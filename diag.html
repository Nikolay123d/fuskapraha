<!doctype html>
<html lang="uk">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PRÁCE CZ CHAT — DIAG</title>
<style>
  body{margin:0;background:#0d1117;color:#c9d1d9;font:14px system-ui,Segoe UI,Roboto,sans-serif}
  .wrap{max-width:900px;margin:0 auto;padding:16px}
  h1{font-size:20px}
  .card{background:#0b0f14;border:1px solid #30363d;border-radius:12px;padding:12px;margin:12px 0}
  .ok{color:#2ea043}.bad{color:#ff7b72}.muted{opacity:.75}
  code,pre{background:#111723;border:1px solid #2b3240;border-radius:8px;padding:6px 8px;display:block;overflow:auto}
  button{background:#238636;border:1px solid #2ea043;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;margin:4px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap}
</style>

<div class="wrap">
  <h1>DIAG: швидка перевірка</h1>

  <div class="card">
    <div id="loadStatus">Завантажую Firebase скрипти…</div>
  </div>

  <div class="card">
    <h3>Конфіг</h3>
    <div id="cfg"></div>
    <div class="muted">⚠️ <b>storageBucket</b> має закінчуватись на <b>appspot.com</b>, інакше фото не працюють.</div>
  </div>

  <div class="card">
    <h3>Перевірка підключення</h3>
    <div class="row">
      <button id="btnTestDB">Тест Realtime DB</button>
      <button id="btnGoogle">Google Sign-In</button>
    </div>
    <div id="dbStatus" class="muted"></div>
    <div id="authStatus" class="muted"></div>
  </div>

  <div class="card">
    <h3>Помилки на сторінці (без F12)</h3>
    <div id="errors">Поки що немає помилок.</div>
  </div>
</div>

<!-- Firebase compat (на GitHub Pages модулі часто ломаються — використовуємо compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
  // Ловимо всі помилки і виводимо в блок
  const errorsEl = document.getElementById('errors');
  function addErr(msg){ 
    const p = document.createElement('div'); p.className='bad'; p.textContent = '• ' + msg; 
    if(errorsEl.textContent.includes('Поки що')) errorsEl.textContent=''; 
    errorsEl.appendChild(p);
  }
  window.addEventListener('error', e => addErr(e.message || String(e.error||e)));
  window.addEventListener('unhandledrejection', e => addErr((e.reason && e.reason.message) ? e.reason.message : String(e.reason)));

  // === ТВОЙ ФАЙРБЕЙС КОНФІГ ===
  const firebaseConfig = {
    apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
    authDomain: "praga-4baee.firebaseapp.com",
    databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
    projectId: "praga-4baee",
    storageBucket: "praga-4baee.appspot.com", // ВАЖЛИВО: appspot.com
    messagingSenderId: "336023952536",
    appId: "1:336023952536:web:f7437feaa25b6eadcd04ed"
  };

  // Виводимо конфіг
  const cfgEl = document.getElementById('cfg');
  cfgEl.innerHTML = '<pre>'+JSON.stringify(firebaseConfig, null, 2)+'</pre>';

  // Ініціалізація
  try{
    firebase.initializeApp(firebaseConfig);
    document.getElementById('loadStatus').innerHTML = '<span class="ok">✅ Firebase скрипти завантажені, ініціалізовано.</span>';
  }catch(err){
    document.getElementById('loadStatus').innerHTML = '<span class="bad">❌ Помилка ініціалізації: '+err.message+'</span>';
    addErr(err.message);
  }

  const auth = firebase.auth();
  const db   = firebase.database();

  // Тест БД: читаємо settings/adminEmail
  document.getElementById('btnTestDB').onclick = async () => {
    const el = document.getElementById('dbStatus');
    el.textContent = 'Читаю settings/adminEmail…';
    try{
      const snap = await db.ref('settings/adminEmail').get();
      if(snap.exists()){
        el.innerHTML = '<span class="ok">✅ Прочитано: ' + snap.val() + '</span>';
      }else{
        el.innerHTML = '<span class="bad">⚠️ Запису немає. Створи вручну settings/adminEmail у БД.</span>';
      }
    }catch(err){
      el.innerHTML = '<span class="bad">❌ Помилка доступу до БД: '+err.message+'</span>';
      addErr(err.message);
    }
  };

  // Google Sign-In з fallback на redirect
  document.getElementById('btnGoogle').onclick = async () => {
    const el = document.getElementById('authStatus');
    el.textContent = 'Пробую увійти через Google…';
    try{
      const provider = new firebase.auth.GoogleAuthProvider();
      try{
        const res = await auth.signInWithPopup(provider);
        el.innerHTML = '<span class="ok">✅ Залогінено як: '+(res.user.email||res.user.uid)+'</span>';
      }catch(popErr){
        // якщо попап заблокований — редірект
        addErr('Popup заблоковано або помилка: '+(popErr.message||popErr));
        await auth.signInWithRedirect(provider);
        el.innerHTML = '<span class="muted">↪️ Виконую редірект входу…</span>';
      }
    }catch(err){
      el.innerHTML = '<span class="bad">❌ Помилка Google Sign-In: '+err.message+'</span>';
      addErr(err.message);
    }
  };
</script>
