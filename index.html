<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Praha Fu≈°ky ‚Äî —Å–æ—Ü—á–∞—Ç</title>

  <!-- –®–†–ò–§–¢–ò -->
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- Leaflet (–∫–∞—Ä—Ç–∞ –±–µ–∑ –∫–ª—é—á–∞) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --accent:#22c55e; --accent-2:#10b981; --danger:#ef4444;
      --glass:rgba(255,255,255,.96); --muted:#64748b; --ink:#0b1220;
      --max:1020px; --avatar:44px; --header-h:66px; --chat-scale:1.08;
      --shadow:0 18px 60px rgba(2,6,23,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#071126;color:var(--ink);overflow-x:hidden}
    body{font-family:Poppins,system-ui,-apple-system,"Segoe UI",Arial,sans-serif;
         background:url('https://i.ibb.co/27hgtZfY/Prague.jpg') center/cover fixed}

    /* Header */
    header{position:sticky;top:0;z-index:1000;padding:6px 8px;text-align:center;color:#fff;backdrop-filter:blur(3px)}
    .brandRow{display:flex;align-items:center;justify-content:center;gap:10px;min-height:var(--header-h);position:relative}
    .profile-btn,.bell-btn,.gear-btn,.members-btn{
      position:absolute;top:8px;width:46px;height:46px;border-radius:50%;border:2px solid rgba(255,255,255,.9);
      display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35);color:#fff;background:rgba(0,0,0,.28)
    }
    .profile-btn{left:8px;background-size:cover;background-position:center}
    .gear-btn{right:112px;display:none}
    .members-btn{right:64px;display:none}
    .bell-btn{right:8px}
    .bell-badge{position:absolute;top:-6px;right:-6px;background:#ff3366;color:#fff;border-radius:12px;padding:2px 6px;font-size:12px;font-weight:700;box-shadow:0 0 10px rgba(255,51,102,.9);display:none}
    header h1{
      margin:0;font-family:'UnifrakturCook',cursive;font-weight:700;font-size:34px;letter-spacing:1px;text-transform:uppercase;
      background:linear-gradient(90deg,#22c55e,#ef4444);-webkit-background-clip:text;background-clip:text;color:transparent;
      text-shadow:0 2px 0 rgba(0,0,0,.55),0 6px 18px rgba(0,0,0,.6)
    }
    header .sub{margin:4px auto 0;font-size:13px;color:#e8ffee;display:inline-block;padding:6px 10px;border-radius:10px;background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.08)}

    /* Tabs */
    .topBar{position:sticky;top:var(--header-h);z-index:900}
    .neon-wrap{max-width:var(--max);margin:6px auto 0;padding:6px 8px}
    .neon-tabs{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .tab-button{border:none;font-weight:800;letter-spacing:.2px;cursor:pointer;border-radius:12px;padding:8px 14px;color:#021f13;background:#cfffdf;box-shadow:0 0 12px rgba(34,197,94,.35),inset 0 -3px 0 rgba(0,0,0,.06);transition:.15s transform,.15s box-shadow}
    .tab-button:hover{transform:translateY(-1px);box-shadow:0 0 16px rgba(34,197,94,.8),inset 0 -3px 0 rgba(0,0,0,.06)}
    .tab-button.active{outline:2px solid #39ff91;box-shadow:0 0 18px rgba(57,255,145,.9),inset 0 -3px 0 rgba(0,0,0,.06)}
    .online-neon{margin:6px auto 8px;max-width:var(--max);text-align:center;color:#baffd1;font-weight:800;text-shadow:0 0 8px rgba(57,255,145,.9);background:rgba(0,0,0,.35);border:1px solid rgba(57,255,145,.35);border-radius:10px;padding:6px 10px}

    main.container{max-width:var(--max);margin:0 auto;padding:8px}
    .tab-content{display:none}
    .tab-content.active{display:block}

    /* Chat feed */
    .chat-area{height:calc(100vh - 320px);overflow:auto;padding:10px 6px}
    .messages{display:flex;flex-direction:column;gap:12px;padding-bottom:220px;transform:scale(var(--chat-scale));transform-origin:bottom left}
    .message{display:flex;gap:10px;align-items:flex-start;max-width:78%;word-break:break-word}
    .message.self{margin-left:auto;flex-direction:row-reverse}
    .avatar{width:var(--avatar);height:var(--avatar);border-radius:50%;object-fit:cover;flex:0 0 var(--avatar);box-shadow:0 3px 10px rgba(0,0,0,.35);cursor:pointer}
    .message-content{background:var(--glass);padding:10px 12px;border-radius:14px;box-shadow:0 6px 30px rgba(2,6,23,.18);color:var(--ink);position:relative}
    .message.self .message-content{background:#E9FFF0}
    .message-meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .chat-image{max-width:300px;border-radius:8px;margin-top:8px;display:block}
    .message-content .text{font-weight:600;font-size:1rem;white-space:pre-wrap}
    .msg-actions{position:absolute;right:6px;top:6px;opacity:.7;font-size:12px}
    .msg-actions button{border:none;background:transparent;cursor:pointer}

    /* Input bar */
    .chat-input{position:fixed;left:0;right:0;bottom:0;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,.96),rgba(255,255,255,.99));border-top:1px solid rgba(0,0,0,.06);z-index:1200;display:flex;gap:8px;align-items:center;max-width:var(--max);margin:0 auto}
    .camera-btn{display:inline-flex;align-items:center;justify-content:center;cursor:pointer;width:48px;height:48px;border-radius:50%;background:#fff;border:1px solid #e6e6e6}
    .camera-btn svg{width:20px;height:20px}
    .chat-input input[type="text"]{flex:1;padding:12px 14px;border-radius:24px;border:1px solid #d0d7de;font-size:16px;outline:none}
    .send-btn{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:20px;font-weight:800;cursor:pointer;box-shadow:0 8px 20px rgba(34,197,94,.18)}

    /* Modals */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);}
    .modal.show{display:flex}
    .modal .panel{background:#fff;border-radius:16px;padding:16px;width:92%;max-width:880px;position:relative;box-shadow:var(--shadow)}
    .modal .close{position:absolute;right:10px;top:8px;background:transparent;border:none;font-size:18px;cursor:pointer}
    .modal.full .panel{width:98%;max-width:none;height:92vh;display:flex;flex-direction:column}

    .notif-item{border-bottom:1px solid #eee;padding:8px}
    .notif-head{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .notif-actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .btn{border:none;border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer}
    .btn-accept{background:#dcfce7}.btn-decline{background:#fee2e2}.btn-open{background:#fff3cd}

    .admin-users-head{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .admin-users-body{flex:1;overflow:auto;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    .grid-users{width:100%;border-collapse:collapse}
    .grid-users th,.grid-users td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left;vertical-align:middle}
    .grid-users th{position:sticky;top:0;background:#f8fafc;z-index:1}
    .user-badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 8px;font-size:12px;background:#f1f5f9}
    .btn-mini{border:none;border-radius:8px;padding:6px 8px;font-weight:700;cursor:pointer;background:#eef2ff}
    .btn-mini.btn-red{background:#ffe1e1}

    .msg-menu{position:absolute;background:#fff;border-radius:8px;padding:6px;box-shadow:0 6px 20px rgba(0,0,0,.2);z-index:2000;display:none}
    .msg-menu button{display:block;border:none;background:transparent;padding:6px 10px;text-align:left;width:100%;cursor:pointer}
    .msg-menu button:hover{background:rgba(0,0,0,.03)}

    .pill-title{margin:10px 0 6px;color:#eafff3;font-weight:900;text-shadow:0 0 10px rgba(57,255,145,.9);}

    /* –ó–µ–ª–µ–Ω–∞—è –≥–∞–ª–∫–∞ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ */
    .photo-toast{position:fixed;left:50%;transform:translateX(-50%);bottom:86px;background:#dcfce7;border:1px solid #16a34a;color:#065f46;padding:8px 12px;border-radius:12px;font-weight:800;box-shadow:0 10px 30px rgba(0,0,0,.15);display:none;z-index:1300}

    @media (max-width:640px){
      .chat-area{height:calc(100vh - 360px)}
      .chat-image{max-width:200px}
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="brandRow">
      <button id="profileBtn" class="profile-btn" title="–ü—Ä–æ—Ñ—ñ–ª—å" aria-label="–ü—Ä–æ—Ñ—ñ–ª—å"></button>
      <h1>PRAHA FU≈†KY</h1>
      <button id="gearBtn" class="gear-btn" title="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è" aria-label="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è">‚öôÔ∏è</button>
      <button id="membersBtn" class="members-btn" title="–£—á–∞—Å–Ω–∏–∫–∏" aria-label="–£—á–∞—Å–Ω–∏–∫–∏">üë•</button>
      <button id="bellBtn" class="bell-btn" title="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è" aria-label="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è">üîî<span id="bellBadge" class="bell-badge">0</span></button>
    </div>
    <div class="sub">–î–æ–ø–æ–º–∞–≥–∞—î–º–æ —É–∫—Ä–∞—ó–Ω—Ü—è–º —É –ü—Ä–∞–∑—ñ ‚Äî —Å–ø—ñ–ª—å–Ω–æ—Ç–∞, —á–∞—Ç, –æ—Ä–µ–Ω–¥–∞, –¥–æ–ø–æ–º–æ–≥–∞.</div>
  </header>

  <!-- TOP TABS -->
  <div class="topBar">
    <div class="neon-wrap">
      <nav class="neon-tabs" role="tablist" aria-label="–í–∫–ª–∞–¥–∫–∏">
        <button class="tab-button active" data-target="chatTab">üí¨ –ß–∞—Ç</button>
        <button class="tab-button" data-target="rentTab">üè† –û—Ä–µ–Ω–¥–∞</button>
        <button class="tab-button" data-target="mapTab">üó∫Ô∏è –ö–∞—Ä—Ç–∞</button>
        <button class="tab-button" data-target="friendsTab">üë• –î—Ä—É–∑—ñ</button>
        <button class="tab-button" data-target="dmTab">‚úâÔ∏è –û—Å–æ–±–∏—Å—Ç—ñ</button>
      </nav>
      <div class="online-neon" id="onlineNeon">–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): 0</div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="container" role="main">
    <!-- –ê–¥–º—ñ–Ω—Å—å–∫–∞ —Å–º—É–∂–∫–∞ –ø–æ–≤–µ—Ä—Ö —á–∞—Ç–∞ -->
    <div id="adminBar" style="display:none; margin-bottom:8px; background:rgba(255,255,255,.86); border:1px solid #e5e7eb; border-radius:12px; padding:8px; box-shadow:var(--shadow)">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <div style="font-weight:900">–ê–¥–º—ñ–Ω ‚Ä¢ –ë–æ—Ç–∏</div>
        <div style="display:flex;gap:6px;align-items:center">
          <button id="startAll" class="tab-button" style="padding:6px 10px">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—Å—ñ—Ö</button>
          <button id="stopAll" class="tab-button"  style="padding:6px 10px;background:#ffe1e1">‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏ –≤—Å—ñ—Ö</button>
          <button id="postOnceAll" class="tab-button" style="padding:6px 10px;background:#fff3cd">‚ö°Ô∏è –ü–æ—Å—Ç —Ä–∞–∑–æ–º</button>
        </div>
      </div>
      <div class="pill-title">–ü—Ä–æ—Ñ—ñ–ª—ñ ¬´–∞–∫—Ç–∏–≤—ñ—Å—Ç—ñ–≤¬ª:</div>
      <div id="botsRow" style="display:flex;gap:8px;flex-wrap:wrap"></div>
    </div>

    <!-- –ß–ê–¢ -->
    <section id="chatTab" class="tab-content active" role="region" aria-label="–ß–∞—Ç">
      <div class="chat-area" id="chatArea" aria-live="polite">
        <div id="messages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- –ß–ê–¢ –û–†–ï–ù–î–ê -->
    <section id="rentTab" class="tab-content" role="region" aria-label="–ß–∞—Ç –û—Ä–µ–Ω–¥–∞">
      <div class="chat-area" id="rentArea">
        <div id="rentMessages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- –ö–ê–†–¢–ê -->
    <section id="mapTab" class="tab-content" role="region" aria-label="–ö–∞—Ä—Ç–∞">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
        <input id="mapSearch" placeholder="–ü–æ—à—É–∫ (–≤–æ–ª–æ–Ω—Ç–µ—Ä–∏, –∞–ø—Ç–µ–∫–∞‚Ä¶)" style="flex:1;min-width:220px;padding:10px;border-radius:10px;border:1px solid #ddd" />
        <button class="tab-button" data-f="all">–£—Å–µ</button>
        <button class="tab-button" data-f="volunteer">–í–æ–ª–æ–Ω—Ç–µ—Ä–∏</button>
        <button class="tab-button" data-f="aid">–î–æ–ø–æ–º–æ–≥–∞</button>
        <button class="tab-button" data-f="pharmacy">–ê–ø—Ç–µ–∫–∏</button>
        <button id="centerBtn" class="tab-button" style="padding:6px 10px">–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏</button>
      </div>
      <div id="map" style="width:100%;height:60vh;border-radius:10px;background:#eaf7ff"></div>
    </section>

    <!-- –î–†–£–ó–Ü -->
    <section id="friendsTab" class="tab-content" role="region" aria-label="–î—Ä—É–∑—ñ">
      <h2 class="pill-title" style="margin-top:0">–î—Ä—É–∑—ñ —Ç–∞ –∑–∞—è–≤–∫–∏</h2>
      <div class="friends-wrap" style="display:grid;grid-template-columns:1fr;gap:12px">
        <div>
          <h3 style="color:#fff;margin:6px 0;text-shadow:0 0 10px rgba(57,255,145,.9)">–ó–∞—è–≤–∫–∏</h3>
          <div id="friendRequests"></div>
        </div>
        <div>
          <h3 style="color:#fff;margin:6px 0;text-shadow:0 0 10px rgba(57,255,145,.9)">–ú–æ—ó –¥—Ä—É–∑—ñ (<span id="friendsOnlineCount">0</span> –æ–Ω–ª–∞–π–Ω)</h3>
          <div id="friendsList"></div>
        </div>
      </div>
    </section>

    <!-- –õ–° (—ñ–Ω–±–æ–∫—Å –¥—ñ–∞–ª–æ–≥—ñ–≤) -->
    <section id="dmTab" class="tab-content" role="region" aria-label="–û—Å–æ–±–∏—Å—Ç—ñ">
      <h2 class="pill-title" style="margin:6px 0">–ú–æ—ó –¥—ñ–∞–ª–æ–≥–∏</h2>
      <div id="dmList" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px"></div>
    </section>
  </main>

  <!-- –§—ñ–∫—Å–æ–≤–∞–Ω–∞ –ø–∞–Ω–µ–ª—å –≤–≤–æ–¥—É -->
  <input id="fileInput" type="file" accept="image/*" style="display:none" />
  <div class="chat-input" role="region" aria-label="–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">
    <label for="fileInput" class="camera-btn" id="cameraLabel" aria-hidden="true">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M4 7H6L7 5H17L18 7H20C21.1 7 22 7.9 22 9V19C22 20.1 21.1 21 20 21H4C2.9 21 2 20.1 2 19V9C2 7.9 2.9 7 4 7Z" fill="#111"/><circle cx="12" cy="13" r="3.5" fill="#fff"/></svg>
    </label>
    <input id="messageInput" type="text" inputmode="text" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." aria-label="–¢–µ–∫—Å—Ç" />
    <button id="sendButton" class="send-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
  </div>

  <!-- –ó–µ–ª–µ–Ω–∞—è –ø–ª–∞—à–∫–∞-–≥–∞–ª–æ—á–∫–∞ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ -->
  <div id="photoToast" class="photo-toast">‚úîÔ∏è –§–æ—Ç–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ. –ù–∞–ø–∏—à—ñ—Ç—å –°–ú–° ‚Äî —Ñ–æ—Ç–æ –∑'—è–≤–∏—Ç—å—Å—è –ø—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏.</div>

  <!-- –ú–û–î–ê–õ–ö–ò -->
  <!-- auth -->
  <div id="authModal" class="modal" aria-hidden="true" style="z-index:1500">
    <div class="panel" role="dialog" aria-modal="true">
      <button class="close" id="modalClose">‚úñ</button>
      <h2 style="margin-top:0">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è / –í—Ö—ñ–¥</h2>

      <form id="registerForm" onsubmit="return false;">
        <input id="nickInput" type="text" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" required style="width:100%;padding:10px;margin:6px 0;border-radius:10px;border:1px solid #e5e7eb"/>
        <input id="emailInput" type="email" placeholder="Email" required style="width:100%;padding:10px;margin:6px 0;border-radius:10px;border:1px solid #e5e7eb"/>
        <input id="passwordInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω. 6)" required style="width:100%;padding:10px;margin:6px 0;border-radius:10px;border:1px solid #e5e7eb"/>
        <div style="display:flex;gap:8px">
          <button id="registerSubmit" type="button" class="tab-button" style="flex:1">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
          <button id="loginShow"    type="button" class="tab-button" style="flex:1;background:#4b5563;color:#fff">–£–≤—ñ–π—Ç–∏</button>
        </div>
        <div id="regError" style="color:#b91c1c;margin-top:6px"></div>
      </form>

      <form id="loginForm" style="display:none" onsubmit="return false;">
        <input id="loginEmail" type="email" placeholder="Email" required style="width:100%;padding:10px;margin:6px 0;border-radius:10px;border:1px solid #e5e7eb"/>
        <input id="loginPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" required style="width:100%;padding:10px;margin:6px 0;border-radius:10px;border:1px solid #e5e7eb"/>
        <div style="display:flex;gap:8px">
          <button id="loginSubmit"   type="button" class="tab-button" style="flex:1">–£–≤—ñ–π—Ç–∏</button>
          <button id="backToRegister"type="button" class="tab-button" style="flex:1;background:#4b5563;color:#fff">–ù–∞–∑–∞–¥</button>
        </div>
        <div id="loginError" style="color:#b91c1c;margin-top:6px"></div>
      </form>

      <div style="margin-top:10px">
        <div id="recaptcha-container" style="margin-bottom:8px"></div>
        <input id="phoneInput" type="tel" placeholder="+420‚Ä¶ (–æ–ø—Ü—ñ–π–Ω–æ: SMS-–ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è)" style="width:100%;padding:10px;margin:6px 0;border-radius:10px;border:1px solid #e5e7eb"/>
        <div style="display:flex;gap:8px">
          <button id="smsSend" class="tab-button" style="flex:1;background:#fff3cd">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∫–æ–¥</button>
          <input id="smsCode" placeholder="–ö–æ–¥" style="flex:1;padding:10px;border-radius:10px;border:1px solid #e5e7eb" />
          <button id="smsVerify" class="tab-button" style="flex:1">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <button id="enableSoundBtn" class="tab-button" style="width:100%">üîä –í–∫–ª—é—á–∏—Ç–∏ –∑–≤—É–∫ —Å–ø–æ–≤—ñ—â–µ–Ω—å</button>
      </div>
    </div>
  </div>

  <!-- –ü—Ä–æ—Ñ—ñ–ª—å -->
  <div id="profileModal" class="modal" aria-hidden="true" style="z-index:1600">
    <div class="panel" role="dialog" aria-modal="true">
      <button class="close" id="profileClose">‚úñ</button>
      <div id="profileContent"></div>
    </div>
  </div>

  <!-- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è -->
  <div id="gearModal" class="modal" aria-hidden="true" style="z-index:1500">
    <div class="panel" role="dialog" aria-modal="true">
      <button class="close" id="gearClose">‚úñ</button>
      <h3 style="margin-top:0">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h3>
      <label class="user-badge" style="gap:8px;margin-right:8px"><input type="checkbox" id="optSound"> –ó–≤—É–∫ —Å–ø–æ–≤—ñ—â–µ–Ω—å</label>
      <label class="user-badge" style="gap:8px"><input type="checkbox" id="optAnon"> –î–æ–∑–≤–æ–ª–∏—Ç–∏ –≥–æ—Å—Ç—å–æ–≤–∏–π –ø–µ—Ä–µ–≥–ª—è–¥</label>
    </div>
  </div>

  <!-- –º–µ–Ω—é –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
  <div id="msgMenu" class="msg-menu" role="menu">
    <button data-act="like">üëç –õ–∞–π–∫</button>
    <button data-act="warn">‚ö†Ô∏è –û–±–µ—Ä–µ–∂–Ω–æ (—à–∞—Ö—Ä–∞–π)</button>
    <button data-act="dislike">üëé –î–∏–∑–ª–∞–π–∫</button>
    <button data-act="spam">üö´ –°–ø–∞–º</button>
    <button data-act="reply">‚Ü©Ô∏è –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏</button>
    <button data-act="delete">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ (–∞–≤—Ç–æ—Ä/–∞–¥–º—ñ–Ω)</button>
  </div>

  <!-- –ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫ -->
  <div id="bellModal" class="modal" aria-hidden="true" style="z-index:1400">
    <div class="panel" role="dialog" aria-modal="true">
      <button class="close" id="bellClose">‚úñ</button>
      <h3 style="margin-top:0">–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h3>
      <div id="notifList"></div>
    </div>
  </div>

  <!-- –ê–¥–º—ñ–Ω ¬´–£—á–∞—Å–Ω–∏–∫–∏¬ª -->
  <div id="adminUsersModal" class="modal full" aria-hidden="true" style="z-index:1700">
    <div class="panel" role="dialog" aria-modal="true">
      <button class="close" id="adminUsersClose">‚úñ</button>
      <div class="admin-users-head">
        <h3 style="margin:0">–£—á–∞—Å–Ω–∏–∫–∏ —Å–∞–π—Ç—É</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="userSearch" placeholder="–ü–æ—à—É–∫ –∑–∞ –Ω—ñ–∫–æ–º –∞–±–æ email‚Ä¶" style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px" />
          <span class="user-badge">–£—Å—å–æ–≥–æ: <b id="usersTotal">0</b></span>
          <span class="user-badge">–ù–∞ –µ–∫—Ä–∞–Ω—ñ: <b id="usersShown">0</b></span>
        </div>
      </div>
      <div class="admin-users-body">
        <table class="grid-users">
          <thead><tr><th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th><th class="muted">Email</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–µ–º—ñ—É–º</th><th>–î—ñ—ó</th></tr></thead>
          <tbody id="usersTBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- –∑–≤—É–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ -->
  <script>window.__soundEnabled=false;</script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
  /* =========================
     –ß–ê–°–¢–¨ 1/3 ‚Äî Firebase init, –±–∞–∑–æ–≤—ñ UI, –∑–≤—É–∫, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
     ========================= */
  const firebaseConfig = {
    apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
    authDomain: "praga-4baee.firebaseapp.com",
    databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
    projectId: "praga-4baee",
    storageBucket: "praga-4baee.firebasestorage.app",
    messagingSenderId: "336023952536",
    appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
    measurementId: "G-BGDJD6R12N"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.database();

  const DEFAULT_AVATAR = "https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg";
  const ADMIN_EMAIL = "urciknikolaj642@gmail.com";

  const tabButtons   = document.querySelectorAll(".tab-button");
  const tabContents  = document.querySelectorAll(".tab-content");
  const profileBtn   = document.getElementById("profileBtn");
  const gearBtn      = document.getElementById("gearBtn");
  const membersBtn   = document.getElementById("membersBtn");
  const adminBar     = document.getElementById("adminBar");
  const onlineNeon   = document.getElementById("onlineNeon");

  const authModal    = document.getElementById("authModal");
  const modalClose   = document.getElementById("modalClose");
  const registerForm = document.getElementById("registerForm");
  const loginForm    = document.getElementById("loginForm");
  const loginShow    = document.getElementById("loginShow");
  const backToRegister = document.getElementById("backToRegister");
  const registerSubmit = document.getElementById("registerSubmit");
  const loginSubmit  = document.getElementById("loginSubmit");
  const regError     = document.getElementById("regError");
  const loginError   = document.getElementById("loginError");
  const nickInput    = document.getElementById("nickInput");
  const emailInput   = document.getElementById("emailInput");
  const passwordInput= document.getElementById("passwordInput");
  const loginEmail   = document.getElementById("loginEmail");
  const loginPassword= document.getElementById("loginPassword");
  const enableSoundBtn = document.getElementById("enableSoundBtn");

  const gearModal = document.getElementById('gearModal');
  const gearClose = document.getElementById('gearClose');
  const optSound  = document.getElementById('optSound');
  const optAnon   = document.getElementById('optAnon');

  function setActiveTab(id){
    tabButtons.forEach(b=>b.classList.toggle("active", b.dataset.target===id));
    tabContents.forEach(c=> c.style.display = (c.id===id) ? "block" : "none");
    adminBar.style.display = (id==='chatTab' && window.__isAdmin) ? 'block' : 'none';
    if (id==='mapTab' && !window.__mapInitOnce){ initLeaflet(); window.__mapInitOnce=true; }
  }
  tabButtons.forEach(btn=> btn.addEventListener('click', ()=> setActiveTab(btn.dataset.target)));

  /* WebAudio */
  let audioCtx=null;
  function ensureAudio(){ if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } }
  function beep(freq=880, dur=120, type="sine", vol=0.15){
    if(!window.__soundEnabled) return;
    ensureAudio();
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(audioCtx.destination);
    o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.08); o.stop(audioCtx.currentTime+0.1); }, dur);
  }
  const SND={ notify(){beep(1200,140,"triangle",0.18)}, sent(){beep(760,90,"sine",0.14)}, error(){beep(320,220,"square",0.18)} };
  enableSoundBtn?.addEventListener('click',()=>{ window.__soundEnabled = true; ensureAudio(); SND.notify(); enableSoundBtn.textContent="üîä –ó–≤—É–∫ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ"; optSound.checked=true; });

  /* –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è */
  gearBtn.addEventListener('click',()=>{ gearModal.classList.add('show'); });
  gearClose.addEventListener('click',()=> gearModal.classList.remove('show'));
  optSound.onchange = ()=>{ window.__soundEnabled = !!optSound.checked; if(optSound.checked) SND.notify(); };
  optAnon.onchange = ()=>{ localStorage.setItem('allow_guest',''+(optAnon.checked?1:0)); };

  /* Auth UI */
  function showAuth(){ authModal.classList.add('show'); regError.textContent=""; loginError.textContent=""; }
  function hideAuth(){ authModal.classList.remove('show'); }
  modalClose.addEventListener('click', hideAuth);
  loginShow.addEventListener('click',()=>{ registerForm.style.display="none"; loginForm.style.display="block"; });
  backToRegister.addEventListener('click',()=>{ registerForm.style.display="block"; loginForm.style.display="none"; });

  registerSubmit.addEventListener('click', async ()=>{
    regError.textContent="";
    const nick = nickInput.value.trim();
    const email= emailInput.value.trim();
    const pass = passwordInput.value.trim();
    if(!nick || !email || pass.length<6){ regError.textContent="–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è (–ø–∞—Ä–æ–ª—å ‚â• 6)"; SND.error(); return; }
    try{
      const cred = await auth.createUserWithEmailAndPassword(email,pass);
      await cred.user.updateProfile({ displayName:nick, photoURL:DEFAULT_AVATAR });
      await db.ref('users/'+cred.user.uid).set({ nick,email,avatar:DEFAULT_AVATAR,createdAt:Date.now() });
      await db.ref('presence/'+cred.user.uid).set({ ts:Date.now(), nick });
      hideAuth(); SND.notify();
    }catch(e){ regError.textContent=e.message||String(e); SND.error(); }
  });

  loginSubmit.addEventListener('click', async ()=>{
    loginError.textContent="";
    try{ await auth.signInWithEmailAndPassword(loginEmail.value.trim(), loginPassword.value.trim()); hideAuth(); SND.notify(); }
    catch(e){ loginError.textContent=e.message||String(e); SND.error(); }
  });

  // SMS (–æ–ø—Ü—ñ–π–Ω–æ)
  let _smsConfirmer=null;
  function initRecaptcha(){ try{ _smsConfirmer = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size:'invisible' }); }catch{} }
  initRecaptcha();
  document.getElementById('smsSend').onclick = async ()=>{
    const phone = document.getElementById('phoneInput').value.trim(); if(!phone) return;
    try{ const res = await auth.signInWithPhoneNumber(phone,_smsConfirmer); window.__smsRes=res; alert('–ö–æ–¥ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ'); }
    catch(e){ alert('SMS –ø–æ–º–∏–ª–∫–∞: '+(e.message||e)); }
  };
  document.getElementById('smsVerify').onclick = async ()=>{
    const code = document.getElementById('smsCode').value.trim(); if(!code||!window.__smsRes) return;
    try{ await window.__smsRes.confirm(code); alert('–ù–æ–º–µ—Ä –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ'); }
    catch(e){ alert('–ö–æ–¥ –Ω–µ–≤—ñ—Ä–Ω–∏–π'); }
  };

  /* onAuthStateChanged */
  window.__isAdmin=false;
  auth.onAuthStateChanged(async (u)=>{
    profileBtn.style.background = `url(${(u && u.photoURL) || DEFAULT_AVATAR}) center/cover`;
    if(u){ await db.ref('presence/'+u.uid).set({ ts:Date.now(), nick: u.displayName||u.email }); }

    if(u){
      try{
        const roleSnap=await db.ref('users/'+u.uid+'/role').get();
        const role=roleSnap.exists()?roleSnap.val():null;
        window.__isAdmin = (u.email===ADMIN_EMAIL) || role==='admin';
      }catch{ window.__isAdmin = (u.email===ADMIN_EMAIL); }
    }else window.__isAdmin=false;

    gearBtn.style.display    = 'flex';
    membersBtn.style.display = window.__isAdmin ? 'flex' : 'none';
    adminBar.style.display   = (window.__isAdmin && document.getElementById('chatTab').style.display==='block') ? 'block' : 'none';

    profileBtn.onclick = ()=>{ if(!auth.currentUser) showAuth(); else openProfile(auth.currentUser.uid,true); };

    updateOnlineCount(); initHelp();
  });

  /* =========================
     –ß–ê–°–¢–¨ 2/3 ‚Äî –ü—Ä–æ—Ñ—ñ–ª—å, –∫–∞—Ä—Ç–∞, –¥—Ä—É–∑—ñ/–õ–°, —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
     ========================= */
  const profileModal  = document.getElementById("profileModal");
  const profileClose  = document.getElementById("profileClose");
  const profileContent= document.getElementById("profileContent");
  profileClose.addEventListener('click',()=> profileModal.classList.remove('show'));

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

  async function openProfile(uid,isSelf=false){
    profileModal.style.zIndex=1600; // –ø–æ–≤–µ—Ä—Ö –≤—Å–µ—Ö
    profileModal.classList.add('show');
    profileContent.innerHTML = "<p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</p>";
    try{
      const s = await db.ref('users/'+uid).get();
      const user = s.exists()? s.val() : { nick:"–ê–Ω–æ–Ω—ñ–º", avatar:DEFAULT_AVATAR };
      const email = user.email || "";
      const self  = auth.currentUser && auth.currentUser.uid===uid;

      // –ø—Ä–µ–º—ñ—É–º –∑–Ω–∞—á–æ–∫
      const flags = (await db.ref('settings/userFlags/'+uid).get()).val()||{};
      const planKey = flags.premium || 'none';
      const PLAN = {
        none:{label:'‚Äî',bg:'linear-gradient(90deg,#e5e7eb,#f8fafc)',col:'#111'},
        trial:{label:'–ü–†–ï–ú–Ü–£–ú ‚Ä¢ TRIAL',bg:'linear-gradient(90deg,#a78bfa,#c084fc)',col:'#fff'},
        premium:{label:'–ü–†–ï–ú–Ü–£–ú',bg:'linear-gradient(90deg,#22c55e,#16a34a)',col:'#fff'},
        premiumPlus:{label:'–ü–†–ï–ú–Ü–£–ú+',bg:'linear-gradient(90deg,#06b6d4,#0ea5e9)',col:'#fff'}
      }[planKey];

      const about = user.about||''; const contacts=user.contacts||'';

      profileContent.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center">
          <img src="${user.avatar||DEFAULT_AVATAR}" style="width:84px;height:84px;border-radius:12px;object-fit:cover">
          <div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <h3 style="margin:0;color:#0b1220;text-shadow:0 0 12px rgba(57,255,145,.7)">${escapeHtml(user.nick||"–ê–Ω–æ–Ω—ñ–º")}</h3>
              <span class="user-badge" style="background:${PLAN.bg};color:${PLAN.col};font-weight:900">${PLAN.label}</span>
              ${uid===auth.currentUser?.uid?'<span class="user-badge">–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</span>':''}
              ${(user.email===ADMIN_EMAIL)?'<span class="user-badge" style="background:#111;color:#39ff91">ADMIN</span>':''}
            </div>
            <div style="color:${email?'#333':'#666'}">${escapeHtml(email)}</div>
          </div>
        </div>
        <div style="margin-top:12px;display:grid;grid-template-columns:1fr;gap:8px">
          <div><b>–ü—Ä–æ —Å–µ–±–µ:</b><br>${about?escapeHtml(about):'<i>–Ω–µ –≤–∫–∞–∑–∞–Ω–æ</i>'}</div>
          <div><b>–ö–æ–Ω—Ç–∞–∫—Ç–∏:</b><br>${contacts?escapeHtml(contacts):'<i>–Ω–µ –≤–∫–∞–∑–∞–Ω–æ</i>'}</div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          ${self?`
            <label class="tab-button" style="cursor:pointer">
              <input type="file" id="avatarFile" accept="image/*" style="display:none">–ó–º—ñ–Ω–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä (—Ñ–∞–π–ª)
            </label>
            <button id="editAbout" class="tab-button">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
            <button id="signOutBtn" class="tab-button" style="background:#ffe1e1">–í–∏–π—Ç–∏</button>
          `:`
            <button id="pmBtn" class="tab-button">–ù–∞–ø–∏—Å–∞—Ç–∏ –õ–°</button>
            <button id="addFriendBtn" class="tab-button">–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>
            <button id="reportBtn" class="tab-button" style="background:#fff3cd">‚ö†Ô∏è –ü–æ—Å–∫–∞—Ä–∂–∏—Ç–∏—Å—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—É</button>
          `}
        </div>
        <div id="profileMsg" style="margin-top:8px;color:#16a34a;font-weight:700"></div>
      `;

      if(self){
        document.getElementById('avatarFile').addEventListener('change', async (e)=>{
          const f = e.target.files[0]; if(!f) return;
          const url = await fileToDataURL(f, 900, .9);
          await db.ref('users/'+uid+'/avatar').set(url);
          await auth.currentUser.updateProfile({ photoURL:url });
          profileBtn.style.background = `url(${url}) center/cover`;
          profileContent.querySelector('img').src = url;
          SND.notify();
        });
        document.getElementById('signOutBtn').onclick = async ()=>{
          try{ await db.ref('presence/'+auth.currentUser.uid).remove(); }catch{}
          await auth.signOut(); profileModal.classList.remove('show');
        };
        document.getElementById('editAbout').onclick = async ()=>{
          const a = prompt('–ü—Ä–æ —Å–µ–±–µ', about||'')||'';
          const c = prompt('–ö–æ–Ω—Ç–∞–∫—Ç–∏', contacts||'')||'';
          await db.ref('users/'+uid).update({ about:a, contacts:c });
          openProfile(uid,true);
        };
      }else{
        document.getElementById('pmBtn').onclick = ()=> openPrivateChat(uid);
        document.getElementById('addFriendBtn').onclick = ()=> sendFriendRequest(uid);
        document.getElementById('reportBtn').onclick = async ()=>{
          await db.ref('notifications/'+ (await getAdminUid()) ).push({
            ts:Date.now(), type:'report', text:`–°–∫–∞—Ä–≥–∞ –Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${escapeHtml(user.nick||uid)}`, from:auth.currentUser?.uid||'guest', target:uid
          });
          document.getElementById('profileMsg').textContent = "–°–∫–∞—Ä–≥—É –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—É.";
          SND.notify();
        };
      }
    }catch(e){ profileContent.innerHTML = "<p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</p>"; }
  }
  profileBtn.addEventListener('click', ()=>{ if(!auth.currentUser) showAuth(); else openProfile(auth.currentUser.uid,true); });

  function fileToDataURL(file,maxW=900,quality=.85){
    return new Promise((resolve,reject)=>{
      const img=new Image(); const r=new FileReader();
      r.onload=e=>{ img.onload()=>{
        const sc=Math.min(1, maxW/img.width);
        const w=(img.width*sc)|0, h=(img.height*sc)|0;
        const c=document.createElement('canvas'); c.width=w; c.height=h;
        c.getContext('2d').drawImage(img,0,0,w,h);
        resolve(c.toDataURL('image/jpeg',quality));
      }; img.onerror=reject; img.src=e.target.result; };
      r.onerror=reject; r.readAsDataURL(file);
    });
  }

  function updateOnlineCount(){
    db.ref('presence').on('value', snap=>{
      const val = snap.val()||{}; const real = Object.keys(val).length;
      onlineNeon.textContent = `–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): ${real*10}`;
    });
    window.addEventListener('beforeunload', async ()=>{
      try{ if(auth.currentUser) await db.ref('presence/'+auth.currentUser.uid).remove(); }catch{}
    });
  }

  // –î–æ–ø–æ–º–æ–≥–∞ (–∫–∞—Ä—Ç–æ—á–∫–∏)
  const helpItems=[
    {img:"https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp", title:"Nemocnice Motol", sub:"V √övalu 84"},
    {img:"https://i.ibb.co/0gWD5wW/images-5.jpg", title:"–Æ—Ä–∏–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞", sub:"–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó"},
    {img:"https://i.ibb.co/R49shL6k/images-6.jpg", title:"–£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –º–∞–≥–∞–∑–∏–Ω–∏", sub:"–ü—Ä–æ–¥—É–∫—Ç–∏"}
  ];
  const helpGrid = document.createElement('div');
  function initHelp(){
    const host=document.querySelector('#friendsTab').previousElementSibling; // –Ω–µ–æ–Ω-–ø–ª–∞—à–∫–∞
    const sec=document.getElementById('friendsTab');
    if(!sec||sec.dataset.helpInit) return; sec.dataset.helpInit='1';
    const helpTab=document.createElement('section'); helpTab.id='helpTab'; helpTab.className='tab-content'; helpTab.setAttribute('role','region'); helpTab.setAttribute('aria-label','–î–æ–ø–æ–º–æ–≥–∞');
    helpTab.innerHTML=`<h2 class="pill-title">–¢–µ—Ä–º—ñ–Ω–æ–≤–∞ –¥–æ–ø–æ–º–æ–≥–∞ —É –ü—Ä–∞–∑—ñ</h2><div id="helpGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px"></div>`;
    document.querySelector('main').insertBefore(helpTab, document.getElementById('dmTab'));
    const hg=helpTab.querySelector('#helpGrid');
    hg.innerHTML = helpItems.map(i=>`
      <div style="background:#fff;padding:10px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.08)">
        <img src="${i.img}" style="width:100%;height:140px;object-fit:cover;border-radius:8px">
        <h3>${i.title}</h3><p>${i.sub}</p>
      </div>`).join('');

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–æ –≤–∫–ª–∞–¥–∫–∏ (–ø–æ—Å–ª–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó)
    const helpBtn=document.createElement('button'); helpBtn.className='tab-button'; helpBtn.dataset.target='helpTab'; helpBtn.textContent='üÜò –î–æ–ø–æ–º–æ–≥–∞';
    document.querySelector('.neon-tabs').insertBefore(helpBtn, document.querySelector("button[data-target='dmTab']"));
    helpBtn.addEventListener('click', ()=> setActiveTab('helpTab'));
  }

  /* –ö–∞—Ä—Ç–∞ */
  let map, markers=[], poi=[];
  function initLeaflet(){
    map = L.map('map').setView([50.0755, 14.4378], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);
    poi = [
      {t:'volunteer', name:'–£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –≤–æ–ª–æ–Ω—Ç–µ—Ä—Å—å–∫–∏–π —Ü–µ–Ω—Ç—Ä', p:[50.087,14.43]},
      {t:'aid', name:'–¶–µ–Ω—Ç—Ä –¥–æ–ø–æ–º–æ–≥–∏ UA', p:[50.09,14.47]},
      {t:'pharmacy', name:'–ê–ø—Ç–µ–∫–∞ Praha', p:[50.07,14.41]},
      {t:'volunteer', name:'Volunteers Hub', p:[50.08,14.5]},
    ];
    renderPoi(poi);
    document.getElementById('centerBtn').onclick=()=> map.setView([50.0755,14.4378],12);
    document.querySelectorAll('#mapTab button[data-f]').forEach(b=> b.onclick=()=>
      renderPoi(b.dataset.f==='all'? poi : poi.filter(o=>o.t===b.dataset.f))
    );
    document.getElementById('mapSearch').oninput = (e)=> searchPoi(e.target.value.trim());
  }
  function clearMarkers(){ markers.forEach(m=>m.remove()); markers=[]; }
  function renderPoi(list){ clearMarkers(); list.forEach(o=>{ const m=L.marker(o.p).addTo(map).bindPopup(`<b>${o.name}</b><br>${o.t}`); markers.push(m); }); }
  function searchPoi(q){ const l=q.toLowerCase(); renderPoi(poi.filter(o=>o.name.toLowerCase().includes(l) || o.t.includes(l))); }

  /* –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è */
  const bellBtn   = document.getElementById("bellBtn");
  const bellBadge = document.getElementById("bellBadge");
  const bellModal = document.getElementById("bellModal");
  const bellClose = document.getElementById("bellClose");
  const notifList = document.getElementById("notifList");
  function notify(title,text){
    const row=document.createElement('div'); row.style.padding="6px 8px"; row.style.borderBottom="1px solid #eee";
    row.textContent = `${title}: ${text}`; notifList.prepend(row);
    let n=Number(bellBadge.dataset.n||"0")+1; bellBadge.dataset.n=String(n);
    bellBadge.textContent=n; bellBadge.style.display=n>0?"inline-block":"none";
    SND.notify();
  }
  bellBtn.addEventListener('click',()=>{ bellModal.classList.add('show'); bellBadge.dataset.n="0"; bellBadge.style.display="none"; });
  bellClose.addEventListener('click',()=> bellModal.classList.remove('show'));

  function renderNotifItem(id,v){
    const row=document.createElement('div');
    row.style.cssText="padding:8px;border-bottom:1px solid #eee;display:flex;gap:8px;align-items:center";
    row.innerHTML = `
      <div style="flex:1">
        <div style="font-weight:700">${(v.type||'info').toUpperCase()}</div>
        <div class="muted" style="font-size:13px">${v.text||''}</div>
      </div>
      ${v.from?'<button class="tab-button btn-prof" style="padding:6px 10px">üë§ –ü—Ä–æ—Ñ—ñ–ª—å</button>':''}
      ${v.type==='dm' && v.from?'<button class="tab-button btn-dm" style="padding:6px 10px">‚úâÔ∏è –í—ñ–¥–∫—Ä–∏—Ç–∏</button>':''}`;
    if(v.from){ row.querySelector('.btn-prof')?.addEventListener('click',()=> openProfile(v.from)); }
    if(v.type==='dm' && v.from){ row.querySelector('.btn-dm')?.addEventListener('click',()=> openPrivateChat(v.from)); }
    notifList.prepend(row);
  }
  function subscribeNotifications(uid){ if(!uid) return; db.ref('notifications/'+uid).on('child_added',snap=>{ const v=snap.val()||{}; renderNotifItem(snap.key, v); SND.notify(); }); }

  /* –î—Ä—É–∑—ñ —Ç–∞ –õ–° */
  const dmList = document.getElementById("dmList");
  const friendsList = document.getElementById("friendsList");
  const friendRequestsEl = document.getElementById("friendRequests");
  const friendsOnlineCountEl = document.getElementById("friendsOnlineCount");
  function convoIdFor(a,b){ return a<b? a+"_"+b : b+"_"+a; }

  async function getAdminUid(){
    const s = await db.ref('users').get(); const v=s.val()||{};
    const id = Object.keys(v).find(uid => (v[uid]?.email||'')===ADMIN_EMAIL);
    return id || null;
  }

  async function sendFriendRequest(toUid){
    if(!auth.currentUser){ showAuth(); return; }
    const from=auth.currentUser.uid; if(from===toUid) return;
    await db.ref('friendRequests/'+toUid+'/'+from).set({ from, ts:Date.now() });
    await db.ref('friends/'+from+'/'+toUid).set({ status:'requested', ts:Date.now(), fromUid:from });
    await db.ref('notifications/'+toUid).push({ ts:Date.now(), type:'friend_req', text:`–ó–∞–ø–∏—Ç —É –¥—Ä—É–∑—ñ –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`, from });
    notify('OK','–ó–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ');
  }

  async function openPrivateChat(otherUid){
    if(!auth.currentUser){ showAuth(); return; }
    const uid=auth.currentUser.uid; const cid=convoIdFor(uid,otherUid);
    const panel=document.createElement('div'); panel.className='modal show'; panel.style.zIndex=1650;
    panel.innerHTML=`<div class="panel"><button class="close">‚úñ</button><h3>–î—ñ–∞–ª–æ–≥</h3>
    <div id="dmThread" style="max-height:55vh;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px;margin-bottom:8px;background:#fafafa"></div>
    <div style="display:flex;gap:6px"><input id="dmText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd"><button id="dmSend" class="tab-button">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button></div></div>`;
    document.body.appendChild(panel);
    panel.querySelector('.close').onclick=()=>panel.remove();
    const thread=panel.querySelector('#dmThread');

    // —ñ–Ω–¥–µ–∫—Å—É—î–º–æ –æ–±–∏–¥–≤–∞ —ñ–Ω–±–æ–∫—Å–∏ –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ —Å–ø–∏—Å–∫—É –¥—ñ–∞–ª–æ–≥—ñ–≤
    const metaA = db.ref('inboxMeta/'+uid+'/'+otherUid).set({ with:otherUid, ts:Date.now() });
    const metaB = db.ref('inboxMeta/'+otherUid+'/'+uid).set({ with:uid, ts:Date.now() });

    db.ref('privateMessages/'+cid).limitToLast(200).on('child_added',snap=>{
      const m=snap.val(); const row=document.createElement('div');
      row.style.margin="6px 0"; row.style.textAlign=m.from===uid?"right":"left";
      row.textContent=`${m.text} (${new Date(m.ts).toLocaleTimeString()})`; thread.appendChild(row); thread.scrollTop=thread.scrollHeight;
    });
    panel.querySelector('#dmSend').onclick=async()=>{
      const t=panel.querySelector('#dmText').value.trim(); if(!t) return;
      const pm={from:uid,to:otherUid,text:t,ts:Date.now()};
      await db.ref('privateMessages/'+cid).push(pm);
      await db.ref('notifications/'+otherUid).push({ ts:Date.now(), type:'dm', text:`–ù–æ–≤–µ –õ–° –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`, from:uid, convoId:cid });
      await db.ref('inboxMeta/'+uid+'/'+otherUid).update({ last:t, ts:pm.ts });
      await db.ref('inboxMeta/'+otherUid+'/'+uid).update({ last:t, ts:pm.ts });
      panel.querySelector('#dmText').value=""; SND.sent();
    };
  }

  async function refreshFriendsBlocks(){
    const u=auth.currentUser; if(!u){ friendsList.innerHTML=""; friendRequestsEl.innerHTML=""; friendsOnlineCountEl.textContent="0"; return; }
    const reqSnap=await db.ref('friendRequests/'+u.uid).get(); friendRequestsEl.innerHTML="";
    if(reqSnap.exists()){
      const reqs=reqSnap.val(); for(const fromUid of Object.keys(reqs)){
        const uSnap=await db.ref('users/'+fromUid).get(); const ud=uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
        const item=document.createElement('div'); item.style.cssText='display:flex;gap:8px;align-items:center;background:#fff;border-radius:10px;padding:8px;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,.06)';
        item.innerHTML=`<img src="${ud.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
        <div style="flex:1"><div style="font-weight:800;color:#0b1220;text-shadow:0 0 8px rgba(57,255,145,.8)">${escapeHtml(ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á')}</div><div class="muted" style="font-size:12px">–∑–∞—è–≤–∫–∞ —É –¥—Ä—É–∑—ñ</div></div>
        <div style="display:flex;gap:6px"><button class="tab-button btn-accept">‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏</button><button class="tab-button btn-decline" style="background:#ffe1e1">‚úñ</button></div>`;
        item.querySelector('.btn-accept').onclick=async()=>{
          await db.ref('friends/'+u.uid+'/'+fromUid).set({ status:'accepted', ts:Date.now() });
          await db.ref('friends/'+fromUid+'/'+u.uid).set({ status:'accepted', ts:Date.now() });
          await db.ref('friendRequests/'+u.uid+'/'+fromUid).remove();
          await db.ref('notifications/'+fromUid).push({ ts:Date.now(), type:'friend_ok', text:`${u.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'} –¥–æ–¥–∞–≤(–ª–∞) –≤–∞—Å —É –¥—Ä—É–∑—ñ`, from:u.uid });
          refreshFriendsBlocks(); SND.notify();
        };
        item.querySelector('.btn-decline').onclick=async()=>{
          await db.ref('friendRequests/'+u.uid+'/'+fromUid).remove(); await db.ref('friends/'+fromUid+'/'+u.uid).remove(); refreshFriendsBlocks();
        };
        friendRequestsEl.appendChild(item);
      }
    }else friendRequestsEl.innerHTML="<i>–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</i>";

    friendsList.innerHTML=""; const frSnap=await db.ref('friends/'+u.uid).get(); let onlineCount=0;
    if(frSnap.exists()){
      const fr=frSnap.val(); for(const fid of Object.keys(fr)){ const rel=fr[fid]; if(rel.status!=='accepted') continue;
        const uSnap=await db.ref('users/'+fid).get(); const ud=uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
        const pSnap=await db.ref('presence/'+fid).get(); const isOn=pSnap.exists(); if(isOn) onlineCount++;
        const d=document.createElement('div'); d.style.cssText='display:flex;gap:8px;align-items:center;background:#fff;border-radius:10px;padding:8px;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,.06)';
        d.innerHTML=`<img src="${ud.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
          <div style="flex:1"><div style="font-weight:800;color:#0b1220;text-shadow:0 0 8px rgba(57,255,145,.8)">${escapeHtml(ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á')}</div><div style="font-size:12px;color:${isOn?'#10b981':'#64748b'}">${isOn?'–æ–Ω–ª–∞–π–Ω':'–æ—Ñ–ª–∞–π–Ω'}</div></div>
          <div style="display:flex;gap:6px"><button class="tab-button btn-pm">‚úâÔ∏è</button><button class="tab-button btn-open">üëÄ</button></div>`;
        d.querySelector('.btn-open').onclick=()=>openProfile(fid);
        d.querySelector('.btn-pm').onclick=()=>openPrivateChat(fid);
        friendsList.appendChild(d);
      }
    } else friendsList.innerHTML="<i>–î–æ–¥–∞–π—Ç–µ –¥—Ä—É–∑—ñ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ—ñ–ª—ñ</i>";
    friendsOnlineCountEl.textContent=String(onlineCount);
  }

  function renderDMInbox(){
    const u=auth.currentUser; if(!u){ dmList.innerHTML="<i>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –±–∞—á–∏—Ç–∏ –õ–°</i>"; return; }
    db.ref('inboxMeta/'+u.uid).off();
    dmList.innerHTML="";
    db.ref('inboxMeta/'+u.uid).orderByChild('ts').limitToLast(200).on('child_added', async snap=>{
      const other=snap.key; const meta=snap.val();
      const uSnap=await db.ref('users/'+other).get(); const ud=uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
      const card=document.createElement('div'); card.style.cssText='display:flex;gap:8px;align-items:center;background:#fff;border-radius:10px;padding:8px;box-shadow:0 2px 8px rgba(0,0,0,.06)';
      card.innerHTML=`<img src="${ud.avatar||DEFAULT_AVATAR}" style="width:42px;height:42px;border-radius:10px;object-fit:cover">
        <div style="flex:1"><div style="font-weight:800">${escapeHtml(ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á')}</div><div class="muted" style="font-size:12px">${escapeHtml(meta.last||'–ë–µ–∑ —Ç–µ–∫—Å—Ç—É')}</div></div>
        <button class='tab-button'>–í—ñ–¥–∫—Ä–∏—Ç–∏</button>`;
      card.querySelector('button').onclick=()=> openPrivateChat(other);
      dmList.prepend(card);
    });
  }

  auth.onAuthStateChanged(u=>{
    if(u){ subscribeNotifications(u.uid); refreshFriendsBlocks(); renderDMInbox(); }
    else { notifList.innerHTML=""; friendRequestsEl.innerHTML=""; friendsList.innerHTML=""; dmList.innerHTML=""; }
    adminBar.style.display = (window.__isAdmin && document.getElementById('chatTab').style.display==='block') ? 'block' : 'none';
  });

  /* =========================
     –ß–ê–°–¢–¨ 3/3 ‚Äî –ß–∞—Ç, –∞–¥–º—ñ–Ω–∫–∞, –±–æ—Ç–∏, –∞–Ω—Ç–∏—Å–ø–∞–º –æ–ø–ª–∞—Ç–∏
     ========================= */
  const messagesEl      = document.getElementById("messages");
  const rentMessagesEl  = document.getElementById("rentMessages");
  const chatAreaMain    = document.getElementById("chatArea");
  const chatAreaRent    = document.getElementById("rentArea");
  const messageInput    = document.getElementById("messageInput");
  const sendButton      = document.getElementById("sendButton");
  const fileInput       = document.getElementById("fileInput");

  let MSG_LIMIT=300;
  function timeStr(ts){ return new Date(ts).toLocaleString(); }
  function isNearBottom(area){ return (area.scrollHeight - area.scrollTop - area.clientHeight) < 160; }
  function scrollToBottom(area){ area.scrollTop = area.scrollHeight; }

  function renderMessage(m,container){
    if(!m||!m.ts) return;
    const wrap=document.createElement('div');
    wrap.className="message"+((auth.currentUser&&m.uid===auth.currentUser.uid)?" self":"");
    wrap.dataset.uid=m.uid||""; wrap.dataset.msgid=m.id||"";

    const avatar=document.createElement('img');
    avatar.className="avatar"; avatar.src=m.avatar||DEFAULT_AVATAR; avatar.alt=m.nick||"avatar";
    avatar.title=m.nick||"–ü—Ä–æ—Ñ—ñ–ª—å"; avatar.onclick=()=>openProfile(m.uid);

    const txt=document.createElement('div'); txt.className="message-content";
    const meta=document.createElement('div'); meta.className="message-meta";
    meta.textContent=`${m.nick||"–ê–Ω–æ–Ω—ñ–º"} ¬∑ ${timeStr(m.ts)}` + (m.recipientUid?" ¬∑ –æ—Å–æ–±–∏—Å—Ç–µ":"");
    txt.appendChild(meta);

    if(m.text){ const p=document.createElement('div'); p.className='text'; p.innerText=m.text; txt.appendChild(p); }
    if(m.image){ const im=document.createElement('img'); im.src=m.image; im.className='chat-image'; im.alt='–§–æ—Ç–æ'; txt.appendChild(im); }

    const area=container.closest('.chat-area'); const stick=area?isNearBottom(area):false;
    wrap.appendChild(avatar); wrap.appendChild(txt); container.appendChild(wrap);
    if(area&&stick) scrollToBottom(area);
  }

  db.ref('messages').limitToLast(MSG_LIMIT).on('child_added',snap=>{
    const m=snap.val(); m.id=snap.key; renderMessage(m, messagesEl);
    clearTimeout(window._scrollMainInit); window._scrollMainInit=setTimeout(()=>{scrollToBottom(chatAreaMain)},60);
  });
  db.ref('rentMessages').limitToLast(MSG_LIMIT).on('child_added',snap=>{
    const m=snap.val(); m.id=snap.key; renderMessage(m, rentMessagesEl);
    clearTimeout(window._scrollRentInit); window._scrollRentInit=setTimeout(()=>{scrollToBottom(chatAreaRent)},60);
  });
  function activeChatPath(){ return document.getElementById('rentTab').style.display==="block" ? "rentMessages" : "messages"; }

  async function isBanned(uid){ const s = await db.ref('settings/userFlags/'+uid+'/banned').get(); return s.val()===true; }
  async function canSend(){ return !!auth.currentUser && !(await isBanned(auth.currentUser.uid)); }

  // –∑–µ–ª—ë–Ω–∞—è –ø–ª–∞—à–∫–∞ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ
  const photoToast=document.getElementById('photoToast');
  fileInput.addEventListener('change',()=>{ if(fileInput.files[0]){ photoToast.style.display='block'; setTimeout(()=> photoToast.style.display='none', 3600); } });

  sendButton.addEventListener('click', async ()=>{
    if(!auth.currentUser){ showAuth(); return; }
    if(!await canSend()){ notify('–î–æ—Å—Ç—É–ø','–í–∞—à –∞–∫–∞—É–Ω—Ç –æ–±–º–µ–∂–µ–Ω–æ (–±–∞–Ω)'); return; }
    const text=messageInput.value.trim(); const file=fileInput.files[0]; if(!text && !file) return;
    let imageData=null; if(file){ try{ imageData=await fileToDataURL(file,900,.9); } catch{ notify('–§–æ—Ç–æ','–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–æ–±–∏—Ç–∏'); return; } }
    const msg={ uid:auth.currentUser.uid, nick:auth.currentUser.displayName||auth.currentUser.email||"–ê–Ω–æ–Ω—ñ–º", avatar:auth.currentUser.photoURL||DEFAULT_AVATAR, text:text||null, image:imageData||null, ts:Date.now(), recipientUid:null };
    try{ await db.ref(activeChatPath()).push(msg); messageInput.value=""; fileInput.value=""; SND.sent(); notify('OK','–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ'); }
    catch{ notify('–ü–æ–º–∏–ª–∫–∞','–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏'); }
  });
  messageInput.addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendButton.click(); } });

  // –ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫ –ø–æ–¥–ø–∏—Å–∫–∏
  auth.onAuthStateChanged(u=>{ if(u){ subscribeNotifications(u.uid); refreshFriendsBlocks(); renderDMInbox(); } });

  /* –ê–¥–º—ñ–Ω–∫–∞ */
  const SUB_PLAN = {
    none:       { key:'none',        label:'‚Äî',                 badge:'linear-gradient(90deg,#e5e7eb,#f8fafc)', color:'#111' },
    trial:      { key:'trial',       label:'–ü–†–ï–ú–Ü–£–ú ‚Ä¢ TRIAL',   badge:'linear-gradient(90deg,#a78bfa,#c084fc)', color:'#fff' },
    premium:    { key:'premium',     label:'–ü–†–ï–ú–Ü–£–ú',           badge:'linear-gradient(90deg,#22c55e,#16a34a)', color:'#fff' },
    premiumPlus:{ key:'premiumPlus', label:'–ü–†–ï–ú–Ü–£–ú+',          badge:'linear-gradient(90deg,#06b6d4,#0ea5e9)', color:'#fff' }
  };

  let _allUsers = []; let _userFlags = {}; let _presence = {};
  const $adminUsersModal = document.getElementById('adminUsersModal');
  const $usersTBody      = document.getElementById('usersTBody');
  const $userSearch      = document.getElementById('userSearch');
  const $usersTotal      = document.getElementById('usersTotal');
  const $usersShown      = document.getElementById('usersShown');
  const $adminUsersClose = document.getElementById('adminUsersClose');

  db.ref('presence').on('value', s=>{ _presence=s.val()||{}; if($adminUsersModal.classList.contains('show')) renderUsersTable(_allUsers); });
  db.ref('settings/userFlags').on('value', s=>{ _userFlags=s.val()||{}; if($adminUsersModal.classList.contains('show')) renderUsersTable(_allUsers); });

  membersBtn.addEventListener('click', ()=>{ if(!window.__isAdmin){ notify('–í—ñ–¥–º–æ–≤–∞','–¢—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω–∞'); return; } $adminUsersModal.classList.add('show'); loadUsers(); });
  $adminUsersClose.addEventListener('click', ()=> $adminUsersModal.classList.remove('show'));
  $userSearch.addEventListener('input', ()=> renderUsersTable(_allUsers));

  async function loadUsers(){ const s=await db.ref('users').get(); const obj=s.val()||{}; _allUsers=Object.keys(obj).map(uid=>({uid,...obj[uid]})); $usersTotal.textContent=String(_allUsers.length); renderUsersTable(_allUsers); }

  function renderUsersTable(list){
    if(!$usersTBody) return; const q=($userSearch.value||'').trim().toLowerCase();
    const filtered=list.filter(u=>!q||(u.nick||'').toLowerCase().includes(q)||(u.email||'').toLowerCase().includes(q)).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    $usersShown.textContent=String(filtered.length); $usersTBody.innerHTML='';
    filtered.forEach(u=>{
      const flags=_userFlags[u.uid]||{}; const banned=!!flags.banned; const premKey=flags.premium||'none'; const plan=SUB_PLAN[premKey]||SUB_PLAN.none; const online=!!_presence[u.uid];
      const tr=document.createElement('tr'); tr.innerHTML=`
        <td>
          <div style="display:flex;gap:10px;align-items:center">
            <span title="${online?'–û–Ω–ª–∞–π–Ω':'–û—Ñ–ª–∞–π–Ω'}" style="display:inline-block;width:10px;height:10px;border-radius:999px;background:${online?'#22c55e':'#94a3b8'}"></span>
            <img src="${u.avatar||DEFAULT_AVATAR}" style="width:36px;height:36px;border-radius:10px;object-fit:cover">
            <div>
              <div style="font-weight:800">${escapeHtml(u.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á')}</div>
              <div class="muted" style="font-size:12px">${u.uid.slice(0,8)}‚Ä¶</div>
            </div>
          </div>
        </td>
        <td class="muted">${escapeHtml(u.email||'')}</td>
        <td>${banned?'<span class="user-badge" style="background:#fee2e2;color:#991b1b">–ó–∞–±–∞–Ω–µ–Ω–æ</span>':'<span class="user-badge">OK</span>'}</td>
        <td><span class="user-badge" style="background:${plan.badge};color:${plan.color};font-weight:900">${plan.label}</span></td>
        <td>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            ${banned?`<button class="btn-mini" data-act="unban" data-uid="${u.uid}">–†–æ–∑–±–∞–Ω–∏—Ç–∏</button>`:`<button class="btn-mini btn-red" data-act="ban" data-uid="${u.uid}">–ó–∞–±–∞–Ω–∏—Ç–∏</button>`}
            <button class="btn-mini" data-act="grant100" data-uid="${u.uid}">–î–æ–Ω–∞—Ç 100</button>
            <button class="btn-mini" data-act="grant199" data-uid="${u.uid}">–î–æ–Ω–∞—Ç 199</button>
            <button class="btn-mini" data-act="pm" data-uid="${u.uid}">‚úâÔ∏è –õ–°</button>
            <button class="btn-mini" data-act="open" data-uid="${u.uid}">üëÄ –ü—Ä–æ—Ñ—ñ–ª—å</button>
          </div>
        </td>`;
      $usersTBody.appendChild(tr);
    });
    $usersTBody.querySelectorAll('button[data-act]').forEach(btn=> btn.onclick=()=> adminUserAction(btn.dataset.act, btn.dataset.uid));
  }

  async function adminUserAction(act, uid){
    if (!window.__isAdmin){ notify('–í—ñ–¥–º–æ–≤–∞','–ü–æ—Ç—Ä—ñ–±–Ω—ñ –ø—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω–∞'); return; }
    try{
      if (act==='ban'){
        await db.ref('settings/userFlags/'+uid).update({ banned:true, updatedBy:auth.currentUser.uid });
        await db.ref('notifications/'+uid).push({ts:Date.now(),type:'system',text:'–í–∞—à –∞–∫–∞—É–Ω—Ç —Ç–∏–º—á–∞—Å–æ–≤–æ –æ–±–º–µ–∂–µ–Ω–æ (–±–∞–Ω).'});
        notify('OK','–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞–±–∞–Ω–µ–Ω–æ');
      }else if (act==='unban'){
        await db.ref('settings/userFlags/'+uid).update({ banned:false, updatedBy:auth.currentUser.uid });
        await db.ref('notifications/'+uid).push({ts:Date.now(),type:'system',text:'–ë–∞–Ω –∑–Ω—è—Ç–æ. –î–æ—Å—Ç—É–ø –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ.'});
        notify('OK','–ë–∞–Ω –∑–Ω—è—Ç–æ');
      }else if (act==='grant100'){
        await db.ref('settings/userFlags/'+uid).update({ premium:'premium', premiumSince:Date.now(), updatedBy:auth.currentUser.uid });
        await db.ref('notifications/'+uid).push({ts:Date.now(), type:'premium', text:`–ê–∫—Ç–∏–≤–æ–≤–∞–Ω–æ –ø–ª–∞–Ω BASIC (100 Kƒç). –î—è–∫—É—î–º–æ –∑–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫—É!`});
        notify('OK','–í–∏–¥–∞–Ω–æ BASIC 100');
      }else if (act==='grant199'){
        await db.ref('settings/userFlags/'+uid).update({ premium:'premiumPlus', premiumSince:Date.now(), updatedBy:auth.currentUser.uid });
        await db.ref('notifications/'+uid).push({ts:Date.now(), type:'premium', text:`–ê–∫—Ç–∏–≤–æ–≤–∞–Ω–æ –ø–ª–∞–Ω PRO (199 Kƒç). –î—è–∫—É—î–º–æ!`});
        notify('OK','–í–∏–¥–∞–Ω–æ PRO 199');
      }else if (act==='pm'){
        openPrivateChat(uid);
      }else if (act==='open'){
        openProfile(uid);
      }
    }catch(e){ console.error(e); notify('–ü–æ–º–∏–ª–∫–∞ –¥—ñ—ó','–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑'); }
  }

  // –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–ª—è –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö ‚Äî —É–∂–µ —É—á—Ç–µ–Ω–æ –≤ canSend()

  /* –ë–û–¢-–û–ü–û–í–Ü–©–ï–ù–ù–Ø –ü–†–û –ü–õ–ê–¢–ï–ñ–Ü ‚Äî –∞–Ω—Ç–∏—Å–ø–∞–º */
  function looksLikePaymentText(t){ if (!t) return false; const s=t.toLowerCase(); return s.includes('–æ–ø–ª–∞—Ç')||s.includes('–ø–ª–∞—Ç—ñ–∂')||s.includes('payment')||s.includes('–¥–æ–Ω–∞—Ç')||s.includes('premium')||s.includes('199')||s.includes('100')||s.includes('354037257')||s.includes('0300'); }
  const _seenPay = new Set();
  function watchPaymentsInFeed(){
    const feed = db.ref('messages').limitToLast(200);
    feed.on('child_added', async snap=>{
      const m=snap.val()||{}; if(!m.uid) return; const hint=(m.image||looksLikePaymentText(m.text)); if(!hint) return;
      if(_seenPay.has(snap.key)) return; _seenPay.add(snap.key);
      const exists=(await db.ref('settings/paymentInboxSeen/'+snap.key).get()).exists(); if(exists) return;
      await db.ref('settings/paymentInboxSeen/'+snap.key).set(true);
      await db.ref('settings/paymentInbox').push({ fromUid:m.uid, ts:m.ts||Date.now(), messageId:snap.key, imageUrl:m.image||null, text:m.text||null }).catch(()=>{});
      const adminId = await getAdminUid(); if(adminId){ await db.ref('notifications/'+adminId).push({ ts:Date.now(), type:'pay', text:`–ú–æ–∂–ª–∏–≤–∞ –æ–ø–ª–∞—Ç–∞ –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤—Ä—É—á–Ω—É` }).catch(()=>{}); }
    });
  }
  watchPaymentsInFeed();

  /* –ë–û–¢–ò (–º–∞—Å–∫–∞ –ø—ñ–¥ —Å–ø—Ä–∞–≤–∂–Ω—ñ—Ö) */
  if (!window.BOTS_DEF){
    window.BOTS_DEF = [
      { id:'bot_1', nick:"–ú–∞—Ä–∏–Ω–∞", avatar:"https://i.ibb.co/LH4wBMS/IMG-d8e6076e17f19db7fe3add0754738a01-V.jpg",
        posts:[
          {text:`O2 –°–Ü–ú –ö–ê–†–¢–ê
–ë–µ–∑ –ª—ñ–º—ñ—Ç —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç —ñ –¥–∑–≤—ñ–Ω–∫–∏, –Ñ–°. 699 Kƒç/–º—ñ—Å. –°—Ç–∞—Ä—Ç 299 Kƒç. 607 914 467`, image:"https://i.ibb.co/LH4wBMS/IMG-d8e6076e17f19db7fe3add0754738a01-V.jpg"},
          {text:`–ü—Ä–æ–¥–∞—é iPhone 11 Pro Max + 26 —á–æ—Ö–ª—ñ–≤. –ë–µ–∑ Apple ID. –ü–∏—à—ñ—Ç—å —É –ø—Ä–∏–≤–∞—Ç.`, image:"https://i.ibb.co/dwcXPqDr/IMG-1954f6b56869b9817a131ae33f3a37b6-V.jpg"},
          {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è`, image:"https://i.ibb.co/G3kDcrYZ/IMG-fa590121e46c5b030c5ddc94d4e8bea9-V.jpg"}
        ], baseInterval: 2*60*1000 },
      { id:'bot_2', nick:"–ê–Ω—Ç–æ–Ω", avatar:"https://i.ibb.co/Z11WVrVC/IMG-b83692bb79a1468af74c81620750e8c0-V.jpg",
        posts:[
          {text:`–®–∞–±–ª–æ–Ω`, image:"https://i.ibb.co/Z11WVrVC/IMG-b83692bb79a1468af74c81620750e8c0-V.jpg"},
          {text:`–®—É–∫–∞—é –º–æ–¥–µ–ª–µ–π –Ω–∞ –ø–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω–∏–π –º–∞–∫—ñ—è–∂ (–ü—Ä–∞–≥–∞). –õ–∏—à–µ –∑–∞ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏.`, image:"https://i.ibb.co/QFWD5wG/IMG-6748e7141906901b131b8fd5130a5c01-V.jpg"},
          {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è 3`, image:"https://i.ibb.co/j97RhTn/IMG-593d75b053ea1a28cdfb9fc52f93afad-V.jpg"}
        ], baseInterval: 3*60*1000 },
      { id:'bot_3', nick:"–û–ª–µ–≥", avatar:"https://i.ibb.co/MzdTMPR/IMG-8231d8142ffcbba7c682ca598683e3f2-V.jpg",
        posts:[
          {text:`–ü–æ—Ç—Ä—ñ–±–µ–Ω –≤–æ–¥—ñ–π –¥–ª—è –ø–µ—Ä–µ—ó–∑–¥—É. WhatsApp: +48 793 463 757`, image:null},
          {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è`, image:"https://i.ibb.co/MzdTMPR/IMG-8231d8142ffcbba7c682ca598683e3f2-V.jpg"},
          {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è 3`, image:"https://i.ibb.co/rfNV6dd/IMG-0cd648a74f86227fe46db2d01c099be0-V.jpg"}
        ], baseInterval: 4*60*1000 }
    ];
  }

  const BotController = (()=>{
    const timers=new Map(), indices=new Map(), speeds=new Map();
    function nextPost(id,posts){ const i=(indices.get(id)||0); indices.set(id, i+1); return posts[i%posts.length]; }
    async function post(bot){ const p=nextPost(bot.id,bot.posts); try{ await db.ref('messages').push({ uid:bot.id, nick:bot.nick, avatar:bot.avatar, text:p.text, image:p.image||null, ts:Date.now() }); }catch(e){ console.error('bot push', e); } }
    function isRunning(id){ return timers.has(id); }
    function computeInterval(bot){ const mult=speeds.get(bot.id)||1; const min=15000; return Math.max(min, bot.baseInterval/mult); }
    function start(bot){ if(isRunning(bot.id)) return; const tick=async()=>{ await post(bot); schedule(); }; function schedule(){ const t=setTimeout(tick, computeInterval(bot)); timers.set(bot.id,t); updateChip(bot.id); } schedule(); }
    function stop(id){ const t=timers.get(id); if(t){ clearTimeout(t); timers.delete(id); updateChip(id); } }
    function setSpeed(id,m){ speeds.set(id,m); if (timers.has(id)){ clearTimeout(timers.get(id)); timers.delete(id); const b=BOTS_DEF.find(x=>x.id===id); if(b) start(b); } updateChip(id); }
    function postOnce(bot){ return post(bot); }
    function stopAll(){ Array.from(timers.keys()).forEach(stop); }
    function startAll(){ BOTS_DEF.forEach(start); }
    function postOnceAll(){ return Promise.all(BOTS_DEF.map(postOnce)); }
    function updateChip(id){ const chip=document.querySelector(`[data-bot='${id}']`); if(!chip) return; const running=isRunning(id); chip.querySelector('.state').textContent = running?'‚óè –ø—Ä–∞—Ü—é—î':'‚óã –∑—É–ø–∏–Ω–µ–Ω–æ'; chip.querySelector('.toggle').textContent= running?'‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏':'‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏'; }
    return {start,stop,setSpeed,postOnce,stopAll,startAll,postOnceAll,isRunning};
  })();

  (function initAdminBotsUI(){
    const box = document.getElementById('botsRow');
    function chip(bot){
      const w=document.createElement('div'); w.className='user-badge'; w.dataset.bot=bot.id; w.style.gap='8px';
      w.innerHTML = `
        <img src="${bot.avatar}" style="width:26px;height:26px;border-radius:6px;object-fit:cover">
        <b>${bot.nick}</b>
        <span class="state" style="font-size:12px;opacity:.8">‚óã –∑—É–ø–∏–Ω–µ–Ω–æ</span>
        <button class="toggle btn-mini">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏</button>
        <button class="once btn-mini" style="background:#fff3cd">‚ö°Ô∏è –†–∞–∑</button>
        <label style="font-size:12px">—à–≤–∏–¥–∫. <input type="range" min="0.5" max="3" step="0.1" value="1" class="speed"></label>
        <span class="speedv" style="font-size:12px">1√ó</span>`;
      const $toggle=w.querySelector('.toggle'); const $once=w.querySelector('.once'); const $range=w.querySelector('.speed'); const $speedv=w.querySelector('.speedv');
      $toggle.onclick=()=>{ BotController[ BotController.isRunning(bot.id)?'stop':'start'](bot); };
      $once.onclick=()=> BotController.postOnce(bot);
      $range.oninput=()=>{ const v=Number($range.value)||1; $speedv.textContent=v.toFixed(1)+'√ó'; BotController.setSpeed(bot.id,v); localStorage.setItem('bot_speed_'+bot.id,String(v)); };
      const saved=Number(localStorage.getItem('bot_speed_'+bot.id)||'1'); if(!Number.isNaN(saved)&&saved){ $range.value=String(saved); $speedv.textContent=saved.toFixed(1)+'√ó'; BotController.setSpeed(bot.id,saved); }
      return w;
    }
    if (box){ box.innerHTML=''; BOTS_DEF.forEach(b=> box.appendChild(chip(b))); }
    document.getElementById('startAll')?.addEventListener('click', ()=> BotController.startAll());
    document.getElementById('stopAll')?.addEventListener('click',  ()=> BotController.stopAll());
    document.getElementById('postOnceAll')?.addEventListener('click',()=> BotController.postOnceAll());
  })();

  </script>
</body>
</html>
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Praha Fu≈°ky ‚Äî —Å–æ—Ü—á–∞—Ç</title>

  <!-- –®–†–ò–§–¢–ò -->
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- Leaflet (–∫–∞—Ä—Ç–∞ –±–µ–∑ –∫–ª—é—á–∞) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --accent:#22c55e; --accent-2:#10b981; --danger:#ef4444;
      --glass:rgba(255,255,255,.96); --muted:#64748b; --ink:#0b1220;
      --max:1020px; --avatar:44px; --header-h:66px; --chat-scale:1.08;
      --shadow:0 18px 60px rgba(2,6,23,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#071126;color:var(--ink);overflow-x:hidden}
    body{font-family:Poppins,system-ui,-apple-system,"Segoe UI",Arial,sans-serif;
         background:url('https://i.ibb.co/27hgtZfY/Prague.jpg') center/cover fixed}

    /* Header */
    header{position:sticky;top:0;z-index:1000;padding:6px 8px;text-align:center;color:#fff;backdrop-filter:blur(3px)}
    .brandRow{display:flex;align-items:center;justify-content:center;gap:10px;min-height:var(--header-h);position:relative}
    .profile-btn,.bell-btn,.gear-btn,.members-btn{
      position:absolute;top:8px;width:46px;height:46px;border-radius:50%;border:2px solid rgba(255,255,255,.9);
      display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35);color:#fff;background:rgba(0,0,0,.28)
    }
    .profile-btn{left:8px;background-size:cover;background-position:center}
    .gear-btn{right:112px;display:none}
    .members-btn{right:64px;display:none}
    .bell-btn{right:8px}
    .bell-badge{position:absolute;top:-6px;right:-6px;background:#ff3366;color:#fff;border-radius:12px;padding:2px 6px;font-size:12px;font-weight:700;box-shadow:0 0 10px rgba(255,51,102,.9);display:none}
    header h1{
      margin:0;font-family:'UnifrakturCook',cursive;font-weight:700;font-size:34px;letter-spacing:1px;text-transform:uppercase;
      background:linear-gradient(90deg,#22c55e,#ef4444);-webkit-background-clip:text;background-clip:text;color:transparent;
      text-shadow:0 2px 0 rgba(0,0,0,.55),0 6px 18px rgba(0,0,0,.6)
    }
    header .sub{margin:4px auto 0;font-size:13px;color:#e8ffee;display:inline-block;padding:6px 10px;border-radius:10px;background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.08)}

    /* Tabs */
    .topBar{position:sticky;top:var(--header-h);z-index:900}
    .neon-wrap{max-width:var(--max);margin:6px auto 0;padding:6px 8px}
    .neon-tabs{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .tab-button{border:none;font-weight:800;letter-spacing:.2px;cursor:pointer;border-radius:12px;padding:8px 14px;color:#021f13;background:#cfffdf;box-shadow:0 0 12px rgba(34,197,94,.35),inset 0 -3px 0 rgba(0,0,0,.06);transition:.15s transform,.15s box-shadow}
    .tab-button:hover{transform:translateY(-1px);box-shadow:0 0 16px rgba(34,197,94,.8),inset 0 -3px 0 rgba(0,0,0,.06)}
    .tab-button.active{outline:2px solid #39ff91;box-shadow:0 0 18px rgba(57,255,145,.9),inset 0 -3px 0 rgba(0,0,0,.06)}
    .online-neon{margin:6px auto 8px;max-width:var(--max);text-align:center;color:#baffd1;font-weight:800;text-shadow:0 0 8px rgba(57,255,145,.9);background:rgba(0,0,0,.35);border:1px solid rgba(57,255,145,.35);border-radius:10px;padding:6px 10px}

    main.container{max-width:var(--max);margin:0 auto;padding:8px}
    .tab-content{display:none}
    .tab-content.active{display:block}

    /* Chat feed */
    .chat-area{height:calc(100vh - 320px);overflow:auto;padding:10px 6px}
    .messages{display:flex;flex-direction:column;gap:12px;padding-bottom:220px;transform:scale(var(--chat-scale));transform-origin:bottom left}
    .message{display:flex;gap:10px;align-items:flex-start;max-width:78%;word-break:break-word}
    .message.self{margin-left:auto;flex-direction:row-reverse}
    .avatar{width:var(--avatar);height:var(--avatar);border-radius:50%;object-fit:cover;flex:0 0 var(--avatar);box-shadow:0 3px 10px rgba(0,0,0,.35);cursor:pointer}
    .message-content{background:var(--glass);padding:10px 12px;border-radius:14px;box-shadow:0 6px 30px rgba(2,6,23,.18);color:var(--ink);position:relative}
    .message.self .message-content{background:#E9FFF0}
    .message-meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .chat-image{max-width:300px;border-radius:8px;margin-top:8px;display:block}
    .message-content .text{font-weight:600;font-size:1rem;white-space:pre-wrap}
    .msg-actions{position:absolute;right:6px;top:6px;opacity:.7;font-size:12px}
    .msg-actions button{border:none;background:transparent;cursor:pointer}

    /* Input bar */
    .chat-input{position:fixed;left:0;right:0;bottom:0;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,.96),rgba(255,255,255,.99));border-top:1px solid rgba(0,0,0,.06);z-index:1200;display:flex;gap:8px;align-items:center;max-width:var(--max);margin:0 auto}
    .camera-btn{display:inline-flex;align-items:center;justify-content:center;cursor:pointer;width:48px;height:48px;border-radius:50%;background:#fff;border:1px solid #e6e6e6}
    .camera-btn svg{width:20px;height:20px}
    .chat-input input[type="text"]{flex:1;padding:12px 14px;border-radius:24px;border:1px solid #d0d7de;font-size:16px;outline:none}
    .send-btn{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:20px;font-weight:800;cursor:pointer;box-shadow:0 8px 20px rgba(34,197,94,.18)}

    /* Modals */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);}
    .modal.show{display:flex}
    .modal .panel{background:#fff;border-radius:16px;padding:16px;width:92%;max-width:880px;position:relative;box-shadow:var(--shadow)}
    .modal .close{position:absolute;right:10px;top:8px;background:transparent;border:none;font-size:18px;cursor:pointer}
    .modal.full .panel{width:98%;max-width:none;height:92vh;display:flex;flex-direction:column}

    .notif-item{border-bottom:1px solid #eee;padding:8px}
    .notif-head{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .notif-actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .btn{border:none;border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer}
    .btn-accept{background:#dcfce7}.btn-decline{background:#fee2e2}.btn-open{background:#fff3cd}

    .admin-users-head{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .admin-users-body{flex:1;overflow:auto;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    .grid-users{width:100%;border-collapse:collapse}
    .grid-users th,.grid-users td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left;vertical-align:middle}
    .grid-users th{position:sticky;top:0;background:#f8fafc;z-index:1}
    .user-badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 8px;font-size:12px;background:#f1f5f9}
    .btn-mini{border:none;border-radius:8px;padding:6px 8px;font-weight:700;cursor:pointer;background:#eef2ff}
    .btn-mini.btn-red{background:#ffe1e1}

    .msg-menu{position:absolute;background:#fff;border-radius:8px;padding:6px;box-shadow:0 6px 20px rgba(0,0,0,.2);z-index:2000;display:none}
    .msg-menu button{display:block;border:none;background:transparent;padding:6px 10px;text-align:left;width:100%;cursor:pointer}
    .msg-menu button:hover{background:rgba(0,0,0,.03)}

    .pill-title{margin:10px 0 6px;color:#eafff3;font-weight:900;text-shadow:0 0 10px rgba(57,255,145,.9);}

    /* –ó–µ–ª–µ–Ω–∞—è –≥–∞–ª–∫–∞ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ */
    .photo-toast{position:fixed;left:50%;transform:translateX(-50%);bottom:86px;background:#dcfce7;border:1px solid #16a34a;color:#065f46;padding:8px 12px;border-radius:12px;font-weight:800;box-shadow:0 10px 30px rgba(0,0,0,.15);display:none;z-index:1300}

    @media (max-width:640px){
      .chat-area{height:calc(100vh - 360px)}
      .chat-image{max-width:200px}
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="brandRow">
      <button id="profileBtn" class="profile-btn" title="–ü—Ä–æ—Ñ—ñ–ª—å" aria-label="–ü—Ä–æ—Ñ—ñ–ª—å"></button>
      <h1>PRAHA FU≈†KY</h1>
      <button id="gearBtn" class="gear-btn" title="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è" aria-label="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è">‚öôÔ∏è</button>
      <button id="membersBtn" class="members-btn" title="–£—á–∞—Å–Ω–∏–∫–∏" aria-label="–£—á–∞—Å–Ω–∏–∫–∏">üë•</button>
      <button id="bellBtn" class="bell-btn" title="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è" aria-label="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è">üîî<span id="bellBadge" class="bell-badge">0</span></button>
    </div>
    <div class="sub">–î–æ–ø–æ–º–∞–≥–∞—î–º–æ —É–∫—Ä–∞—ó–Ω—Ü—è–º —É –ü—Ä–∞–∑—ñ ‚Äî —Å–ø—ñ–ª—å–Ω–æ—Ç–∞, —á–∞—Ç, –æ—Ä–µ–Ω–¥–∞, –¥–æ–ø–æ–º–æ–≥–∞.</div>
  </header>

  <!-- TOP TABS -->
  <div class="topBar">
    <div class="neon-wrap">
      <nav class="neon-tabs" role="tablist" aria-label="–í–∫–ª–∞–¥–∫–∏">
        <button class="tab-button active" data-target="chatTab">üí¨ –ß–∞—Ç</button>
        <button class="tab-button" data-target="rentTab">üè† –û—Ä–µ–Ω–¥–∞</button>
        <button class="tab-button" data-target="mapTab">üó∫Ô∏è –ö–∞—Ä—Ç–∞</button>
        <button class="tab-button" data-target="friendsTab">üë• –î—Ä—É–∑—ñ</button>
        <button class="tab-button" data-target="dmTab">‚úâÔ∏è –û—Å–æ–±–∏—Å—Ç—ñ</button>
      </nav>
      <div class="online-neon" id="onlineNeon">–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): 0</div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="container" role="main">
    <!-- –ê–¥–º—ñ–Ω—Å—å–∫–∞ —Å–º—É–∂–∫–∞ –ø–æ–≤–µ—Ä—Ö —á–∞—Ç–∞ -->
    <div id="adminBar" style="display:none; margin-bottom:8px; background:rgba(255,255,255,.86); border:1px solid #e5e7eb; border-radius:12px; padding:8px; box-shadow:var(--shadow)">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <div style="font-weight:900">–ê–¥–º—ñ–Ω ‚Ä¢ –ë–æ—Ç–∏</div>
        <div style="display:flex;gap:6px;align-items:center">
          <button id="startAll" class="tab-button" style="padding:6px 10px">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—Å—ñ—Ö</button>
          <button id="stopAll" class="tab-button"  style="padding:6px 10px;background:#ffe1e1">‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏ –≤—Å—ñ—Ö</button>
          <button id="postOnceAll" class="tab-button" style="padding:6px 10px;background:#fff3cd">‚ö°Ô∏è –ü–æ—Å—Ç —Ä–∞–∑–æ–º</button>
        </div>
      </div>
      <div class="pill-title">–ü—Ä–æ—Ñ—ñ–ª—ñ ¬´–∞–∫—Ç–∏–≤—ñ—Å—Ç—ñ–≤¬ª:</div>
      <div id="botsRow" style="display:flex;gap:8px;flex-wrap:wrap"></div>
    </div>

    <!-- –ß–ê–¢ -->
    <section id="chatTab" class="tab-content active" role="region" aria-label="–ß–∞—Ç">
      <div class="chat-area" id="chatArea" aria-live="polite">
        <div id="messages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- –ß–ê–¢ –û–†–ï–ù–î–ê -->
    <section id="rentTab" class="tab-content" role="region" aria-label="–ß–∞—Ç –û—Ä–µ–Ω–¥–∞">
      <div class="chat-area" id="rentArea">
        <div id="rentMessages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- –ö–ê–†–¢–ê -->
    <section id="mapTab" class="tab-content" role="region" aria-label="–ö–∞—Ä—Ç–∞">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
        <input id="mapSearch" placeholder="–ü–æ—à—É–∫ (–≤–æ–ª–æ–Ω—Ç–µ—Ä–∏, –∞–ø—Ç–µ–∫–∞‚Ä¶)" style="flex:1;min-width:220px;padding:10px;border-radius:10px;border:1px solid #ddd" />
        <button class="tab-button" data-f="all">–£—Å–µ</button>
        <button class="tab-button" data-f="volunteer">–í–æ–ª–æ–Ω—Ç–µ—Ä–∏</button>
        <button class="tab-button" data-f="aid">–î–æ–ø–æ–º–æ–≥–∞</button>
        <button class="tab-button" data-f="pharmacy">–ê–ø—Ç–µ–∫–∏</button>
        <button id="centerBtn" class="tab-button" style="padding:6px 10px">–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏</button>
      </div>
      <div id="map" style="width:100%;height:60vh;border-radius:10px;background:#eaf7ff"></div>
    </section>

    <!-- –î–†–£–ó–Ü -->
    <section id="friendsTab" class="tab-content" role="region" aria-label="–î—Ä—É–∑—ñ">
      <h2 class="pill-title" style="margin-top:0">–î—Ä—É–∑—ñ —Ç–∞ –∑–∞—è–≤–∫–∏</h2>
      <div class="friends-wrap" style="display:grid;grid-template-columns:1fr;gap:12px">
        <div>
          <h3 style="color:#fff;margin:6px 0;text-shadow:0 0 10px rgba(57,255,145,.9)">–ó–∞—è–≤–∫–∏</h3>
          <div id="friendRequests"></div>
        </div>
        <div>
          <h3 style="color:#fff;margin:6px 0;text-shadow:0 0 10px rgba(57,255,145,.9)">–ú–æ—ó –¥—Ä—É–∑—ñ (<span id="friendsOnlineCount">0</span> –æ–Ω–ª–∞–π–Ω)</h3>
          <div id="friendsList"></div>
        </div>
      </div>
    </section>

    <!-- –õ–° (—ñ–Ω–±–æ–∫—Å –¥—ñ–∞–ª–æ–≥—ñ–≤) -->
    <section id="dmTab" class="tab-content" role="region" aria-label="–û—Å–æ–±–∏—Å—Ç—ñ">
      <h2 class="pill-title" style="margin:6px 0">–ú–æ—ó –¥—ñ–∞–ª–æ–≥–∏</h2>
      <div id="dmList" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px"></div>
    </section>
  </main>

  <!-- –§—ñ–∫—Å–æ–≤–∞–Ω–∞ –ø–∞–Ω–µ–ª—å –≤–≤–æ–¥—É -->
  <input id="fileInput" type="file" accept="image/*" style="display:none" />
  <div class="chat-input" role="region" aria-label="–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">
    <label for="fileInput" class="camera-btn" id="cameraLabel" aria-hidden="true">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M4 7H6L7 5H17L18 7H20C21.1 7 22 7.9 22 9V19C22 20.1 21.1 21 20 21H4C2.9 21 2 20.1 2 19V9C2 7.9 2.9 7 4 7Z" fill="#111"/><circle cx="12" cy="13" r="3.5" fill="#fff"/></svg>
    </label>
    <input id="messageInput" type="text" inputmode="text" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." aria-label="–¢–µ–∫—Å—Ç" />
    <button id="sendButton" class="send-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
  </div>

  <!-- –ó–µ–ª–µ–Ω–∞—è –ø–ª–∞—à–∫–∞-–≥–∞–ª–æ—á–∫–∞ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ -->
  <div id="photoToast" class="photo-toast">‚úîÔ∏è –§–æ—Ç–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ. –ù–∞–ø–∏—à—ñ—Ç—å –°–ú–° ‚Äî —Ñ–æ—Ç–æ –∑'—è–≤–∏—Ç—å—Å—è –ø—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏.</div>

  <!-- –ú–û–î–ê–õ–ö–ò -->
  <!-- auth -->
  <div id="authModal" class="modal" aria-hidden="true" style="z-index:1500">
    <div class="panel" role="dialog" aria-modal="true">
      <button class="close" id="modalClose">‚úñ</button>
      <h2 style="margin-top:0">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è / –í—Ö—ñ–¥</h2>

      <form id="registerForm" onsubmit="return false;">
        <input id="nickInput" type="text" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" required style="width:100%;padding:10px;margin:6px 0;border-radius:10px;border:1px solid #e5e7eb"/>
        <input id="emailInput" type="email" placeholder="Email" required style="width:100%;padding:10px;margin:6px 0;border-radius:10px;border:1px solid #e5e7eb"/>
        <input id="passwordInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω. 6)" required style="width:100%;padding:10px;margin:6px 0;border-radius:10px;border:1px solid #e5e7eb"/>
        <div style="display:flex;gap:8px">
          <button id="registerSubmit" type="button" class="tab-button" style="flex:1">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
          <button id="loginShow"    type="button" class="tab-button" style="flex:1;background:#4b5563;color:#fff">–£–≤—ñ–π—Ç–∏</button>
        </div>
        <div id="regError" style="color:#b91c1c;margin-top:6px"></div>
      </form>

      <form id="loginForm" style="display:none" onsubmit="return false;">
        <input id="loginEmail" type="email" placeholder="Email" required style="width:100%;padding:10px;margin:6px 0;border-radius:10px;border:1px solid #e5e7eb"/>
        <input id="loginPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" required style="width:100%;padding:10px;margin:6px 0;border-radius:10px;border:1px solid #e5e7eb"/>
        <div style="display:flex;gap:8px">
          <button id="loginSubmit"   type="button" class="tab-button" style="flex:1">–£–≤—ñ–π—Ç–∏</button>
          <button id="backToRegister"type="button" class="tab-button" style="flex:1;background:#4b5563;color:#fff">–ù–∞–∑–∞–¥</button>
        </div>
        <div id="loginError" style="color:#b91c1c;margin-top:6px"></div>
      </form>

      <div style="margin-top:10px">
        <div id="recaptcha-container" style="margin-bottom:8px"></div>
        <input id="phoneInput" type="tel" placeholder="+420‚Ä¶ (–æ–ø—Ü—ñ–π–Ω–æ: SMS-–ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è)" style="width:100%;padding:10px;margin:6px 0;border-radius:10px;border:1px solid #e5e7eb"/>
        <div style="display:flex;gap:8px">
          <button id="smsSend" class="tab-button" style="flex:1;background:#fff3cd">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∫–æ–¥</button>
          <input id="smsCode" placeholder="–ö–æ–¥" style="flex:1;padding:10px;border-radius:10px;border:1px solid #e5e7eb" />
          <button id="smsVerify" class="tab-button" style="flex:1">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <button id="enableSoundBtn" class="tab-button" style="width:100%">üîä –í–∫–ª—é—á–∏—Ç–∏ –∑–≤—É–∫ —Å–ø–æ–≤—ñ—â–µ–Ω—å</button>
      </div>
    </div>
  </div>

  <!-- –ü—Ä–æ—Ñ—ñ–ª—å -->
  <div id="profileModal" class="modal" aria-hidden="true" style="z-index:1600">
    <div class="panel" role="dialog" aria-modal="true">
      <button class="close" id="profileClose">‚úñ</button>
      <div id="profileContent"></div>
    </div>
  </div>

  <!-- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è -->
  <div id="gearModal" class="modal" aria-hidden="true" style="z-index:1500">
    <div class="panel" role="dialog" aria-modal="true">
      <button class="close" id="gearClose">‚úñ</button>
      <h3 style="margin-top:0">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h3>
      <label class="user-badge" style="gap:8px;margin-right:8px"><input type="checkbox" id="optSound"> –ó–≤—É–∫ —Å–ø–æ–≤—ñ—â–µ–Ω—å</label>
      <label class="user-badge" style="gap:8px"><input type="checkbox" id="optAnon"> –î–æ–∑–≤–æ–ª–∏—Ç–∏ –≥–æ—Å—Ç—å–æ–≤–∏–π –ø–µ—Ä–µ–≥–ª—è–¥</label>
    </div>
  </div>

  <!-- –º–µ–Ω—é –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
  <div id="msgMenu" class="msg-menu" role="menu">
    <button data-act="like">üëç –õ–∞–π–∫</button>
    <button data-act="warn">‚ö†Ô∏è –û–±–µ—Ä–µ–∂–Ω–æ (—à–∞—Ö—Ä–∞–π)</button>
    <button data-act="dislike">üëé –î–∏–∑–ª–∞–π–∫</button>
    <button data-act="spam">üö´ –°–ø–∞–º</button>
    <button data-act="reply">‚Ü©Ô∏è –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏</button>
    <button data-act="delete">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ (–∞–≤—Ç–æ—Ä/–∞–¥–º—ñ–Ω)</button>
  </div>

  <!-- –ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫ -->
  <div id="bellModal" class="modal" aria-hidden="true" style="z-index:1400">
    <div class="panel" role="dialog" aria-modal="true">
      <button class="close" id="bellClose">‚úñ</button>
      <h3 style="margin-top:0">–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h3>
      <div id="notifList"></div>
    </div>
  </div>

  <!-- –ê–¥–º—ñ–Ω ¬´–£—á–∞—Å–Ω–∏–∫–∏¬ª -->
  <div id="adminUsersModal" class="modal full" aria-hidden="true" style="z-index:1700">
    <div class="panel" role="dialog" aria-modal="true">
      <button class="close" id="adminUsersClose">‚úñ</button>
      <div class="admin-users-head">
        <h3 style="margin:0">–£—á–∞—Å–Ω–∏–∫–∏ —Å–∞–π—Ç—É</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="userSearch" placeholder="–ü–æ—à—É–∫ –∑–∞ –Ω—ñ–∫–æ–º –∞–±–æ email‚Ä¶" style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px" />
          <span class="user-badge">–£—Å—å–æ–≥–æ: <b id="usersTotal">0</b></span>
          <span class="user-badge">–ù–∞ –µ–∫—Ä–∞–Ω—ñ: <b id="usersShown">0</b></span>
        </div>
      </div>
      <div class="admin-users-body">
        <table class="grid-users">
          <thead><tr><th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th><th class="muted">Email</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–µ–º—ñ—É–º</th><th>–î—ñ—ó</th></tr></thead>
          <tbody id="usersTBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- –∑–≤—É–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ -->
  <script>window.__soundEnabled=false;</script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
  /* =========================
     –ß–ê–°–¢–¨ 1/3 ‚Äî Firebase init, –±–∞–∑–æ–≤—ñ UI, –∑–≤—É–∫, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
     ========================= */
  const firebaseConfig = {
    apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
    authDomain: "praga-4baee.firebaseapp.com",
    databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
    projectId: "praga-4baee",
    storageBucket: "praga-4baee.firebasestorage.app",
    messagingSenderId: "336023952536",
    appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
    measurementId: "G-BGDJD6R12N"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.database();

  const DEFAULT_AVATAR = "https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg";
  const ADMIN_EMAIL = "urciknikolaj642@gmail.com";

  const tabButtons   = document.querySelectorAll(".tab-button");
  const tabContents  = document.querySelectorAll(".tab-content");
  const profileBtn   = document.getElementById("profileBtn");
  const gearBtn      = document.getElementById("gearBtn");
  const membersBtn   = document.getElementById("membersBtn");
  const adminBar     = document.getElementById("adminBar");
  const onlineNeon   = document.getElementById("onlineNeon");

  const authModal    = document.getElementById("authModal");
  const modalClose   = document.getElementById("modalClose");
  const registerForm = document.getElementById("registerForm");
  const loginForm    = document.getElementById("loginForm");
  const loginShow    = document.getElementById("loginShow");
  const backToRegister = document.getElementById("backToRegister");
  const registerSubmit = document.getElementById("registerSubmit");
  const loginSubmit  = document.getElementById("loginSubmit");
  const regError     = document.getElementById("regError");
  const loginError   = document.getElementById("loginError");
  const nickInput    = document.getElementById("nickInput");
  const emailInput   = document.getElementById("emailInput");
  const passwordInput= document.getElementById("passwordInput");
  const loginEmail   = document.getElementById("loginEmail");
  const loginPassword= document.getElementById("loginPassword");
  const enableSoundBtn = document.getElementById("enableSoundBtn");

  const gearModal = document.getElementById('gearModal');
  const gearClose = document.getElementById('gearClose');
  const optSound  = document.getElementById('optSound');
  const optAnon   = document.getElementById('optAnon');

  function setActiveTab(id){
    tabButtons.forEach(b=>b.classList.toggle("active", b.dataset.target===id));
    tabContents.forEach(c=> c.style.display = (c.id===id) ? "block" : "none");
    adminBar.style.display = (id==='chatTab' && window.__isAdmin) ? 'block' : 'none';
    if (id==='mapTab' && !window.__mapInitOnce){ initLeaflet(); window.__mapInitOnce=true; }
  }
  tabButtons.forEach(btn=> btn.addEventListener('click', ()=> setActiveTab(btn.dataset.target)));

  /* WebAudio */
  let audioCtx=null;
  function ensureAudio(){ if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } }
  function beep(freq=880, dur=120, type="sine", vol=0.15){
    if(!window.__soundEnabled) return;
    ensureAudio();
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(audioCtx.destination);
    o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.08); o.stop(audioCtx.currentTime+0.1); }, dur);
  }
  const SND={ notify(){beep(1200,140,"triangle",0.18)}, sent(){beep(760,90,"sine",0.14)}, error(){beep(320,220,"square",0.18)} };
  enableSoundBtn?.addEventListener('click',()=>{ window.__soundEnabled = true; ensureAudio(); SND.notify(); enableSoundBtn.textContent="üîä –ó–≤—É–∫ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ"; optSound.checked=true; });

  /* –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è */
  gearBtn.addEventListener('click',()=>{ gearModal.classList.add('show'); });
  gearClose.addEventListener('click',()=> gearModal.classList.remove('show'));
  optSound.onchange = ()=>{ window.__soundEnabled = !!optSound.checked; if(optSound.checked) SND.notify(); };
  optAnon.onchange = ()=>{ localStorage.setItem('allow_guest',''+(optAnon.checked?1:0)); };

  /* Auth UI */
  function showAuth(){ authModal.classList.add('show'); regError.textContent=""; loginError.textContent=""; }
  function hideAuth(){ authModal.classList.remove('show'); }
  modalClose.addEventListener('click', hideAuth);
  loginShow.addEventListener('click',()=>{ registerForm.style.display="none"; loginForm.style.display="block"; });
  backToRegister.addEventListener('click',()=>{ registerForm.style.display="block"; loginForm.style.display="none"; });

  registerSubmit.addEventListener('click', async ()=>{
    regError.textContent="";
    const nick = nickInput.value.trim();
    const email= emailInput.value.trim();
    const pass = passwordInput.value.trim();
    if(!nick || !email || pass.length<6){ regError.textContent="–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è (–ø–∞—Ä–æ–ª—å ‚â• 6)"; SND.error(); return; }
    try{
      const cred = await auth.createUserWithEmailAndPassword(email,pass);
      await cred.user.updateProfile({ displayName:nick, photoURL:DEFAULT_AVATAR });
      await db.ref('users/'+cred.user.uid).set({ nick,email,avatar:DEFAULT_AVATAR,createdAt:Date.now() });
      await db.ref('presence/'+cred.user.uid).set({ ts:Date.now(), nick });
      hideAuth(); SND.notify();
    }catch(e){ regError.textContent=e.message||String(e); SND.error(); }
  });

  loginSubmit.addEventListener('click', async ()=>{
    loginError.textContent="";
    try{ await auth.signInWithEmailAndPassword(loginEmail.value.trim(), loginPassword.value.trim()); hideAuth(); SND.notify(); }
    catch(e){ loginError.textContent=e.message||String(e); SND.error(); }
  });

  // SMS (–æ–ø—Ü—ñ–π–Ω–æ)
  let _smsConfirmer=null;
  function initRecaptcha(){ try{ _smsConfirmer = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size:'invisible' }); }catch{} }
  initRecaptcha();
  document.getElementById('smsSend').onclick = async ()=>{
    const phone = document.getElementById('phoneInput').value.trim(); if(!phone) return;
    try{ const res = await auth.signInWithPhoneNumber(phone,_smsConfirmer); window.__smsRes=res; alert('–ö–æ–¥ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ'); }
    catch(e){ alert('SMS –ø–æ–º–∏–ª–∫–∞: '+(e.message||e)); }
  };
  document.getElementById('smsVerify').onclick = async ()=>{
    const code = document.getElementById('smsCode').value.trim(); if(!code||!window.__smsRes) return;
    try{ await window.__smsRes.confirm(code); alert('–ù–æ–º–µ—Ä –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ'); }
    catch(e){ alert('–ö–æ–¥ –Ω–µ–≤—ñ—Ä–Ω–∏–π'); }
  };

  /* onAuthStateChanged */
  window.__isAdmin=false;
  auth.onAuthStateChanged(async (u)=>{
    profileBtn.style.background = `url(${(u && u.photoURL) || DEFAULT_AVATAR}) center/cover`;
    if(u){ await db.ref('presence/'+u.uid).set({ ts:Date.now(), nick: u.displayName||u.email }); }

    if(u){
      try{
        const roleSnap=await db.ref('users/'+u.uid+'/role').get();
        const role=roleSnap.exists()?roleSnap.val():null;
        window.__isAdmin = (u.email===ADMIN_EMAIL) || role==='admin';
      }catch{ window.__isAdmin = (u.email===ADMIN_EMAIL); }
    }else window.__isAdmin=false;

    gearBtn.style.display    = 'flex';
    membersBtn.style.display = window.__isAdmin ? 'flex' : 'none';
    adminBar.style.display   = (window.__isAdmin && document.getElementById('chatTab').style.display==='block') ? 'block' : 'none';

    profileBtn.onclick = ()=>{ if(!auth.currentUser) showAuth(); else openProfile(auth.currentUser.uid,true); };

    updateOnlineCount(); initHelp();
  });

  /* =========================
     –ß–ê–°–¢–¨ 2/3 ‚Äî –ü—Ä–æ—Ñ—ñ–ª—å, –∫–∞—Ä—Ç–∞, –¥—Ä—É–∑—ñ/–õ–°, —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
     ========================= */
  const profileModal  = document.getElementById("profileModal");
  const profileClose  = document.getElementById("profileClose");
  const profileContent= document.getElementById("profileContent");
  profileClose.addEventListener('click',()=> profileModal.classList.remove('show'));

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

  async function openProfile(uid,isSelf=false){
    profileModal.style.zIndex=1600; // –ø–æ–≤–µ—Ä—Ö –≤—Å–µ—Ö
    profileModal.classList.add('show');
    profileContent.innerHTML = "<p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</p>";
    try{
      const s = await db.ref('users/'+uid).get();
      const user = s.exists()? s.val() : { nick:"–ê–Ω–æ–Ω—ñ–º", avatar:DEFAULT_AVATAR };
      const email = user.email || "";
      const self  = auth.currentUser && auth.currentUser.uid===uid;

      // –ø—Ä–µ–º—ñ—É–º –∑–Ω–∞—á–æ–∫
      const flags = (await db.ref('settings/userFlags/'+uid).get()).val()||{};
      const planKey = flags.premium || 'none';
      const PLAN = {
        none:{label:'‚Äî',bg:'linear-gradient(90deg,#e5e7eb,#f8fafc)',col:'#111'},
        trial:{label:'–ü–†–ï–ú–Ü–£–ú ‚Ä¢ TRIAL',bg:'linear-gradient(90deg,#a78bfa,#c084fc)',col:'#fff'},
        premium:{label:'–ü–†–ï–ú–Ü–£–ú',bg:'linear-gradient(90deg,#22c55e,#16a34a)',col:'#fff'},
        premiumPlus:{label:'–ü–†–ï–ú–Ü–£–ú+',bg:'linear-gradient(90deg,#06b6d4,#0ea5e9)',col:'#fff'}
      }[planKey];

      const about = user.about||''; const contacts=user.contacts||'';

      profileContent.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center">
          <img src="${user.avatar||DEFAULT_AVATAR}" style="width:84px;height:84px;border-radius:12px;object-fit:cover">
          <div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <h3 style="margin:0;color:#0b1220;text-shadow:0 0 12px rgba(57,255,145,.7)">${escapeHtml(user.nick||"–ê–Ω–æ–Ω—ñ–º")}</h3>
              <span class="user-badge" style="background:${PLAN.bg};color:${PLAN.col};font-weight:900">${PLAN.label}</span>
              ${uid===auth.currentUser?.uid?'<span class="user-badge">–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</span>':''}
              ${(user.email===ADMIN_EMAIL)?'<span class="user-badge" style="background:#111;color:#39ff91">ADMIN</span>':''}
            </div>
            <div style="color:${email?'#333':'#666'}">${escapeHtml(email)}</div>
          </div>
        </div>
        <div style="margin-top:12px;display:grid;grid-template-columns:1fr;gap:8px">
          <div><b>–ü—Ä–æ —Å–µ–±–µ:</b><br>${about?escapeHtml(about):'<i>–Ω–µ –≤–∫–∞–∑–∞–Ω–æ</i>'}</div>
          <div><b>–ö–æ–Ω—Ç–∞–∫—Ç–∏:</b><br>${contacts?escapeHtml(contacts):'<i>–Ω–µ –≤–∫–∞–∑–∞–Ω–æ</i>'}</div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          ${self?`
            <label class="tab-button" style="cursor:pointer">
              <input type="file" id="avatarFile" accept="image/*" style="display:none">–ó–º—ñ–Ω–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä (—Ñ–∞–π–ª)
            </label>
            <button id="editAbout" class="tab-button">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
            <button id="signOutBtn" class="tab-button" style="background:#ffe1e1">–í–∏–π—Ç–∏</button>
          `:`
            <button id="pmBtn" class="tab-button">–ù–∞–ø–∏—Å–∞—Ç–∏ –õ–°</button>
            <button id="addFriendBtn" class="tab-button">–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>
            <button id="reportBtn" class="tab-button" style="background:#fff3cd">‚ö†Ô∏è –ü–æ—Å–∫–∞—Ä–∂–∏—Ç–∏—Å—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—É</button>
          `}
        </div>
        <div id="profileMsg" style="margin-top:8px;color:#16a34a;font-weight:700"></div>
      `;

      if(self){
        document.getElementById('avatarFile').addEventListener('change', async (e)=>{
          const f = e.target.files[0]; if(!f) return;
          const url = await fileToDataURL(f, 900, .9);
          await db.ref('users/'+uid+'/avatar').set(url);
          await auth.currentUser.updateProfile({ photoURL:url });
          profileBtn.style.background = `url(${url}) center/cover`;
          profileContent.querySelector('img').src = url;
          SND.notify();
        });
        document.getElementById('signOutBtn').onclick = async ()=>{
          try{ await db.ref('presence/'+auth.currentUser.uid).remove(); }catch{}
          await auth.signOut(); profileModal.classList.remove('show');
        };
        document.getElementById('editAbout').onclick = async ()=>{
          const a = prompt('–ü—Ä–æ —Å–µ–±–µ', about||'')||'';
          const c = prompt('–ö–æ–Ω—Ç–∞–∫—Ç–∏', contacts||'')||'';
          await db.ref('users/'+uid).update({ about:a, contacts:c });
          openProfile(uid,true);
        };
      }else{
        document.getElementById('pmBtn').onclick = ()=> openPrivateChat(uid);
        document.getElementById('addFriendBtn').onclick = ()=> sendFriendRequest(uid);
        document.getElementById('reportBtn').onclick = async ()=>{
          await db.ref('notifications/'+ (await getAdminUid()) ).push({
            ts:Date.now(), type:'report', text:`–°–∫–∞—Ä–≥–∞ –Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${escapeHtml(user.nick||uid)}`, from:auth.currentUser?.uid||'guest', target:uid
          });
          document.getElementById('profileMsg').textContent = "–°–∫–∞—Ä–≥—É –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—É.";
          SND.notify();
        };
      }
    }catch(e){ profileContent.innerHTML = "<p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</p>"; }
  }
  profileBtn.addEventListener('click', ()=>{ if(!auth.currentUser) showAuth(); else openProfile(auth.currentUser.uid,true); });

  function fileToDataURL(file,maxW=900,quality=.85){
    return new Promise((resolve,reject)=>{
      const img=new Image(); const r=new FileReader();
      r.onload=e=>{ img.onload()=>{
        const sc=Math.min(1, maxW/img.width);
        const w=(img.width*sc)|0, h=(img.height*sc)|0;
        const c=document.createElement('canvas'); c.width=w; c.height=h;
        c.getContext('2d').drawImage(img,0,0,w,h);
        resolve(c.toDataURL('image/jpeg',quality));
      }; img.onerror=reject; img.src=e.target.result; };
      r.onerror=reject; r.readAsDataURL(file);
    });
  }

  function updateOnlineCount(){
    db.ref('presence').on('value', snap=>{
      const val = snap.val()||{}; const real = Object.keys(val).length;
      onlineNeon.textContent = `–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): ${real*10}`;
    });
    window.addEventListener('beforeunload', async ()=>{
      try{ if(auth.currentUser) await db.ref('presence/'+auth.currentUser.uid).remove(); }catch{}
    });
  }

  // –î–æ–ø–æ–º–æ–≥–∞ (–∫–∞—Ä—Ç–æ—á–∫–∏)
  const helpItems=[
    {img:"https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp", title:"Nemocnice Motol", sub:"V √övalu 84"},
    {img:"https://i.ibb.co/0gWD5wW/images-5.jpg", title:"–Æ—Ä–∏–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞", sub:"–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó"},
    {img:"https://i.ibb.co/R49shL6k/images-6.jpg", title:"–£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –º–∞–≥–∞–∑–∏–Ω–∏", sub:"–ü—Ä–æ–¥—É–∫—Ç–∏"}
  ];
  const helpGrid = document.createElement('div');
  function initHelp(){
    const host=document.querySelector('#friendsTab').previousElementSibling; // –Ω–µ–æ–Ω-–ø–ª–∞—à–∫–∞
    const sec=document.getElementById('friendsTab');
    if(!sec||sec.dataset.helpInit) return; sec.dataset.helpInit='1';
    const helpTab=document.createElement('section'); helpTab.id='helpTab'; helpTab.className='tab-content'; helpTab.setAttribute('role','region'); helpTab.setAttribute('aria-label','–î–æ–ø–æ–º–æ–≥–∞');
    helpTab.innerHTML=`<h2 class="pill-title">–¢–µ—Ä–º—ñ–Ω–æ–≤–∞ –¥–æ–ø–æ–º–æ–≥–∞ —É –ü—Ä–∞–∑—ñ</h2><div id="helpGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px"></div>`;
    document.querySelector('main').insertBefore(helpTab, document.getElementById('dmTab'));
    const hg=helpTab.querySelector('#helpGrid');
    hg.innerHTML = helpItems.map(i=>`
      <div style="background:#fff;padding:10px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.08)">
        <img src="${i.img}" style="width:100%;height:140px;object-fit:cover;border-radius:8px">
        <h3>${i.title}</h3><p>${i.sub}</p>
      </div>`).join('');

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–æ –≤–∫–ª–∞–¥–∫–∏ (–ø–æ—Å–ª–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó)
    const helpBtn=document.createElement('button'); helpBtn.className='tab-button'; helpBtn.dataset.target='helpTab'; helpBtn.textContent='üÜò –î–æ–ø–æ–º–æ–≥–∞';
    document.querySelector('.neon-tabs').insertBefore(helpBtn, document.querySelector("button[data-target='dmTab']"));
    helpBtn.addEventListener('click', ()=> setActiveTab('helpTab'));
  }

  /* –ö–∞—Ä—Ç–∞ */
  let map, markers=[], poi=[];
  function initLeaflet(){
    map = L.map('map').setView([50.0755, 14.4378], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);
    poi = [
      {t:'volunteer', name:'–£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –≤–æ–ª–æ–Ω—Ç–µ—Ä—Å—å–∫–∏–π —Ü–µ–Ω—Ç—Ä', p:[50.087,14.43]},
      {t:'aid', name:'–¶–µ–Ω—Ç—Ä –¥–æ–ø–æ–º–æ–≥–∏ UA', p:[50.09,14.47]},
      {t:'pharmacy', name:'–ê–ø—Ç–µ–∫–∞ Praha', p:[50.07,14.41]},
      {t:'volunteer', name:'Volunteers Hub', p:[50.08,14.5]},
    ];
    renderPoi(poi);
    document.getElementById('centerBtn').onclick=()=> map.setView([50.0755,14.4378],12);
    document.querySelectorAll('#mapTab button[data-f]').forEach(b=> b.onclick=()=>
      renderPoi(b.dataset.f==='all'? poi : poi.filter(o=>o.t===b.dataset.f))
    );
    document.getElementById('mapSearch').oninput = (e)=> searchPoi(e.target.value.trim());
  }
  function clearMarkers(){ markers.forEach(m=>m.remove()); markers=[]; }
  function renderPoi(list){ clearMarkers(); list.forEach(o=>{ const m=L.marker(o.p).addTo(map).bindPopup(`<b>${o.name}</b><br>${o.t}`); markers.push(m); }); }
  function searchPoi(q){ const l=q.toLowerCase(); renderPoi(poi.filter(o=>o.name.toLowerCase().includes(l) || o.t.includes(l))); }

  /* –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è */
  const bellBtn   = document.getElementById("bellBtn");
  const bellBadge = document.getElementById("bellBadge");
  const bellModal = document.getElementById("bellModal");
  const bellClose = document.getElementById("bellClose");
  const notifList = document.getElementById("notifList");
  function notify(title,text){
    const row=document.createElement('div'); row.style.padding="6px 8px"; row.style.borderBottom="1px solid #eee";
    row.textContent = `${title}: ${text}`; notifList.prepend(row);
    let n=Number(bellBadge.dataset.n||"0")+1; bellBadge.dataset.n=String(n);
    bellBadge.textContent=n; bellBadge.style.display=n>0?"inline-block":"none";
    SND.notify();
  }
  bellBtn.addEventListener('click',()=>{ bellModal.classList.add('show'); bellBadge.dataset.n="0"; bellBadge.style.display="none"; });
  bellClose.addEventListener('click',()=> bellModal.classList.remove('show'));

  function renderNotifItem(id,v){
    const row=document.createElement('div');
    row.style.cssText="padding:8px;border-bottom:1px solid #eee;display:flex;gap:8px;align-items:center";
    row.innerHTML = `
      <div style="flex:1">
        <div style="font-weight:700">${(v.type||'info').toUpperCase()}</div>
        <div class="muted" style="font-size:13px">${v.text||''}</div>
      </div>
      ${v.from?'<button class="tab-button btn-prof" style="padding:6px 10px">üë§ –ü—Ä–æ—Ñ—ñ–ª—å</button>':''}
      ${v.type==='dm' && v.from?'<button class="tab-button btn-dm" style="padding:6px 10px">‚úâÔ∏è –í—ñ–¥–∫—Ä–∏—Ç–∏</button>':''}`;
    if(v.from){ row.querySelector('.btn-prof')?.addEventListener('click',()=> openProfile(v.from)); }
    if(v.type==='dm' && v.from){ row.querySelector('.btn-dm')?.addEventListener('click',()=> openPrivateChat(v.from)); }
    notifList.prepend(row);
  }
  function subscribeNotifications(uid){ if(!uid) return; db.ref('notifications/'+uid).on('child_added',snap=>{ const v=snap.val()||{}; renderNotifItem(snap.key, v); SND.notify(); }); }

  /* –î—Ä—É–∑—ñ —Ç–∞ –õ–° */
  const dmList = document.getElementById("dmList");
  const friendsList = document.getElementById("friendsList");
  const friendRequestsEl = document.getElementById("friendRequests");
  const friendsOnlineCountEl = document.getElementById("friendsOnlineCount");
  function convoIdFor(a,b){ return a<b? a+"_"+b : b+"_"+a; }

  async function getAdminUid(){
    const s = await db.ref('users').get(); const v=s.val()||{};
    const id = Object.keys(v).find(uid => (v[uid]?.email||'')===ADMIN_EMAIL);
    return id || null;
  }

  async function sendFriendRequest(toUid){
    if(!auth.currentUser){ showAuth(); return; }
    const from=auth.currentUser.uid; if(from===toUid) return;
    await db.ref('friendRequests/'+toUid+'/'+from).set({ from, ts:Date.now() });
    await db.ref('friends/'+from+'/'+toUid).set({ status:'requested', ts:Date.now(), fromUid:from });
    await db.ref('notifications/'+toUid).push({ ts:Date.now(), type:'friend_req', text:`–ó–∞–ø–∏—Ç —É –¥—Ä—É–∑—ñ –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`, from });
    notify('OK','–ó–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ');
  }

  async function openPrivateChat(otherUid){
    if(!auth.currentUser){ showAuth(); return; }
    const uid=auth.currentUser.uid; const cid=convoIdFor(uid,otherUid);
    const panel=document.createElement('div'); panel.className='modal show'; panel.style.zIndex=1650;
    panel.innerHTML=`<div class="panel"><button class="close">‚úñ</button><h3>–î—ñ–∞–ª–æ–≥</h3>
    <div id="dmThread" style="max-height:55vh;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px;margin-bottom:8px;background:#fafafa"></div>
    <div style="display:flex;gap:6px"><input id="dmText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd"><button id="dmSend" class="tab-button">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button></div></div>`;
    document.body.appendChild(panel);
    panel.querySelector('.close').onclick=()=>panel.remove();
    const thread=panel.querySelector('#dmThread');

    // —ñ–Ω–¥–µ–∫—Å—É—î–º–æ –æ–±–∏–¥–≤–∞ —ñ–Ω–±–æ–∫—Å–∏ –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ —Å–ø–∏—Å–∫—É –¥—ñ–∞–ª–æ–≥—ñ–≤
    const metaA = db.ref('inboxMeta/'+uid+'/'+otherUid).set({ with:otherUid, ts:Date.now() });
    const metaB = db.ref('inboxMeta/'+otherUid+'/'+uid).set({ with:uid, ts:Date.now() });

    db.ref('privateMessages/'+cid).limitToLast(200).on('child_added',snap=>{
      const m=snap.val(); const row=document.createElement('div');
      row.style.margin="6px 0"; row.style.textAlign=m.from===uid?"right":"left";
      row.textContent=`${m.text} (${new Date(m.ts).toLocaleTimeString()})`; thread.appendChild(row); thread.scrollTop=thread.scrollHeight;
    });
    panel.querySelector('#dmSend').onclick=async()=>{
      const t=panel.querySelector('#dmText').value.trim(); if(!t) return;
      const pm={from:uid,to:otherUid,text:t,ts:Date.now()};
      await db.ref('privateMessages/'+cid).push(pm);
      await db.ref('notifications/'+otherUid).push({ ts:Date.now(), type:'dm', text:`–ù–æ–≤–µ –õ–° –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`, from:uid, convoId:cid });
      await db.ref('inboxMeta/'+uid+'/'+otherUid).update({ last:t, ts:pm.ts });
      await db.ref('inboxMeta/'+otherUid+'/'+uid).update({ last:t, ts:pm.ts });
      panel.querySelector('#dmText').value=""; SND.sent();
    };
  }

  async function refreshFriendsBlocks(){
    const u=auth.currentUser; if(!u){ friendsList.innerHTML=""; friendRequestsEl.innerHTML=""; friendsOnlineCountEl.textContent="0"; return; }
    const reqSnap=await db.ref('friendRequests/'+u.uid).get(); friendRequestsEl.innerHTML="";
    if(reqSnap.exists()){
      const reqs=reqSnap.val(); for(const fromUid of Object.keys(reqs)){
        const uSnap=await db.ref('users/'+fromUid).get(); const ud=uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
        const item=document.createElement('div'); item.style.cssText='display:flex;gap:8px;align-items:center;background:#fff;border-radius:10px;padding:8px;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,.06)';
        item.innerHTML=`<img src="${ud.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
        <div style="flex:1"><div style="font-weight:800;color:#0b1220;text-shadow:0 0 8px rgba(57,255,145,.8)">${escapeHtml(ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á')}</div><div class="muted" style="font-size:12px">–∑–∞—è–≤–∫–∞ —É –¥—Ä—É–∑—ñ</div></div>
        <div style="display:flex;gap:6px"><button class="tab-button btn-accept">‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏</button><button class="tab-button btn-decline" style="background:#ffe1e1">‚úñ</button></div>`;
        item.querySelector('.btn-accept').onclick=async()=>{
          await db.ref('friends/'+u.uid+'/'+fromUid).set({ status:'accepted', ts:Date.now() });
          await db.ref('friends/'+fromUid+'/'+u.uid).set({ status:'accepted', ts:Date.now() });
          await db.ref('friendRequests/'+u.uid+'/'+fromUid).remove();
          await db.ref('notifications/'+fromUid).push({ ts:Date.now(), type:'friend_ok', text:`${u.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'} –¥–æ–¥–∞–≤(–ª–∞) –≤–∞—Å —É –¥—Ä—É–∑—ñ`, from:u.uid });
          refreshFriendsBlocks(); SND.notify();
        };
        item.querySelector('.btn-decline').onclick=async()=>{
          await db.ref('friendRequests/'+u.uid+'/'+fromUid).remove(); await db.ref('friends/'+fromUid+'/'+u.uid).remove(); refreshFriendsBlocks();
        };
        friendRequestsEl.appendChild(item);
      }
    }else friendRequestsEl.innerHTML="<i>–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</i>";

    friendsList.innerHTML=""; const frSnap=await db.ref('friends/'+u.uid).get(); let onlineCount=0;
    if(frSnap.exists()){
      const fr=frSnap.val(); for(const fid of Object.keys(fr)){ const rel=fr[fid]; if(rel.status!=='accepted') continue;
        const uSnap=await db.ref('users/'+fid).get(); const ud=uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
        const pSnap=await db.ref('presence/'+fid).get(); const isOn=pSnap.exists(); if(isOn) onlineCount++;
        const d=document.createElement('div'); d.style.cssText='display:flex;gap:8px;align-items:center;background:#fff;border-radius:10px;padding:8px;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,.06)';
        d.innerHTML=`<img src="${ud.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
          <div style="flex:1"><div style="font-weight:800;color:#0b1220;text-shadow:0 0 8px rgba(57,255,145,.8)">${escapeHtml(ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á')}</div><div style="font-size:12px;color:${isOn?'#10b981':'#64748b'}">${isOn?'–æ–Ω–ª–∞–π–Ω':'–æ—Ñ–ª–∞–π–Ω'}</div></div>
          <div style="display:flex;gap:6px"><button class="tab-button btn-pm">‚úâÔ∏è</button><button class="tab-button btn-open">üëÄ</button></div>`;
        d.querySelector('.btn-open').onclick=()=>openProfile(fid);
        d.querySelector('.btn-pm').onclick=()=>openPrivateChat(fid);
        friendsList.appendChild(d);
      }
    } else friendsList.innerHTML="<i>–î–æ–¥–∞–π—Ç–µ –¥—Ä—É–∑—ñ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ—ñ–ª—ñ</i>";
    friendsOnlineCountEl.textContent=String(onlineCount);
  }

  function renderDMInbox(){
    const u=auth.currentUser; if(!u){ dmList.innerHTML="<i>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –±–∞—á–∏—Ç–∏ –õ–°</i>"; return; }
    db.ref('inboxMeta/'+u.uid).off();
    dmList.innerHTML="";
    db.ref('inboxMeta/'+u.uid).orderByChild('ts').limitToLast(200).on('child_added', async snap=>{
      const other=snap.key; const meta=snap.val();
      const uSnap=await db.ref('users/'+other).get(); const ud=uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
      const card=document.createElement('div'); card.style.cssText='display:flex;gap:8px;align-items:center;background:#fff;border-radius:10px;padding:8px;box-shadow:0 2px 8px rgba(0,0,0,.06)';
      card.innerHTML=`<img src="${ud.avatar||DEFAULT_AVATAR}" style="width:42px;height:42px;border-radius:10px;object-fit:cover">
        <div style="flex:1"><div style="font-weight:800">${escapeHtml(ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á')}</div><div class="muted" style="font-size:12px">${escapeHtml(meta.last||'–ë–µ–∑ —Ç–µ–∫—Å—Ç—É')}</div></div>
        <button class='tab-button'>–í—ñ–¥–∫—Ä–∏—Ç–∏</button>`;
      card.querySelector('button').onclick=()=> openPrivateChat(other);
      dmList.prepend(card);
    });
  }

  auth.onAuthStateChanged(u=>{
    if(u){ subscribeNotifications(u.uid); refreshFriendsBlocks(); renderDMInbox(); }
    else { notifList.innerHTML=""; friendRequestsEl.innerHTML=""; friendsList.innerHTML=""; dmList.innerHTML=""; }
    adminBar.style.display = (window.__isAdmin && document.getElementById('chatTab').style.display==='block') ? 'block' : 'none';
  });

  /* =========================
     –ß–ê–°–¢–¨ 3/3 ‚Äî –ß–∞—Ç, –∞–¥–º—ñ–Ω–∫–∞, –±–æ—Ç–∏, –∞–Ω—Ç–∏—Å–ø–∞–º –æ–ø–ª–∞—Ç–∏
     ========================= */
  const messagesEl      = document.getElementById("messages");
  const rentMessagesEl  = document.getElementById("rentMessages");
  const chatAreaMain    = document.getElementById("chatArea");
  const chatAreaRent    = document.getElementById("rentArea");
  const messageInput    = document.getElementById("messageInput");
  const sendButton      = document.getElementById("sendButton");
  const fileInput       = document.getElementById("fileInput");

  let MSG_LIMIT=300;
  function timeStr(ts){ return new Date(ts).toLocaleString(); }
  function isNearBottom(area){ return (area.scrollHeight - area.scrollTop - area.clientHeight) < 160; }
  function scrollToBottom(area){ area.scrollTop = area.scrollHeight; }

  function renderMessage(m,container){
    if(!m||!m.ts) return;
    const wrap=document.createElement('div');
    wrap.className="message"+((auth.currentUser&&m.uid===auth.currentUser.uid)?" self":"");
    wrap.dataset.uid=m.uid||""; wrap.dataset.msgid=m.id||"";

    const avatar=document.createElement('img');
    avatar.className="avatar"; avatar.src=m.avatar||DEFAULT_AVATAR; avatar.alt=m.nick||"avatar";
    avatar.title=m.nick||"–ü—Ä–æ—Ñ—ñ–ª—å"; avatar.onclick=()=>openProfile(m.uid);

    const txt=document.createElement('div'); txt.className="message-content";
    const meta=document.createElement('div'); meta.className="message-meta";
    meta.textContent=`${m.nick||"–ê–Ω–æ–Ω—ñ–º"} ¬∑ ${timeStr(m.ts)}` + (m.recipientUid?" ¬∑ –æ—Å–æ–±–∏—Å—Ç–µ":"");
    txt.appendChild(meta);

    if(m.text){ const p=document.createElement('div'); p.className='text'; p.innerText=m.text; txt.appendChild(p); }
    if(m.image){ const im=document.createElement('img'); im.src=m.image; im.className='chat-image'; im.alt='–§–æ—Ç–æ'; txt.appendChild(im); }

    const area=container.closest('.chat-area'); const stick=area?isNearBottom(area):false;
    wrap.appendChild(avatar); wrap.appendChild(txt); container.appendChild(wrap);
    if(area&&stick) scrollToBottom(area);
  }

  db.ref('messages').limitToLast(MSG_LIMIT).on('child_added',snap=>{
    const m=snap.val(); m.id=snap.key; renderMessage(m, messagesEl);
    clearTimeout(window._scrollMainInit); window._scrollMainInit=setTimeout(()=>{scrollToBottom(chatAreaMain)},60);
  });
  db.ref('rentMessages').limitToLast(MSG_LIMIT).on('child_added',snap=>{
    const m=snap.val(); m.id=snap.key; renderMessage(m, rentMessagesEl);
    clearTimeout(window._scrollRentInit); window._scrollRentInit=setTimeout(()=>{scrollToBottom(chatAreaRent)},60);
  });
  function activeChatPath(){ return document.getElementById('rentTab').style.display==="block" ? "rentMessages" : "messages"; }

  async function isBanned(uid){ const s = await db.ref('settings/userFlags/'+uid+'/banned').get(); return s.val()===true; }
  async function canSend(){ return !!auth.currentUser && !(await isBanned(auth.currentUser.uid)); }

  // –∑–µ–ª—ë–Ω–∞—è –ø–ª–∞—à–∫–∞ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ
  const photoToast=document.getElementById('photoToast');
  fileInput.addEventListener('change',()=>{ if(fileInput.files[0]){ photoToast.style.display='block'; setTimeout(()=> photoToast.style.display='none', 3600); } });

  sendButton.addEventListener('click', async ()=>{
    if(!auth.currentUser){ showAuth(); return; }
    if(!await canSend()){ notify('–î–æ—Å—Ç—É–ø','–í–∞—à –∞–∫–∞—É–Ω—Ç –æ–±–º–µ–∂–µ–Ω–æ (–±–∞–Ω)'); return; }
    const text=messageInput.value.trim(); const file=fileInput.files[0]; if(!text && !file) return;
    let imageData=null; if(file){ try{ imageData=await fileToDataURL(file,900,.9); } catch{ notify('–§–æ—Ç–æ','–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–æ–±–∏—Ç–∏'); return; } }
    const msg={ uid:auth.currentUser.uid, nick:auth.currentUser.displayName||auth.currentUser.email||"–ê–Ω–æ–Ω—ñ–º", avatar:auth.currentUser.photoURL||DEFAULT_AVATAR, text:text||null, image:imageData||null, ts:Date.now(), recipientUid:null };
    try{ await db.ref(activeChatPath()).push(msg); messageInput.value=""; fileInput.value=""; SND.sent(); notify('OK','–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ'); }
    catch{ notify('–ü–æ–º–∏–ª–∫–∞','–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏'); }
  });
  messageInput.addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendButton.click(); } });

  // –ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫ –ø–æ–¥–ø–∏—Å–∫–∏
  auth.onAuthStateChanged(u=>{ if(u){ subscribeNotifications(u.uid); refreshFriendsBlocks(); renderDMInbox(); } });

  /* –ê–¥–º—ñ–Ω–∫–∞ */
  const SUB_PLAN = {
    none:       { key:'none',        label:'‚Äî',                 badge:'linear-gradient(90deg,#e5e7eb,#f8fafc)', color:'#111' },
    trial:      { key:'trial',       label:'–ü–†–ï–ú–Ü–£–ú ‚Ä¢ TRIAL',   badge:'linear-gradient(90deg,#a78bfa,#c084fc)', color:'#fff' },
    premium:    { key:'premium',     label:'–ü–†–ï–ú–Ü–£–ú',           badge:'linear-gradient(90deg,#22c55e,#16a34a)', color:'#fff' },
    premiumPlus:{ key:'premiumPlus', label:'–ü–†–ï–ú–Ü–£–ú+',          badge:'linear-gradient(90deg,#06b6d4,#0ea5e9)', color:'#fff' }
  };

  let _allUsers = []; let _userFlags = {}; let _presence = {};
  const $adminUsersModal = document.getElementById('adminUsersModal');
  const $usersTBody      = document.getElementById('usersTBody');
  const $userSearch      = document.getElementById('userSearch');
  const $usersTotal      = document.getElementById('usersTotal');
  const $usersShown      = document.getElementById('usersShown');
  const $adminUsersClose = document.getElementById('adminUsersClose');

  db.ref('presence').on('value', s=>{ _presence=s.val()||{}; if($adminUsersModal.classList.contains('show')) renderUsersTable(_allUsers); });
  db.ref('settings/userFlags').on('value', s=>{ _userFlags=s.val()||{}; if($adminUsersModal.classList.contains('show')) renderUsersTable(_allUsers); });

  membersBtn.addEventListener('click', ()=>{ if(!window.__isAdmin){ notify('–í—ñ–¥–º–æ–≤–∞','–¢—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω–∞'); return; } $adminUsersModal.classList.add('show'); loadUsers(); });
  $adminUsersClose.addEventListener('click', ()=> $adminUsersModal.classList.remove('show'));
  $userSearch.addEventListener('input', ()=> renderUsersTable(_allUsers));

  async function loadUsers(){ const s=await db.ref('users').get(); const obj=s.val()||{}; _allUsers=Object.keys(obj).map(uid=>({uid,...obj[uid]})); $usersTotal.textContent=String(_allUsers.length); renderUsersTable(_allUsers); }

  function renderUsersTable(list){
    if(!$usersTBody) return; const q=($userSearch.value||'').trim().toLowerCase();
    const filtered=list.filter(u=>!q||(u.nick||'').toLowerCase().includes(q)||(u.email||'').toLowerCase().includes(q)).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    $usersShown.textContent=String(filtered.length); $usersTBody.innerHTML='';
    filtered.forEach(u=>{
      const flags=_userFlags[u.uid]||{}; const banned=!!flags.banned; const premKey=flags.premium||'none'; const plan=SUB_PLAN[premKey]||SUB_PLAN.none; const online=!!_presence[u.uid];
      const tr=document.createElement('tr'); tr.innerHTML=`
        <td>
          <div style="display:flex;gap:10px;align-items:center">
            <span title="${online?'–û–Ω–ª–∞–π–Ω':'–û—Ñ–ª–∞–π–Ω'}" style="display:inline-block;width:10px;height:10px;border-radius:999px;background:${online?'#22c55e':'#94a3b8'}"></span>
            <img src="${u.avatar||DEFAULT_AVATAR}" style="width:36px;height:36px;border-radius:10px;object-fit:cover">
            <div>
              <div style="font-weight:800">${escapeHtml(u.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á')}</div>
              <div class="muted" style="font-size:12px">${u.uid.slice(0,8)}‚Ä¶</div>
            </div>
          </div>
        </td>
        <td class="muted">${escapeHtml(u.email||'')}</td>
        <td>${banned?'<span class="user-badge" style="background:#fee2e2;color:#991b1b">–ó–∞–±–∞–Ω–µ–Ω–æ</span>':'<span class="user-badge">OK</span>'}</td>
        <td><span class="user-badge" style="background:${plan.badge};color:${plan.color};font-weight:900">${plan.label}</span></td>
        <td>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            ${banned?`<button class="btn-mini" data-act="unban" data-uid="${u.uid}">–†–æ–∑–±–∞–Ω–∏—Ç–∏</button>`:`<button class="btn-mini btn-red" data-act="ban" data-uid="${u.uid}">–ó–∞–±–∞–Ω–∏—Ç–∏</button>`}
            <button class="btn-mini" data-act="grant100" data-uid="${u.uid}">–î–æ–Ω–∞—Ç 100</button>
            <button class="btn-mini" data-act="grant199" data-uid="${u.uid}">–î–æ–Ω–∞—Ç 199</button>
            <button class="btn-mini" data-act="pm" data-uid="${u.uid}">‚úâÔ∏è –õ–°</button>
            <button class="btn-mini" data-act="open" data-uid="${u.uid}">üëÄ –ü—Ä–æ—Ñ—ñ–ª—å</button>
          </div>
        </td>`;
      $usersTBody.appendChild(tr);
    });
    $usersTBody.querySelectorAll('button[data-act]').forEach(btn=> btn.onclick=()=> adminUserAction(btn.dataset.act, btn.dataset.uid));
  }

  async function adminUserAction(act, uid){
    if (!window.__isAdmin){ notify('–í—ñ–¥–º–æ–≤–∞','–ü–æ—Ç—Ä—ñ–±–Ω—ñ –ø—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω–∞'); return; }
    try{
      if (act==='ban'){
        await db.ref('settings/userFlags/'+uid).update({ banned:true, updatedBy:auth.currentUser.uid });
        await db.ref('notifications/'+uid).push({ts:Date.now(),type:'system',text:'–í–∞—à –∞–∫–∞—É–Ω—Ç —Ç–∏–º—á–∞—Å–æ–≤–æ –æ–±–º–µ–∂–µ–Ω–æ (–±–∞–Ω).'});
        notify('OK','–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞–±–∞–Ω–µ–Ω–æ');
      }else if (act==='unban'){
        await db.ref('settings/userFlags/'+uid).update({ banned:false, updatedBy:auth.currentUser.uid });
        await db.ref('notifications/'+uid).push({ts:Date.now(),type:'system',text:'–ë–∞–Ω –∑–Ω—è—Ç–æ. –î–æ—Å—Ç—É–ø –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ.'});
        notify('OK','–ë–∞–Ω –∑–Ω—è—Ç–æ');
      }else if (act==='grant100'){
        await db.ref('settings/userFlags/'+uid).update({ premium:'premium', premiumSince:Date.now(), updatedBy:auth.currentUser.uid });
        await db.ref('notifications/'+uid).push({ts:Date.now(), type:'premium', text:`–ê–∫—Ç–∏–≤–æ–≤–∞–Ω–æ –ø–ª–∞–Ω BASIC (100 Kƒç). –î—è–∫—É—î–º–æ –∑–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫—É!`});
        notify('OK','–í–∏–¥–∞–Ω–æ BASIC 100');
      }else if (act==='grant199'){
        await db.ref('settings/userFlags/'+uid).update({ premium:'premiumPlus', premiumSince:Date.now(), updatedBy:auth.currentUser.uid });
        await db.ref('notifications/'+uid).push({ts:Date.now(), type:'premium', text:`–ê–∫—Ç–∏–≤–æ–≤–∞–Ω–æ –ø–ª–∞–Ω PRO (199 Kƒç). –î—è–∫—É—î–º–æ!`});
        notify('OK','–í–∏–¥–∞–Ω–æ PRO 199');
      }else if (act==='pm'){
        openPrivateChat(uid);
      }else if (act==='open'){
        openProfile(uid);
      }
    }catch(e){ console.error(e); notify('–ü–æ–º–∏–ª–∫–∞ –¥—ñ—ó','–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑'); }
  }

  // –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–ª—è –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö ‚Äî —É–∂–µ —É—á—Ç–µ–Ω–æ –≤ canSend()

  /* –ë–û–¢-–û–ü–û–í–Ü–©–ï–ù–ù–Ø –ü–†–û –ü–õ–ê–¢–ï–ñ–Ü ‚Äî –∞–Ω—Ç–∏—Å–ø–∞–º */
  function looksLikePaymentText(t){ if (!t) return false; const s=t.toLowerCase(); return s.includes('–æ–ø–ª–∞—Ç')||s.includes('–ø–ª–∞—Ç—ñ–∂')||s.includes('payment')||s.includes('–¥–æ–Ω–∞—Ç')||s.includes('premium')||s.includes('199')||s.includes('100')||s.includes('354037257')||s.includes('0300'); }
  const _seenPay = new Set();
  function watchPaymentsInFeed(){
    const feed = db.ref('messages').limitToLast(200);
    feed.on('child_added', async snap=>{
      const m=snap.val()||{}; if(!m.uid) return; const hint=(m.image||looksLikePaymentText(m.text)); if(!hint) return;
      if(_seenPay.has(snap.key)) return; _seenPay.add(snap.key);
      const exists=(await db.ref('settings/paymentInboxSeen/'+snap.key).get()).exists(); if(exists) return;
      await db.ref('settings/paymentInboxSeen/'+snap.key).set(true);
      await db.ref('settings/paymentInbox').push({ fromUid:m.uid, ts:m.ts||Date.now(), messageId:snap.key, imageUrl:m.image||null, text:m.text||null }).catch(()=>{});
      const adminId = await getAdminUid(); if(adminId){ await db.ref('notifications/'+adminId).push({ ts:Date.now(), type:'pay', text:`–ú–æ–∂–ª–∏–≤–∞ –æ–ø–ª–∞—Ç–∞ –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤—Ä—É—á–Ω—É` }).catch(()=>{}); }
    });
  }
  watchPaymentsInFeed();

  /* –ë–û–¢–ò (–º–∞—Å–∫–∞ –ø—ñ–¥ —Å–ø—Ä–∞–≤–∂–Ω—ñ—Ö) */
  if (!window.BOTS_DEF){
    window.BOTS_DEF = [
      { id:'bot_1', nick:"–ú–∞—Ä–∏–Ω–∞", avatar:"https://i.ibb.co/LH4wBMS/IMG-d8e6076e17f19db7fe3add0754738a01-V.jpg",
        posts:[
          {text:`O2 –°–Ü–ú –ö–ê–†–¢–ê
–ë–µ–∑ –ª—ñ–º—ñ—Ç —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç —ñ –¥–∑–≤—ñ–Ω–∫–∏, –Ñ–°. 699 Kƒç/–º—ñ—Å. –°—Ç–∞—Ä—Ç 299 Kƒç. 607 914 467`, image:"https://i.ibb.co/LH4wBMS/IMG-d8e6076e17f19db7fe3add0754738a01-V.jpg"},
          {text:`–ü—Ä–æ–¥–∞—é iPhone 11 Pro Max + 26 —á–æ—Ö–ª—ñ–≤. –ë–µ–∑ Apple ID. –ü–∏—à—ñ—Ç—å —É –ø—Ä–∏–≤–∞—Ç.`, image:"https://i.ibb.co/dwcXPqDr/IMG-1954f6b56869b9817a131ae33f3a37b6-V.jpg"},
          {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è`, image:"https://i.ibb.co/G3kDcrYZ/IMG-fa590121e46c5b030c5ddc94d4e8bea9-V.jpg"}
        ], baseInterval: 2*60*1000 },
      { id:'bot_2', nick:"–ê–Ω—Ç–æ–Ω", avatar:"https://i.ibb.co/Z11WVrVC/IMG-b83692bb79a1468af74c81620750e8c0-V.jpg",
        posts:[
          {text:`–®–∞–±–ª–æ–Ω`, image:"https://i.ibb.co/Z11WVrVC/IMG-b83692bb79a1468af74c81620750e8c0-V.jpg"},
          {text:`–®—É–∫–∞—é –º–æ–¥–µ–ª–µ–π –Ω–∞ –ø–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω–∏–π –º–∞–∫—ñ—è–∂ (–ü—Ä–∞–≥–∞). –õ–∏—à–µ –∑–∞ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏.`, image:"https://i.ibb.co/QFWD5wG/IMG-6748e7141906901b131b8fd5130a5c01-V.jpg"},
          {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è 3`, image:"https://i.ibb.co/j97RhTn/IMG-593d75b053ea1a28cdfb9fc52f93afad-V.jpg"}
        ], baseInterval: 3*60*1000 },
      { id:'bot_3', nick:"–û–ª–µ–≥", avatar:"https://i.ibb.co/MzdTMPR/IMG-8231d8142ffcbba7c682ca598683e3f2-V.jpg",
        posts:[
          {text:`–ü–æ—Ç—Ä—ñ–±–µ–Ω –≤–æ–¥—ñ–π –¥–ª—è –ø–µ—Ä–µ—ó–∑–¥—É. WhatsApp: +48 793 463 757`, image:null},
          {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è`, image:"https://i.ibb.co/MzdTMPR/IMG-8231d8142ffcbba7c682ca598683e3f2-V.jpg"},
          {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è 3`, image:"https://i.ibb.co/rfNV6dd/IMG-0cd648a74f86227fe46db2d01c099be0-V.jpg"}
        ], baseInterval: 4*60*1000 }
    ];
  }

  const BotController = (()=>{
    const timers=new Map(), indices=new Map(), speeds=new Map();
    function nextPost(id,posts){ const i=(indices.get(id)||0); indices.set(id, i+1); return posts[i%posts.length]; }
    async function post(bot){ const p=nextPost(bot.id,bot.posts); try{ await db.ref('messages').push({ uid:bot.id, nick:bot.nick, avatar:bot.avatar, text:p.text, image:p.image||null, ts:Date.now() }); }catch(e){ console.error('bot push', e); } }
    function isRunning(id){ return timers.has(id); }
    function computeInterval(bot){ const mult=speeds.get(bot.id)||1; const min=15000; return Math.max(min, bot.baseInterval/mult); }
    function start(bot){ if(isRunning(bot.id)) return; const tick=async()=>{ await post(bot); schedule(); }; function schedule(){ const t=setTimeout(tick, computeInterval(bot)); timers.set(bot.id,t); updateChip(bot.id); } schedule(); }
    function stop(id){ const t=timers.get(id); if(t){ clearTimeout(t); timers.delete(id); updateChip(id); } }
    function setSpeed(id,m){ speeds.set(id,m); if (timers.has(id)){ clearTimeout(timers.get(id)); timers.delete(id); const b=BOTS_DEF.find(x=>x.id===id); if(b) start(b); } updateChip(id); }
    function postOnce(bot){ return post(bot); }
    function stopAll(){ Array.from(timers.keys()).forEach(stop); }
    function startAll(){ BOTS_DEF.forEach(start); }
    function postOnceAll(){ return Promise.all(BOTS_DEF.map(postOnce)); }
    function updateChip(id){ const chip=document.querySelector(`[data-bot='${id}']`); if(!chip) return; const running=isRunning(id); chip.querySelector('.state').textContent = running?'‚óè –ø—Ä–∞—Ü—é—î':'‚óã –∑—É–ø–∏–Ω–µ–Ω–æ'; chip.querySelector('.toggle').textContent= running?'‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏':'‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏'; }
    return {start,stop,setSpeed,postOnce,stopAll,startAll,postOnceAll,isRunning};
  })();

  (function initAdminBotsUI(){
    const box = document.getElementById('botsRow');
    function chip(bot){
      const w=document.createElement('div'); w.className='user-badge'; w.dataset.bot=bot.id; w.style.gap='8px';
      w.innerHTML = `
        <img src="${bot.avatar}" style="width:26px;height:26px;border-radius:6px;object-fit:cover">
        <b>${bot.nick}</b>
        <span class="state" style="font-size:12px;opacity:.8">‚óã –∑—É–ø–∏–Ω–µ–Ω–æ</span>
        <button class="toggle btn-mini">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏</button>
        <button class="once btn-mini" style="background:#fff3cd">‚ö°Ô∏è –†–∞–∑</button>
        <label style="font-size:12px">—à–≤–∏–¥–∫. <input type="range" min="0.5" max="3" step="0.1" value="1" class="speed"></label>
        <span class="speedv" style="font-size:12px">1√ó</span>`;
      const $toggle=w.querySelector('.toggle'); const $once=w.querySelector('.once'); const $range=w.querySelector('.speed'); const $speedv=w.querySelector('.speedv');
      $toggle.onclick=()=>{ BotController[ BotController.isRunning(bot.id)?'stop':'start'](bot); };
      $once.onclick=()=> BotController.postOnce(bot);
      $range.oninput=()=>{ const v=Number($range.value)||1; $speedv.textContent=v.toFixed(1)+'√ó'; BotController.setSpeed(bot.id,v); localStorage.setItem('bot_speed_'+bot.id,String(v)); };
      const saved=Number(localStorage.getItem('bot_speed_'+bot.id)||'1'); if(!Number.isNaN(saved)&&saved){ $range.value=String(saved); $speedv.textContent=saved.toFixed(1)+'√ó'; BotController.setSpeed(bot.id,saved); }
      return w;
    }
    if (box){ box.innerHTML=''; BOTS_DEF.forEach(b=> box.appendChild(chip(b))); }
    document.getElementById('startAll')?.addEventListener('click', ()=> BotController.startAll());
    document.getElementById('stopAll')?.addEventListener('click',  ()=> BotController.stopAll());
    document.getElementById('postOnceAll')?.addEventListener('click',()=> BotController.postOnceAll());
  })();

  </script>
</body>
</html>
