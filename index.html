<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PRAGA FU≈†KY ‚Äî –°–æ—Ü—á–∞—Ç</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{ --accent:#2ecc71; --glass: rgba(255,255,255,0.96); --muted:#64748b; --max-width:1100px; --avatar-size:52px; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif;-webkit-font-smoothing:antialiased;background:#071126;color:#0b1220;overflow-x:hidden}

    /* Background */
    body{ background-image:url('https://i.ibb.co/27hgtZfY/Prague.jpg'); background-size:cover; background-position:center; background-attachment:fixed }

    /* Header */
    header{position:sticky;top:0;z-index:120;padding:8px 12px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px}
    header .topline{width:100%;max-width:var(--max-width);display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{margin:0;font-family:'UnifrakturCook',Inter; font-size:44px;color:#fff; text-transform:uppercase; letter-spacing:1px; text-shadow: 0 6px 0 rgba(0,0,0,0.45), 0 12px 30px rgba(0,0,0,0.6)}
    header p{margin:0;color:#fff;font-size:14px;padding:6px 12px;border-radius:10px;background:rgba(0,0,0,0.28)}

    .controls{display:flex;gap:8px;align-items:center}
    .bell{position:relative; width:44px;height:44px;border-radius:10px;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .bell svg{opacity:0.95}
    .bell .count{position:absolute;right:-6px;top:-6px;background:#ef4444;color:#fff;border-radius:999px;padding:4px 7px;font-size:12px;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
    .profile-btn{width:52px;height:52px;border-radius:50%;border:2px solid #fff;background-size:cover;background-position:center;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,0.35)}

    /* Tabs */
    nav.tabs{display:flex;gap:12px;justify-content:center;padding:10px;width:100%;max-width:var(--max-width);margin:0 auto}
    .tab-button{background:linear-gradient(180deg, rgba(0,0,0,0.36), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.06);color:#fff;padding:10px 18px;font-weight:800;border-radius:12px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.45)}
    .tab-button.active{outline:3px solid rgba(46,204,113,0.12);background:linear-gradient(180deg, rgba(46,204,113,0.16), rgba(0,0,0,0.22))}

    main.container{max-width:var(--max-width);margin:8px auto;padding:6px}
    .sys-msg{margin:8px auto;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(0,0,0,0.5), rgba(0,0,0,0.22));color:#fff;font-size:15px;text-align:left;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .sys-left{flex:1}
    .sys-right{min-width:180px;text-align:right}

    .tab-content{display:none}
    .tab-content.active{display:block}

    /* Chat */
    .chat-area{height:calc(100vh - 520px);overflow:auto;padding:14px 8px;background:transparent}
    .messages{display:flex;flex-direction:column;gap:12px;padding-bottom:260px}
    .message{display:flex;gap:12px;align-items:flex-start;max-width:78%;word-break:break-word}
    .message.self{margin-left:auto;flex-direction:row-reverse}
    .avatar{width:var(--avatar-size);height:var(--avatar-size);border-radius:50%;object-fit:cover;flex:0 0 var(--avatar-size);box-shadow:0 3px 10px rgba(0,0,0,0.35);cursor:pointer}
    .message-content{background:var(--glass);padding:10px 14px;border-radius:14px;box-shadow:0 6px 30px rgba(2,6,23,0.18);color:#0b1220}
    .message.self .message-content{background:#E9FFF0}
    .message-meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .chat-image{max-width:360px;border-radius:8px;margin-top:8px;display:block}
    .message-content .text{ font-family:'UnifrakturCook',cursive;font-weight:700;font-size:1rem;color:#0b1220;white-space:pre-wrap }

    /* PM panel */
    #pmPanel{position:fixed;right:18px;bottom:88px;width:360px;max-height:70vh;background:rgba(255,255,255,0.98);box-shadow:0 12px 40px rgba(0,0,0,0.4);border-radius:12px;display:none;flex-direction:column;z-index:220}
    #pmPanel .pm-header{padding:10px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between}
    #pmPanel .pm-body{padding:10px;overflow:auto;flex:1}
    #pmPanel .pm-footer{padding:10px;border-top:1px solid #eee;display:flex;gap:8px;align-items:center}

    /* Input */
    .chat-input{position:fixed;left:0;right:0;bottom:0;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.99));border-top:1px solid rgba(0,0,0,0.06);z-index:80;display:flex;gap:8px;align-items:center;max-width:var(--max-width);margin:0 auto}
    .camera-btn{display:inline-flex;align-items:center;justify-content:center;cursor:pointer;width:48px;height:48px;border-radius:50%;background:#fff;border:1px solid #e6e6e6}
    .chat-input input[type="text"]{flex:1;padding:12px 14px;border-radius:24px;border:1px solid #d0d7de;font-size:16px;outline:none}
    .send-btn{background:var(--accent);color:#fff;border:none;padding:10px 18px;border-radius:20px;font-weight:800;cursor:pointer;box-shadow:0 8px 20px rgba(46,204,113,0.18)}

    /* Message menu */
    .msg-menu{position:fixed;background:#fff;border-radius:8px;padding:6px;box-shadow:0 6px 20px rgba(0,0,0,0.2);z-index:200;display:none}
    .msg-menu button{display:block;border:none;background:transparent;padding:6px 10px;text-align:left;width:100%;cursor:pointer}
    .msg-menu button:hover{background:rgba(0,0,0,0.03)}

    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:150}
    .modal.show{display:flex}
    .modal-panel{background:#fff;border-radius:12px;padding:16px;width:94%;max-width:720px;position:relative;box-shadow:0 18px 80px rgba(2,6,23,0.4)}
    .modal-close{position:absolute;right:10px;top:8px;background:transparent;border:none;font-size:18px;cursor:pointer}

    @media(max-width:820px){ header h1{font-size:32px} .chat-area{height:calc(100vh - 420px)} .messages{gap:14px;padding-bottom:200px} .message{max-width:92%} #pmPanel{width:94%;right:6px;left:6px} }
  </style>
</head>
<body>

  <header>
    <div class="topline">
      <div style="display:flex;align-items:center;gap:12px">
        <h1>PRAGA FU≈†KY</h1>
        <p id="tagline">–í—ñ—Ç–∞—î–º–æ! –î–æ—Ä–æ–≥—ñ —É–∫—Ä–∞—ó–Ω—Ü—ñ ‚Äî —Ü–µ–π —á–∞—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ, —â–æ–± –¥–æ–ø–æ–º–∞–≥–∞—Ç–∏ –Ω–∞—à–∏–º —Å–ø—ñ–≤–≤—ñ—Ç—á–∏–∑–Ω–∏–∫–∞–º.</p>
      </div>
      <div class="controls">
        <div id="notifBell" class="bell" title="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 17H9" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 22C13.1046 22 14 21.1046 14 20H10C10 21.1046 10.8954 22 12 22Z" fill="#fff"/><path d="M18 8C18 5.23858 15.7614 3 13 3H11C8.23858 3 6 5.23858 6 8C6 12 4 13 4 13H20C20 13 18 12 18 8Z" stroke="#fff" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <div id="notifCount" class="count" style="display:none">0</div>
        </div>
        <button id="botToggle" class="small-btn" title="–ü–∞—É–∑–∞/–°—Ç–∞—Ä—Ç –±–æ—Ç—ñ–≤">–ü–∞—É–∑–∞ –±–æ—Ç–æ–≤</button>
        <button id="profileBtn" class="profile-btn" title="–ü—Ä–æ—Ñ—ñ–ª—å"></button>
      </div>
    </div>

    <nav class="tabs" role="tablist" aria-label="–í–∫–ª–∞–¥–∫–∏">
      <button class="tab-button active" data-target="chatTab">üí¨ –ß–∞—Ç</button>
      <button class="tab-button" data-target="rentTab">üèòÔ∏è –ß–∞—Ç –û—Ä–µ–Ω–¥–∞</button>
      <button class="tab-button" data-target="mapTab">üó∫ –ö–∞—Ä—Ç–∞</button>
      <button class="tab-button" data-target="helpTab">‚ùì –î–æ–ø–æ–º–æ–≥–∞</button>
    </nav>
  </header>

  <main class="container">
    <div class="sys-msg">
      <div class="sys-left">–Ø–∫—â–æ –≤–∏ –≤–ø–µ—Ä—à–µ ‚Äî –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏" ‚Äî –∑'—è–≤–∏—Ç—å—Å—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è. 6 –≥–æ–¥–∏–Ω –¥–æ—Å—Ç—É–ø—É –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email.</div>
      <div class="sys-right"><strong>–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.):</strong> <span id="onlineCount">‚Äî</span></div>
    </div>

    <!-- Chat -->
    <section id="chatTab" class="tab-content active">
      <div class="chat-area" id="chatArea" aria-live="polite">
        <div id="messages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- Rent chat -->
    <section id="rentTab" class="tab-content" style="display:none">
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <input id="rentSearch" placeholder="–ü–æ—à—É–∫ –æ–≥–æ–ª–æ—à–µ–Ω—å..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd">
        <button id="postRentBtn" class="small-btn">–ü–æ–¥–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</button>
      </div>
      <div class="chat-area" style="height:54vh">
        <div id="rentMessages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- Map (Google Maps will load with key) -->
    <section id="mapTab" class="tab-content" style="display:none">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <div style="flex:1"><input id="mapSearch" placeholder="–ü–æ—à—É–∫ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –≤–æ–ª–æ–Ω—Ç–µ—Ä–∏, –∞–ø—Ç–µ–∫–∞)..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd"></div>
        <div><button id="centerBtn" class="small-btn">–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏</button></div>
      </div>
      <div id="map" style="height:60vh;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.3)"></div>
    </section>

    <!-- Help -->
    <section id="helpTab" class="tab-content" style="display:none">
      <h2 style="color:#fff">–¢–µ—Ä–º—ñ–Ω–æ–≤–∞ –¥–æ–ø–æ–º–æ–≥–∞ —É –ü—Ä–∞–∑—ñ</h2>
      <div class="help-grid">
        <div class="help-card">
          <img src="https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp" alt="–ë–æ–ª—å–Ω–∏—Ü–∞">
          <h3>Nemocnice Motol</h3><p>–ê–¥—Ä–µ—Å–∞: V Uvalu 84</p>
        </div>
        <div class="help-card">
          <img src="https://i.ibb.co/0gWD5wW/images-5.jpg" alt="–Æ—Ä–∏—Å—Ç—ã">
          <h3>–Æ—Ä–∏–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞</h3><p>–î–æ–∫—É–º–µ–Ω—Ç–∏ —Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó</p>
        </div>
        <div class="help-card">
          <img src="https://i.ibb.co/R49shL6k/images-6.jpg" alt="–ú–∞–≥–∞–∑–∏–Ω—ã">
          <h3>–£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –º–∞–≥–∞–∑–∏–Ω–∏</h3><p>–ü—Ä–æ–¥—É–∫—Ç–∏ —Ç–∞ —Ç–æ–≤–∞—Ä–∏</p>
        </div>
      </div>
    </section>
  </main>

  <!-- PM floating panel -->
  <div id="pmPanel">
    <div class="pm-header">
      <div id="pmTitle">–ß–∞—Ç</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="pmClose" class="small-btn">–ó–∞–∫—Ä–∏—Ç–∏</button>
      </div>
    </div>
    <div class="pm-body" id="pmBody"></div>
    <div class="pm-footer">
      <input id="pmInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç–∏..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd">
      <button id="pmSend" class="small-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
    </div>
  </div>

  <!-- Hidden file input -->
  <input id="fileInput" type="file" accept="image/*" style="display:none">

  <!-- Input bar -->
  <div class="chat-input" role="region" aria-label="–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">
    <label for="fileInput" class="camera-btn" title="–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="#111" xmlns="http://www.w3.org/2000/svg"><path d="M4 7H6L7 5H17L18 7H20C21.1 7 22 7.9 22 9V19C22 20.1 21.1 21 20 21H4C2.9 21 2 20.1 2 19V9C2 7.9 2.9 7 4 7Z"></path></svg>
    </label>
    <input id="messageInput" type="text" inputmode="text" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." aria-label="–¢–µ–∫—Å—Ç" />
    <button id="sendButton" class="send-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
  </div>

  <!-- Profile modal -->
  <div id="profileModal" class="modal" aria-hidden="true">
    <div class="modal-panel">
      <button class="modal-close" id="profileClose">‚úï</button>
      <div id="profileContent">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>
  </div>

  <!-- Message ctx menu -->
  <div id="msgMenu" class="msg-menu" role="menu">
    <button data-act="like">üëç –õ–∞–π–∫</button>
    <button data-act="warn">‚ö†Ô∏è –û—Å—Ç–µ—Ä–µ–∂–Ω–æ (—à–∞—Ö—Ä–∞–π)</button>
    <button data-act="dislike">üëé –î–∏–∑–ª–∞–π–∫</button>
    <button data-act="spam">üö´ –°–ø–∞–º</button>
    <button data-act="reply">‚Ü©Ô∏è –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏</button>
  </div>

  <!-- Firebase + full app logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, sendEmailVerification, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref as dbRef, push as dbPush, onChildAdded, query, orderByChild, limitToLast, get as dbGet, set as dbSet, onValue, remove as dbRemove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // ---------- Firebase config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
      authDomain: "praga-4baee.firebaseapp.com",
      databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
      projectId: "praga-4baee",
      storageBucket: "praga-4baee.firebasestorage.app",
      messagingSenderId: "336023952536",
      appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
      measurementId: "G-BGDJD6R12N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // DOM refs
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const messagesEl = document.getElementById('messages');
    const rentMessagesEl = document.getElementById('rentMessages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const fileInput = document.getElementById('fileInput');
    const profileBtn = document.getElementById('profileBtn');
    const profileModal = document.getElementById('profileModal');
    const profileClose = document.getElementById('profileClose');
    const profileContent = document.getElementById('profileContent');
    const notifBell = document.getElementById('notifBell');
    const notifCount = document.getElementById('notifCount');
    const onlineCountEl = document.getElementById('onlineCount');
    const mapEl = document.getElementById('map');
    const botToggle = document.getElementById('botToggle');

    // PM panel refs
    const pmPanel = document.getElementById('pmPanel');
    const pmTitle = document.getElementById('pmTitle');
    const pmBody = document.getElementById('pmBody');
    const pmClose = document.getElementById('pmClose');
    const pmInput = document.getElementById('pmInput');
    const pmSend = document.getElementById('pmSend');

    const DEFAULT_AVATAR = 'https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg';
    let currentUser = null;
    const MSG_LIMIT = 500;

    // Tabs
    function setActiveTab(id){ tabButtons.forEach(b=>b.classList.toggle('active', b.dataset.target===id)); tabContents.forEach(c=>c.style.display=(c.id===id)?'block':'none'); if(id==='chatTab') messageInput.focus(); if(id==='mapTab') setTimeout(()=> { if(window.google && window.map) { google.maps.event.trigger(window.map,'resize'); window.map.setCenter({lat:50.0755,lng:14.4378}); } }, 200); }
    tabButtons.forEach(btn=>btn.addEventListener('click', ()=> setActiveTab(btn.dataset.target)));
    document.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='c') setActiveTab('chatTab'); if(e.key.toLowerCase()==='r') setActiveTab('rentTab'); if(e.key.toLowerCase()==='m') setActiveTab('mapTab'); if(e.key.toLowerCase()==='h') setActiveTab('helpTab'); });

    function timeStr(ts){ return new Date(ts).toLocaleString(); }

    // Render message
    function renderMessage(m, container = messagesEl){
      if(!m || !m.ts) return;
      const wrap = document.createElement('div');
      wrap.className = 'message' + ((currentUser && m.uid === currentUser.uid) ? ' self' : '');
      wrap.dataset.uid = m.uid || '';
      wrap.dataset.msgid = m.id || '';

      const avatar = document.createElement('img');
      avatar.className = 'avatar';
      avatar.src = m.avatar || DEFAULT_AVATAR;
      avatar.alt = m.nick || 'avatar';
      avatar.title = m.nick || '–ü–æ–∫–∞–∑ –ø—Ä–æ—Ñ—ñ–ª—é';
      avatar.addEventListener('click', ()=> openProfile(m.uid));

      const txt = document.createElement('div');
      txt.className = 'message-content';
      const meta = document.createElement('div');
      meta.className = 'message-meta';
      meta.textContent = `${m.nick || '–ê–Ω–æ–Ω—ñ–º'} ¬∑ ${timeStr(m.ts)}` + (m.recipientUid ? ' ¬∑ –æ—Å–æ–±–∏—Å—Ç–µ' : '');
      txt.appendChild(meta);

      if(m.text){
        const p = document.createElement('div');
        p.className = 'text';
        p.innerText = m.text;
        txt.appendChild(p);
      }
      if(m.image){
        const im = document.createElement('img');
        im.src = m.image;
        im.alt = '–§–æ—Ç–æ';
        im.className = 'chat-image';
        txt.appendChild(im);
      }

      wrap.appendChild(avatar);
      wrap.appendChild(txt);
      container.appendChild(wrap);

      // context menu
      wrap.addEventListener('contextmenu', (ev)=>{ ev.preventDefault(); showMsgMenu(ev.pageX, ev.pageY, m, wrap); });

      // autoscroll
      const chatArea = container.closest('.chat-area');
      if(chatArea){
        const nearBottom = chatArea.scrollHeight - chatArea.scrollTop - chatArea.clientHeight < 200;
        if(nearBottom) chatArea.scrollTop = chatArea.scrollHeight;
      }
    }

    // subscribe public messages
    const msgsQuery = query(dbRef(db,'messages'), orderByChild('ts'), limitToLast(MSG_LIMIT));
    onChildAdded(msgsQuery, snap=>{ const m = snap.val(); m.id = snap.key; renderMessage(m, messagesEl); });

    // rent messages
    const rentQuery = query(dbRef(db,'rentMessages'), orderByChild('ts'), limitToLast(200));
    onChildAdded(rentQuery, snap=>{ const m = snap.val(); m.id = snap.key; renderMessage(m, rentMessagesEl); });

    // image resize
    function resizeImageFile(file, maxWidth=1200, quality=0.8){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        const reader = new FileReader();
        reader.onload = (e)=>{
          img.onload = ()=>{
            const scale = Math.min(1, maxWidth / img.width);
            const w = Math.round(img.width * scale);
            const h = Math.round(img.height * scale);
            const canvas = document.createElement('canvas');
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            resolve(dataUrl);
          };
          img.onerror = (err)=> reject(err);
          img.src = e.target.result;
        };
        reader.onerror = (err)=> reject(err);
        reader.readAsDataURL(file);
      });
    }

    // send public message
    sendButton.addEventListener('click', async ()=>{
      if(!auth.currentUser){ showAuthModal(); return; }
      if(!await canSendMessage()){ alert('–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å email –∞–±–æ —Å–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—å 6-–≥–æ–¥–∏–Ω–Ω–∏–º –¥–æ—Å—Ç—É–ø–æ–º –ø—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó.'); return; }

      const text = messageInput.value.trim();
      const file = fileInput.files[0];
      if(!text && !file) return;

      let imageData = null;
      if(file){
        try{ imageData = await resizeImageFile(file, 1200, 0.8); } catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Ñ–æ—Ç–æ'); return; }
      }

      const msg = {
        uid: auth.currentUser.uid,
        nick: auth.currentUser.displayName || auth.currentUser.email || '–ê–Ω–æ–Ω—ñ–º',
        avatar: auth.currentUser.photoURL || DEFAULT_AVATAR,
        text: text || null,
        image: imageData || null,
        ts: Date.now(),
        recipientUid: null
      };

      try{ await dbPush(dbRef(db,'messages'), msg); messageInput.value = ''; fileInput.value = ''; } catch(err){ console.error('dbPush error', err); alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è'); }
    });

    messageInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendButton.click(); } });

    // ----------------- Auth / Profile -----------------
    function showAuthModal(){ profileModal.classList.add('show'); profileModal.setAttribute('aria-hidden','false'); profileContent.innerHTML = authHtml(); attachAuthHandlers(); }
    function hideAuthModal(){ profileModal.classList.remove('show'); profileModal.setAttribute('aria-hidden','true'); }

    function authHtml(){ return `
      <h2>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è / –í—Ö—ñ–¥</h2>
      <div style="display:flex;gap:12px;flex-direction:column">
        <input id="uiNick" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" />
        <input id="uiEmail" placeholder="Email" />
        <input id="uiPass" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω. 6)" type="password" />
        <div style="display:flex;gap:8px;"><button id="uiRegister">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å</button><button id="uiLogin">–£–≤—ñ–π—Ç–∏</button></div>
        <div id="uiAuthMsg" style="color:#b91c1c"></div>
      </div>
    `; }

    function attachAuthHandlers(){
      document.getElementById('uiRegister').addEventListener('click', async ()=>{
        const nick = document.getElementById('uiNick').value.trim();
        const email = document.getElementById('uiEmail').value.trim();
        const pass = document.getElementById('uiPass').value.trim();
        const msgEl = document.getElementById('uiAuthMsg');
        msgEl.textContent = '';
        if(!nick||!email||!pass){ msgEl.textContent='–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è'; return; }
        if(pass.length<6){ msgEl.textContent='–ü–∞—Ä–æ–ª—å –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤'; return; }
        try{
          const cred = await createUserWithEmailAndPassword(auth, email, pass);
          await updateProfile(cred.user, { displayName: nick, photoURL: DEFAULT_AVATAR });
          await dbSet(dbRef(db, `users/${cred.user.uid}`), { nick, email, avatar: DEFAULT_AVATAR, createdAt: Date.now(), online:true });
          localStorage.setItem('regTime_'+cred.user.uid, String(Date.now()));
          await sendEmailVerification(cred.user);
          hideAuthModal();
          alert('–ó–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ. –õ–∏—Å—Ç –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ.');
        }catch(e){ console.error(e); msgEl.textContent = e.message || String(e); }
      });

      document.getElementById('uiLogin').addEventListener('click', async ()=>{
        const email = document.getElementById('uiEmail').value.trim();
        const pass = document.getElementById('uiPass').value.trim();
        const msgEl = document.getElementById('uiAuthMsg'); msgEl.textContent = '';
        if(!email||!pass){ msgEl.textContent='–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è'; return; }
        try{ await signInWithEmailAndPassword(auth, email, pass); hideAuthModal(); } catch(e){ console.error(e); msgEl.textContent = e.message || String(e); }
      });
    }

    profileBtn.addEventListener('click', ()=>{ if(!auth.currentUser){ showAuthModal(); return; } openProfile(auth.currentUser.uid, true); });
    profileClose.addEventListener('click', ()=> hideAuthModal());

    async function openProfile(uid, self=false){
      profileContent.innerHTML = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...'; profileModal.classList.add('show'); profileModal.setAttribute('aria-hidden','false');
      try{
        const snap = await dbGet(dbRef(db, `users/${uid}`));
        const user = snap && snap.exists()? snap.val() : { nick:'–ê–Ω–æ–Ω—ñ–º', avatar: DEFAULT_AVATAR };
        const isSelf = auth.currentUser && auth.currentUser.uid === uid;
        profileContent.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center">
            <img id="profImg" src="${user.avatar||DEFAULT_AVATAR}" style="width:112px;height:112px;border-radius:12px;object-fit:cover">
            <div>
              <h3 style="margin:0">${user.nick||'–ê–Ω–æ–Ω—ñ–º'}</h3>
              <div style="color:#666">${user.email||''}</div>
            </div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px">
            ${isSelf? '<button id="editAvatarBtn" class="small-btn">–ó–º—ñ–Ω–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä</button><button id="inboxBtn" class="small-btn">–û—Å–æ–±–∏—Å—Ç—ñ</button><button id="logoutBtn" class="small-btn">–í–∏–π—Ç–∏</button>' : `<button id="pmBtn" class="small-btn">–ù–∞–ø–∏—Å–∞—Ç–∏</button><button id="addFriendBtn" class="small-btn">–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>`}
          </div>
          <div id="profileMsg" style="margin-top:8px;color:#b91c1c"></div>
        `;
        if(isSelf){
          document.getElementById('editAvatarBtn').addEventListener('click', ()=>{
            const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
            inp.addEventListener('change', async ()=> {
              const f = inp.files[0]; if(!f) return;
              try{
                const dataUrl = await resizeImageFile(f, 1000, 0.85);
                await dbSet(dbRef(db, `users/${uid}/avatar`), dataUrl);
                await updateProfile(auth.currentUser, { photoURL: dataUrl });
                document.getElementById('profImg').src = dataUrl; profileBtn.style.background = `url(${dataUrl}) center/cover`;
                alert('–ê–≤–∞—Ç–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ');
              }catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–≤–∞—Ç–∞—Ä–∞'); }
            });
            inp.click();
          });
          document.getElementById('inboxBtn').addEventListener('click', ()=> openInbox());
          document.getElementById('logoutBtn').addEventListener('click', async ()=>{ try{ await signOut(auth); alert('–í–∏ –≤–∏–π—à–ª–∏'); hideAuthModal(); }catch(e){ console.error(e); } });
        } else {
          document.getElementById('pmBtn').addEventListener('click', ()=>{ profileModal.classList.remove('show'); startPrivateChat(uid); });
          document.getElementById('addFriendBtn').addEventListener('click', async ()=>{ if(!auth.currentUser){ showAuthModal(); return; } try{ await dbSet(dbRef(db, `friendRequests/${uid}/${auth.currentUser.uid}`), { from: auth.currentUser.uid, ts: Date.now() }); document.getElementById('profileMsg').textContent = '–ó–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ.'; updateNotifications(); }catch(e){ document.getElementById('profileMsg').textContent = '–ü–æ–º–∏–ª–∫–∞'; } });
        }
      }catch(e){ profileContent.innerHTML = '–ü–æ–º–∏–ª–∫–∞'; console.error(e); }
    }

    // Notifications
    async function updateNotifications(){
      if(!auth.currentUser){ notifCount.style.display='none'; return; }
      try{
        const reqSnap = await dbGet(dbRef(db, `friendRequests/${auth.currentUser.uid}`));
        const reqCount = reqSnap && reqSnap.exists()? Object.keys(reqSnap.val()).length : 0;
        const metaSnap = await dbGet(dbRef(db, `inboxMeta/${auth.currentUser.uid}/unread`));
        const unread = metaSnap && metaSnap.exists()? Number(metaSnap.val()) : 0;
        const total = reqCount + unread;
        if(total>0){ notifCount.style.display='block'; notifCount.textContent = String(total); } else notifCount.style.display='none';
      }catch(e){ console.error(e); }
    }

    notifBell.addEventListener('click', ()=>{
      if(!auth.currentUser){ showAuthModal(); return; }
      profileContent.innerHTML = '<h3>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h3><div id="notifList">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>'; profileModal.classList.add('show'); profileModal.setAttribute('aria-hidden','false');
      (async ()=>{
        const list = document.getElementById('notifList'); list.innerHTML = '';
        const rr = await dbGet(dbRef(db, `friendRequests/${auth.currentUser.uid}`));
        if(rr && rr.exists()){
          const data = rr.val();
          for(const k of Object.keys(data)){
            const d = data[k];
            const el = document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #eee';
            el.innerHTML = `–ó–∞–ø–∏—Ç –≤—ñ–¥ ${d.from} ‚Äî <button data-from="${d.from}">–ü—Ä–∏–π–Ω—è—Ç–∏</button> <button data-from2="${d.from}">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>`;
            list.appendChild(el);
            el.querySelector('button[data-from]').addEventListener('click', async (e)=>{ const from = e.target.dataset.from; try{ await dbSet(dbRef(db, `friends/${auth.currentUser.uid}/${from}`), { ts: Date.now() }); await dbSet(dbRef(db, `friends/${from}/${auth.currentUser.uid}`), { ts: Date.now() }); await dbRemove(dbRef(db, `friendRequests/${auth.currentUser.uid}/${from}`)); e.target.closest('div').remove(); updateNotifications(); alert('–î–æ–¥–∞–Ω–æ –≤ –¥—Ä—É–∑—ñ'); }catch(ex){ console.error(ex); } });
            el.querySelector('button[data-from2]').addEventListener('click', async (e)=>{ const from = e.target.dataset.from2; await dbRemove(dbRef(db, `friendRequests/${auth.currentUser.uid}/${from}`)); e.target.closest('div').remove(); updateNotifications(); });
          }
        }
        const inbox = await dbGet(dbRef(db, `inboxMeta/${auth.currentUser.uid}`));
        if(inbox && inbox.exists()){
          const data = inbox.val();
          for(const convo in data){ if(convo==='unread') continue;
            const el = document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #eee';
            el.textContent = `–ß–∞—Ç: ${convo} ‚Äî –æ—Å—Ç–∞–Ω–Ω—î: ${new Date(data[convo].lastTs).toLocaleString()}`; list.appendChild(el);
          }
        }
        if(list.innerHTML==='') list.innerHTML='–ù–µ–º–∞—î —Å–ø–æ–≤—ñ—â–µ–Ω—å';
      })();
    });

    // Presence (online counter x10)
    function updateOnlineCount(){ onValue(dbRef(db,'presence'), snap=>{ const val = snap.val()||{}; const real = Object.keys(val).length; const shown = real * 10; onlineCountEl.textContent = shown; }); }

    onAuthStateChanged(auth, (user)=>{
      currentUser = user;
      if(user){ profileBtn.style.background = `url(${user.photoURL||DEFAULT_AVATAR}) center/cover`; try{ dbSet(dbRef(db, `presence/${user.uid}`), { ts: Date.now(), nick: user.displayName || user.email }); }catch(e){} } else { profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`; }
      updateNotifications(); updateOnlineCount();
    });

    // ----------------- Private messages (in-panel UI) -----------------
    let currentConvo = null;
    function convoIdFor(u1, u2){ return u1 < u2 ? u1 + '_' + u2 : u2 + '_' + u1; }

    async function startPrivateChat(otherUid){
      if(!auth.currentUser){ showAuthModal(); return; }
      currentConvo = convoIdFor(auth.currentUser.uid, otherUid);
      pmTitle.textContent = '–ß–∞—Ç: ' + currentConvo;
      pmBody.innerHTML = '<div style="opacity:0.6">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
      pmPanel.style.display = 'flex';
      // subscribe last 200 messages for this convo
      const q = query(dbRef(db, `privateMessages/${currentConvo}`), orderByChild('ts'), limitToLast(200));
      // We'll clear and re-subscribe - simple approach
      // Attach onChildAdded
      onChildAdded(q, snap=>{
        const m = snap.val(); m.id = snap.key;
        appendPmMessage(m);
      });
      // mark unread reset
      await dbSet(dbRef(db, `inboxMeta/${auth.currentUser.uid}/unread`), 0);
      updateNotifications();
    }

    function appendPmMessage(m){
      if(!m) return;
      // ensure pmBody exists
      if(!pmBody) return;
      const el = document.createElement('div'); el.style.marginBottom='8px';
      el.innerHTML = `<div style="font-size:12px;color:#666">${m.fromNick || m.from} ¬∑ ${new Date(m.ts).toLocaleString()}</div><div style="font-weight:600">${m.text || ''}</div>`;
      pmBody.appendChild(el);
      pmBody.scrollTop = pmBody.scrollHeight;
    }

    pmSend.addEventListener('click', async ()=>{
      if(!auth.currentUser){ showAuthModal(); return; }
      const txt = pmInput.value.trim(); if(!txt) return;
      if(!currentConvo){ alert('–ù–µ –≤—ñ–¥–∫—Ä–∏—Ç–æ –±–µ—Å—ñ–¥—É'); return; }
      const pm = { from: auth.currentUser.uid, to: currentConvo.includes(auth.currentUser.uid) ? (currentConvo.split('_').find(x=>x!==auth.currentUser.uid)) : null, text: txt, ts: Date.now(), fromNick: auth.currentUser.displayName || auth.currentUser.email };
      try{
        await dbPush(dbRef(db, `privateMessages/${currentConvo}`), pm);
        // update inbox meta for recipient
        const other = currentConvo.split('_').find(x=>x!==auth.currentUser.uid);
        if(other){
          const prev = await dbGet(dbRef(db, `inboxMeta/${other}/unread`));
          const cur = prev && prev.exists()? Number(prev.val()) : 0;
          await dbSet(dbRef(db, `inboxMeta/${other}/unread`), cur+1);
          await dbSet(dbRef(db, `inboxMeta/${other}/${currentConvo}`), { lastTs: Date.now(), lastFrom: auth.currentUser.uid });
        }
        pmInput.value = '';
        updateNotifications();
      }catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è PM'); }
    });

    pmClose.addEventListener('click', ()=>{ pmPanel.style.display = 'none'; currentConvo = null; pmBody.innerHTML = ''; });

    async function openInbox(){ if(!auth.currentUser){ showAuthModal(); return; } profileContent.innerHTML = '<h3>–û—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</h3><div id="inboxList">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>'; profileModal.classList.add('show'); profileModal.setAttribute('aria-hidden','false');
      const inboxList = document.getElementById('inboxList'); try{
        const snap = await dbGet(dbRef(db, `inboxMeta/${auth.currentUser.uid}`)); const data = snap && snap.exists()? snap.val() : {};
        inboxList.innerHTML = ''; for(const k in data){ if(k==='unread') continue; const el = document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #eee'; el.textContent = `${k} ‚Äî –æ—Å—Ç–∞–Ω–Ω—î: ${new Date(data[k].lastTs).toLocaleString()}`; el.addEventListener('click', ()=>{ profileModal.classList.remove('show'); startConversationFromConvoId(k); }); inboxList.appendChild(el); }
        if(!inboxList.children.length) inboxList.innerHTML = '–ü—É—Å—Ç–æ';
      }catch(e){ inboxList.innerHTML='–ü–æ–º–∏–ª–∫–∞'; }
    }

    function startConversationFromConvoId(convoId){
      currentConvo = convoId;
      pmTitle.textContent = '–ß–∞—Ç: ' + convoId;
      pmBody.innerHTML = '';
      pmPanel.style.display = 'flex';
      const q = query(dbRef(db, `privateMessages/${currentConvo}`), orderByChild('ts'), limitToLast(500));
      onChildAdded(q, snap=> appendPmMessage(snap.val()));
      // reset unread
      if(currentUser) dbSet(dbRef(db, `inboxMeta/${currentUser.uid}/unread`), 0);
    }

    // ----------------- Message menu actions -----------------
    const msgMenu = document.getElementById('msgMenu');
    function showMsgMenu(x,y,msg,wrap){
      msgMenu.style.left = x + 'px'; msgMenu.style.top = y + 'px'; msgMenu.style.display = 'block';
      const hide = ()=>{ msgMenu.style.display = 'none'; document.removeEventListener('click', hide); };
      document.addEventListener('click', hide, { once:true });
      msgMenu.querySelectorAll('button').forEach(btn=>{
        btn.onclick = async ()=> {
          const act = btn.dataset.act;
          try{
            if(act === 'reply'){
              const r = prompt('–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:');
              if(r){ await dbPush(dbRef(db,'messages'), { uid: auth.currentUser.uid, nick: auth.currentUser.displayName || auth.currentUser.email, avatar: auth.currentUser.photoURL || DEFAULT_AVATAR, text: '‚Ü™Ô∏è –í—ñ–¥–ø–æ–≤—ñ–¥—å: ' + r, ts: Date.now(), recipientUid: msg.uid }); }
            } else {
              if(!msg.id){ alert('–ù–µ–º–∞—î id –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è'); return; }
              await dbSet(dbRef(db, `messageReactions/${msg.id}/${auth.currentUser?auth.currentUser.uid:'anon'}`), { act, ts: Date.now() });
              alert('–î—ñ—è: ' + act);
            }
          }catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –¥—ñ—ó'); }
        };
      });
    }

    // ----------------- BOTS -----------------
    const BOT_USERS = [
      { uid: 'lucas_01', nick: 'Luka Novak', avatar: 'https://i.ibb.co/LH4wBMS/IMG-d8e6076e17f19db7fe3add0754738a01-V.jpg', ads: [
        `O2 –°–Ü–ú –ö–ê–†–¢–ê\n–ë–µ–∑ –ªi–ºi—Ç —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç\n–ë–µ–∑ –ªi–ºi—Ç –¥–∑–≤—ñ–Ω–∫–∏\n–ü—Ä–∞—Ü—é—î –≤ –Ñ–≤—Ä–æ–ø—ñ\n–ø–ª–∞—Ç–∞ 699 –∫—Ä–æ–Ω/–º—ñ—Å. –¶i–Ω–∞ 299–∫—Å. —Ç–µ–ª 607914467. Viber/WhatsApp/Telegram.`,
        `–î–æ–±—Ä–æ–≥–æ –¥–Ω—è! –ü—Ä–æ–¥–∞—é —Å–≤—ñ–π iPhone 11 Pro Max —Ä–∞–∑–æ–º —ñ–∑ 26 —á–æ—Ö–ª–∞–º–∏ ‚Äî —á–æ—Ö–ª–∏ –≤—ñ–¥–¥–∞—é –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ. –£ —Ç–µ–ª–µ—Ñ–æ–Ω—ñ –Ω—ñ—á–æ–≥–æ –Ω–µ –º—ñ–Ω—è–ª–æ—Å—è, –∂–æ–¥–Ω–∏—Ö —Ç—Ä—ñ—â–∏–Ω. –ü–∏—à—ñ—Ç—å.`,
        `–§–æ—Ç–æ: –¥–∏–≤—ñ—Ç—å—Å—è –≤–∫–ª–∞–¥–µ–Ω–Ω—è.`
      ]},
      { uid: 'anna_p', nick: 'Anna Petrova', avatar: 'https://i.ibb.co/QFWDvGZ8/IMG-6748e7141906901b131b8fd5130a5c01-V.jpg', ads: [
        `–ó–∞–ø—Ä–æ—à—É—é –º–æ–¥–µ–ª–µ–π –Ω–∞ –ø–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω–∏–π –º–∞–∫—ñ—è–∂ –≤—ñ–¥ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ–≥–æ –º–∞–π—Å—Ç—Ä–∞.\n–¶—ñ–Ω–∞ ‚Äî –ª–∏—à–µ –∑–∞ –º–∞—Ç–µ—Ä—ñ–∞–ª.\n–ü—Ä–∞–≥–∞\n–î–∞—Ç–∞: 28.07 14:00.\n–ü–∏—à—ñ—Ç—å –≤ –ø—Ä–∏–≤–∞—Ç.`,
        `–Ü–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ç–∏—Ö, —Ö—Ç–æ –º—Ä—ñ—î –ø—Ä–æ –ü–ú ‚Äî —Ñ–æ—Ç–æ —Ç–∞ –∑–∞–ø–∏—Å —É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è—Ö.`,
        `–î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ–æ—Ç–æ —É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ.`
      ]},
      { uid: 'marek_m', nick: 'Marek Horvat', avatar: 'https://i.ibb.co/rfNV6ddC/IMG-0cd648a74f86227fe46db2d01c099be0-V.jpg', ads: [
        `–ù—É–∂–µ–Ω –≤–æ–¥–∏—Ç–µ–ª—å –¥–ª—è –¥–æ–ø–æ–º–æ–≥–∏ –≤ –ø–µ—Ä–µ—ó–∑–¥—ñ, –∑—ñ —Å–≤–æ—ó–º –∞–≤—Ç–æ.\nWhatsApp: +48 793 463 757 ‚Ä¢ Telegram: @carlx_xxx`,
        `–û–≥–æ–ª–æ—à–µ–Ω–Ω—è –∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—è–º–∏ ‚Äî –¥–∏–≤—ñ—Ç—å—Å—è –ø–æ—Å—Ç.`,
        `–ö–æ–Ω—Ç–∞–∫—Ç–∏ –∑–∞ –∑–∞–ø–∏—Ç–æ–º.`
      ]}
    ];

    // Sequence intervals: after bot1 -> wait 3min -> bot2 -> wait 2min -> bot3 -> wait 5min -> repeat
    const SEQ = [3*60*1000, 2*60*1000, 5*60*1000];

    let botsPaused = false;
    function startBotsClientSide(){
      if(localStorage.getItem('pf_bots_started') && localStorage.getItem('pf_bots_started') === '2') return; // '2' means suppressed forever
      if(localStorage.getItem('pf_bots_started') && localStorage.getItem('pf_bots_started') === '1' && botsPaused) return;
      if(localStorage.getItem('pf_bots_running')) return;
      localStorage.setItem('pf_bots_running','1');
      let idx = 0;
      (async function loop(){
        if(botsPaused){ setTimeout(loop, 5000); return; }
        const bot = BOT_USERS[idx % BOT_USERS.length];
        const adIndex = Math.floor(Date.now()/60000) % bot.ads.length;
        const text = bot.ads[adIndex];
        try{ await dbPush(dbRef(db,'messages'), { uid: bot.uid, nick: bot.nick, avatar: bot.avatar, text: text, image: null, ts: Date.now() }); }catch(e){ console.error('bot push err', e); }
        const wait = SEQ[idx % SEQ.length];
        idx = (idx + 1) % BOT_USERS.length;
        setTimeout(loop, wait);
      })();
    }

    // Toggle bots
    botToggle.addEventListener('click', ()=>{
      botsPaused = !botsPaused;
      botToggle.textContent = botsPaused ? '–°—Ç–∞—Ä—Ç –±–æ—Ç–æ–≤' : '–ü–∞—É–∑–∞ –±–æ—Ç–æ–≤';
      if(!botsPaused) startBotsClientSide();
    });

    // Small delay
    setTimeout(()=> startBotsClientSide(), 2500);

    // ----------------- Google Maps points -----------------
    const MAP_POINTS = [
      { title:'Nemocnice Motol', pos:{lat:50.058, lng:14.360}, img:'https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp' },
      { title:'Pravni pomoc', pos:{lat:50.083, lng:14.412}, img:'https://i.ibb.co/0gWD5wW/images-5.jpg' },
      { title:'Ukrainske sklepy', pos:{lat:50.084, lng:14.417}, img:'https://i.ibb.co/R49shL6k/images-6.jpg' }
    ];

    window.initMap = function(){
      try{
        const center = { lat:50.0755, lng:14.4378 };
        window.map = new google.maps.Map(mapEl, { center, zoom:13, gestureHandling:'greedy' });
        window.markers = [];
        MAP_POINTS.forEach(p=>{
          const marker = new google.maps.Marker({ position:p.pos, map:window.map, title:p.title });
          const content = `<div style="width:220px"><strong>${p.title}</strong><div><img src='${p.img}' style='width:100%;border-radius:6px;margin-top:6px'></div></div>`;
          const inf = new google.maps.InfoWindow({ content });
          marker.addListener('click', ()=> inf.open(window.map, marker));
          window.markers.push(marker);
        });
        document.getElementById('centerBtn').addEventListener('click', ()=> window.map.panTo(center));
        const mapSearch = document.getElementById('mapSearch');
        mapSearch.addEventListener('input', (e)=>{ const q = e.target.value.trim().toLowerCase(); window.markers.forEach(mk => mk.setVisible(!q || mk.title.toLowerCase().includes(q))); });
      }catch(e){ console.error('initMap', e); }
    };

    // ----------------- Misc helpers -----------------
    setInterval(()=> updateNotifications(), 8000);
    updateOnlineCount();

    // Expose debug helper
    window.__PF = { startBotsClientSide };

  </script>

  <!-- Google Maps script with your API key inserted -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFrxVhpb6nHJ6rhiLl5Ho8t0jOb1iEQNc&callback=initMap"></script>
</body>
</html>
