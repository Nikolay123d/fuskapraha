<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>–ü–†–ê–ì–ê –§–£–®–ö–ò ‚Äî —á–∞—Ç —Å–ø—ñ–ª—å–Ω–æ—Ç–∏</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="color-scheme" content="light dark">
  <link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Ctext x='8' y='48' font-size='48'%3Eüí¨%3C/text%3E%3C/svg%3E">
  <style>
    :root{
      --bg:#0b0f14; --card:#121821; --muted:#8aa0b2; --text:#e8f0f7; --accent:#42a5f5;
      --ok:#22c55e; --warn:#eab308; --bad:#ef4444; --ring:#64b5f6; --tabGlow:#00ffa8;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    a{color:var(--accent);text-decoration:none}
    button{cursor:pointer;border:0;border-radius:10px;padding:10px 14px;background:#1e2734;color:var(--text);font-weight:600;transition:.2s}
    button:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.25)}
    input,textarea{width:100%;background:#0f141c;border:1px solid #243141;border-radius:10px;color:var(--text);padding:10px 12px}
    textarea{min-height:72px;resize:vertical}
    .wrap{max-width:1150px;margin:0 auto;padding:10px}
    /* ===== HEADER ===== */
    .hdr{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,#0b0f14 0%,rgba(11,15,20,.9) 60%,rgba(11,15,20,.6) 100%);backdrop-filter:saturate(120%) blur(10px);border-bottom:1px solid #203042}
    .hdr-in{display:flex;align-items:center;gap:10px;padding:10px 8px}
    .logo{
      font-weight:900; font-family: Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif;
      letter-spacing:1px; display:flex; gap:2px; font-size:22px; line-height:1;
      text-shadow: 0 1px 0 #000, 0 2px 0 #000, 0 3px 4px rgba(0,0,0,.5);
    }
    .logo span:nth-child(odd){color:#ff2d2d} /* –∫—Ä–∞—Å–Ω–∞—è */
    .logo span:nth-child(even){color:#00d66b} /* –∑–µ–ª—ë–Ω–∞—è */
    @media (prefers-reduced-motion:no-preference){
      .tabs a{animation:tabPulse 3s ease-in-out infinite}
      @keyframes tabPulse{
        0%{box-shadow:0 0 0 rgba(0,255,168,0)}
        50%{box-shadow:0 0 18px rgba(0,255,168,.35)}
        100%{box-shadow:0 0 0 rgba(0,255,168,0)}
      }
    }
    .tabs{display:flex;gap:8px;flex:1;justify-content:center}
    .tabs a{
      display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;background:#141c27;
      border:1px solid #213044; font-weight:800; letter-spacing:.2px; text-transform:uppercase;
    }
    .tabs a.active{outline:2px solid var(--tabGlow); background:#0f1520}
    .right{display:flex;align-items:center;gap:8px;margin-left:auto}
    .bell{
      position:relative; display:inline-flex; align-items:center; justify-content:center;
      width:46px;height:46px;border-radius:14px;background:#141c27;border:1px solid #213044;
      font-size:24px; line-height:1;
    }
    .bell .badge{
      position:absolute; right:-6px; top:-6px; background:#ff3b3b; color:#fff; min-width:22px; height:22px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-size:12px; padding:0 6px; border:2px solid #0b0f14;
    }
    .avatarBtn{
      width:46px; height:46px; border-radius:14px; background:#141c27 center/cover no-repeat; border:1px solid #213044;
    }
    .onlinePill{
      margin-left:6px; padding:8px 10px; border-radius:999px; background:#13202c; border:1px solid #213044; color:#9ed8ff; font-weight:700;
    }

    /* ===== MAIN LAYOUT ===== */
    .grid{display:grid; grid-template-columns:1fr; gap:10px; padding:10px}
    .panel{background:var(--card); border:1px solid #203042; border-radius:14px; overflow:hidden}
    .panel-h{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #203042; background:#0f1520}
    .panel-h h3{margin:0;font-size:15px;letter-spacing:.3px;color:#bfe2ff}
    .panel-b{padding:10px}

    /* ===== CHAT ===== */
    .chatTabs{display:flex; gap:6px; margin-bottom:8px}
    .chatTabs button{border-radius:12px}
    .chatTabs .on{outline:2px solid #00ffa8}
    .feed{display:flex; flex-direction:column; gap:8px; height:58vh; overflow:auto; padding-right:2px; scroll-behavior:smooth}
    @media (min-width:720px){ .feed{height:68vh} }
    .msg{display:grid; grid-template-columns:42px 1fr; gap:8px; background:#0f141c; border:1px solid #223142; border-radius:12px; padding:8px}
    .msg .ava{width:42px;height:42px;border-radius:10px;background:#0b1017 center/cover no-repeat;border:1px solid #223142}
    .msg .meta{display:flex; gap:6px; align-items:center; color:#8fb1c9; font-size:13px}
    .msg .txt{white-space:pre-wrap; word-wrap:break-word}
    .msg img{width:100%; height:auto; border-radius:10px; display:block; object-fit:contain; max-height:70vh}
    .msg .actions{display:flex; gap:8px; margin-top:6px}
    .msg .actions button{padding:6px 8px; border-radius:8px; font-size:12px}
    .composer{display:flex; gap:8px; align-items:flex-start; margin-top:8px}
    .composer textarea{flex:1}
    .composer .send{font-size:15px}
    .hidden{display:none !important}
    .small-btn{padding:6px 10px; font-size:12px}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#13202c; border:1px solid #213044; font-size:12px}
    .admin-badge{margin-left:6px; padding:2px 6px; border-radius:6px; background:#2a1632; color:#e8b3ff; font-size:11px; border:1px solid #3a1d45}

    /* ===== PROFILE / MODALS ===== */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:14px; z-index:60}
    .modal.show{display:flex}
    .modal .back{position:absolute; inset:0; background:rgba(0,0,0,.6); backdrop-filter: blur(4px)}
    .modal .card{position:relative; z-index:1; width:min(720px,96vw); max-height:92vh; overflow:auto; border-radius:16px; border:1px solid #203042; background:#0f1520}
    .modal .card .hd{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #203042}
    .modal .card .bd{padding:12px}
    .profile-avatar{width:112px;height:112px;border-radius:12px;object-fit:cover;border:1px solid #213044}
    .notifList > div{padding:8px; border-bottom:1px solid #1c2836}

    /* ===== MAP ===== */
    #map{width:100%; height:60vh; border-radius:12px}
    .mapTop{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
    .mapTop input{flex:1; min-width:200px}

    /* Mobile tweaks */
    @media (max-width:480px){
      .hdr-in{gap:6px}
      .tabs{gap:6px}
      .tabs a{padding:8px 10px; font-size:12px}
      .bell{width:50px;height:50px;font-size:26px}
      .avatarBtn{width:50px;height:50px}
      .onlinePill{padding:7px 10px}
      .feed{height:66vh}
    }
  </style>
</head>
<body>
  <header class="hdr">
    <div class="wrap hdr-in">
      <div class="logo" id="brand">
        <span>–ü</span><span>–†</span><span>–ê</span><span>–ì</span><span>–ê</span>
        <span style="width:6px"></span>
        <span>–§</span><span>–£</span><span>–®</span><span>–ö</span><span>–ò</span>
      </div>

      <nav class="tabs" id="navTabs">
        <a href="#chat" id="tabChat" class="active">üí¨ –ß–∞—Ç</a>
        <a href="#rent" id="tabRent">üè† –ß–∞—Ç –û—Ä–µ–Ω–¥–∞</a>
        <a href="#map" id="tabMap">üó∫Ô∏è –ö–∞—Ä—Ç–∞ –¥–æ–ø–æ–º–æ–≥–∏</a>
      </nav>

      <div class="right">
        <button id="friendsBtn" class="pill">üë• –î—Ä—É–∑—ñ</button>
        <button id="adsBtn" class="pill">üì£ –†–µ–∫–ª–∞–º–∞</button>
        <div id="notifBell" class="bell" title="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è">üîî <div id="notifCount" class="badge" style="display:none">0</div></div>
        <button id="profileBtn" class="avatarBtn" title="–ü—Ä–æ—Ñ—ñ–ª—å"></button>
        <div class="onlinePill" title="–û–Ω–ª–∞–π–Ω —É —á–∞—Ç—ñ"><span id="onlineCount">0</span> –æ–Ω–ª–∞–π–Ω</div>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- CHAT PANEL -->
    <section class="panel" id="chatPanel">
      <div class="panel-h"><h3 id="chatTitle">–°—Ç—Ä—ñ—á–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</h3></div>
      <div class="panel-b">
        <div class="chatTabs">
          <button id="switchChat" class="on">üí¨ –ó–∞–≥–∞–ª—å–Ω–∏–π</button>
          <button id="switchRent">üè† –û—Ä–µ–Ω–¥–∞</button>
        </div>

        <!-- –õ–µ–Ω—Ç–∞ -->
        <div id="feed" class="feed" aria-live="polite"></div>

        <!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
        <div class="composer">
          <textarea id="messageInput" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."></textarea>
          <div style="display:flex;flex-direction:column;gap:8px;width:140px;min-width:140px">
            <input id="fileInput" type="file" accept="image/*">
            <button id="sendButton" class="send">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
          </div>
        </div>
      </div>
    </section>

    <!-- MAP PANEL -->
    <section class="panel hidden" id="mapPanel">
      <div class="panel-h"><h3>–ö–∞—Ä—Ç–∞ –¥–æ–ø–æ–º–æ–≥–∏ –≤ –ü—Ä–∞–∑—ñ</h3></div>
      <div class="panel-b">
        <div class="mapTop">
          <input id="mapSearch" placeholder="–ü–æ—à—É–∫ –º—ñ—Å—Ü—å...">
          <button id="centerBtn" class="small-btn">–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏</button>
        </div>
        <div id="map"></div>
      </div>
    </section>
  </main>

  <!-- PROFILE / FRIENDS / NOTIFS / ADMIN -->
  <div class="modal" id="profileModal" aria-hidden="true">
    <div class="back" id="profileClose"></div>
    <div class="card">
      <div class="hd">
        <strong>–ü—Ä–æ—Ñ—ñ–ª—å</strong>
        <div style="display:flex;gap:6px">
          <button id="openInboxBtn" class="small-btn">üíå –û—Å–æ–±–∏—Å—Ç—ñ</button>
          <button id="logoutBtn" class="small-btn">–í–∏–π—Ç–∏</button>
        </div>
      </div>
      <div class="bd" id="profileContent"></div>
    </div>
  </div>

  <div class="modal" id="friendsModal" aria-hidden="true">
    <div class="back" id="friendsClose"></div>
    <div class="card">
      <div class="hd"><strong>–î—Ä—É–∑—ñ</strong></div>
      <div class="bd" id="friendsContent"></div>
    </div>
  </div>

  <div class="modal" id="notifModal" aria-hidden="true">
    <div class="back" id="notifClose"></div>
    <div class="card">
      <div class="hd"><strong>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</strong></div>
      <div class="bd notifList" id="notifList"></div>
    </div>
  </div>

  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="back" id="adminClose"></div>
    <div class="card">
      <div class="hd"><strong>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</strong></div>
      <div class="bd" id="adminContent"></div>
    </div>
  </div>
    <!-- ===== FIREBASE SDK ===== -->
  <script type="module">
    /* ---------- Firebase –∫–æ–Ω—Ñ—ñ–≥ ---------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      updateProfile, sendEmailVerification
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getDatabase, ref as dbRef, push as dbPush, set as dbSet, get as dbGet, onValue, remove as dbRemove, update as dbUpdate
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
      authDomain: "praga-4baee.firebaseapp.com",
      databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
      projectId: "praga-4baee",
      storageBucket: "praga-4baee.firebasestorage.app",
      messagingSenderId: "336023952536",
      appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
      measurementId: "G-BGDJD6R12N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    /* ---------- DOM ---------- */
    const feed = document.getElementById('feed');
    const messageInput = document.getElementById('messageInput');
    const fileInput = document.getElementById('fileInput');
    const sendButton = document.getElementById('sendButton');

    const tabChat = document.getElementById('tabChat');
    const tabRent = document.getElementById('tabRent');
    const tabMap = document.getElementById('tabMap');
    const switchChat = document.getElementById('switchChat');
    const switchRent = document.getElementById('switchRent');

    const chatPanel = document.getElementById('chatPanel');
    const mapPanel = document.getElementById('mapPanel');

    const profileBtn = document.getElementById('profileBtn');
    const friendsBtn = document.getElementById('friendsBtn');
    const adsBtn = document.getElementById('adsBtn');
    const notifBell = document.getElementById('notifBell');
    const notifCount = document.getElementById('notifCount');

    const profileModal = document.getElementById('profileModal');
    const profileClose = document.getElementById('profileClose');
    const profileContent = document.getElementById('profileContent');
    const openInboxBtn = document.getElementById('openInboxBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const friendsModal = document.getElementById('friendsModal');
    const friendsClose = document.getElementById('friendsClose');
    const friendsContent = document.getElementById('friendsContent');

    const notifModal = document.getElementById('notifModal');
    const notifClose = document.getElementById('notifClose');
    const notifList = document.getElementById('notifList');

    const adminModal = document.getElementById('adminModal');
    const adminClose = document.getElementById('adminClose');
    const adminContent = document.getElementById('adminContent');

    const onlineCountEl = document.getElementById('onlineCount');

    const DEFAULT_AVATAR = 'https://i.ibb.co/1sZk2J9/ava.png';

    /* ---------- –†–æ—É—Ç–∏–Ω–≥ –≤–∫–ª–∞–¥–æ–∫ (—Ç–∞–±—ã + –∫–ª–∞–≤–∏—à–∏) ---------- */
    let currentRoom = 'messages'; // 'messages' | 'rentMessages'
    function setTab(hash){
      tabChat.classList.remove('active');
      tabRent.classList.remove('active');
      tabMap.classList.remove('active');
      chatPanel.classList.add('hidden');
      mapPanel.classList.add('hidden');

      if (hash==='#map'){
        tabMap.classList.add('active');
        mapPanel.classList.remove('hidden');
        ensureMap();
      } else if (hash==='#rent'){
        tabRent.classList.add('active');
        chatPanel.classList.remove('hidden');
        currentRoom = 'rentMessages'; loadFeed();
      } else {
        tabChat.classList.add('active');
        chatPanel.classList.remove('hidden');
        currentRoom = 'messages'; loadFeed();
      }
    }
    [tabChat,tabRent,tabMap].forEach(a => a.addEventListener('click', (e)=>{ e.preventDefault(); setTab(e.target.getAttribute('href')); history.replaceState(null,'',e.target.getAttribute('href')); }));

    switchChat.addEventListener('click', ()=>{ switchChat.classList.add('on'); switchRent.classList.remove('on'); currentRoom='messages'; loadFeed(); });
    switchRent.addEventListener('click', ()=>{ switchRent.classList.add('on'); switchChat.classList.remove('on'); currentRoom='rentMessages'; loadFeed(); });

    /* ---------- Resize util for images ---------- */
    function resizeImageFile(file, maxSide=1200, quality=0.82){
      return new Promise((resolve, reject)=>{
        const img = new Image(); const reader = new FileReader();
        reader.onload = e => { img.onload = ()=> {
            const w = img.width, h = img.height;
            let nw=w, nh=h;
            if (w>h && w>maxSide){ nw=maxSide; nh=Math.round(h*(maxSide/w)); }
            if (h>=w && h>maxSide){ nh=maxSide; nw=Math.round(w*(maxSide/h)); }
            const canvas = document.createElement('canvas'); canvas.width=nw; canvas.height=nh;
            const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,nw,nh);
            resolve(canvas.toDataURL('image/jpeg', quality));
          }; img.onerror = reject; img.src = e.target.result; };
        reader.onerror = reject; reader.readAsDataURL(file);
      });
    }

    /* ---------- –£—Ç–∏–ª–∏—Ç—ã DOM ---------- */
    function el(tag, attrs={}, ...kids){ const n=document.createElement(tag); Object.entries(attrs).forEach(([k,v]) => { if(k==='class') n.className=v; else if(k==='html') n.innerHTML=v; else n.setAttribute(k,v); }); kids.forEach(k=> n.append(k)); return n; }
    function money(n){ return new Intl.NumberFormat('uk-UA').format(n); }

    /* ---------- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è / –ø—Ä–æ—Ñ—ñ–ª—å ---------- */
    function showAuthModal(){
      profileModal.classList.add('show'); profileModal.setAttribute('aria-hidden','false');
      profileContent.innerHTML = `
        <h3>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è / –í—Ö—ñ–¥</h3>
        <div style="display:grid;gap:8px;grid-template-columns:1fr 1fr">
          <div class="panel" style="padding:12px">
            <h4 style="margin:0 0 8px 0">–®–≤–∏–¥–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h4>
            <input id="uiNick" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º">
            <input id="uiEmail" placeholder="Email">
            <input id="uiPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω. 6)">
            <button id="uiRegister">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
          </div>
          <div class="panel" style="padding:12px">
            <h4 style="margin:0 0 8px 0">–í—Ö—ñ–¥</h4>
            <input id="liEmail" placeholder="Email">
            <input id="liPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="uiLogin">–£–≤—ñ–π—Ç–∏</button>
          </div>
        </div>
        <div id="uiAuthMsg" style="color:#ff8080;margin-top:8px"></div>
      `;
      attachAuthHandlers();
    }
    function hideProfileModal(){ profileModal.classList.remove('show'); profileModal.setAttribute('aria-hidden','true'); }

    function attachAuthHandlers(){
      document.getElementById('uiRegister').onclick = async ()=>{
        const nick = document.getElementById('uiNick').value.trim();
        const email= document.getElementById('uiEmail').value.trim();
        const pass = document.getElementById('uiPass').value.trim();
        const msgEl= document.getElementById('uiAuthMsg'); msgEl.textContent='';
        if(!nick || !email || !pass){ msgEl.textContent='–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è'; return; }
        if(pass.length<6){ msgEl.textContent='–ü–∞—Ä–æ–ª—å –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤'; return; }
        try{
          const cred = await createUserWithEmailAndPassword(auth,email,pass);
          await updateProfile(cred.user,{ displayName:nick, photoURL:DEFAULT_AVATAR });
          await dbSet(dbRef(db,`users/${cred.user.uid}`), { nick,email,avatar:DEFAULT_AVATAR,createdAt:Date.now(),online:true });
          localStorage.setItem('regTime_'+cred.user.uid, String(Date.now()));
          await sendEmailVerification(cred.user);
          alert('–ó–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ. –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ. –î–æ—Å—Ç—É–ø 6 –≥–æ–¥–∏–Ω –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è.');
          hideProfileModal();
        }catch(e){ msgEl.textContent = e.message || String(e); }
      };
      document.getElementById('uiLogin').onclick = async ()=>{
        const email= document.getElementById('liEmail').value.trim();
        const pass = document.getElementById('liPass').value.trim();
        const msgEl= document.getElementById('uiAuthMsg'); msgEl.textContent='';
        if(!email || !pass){ msgEl.textContent='–ó–∞–ø–æ–≤–Ω—ñ—Ç—å email/–ø–∞—Ä–æ–ª—å'; return; }
        try{ await signInWithEmailAndPassword(auth,email,pass); hideProfileModal(); }
        catch(e){ msgEl.textContent = e.message || String(e); }
      };
    }

    async function canSendMessage(){
      const u = auth.currentUser; if(!u) return false;
      if (u.emailVerified) return true;
      const k = 'regTime_'+u.uid; const local = localStorage.getItem(k);
      const six = 6*60*60*1000;
      if(local && (Date.now()-Number(local)<six)) return true;
      try{
        const snap = await dbGet(dbRef(db,`users/${u.uid}/createdAt`));
        if(snap.exists()){
          const created = Number(snap.val());
          if(!Number.isNaN(created) && Date.now()-created<six){
            localStorage.setItem(k,String(created)); return true;
          }
        }
      }catch(_){}
      return false;
    }

    /* ---------- –ü—Ä–æ—Ñ—ñ–ª—å/–∫–Ω–æ–ø–∫–∏ ---------- */
    profileBtn.addEventListener('click', ()=>{
      if (!auth.currentUser){ showAuthModal(); return; }
      openProfile(auth.currentUser.uid,true);
    });
    logoutBtn.addEventListener('click', async ()=>{ try{ await signOut(auth); hideProfileModal(); }catch(_){} });
    profileClose.addEventListener('click', hideProfileModal);

    async function openProfile(uid, self=false){
      profileModal.classList.add('show'); profileModal.setAttribute('aria-hidden','false');
      profileContent.innerHTML = '<div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>';
      try{
        const snap = await dbGet(dbRef(db,`users/${uid}`));
        const user = snap.exists()?snap.val():{ nick:'–ê–Ω–æ–Ω—ñ–º', avatar:DEFAULT_AVATAR };
        const isSelf = auth.currentUser && auth.currentUser.uid===uid;
        const isAdmin = auth.currentUser && auth.currentUser.email==='urciknikolaj642@gmail.com';

        profileContent.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
            <img class="profile-avatar" id="profImg" src="${user.avatar||DEFAULT_AVATAR}">
            <div>
              <h3 style="margin:0">${user.nick||'–ê–Ω–æ–Ω—ñ–º'} ${isAdmin?'<span class="admin-badge">ADMIN</span>':''}</h3>
              <div style="color:#86a7be">${user.email||''}</div>
              <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
                ${isSelf?`
                  <button id="editAvatarBtn" class="small-btn">–ó–º—ñ–Ω–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä</button>
                  <button id="inboxBtn" class="small-btn">–û—Å–æ–±–∏—Å—Ç—ñ</button>
                `:`
                  <button id="pmBtn" class="small-btn">–ù–∞–ø–∏—Å–∞—Ç–∏</button>
                  <button id="addFriendBtn" class="small-btn">–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>
                `}
              </div>
            </div>
          </div>
          ${isAdmin?`<div style="margin-top:12px"><button id="openAdmin" class="small-btn">–í—ñ–¥–∫—Ä–∏—Ç–∏ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</button></div>`:''}
          <div id="profileMsg" style="margin-top:8px;color:#ff8080"></div>
        `;

        if(isAdmin){ document.getElementById('openAdmin').onclick = ()=> openAdminPanel(); }

        if(isSelf){
          document.getElementById('editAvatarBtn').onclick = ()=> {
            const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
            inp.onchange = async ()=> {
              const f = inp.files[0]; if(!f) return;
              try{
                const dataUrl = await resizeImageFile(f, 1000, .85);
                await dbSet(dbRef(db,`users/${uid}/avatar`), dataUrl);
                await updateProfile(auth.currentUser, { photoURL: dataUrl });
                document.getElementById('profImg').src = dataUrl;
                profileBtn.style.background = `url(${dataUrl}) center/cover`;
                alert('–ê–≤–∞—Ç–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ');
              }catch(e){ alert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–≤–∞—Ç–∞—Ä–∞'); }
            };
            inp.click();
          };
          document.getElementById('inboxBtn').onclick = ()=> openInbox();
        }else{
          document.getElementById('pmBtn').onclick = ()=> { profileModal.classList.remove('show'); startPrivateChat(uid); };
          document.getElementById('addFriendBtn').onclick = async ()=>{
            if(!auth.currentUser){ showAuthModal(); return; }
            try{
              await dbSet(dbRef(db,`friendRequests/${uid}/${auth.currentUser.uid}`), {
                from:auth.currentUser.uid, ts:Date.now(), nick:auth.currentUser.displayName||auth.currentUser.email
              });
              document.getElementById('profileMsg').textContent='–ó–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ.';
            }catch(e){ document.getElementById('profileMsg').textContent='–ü–æ–º–∏–ª–∫–∞'; }
          };
        }
      }catch(e){ profileContent.innerHTML='<div>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</div>'; }
    }

    /* ---------- –î—Ä—É–∑—ñ / –º–æ–¥–∞–ª ---------- */
    friendsBtn.addEventListener('click', async ()=>{
      if(!auth.currentUser){ showAuthModal(); return; }
      friendsModal.classList.add('show'); friendsModal.setAttribute('aria-hidden','false');
      friendsContent.innerHTML='–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶';
      try{
        const uid = auth.currentUser.uid;
        const req = await dbGet(dbRef(db,`friendRequests/${uid}`));
        const fr  = await dbGet(dbRef(db,`friends/${uid}`));
        const reqs = req.exists()?req.val():{};
        const frs  = fr.exists()?fr.val():{};
        const reqHtml = Object.keys(reqs).length? Object.values(reqs).map(d=>`
          <div class="panel" style="padding:8px;margin-bottom:6px">
            –ó–∞–ø–∏—Ç –≤—ñ–¥ <strong>${d.nick||d.from}</strong>
            <div style="margin-top:6px;display:flex;gap:6px">
              <button class="small-btn" data-acc="${d.from}">–ü—Ä–∏–π–Ω—è—Ç–∏</button>
              <button class="small-btn" data-rej="${d.from}">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
            </div>
          </div>
        `).join('') : '<div>–ù–µ–º–∞—î –∑–∞–ø–∏—Ç—ñ–≤</div>';
        const frHtml = Object.keys(frs).length? Object.keys(frs).map(id=>`
          <div class="panel" style="padding:8px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center">
            <span>üë§ ${id}</span>
            <div style="display:flex;gap:6px">
              <button class="small-btn" data-open="${id}">–ü—Ä–æ—Ñ—ñ–ª—å</button>
              <button class="small-btn" data-pm="${id}">–ù–∞–ø–∏—Å–∞—Ç–∏</button>
            </div>
          </div>
        `).join('') : '<div>–ü–æ–∫–∏ –¥—Ä—É–∑—ñ–≤ –Ω–µ–º–∞—î</div>';
        friendsContent.innerHTML = `
          <h3>–ó–∞–ø–∏—Ç–∏ –≤ –¥—Ä—É–∑—ñ</h3>
          ${reqHtml}
          <h3 style="margin-top:10px">–ú–æ—ó –¥—Ä—É–∑—ñ</h3>
          ${frHtml}
        `;
        friendsContent.querySelectorAll('[data-acc]').forEach(btn=>{
          btn.onclick = async ()=>{
            const from = btn.getAttribute('data-acc');
            await dbSet(dbRef(db,`friends/${uid}/${from}`), { ts:Date.now() });
            await dbSet(dbRef(db,`friends/${from}/${uid}`), { ts:Date.now() });
            await dbRemove(dbRef(db,`friendRequests/${uid}/${from}`));
            btn.closest('.panel').remove();
          };
        });
        friendsContent.querySelectorAll('[data-rej]').forEach(btn=>{
          btn.onclick = async ()=>{ const from=btn.getAttribute('data-rej'); await dbRemove(dbRef(db,`friendRequests/${uid}/${from}`)); btn.closest('.panel').remove(); };
        });
        friendsContent.querySelectorAll('[data-open]').forEach(btn=>{
          btn.onclick = ()=> openProfile(btn.getAttribute('data-open'), false);
        });
        friendsContent.querySelectorAll('[data-pm]').forEach(btn=>{
          btn.onclick = ()=> startPrivateChat(btn.getAttribute('data-pm'));
        });
      }catch(e){ friendsContent.innerHTML='–ü–æ–º–∏–ª–∫–∞'; }
    });
    friendsClose.addEventListener('click', ()=> { friendsModal.classList.remove('show'); friendsModal.setAttribute('aria-hidden','true'); });

    /* ---------- –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è ---------- */
    notifBell.addEventListener('click', async ()=>{
      if(!auth.currentUser){ showAuthModal(); return; }
      notifModal.classList.add('show'); notifModal.setAttribute('aria-hidden','false');
      notifList.innerHTML='–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶';
      try{
        const uid = auth.currentUser.uid;
        // –∑–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—ñ
        const rr = await dbGet(dbRef(db,`friendRequests/${uid}`));
        const reqs = rr.exists()?rr.val():{};
        // –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω—ñ –õ–°
        const mm = await dbGet(dbRef(db,`inboxMeta/${uid}`));
        const meta = mm.exists()?mm.val():{};
        const parts = [];
        if(Object.keys(reqs).length){
          parts.push('<h4>–ó–∞–ø–∏—Ç–∏ –≤ –¥—Ä—É–∑—ñ</h4>');
          Object.keys(reqs).forEach(from=>{
            const d=reqs[from];
            parts.push(`<div>–ó–∞–ø–∏—Ç –≤—ñ–¥ <strong>${d.nick||from}</strong> ‚Ä¢ ${new Date(d.ts).toLocaleString()}</div>`);
          });
        }
        const unread = meta.unread?Number(meta.unread):0;
        let convos = Object.keys(meta).filter(k=>k!=='unread');
        if(convos.length){
          parts.push('<h4 style="margin-top:8px">–û—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</h4>');
          for (const id of convos){
            const last = meta[id].lastTs?new Date(meta[id].lastTs).toLocaleString():'';
            const other = meta[id].otherNick || meta[id].otherUid || id;
            parts.push(`<div>–ù–æ–≤–µ –≤—ñ–¥ <strong>${other}</strong> ‚Ä¢ –æ—Å—Ç–∞–Ω–Ω—î: ${last}</div>`);
          }
        }
        if(!parts.length) parts.push('<div>–ù–µ–º–∞—î —Å–ø–æ–≤—ñ—â–µ–Ω—å</div>');
        notifList.innerHTML = parts.join('');
      }catch(e){ notifList.innerHTML='–ü–æ–º–∏–ª–∫–∞'; }
    });
    notifClose.addEventListener('click', ()=>{ notifModal.classList.remove('show'); notifModal.setAttribute('aria-hidden','true'); });

    async function updateNotifications(){
      if (!auth.currentUser){ notifCount.style.display='none'; return; }
      try{
        const uid=auth.currentUser.uid;
        const reqSnap = await dbGet(dbRef(db,`friendRequests/${uid}`));
        const reqCount = reqSnap.exists()? Object.keys(reqSnap.val()).length : 0;
        const metaSnap= await dbGet(dbRef(db,`inboxMeta/${uid}/unread`));
        const unread = metaSnap.exists()? Number(metaSnap.val()) : 0;
        const total = reqCount + unread;
        if (total>0){ notifCount.style.display='block'; notifCount.textContent=String(total); }
        else notifCount.style.display='none';
      }catch(_){}
    }
    setInterval(updateNotifications, 8000);

    /* ---------- –õ–°: —ñ–º'—è –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫–∞ –≤ –º–µ—Ç–∞–¥–∞–Ω–∏—Ö ---------- */
    function convoIdFor(a,b){ return a<b ? `${a}_${b}` : `${b}_${a}`; }

    async function startPrivateChat(otherUid){
      if(!auth.currentUser){ showAuthModal(); return; }
      const uid = auth.currentUser.uid;
      const text = prompt('–ù–∞–ø–∏—à—ñ—Ç—å –æ—Å–æ–±–∏—Å—Ç–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:'); if(!text) return;
      const convoId = convoIdFor(uid, otherUid);
      const fromNick = auth.currentUser.displayName || auth.currentUser.email;
      const pm = { from:uid, to:otherUid, text, ts:Date.now(), fromNick };
      await dbPush(dbRef(db,`privateMessages/${convoId}`), pm);
      // –∑–∞–ø–∏—à–µ–º–æ –º–µ—Ç—É –¥–ª—è –æ–±–æ—Ö, –∑ —ñ–º–µ–Ω–µ–º —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞
      const otherSnap = await dbGet(dbRef(db,`users/${otherUid}/nick`));
      const otherNick = otherSnap.exists()?otherSnap.val():otherUid;
      await dbSet(dbRef(db,`inboxMeta/${otherUid}/unread`), (await (async ()=>{ const s = await dbGet(dbRef(db,`inboxMeta/${otherUid}/unread`)); return s.exists()?Number(s.val()):0; })()) + 1);
      await dbUpdate(dbRef(db,`inboxMeta/${otherUid}/${convoId}`), { lastTs:Date.now(), lastFrom:uid, otherUid:uid, otherNick:fromNick });
      await dbUpdate(dbRef(db,`inboxMeta/${uid}/${convoId}`), { lastTs:Date.now(), lastFrom:uid, otherUid:otherUid, otherNick:otherNick });
      updateNotifications();
      alert('–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ');
    }

    async function openInbox(){
      if(!auth.currentUser){ showAuthModal(); return; }
      profileModal.classList.add('show'); profileModal.setAttribute('aria-hidden','false');
      profileContent.innerHTML = '<h3>–û—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</h3><div id="inboxList">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
      const inboxList = document.getElementById('inboxList');
      try{
        const uid = auth.currentUser.uid;
        const snap = await dbGet(dbRef(db,`inboxMeta/${uid}`));
        const data = snap.exists()?snap.val():{};
        const rows=[];
        for (const k in data){
          if (k==='unread') continue;
          const item = data[k];
          const name = item.otherNick || item.otherUid || k;
          rows.push(`
            <div class="panel" style="padding:8px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center">
              <div>üíå ${name} ‚Äî <span style="color:#8fb1c9">–æ—Å—Ç–∞–Ω–Ω—î: ${new Date(item.lastTs).toLocaleString()}</span></div>
              <button class="small-btn" data-open="${k}">–í—ñ–¥–∫—Ä–∏—Ç–∏</button>
            </div>
          `);
        }
        inboxList.innerHTML = rows.length? rows.join('') : '–ü—É—Å—Ç–æ';
        inboxList.querySelectorAll('[data-open]').forEach(btn=>{
          btn.onclick = ()=> { window.open(location.pathname+'?convo='+btn.getAttribute('data-open'),'_blank'); };
        });
      }catch(e){ inboxList.innerHTML='–ü–æ–º–∏–ª–∫–∞'; }
    }

    /* ---------- –ü—Ä–∏—Å—É—Ç–Ω—ñ—Å—Ç—å / online*10 ---------- */
    function updateOnlineCount(){
      onValue(dbRef(db,'presence'), (snap)=>{
        const val = snap.val() || {};
        const real = Object.keys(val).length;
        const shown = real * 10;
        onlineCountEl.textContent = shown;
      });
    }

    /* ---------- Auth state ---------- */
    onAuthStateChanged(auth, (user)=>{
      if (user){
        profileBtn.style.background = `url(${user.photoURL || DEFAULT_AVATAR}) center/cover`;
        try{ dbSet(dbRef(db,`presence/${user.uid}`), { ts:Date.now(), nick: user.displayName||user.email }); }catch(_){}
      }else{
        profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`;
      }
      updateNotifications();
      updateOnlineCount();
    });
     /* ---------- –†–µ–Ω–¥–µ—Ä –ª–µ–Ω—Ç—ã + –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã ---------- */
    let feedUnsub = null;
    function clearFeedSub(){ if (typeof feedUnsub==='function'){ feedUnsub(); feedUnsub=null; } }

    function renderMessage(id,m){
      const wrap = el('div',{class:'msg'});
      const ava  = el('div',{class:'ava'}); ava.style.backgroundImage=`url('${m.avatar||DEFAULT_AVATAR}')`;
      const body = el('div');
      const meta = el('div',{class:'meta'}, el('strong',{}, m.nick||'–ê–Ω–æ–Ω—ñ–º'), el('span',{}, '‚Ä¢ '+new Date(m.ts).toLocaleString()));
      const txt  = el('div',{class:'txt'}, m.text||'');
      body.append(meta);
      if (m.image){
        const im = el('img',{src:m.image,alt:'photo'});
        body.append(im);
      }
      if (m.text) body.append(txt);

      // –ö–Ω–æ–ø–∫–∏ —Ä–µ–∞–∫—Ü—ñ–π
      const acts = el('div',{class:'actions'});
      [
        {k:'like', lbl:'üëç –õ–∞–π–∫'},
        {k:'warn', lbl:'‚ö†Ô∏è –û–±–µ—Ä–µ–∂–Ω–æ —à–∞—Ö—Ä–∞–π'},
        {k:'dislike', lbl:'üëé –î–∏–∑–ª–∞–π–∫'},
        {k:'spam', lbl:'üö´ –°–ø–∞–º'},
        {k:'reply', lbl:'‚Ü©Ô∏è –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏'},
        {k:'profile', lbl:'üë§ –ü—Ä–æ—Ñ—ñ–ª—å'}
      ].forEach(a=>{
        const b = el('button',{}, a.lbl);
        b.onclick = async ()=>{
          if (!auth.currentUser) { showAuthModal(); return; }
          if (a.k==='reply'){
            const r = prompt('–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:'); if (!r) return;
            await dbPush(dbRef(db,currentRoom), {
              uid: auth.currentUser.uid,
              nick: auth.currentUser.displayName || auth.currentUser.email,
              avatar: auth.currentUser.photoURL || DEFAULT_AVATAR,
              text: `‚Ü™Ô∏è ${m.nick||'–ê–Ω–æ–Ω—ñ–º'}: ${r}`,
              ts: Date.now(),
              recipientUid: m.uid || null
            });
          } else if (a.k==='profile'){
            if (m.uid) openProfile(m.uid,false);
          } else {
            if (!id){ alert('–ù–µ–º–∞—î id –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è'); return; }
            await dbSet(dbRef(db, `messageReactions/${id}/${auth.currentUser.uid}`), { act:a.k, ts:Date.now() });
            alert('–ó—Ä–æ–±–ª–µ–Ω–æ: '+a.lbl);
          }
        };
        acts.append(b);
      });

      wrap.append(ava, body, acts);
      return wrap;
    }

    function loadFeed(){
      clearFeedSub();
      feed.innerHTML = '<div class="panel" style="padding:10px">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>';
      const roomRef = dbRef(db, currentRoom);
      const handler = (snap)=>{
        const data = snap.val()||{};
        const keys = Object.keys(data).sort((a,b)=> data[a].ts - data[b].ts).slice(-400);
        feed.innerHTML='';
        keys.forEach(k=> feed.append( renderMessage(k, data[k]) ));
        feed.scrollTop = feed.scrollHeight;
      };
      onValue(roomRef, handler);
      feedUnsub = ()=>{ /* firebase v10 onValue –ø–æ–≤–µ—Ä—Ç–∞—î unsubscribe —á–µ—Ä–µ–∑ off, –∞–ª–µ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏ –∑–∞–ª–∏—à–∏–º–æ no-op */ };
    }

    /* ---------- –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è ---------- */
    sendButton.addEventListener('click', async ()=>{
      if (!auth.currentUser){ showAuthModal(); return; }
      const ok = await canSendMessage(); if (!ok){ alert('–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å email –∞–±–æ –∑–∞—á–µ–∫–∞–π—Ç–µ 6 –≥–æ–¥–∏–Ω –ø—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó.'); return; }

      const text = messageInput.value.trim();
      const file = fileInput.files[0];
      if (!text && !file) return;

      let imageData = null;
      if (file){
        try{ imageData = await resizeImageFile(file, 1200, 0.85); }
        catch(e){ alert('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Ñ–æ—Ç–æ'); return; }
      }

      const msg = {
        uid: auth.currentUser.uid,
        nick: auth.currentUser.displayName || auth.currentUser.email || '–ê–Ω–æ–Ω—ñ–º',
        avatar: auth.currentUser.photoURL || DEFAULT_AVATAR,
        text: text || null,
        image: imageData || null,
        ts: Date.now(),
        recipientUid: null
      };

      try{
        await dbPush(dbRef(db, currentRoom), msg);
        messageInput.value=''; fileInput.value='';
      }catch(e){ alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è'); }
    });
    messageInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendButton.click(); } });

    /* ---------- –†–µ–∫–ª–∞–º–∞ (–∫–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—É—î email) ---------- */
    adsBtn.addEventListener('click', ()=>{
      alert('–ö—É–ø—ñ–≤–ª—è —Ä–µ–∫–ª–∞–º–∏: urciknikolaj642@gmail.com');
    });

    /* ---------- Admin tools ---------- */
    const ADMIN_EMAIL = 'urciknikolaj642@gmail.com';
    async function openAdminPanel(){
      if(!auth.currentUser || auth.currentUser.email!==ADMIN_EMAIL){ alert('–î–æ—Å—Ç—É–ø –ª–∏—à–µ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞'); return; }
      adminModal.classList.add('show'); adminModal.setAttribute('aria-hidden','false');
      adminContent.innerHTML = `
        <div class="admin-panel" style="display:grid;gap:8px">
          <div class="panel" style="padding:10px;display:grid;gap:8px">
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label>–ë–æ—Ç–∏:</label>
              <button id="toggleBots" class="small-btn">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏</button>
              <button id="viewBotLog" class="small-btn">–õ–æ–≥ –±–æ—Ç—ñ–≤</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label>–ü–æ—à—É–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å:</label>
              <input id="adminQuery" placeholder="–∫–ª—é—á–æ–≤–µ —Å–ª–æ–≤–æ" style="max-width:220px">
              <button id="searchMsgs" class="small-btn">–ü–æ—à—É–∫</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label>–ë–∞–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (UID):</label>
              <input id="banUid" placeholder="UID" style="max-width:220px">
              <button id="banBtn" class="small-btn">–ó–∞–±–∞–Ω–∏—Ç–∏</button>
              <button id="unbanBtn" class="small-btn">–†–æ–∑–±–∞–Ω–∏—Ç–∏</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label>–¢–µ—Ö. —Ä–µ–∂–∏–º:</label>
              <button id="toggleMaintenance" class="small-btn">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label>–ï–∫—Å–ø–æ—Ä—Ç:</label>
              <button id="exportMsgs" class="small-btn">–ï–∫—Å–ø–æ—Ä—Ç JSON</button>
            </div>
            <div id="adminResults" style="margin-top:6px;max-height:40vh;overflow:auto"></div>
          </div>
        </div>
      `;
      // handlers
      const dbRef2=(...a)=>dbRef(...a), dbGet2=(...a)=>dbGet(...a), dbSet2=(...a)=>dbSet(...a), dbRemove2=(...a)=>dbRemove(...a), dbPush2=(...a)=>dbPush(...a), dbUpdate2=(...a)=>dbUpdate(...a);
      document.getElementById('toggleBots').onclick = async ()=>{
        const ref = dbRef2(db,'settings/botsEnabled'); const s=await dbGet2(ref); const cur=s.exists()?Boolean(s.val()):false; await dbSet2(ref,!cur); alert('–ë–æ—Ç–∏: '+(!cur?'–£–≤—ñ–º–∫–Ω–µ–Ω–æ':'–í–∏–º–∫–Ω–µ–Ω–æ'));
      };
      document.getElementById('viewBotLog').onclick = async ()=>{
        const snap = await dbGet2(dbRef2(db,'botPosts')); const out=document.getElementById('adminResults'); out.innerHTML='';
        if (snap && snap.exists()){
          const data=snap.val(); Object.keys(data).reverse().slice(0,200).forEach(k=>{
            const m=data[k]; const d=document.createElement('div'); d.style.padding='6px'; d.style.borderBottom='1px solid #1c2836';
            d.textContent=`${m.nick||m.uid} ‚Ä¢ ${new Date(m.ts).toLocaleString()} ‚Ä¢ ${m.text||''}`; out.appendChild(d);
          });
        } else out.innerHTML='–õ–æ–≥—É –Ω–µ–º–∞—î';
      };
      document.getElementById('searchMsgs').onclick = async ()=>{
        const q=document.getElementById('adminQuery').value.trim().toLowerCase(); const out=document.getElementById('adminResults'); out.innerHTML='';
        if(!q) return out.innerHTML='–í–≤–µ–¥—ñ—Ç—å –∑–∞–ø–∏—Ç';
        const s=await dbGet2(dbRef2(db,'messages')); if(!s || !s.exists()) return out.innerHTML='–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –Ω–µ–º–∞—î';
        const all=s.val(); Object.keys(all).forEach(k=>{
          const m=all[k]; if ((m.text||'').toLowerCase().includes(q) || (m.nick||'').toLowerCase().includes(q)){
            const d=document.createElement('div'); d.style.padding='6px'; d.style.borderBottom='1px solid #1c2836';
            d.innerHTML = `<strong>${m.nick||m.uid}</strong> ‚Ä¢ ${new Date(m.ts).toLocaleString()}<div>${m.text||''}</div><div style="margin-top:6px"><button data-del="${k}" class="small-btn">–í–∏–¥–∞–ª–∏—Ç–∏</button></div>`;
            out.appendChild(d);
            d.querySelector('[data-del]').onclick = async (e)=>{ const id=e.target.getAttribute('data-del'); if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')) return; await dbRemove2(dbRef2(db,`messages/${id}`)); d.remove(); };
          }
        });
      };
      document.getElementById('banBtn').onclick = async ()=>{ const uid=document.getElementById('banUid').value.trim(); if(!uid) return alert('UID?'); await dbSet2(dbRef2(db,`users/${uid}/banned`),true); alert('–ó–∞–±–∞–Ω–µ–Ω–æ '+uid); };
      document.getElementById('unbanBtn').onclick= async ()=>{ const uid=document.getElementById('banUid').value.trim(); if(!uid) return alert('UID?'); await dbSet2(dbRef2(db,`users/${uid}/banned`),false); alert('–†–æ–∑–±–∞–Ω–µ–Ω–æ '+uid); };
      document.getElementById('toggleMaintenance').onclick = async ()=>{ const ref=dbRef2(db,'settings/maintenance'); const s=await dbGet2(ref); const cur=s.exists()?Boolean(s.val()):false; await dbSet2(ref,!cur); alert('–¢–µ—Ö. —Ä–µ–∂–∏–º: '+(!cur)); };
      document.getElementById('exportMsgs').onclick = async ()=>{
        const snap = await dbGet2(dbRef2(db,'messages')); if(!snap || !snap.exists()) return alert('–ù–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å');
        const data=snap.val(); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download='messages_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      };
    }
    adminClose.addEventListener('click', ()=>{ adminModal.classList.remove('show'); adminModal.setAttribute('aria-hidden','true'); });
    // –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –∞–¥–º—ñ–Ω–∫–∏ –ø—Ä–∞–≤–æ—é –∫–Ω–æ–ø–∫–æ—é –ø–æ –∞–≤–∞—Ç–∞—Ä—É
    profileBtn.addEventListener('contextmenu', (e)=>{ e.preventDefault(); openAdminPanel(); });

    /* ---------- –ë–û–¢–ò ---------- */
    const BOT_UIDS = ['bot_1_pf','bot_2_pf','bot_3_pf'];
    const BOT_USERS = [
      {
        uid: 'bot_1_pf',
        nick:'Oleh S.',
        avatar:'https://i.ibb.co/LH4wBMS/IMG-d8e6076e17f19db7fe3add0754738a01-V.jpg',
        ads:[
          { text:`O2 –°–Ü–ú –ö–ê–†–¢–ê\n–ë–µ–∑ –ªi–ºi—Ç —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç\n–ë–µ–∑ –ªi–ºi—Ç –¥–∑–≤—ñ–Ω–∫–∏\n–ü—Ä–∞—Ü—é—î –≤ –Ñ–≤—Ä–æ–ø—ñ\n–ü–ª–∞—Ç–∞ 699 –∫—Ä–æ–Ω/–º—ñ—Å. –¶—ñ–Ω–∞ 299–∫c. –¢–µ–ª: 607914467. Viber/WhatsApp/Telegram.`, image:null },
          { text:`–î–æ–±—Ä–æ–≥–æ –¥–Ω—è! –ü—Ä–æ–¥–∞—é —Å–≤—ñ–π —É–ª—é–±–ª–µ–Ω–∏–π iPhone 11 Pro Max —Ä–∞–∑–æ–º —ñ–∑ 26 —á–æ—Ö–ª–∞–º–∏ ‚Äî —á–æ—Ö–ª–∏ –≤—ñ–¥–¥–∞—é –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ.`, image:'https://i.ibb.co/dwcXPqDr/IMG-1954f6b56869b9817a131ae33f3a37b6-V.jpg' },
          { text:null, image:'https://i.ibb.co/G3kDcrYZ/IMG-fa590121e46c5b030c5ddc94d4e8bea9-V.jpg' }
        ]
      },
      {
        uid:'bot_2_pf',
        nick:'Anna M.',
        avatar:'https://i.ibb.co/QFWDvGZ8/IMG-6748e7141906901b131b8fd5130a5c01-V.jpg',
        ads:[
          { text:`–ó–∞–ø—Ä–æ—à—É—é –º–æ–¥–µ–ª–µ–π –Ω–∞ –ø–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω–∏–π –º–∞–∫—ñ—è–∂ –≤—ñ–¥ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ–≥–æ –º–∞–π—Å—Ç—Ä–∞ –ø—ñ–¥ –º–æ—ó–º –∫–æ–Ω—Ç—Ä–æ–ª–µ–º ‚ú®\n\n‚Ä¢ –ì—É–±–∏ (–¥–æ–∑–≤—ñ–ª –Ω–∞ –≤—ñ–¥–µ–æ —Ç–∞ —Ñ–æ—Ç–æ, –±–µ–∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ü–ú)\nüî∏ –¶—ñ–Ω–∞ ‚Äî (–ª–∏—à–µ –∑–∞ –º–∞—Ç–µ—Ä—ñ–∞–ª)\nüìç–ü—Ä–∞–≥–∞ ‚Ä¢ 28.07 14:00\n–î–ª—è –¥–µ—Ç–∞–ª—ñ ‚Äî –≤ –æ—Å–æ–±–∏—Å—Ç—ñ ü´∂üèª`, image:'https://i.ibb.co/QFWDvGZ8/IMG-6748e7141906901b131b8fd5130a5c01-V.jpg' },
          { text:`–§–æ—Ç–æ –ø—Ä–∏–∫–ª–∞–¥ ‚Äî –¥–µ—Ç–∞–ª—ñ –≤ –ø—Ä–∏–≤–∞—Ç—ñ.`, image:'https://i.ibb.co/j97RhTny/IMG-593d75b053ea1a28cdfb9fc52f93afad-V.jpg' },
          { text:null, image:'https://i.ibb.co/Z11WVrVC/IMG-b83692bb79a1468af74c81620750e8c0-V.jpg' }
        ]
      },
      {
        uid:'bot_3_pf',
        nick:'Marek H.',
        avatar:'https://i.ibb.co/rfNV6ddC/IMG-0cd648a74f86227fe46db2d01c099be0-V.jpg',
        ads:[
          { text:`–ù—É–∂–µ–Ω –≤–æ–¥–∏—Ç–µ–ª—å –¥–ª—è –ø–æ–º–æ—â–∏ –≤ –ø–µ—Ä–µ–µ–∑–¥–µ, —Å–æ —Å–≤–æ–∏–º –∞–≤—Ç–æ, –ø–∏—à–∏—Ç–µ: WhatsApp +48 793 463 757 ‚Ä¢ Telegram @carlx_xxx`, image:null },
          { text:null, image:'https://i.ibb.co/MzdTMPR/IMG-8231d8142ffcbba7c682ca598683e3f2-V.jpg' },
          { text:null, image:'https://i.ibb.co/rfNV6ddC/IMG-0cd648a74f86227fe46db2d01c099be0-V.jpg' }
        ]
      }
    ];
    // –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å 2 / 3 / 4 —Ö–≤
    const SCHEDULE = [
      { botIdx:0, wait:2*60*1000 },
      { botIdx:1, wait:3*60*1000 },
      { botIdx:2, wait:4*60*1000 }
    ];
    let botsController={ enabled:false, running:false, seqPos:0, loopId:null };

    onValue(dbRef(db,'settings/botsEnabled'), (snap)=>{
      const val = snap && snap.exists()?Boolean(snap.val()):false;
      botsController.enabled=val; if (val && !botsController.running) startBots(); if (!val && botsController.running) stopBots();
    });

    async function startBots(){
      if (botsController.running) return;
      botsController.running=true; botsController.seqPos=0;
      (async function loop(){
        if (!botsController.enabled){ botsController.running=false; return; }
        const s = SCHEDULE[botsController.seqPos % SCHEDULE.length];
        const bot = BOT_USERS[s.botIdx];
        const adIndex = Math.floor(Date.now() / (60*1000)) % bot.ads.length;
        const ad = bot.ads[adIndex];
        try{
          await dbPush(dbRef(db,'messages'), {
            uid:bot.uid, nick:bot.nick, avatar:bot.avatar, text:ad.text||null, image:ad.image||null, ts:Date.now()
          });
          await dbPush(dbRef(db,'botPosts'), { uid:bot.uid, nick:bot.nick, text:ad.text||'', ts:Date.now() });
        }catch(_){}
        botsController.seqPos++; botsController.loopId = setTimeout(loop, s.wait);
      })();
    }
    function stopBots(){ if (botsController.loopId) clearTimeout(botsController.loopId); botsController.running=false; botsController.loopId=null; }

    /* ---------- –ö–∞—Ä—Ç–∞ Google –∑ 15 —Ç–æ—á–∫–∞–º–∏ ---------- */
    const MAP_POINTS = [
      { title:'Nemocnice Motol',         pos:{lat:50.058, lng:14.360}, img:'https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp' },
      { title:'Vinohrady Hospital',      pos:{lat:50.079, lng:14.470}, img:'https://i.ibb.co/0gWD5wW/images-5.jpg' },
      { title:'Pr√°vn√≠ pomoc',            pos:{lat:50.083, lng:14.412}, img:'https://i.ibb.co/0gWD5wW/images-5.jpg' },
      { title:'Ukrajinsk√© potraviny 1',  pos:{lat:50.084, lng:14.417}, img:'https://i.ibb.co/R49shL6k/images-6.jpg' },
      { title:'Ukrajinsk√© potraviny 2',  pos:{lat:50.089, lng:14.453}, img:'https://i.ibb.co/R49shL6k/images-6.jpg' },
      { title:'Centrum pr√°ce',           pos:{lat:50.075, lng:14.420}, img:'https://i.ibb.co/4W6hLwF/help.jpg' },
      { title:'–ë–ª–∞–≥–æ–¥—ñ–π–Ω–∏–π —Ñ–æ–Ω–¥ 1',      pos:{lat:50.070, lng:14.430}, img:'https://i.ibb.co/4W6hLwF/help.jpg' },
      { title:'–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω—ñ —Ä–µ—á—ñ',        pos:{lat:50.100, lng:14.440}, img:'https://i.ibb.co/4W6hLwF/help.jpg' },
      { title:'Hostel —Ç–∏–º—á–∞—Å–æ–≤–æ',        pos:{lat:50.082, lng:14.380}, img:'https://i.ibb.co/4W6hLwF/help.jpg' },
      { title:'–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó üá∫üá¶',        pos:{lat:50.088, lng:14.500}, img:'https://i.ibb.co/4W6hLwF/help.jpg' },
      { title:'–î–∏—Ç—è—á–∏–π —Ü–µ–Ω—Ç—Ä',           pos:{lat:50.092, lng:14.410}, img:'https://i.ibb.co/4W6hLwF/help.jpg' },
      { title:'–ö—É—Ä—Å–∏ —á–µ—Å—å–∫–æ—ó',           pos:{lat:50.067, lng:14.445}, img:'https://i.ibb.co/4W6hLwF/help.jpg' },
      { title:'–¶–ù–ê–ü –º—ñ–≥—Ä–∞—Ü—ñ—ó',           pos:{lat:50.060, lng:14.470}, img:'https://i.ibb.co/4W6hLwF/help.jpg' },
      { title:'–ü—É–Ω–∫—Ç–∏ —Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è',       pos:{lat:50.098, lng:14.420}, img:'https://i.ibb.co/4W6hLwF/help.jpg' },
      { title:'–í–æ–ª–æ–Ω—Ç–µ—Ä–∏ —Ü–µ–Ω—Ç—Ä',         pos:{lat:50.076, lng:14.460}, img:'https://i.ibb.co/4W6hLwF/help.jpg' }
    ];
    let map, markers=[];
    function ensureMap(){
      if (typeof google==='undefined' || !document.getElementById('map')) return;
      if (map) return;
      const center={lat:50.0755,lng:14.4378};
      map = new google.maps.Map(document.getElementById('map'), { center, zoom:13, gestureHandling:'greedy' });
      MAP_POINTS.forEach(p=>{
        const marker = new google.maps.Marker({ position:p.pos, map, title:p.title });
        const content = `<div style="width:220px"><strong>${p.title}</strong><div><img src="${p.img}" style="width:100%;border-radius:6px;margin-top:6px"></div></div>`;
        const inf = new google.maps.InfoWindow({ content });
        marker.addListener('click', ()=> inf.open(map, marker));
        markers.push(marker);
      });
      document.getElementById('centerBtn').onclick = ()=> map.panTo(center);
      document.getElementById('mapSearch').oninput = (e)=>{
        const q = e.target.value.trim().toLowerCase();
        markers.forEach(mk => mk.setVisible(!q || (mk.getTitle()||'').toLowerCase().includes(q)));
      };
    }
    /* ---------- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ---------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      // –∞–≤–∞—Ç–∞—Ä –¥–µ—Ñ–æ–ª—Ç
      profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`;
      // —Ö–µ—à-–≤–∫–ª–∞–¥–∫–∞
      setTab(location.hash || '#chat');
      loadFeed(); // —Å—Ç–∞—Ä—Ç–æ–≤–∞

      // –∑–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª–æ–∫
      [friendsClose, notifClose].forEach(el=> el.addEventListener('click', (e)=> e.target.closest('.modal').classList.remove('show')));

      // –ø—Ä–∏—Ö–æ–≤—É—î–º–æ –ø–æ–ª–µ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è –ù–Ü ‚Äî —Ç—É—Ç –º–∏ –∑–∞–ª–∏—à–∏–ª–∏ —Ç—ñ–ª—å–∫–∏ —á–∞—Ç-–∫–æ–º–ø–æ–∑–µ—Ä. (–∑–∞ —Ç–≤–æ—ó–º –ø—Ä–æ—Ö–∞–Ω–Ω—è–º –±–∞–Ω–Ω–µ—Ä/–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —É–¥–∞–ª–µ–Ω—ã)
    });

    // –ö–Ω–æ–ø–∫–∏ Friends/Notifications —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫–∏ (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã—à–µ)

  </script>

  <!-- ===== GOOGLE MAPS (—Ç–≤–æ–π –∫–ª—é—á) =====
       –¢—ã –ø—Ä–∏—Å–ª–∞–ª: "https://maps.googleapis.com/maps/api/js?key=AlzaSyBFrxVhpb6nHJ6rhiL15&callback=initMap"
       –Ø –ø–æ–¥–∫–ª—é—á–∞—é –Ω–∏–∂–µ, –∏ –±–∏–Ω–¥—é callback –Ω–∞ ensureMap()
  -->
  <script>
    // –¥–µ–ª–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π initMap –¥–ª—è callback Google
    function initMap(){ try{ if (typeof ensureMap==='function') ensureMap(); }catch(e){} }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AlzaSyBFrxVhpb6nHJ6rhiL15&callback=initMap"></script>

</body>
</html>
