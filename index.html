<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Praha Fu≈°ky ‚Äî —Å–æ—Ü—á–∞—Ç</title>

  <!-- –®–†–ò–§–¢–ò -->
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- Leaflet (–∫–∞—Ä—Ç–∞ –±–µ–∑ –∫–ª—é—á–∞) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --accent:#22c55e; --accent-2:#10b981; --danger:#ef4444;
      --glass:rgba(255,255,255,.96); --muted:#64748b; --ink:#0b1220;
      --max:1020px; --avatar:44px; --header-h:66px; --chat-scale:1.06;
      --shadow:0 18px 60px rgba(2,6,23,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#071126;color:var(--ink);overflow-x:hidden}
    body{font-family:Poppins,system-ui,-apple-system,"Segoe UI",Arial,sans-serif;
         background:url('https://i.ibb.co/27hgtZfY/Prague.jpg') center/cover fixed}

    /* Header */
    header{position:sticky;top:0;z-index:1000;padding:6px 8px;text-align:center;color:#fff;backdrop-filter:blur(3px)}
    .brandRow{display:flex;align-items:center;justify-content:center;gap:10px;min-height:var(--header-h);position:relative}
    .profile-btn,.bell-btn,.gear-btn,.members-btn{
      position:absolute;top:8px;width:46px;height:46px;border-radius:50%;border:2px solid rgba(255,255,255,.9);
      display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35);color:#fff;background:rgba(0,0,0,.28)
    }
    .profile-btn{left:8px;background-size:cover;background-position:center}
    .gear-btn{right:112px;display:none}
    .members-btn{right:64px;display:none}
    .bell-btn{right:8px}
    .bell-badge{position:absolute;top:-6px;right:-6px;background:#ff3366;color:#fff;border-radius:12px;padding:2px 6px;font-size:12px;font-weight:700;display:none}
    header h1{
      margin:0;font-family:'UnifrakturCook',cursive;font-weight:700;font-size:34px;letter-spacing:1px;text-transform:uppercase;
      background:linear-gradient(90deg,#22c55e,#ef4444);-webkit-background-clip:text;background-clip:text;color:transparent;
      text-shadow:0 2px 0 rgba(0,0,0,.55),0 6px 18px rgba(0,0,0,.6)
    }
    header .sub{margin:4px auto 0;font-size:13px;color:#e8ffee;display:inline-block;padding:6px 10px;border-radius:10px;background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.08)}

    .topBar{position:sticky;top:var(--header-h);z-index:900}
    .neon-wrap{max-width:var(--max);margin:6px auto 0;padding:6px 8px}
    .neon-tabs{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .tab-button{border:none;font-weight:800;letter-spacing:.2px;cursor:pointer;border-radius:12px;padding:8px 14px;color:#021f13;background:#cfffdf;box-shadow:0 0 12px rgba(34,197,94,.35),inset 0 -3px 0 rgba(0,0,0,.06);transition:.15s transform,.15s box-shadow}
    .tab-button:hover{transform:translateY(-1px);box-shadow:0 0 16px rgba(34,197,94,.8),inset 0 -3px 0 rgba(0,0,0,.06)}
    .tab-button.active{outline:2px solid #39ff91;box-shadow:0 0 18px rgba(57,255,145,.9),inset 0 -3px 0 rgba(0,0,0,.06)}
    .online-neon{margin:6px auto 8px;max-width:var(--max);text-align:center;color:#baffd1;font-weight:800;text-shadow:0 0 8px rgba(57,255,145,.9);background:rgba(0,0,0,.35);border:1px solid rgba(57,255,145,.35);border-radius:10px;padding:6px 10px}

    main.container{max-width:var(--max);margin:0 auto;padding:8px}
    .tab-content{display:none}
    .tab-content.active{display:block}

    /* Chat feed */
    .chat-area{height:calc(100vh - 320px);overflow:auto;padding:10px 6px}
    .messages{display:flex;flex-direction:column;gap:12px;padding-bottom:220px;transform:scale(var(--chat-scale));transform-origin:bottom left}
    .message{display:flex;gap:10px;align-items:flex-start;max-width:78%;word-break:break-word}
    .message.self{margin-left:auto;flex-direction:row-reverse}
    .avatar{width:var(--avatar);height:var(--avatar);border-radius:50%;object-fit:cover;flex:0 0 var(--avatar);box-shadow:0 3px 10px rgba(0,0,0,.35);cursor:pointer}
    .message-content{background:var(--glass);padding:10px 12px;border-radius:14px;box-shadow:0 6px 30px rgba(2,6,23,.18);color:var(--ink);position:relative}
    .message.self .message-content{background:#E9FFF0}
    .message-meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .chat-image{max-width:300px;border-radius:8px;margin-top:8px;display:block}
    .message-content .text{font-weight:600;font-size:1rem;white-space:pre-wrap}

    /* Input bar */
    .chat-input{position:fixed;left:0;right:0;bottom:0;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,.96),rgba(255,255,255,.99));border-top:1px solid rgba(0,0,0,.06);z-index:1200;display:flex;gap:8px;align-items:center;max-width:var(--max);margin:0 auto}
    .camera-btn{display:inline-flex;align-items:center;justify-content:center;cursor:pointer;width:48px;height:48px;border-radius:50%;background:#fff;border:1px solid #e6e6e6}
    .camera-btn svg{width:20px;height:20px}
    .chat-input input[type="text"]{flex:1;padding:12px 14px;border-radius:24px;border:1px solid #d0d7de;font-size:16px;outline:none}
    .send-btn{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:20px;font-weight:800;cursor:pointer;box-shadow:0 8px 20px rgba(34,197,94,.18)}

    /* Modals */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);}
    .modal.show{display:flex}
    .modal .panel{background:#fff;border-radius:16px;padding:16px;width:92%;max-width:880px;position:relative;box-shadow:var(--shadow)}
    .modal .close{position:absolute;right:10px;top:8px;background:transparent;border:none;font-size:18px;cursor:pointer}
    .modal.full .panel{width:98%;max-width:none;height:92vh;display:flex;flex-direction:column}

    .user-badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 8px;font-size:12px;background:#f1f5f9}
    .pill-title{margin:10px 0 6px;color:#eafff3;font-weight:900;text-shadow:0 0 10px rgba(57,255,145,.9);}

    /* –ó–µ–ª–µ–Ω–∞—è –≥–∞–ª–∫–∞ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ */
    .photo-toast{position:fixed;left:50%;transform:translateX(-50%);bottom:86px;background:#dcfce7;border:1px solid #16a34a;color:#065f46;padding:8px 12px;border-radius:12px;font-weight:800;box-shadow:0 10px 30px rgba(0,0,0,.15);display:none;z-index:1300}

    /* –¢–æ—Å—Ç –¥–ª—è –∑–≤—É–∫–∞ */
    .sound-toast{position:fixed;left:50%;transform:translateX(-50%);bottom:140px;background:#fff;border:1px solid #e2e8f0;color:#0b1220;padding:10px 12px;border-radius:12px;font-weight:700;box-shadow:0 10px 30px rgba(0,0,0,.15);display:none;z-index:1300}

    @media (max-width:640px){
      .chat-area{height:calc(100vh - 360px)}
      .chat-image{max-width:200px}
    }

    .btn-mini{border:none;border-radius:10px;padding:6px 10px;background:#eef2ff;cursor:pointer}
    .notif-item{position:relative}
    .notif-x{position:absolute;right:6px;top:6px;border:none;background:#f1f5f9;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="brandRow">
      <button id="profileBtn" class="profile-btn" title="–ü—Ä–æ—Ñ—ñ–ª—å" aria-label="–ü—Ä–æ—Ñ—ñ–ª—å"></button>
      <h1>PRAHA FU≈†KY</h1>
      <button id="gearBtn" class="gear-btn" title="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è" aria-label="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è">‚öôÔ∏è</button>
      <button id="membersBtn" class="members-btn" title="–£—á–∞—Å–Ω–∏–∫–∏" aria-label="–£—á–∞—Å–Ω–∏–∫–∏">üë•</button>
      <button id="bellBtn" class="bell-btn" title="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è" aria-label="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è">üîî<span id="bellBadge" class="bell-badge">0</span></button>
    </div>
    <div class="sub">–î–æ–ø–æ–º–∞–≥–∞—î–º–æ —É–∫—Ä–∞—ó–Ω—Ü—è–º —É –ü—Ä–∞–∑—ñ ‚Äî —Å–ø—ñ–ª—å–Ω–æ—Ç–∞, —á–∞—Ç, –æ—Ä–µ–Ω–¥–∞, –¥–æ–ø–æ–º–æ–≥–∞.</div>
  </header>

  <!-- TOP TABS -->
  <div class="topBar">
    <div class="neon-wrap">
      <nav class="neon-tabs" role="tablist" aria-label="–í–∫–ª–∞–¥–∫–∏">
        <button class="tab-button active" data-target="chatTab">üí¨ –ß–∞—Ç</button>
        <button class="tab-button" data-target="rentTab">üè† –û—Ä–µ–Ω–¥–∞</button>
        <button class="tab-button" data-target="mapTab">üó∫Ô∏è –ö–∞—Ä—Ç–∞</button>
        <button class="tab-button" data-target="friendsTab">üë• –î—Ä—É–∑—ñ</button>
        <button class="tab-button" data-target="dmTab">‚úâÔ∏è –û—Å–æ–±–∏—Å—Ç—ñ</button>
      </nav>
      <div class="online-neon" id="onlineNeon">–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): 0</div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="container" role="main">
    <!-- –ê–¥–º—ñ–Ω—Å—å–∫–∞ —Å–º—É–∂–∫–∞ -->
    <div id="adminBar" style="display:none; margin-bottom:8px; background:rgba(255,255,255,.86); border:1px solid #e5e7eb; border-radius:12px; padding:8px; box-shadow:var(--shadow)">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <div style="font-weight:900">–ê–¥–º—ñ–Ω ‚Ä¢ –ë–æ—Ç–∏</div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <button id="startAll" class="tab-button" style="padding:6px 10px">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—Å—ñ—Ö</button>
          <button id="stopAll" class="tab-button"  style="padding:6px 10px;background:#ffe1e1">‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏ –≤—Å—ñ—Ö</button>
          <button id="postOnceAll" class="tab-button" style="padding:6px 10px;background:#fff3cd">‚ö°Ô∏è –ü–æ—Å—Ç —Ä–∞–∑–æ–º</button>
          <button id="editBots" class="tab-button" style="padding:6px 10px;background:#e0e7ff">üõ† –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –±–æ—Ç–∞</button>
        </div>
      </div>
      <div class="pill-title">–ü—Ä–æ—Ñ—ñ–ª—ñ ¬´–∞–∫—Ç–∏–≤—ñ—Å—Ç—ñ–≤¬ª:</div>
      <div id="botsRow" style="display:flex;gap:8px;flex-wrap:wrap"></div>
    </div>

    <!-- –ß–ê–¢–ò -->
    <section id="chatTab" class="tab-content active" role="region" aria-label="–ß–∞—Ç">
      <div class="chat-area" id="chatArea" aria-live="polite">
        <div id="messages" class="messages" role="log"></div>
      </div>
    </section>
    <section id="rentTab" class="tab-content" role="region" aria-label="–ß–∞—Ç –û—Ä–µ–Ω–¥–∞">
      <div class="chat-area" id="rentArea">
        <div id="rentMessages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- –ö–ê–†–¢–ê -->
    <section id="mapTab" class="tab-content" role="region" aria-label="–ö–∞—Ä—Ç–∞">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
        <input id="mapSearch" placeholder="–ü–æ—à—É–∫ (–≤–æ–ª–æ–Ω—Ç–µ—Ä–∏, –∞–ø—Ç–µ–∫–∞‚Ä¶)" style="flex:1;min-width:220px;padding:10px;border-radius:10px;border:1px solid #ddd" />
        <button class="tab-button" data-f="all">–£—Å–µ</button>
        <button class="tab-button" data-f="volunteer">–í–æ–ª–æ–Ω—Ç–µ—Ä–∏</button>
        <button class="tab-button" data-f="aid">–î–æ–ø–æ–º–æ–≥–∞</button>
        <button class="tab-button" data-f="pharmacy">–ê–ø—Ç–µ–∫–∏</button>
        <button id="centerBtn" class="tab-button" style="padding:6px 10px">–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏</button>
      </div>
      <div id="map" style="width:100%;height:60vh;border-radius:10px;background:#eaf7ff"></div>
    </section>

    <!-- –î–†–£–ó–Ü / –ó–ê–Ø–í–ö–ò -->
    <section id="friendsTab" class="tab-content" role="region" aria-label="–î—Ä—É–∑—ñ">
      <h2 class="pill-title" style="margin-top:0">–ó–∞—è–≤–∫–∏ —Ç–∞ –¥—Ä—É–∑—ñ</h2>
      <div class="friends-wrap" style="display:grid;grid-template-columns:1fr;gap:12px">
        <div>
          <h3 style="color:#fff;margin:6px 0;text-shadow:0 0 10px rgba(57,255,145,.9)">–ó–∞—è–≤–∫–∏</h3>
          <div id="friendRequests"></div>
        </div>
        <div>
          <h3 style="color:#fff;margin:6px 0;text-shadow:0 0 10px rgba(57,255,145,.9)">–ú–æ—ó –¥—Ä—É–∑—ñ (<span id="friendsOnlineCount">0</span> –æ–Ω–ª–∞–π–Ω)</h3>
          <div id="friendsList"></div>
        </div>
      </div>
    </section>

    <!-- –õ–° -->
    <section id="dmTab" class="tab-content" role="region" aria-label="–û—Å–æ–±–∏—Å—Ç—ñ">
      <h2 class="pill-title" style="margin:6px 0">–ú–æ—ó –¥—ñ–∞–ª–æ–≥–∏</h2>
      <div id="dmList" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px"></div>
    </section>
  </main>

  <!-- –§–∏–∫—Å. –ø–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
  <input id="fileInput" type="file" accept="image/*" style="display:none" />
  <div class="chat-input" role="region" aria-label="–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">
    <label for="fileInput" class="camera-btn" id="cameraLabel" aria-hidden="true">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M4 7H6L7 5H17L18 7H20C21.1 7 22 7.9 22 9V19C22 20.1 21.1 21 20 21H4C2.9 21 2 20.1 2 19V9C2 7.9 2.9 7 4 7Z" fill="#111"/><circle cx="12" cy="13" r="3.5" fill="#fff"/></svg>
    </label>
    <input id="messageInput" type="text" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." aria-label="–¢–µ–∫—Å—Ç" />
    <button id="sendButton" class="send-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
  </div>

  <!-- –ü–ª–∞—à–∫–∏ -->
  <div id="photoToast" class="photo-toast">‚úîÔ∏è –§–æ—Ç–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ. –ù–∞–ø–∏—à—ñ—Ç—å –°–ú–° ‚Äî —Ñ–æ—Ç–æ –∑'—è–≤–∏—Ç—å—Å—è –ø—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏.</div>
  <div id="soundToast" class="sound-toast">üîä –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± —É–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫ <button id="soundEnableBtn" class="tab-button" style="margin-left:8px;padding:4px 8px">–£–≤—ñ–º–∫–Ω—É—Ç–∏</button></div>

  <!-- –ú–û–î–ê–õ–ö–ò: auth/profile/settings/bell/admin/bots/pay -->
  <div id="authModal" class="modal" aria-hidden="true" style="z-index:1500">‚Ä¶</div>
  <div id="profileModal" class="modal" aria-hidden="true" style="z-index:1600">‚Ä¶</div>
  <div id="gearModal" class="modal" aria-hidden="true" style="z-index:1500">‚Ä¶</div>
  <div id="bellModal" class="modal" aria-hidden="true" style="z-index:1400">‚Ä¶</div>
  <div id="adminUsersModal" class="modal full" aria-hidden="true" style="z-index:1700">‚Ä¶</div>
  <div id="botsEditModal" class="modal" aria-hidden="true" style="z-index:1750">‚Ä¶</div>
  <div id="payModal" class="modal" aria-hidden="true" style="z-index:1800">‚Ä¶</div>

  <!-- –∑–≤—É–∫–æ–≤–∞ —Å–∏—Å—Ç–µ–º–∞ -->
  <script>window.__soundEnabled=false;</script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
  /* =========================
     –ß–ê–°–¢–ò–ù–ê 1/3 ‚Äî Firebase init, UI, –∑–≤—É–∫, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
     ========================= */
  const firebaseConfig = {
    apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
    authDomain: "praga-4baee.firebaseapp.com",
    databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
    projectId: "praga-4baee",
    storageBucket: "praga-4baee.firebasestorage.app",
    messagingSenderId: "336023952536",
    appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
    measurementId: "G-BGDJD6R12N"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.database();

  const DEFAULT_AVATAR = "https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg";
  const ADMIN_EMAIL    = "urciknikolaj642@gmail.com"; // –æ–±—ä—è–≤–ª—è–µ–º –û–î–ò–ù —Ä–∞–∑

  const tabButtons   = document.querySelectorAll('.tab-button');
  const tabContents  = document.querySelectorAll('.tab-content');
  const profileBtn   = document.getElementById('profileBtn');
  const gearBtn      = document.getElementById('gearBtn');
  const membersBtn   = document.getElementById('membersBtn');
  const adminBar     = document.getElementById('adminBar');
  const onlineNeon   = document.getElementById('onlineNeon');

  function setActiveTab(id){
    tabButtons.forEach(b=>b.classList.toggle('active', b.dataset.target===id));
    tabContents.forEach(c=> c.classList.toggle('active', c.id===id));
    adminBar.style.display = (id==='chatTab' && window.__isAdmin) ? 'block' : 'none';
    if (id==='mapTab'){
      if(!window.__mapInitOnce){ initLeaflet(); window.__mapInitOnce=true; }
      setTimeout(()=>{ try{ map.invalidateSize(false); }catch{} }, 60);
    }
  }
  tabButtons.forEach(btn=> btn.addEventListener('click', ()=> setActiveTab(btn.dataset.target)));

  /* ==== –ó–≤—É–∫ ==== */
  let audioCtx=null;
  function ensureAudio(){ if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } }
  function beep(freq=880,dur=120,type='sine',vol=0.15){
    if(!window.__soundEnabled) return;
    ensureAudio();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(audioCtx.destination); o.start();
    setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.08); o.stop(audioCtx.currentTime+0.1); }, dur);
  }
  const SND={ notify(){beep(1200,140,'triangle',0.18)}, sent(){beep(760,90,'sine',0.14)}, error(){beep(320,220,'square',0.18)} };

  const soundToast=document.getElementById('soundToast');
  const soundEnableBtn=document.getElementById('soundEnableBtn');
  function askEnableSoundOnce(){ if(!window.__soundEnabled) soundToast.style.display='block'; }
  soundEnableBtn.addEventListener('click',()=>{ window.__soundEnabled=true; ensureAudio(); SND.notify(); soundToast.style.display='none'; document.getElementById('optSound').checked=true; });
  document.body.addEventListener('click',()=>{ if(!window.__soundEnabled){ askEnableSoundOnce(); } },{ once:true });
  document.getElementById('enableSoundBtn')?.addEventListener('click',()=>{ window.__soundEnabled=true; ensureAudio(); SND.notify(); document.getElementById('optSound').checked=true; });

  const gearModal=document.getElementById('gearModal'); const gearClose=document.getElementById('gearClose');
  const optSound=document.getElementById('optSound'); const optAnon=document.getElementById('optAnon');
  gearBtn.addEventListener('click',()=> gearModal.classList.add('show'));
  gearClose.addEventListener('click',()=> gearModal.classList.remove('show'));
  optSound.onchange=()=>{ window.__soundEnabled=!!optSound.checked; if(optSound.checked) SND.notify(); };
  optAnon.onchange = ()=> localStorage.setItem('allow_guest', optAnon.checked?'1':'0');

  // ‚Ä¶ –º–æ–¥–∞–ª–∫–∏ –ª–æ–≥–∏–Ω–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–∫–∞–∫ –≤ —Ç–≤–æ—ë–º –∫–æ–¥–µ; –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ —Ä–∞–∑–º–µ—Ç–∫–µ)

  let _smsConfirmer=null; function initRecaptcha(){ try{ _smsConfirmer = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size:'invisible' }); }catch{} }
  initRecaptcha();

  window.__isAdmin=false;
  auth.onAuthStateChanged(async (u)=>{
    const setBtnAvatar = (url)=>{ document.getElementById('profileBtn').style.background=`url(${url||DEFAULT_AVATAR}) center/cover`; };
    setBtnAvatar((u&&u.photoURL)||DEFAULT_AVATAR);

    if(u){
      await db.ref('presence/'+u.uid).set({ ts:Date.now(), nick: u.displayName||u.email });
      db.ref('users/'+u.uid+'/avatar').on('value', s=>{ const v=s.val(); if(v){ setBtnAvatar(v); } });
    }
    if(u){
      try{
        const roleSnap=await db.ref('users/'+u.uid+'/role').get();
        const role=roleSnap.exists()?roleSnap.val():null;
        window.__isAdmin = (u.email===ADMIN_EMAIL)||role==='admin';
      }catch{ window.__isAdmin=(u.email===ADMIN_EMAIL); }
    } else { window.__isAdmin=false; }

    document.getElementById('gearBtn').style.display='flex';
    document.getElementById('membersBtn').style.display=window.__isAdmin?'flex':'none';
    adminBar.style.display=(window.__isAdmin && document.getElementById('chatTab').classList.contains('active'))?'block':'none';
    document.getElementById('profileBtn').onclick=()=>{ if(!auth.currentUser) showAuth(); else openProfile(auth.currentUser.uid,true); };
    updateOnlineCount(); initHelp();
    if(u){ subscribeNotifications(u.uid); bindFriendsRealtime(); renderDMInbox(); }
    else { document.getElementById('notifList').innerHTML=''; friendsList.innerHTML=''; friendRequestsEl.innerHTML=''; dmList.innerHTML=''; }

    // –í–ê–ñ–ù–û: –∑–∞–ø—É—Å–∫ –∞–¥–º–∏–Ω—Å–∫–∏—Ö –≤–æ—Ç—á–µ—Ä–æ–≤ –∏ –ø–∞–Ω–µ–ª–∏ –±–æ—Ç–æ–≤ –ø–æ—Å–ª–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–∞–≤
    if(window.__isAdmin){ watchPaymentsInFeed(); renderBotsToolbar(); }
  });
  </script>
   const profileModal=document.getElementById('profileModal'); const profileClose=document.getElementById('profileClose'); const profileContent=document.getElementById('profileContent'); profileClose?.addEventListener('click',()=> profileModal.classList.remove('show'));
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

  function showAuth(){ const m=document.getElementById('authModal'); if(m){ m.classList.add('show'); document.getElementById('regError').textContent=''; document.getElementById('loginError').textContent=''; } }
  function hideAuth(){ document.getElementById('authModal')?.classList.remove('show'); }

  async function openProfile(uid,isSelf=false){
    profileModal.classList.add('show'); profileContent.innerHTML='<p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</p>';
    try{
      const s=await db.ref('users/'+uid).get(); const user=s.exists()?s.val():{nick:'–ê–Ω–æ–Ω—ñ–º',avatar:DEFAULT_AVATAR}; const email=user.email||''; const self=auth.currentUser&&auth.currentUser.uid===uid;
      const flags=(await db.ref('settings/userFlags/'+uid).get()).val()||{}; const planKey=flags.premium||'none';
      const PLAN={none:{label:'‚Äî',bg:'#f1f5f9',col:'#111'}, trial:{label:'TRIAL',bg:'#c084fc',col:'#fff'}, premium:{label:'–ü–†–ï–ú–Ü–£–ú',bg:'#16a34a',col:'#fff'}, premiumPlus:{label:'–ü–†–ï–ú–Ü–£–ú+',bg:'#0ea5e9',col:'#fff'}}[planKey];
      const about=user.about||''; const contacts=user.contacts||''; const avatar=user.avatar||DEFAULT_AVATAR;
      profileContent.innerHTML=`
        <div style="display:flex;gap:12px;align-items:center">
          <img src="${avatar}" style="width:84px;height:84px;border-radius:12px;object-fit:cover">
          <div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <h3 style="margin:0;color:#0b1220;text-shadow:0 0 12px rgba(57,255,145,.7)">${escapeHtml(user.nick||'–ê–Ω–æ–Ω—ñ–º')}</h3>
              <span class="user-badge" style="background:${PLAN.bg};color:${PLAN.col};font-weight:900">${PLAN.label}</span>
              ${uid===auth.currentUser?.uid?'<span class="user-badge">–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</span>':''}
            </div>
            <div style="color:${email?'#333':'#666'}">${escapeHtml(email)}</div>
          </div>
        </div>
        <div style="margin-top:12px;display:grid;grid-template-columns:1fr;gap:8px">
          <div><b>–ü—Ä–æ —Å–µ–±–µ:</b><br>${about?escapeHtml(about):'<i>–Ω–µ –≤–∫–∞–∑–∞–Ω–æ</i>'}</div>
          <div><b>–ö–æ–Ω—Ç–∞–∫—Ç–∏:</b><br>${contacts?escapeHtml(contacts):'<i>–Ω–µ –≤–∫–∞–∑–∞–Ω–æ</i>'}</div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          ${self?`
            <label class="tab-button" style="cursor:pointer"><input type="file" id="avatarFile" accept="image/*" style="display:none">–ó–º—ñ–Ω–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä</label>
            <button id="editAbout" class="tab-button">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
            <button id="signOutBtn" class="tab-button" style="background:#ffe1e1">–í–∏–π—Ç–∏</button>
          `:`
            <button id="pmBtn" class="tab-button">–ù–∞–ø–∏—Å–∞—Ç–∏ –õ–°</button>
            <button id="addFriendBtn" class="tab-button">–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>
          `}
        </div>
        <div id="profileMsg" style="margin-top:8px;color:#16a34a;font-weight:700"></div>`;

      if(self){
        document.getElementById('avatarFile')?.addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; const url=await fileToDataURL(f,900,.9); await db.ref('users/'+uid+'/avatar').set(url); await auth.currentUser.updateProfile({ photoURL:url }); document.getElementById('profileBtn').style.background=`url(${url}) center/cover`; profileContent.querySelector('img').src=url; SND.notify(); });
        document.getElementById('signOutBtn').onclick=async()=>{ try{ await db.ref('presence/'+auth.currentUser.uid).remove(); }catch{} await auth.signOut(); profileModal.classList.remove('show'); };
        document.getElementById('editAbout').onclick=async()=>{ const a=prompt('–ü—Ä–æ —Å–µ–±–µ', about)||''; const c=prompt('–ö–æ–Ω—Ç–∞–∫—Ç–∏', contacts)||''; await db.ref('users/'+uid).update({ about:a, contacts:c }); openProfile(uid,true); };
      }else{
        document.getElementById('pmBtn').onclick=()=> openPrivateChat(uid);
        document.getElementById('addFriendBtn').onclick=()=> sendFriendRequest(uid);
      }
    }catch{ profileContent.innerHTML='<p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</p>'; }
  }

  function fileToDataURL(file,maxW=900,quality=.85){ return new Promise((resolve,reject)=>{ const img=new Image(); const r=new FileReader(); r.onload=e=>{ img.onload=()=>{ const sc=Math.min(1, maxW/img.width); const w=(img.width*sc)|0, h=(img.height*sc)|0; const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); resolve(c.toDataURL('image/jpeg',quality)); }; img.onerror=reject; img.src=e.target.result; }; r.onerror=reject; r.readAsDataURL(file); }); }

  function updateOnlineCount(){ db.ref('presence').on('value', snap=>{ const val=snap.val()||{}; const real=Object.keys(val).length; onlineNeon.textContent=`–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): ${real*10}`; }); window.addEventListener('beforeunload', async ()=>{ try{ if(auth.currentUser) await db.ref('presence/'+auth.currentUser.uid).remove(); }catch{} }); }

  // –î–æ–ø–æ–º–æ–≥–∞ —Ç–∞–± (–∫–∞–∫ —É —Ç–µ–±—è)
  function initHelp(){ /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–∏–∑—É–∞–ª–∫–∏ ... */ }

  // –ö–∞—Ä—Ç–∞ (–∫–∞–∫ —É —Ç–µ–±—è)
  let map, markers=[], poi=[];
  function initLeaflet(){ /* ... */ }
  function clearMarkers(){ markers.forEach(m=>m.remove()); markers=[]; }
  function renderPoi(list){ /* ... */ }
  function searchPoi(q){ /* ... */ }

  // ===== –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è =====
  const bellBtn=document.getElementById('bellBtn'); const bellBadge=document.getElementById('bellBadge'); const bellModal=document.getElementById('bellModal'); const bellClose=document.getElementById('bellClose'); const notifList=document.getElementById('notifList');
  function renderNotifItem(id,v){
    const row=document.createElement('div');
    row.className='notif-item';
    row.style.cssText='padding:8px;border-bottom:1px solid #eee;display:flex;gap:8px;align-items:center';
    row.innerHTML=`<button class="notif-x" title="–ü—Ä–∏–±—Ä–∞—Ç–∏">‚úñ</button>
                   <div style="flex:1"><div style="font-weight:700">${(v.type||'info').toUpperCase()}</div><div style="font-size:13px">${v.text||''}</div></div>`;
    row.querySelector('.notif-x').onclick=()=> row.remove();
    notifList.prepend(row);
  }
  function subscribeNotifications(uid){
    if(!uid) return;
    db.ref('notifications/'+uid).on('child_added',snap=>{
      renderNotifItem(snap.key,snap.val()||{});
      bellBadge.style.display='inline-block';
      const n=Number(bellBadge.textContent||'0')+1; bellBadge.textContent=String(n);
      SND.notify();
    });
  }
  bellBtn.addEventListener('click',()=>{ bellModal.classList.add('show'); bellBadge.textContent='0'; bellBadge.style.display='none'; });
  bellClose.addEventListener('click',()=> bellModal.classList.remove('show'));
  document.getElementById('notifClear').onclick=()=>{ notifList.innerHTML=''; };

  // ===== –î—Ä—É–∑—ñ / –õ–° =====
  const friendsList=document.getElementById('friendsList'); const friendRequestsEl=document.getElementById('friendRequests'); const friendsOnlineCountEl=document.getElementById('friendsOnlineCount'); const dmList=document.getElementById('dmList');
  function convoIdFor(a,b){ return a<b? a+'_'+b : b+'_'+a; }

  async function sendFriendRequest(toUid){
    if(!auth.currentUser){ showAuth(); return; }
    const from=auth.currentUser.uid; if(from===toUid) return;
    const btn=document.getElementById('addFriendBtn'); if(btn){ btn.disabled=true; btn.textContent='‚è≥'; }
    try{
      await db.ref('friendRequests/'+toUid+'/'+from).set({ from, ts:Date.now() });
      await db.ref('friends/'+from+'/'+toUid).set({ status:'requested', ts:Date.now(), fromUid:from });
      await db.ref('notifications/'+toUid).push({ ts:Date.now(), type:'friend_req', text:`–ó–∞–ø–∏—Ç —É –¥—Ä—É–∑—ñ –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`, from });
      pushNotif('OK','–ó–∞—è–≤–∫–∞ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞');
      if(btn){ btn.textContent='‚úÖ –ó–∞—è–≤–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞'; }
    }catch(e){
      pushNotif('–ü–æ–º–∏–ª–∫–∞','–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞—è–≤–∫—É');
      if(btn){ btn.disabled=false; btn.textContent='–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ'; }
    }
  }

  async function ensureDmAcl(cid, uid, otherUid){
    const a = db.ref(`privateMessages/${cid}/_acl/${uid}`);
    const b = db.ref(`privateMessages/${cid}/_acl/${otherUid}`);
    const [as, bs] = await Promise.all([a.get(), b.get()]);
    if(!as.exists()) await a.set(true);
    if(!bs.exists()) await b.set(true);
  }

  async function openPrivateChat(otherUid){
    if(!auth.currentUser){ showAuth(); return; }
    const uid=auth.currentUser.uid; const cid=convoIdFor(uid,otherUid);

    // ACL –ø–µ—Ä–µ–¥ –ø–æ–¥–ø–∏—Å–∫–æ–π
    await ensureDmAcl(cid, uid, otherUid);

    const panel=document.createElement('div'); panel.className='modal show'; panel.style.zIndex=1650;
    panel.innerHTML=`<div class="panel"><button class="close">‚úñ</button><h3>–î—ñ–∞–ª–æ–≥</h3>
    <div id="dmThread" style="max-height:55vh;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px;margin-bottom:8px;background:#fafafa"></div>
    <div style="display:flex;gap:6px"><input id="dmText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd"><button id="dmSend" class="tab-button">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button></div></div>`;
    document.body.appendChild(panel);
    panel.querySelector('.close').onclick=()=>panel.remove();
    const thread=panel.querySelector('#dmThread');

    db.ref('inboxMeta/'+uid+'/'+otherUid).set({ with:otherUid, ts:Date.now() });
    db.ref('inboxMeta/'+otherUid+'/'+uid).set({ with:uid, ts:Date.now() });

    db.ref('privateMessages/'+cid).limitToLast(200).on('child_added',snap=>{
      if (snap.key === '_acl') return; // —Ñ–∏–ª—å—Ç—Ä —Å–ª—É–∂–µ–±–Ω–æ–≥–æ —É–∑–ª–∞
      const m=snap.val();
      if(!m || !m.ts || !m.text) return;
      const row=document.createElement('div');
      row.style.margin='6px 0'; row.style.textAlign=m.from===uid?'right':'left';
      row.textContent=`${m.text} (${new Date(m.ts).toLocaleTimeString()})`;
      thread.appendChild(row); thread.scrollTop=thread.scrollHeight;
    });

    panel.querySelector('#dmSend').onclick=async()=>{
      const t=panel.querySelector('#dmText').value.trim(); if(!t) return;
      const pm={from:uid,to:otherUid,text:t,ts:Date.now()};
      await ensureDmAcl(cid, uid, otherUid); // –≥–∞—Ä–∞–Ω—Ç–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é
      await db.ref('privateMessages/'+cid).push(pm);
      await db.ref('notifications/'+otherUid).push({ ts:Date.now(), type:'dm', text:`–ù–æ–≤–µ –õ–° –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`, from:uid, convoId:cid });
      await db.ref('inboxMeta/'+uid+'/'+otherUid).update({ last:t, ts:pm.ts });
      await db.ref('inboxMeta/'+otherUid+'/'+uid).update({ last:t, ts:pm.ts });
      panel.querySelector('#dmText').value=''; SND.sent();
    };
  }

  async function deriveDisplayName(uid){
    const us = await db.ref('users/'+uid).get();
    if (us.exists()){
      const u = us.val();
      if (u.nick)  return u.nick;
      if (u.email) return (u.email.split('@')[0] || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á');
    }
    return (uid || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á').slice(0,8) + '‚Ä¶';
  }

  function bindFriendsRealtime(){
    const u=auth.currentUser; if(!u){ return; }
    db.ref('friendRequests/'+u.uid).off();
    db.ref('friendRequests/'+u.uid).on('value', async snap=>{
      const container = document.getElementById('friendRequests');
      container.innerHTML='';
      if(snap.exists()){
        const reqs=snap.val();
        for(const fromUid of Object.keys(reqs)){
          const uSnap=await db.ref('users/'+fromUid).get(); const ud=uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
          const item=document.createElement('div'); item.style.cssText='display:flex;gap:8px;align-items:center;background:#fff;border-radius:10px;padding:8px;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,.06)';
          item.innerHTML=`<img src="${ud.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
          <div style="flex:1"><div style="font-weight:800;color:#0b1220">${escapeHtml(ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á')}</div><div class="muted" style="font-size:12px;color:#94a3b8">–∑–∞—è–≤–∫–∞ —É –¥—Ä—É–∑—ñ</div></div>
          <div style="display:flex;gap:6px"><button class="tab-button btn-accept">‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏</button><button class="tab-button btn-decline" style="background:#ffe1e1">‚úñ</button></div>`;
          item.querySelector('.btn-accept').onclick=async()=>{
            await db.ref('friends/'+u.uid+'/'+fromUid).set({ status:'accepted', ts:Date.now() });
            await db.ref('friends/'+fromUid+'/'+u.uid).set({ status:'accepted', ts:Date.now() });
            await db.ref('friendRequests/'+u.uid+'/'+fromUid).remove();
            await db.ref('notifications/'+fromUid).push({ ts:Date.now(), type:'friend_ok', text:`${u.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'} –¥–æ–¥–∞–≤(–ª–∞) –≤–∞—Å —É –¥—Ä—É–∑—ñ`, from:u.uid });
            SND.notify();
          };
          item.querySelector('.btn-decline').onclick=async()=>{
            await db.ref('friendRequests/'+u.uid+'/'+fromUid).remove(); await db.ref('friends/'+fromUid+'/'+u.uid).remove();
          };
          container.appendChild(item);
        }
      }else{
        container.innerHTML="<i style='color:#eafff3;text-shadow:0 0 8px rgba(57,255,145,.7)'>–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</i>";
      }
    });

    db.ref('friends/'+u.uid).off();
    db.ref('friends/'+u.uid).on('value', async frSnap=>{
      const container = document.getElementById('friendsList');
      container.innerHTML=''; let onlineCount=0;
      if(frSnap.exists()){
        const fr=frSnap.val();
        for(const fid of Object.keys(fr)){
          const rel=fr[fid]; if(rel.status!=='accepted') continue;
          const [uSnap,pSnap]= await Promise.all([db.ref('users/'+fid).get(), db.ref('presence/'+fid).get()]);
          const ud=uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
          const isOn=pSnap.exists(); if(isOn) onlineCount++;
          const d=document.createElement('div'); d.style.cssText='display:flex;gap:8px;align-items:center;background:#fff;border-radius:10px;padding:8px;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,.06)';
          d.innerHTML=`<img src="${ud.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
            <div style="flex:1"><div style="font-weight:800;color:#0b1220">${escapeHtml(ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á')}</div><div style="font-size:12px;color:${isOn?'#10b981':'#64748b'}">${isOn?'–æ–Ω–ª–∞–π–Ω':'–æ—Ñ–ª–∞–π–Ω'}</div></div>
            <div style="display:flex;gap:6px"><button class="tab-button btn-pm">‚úâÔ∏è</button><button class="tab-button btn-open">üëÄ</button></div>`;
          d.querySelector('.btn-open').onclick=()=>openProfile(fid);
          d.querySelector('.btn-pm').onclick=()=>openPrivateChat(fid);
          container.appendChild(d);
        }
      }
      friendsOnlineCountEl.textContent=String(onlineCount);
    });
  }

  function renderDMInbox(){
    const u=auth.currentUser;
    if(!u){ dmList.innerHTML='<i>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –±–∞—á–∏—Ç–∏ –õ–°</i>'; return; }
    db.ref('inboxMeta/'+u.uid).off();
    dmList.innerHTML='';
    db.ref('inboxMeta/'+u.uid).orderByChild('ts').limitToLast(200).on('child_added', async snap=>{
      const other=snap.key; const meta=snap.val()||{};
      const name=await deriveDisplayName(other);
      const avatar=(await db.ref('users/'+other+'/avatar').get()).val()||DEFAULT_AVATAR;
      const card=document.createElement('div'); card.style.cssText='display:flex;gap:8px;align-items:center;background:#fff;border-radius:10px;padding:8px;box-shadow:0 2px 8px rgba(0,0,0,.06)';
      card.innerHTML=`<img src="${avatar}" style="width:42px;height:42px;border-radius:10px;object-fit:cover">
        <div style="flex:1"><div style="font-weight:800">${escapeHtml(name)}</div><div style="font-size:12px;color:#64748b">${escapeHtml(meta.last||'–ë–µ–∑ —Ç–µ–∫—Å—Ç—É')}</div></div>
        <button class='tab-button'>–í—ñ–¥–∫—Ä–∏—Ç–∏</button>`;
      card.querySelector('button').onclick=()=> openPrivateChat(other);
      dmList.prepend(card);
    });
  }
</script>
     const profileModal=document.getElementById('profileModal'); const profileClose=document.getElementById('profileClose'); const profileContent=document.getElementById('profileContent'); profileClose?.addEventListener('click',()=> profileModal.classList.remove('show'));
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

  function showAuth(){ const m=document.getElementById('authModal'); if(m){ m.classList.add('show'); document.getElementById('regError').textContent=''; document.getElementById('loginError').textContent=''; } }
  function hideAuth(){ document.getElementById('authModal')?.classList.remove('show'); }

  async function openProfile(uid,isSelf=false){
    profileModal.classList.add('show'); profileContent.innerHTML='<p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</p>';
    try{
      const s=await db.ref('users/'+uid).get(); const user=s.exists()?s.val():{nick:'–ê–Ω–æ–Ω—ñ–º',avatar:DEFAULT_AVATAR}; const email=user.email||''; const self=auth.currentUser&&auth.currentUser.uid===uid;
      const flags=(await db.ref('settings/userFlags/'+uid).get()).val()||{}; const planKey=flags.premium||'none';
      const PLAN={none:{label:'‚Äî',bg:'#f1f5f9',col:'#111'}, trial:{label:'TRIAL',bg:'#c084fc',col:'#fff'}, premium:{label:'–ü–†–ï–ú–Ü–£–ú',bg:'#16a34a',col:'#fff'}, premiumPlus:{label:'–ü–†–ï–ú–Ü–£–ú+',bg:'#0ea5e9',col:'#fff'}}[planKey];
      const about=user.about||''; const contacts=user.contacts||''; const avatar=user.avatar||DEFAULT_AVATAR;
      profileContent.innerHTML=`
        <div style="display:flex;gap:12px;align-items:center">
          <img src="${avatar}" style="width:84px;height:84px;border-radius:12px;object-fit:cover">
          <div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <h3 style="margin:0;color:#0b1220;text-shadow:0 0 12px rgba(57,255,145,.7)">${escapeHtml(user.nick||'–ê–Ω–æ–Ω—ñ–º')}</h3>
              <span class="user-badge" style="background:${PLAN.bg};color:${PLAN.col};font-weight:900">${PLAN.label}</span>
              ${uid===auth.currentUser?.uid?'<span class="user-badge">–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</span>':''}
            </div>
            <div style="color:${email?'#333':'#666'}">${escapeHtml(email)}</div>
          </div>
        </div>
        <div style="margin-top:12px;display:grid;grid-template-columns:1fr;gap:8px">
          <div><b>–ü—Ä–æ —Å–µ–±–µ:</b><br>${about?escapeHtml(about):'<i>–Ω–µ –≤–∫–∞–∑–∞–Ω–æ</i>'}</div>
          <div><b>–ö–æ–Ω—Ç–∞–∫—Ç–∏:</b><br>${contacts?escapeHtml(contacts):'<i>–Ω–µ –≤–∫–∞–∑–∞–Ω–æ</i>'}</div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          ${self?`
            <label class="tab-button" style="cursor:pointer"><input type="file" id="avatarFile" accept="image/*" style="display:none">–ó–º—ñ–Ω–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä</label>
            <button id="editAbout" class="tab-button">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
            <button id="signOutBtn" class="tab-button" style="background:#ffe1e1">–í–∏–π—Ç–∏</button>
          `:`
            <button id="pmBtn" class="tab-button">–ù–∞–ø–∏—Å–∞—Ç–∏ –õ–°</button>
            <button id="addFriendBtn" class="tab-button">–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>
          `}
        </div>
        <div id="profileMsg" style="margin-top:8px;color:#16a34a;font-weight:700"></div>`;

      if(self){
        document.getElementById('avatarFile')?.addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; const url=await fileToDataURL(f,900,.9); await db.ref('users/'+uid+'/avatar').set(url); await auth.currentUser.updateProfile({ photoURL:url }); document.getElementById('profileBtn').style.background=`url(${url}) center/cover`; profileContent.querySelector('img').src=url; SND.notify(); });
        document.getElementById('signOutBtn').onclick=async()=>{ try{ await db.ref('presence/'+auth.currentUser.uid).remove(); }catch{} await auth.signOut(); profileModal.classList.remove('show'); };
        document.getElementById('editAbout').onclick=async()=>{ const a=prompt('–ü—Ä–æ —Å–µ–±–µ', about)||''; const c=prompt('–ö–æ–Ω—Ç–∞–∫—Ç–∏', contacts)||''; await db.ref('users/'+uid).update({ about:a, contacts:c }); openProfile(uid,true); };
      }else{
        document.getElementById('pmBtn').onclick=()=> openPrivateChat(uid);
        document.getElementById('addFriendBtn').onclick=()=> sendFriendRequest(uid);
      }
    }catch{ profileContent.innerHTML='<p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</p>'; }
  }

  function fileToDataURL(file,maxW=900,quality=.85){ return new Promise((resolve,reject)=>{ const img=new Image(); const r=new FileReader(); r.onload=e=>{ img.onload=()=>{ const sc=Math.min(1, maxW/img.width); const w=(img.width*sc)|0, h=(img.height*sc)|0; const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); resolve(c.toDataURL('image/jpeg',quality)); }; img.onerror=reject; img.src=e.target.result; }; r.onerror=reject; r.readAsDataURL(file); }); }

  function updateOnlineCount(){ db.ref('presence').on('value', snap=>{ const val=snap.val()||{}; const real=Object.keys(val).length; onlineNeon.textContent=`–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): ${real*10}`; }); window.addEventListener('beforeunload', async ()=>{ try{ if(auth.currentUser) await db.ref('presence/'+auth.currentUser.uid).remove(); }catch{} }); }

  // –î–æ–ø–æ–º–æ–≥–∞ —Ç–∞–± (–∫–∞–∫ —É —Ç–µ–±—è)
  function initHelp(){ /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–∏–∑—É–∞–ª–∫–∏ ... */ }

  // –ö–∞—Ä—Ç–∞ (–∫–∞–∫ —É —Ç–µ–±—è)
  let map, markers=[], poi=[];
  function initLeaflet(){ /* ... */ }
  function clearMarkers(){ markers.forEach(m=>m.remove()); markers=[]; }
  function renderPoi(list){ /* ... */ }
  function searchPoi(q){ /* ... */ }

  // ===== –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è =====
  const bellBtn=document.getElementById('bellBtn'); const bellBadge=document.getElementById('bellBadge'); const bellModal=document.getElementById('bellModal'); const bellClose=document.getElementById('bellClose'); const notifList=document.getElementById('notifList');
  function renderNotifItem(id,v){
    const row=document.createElement('div');
    row.className='notif-item';
    row.style.cssText='padding:8px;border-bottom:1px solid #eee;display:flex;gap:8px;align-items:center';
    row.innerHTML=`<button class="notif-x" title="–ü—Ä–∏–±—Ä–∞—Ç–∏">‚úñ</button>
                   <div style="flex:1"><div style="font-weight:700">${(v.type||'info').toUpperCase()}</div><div style="font-size:13px">${v.text||''}</div></div>`;
    row.querySelector('.notif-x').onclick=()=> row.remove();
    notifList.prepend(row);
  }
  function subscribeNotifications(uid){
    if(!uid) return;
    db.ref('notifications/'+uid).on('child_added',snap=>{
      renderNotifItem(snap.key,snap.val()||{});
      bellBadge.style.display='inline-block';
      const n=Number(bellBadge.textContent||'0')+1; bellBadge.textContent=String(n);
      SND.notify();
    });
  }
  bellBtn.addEventListener('click',()=>{ bellModal.classList.add('show'); bellBadge.textContent='0'; bellBadge.style.display='none'; });
  bellClose.addEventListener('click',()=> bellModal.classList.remove('show'));
  document.getElementById('notifClear').onclick=()=>{ notifList.innerHTML=''; };

  // ===== –î—Ä—É–∑—ñ / –õ–° =====
  const friendsList=document.getElementById('friendsList'); const friendRequestsEl=document.getElementById('friendRequests'); const friendsOnlineCountEl=document.getElementById('friendsOnlineCount'); const dmList=document.getElementById('dmList');
  function convoIdFor(a,b){ return a<b? a+'_'+b : b+'_'+a; }

  async function sendFriendRequest(toUid){
    if(!auth.currentUser){ showAuth(); return; }
    const from=auth.currentUser.uid; if(from===toUid) return;
    const btn=document.getElementById('addFriendBtn'); if(btn){ btn.disabled=true; btn.textContent='‚è≥'; }
    try{
      await db.ref('friendRequests/'+toUid+'/'+from).set({ from, ts:Date.now() });
      await db.ref('friends/'+from+'/'+toUid).set({ status:'requested', ts:Date.now(), fromUid:from });
      await db.ref('notifications/'+toUid).push({ ts:Date.now(), type:'friend_req', text:`–ó–∞–ø–∏—Ç —É –¥—Ä—É–∑—ñ –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`, from });
      pushNotif('OK','–ó–∞—è–≤–∫–∞ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞');
      if(btn){ btn.textContent='‚úÖ –ó–∞—è–≤–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞'; }
    }catch(e){
      pushNotif('–ü–æ–º–∏–ª–∫–∞','–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞—è–≤–∫—É');
      if(btn){ btn.disabled=false; btn.textContent='–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ'; }
    }
  }

  async function ensureDmAcl(cid, uid, otherUid){
    const a = db.ref(`privateMessages/${cid}/_acl/${uid}`);
    const b = db.ref(`privateMessages/${cid}/_acl/${otherUid}`);
    const [as, bs] = await Promise.all([a.get(), b.get()]);
    if(!as.exists()) await a.set(true);
    if(!bs.exists()) await b.set(true);
  }

  async function openPrivateChat(otherUid){
    if(!auth.currentUser){ showAuth(); return; }
    const uid=auth.currentUser.uid; const cid=convoIdFor(uid,otherUid);

    // ACL –ø–µ—Ä–µ–¥ –ø–æ–¥–ø–∏—Å–∫–æ–π
    await ensureDmAcl(cid, uid, otherUid);

    const panel=document.createElement('div'); panel.className='modal show'; panel.style.zIndex=1650;
    panel.innerHTML=`<div class="panel"><button class="close">‚úñ</button><h3>–î—ñ–∞–ª–æ–≥</h3>
    <div id="dmThread" style="max-height:55vh;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px;margin-bottom:8px;background:#fafafa"></div>
    <div style="display:flex;gap:6px"><input id="dmText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd"><button id="dmSend" class="tab-button">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button></div></div>`;
    document.body.appendChild(panel);
    panel.querySelector('.close').onclick=()=>panel.remove();
    const thread=panel.querySelector('#dmThread');

    db.ref('inboxMeta/'+uid+'/'+otherUid).set({ with:otherUid, ts:Date.now() });
    db.ref('inboxMeta/'+otherUid+'/'+uid).set({ with:uid, ts:Date.now() });

    db.ref('privateMessages/'+cid).limitToLast(200).on('child_added',snap=>{
      if (snap.key === '_acl') return; // —Ñ–∏–ª—å—Ç—Ä —Å–ª—É–∂–µ–±–Ω–æ–≥–æ —É–∑–ª–∞
      const m=snap.val();
      if(!m || !m.ts || !m.text) return;
      const row=document.createElement('div');
      row.style.margin='6px 0'; row.style.textAlign=m.from===uid?'right':'left';
      row.textContent=`${m.text} (${new Date(m.ts).toLocaleTimeString()})`;
      thread.appendChild(row); thread.scrollTop=thread.scrollHeight;
    });

    panel.querySelector('#dmSend').onclick=async()=>{
      const t=panel.querySelector('#dmText').value.trim(); if(!t) return;
      const pm={from:uid,to:otherUid,text:t,ts:Date.now()};
      await ensureDmAcl(cid, uid, otherUid); // –≥–∞—Ä–∞–Ω—Ç–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é
      await db.ref('privateMessages/'+cid).push(pm);
      await db.ref('notifications/'+otherUid).push({ ts:Date.now(), type:'dm', text:`–ù–æ–≤–µ –õ–° –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`, from:uid, convoId:cid });
      await db.ref('inboxMeta/'+uid+'/'+otherUid).update({ last:t, ts:pm.ts });
      await db.ref('inboxMeta/'+otherUid+'/'+uid).update({ last:t, ts:pm.ts });
      panel.querySelector('#dmText').value=''; SND.sent();
    };
  }

  async function deriveDisplayName(uid){
    const us = await db.ref('users/'+uid).get();
    if (us.exists()){
      const u = us.val();
      if (u.nick)  return u.nick;
      if (u.email) return (u.email.split('@')[0] || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á');
    }
    return (uid || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á').slice(0,8) + '‚Ä¶';
  }

  function bindFriendsRealtime(){
    const u=auth.currentUser; if(!u){ return; }
    db.ref('friendRequests/'+u.uid).off();
    db.ref('friendRequests/'+u.uid).on('value', async snap=>{
      const container = document.getElementById('friendRequests');
      container.innerHTML='';
      if(snap.exists()){
        const reqs=snap.val();
        for(const fromUid of Object.keys(reqs)){
          const uSnap=await db.ref('users/'+fromUid).get(); const ud=uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
          const item=document.createElement('div'); item.style.cssText='display:flex;gap:8px;align-items:center;background:#fff;border-radius:10px;padding:8px;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,.06)';
          item.innerHTML=`<img src="${ud.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
          <div style="flex:1"><div style="font-weight:800;color:#0b1220">${escapeHtml(ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á')}</div><div class="muted" style="font-size:12px;color:#94a3b8">–∑–∞—è–≤–∫–∞ —É –¥—Ä—É–∑—ñ</div></div>
          <div style="display:flex;gap:6px"><button class="tab-button btn-accept">‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏</button><button class="tab-button btn-decline" style="background:#ffe1e1">‚úñ</button></div>`;
          item.querySelector('.btn-accept').onclick=async()=>{
            await db.ref('friends/'+u.uid+'/'+fromUid).set({ status:'accepted', ts:Date.now() });
            await db.ref('friends/'+fromUid+'/'+u.uid).set({ status:'accepted', ts:Date.now() });
            await db.ref('friendRequests/'+u.uid+'/'+fromUid).remove();
            await db.ref('notifications/'+fromUid).push({ ts:Date.now(), type:'friend_ok', text:`${u.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'} –¥–æ–¥–∞–≤(–ª–∞) –≤–∞—Å —É –¥—Ä—É–∑—ñ`, from:u.uid });
            SND.notify();
          };
          item.querySelector('.btn-decline').onclick=async()=>{
            await db.ref('friendRequests/'+u.uid+'/'+fromUid).remove(); await db.ref('friends/'+fromUid+'/'+u.uid).remove();
          };
          container.appendChild(item);
        }
      }else{
        container.innerHTML="<i style='color:#eafff3;text-shadow:0 0 8px rgba(57,255,145,.7)'>–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</i>";
      }
    });

    db.ref('friends/'+u.uid).off();
    db.ref('friends/'+u.uid).on('value', async frSnap=>{
      const container = document.getElementById('friendsList');
      container.innerHTML=''; let onlineCount=0;
      if(frSnap.exists()){
        const fr=frSnap.val();
        for(const fid of Object.keys(fr)){
          const rel=fr[fid]; if(rel.status!=='accepted') continue;
          const [uSnap,pSnap]= await Promise.all([db.ref('users/'+fid).get(), db.ref('presence/'+fid).get()]);
          const ud=uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
          const isOn=pSnap.exists(); if(isOn) onlineCount++;
          const d=document.createElement('div'); d.style.cssText='display:flex;gap:8px;align-items:center;background:#fff;border-radius:10px;padding:8px;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,.06)';
          d.innerHTML=`<img src="${ud.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
            <div style="flex:1"><div style="font-weight:800;color:#0b1220">${escapeHtml(ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á')}</div><div style="font-size:12px;color:${isOn?'#10b981':'#64748b'}">${isOn?'–æ–Ω–ª–∞–π–Ω':'–æ—Ñ–ª–∞–π–Ω'}</div></div>
            <div style="display:flex;gap:6px"><button class="tab-button btn-pm">‚úâÔ∏è</button><button class="tab-button btn-open">üëÄ</button></div>`;
          d.querySelector('.btn-open').onclick=()=>openProfile(fid);
          d.querySelector('.btn-pm').onclick=()=>openPrivateChat(fid);
          container.appendChild(d);
        }
      }
      friendsOnlineCountEl.textContent=String(onlineCount);
    });
  }

  function renderDMInbox(){
    const u=auth.currentUser;
    if(!u){ dmList.innerHTML='<i>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –±–∞—á–∏—Ç–∏ –õ–°</i>'; return; }
    db.ref('inboxMeta/'+u.uid).off();
    dmList.innerHTML='';
    db.ref('inboxMeta/'+u.uid).orderByChild('ts').limitToLast(200).on('child_added', async snap=>{
      const other=snap.key; const meta=snap.val()||{};
      const name=await deriveDisplayName(other);
      const avatar=(await db.ref('users/'+other+'/avatar').get()).val()||DEFAULT_AVATAR;
      const card=document.createElement('div'); card.style.cssText='display:flex;gap:8px;align-items:center;background:#fff;border-radius:10px;padding:8px;box-shadow:0 2px 8px rgba(0,0,0,.06)';
      card.innerHTML=`<img src="${avatar}" style="width:42px;height:42px;border-radius:10px;object-fit:cover">
        <div style="flex:1"><div style="font-weight:800">${escapeHtml(name)}</div><div style="font-size:12px;color:#64748b">${escapeHtml(meta.last||'–ë–µ–∑ —Ç–µ–∫—Å—Ç—É')}</div></div>
        <button class='tab-button'>–í—ñ–¥–∫—Ä–∏—Ç–∏</button>`;
      card.querySelector('button').onclick=()=> openPrivateChat(other);
      dmList.prepend(card);
    });
  }
</script>
