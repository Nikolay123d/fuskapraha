<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Praha Fušky</title>
  <style>
    :root{
      --bg: #0b0d12; /* глубокий темно-синий */
      --card: #11141b;
      --muted: #6c7486;
      --text: #e8edf8;
      --accent: #6aa3ff;
      --accent-2: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% 0%, #0f1320, #06070a 70%), var(--bg);
      color: var(--text);
      display:flex;flex-direction:column;
    }
    /* Верхняя панель */
    header{
      position:sticky;top:0;z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(9,12,18,.65);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .nav{
      display:flex;align-items:center;gap:12px;
      padding:10px 14px;
      max-width:1200px;margin:0 auto;
    }
    .logo{
      font-family: "UnifrakturMaguntia", "Old English Text MT", Georgia, serif;
      font-size: 28px; letter-spacing: 1px;
      text-shadow: 2px 2px 0 #000, 0 0 18px rgba(106,163,255,.35);
      user-select:none;
    }
    .logo span{ display:inline-block; transform: translateY(1px); }
    .tabs{ margin-left:auto; display:flex; gap:8px; }
    .btn{
      border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      color:var(--text);
      padding:8px 12px;border-radius:12px;cursor:pointer;
      transition:.2s; font-weight:600; font-size:14px;
      box-shadow: var(--shadow);
    }
    .btn:hover{ transform:translateY(-1px); border-color: rgba(255,255,255,.16)}
    .btn.primary{ border-color: rgba(106,163,255,.45); box-shadow:0 8px 20px rgba(106,163,255,.18)}
    .btn.danger{ border-color: rgba(239,68,68,.45);}
    .btn.warning{ border-color: rgba(245,158,11,.45);}
    .btn.success{ border-color: rgba(34,197,94,.45);}

    .avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,.2);cursor:pointer}
    .avatar-wrap{display:flex;align-items:center;gap:10px}

    .container{max-width:1200px;margin:12px auto;display:grid;grid-template-columns: 280px 1fr;gap:12px;flex:1;width:100%;padding:0 12px 14px}

    /* Левое меню */
    .side{
      position:sticky;top:64px;align-self:start;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px;
    }
    .side h4{margin:8px 6px 10px;color:#cdd6f4}
    .menu{display:flex;flex-direction:column;gap:8px}

    .notice{
      margin:10px 0 12px; padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(8,12,20,.8), rgba(8,12,20,.6));
    }

    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.08)}

    /* Основная область */
    .main{display:flex;flex-direction:column;gap:12px}

    .hero{
      position:relative; overflow:hidden; border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      padding:14px 14px 12px;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 300"><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop offset="0%" stop-color="%230d1322"/><stop offset="100%" stop-color="%23070a12"/></linearGradient></defs><rect width="800" height="300" fill="url(%23g)"/></svg>') center/cover;
    }
    /* Подложка под текст для читабельности */
    .hero-overlay{
      position:absolute;inset:0;background: radial-gradient(600px 200px at 10% 10%, rgba(10,14,24,.75), rgba(10,14,24,.35) 55%, rgba(10,14,24,0) 70%);
      pointer-events:none;border-radius:var(--radius);
    }
    .hero-content{position:relative; z-index:2}
    .hero h1{
      font-family: "UnifrakturMaguntia", Georgia, serif;
      margin:0 0 8px; font-size:34px; letter-spacing:.5px;
      text-shadow: 0 2px 0 #000, 0 0 22px rgba(0,0,0,.45);
    }
    .hero .sub{color:#d9e1f5; opacity:.9; max-width:900px}

    /* Вкладки чатов */
    .tabs-line{display:flex;gap:8px;margin-top:10px}

    /* Карточки */
    .card{ border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow); background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); }

    /* Чат */
    .chat-wrap{display:grid; grid-template-rows: minmax(300px, 65vh) auto; }
    .messages{ padding:10px; overflow:auto; scroll-behavior:smooth; }
    .msg{ display:flex; gap:10px; margin:8px 0; }
    .msg.self .bubble{ background: rgba(106,163,255,.15); border-color: rgba(106,163,255,.35); }
    .bubble{ border:1px solid rgba(255,255,255,.1); background: rgba(255,255,255,.04); padding:8px 10px; border-radius:12px; max-width: 70%;}
    .msg .meta{font-size:12px;color:#9aa3ba;margin-top:4px}
    .msg .name{font-weight:700}
    .msg img.media{max-width:240px;border-radius:10px;border:1px solid rgba(255,255,255,.1)}

    .composer{ display:flex; gap:8px; padding:12px; border-top:1px solid rgba(255,255,255,.06);}
    .composer input, .composer textarea{ flex:1; background:#0f1422; border:1px solid rgba(255,255,255,.08); color:var(--text); padding:10px 12px; border-radius:12px; resize:vertical; max-height:200px }

    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
    .chip{font-size:12px;border:1px solid rgba(255,255,255,.1);padding:3px 6px;border-radius:999px;color:#cdd6f4}

    /* Контекст-меню реакций */
    .react-menu{ position:fixed; display:none; gap:6px; padding:6px; background:#0f1422; border:1px solid rgba(255,255,255,.12); border-radius:12px; box-shadow:var(--shadow) }
    .react-menu button{ font-size:18px; background:transparent; border:none; cursor:pointer }

    /* Профиль + ЛС */
    .modal{ position:fixed; inset:0; display:none; place-items:center; background: rgba(0,0,0,.55); z-index:40 }
    .modal.open{ display:grid }
    .sheet{ width:min(900px, 96vw); background:#0b101c; border:1px solid rgba(255,255,255,.08); border-radius:18px; overflow:hidden; }
    .sheet-head{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.08) }
    .sheet-body{ padding:12px; display:grid; grid-template-columns: 260px 1fr; gap:12px }
    .sheet-body .section{ background:#0f1422; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px }

    .list{ display:flex; flex-direction:column; gap:6px; max-height:55vh; overflow:auto }
    .list .item{ display:flex; align-items:center; gap:10px; padding:8px; border:1px solid rgba(255,255,255,.06); border-radius:12px; background: rgba(255,255,255,.02); cursor:pointer }
    .status-dot{ width:8px; height:8px; border-radius:50% }

    /* Админка */
    .admin{ display:none }
    .admin.open{ display:block }
    .admin .grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px }

    /* Карта */
    #map{ width:100%; height:65vh; border-radius:16px }

    /* Помощь */
    .help p{ color:#c9d4ee }

    /* Утилити */
    .hidden{ display:none !important }
    .row{display:flex;gap:8px;align-items:center}
    .grow{flex:1}
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <div class="nav">
      <!-- Аватар слева -->
      <div id="profileTrigger" class="avatar-wrap" title="Профиль, друзья, ЛС">
        <img id="navAvatar" class="avatar" src="https://i.pravatar.cc/80?img=64" alt="avatar"/>
        <div>
          <div style="font-weight:700">Профиль</div>
          <div id="navOnline" class="pill" style="font-size:11px; opacity:.85">онлайн: <span id="onlineCount">—</span></div>
        </div>
      </div>
      <div class="logo" style="margin-left:10px">PRAHA&nbsp;<span>FUŠKY</span></div>

      <div class="tabs">
        <button class="btn" data-view="chatMain">Чат</button>
        <button class="btn" data-view="chatRent">Чат Оренда</button>
        <button class="btn" data-view="map">Карта</button>
        <button class="btn" data-view="help">Помощь</button>
        <button id="adminBtn" class="btn warning hidden" data-view="admin">Админ</button>
      </div>
    </div>
  </header>

  <div class="container">
    <aside class="side">
      <h4>Навигация</h4>
      <div class="menu">
        <button class="btn primary" data-view="chatMain">Открыть общий чат</button>
        <button class="btn" data-view="chatRent">Чат аренды</button>
        <button class="btn" data-view="map">Открыть карту</button>
        <button class="btn" data-view="help">Помощь</button>
        <button id="sideAdminBtn" class="btn warning hidden" data-view="admin">Панель администратора</button>
      </div>
      <div class="notice">
        <div class="sub">Якщо ви вперше — натисніть <b>«Відправити»</b> — з'явиться реєстрація. <b>6 годин доступу без підтвердження email.</b></div>
      </div>
      <div class="chips">
        <div class="chip">Автопрокрутка чата</div>
        <div class="chip">Личные сообщения</div>
        <div class="chip">Друзья онлайн</div>
        <div class="chip">Боты-объявления</div>
      </div>
    </aside>

    <main class="main">
      <section class="hero card">
        <div class="hero-overlay"></div>
        <div class="hero-content">
          <h1>PRAHA FUŠKY</h1>
          <div class="sub">Место для быстрых объявлений, вакансий, аренды и общения. Уважайте друг друга. Помните: администрация может временно ограничить отправку сообщений при нарушениях.</div>
          <div class="tabs-line" style="margin-top:10px">
            <button class="btn" data-view="chatMain">Чат</button>
            <button class="btn" data-view="map">Карта</button>
            <button class="btn" data-view="help">Помощь</button>
          </div>
        </div>
      </section>

      <!-- ЧАТЫ -->
      <section id="view-chatMain" class="card chat-wrap">
        <div class="messages" id="messages-main"></div>
        <div class="composer">
          <textarea id="input-main" rows="1" placeholder="Напишите сообщение…"></textarea>
          <input id="imageUrl-main" placeholder="Ссылка на фото (не обязательно)" />
          <button class="btn primary" id="send-main">Отправить</button>
        </div>
      </section>

      <section id="view-chatRent" class="card chat-wrap hidden">
        <div class="messages" id="messages-rent"></div>
        <div class="composer">
          <textarea id="input-rent" rows="1" placeholder="Аренда: напишите сообщение…"></textarea>
          <input id="imageUrl-rent" placeholder="Ссылка на фото (не обязательно)" />
          <button class="btn primary" id="send-rent">Отправить</button>
        </div>
      </section>

      <!-- КАРТА -->
      <section id="view-map" class="card hidden">
        <div id="map"></div>
        <div class="row" style="padding:10px">
          <input id="mapTitle" class="grow" placeholder="Заголовок точки (например, Объявление)" />
          <input id="mapImg" class="grow" placeholder="URL иконки (картинки маркера)" />
          <input id="mapLat" placeholder="Lat" style="width:120px" />
          <input id="mapLng" placeholder="Lng" style="width:120px" />
          <button class="btn" id="addMarker">Добавить точку</button>
        </div>
      </section>

      <!-- ПОМОЩЬ -->
      <section id="view-help" class="card help hidden" style="padding:14px">
        <h3>Правила и подсказки</h3>
        <p>1) Новые пользователи получают 6 часов доступа к отправке сообщений без подтверждения email. Дальше — подтвердите почту или оформите премиум.</p>
        <p>2) Личные сообщения: откройте профиль из левого верхнего угла, найдите пользователя и нажмите «Написать».</p>
        <p>3) Друзья: заявки и список друзей — в профиле («Друзья»). Онлайн считается по активности за последние 2 минуты.</p>
        <p>4) Реакции: удерживайте сообщение, чтобы поставить лайк 👍, пометить «осторожно мошенник» ⚠️, дизлайк 👎, спам 🚫 и др.</p>
        <p>5) Карта: вы можете добавлять точки с иконками — нужен URL картинки, так как хранилище Firebase не используется.</p>
        <p>6) Реклама: пишите на <b><span id="adEmail">urciknikolaj642@gmail.com</span></b>.</p>
      </section>

      <!-- АДМИНКА -->
      <section id="view-admin" class="card admin hidden" style="padding:12px">
        <h3>Панель администратора</h3>
        <div class="chips" style="margin-bottom:10px">
          <div class="chip">Продлить +30 дней</div>
          <div class="chip">Премиум навсегда</div>
          <div class="chip">Блок/разблок</div>
          <div class="chip">Обнулить лимиты</div>
        </div>
        <div class="grid" id="adminUsers"></div>
      </section>
    </main>
  </div>

  <!-- Модалка профиля и ЛС -->
  <div id="profileModal" class="modal">
    <div class="sheet">
      <div class="sheet-head">
        <div class="row">
          <img id="profileAvatar" class="avatar" src="https://i.pravatar.cc/80?img=64"/>
          <div>
            <div id="profileName" style="font-weight:800">Мой профиль</div>
            <div style="font-size:12px;color:#9aa3ba">Нажмите, чтобы сменить аватар (URL)</div>
          </div>
        </div>
        <div class="row">
          <button class="btn" id="profileMsgsBtn">Личные сообщения</button>
          <button class="btn" id="profileFriendsBtn">Друзья</button>
          <button class="btn danger" id="logoutBtn">Выйти</button>
          <button class="btn" id="closeProfile">×</button>
        </div>
      </div>
      <div class="sheet-body">
        <div class="section">
          <h4>Мои настройки</h4>
          <label>Ник</label>
          <input id="nickInput" style="width:100%" placeholder="Ваш ник" />
          <div class="chips" style="margin-top:8px">
            <div class="chip">Бесплатные без фото: <span id="quotaText">—</span></div>
            <div class="chip">Бесплатные с фото: <span id="quotaPhoto">—</span></div>
            <div class="chip">Премиум до: <span id="premiumUntil">—</span></div>
          </div>
          <div class="chips" style="margin-top:6px">
            <div class="chip">Статус: <span id="statusText">—</span></div>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn success" id="saveProfile">Сохранить</button>
          </div>
        </div>
        <div class="section">
          <div class="row" style="justify-content:space-between">
            <h4>Диалоги</h4>
            <input id="searchUsers" placeholder="Поиск по людям…" style="max-width:260px" />
          </div>
          <div class="list" id="dialogs"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Контекст меню реакций -->
  <div id="reactMenu" class="react-menu"></div>

  <!-- Firebase & App Scripts -->
  <script type="module">
    // === Firebase (реальные ключи пользователя) ===
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getDatabase, ref, onValue, push, set, update, serverTimestamp, query, limitToLast, orderByChild, equalTo, get, child } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
      authDomain: "praga-4baee.firebaseapp.com",
      databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
      projectId: "praga-4baee",
      storageBucket: "praga-4baee.firebasestorage.app",
      messagingSenderId: "336023952536",
      appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
      measurementId: "G-BGDJD6R12N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // === Глобальные переменные ===
    let me = null;               // текущий пользователь (auth)
    let meData = null;           // профиль из /users/{uid}
    let activeView = 'chatMain';

    const views = {
      chatMain: document.getElementById('view-chatMain'),
      chatRent: document.getElementById('view-chatRent'),
      map: document.getElementById('view-map'),
      help: document.getElementById('view-help'),
      admin: document.getElementById('view-admin'),
    };

    // === Навигация по вкладкам ===
    document.querySelectorAll('[data-view]').forEach(btn=>{
      btn.addEventListener('click', ()=>switchView(btn.dataset.view))
    });
    function switchView(name){
      activeView=name;
      Object.entries(views).forEach(([k,el])=> el.classList.toggle('hidden', k!==name));
      if(name==='map') setTimeout(()=>initMapOnce(), 0);
    }

    // === Профиль ===
    const profileTrigger = document.getElementById('profileTrigger');
    const profileModal = document.getElementById('profileModal');
    const closeProfile = document.getElementById('closeProfile');
    profileTrigger.addEventListener('click', ()=> profileModal.classList.add('open'));
    closeProfile.addEventListener('click', ()=> profileModal.classList.remove('open'));

    // === Онбординг: анонимная авторизация + пробный период 6 часов ===
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        await signInAnonymously(auth);
        return;
      }
      me = user;
      const uref = ref(db, `users/${user.uid}`);
      const snap = await get(uref);
      const now = Date.now();
      if(!snap.exists()){
        const trialHours = 6;
        await set(uref, {
          uid: user.uid,
          nick: `user_${user.uid.slice(0,6)}`,
          avatar: 'https://i.pravatar.cc/120?u='+user.uid,
          createdAt: now,
          firstLoginAt: now,
          premiumForever: false,
          premiumUntil: 0,
          blocked: false,
          lastSeen: now,
          freeTextLeft: 30,
          freePhotoLeft: 10,
          isAdmin: false,
          trialEndsAt: now + trialHours*60*60*1000,
        });
      } else {
        meData = snap.val();
      }
      watchMe();
      bootstrapUI();
      startChatListeners();
      startOnlineCounter();
      startBots();
    });

    async function watchMe(){
      const uref = ref(db, `users/${me.uid}`);
      onValue(uref, (s)=>{
        meData = s.val();
        if(!meData) return;
        document.getElementById('navAvatar').src = meData.avatar || 'https://i.pravatar.cc/80?img=64';
        document.getElementById('profileAvatar').src = meData.avatar || 'https://i.pravatar.cc/80?img=64';
        document.getElementById('nickInput').value = meData.nick || '';
        document.getElementById('quotaText').textContent = meData.freeTextLeft ?? '—';
        document.getElementById('quotaPhoto').textContent = meData.freePhotoLeft ?? '—';
        document.getElementById('premiumUntil').textContent = meData.premiumForever ? 'навсегда' : (meData.premiumUntil? new Date(meData.premiumUntil).toLocaleString(): '—');
        document.getElementById('statusText').textContent = meData.blocked? 'заблокирован' : 'активен';
        document.getElementById('adminBtn').classList.toggle('hidden', !meData.isAdmin);
        document.getElementById('sideAdminBtn').classList.toggle('hidden', !meData.isAdmin);
      })
      // обновление lastSeen каждые 30с
      setInterval(()=> update(ref(db, `users/${me.uid}`), { lastSeen: Date.now() }), 30000);
    }

    document.getElementById('saveProfile').addEventListener('click', async()=>{
      const nick = document.getElementById('nickInput').value.trim().slice(0,32) || `user_${me.uid.slice(0,6)}`;
      await update(ref(db, `users/${me.uid}`), { nick });
      alert('Сохранено');
    });

    document.getElementById('profileAvatar').addEventListener('click', async()=>{
      const url = prompt('Вставьте URL аватара (мы не используем Firebase Storage)');
      if(url) await update(ref(db, `users/${me.uid}`), { avatar: url });
    })
    document.getElementById('logoutBtn').addEventListener('click', ()=> signOut(auth));

    // === Друзья и ЛС ===
    const dialogsEl = document.getElementById('dialogs');
    const searchUsers = document.getElementById('searchUsers');
    searchUsers.addEventListener('input', async ()=>{
      const q = searchUsers.value.trim().toLowerCase();
      const snap = await get(ref(db, 'users'));
      dialogsEl.innerHTML = '';
      if(snap.exists()){
        Object.values(snap.val()).filter(u=> (u.nick||'').toLowerCase().includes(q) && u.uid!==me.uid).slice(0,50).forEach(u=>{
          const online = Date.now() - (u.lastSeen||0) < 120000;
          const item = document.createElement('div');
          item.className='item';
          item.innerHTML = `
            <img src="${u.avatar}" class="avatar"/>
            <div class="grow">
              <div style="font-weight:700">${u.nick||u.uid.slice(0,6)}</div>
              <div style="font-size:12px;color:#9aa3ba">${online? 'онлайн' : 'оффлайн'}</div>
            </div>
            <button class="btn" data-act="chat">Написать</button>
            <button class="btn" data-act="add">В друзья</button>
            <button class="btn danger" data-act="report">Пожаловаться</button>
          `;
          item.querySelector('[data-act="chat"]').onclick = ()=> openDM(u.uid);
          item.querySelector('[data-act="add"]').onclick = ()=> sendFriendRequest(u.uid);
          item.querySelector('[data-act="report"]').onclick = ()=> reportUser(u.uid);
          dialogsEl.appendChild(item);
        })
      }
    });

    async function sendFriendRequest(toUid){
      const id = push(ref(db, `friendRequests/${toUid}`)).key;
      await set(ref(db, `friendRequests/${toUid}/${id}`), { from: me.uid, at: Date.now() });
      alert('Заявка отправлена');
    }

    function reportUser(uid){
      const id = push(ref(db, 'reports')).key;
      set(ref(db, `reports/${id}`), { from: me.uid, against: uid, at: Date.now() });
      alert('Жалоба отправлена');
    }

    // Профильные кнопки
    document.getElementById('profileFriendsBtn').addEventListener('click', showFriends);
    async function showFriends(){
      const wrap = dialogsEl; wrap.innerHTML = '';
      // Заявки
      const rq = await get(ref(db, `friendRequests/${me.uid}`));
      if(rq.exists()){
        const box = document.createElement('div');
        box.innerHTML = '<h4>Заявки в друзья</h4>';
        wrap.appendChild(box);
        for(const [rid, r] of Object.entries(rq.val())){
          const us = await get(ref(db, `users/${r.from}`));
          if(!us.exists()) continue;
          const u = us.val();
          const item = document.createElement('div');
          item.className='item';
          item.innerHTML = `
            <img src="${u.avatar}" class="avatar"/>
            <div class="grow"><div style="font-weight:700">${u.nick}</div></div>
            <button class="btn success">Принять</button>
            <button class="btn danger">Отклонить</button>`;
          item.children[2].onclick = async()=>{
            await set(ref(db, `friends/${me.uid}/${u.uid}`), true);
            await set(ref(db, `friends/${u.uid}/${me.uid}`), true);
            await set(ref(db, `friendRequests/${me.uid}/${rid}`), null);
            showFriends();
          };
          item.children[3].onclick = async()=>{ await set(ref(db, `friendRequests/${me.uid}/${rid}`), null); showFriends(); };
          wrap.appendChild(item);
        }
      }
      // Список друзей
      const fr = await get(ref(db, `friends/${me.uid}`));
      const box2 = document.createElement('div');
      box2.innerHTML = '<h4>Мои друзья</h4>';
      wrap.appendChild(box2);
      if(fr.exists()){
        for(const uid of Object.keys(fr.val())){
          const us = await get(ref(db, `users/${uid}`)); if(!us.exists()) continue; const u=us.val();
          const online = Date.now() - (u.lastSeen||0) < 120000;
          const item = document.createElement('div');
          item.className='item';
          item.innerHTML = `
            <span class="status-dot" style="background:${online? '#22c55e':'#64748b'}"></span>
            <img src="${u.avatar}" class="avatar"/>
            <div class="grow"><div style="font-weight:700">${u.nick}</div></div>
            <button class="btn" data-act="chat">Написать</button>
            <button class="btn danger" data-act="rm">Удалить</button>`;
          item.querySelector('[data-act="chat"]').onclick = ()=> openDM(u.uid);
          item.querySelector('[data-act="rm"]').onclick = async()=>{ await set(ref(db, `friends/${me.uid}/${u.uid}`), null); await set(ref(db, `friends/${u.uid}/${me.uid}`), null); showFriends(); };
          wrap.appendChild(item);
        }
      } else {
        const p = document.createElement('p'); p.textContent='Пока нет друзей'; wrap.appendChild(p);
      }
    }

    // === Личные сообщения (DM) ===
    async function openDM(withUid){
      profileModal.classList.remove('open');
      const otherSnap = await get(ref(db, `users/${withUid}`));
      if(!otherSnap.exists()) return alert('Пользователь не найден');
      const other = otherSnap.val();
      const chatId = dmId(me.uid, withUid);
      switchView('chatMain'); // визуально тот же интерфейс; можно развести, если нужно
      // Откроем отдельное окно поверх главного чата
      const win = document.createElement('div');
      win.className='card';
      win.style.position='fixed'; win.style.bottom='12px'; win.style.right='12px'; win.style.width='min(460px, 95vw)'; win.style.zIndex='45';
      win.innerHTML = `
        <div class="row" style="justify-content:space-between; padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.08)">
          <div class="row"><img class="avatar" src="${other.avatar}"><div style="margin-left:8px"><div style="font-weight:800">${other.nick}</div><div style="font-size:12px;color:#9aa3ba">Личные сообщения</div></div></div>
          <button class="btn" data-x>×</button>
        </div>
        <div class="messages" style="height:40vh"></div>
        <div class="composer">
          <textarea rows="1" placeholder="Напишите личное сообщение…"></textarea>
          <input placeholder="URL фото (необязательно)" />
          <button class="btn primary">Отправить</button>
        </div>`;
      document.body.appendChild(win);
      win.querySelector('[data-x]').onclick = ()=> win.remove();
      const list = win.querySelector('.messages');
      const text = win.querySelector('textarea');
      const img = win.querySelector('input');
      const send = win.querySelector('button.btn.primary');

      const msgsRef = ref(db, `dm/${chatId}`);
      onValue(query(msgsRef, orderByChild('at'), limitToLast(100)), (s)=>{
        list.innerHTML='';
        if(s.exists()){
          Object.entries(s.val()).sort((a,b)=>a[1].at-b[1].at).forEach(([id,m])=>{
            const el = renderMessage(m, me.uid);
            list.appendChild(el);
          });
          list.scrollTop = list.scrollHeight;
        }
      });
      send.onclick = ()=> sendMessageTo(`dm/${chatId}`, text.value, img.value);
    }
    function dmId(a,b){ return a<b? `${a}_${b}` : `${b}_${a}` }

    // === Реакции и контекстное меню ===
    const reactMenu = document.getElementById('reactMenu');
    const reactions = [
      {k:'like', e:'👍'},
      {k:'warn', e:'⚠️'},
      {k:'dislike', e:'👎'},
      {k:'spam', e:'🚫'},
      {k:'love', e:'❤️'},
    ];

    function attachReactionMenu(el, path, msgId){
      el.addEventListener('contextmenu', (e)=>{ e.preventDefault(); showReactMenu(e.clientX, e.clientY, path, msgId) });
      let t; el.addEventListener('mousedown', (e)=>{ t=setTimeout(()=>showReactMenu(e.clientX,e.clientY,path,msgId), 420)});
      ['mouseup','mouseleave'].forEach(ev=> el.addEventListener(ev, ()=>clearTimeout(t)));
    }
    function showReactMenu(x,y, path, msgId){
      reactMenu.innerHTML='';
      reactions.forEach(r=>{
        const b=document.createElement('button'); b.textContent=r.e; b.title=r.k; b.onclick=()=>{
          const id = push(ref(db, `${path}/${msgId}/reactions/${r.k}`)).key;
          set(ref(db, `${path}/${msgId}/reactions/${r.k}/${id}`), me.uid);
          hideReactMenu();
        }; reactMenu.appendChild(b);
      })
      reactMenu.style.left=x+'px'; reactMenu.style.top=y+'px'; reactMenu.style.display='flex';
      document.addEventListener('click', hideReactMenu, {once:true});
    }
    function hideReactMenu(){ reactMenu.style.display='none' }

    // === Общий чат и чат аренды ===
    function startChatListeners(){
      bindChat('main', 'chat/main');
      bindChat('rent', 'chat/rent');
    }
    function bindChat(code, path){
      const list = document.getElementById(`messages-${code}`);
      const input = document.getElementById(`input-${code}`);
      const img = document.getElementById(`imageUrl-${code}`);
      const btn = document.getElementById(`send-${code}`);
      const msgsRef = ref(db, path);
      onValue(query(msgsRef, orderByChild('at'), limitToLast(200)), (s)=>{
        list.innerHTML='';
        if(s.exists()){
          const arr = Object.entries(s.val()).sort((a,b)=>a[1].at-b[1].at);
          arr.forEach(([id,m])=>{
            const el = renderMessage(m, me?.uid);
            attachReactionMenu(el.querySelector('.bubble'), path, id);
            list.appendChild(el);
          })
          list.scrollTop = list.scrollHeight; // автопрокрутка
        }
      })
      btn.addEventListener('click', ()=> sendMessageTo(path, input.value, img.value));
    }

    async function sendMessageTo(path, text, imageUrl){
      text = (text||'').trim(); imageUrl = (imageUrl||'').trim();
      if(!text && !imageUrl) return;
      if(meData?.blocked) return alert('Вы заблокированы');
      const now = Date.now();
      const trialOk = now < (meData?.trialEndsAt||0);
      const isPrem = meData?.premiumForever || (meData?.premiumUntil||0) > now;
      const freeTextLeft = meData?.freeTextLeft||0;
      const freePhotoLeft = meData?.freePhotoLeft||0;

      const needPhotoQuota = !!imageUrl;
      const enough = isPrem || trialOk || (!needPhotoQuota && freeTextLeft>0) || (needPhotoQuota && freePhotoLeft>0);
      if(!enough){
        return alert('Лимит исчерпан. Оформите премиум или дождитесь пополнения.');
      }
      const id = push(ref(db, path)).key;
      const msg = { id, from: me.uid, text, image: imageUrl||'', at: Date.now() };
      await set(ref(db, `${path}/${id}`), msg);
      // списываем квоты
      if(!isPrem && !trialOk){
        if(needPhotoQuota) await update(ref(db, `users/${me.uid}`), { freePhotoLeft: Math.max(0, freePhotoLeft-1) });
        else await update(ref(db, `users/${me.uid}`), { freeTextLeft: Math.max(0, freeTextLeft-1) });
      }
      // очистка ввода
      const [_, code] = path.split('/');
      const input = document.getElementById(`input-${code}`);
      const img = document.getElementById(`imageUrl-${code}`);
      if(input) input.value=''; if(img) img.value='';
    }

    function renderMessage(m, myUid){
      const wrap = document.createElement('div');
      wrap.className = 'msg'+ (m.from===myUid? ' self':'');
      const avatar = document.createElement('img'); avatar.className='avatar'; avatar.src='https://i.pravatar.cc/80?u='+m.from;
      const bubble = document.createElement('div'); bubble.className='bubble';
      const name = document.createElement('div'); name.className='name'; name.textContent = m.from===myUid? 'Вы' : (m.nick||'');
      const time = document.createElement('div'); time.className='meta'; time.textContent = new Date(m.at).toLocaleString();
      if(m.text){ const p=document.createElement('div'); p.textContent = m.text; bubble.appendChild(p); }
      if(m.image){ const im=document.createElement('img'); im.src=m.image; im.className='media'; bubble.appendChild(im); }

      // реакции
      const rbar = document.createElement('div'); rbar.className='meta';
      const reacts = m.reactions? Object.entries(m.reactions).map(([k,v])=> ({k, n: Object.keys(v).length})) : [];
      if(reacts.length){ rbar.textContent = 'Реакции: '+reacts.map(r=> `${reactions.find(x=>x.k===r.k)?.e||r.k} x${r.n}`).join('  '); bubble.appendChild(rbar) }

      wrap.appendChild(avatar); wrap.appendChild(bubble);
      bubble.title = 'Удерживайте для реакций';
      return wrap;
    }

    // === Онлайны (с множителем 10x) ===
    async function startOnlineCounter(){
      function tick(){
        get(ref(db, 'users')).then(s=>{
          let online=0; if(s.exists()){
            Object.values(s.val()).forEach(u=>{ if(Date.now() - (u.lastSeen||0) < 120000) online++; })
          }
          document.getElementById('onlineCount').textContent = online*10; // множитель 10x
        })
      }
      tick(); setInterval(tick, 15000);
    }

    // === Админка: список пользователей и действия ===
    async function refreshAdmin(){
      if(!meData?.isAdmin) return;
      const wrap = document.getElementById('adminUsers');
      wrap.innerHTML='';
      const s = await get(ref(db, 'users'));
      if(!s.exists()) return;
      const users = Object.values(s.val()).sort((a,b)=> (b.lastSeen||0)-(a.lastSeen||0));
      users.forEach(u=>{
        const card=document.createElement('div'); card.className='card'; card.style.padding='10px';
        card.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div class="row"><img class="avatar" src="${u.avatar}"><div style="margin-left:8px"><div style="font-weight:800">${u.nick||u.uid.slice(0,6)}</div><div style="font-size:12px;color:#9aa3ba">UID: ${u.uid}</div></div></div>
            <div class="chips"><div class="chip">Текст: ${u.freeTextLeft||0}</div><div class="chip">Фото: ${u.freePhotoLeft||0}</div><div class="chip">Премиум: ${u.premiumForever? 'навсегда' : (u.premiumUntil? new Date(u.premiumUntil).toLocaleDateString():'—')}</div><div class="chip">Пробный до: ${u.trialEndsAt? new Date(u.trialEndsAt).toLocaleString():'—'}</div><div class="chip">Последний вход: ${u.lastSeen? new Date(u.lastSeen).toLocaleString():'—'}</div></div>
          </div>
          <div class="row" style="margin-top:8px;flex-wrap:wrap">
            <button class="btn" data-act="extend">+30 дней</button>
            <button class="btn success" data-act="forever">Премиум навсегда</button>
            <button class="btn warning" data-act="toggleBlock">${u.blocked? 'Разблокировать':'Заблокировать'}</button>
            <button class="btn" data-act="reset">Обнулить лимиты</button>
            <input class="grow" data-k="text" placeholder="Новый лимит текст" />
            <input class="grow" data-k="photo" placeholder="Новый лимит фото" />
            <button class="btn" data-act="applyLimits">Задать лимиты</button>
          </div>
        `;
        card.querySelector('[data-act="extend"]').onclick = async()=>{
          const till = Math.max(Date.now(), u.premiumUntil||0) + 30*24*60*60*1000;
          await update(ref(db, `users/${u.uid}`), { premiumUntil: till, premiumForever: false }); refreshAdmin();
        }
        card.querySelector('[data-act="forever"]').onclick = async()=>{
          await update(ref(db, `users/${u.uid}`), { premiumForever: true }); refreshAdmin();
        }
        card.querySelector('[data-act="toggleBlock"]').onclick = async()=>{
          await update(ref(db, `users/${u.uid}`), { blocked: !u.blocked }); refreshAdmin();
        }
        card.querySelector('[data-act="reset"]').onclick = async()=>{
          await update(ref(db, `users/${u.uid}`), { freeTextLeft: 30, freePhotoLeft: 10 }); refreshAdmin();
        }
        card.querySelector('[data-act="applyLimits"]').onclick = async()=>{
          const t = Number(card.querySelector('[data-k="text"]').value||u.freeTextLeft||0);
          const p = Number(card.querySelector('[data-k="photo"]').value||u.freePhotoLeft||0);
          await update(ref(db, `users/${u.uid}`), { freeTextLeft: t, freePhotoLeft: p }); refreshAdmin();
        }
        document.getElementById('adminUsers').appendChild(card);
      })
    }

    // открытие админки
    document.getElementById('adminBtn').addEventListener('click', ()=>{ switchView('admin'); refreshAdmin(); });
    document.getElementById('sideAdminBtn').addEventListener('click', ()=>{ switchView('admin'); refreshAdmin(); });

    // === Боты: 3 бота с разными интервалами (2м, 3м, 4м) ===
    const bots = [
      {
        name:'Bot#1', avatar:'https://i.ibb.co/LH4wBMS/IMG-d8e6076e17f19db7fe3add0754738a01-V.jpg',
        interval: 2*60*1000,
        posts:[
          {text:'O2 СIМ КАРТА\nБез ліміт интернет, без ліміт дзвінки, працює в Європі. Плата 699 крон/міс. Ціна 299 Kč. тел 607914467. Viber/WhatsApp/Telegram.', image:'https://i.ibb.co/LH4wBMS/IMG-d8e6076e17f19db7fe3add0754738a01-V.jpg'},
          {text:'Продаю iPhone 11 Pro Max + 26 чохлів (чохли безкоштовно). Стан відмінний, не падав, все оригінальне. Без Apple ID. Питання в особисті.', image:'https://i.ibb.co/dwcXPqDr/IMG-1954f6b56869b9817a131ae33f3a37b6-V.jpg'},
          {text:'Оголошення з фото-текстом', image:'https://i.ibb.co/G3kDcrYZ/IMG-fa590121e46c5b030c5ddc94d4e8bea9-V.jpg'},
        ]
      },
      {
        name:'Bot#2', avatar:'https://i.ibb.co/Z11WVrVC/IMG-b83692bb79a1468af74c81620750e8c0-V.jpg',
        interval: 3*60*1000,
        posts:[
          {text:'Запрошую моделей на перманентний макіяж під наглядом сертифікованого майстра. Прага, 28.07 о 14:00. Лише за матеріал. Подробиці — в особисті.' , image:'https://i.ibb.co/QFWDvGZ8/IMG-6748e7141906901b131b8fd5130a5c01-V.jpg'},
          {text:'Шаблон для 2-го бота з картинкою', image:'https://i.ibb.co/Z11WVrVC/IMG-b83692bb79a1468af74c81620750e8c0-V.jpg'},
          {text:'Додаткове оголошення', image:'https://i.ibb.co/j97RhTny/IMG-593d75b053ea1a28cdfb9fc52f93afad-V.jpg'},
        ]
      },
      {
        name:'Bot#3', avatar:'https://i.ibb.co/MzdTMPR/IMG-8231d8142ffcbba7c682ca598683e3f2-V.jpg',
        interval: 4*60*1000,
        posts:[
          {text:'Нужен водитель для помощи в переезде, со своим авто. Пишите: WhatsApp +48 793 463 757, Telegram: @carlx_xxx', image:''},
          {text:'Перевозки/услуги — детали в ЛС', image:'https://i.ibb.co/MzdTMPR/IMG-8231d8142ffcbba7c682ca598683e3f2-V.jpg'},
          {text:'Ещё предложение', image:'https://i.ibb.co/rfNV6ddC/IMG-0cd648a74f86227fe46db2d01c099be0-V.jpg'},
        ]
      },
    ];

    function startBots(){
      // публикуем в общий чат по кругу
      bots.forEach((bot)=>{
        let idx=0;
        setInterval(async()=>{
          const p = bot.posts[idx%bot.posts.length]; idx++;
          const id = push(ref(db, 'chat/main')).key;
          const msg = { id, from:`bot_${bot.name}`, nick: bot.name, text:p.text, image:p.image||'', at: Date.now() };
          await set(ref(db, `chat/main/${id}`), msg);
        }, bot.interval);
      })
    }

    // === Карта Google ===
    let _mapInited=false; let _map; let _markers=[];
    function initMapOnce(){ if(_mapInited) return; _mapInited=true; if(window.initAppMap) window.initAppMap(); }
    window.initAppMap = function(){
      // Старт в Праге
      _map = new google.maps.Map(document.getElementById('map'), { center:{lat:50.0755, lng:14.4378}, zoom:12, mapId:'DEMO_MAP_ID' });
      // Загрузка точек
      onValue(ref(db, 'mapPoints'), (s)=>{
        _markers.forEach(m=>m.setMap(null)); _markers=[];
        if(s.exists()){
          Object.values(s.val()).forEach(p=>{
            const m = new google.maps.Marker({ position:{lat:p.lat, lng:p.lng}, map:_map, title:p.title||'', icon: p.icon? { url:p.icon, scaledSize: new google.maps.Size(32,32)}:undefined });
            const inf = new google.maps.InfoWindow({ content:`<b>${p.title||''}</b>` });
            m.addListener('click', ()=> inf.open({map:_map, anchor:m}));
            _markers.push(m);
          })
        }
      })
    }

    document.getElementById('addMarker').addEventListener('click', async()=>{
      const t = document.getElementById('mapTitle').value.trim();
      const i = document.getElementById('mapImg').value.trim();
      const lat = parseFloat(document.getElementById('mapLat').value);
      const lng = parseFloat(document.getElementById('mapLng').value);
      if(!t || isNaN(lat) || isNaN(lng)) return alert('Заполните заголовок и координаты');
      const id = push(ref(db, 'mapPoints')).key;
      await set(ref(db, `mapPoints/${id}`), { title:t, icon:i||'', lat, lng });
      document.getElementById('mapTitle').value=''; document.getElementById('mapImg').value=''; document.getElementById('mapLat').value=''; document.getElementById('mapLng').value='';
    })

    // === Вспомогательное ===
    function bootstrapUI(){
      // подправим высоту лент (+25%)
      document.querySelectorAll('.messages').forEach(el=>{ el.style.minHeight='calc(65vh + 25%)'; el.style.maxHeight='calc(65vh + 25%)'; });
    }

    // быстрый фильтр людей (диалоги)
    document.getElementById('profileMsgsBtn').addEventListener('click', ()=>{ searchUsers.value=''; searchUsers.dispatchEvent(new Event('input')); });

    // Навешиваем прослушку на клик по логотипу — просто открыть общий чат
    document.querySelector('.logo').addEventListener('click', ()=> switchView('chatMain'));

  </script>

  <!-- Google Maps (реальный ключ пользователя) -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFrxVhpb6nHJ6rhiLl5Ho8t0jOb1iEQNc&callback=initAppMap"></script>
</body>
</html>
