 <!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PRAGA FU≈†KY ‚Äî –°–æ—Ü—á–∞—Ç (FINAL)</title>
  <meta name="theme-color" content="#071126" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --accent:#2ecc71;
      --glass: rgba(255,255,255,0.96);
      --muted:#64748b;
      --max-width:1100px;
      --avatar-size:56px;
      --chat-scale:1.18;
      --gothic-size:44px;
      --mobile-break:820px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif;-webkit-font-smoothing:antialiased;background:#071126;color:#0b1220;overflow-x:hidden}

    /* Background */
    body{ background-image:url('https://i.ibb.co/27hgtZfY/Prague.jpg'); background-size:cover; background-position:center; background-attachment:fixed }

    /* Header */
    header{position:sticky;top:0;z-index:160;padding:8px 12px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;background:linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.02));backdrop-filter: blur(2px)}
    .topline{width:100%;max-width:var(--max-width);display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand-left{display:flex;align-items:center;gap:12px;flex:1;justify-content:center}
    h1.gothic{font-family:'UnifrakturCook',cursive;margin:0;font-size:var(--gothic-size);color:#fff;text-transform:uppercase;letter-spacing:2px;text-shadow:2px 6px 0 rgba(0,0,0,0.45),0 12px 30px rgba(0,0,0,0.6)}
    #tagline{margin:0;color:#fff;font-size:13px;padding:6px 12px;border-radius:10px;background:rgba(0,0,0,0.28)}

    .controls{display:flex;gap:10px;align-items:center}
    .bell{position:relative; width:44px;height:44px;border-radius:10px;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .bell svg{opacity:0.95}
    .bell .count{position:absolute;right:-6px;top:-6px;background:#ef4444;color:#fff;border-radius:999px;padding:4px 7px;font-size:12px;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
    .profile-btn{width:48px;height:48px;border-radius:50%;border:2px solid #fff;background-size:cover;background-position:center;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,0.35)}

    /* Tabs */
    nav.tabs{display:flex;gap:10px;justify-content:center;padding:8px;width:100%;max-width:var(--max-width);margin:0 auto}
    .tab-button{background:linear-gradient(180deg, rgba(0,0,0,0.30), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.04);color:#fff;padding:8px 14px;font-weight:800;border-radius:10px;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,0.35)}
    .tab-button.active{outline:2px solid rgba(46,204,113,0.12);background:linear-gradient(180deg, rgba(46,204,113,0.12), rgba(0,0,0,0.12))}

    main.container{max-width:var(--max-width);margin:6px auto;padding:6px}

    /* system message hidden (we removed it from feed) */
    .sys-msg{display:none}

    .tab-content{display:none}
    .tab-content.active{display:block}

    /* Chat area */
    .chat-area{height:calc(100vh - 200px);overflow:auto;padding:8px;background:transparent}
    .messages{display:flex;flex-direction:column;gap:12px;padding-bottom:160px;transform:scale(var(--chat-scale));transform-origin:bottom left}
    .message{display:flex;gap:12px;align-items:flex-start;max-width:82%;word-break:break-word}
    .message.self{margin-left:auto;flex-direction:row-reverse}
    .avatar{width:var(--avatar-size);height:var(--avatar-size);border-radius:50%;object-fit:cover;flex:0 0 var(--avatar-size);box-shadow:0 3px 10px rgba(0,0,0,0.35);cursor:pointer}
    .message-content{background:var(--glass);padding:10px 14px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.12);color:#0b1220}
    .message.self .message-content{background:#E9FFF0}
    .message-meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .chat-image{max-width:520px;border-radius:8px;margin-top:8px;display:block}
    .message-content .text{ font-family:'UnifrakturCook',cursive;font-weight:700;font-size:1rem;color:#0b1220;white-space:pre-wrap }

    /* Input */
    .chat-input{position:fixed;left:0;right:0;bottom:0;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.99));border-top:1px solid rgba(0,0,0,0.06);z-index:90;display:flex;gap:8px;align-items:center;max-width:var(--max-width);margin:0 auto}
    .camera-btn{display:inline-flex;align-items:center;justify-content:center;cursor:pointer;width:46px;height:46px;border-radius:50%;background:#fff;border:1px solid #e6e6e6}
    .chat-input input[type="text"]{flex:1;padding:12px 14px;border-radius:22px;border:1px solid #d0d7de;font-size:15px;outline:none}
    .send-btn{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:18px;font-weight:800;cursor:pointer;box-shadow:0 8px 20px rgba(46,204,113,0.18)}

    /* Message menu */
    .msg-menu{position:fixed;background:#fff;border-radius:8px;padding:6px;box-shadow:0 6px 20px rgba(0,0,0,0.2);z-index:300;display:none}
    .msg-menu button{display:block;border:none;background:transparent;padding:6px 10px;text-align:left;width:100%;cursor:pointer}
    .msg-menu button:hover{background:rgba(0,0,0,0.03)}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:350;padding:12px}
    .modal.show{display:flex}
    .modal-panel{background:#fff;border-radius:12px;padding:12px;width:96%;max-width:980px;position:relative;box-shadow:0 24px 100px rgba(0,0,0,0.6)}
    .modal-close{position:absolute;right:10px;top:8px;background:transparent;border:none;font-size:18px;cursor:pointer}

    /* Friends list */
    .friends-list{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto;padding:8px}

    /* Map info window small image */
    .map-thumb{width:100%;height:120px;object-fit:cover;border-radius:6px;margin-top:8px}

    /* small device tweaks */
    @media(max-width:var(--mobile-break)){
      :root{--chat-scale:1.05;--gothic-size:32px}
      .messages{transform-origin:bottom left;padding-bottom:220px}
      .chat-input{padding:10px}
      .message-content .text{font-size:0.95rem}
      .chat-area{height:calc(100vh - 170px)}
      header{padding:6px}
      nav.tabs{gap:8px}
      .brand-left{justify-content:center}
      .profile-btn{width:42px;height:42px}
    }
  </style>
</head>
<body>

  <header>
    <div class="topline">
      <div class="profile-left">
        <button id="profileBtn" class="profile-btn" title="–ü—Ä–æ—Ñ—ñ–ª—å" aria-label="–ü—Ä–æ—Ñ—ñ–ª—å"></button>
      </div>
      <div class="brand-left">
        <div style="text-align:center">
          <h1 class="gothic">PRAGA FU≈†KY</h1>
          <p id="tagline">–í—ñ—Ç–∞—é, –¥–æ—Ä–æ–≥—ñ —É–∫—Ä–∞—ó–Ω—Ü—ñ ‚Äî —Ü–µ–π —á–∞—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ, —â–æ–± –¥–æ–ø–æ–º–∞–≥–∞—Ç–∏ –Ω–∞—à–∏–º.</p>
        </div>
      </div>
      <div class="controls" style="justify-self:end">
        <div id="notifBell" class="bell" title="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è" aria-hidden="false" role="button" aria-label="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 17H9" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 22C13.1046 22 14 21.1046 14 20H10C10 21.1046 10.8954 22 12 22Z" fill="#fff"/><path d="M18 8C18 5.23858 15.7614 3 13 3H11C8.23858 3 6 5.23858 6 8C6 12 4 13 4 13H20C20 13 18 12 18 8Z" stroke="#fff" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <div id="notifCount" class="count" style="display:none">0</div>
        </div>
        <button id="friendsBtn" class="small-btn" title="–î—Ä—É–∑—ñ">üë• –î—Ä—É–∑—ñ</button>
      </div>
    </div>

    <nav class="tabs" role="tablist" aria-label="–í–∫–ª–∞–¥–∫–∏">
      <button class="tab-button active" data-target="chatTab">üí¨ –ß–∞—Ç</button>
      <button class="tab-button" data-target="rentTab">üèòÔ∏è –ß–∞—Ç –û—Ä–µ–Ω–¥–∞</button>
      <button class="tab-button" data-target="mapTab">üó∫ –ö–∞—Ä—Ç–∞</button>
      <button class="tab-button" data-target="helpTab">‚ùì –î–æ–ø–æ–º–æ–≥–∞</button>
    </nav>
  </header>

  <main class="container">
    <!-- Chat -->
    <section id="chatTab" class="tab-content active">
      <div class="chat-area" id="chatArea" aria-live="polite">
        <div id="messages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- Rent chat -->
    <section id="rentTab" class="tab-content" style="display:none">
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <input id="rentSearch" placeholder="–ü–æ—à—É–∫ –æ–≥–æ–ª–æ—à–µ–Ω—å..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd">
        <button id="postRentBtn" class="small-btn">–ü–æ–¥–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</button>
      </div>
      <div class="chat-area" style="height:54vh">
        <div id="rentMessages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- Map -->
    <section id="mapTab" class="tab-content" style="display:none">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <div style="flex:1"><input id="mapSearch" placeholder="–ü–æ—à—É–∫ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –≤–æ–ª–æ–Ω—Ç–µ—Ä–∏, –∞–ø—Ç–µ–∫–∞)..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd"></div>
        <div><button id="centerBtn" class="small-btn">–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏</button></div>
      </div>
      <div id="map" style="height:60vh;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.3)"></div>
    </section>

    <!-- Help -->
    <section id="helpTab" class="tab-content" style="display:none">
      <h2 style="color:#fff">–¢–µ—Ä–º—ñ–Ω–æ–≤–∞ –¥–æ–ø–æ–º–æ–≥–∞ —É –ü—Ä–∞–∑—ñ</h2>
      <div class="help-grid">
        <div class="help-card">
          <img src="https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp" alt="–ë–æ–ª—å–Ω–∏—Ü–∞">
          <h3>Nemocnice Motol</h3><p>–ê–¥—Ä–µ—Å–∞: V Uvalu 84</p>
        </div>
        <div class="help-card">
          <img src="https://i.ibb.co/0gWD5wW/images-5.jpg" alt="–Æ—Ä–∏—Å—Ç—ã">
          <h3>–Æ—Ä–∏–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞</h3><p>–î–æ–∫—É–º–µ–Ω—Ç–∏ —Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó</p>
        </div>
        <div class="help-card">
          <img src="https://i.ibb.co/R49shL6k/images-6.jpg" alt="–ú–∞–≥–∞–∑–∏–Ω—ã">
          <h3>–£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –º–∞–≥–∞–∑–∏–Ω–∏</h3><p>–ü—Ä–æ–¥—É–∫—Ç–∏ —Ç–∞ —Ç–æ–≤–∞—Ä–∏</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Hidden file input -->
  <input id="fileInput" type="file" accept="image/*" style="display:none">

  <!-- Input -->
  <div class="chat-input" role="region" aria-label="–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">
    <label for="fileInput" class="camera-btn" title="–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="#111" xmlns="http://www.w3.org/2000/svg"><path d="M4 7H6L7 5H17L18 7H20C21.1 7 22 7.9 22 9V19C22 20.1 21.1 21 20 21H4C2.9 21 2 20.1 2 19V9C2 7.9 2.9 7 4 7Z"></path></svg>
    </label>
    <input id="messageInput" type="text" inputmode="text" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." aria-label="–¢–µ–∫—Å—Ç" />
    <button id="sendButton" class="send-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
  </div>

  <!-- Profile modal -->
  <div id="profileModal" class="modal" aria-hidden="true">
    <div class="modal-panel">
      <button class="modal-close" id="profileClose">‚úï</button>
      <div id="profileContent">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>
  </div>

  <!-- Message menu -->
  <div id="msgMenu" class="msg-menu" role="menu">
    <button data-act="like">üëç –õ–∞–π–∫</button>
    <button data-act="warn">‚ö†Ô∏è –û—Å—Ç–µ—Ä–µ–∂–Ω–æ (—à–∞—Ö—Ä–∞–π)</button>
    <button data-act="dislike">üëé –î–∏–∑–ª–∞–π–∫</button>
    <button data-act="spam">üö´ –°–ø–∞–º</button>
    <button data-act="reply">‚Ü©Ô∏è –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏</button>
  </div>

  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile,
      sendEmailVerification, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getDatabase, ref as dbRef, push as dbPush, onChildAdded, query, orderByChild, limitToLast,
      get as dbGet, set as dbSet, onValue, remove as dbRemove
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // ---------- Firebase config (from your project) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
      authDomain: "praga-4baee.firebaseapp.com",
      databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
      projectId: "praga-4baee",
      storageBucket: "praga-4baee.firebasestorage.app",
      messagingSenderId: "336023952536",
      appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
      measurementId: "G-BGDJD6R12N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ---------- DOM ----------
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const messagesEl = document.getElementById('messages');
    const rentMessagesEl = document.getElementById('rentMessages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const fileInput = document.getElementById('fileInput');
    const profileBtn = document.getElementById('profileBtn');
    const profileModal = document.getElementById('profileModal');
    const profileClose = document.getElementById('profileClose');
    const profileContent = document.getElementById('profileContent');
    const notifBell = document.getElementById('notifBell');
    const notifCount = document.getElementById('notifCount');
    const friendsBtn = document.getElementById('friendsBtn');
    const onlineCountEl = document.getElementById('onlineCount');
    const mapEl = document.getElementById('map');
    const rentSearch = document.getElementById('rentSearch');
    const postRentBtn = document.getElementById('postRentBtn');
    const mapSearch = document.getElementById('mapSearch');
    const centerBtn = document.getElementById('centerBtn');

    const DEFAULT_AVATAR = 'https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg';
    let currentUser = null;
    const MSG_LIMIT = 500;

    function setActiveTab(id){
      tabButtons.forEach(b => b.classList.toggle('active', b.dataset.target === id));
      tabContents.forEach(c => c.style.display = (c.id === id) ? 'block' : 'none');
      if (id === 'chatTab') messageInput.focus();
      if (id === 'mapTab') {
        setTimeout(()=> {
          if (window.google && window.map) {
            google.maps.event.trigger(window.map,'resize');
            window.map.setCenter({lat:50.0755,lng:14.4378});
          } else {
            const want = confirm('–ö–∞—Ä—Ç–∞ —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞. –ë–∞–∂–∞—î—Ç–µ –≤—Å—Ç–∞–≤–∏—Ç–∏ Google Maps API key –∑–∞—Ä–∞–∑?');
            if (want) loadMapsWithKey();
          }
        }, 200);
      }
    }
    tabButtons.forEach(btn => btn.addEventListener('click', ()=> setActiveTab(btn.dataset.target)));
    document.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='c') setActiveTab('chatTab'); if(e.key.toLowerCase()==='r') setActiveTab('rentTab'); if(e.key.toLowerCase()==='m') setActiveTab('mapTab'); if(e.key.toLowerCase()==='h') setActiveTab('helpTab'); });

    function timeStr(ts){ return new Date(ts).toLocaleString(); }

    /* ----------------- Render message ----------------- */
    function renderMessage(m, container = messagesEl){
      if (!m || !m.ts) return;
      const wrap = document.createElement('div');
      wrap.className = 'message' + ((currentUser && m.uid === currentUser.uid) ? ' self' : '');
      wrap.dataset.uid = m.uid || '';
      wrap.dataset.msgid = m.id || '';

      const avatar = document.createElement('img');
      avatar.className = 'avatar';
      avatar.src = m.avatar || DEFAULT_AVATAR;
      avatar.alt = m.nick || 'avatar';
      avatar.title = m.nick || '–ü—Ä–æ—Ñ—ñ–ª—å';
      avatar.addEventListener('click', ()=> openProfile(m.uid));

      const txt = document.createElement('div');
      txt.className = 'message-content';
      const meta = document.createElement('div');
      meta.className = 'message-meta';
      meta.textContent = `${m.nick || '–ê–Ω–æ–Ω—ñ–º'} ¬∑ ${timeStr(m.ts)}` + (m.recipientUid ? ' ¬∑ –æ—Å–æ–±–∏—Å—Ç–µ' : '');
      txt.appendChild(meta);

      if (m.text) {
        const p = document.createElement('div');
        p.className = 'text';
        p.innerText = m.text;
        txt.appendChild(p);
      }

      if (m.image) {
        const im = document.createElement('img');
        im.src = m.image;
        im.alt = '–§–æ—Ç–æ';
        im.className = 'chat-image';
        txt.appendChild(im);
      }

      wrap.appendChild(avatar);
      wrap.appendChild(txt);
      container.appendChild(wrap);

      wrap.addEventListener('contextmenu', (ev) => {
        ev.preventDefault();
        showMsgMenu(ev.pageX, ev.pageY, m, wrap);
      });

      // auto-scroll to bottom if near bottom
      const chatArea = container.closest('.chat-area');
      if (chatArea) {
        const nearBottom = chatArea.scrollHeight - chatArea.scrollTop - chatArea.clientHeight < 200;
        if (nearBottom) chatArea.scrollTop = chatArea.scrollHeight;
      }
    }

    // subscribe public messages
    const msgsQuery = query(dbRef(db, "messages"), orderByChild("ts"), limitToLast(MSG_LIMIT));
    onChildAdded(msgsQuery, (snap) => {
      const m = snap.val(); m.id = snap.key;
      renderMessage(m, messagesEl);
    });

    // rent messages
    const rentQuery = query(dbRef(db, "rentMessages"), orderByChild("ts"), limitToLast(200));
    onChildAdded(rentQuery, (snap) => {
      const m = snap.val(); m.id = snap.key;
      renderMessage(m, rentMessagesEl);
    });

    /* ----------------- Image resize helper ----------------- */
    function resizeImageFile(file, maxWidth = 1200, quality = 0.8) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        reader.onload = (e) => {
          img.onload = () => {
            const scale = Math.min(1, maxWidth / img.width);
            const w = Math.round(img.width * scale);
            const h = Math.round(img.height * scale);
            const canvas = document.createElement('canvas');
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            resolve(dataUrl);
          };
          img.onerror = (err) => reject(err);
          img.src = e.target.result;
        };
        reader.onerror = (err) => reject(err);
        reader.readAsDataURL(file);
      });
    }

    /* ----------------- Send message ----------------- */
    sendButton.addEventListener('click', async ()=>{
      if (!auth.currentUser) { showAuthModal(); return; }
      if (!await canSendMessage()) { alert('–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å email –∞–±–æ —Å–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—å 6-–≥–æ–¥–∏–Ω–Ω–∏–º –¥–æ—Å—Ç—É–ø–æ–º –ø—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó.'); return; }

      const text = messageInput.value.trim();
      const file = fileInput.files[0];
      if (!text && !file) return;

      let imageData = null;
      if (file) {
        try {
          imageData = await resizeImageFile(file, 1200, 0.8);
        } catch (e) {
          console.error('resize error', e);
          alert('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Ñ–æ—Ç–æ');
          return;
        }
      }

      const msg = {
        uid: auth.currentUser.uid,
        nick: auth.currentUser.displayName || auth.currentUser.email || '–ê–Ω–æ–Ω—ñ–º',
        avatar: auth.currentUser.photoURL || DEFAULT_AVATAR,
        text: text || null,
        image: imageData || null,
        ts: Date.now(),
        recipientUid: null
      };

      try {
        await dbPush(dbRef(db, "messages"), msg);
        messageInput.value = '';
        fileInput.value = '';
      } catch (err) {
        console.error('dbPush error', err);
        alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è');
      }
    });
    messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendButton.click(); } });

    /* ----------------- Auth / Profile ----------------- */
    function showAuthModal(){ profileModal.classList.add('show'); profileModal.setAttribute('aria-hidden','false'); profileContent.innerHTML = authHtml(); attachAuthHandlers(); }
    function hideAuthModal(){ profileModal.classList.remove('show'); profileModal.setAttribute('aria-hidden','true'); }

    function authHtml(){ return `
      <h2>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è / –í—Ö—ñ–¥</h2>
      <div style="display:flex;gap:12px;flex-direction:column">
        <input id="uiNick" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" />
        <input id="uiEmail" placeholder="Email" />
        <input id="uiPass" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω. 6)" type="password" />
        <div style="display:flex;gap:8px;"><button id="uiRegister">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å</button><button id="uiLogin">–£–≤—ñ–π—Ç–∏</button></div>
        <div id="uiAuthMsg" style="color:#b91c1c"></div>
      </div>
    `; }

    function attachAuthHandlers(){
      document.getElementById('uiRegister').addEventListener('click', async ()=>{
        const nick = document.getElementById('uiNick').value.trim();
        const email = document.getElementById('uiEmail').value.trim();
        const pass = document.getElementById('uiPass').value.trim();
        const msgEl = document.getElementById('uiAuthMsg'); msgEl.textContent = '';
        if (!nick || !email || !pass) { msgEl.textContent = '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è'; return; }
        if (pass.length < 6) { msgEl.textContent = '–ü–∞—Ä–æ–ª—å –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤'; return; }
        try {
          const cred = await createUserWithEmailAndPassword(auth, email, pass);
          await updateProfile(cred.user, { displayName: nick, photoURL: DEFAULT_AVATAR });
          await dbSet(dbRef(db, `users/${cred.user.uid}`), { nick, email, avatar: DEFAULT_AVATAR, createdAt: Date.now(), online:true });
          localStorage.setItem('regTime_' + cred.user.uid, String(Date.now()));
          await sendEmailVerification(cred.user);
          hideAuthModal();
          alert('–ó–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ. –õ–∏—Å—Ç –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ. –£ –≤–∞—Å 6 –≥–æ–¥–∏–Ω –¥–æ—Å—Ç—É–ø—É –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è');
        } catch (e) { console.error(e); msgEl.textContent = e.message || String(e); }
      });

      document.getElementById('uiLogin').addEventListener('click', async ()=>{
        const email = document.getElementById('uiEmail').value.trim();
        const pass = document.getElementById('uiPass').value.trim();
        const msgEl = document.getElementById('uiAuthMsg'); msgEl.textContent = '';
        if (!email || !pass) { msgEl.textContent = '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è'; return; }
        try {
          await signInWithEmailAndPassword(auth, email, pass);
          hideAuthModal();
        } catch (e) { console.error(e); msgEl.textContent = e.message || String(e); }
      });
    }

    /* ----------------- canSendMessage: emailVerified OR within 6 hours ----------------- */
    async function canSendMessage(){
      const user = auth.currentUser;
      if (!user) return false;
      if (user.emailVerified) return true;
      const localKey = 'regTime_' + user.uid;
      const localVal = localStorage.getItem(localKey);
      const sixHours = 6 * 60 * 60 * 1000;
      if (localVal && (Date.now() - Number(localVal) < sixHours)) return true;
      try {
        const snap = await dbGet(dbRef(db, `users/${user.uid}/createdAt`));
        if (snap && snap.exists()) {
          const created = Number(snap.val());
          if (!Number.isNaN(created) && Date.now() - created < sixHours) {
            localStorage.setItem(localKey, String(created));
            return true;
          }
        }
      } catch (e) { console.error('canSendMessage db get error', e); }
      return false;
    }

    /* ----------------- Profile open / admin controls ----------------- */
    profileBtn.addEventListener('click', ()=> {
      if (!auth.currentUser) { showAuthModal(); return; }
      openProfile(auth.currentUser.uid, true);
    });
    profileClose.addEventListener('click', ()=> hideAuthModal());

    async function openProfile(uid, self=false){
      profileContent.innerHTML = '<p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>';
      profileModal.classList.add('show'); profileModal.setAttribute('aria-hidden','false');
      try {
        const snap = await dbGet(dbRef(db, `users/${uid}`));
        const user = snap && snap.exists() ? snap.val() : { nick: '–ê–Ω–æ–Ω—ñ–º', avatar: DEFAULT_AVATAR };
        const isSelf = auth.currentUser && auth.currentUser.uid === uid;
        const isAdminEmail = auth.currentUser && auth.currentUser.email === 'urciknikolaj642@gmail.com';
        profileContent.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center">
            <img id="profImg" src="${user.avatar || DEFAULT_AVATAR}" style="width:112px;height:112px;border-radius:12px;object-fit:cover">
            <div>
              <h3 style="margin:0">${user.nick || '–ê–Ω–æ–Ω—ñ–º'} ${isAdminEmail? '<span class="admin-badge">ADMIN</span>':''}</h3>
              <div style="color:#666">${user.email || ''}</div>
            </div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            ${isSelf ? '<button id="editAvatarBtn" class="small-btn">–ó–º—ñ–Ω–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä</button><button id="inboxBtn" class="small-btn">–û—Å–æ–±–∏—Å—Ç—ñ</button><button id="logoutBtn" class="small-btn">–í–∏–π—Ç–∏</button>' : `<button id="pmBtn" class="small-btn">–ù–∞–ø–∏—Å–∞—Ç–∏</button><button id="addFriendBtn" class="small-btn">–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>`}
          </div>
          <div id="profileMsg" style="margin-top:8px;color:#b91c1c"></div>
          <div id="adminPanel" style="margin-top:12px;display:${isAdminEmail ? 'block' : 'none'}"></div>
        `;

        // admin panel
        if (isAdminEmail) {
          const panel = document.getElementById('adminPanel');
          panel.innerHTML = `<h4>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h4>
            <div style="display:flex;gap:8px;align-items:center">
              <label>–ë–æ—Ç–∏:</label>
              <button id="toggleBotsBtn" class="small-btn">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</button>
              <button id="clearBotsBtn" class="small-btn">–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –±–æ—Ç—ñ–≤</button>
            </div>
            <div style="margin-top:8px;font-size:13px;color:#444">–¢–≤—ñ–π email: <strong>urciknikolaj642@gmail.com</strong></div>
          `;
          document.getElementById('clearBotsBtn').addEventListener('click', async ()=> {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –±–æ—Ç—ñ–≤?')) return;
            try {
              const bSnap = await dbGet(dbRef(db, 'messages'));
              if (!bSnap || !bSnap.exists()) { alert('–ù–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å'); return; }
              const all = bSnap.val();
              for (const key of Object.keys(all)) {
                const m = all[key];
                if (m && BOT_UIDS.includes(m.uid)) {
                  await dbRemove(dbRef(db, `messages/${key}`));
                }
              }
              alert('–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –±–æ—Ç—ñ–≤ –≤–∏–¥–∞–ª–µ–Ω–æ (–ø–æ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ).');
            } catch (e) { console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ'); }
          });
          const toggleBtn = document.getElementById('toggleBotsBtn');
          const sRef = dbRef(db, 'settings/botsEnabled');
          const sSnap = await dbGet(sRef);
          const current = sSnap && sSnap.exists() ? Boolean(sSnap.val()) : false;
          toggleBtn.textContent = current ? '–í–∏–º–∫–Ω—É—Ç–∏ –±–æ—Ç–∏' : '–£–≤—ñ–º–∫–Ω—É—Ç–∏ –±–æ—Ç–∏';
          toggleBtn.addEventListener('click', async ()=> {
            const newVal = !(await (async ()=> { const s = await dbGet(sRef); return s && s.exists() ? Boolean(s.val()) : false; })());
            try {
              await dbSet(sRef, newVal);
              toggleBtn.textContent = newVal ? '–í–∏–º–∫–Ω—É—Ç–∏ –±–æ—Ç–∏' : '–£–≤—ñ–º–∫–Ω—É—Ç–∏ –±–æ—Ç–∏';
              alert('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
            } catch (e) { console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è'); }
          });
        }

        if (isSelf) {
          document.getElementById('editAvatarBtn').addEventListener('click', ()=> {
            const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
            inp.addEventListener('change', async ()=> {
              const f = inp.files[0]; if (!f) return;
              try {
                const dataUrl = await resizeImageFile(f, 1000, 0.85);
                await dbSet(dbRef(db, `users/${uid}/avatar`), dataUrl);
                await updateProfile(auth.currentUser, { photoURL: dataUrl });
                document.getElementById('profImg').src = dataUrl;
                profileBtn.style.background = `url(${dataUrl}) center/cover`;
                alert('–ê–≤–∞—Ç–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ');
              } catch (e) { console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–≤–∞—Ç–∞—Ä–∞'); }
            });
            inp.click();
          });
          document.getElementById('inboxBtn').addEventListener('click', ()=> openInbox());
          document.getElementById('logoutBtn').addEventListener('click', async ()=> {
            try { await signOut(auth); alert('–í–∏ –≤–∏–π—à–ª–∏'); hideAuthModal(); } catch(e){ console.error(e); }
          });
        } else {
          document.getElementById('pmBtn').addEventListener('click', ()=> { profileModal.classList.remove('show'); startPrivateChat(uid); });
          document.getElementById('addFriendBtn').addEventListener('click', async ()=> {
            if (!auth.currentUser) { showAuthModal(); return; }
            try {
              await dbSet(dbRef(db, `friendRequests/${uid}/${auth.currentUser.uid}`), { from: auth.currentUser.uid, ts: Date.now(), nick: auth.currentUser.displayName||auth.currentUser.email });
              document.getElementById('profileMsg').textContent = '–ó–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ.';
            } catch (e) { document.getElementById('profileMsg').textContent = '–ü–æ–º–∏–ª–∫–∞'; console.error(e); }
          });
        }
      } catch (e) { profileContent.innerHTML = '<p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</p>'; console.error(e); }
    }

    /* ----------------- Notifications ----------------- */
    async function updateNotifications(){
      if (!auth.currentUser){ notifCount.style.display = 'none'; return; }
      try {
        const reqSnap = await dbGet(dbRef(db, `friendRequests/${auth.currentUser.uid}`));
        const reqCount = reqSnap && reqSnap.exists() ? Object.keys(reqSnap.val()).length : 0;
        const metaSnap = await dbGet(dbRef(db, `inboxMeta/${auth.currentUser.uid}/unread`));
        const unread = metaSnap && metaSnap.exists() ? Number(metaSnap.val()) : 0;
        const total = reqCount + unread;
        if (total > 0) { notifCount.style.display = 'block'; notifCount.textContent = String(total); } else notifCount.style.display = 'none';
      } catch (e) { console.error(e); }
    }
    notifBell.addEventListener('click', ()=> {
      if (!auth.currentUser) { showAuthModal(); return; }
      profileContent.innerHTML = '<h3>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h3><div id="notifList">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
      profileModal.classList.add('show'); profileModal.setAttribute('aria-hidden','false');
      (async ()=>{
        const list = document.getElementById('notifList');
        list.innerHTML = '';
        const rr = await dbGet(dbRef(db, `friendRequests/${auth.currentUser.uid}`));
        if (rr && rr.exists()) {
          const data = rr.val();
          for (const fromUid of Object.keys(data)) {
            const d = data[fromUid];
            const el = document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #eee';
            el.innerHTML = `–ó–∞–ø–∏—Ç –≤—ñ–¥ ${d.nick || d.from} ‚Äî <button data-from="${fromUid}">–ü—Ä–∏–π–Ω—è—Ç–∏</button> <button data-from2="${fromUid}">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>`;
            list.appendChild(el);
            el.querySelector('button[data-from]').addEventListener('click', async (e)=> {
              const from = e.target.dataset.from;
              try {
                await dbSet(dbRef(db, `friends/${auth.currentUser.uid}/${from}`), { ts: Date.now() });
                await dbSet(dbRef(db, `friends/${from}/${auth.currentUser.uid}`), { ts: Date.now() });
                await dbRemove(dbRef(db, `friendRequests/${auth.currentUser.uid}/${from}`));
                e.target.closest('div').remove();
                updateNotifications();
                alert('–î–æ–¥–∞–Ω–æ –≤ –¥—Ä—É–∑—ñ');
              } catch (ex) { console.error(ex); }
            });
            el.querySelector('button[data-from2]').addEventListener('click', async (e)=> {
              const from = e.target.dataset.from2;
              await dbRemove(dbRef(db, `friendRequests/${auth.currentUser.uid}/${from}`));
              e.target.closest('div').remove();
              updateNotifications();
            });
          }
        }
        const inbox = await dbGet(dbRef(db, `inboxMeta/${auth.currentUser.uid}`));
        if (inbox && inbox.exists()){
          const data = inbox.val();
          for (const convo in data) {
            if (convo === 'unread') continue;
            const el = document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #eee';
            el.textContent = `–ß–∞—Ç: ${convo} ‚Äî –æ—Å—Ç–∞–Ω–Ω—î: ${new Date(data[convo].lastTs).toLocaleString()}`;
            list.appendChild(el);
          }
        }
        if (list.innerHTML === '') list.innerHTML = '–ù–µ–º–∞—î —Å–ø–æ–≤—ñ—â–µ–Ω—å';
      })();
    });

    /* ----------------- Presence / online counter (√ó10) ----------------- */
    function updateOnlineCount(){
      onValue(dbRef(db, 'presence'), (snap)=>{
        const val = snap.val() || {};
        const real = Object.keys(val).length;
        const shown = real * 10;
        // find any element showing online count (we hid sys-msg) - put in notif bell tooltip also
        onlineCountEl && (onlineCountEl.textContent = shown);
        // also set title on bell for quick view
        notifBell && notifBell.setAttribute('title', '–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): ' + shown);
      });
    }

    /* ----------------- Auth state ----------------- */
    onAuthStateChanged(auth, (user)=> {
      currentUser = user;
      if (user) {
        profileBtn.style.background = `url(${user.photoURL || DEFAULT_AVATAR}) center/cover`;
        try { dbSet(dbRef(db, `presence/${user.uid}`), { ts: Date.now(), nick: user.displayName || user.email }); } catch(e){}
      } else {
        profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`;
      }
      updateNotifications();
      updateOnlineCount();
    });
    window.addEventListener('beforeunload', async ()=> { try{ if (auth.currentUser) await dbRemove(dbRef(db, `presence/${auth.currentUser.uid}`)); }catch(e){} });

    /* ----------------- Private messages basics ----------------- */
    async function startPrivateChat(otherUid){
      if (!auth.currentUser) { showAuthModal(); return; }
      const uid = auth.currentUser.uid;
      const convoId = uid < otherUid ? uid + '_' + otherUid : otherUid + '_' + uid;
      // open modal with compose and recent messages
      profileContent.innerHTML = '<h3>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó...</h3>';
      profileModal.classList.add('show'); profileModal.setAttribute('aria-hidden','false');
      try {
        const msgsSnap = await dbGet(dbRef(db, `privateMessages/${convoId}`));
        const listHtml = document.createElement('div');
        listHtml.style.maxHeight = '50vh';
        listHtml.style.overflow = 'auto';
        listHtml.style.padding = '8px';
        if (msgsSnap && msgsSnap.exists()) {
          const data = msgsSnap.val();
          for (const k of Object.keys(data)) {
            const m = data[k];
            const el = document.createElement('div');
            el.style.padding = '6px';
            el.style.borderBottom = '1px solid #eee';
            el.innerHTML = `<strong>${m.fromNick||m.from}</strong> ‚Ä¢ ${new Date(m.ts).toLocaleString()}<div>${m.text||''}</div>`;
            listHtml.appendChild(el);
          }
        } else {
          listHtml.innerHTML = '<div style="padding:8px;color:#666">–¢—É—Ç –ø–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</div>';
        }
        profileContent.innerHTML = `<h3>–û—Å–æ–±–∏—Å—Ç—ñ ‚Äî ${convoId}</h3>`;
        profileContent.appendChild(listHtml);
        const compose = document.createElement('div');
        compose.style.marginTop = '10px';
        compose.innerHTML = `<textarea id="pmText" style="width:100%;height:110px;padding:8px;border:1px solid #ddd;border-radius:8px" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."></textarea><div style="display:flex;gap:8px;margin-top:8px"><button id="pmSend" class="send-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button><button id="pmCancel" class="small-btn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button></div>`;
        profileContent.appendChild(compose);
        document.getElementById('pmCancel').addEventListener('click', ()=> { profileModal.classList.remove('show'); });
        document.getElementById('pmSend').addEventListener('click', async ()=> {
          const text = document.getElementById('pmText').value.trim(); if (!text) return alert('–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç');
          const pm = { from: uid, to: otherUid, text, ts: Date.now(), fromNick: auth.currentUser.displayName || auth.currentUser.email };
          try {
            await dbPush(dbRef(db, `privateMessages/${convoId}`), pm);
            const prev = await dbGet(dbRef(db, `inboxMeta/${otherUid}/unread`)); const cur = prev && prev.exists() ? Number(prev.val()) : 0;
            await dbSet(dbRef(db, `inboxMeta/${otherUid}/unread`), cur + 1);
            await dbSet(dbRef(db, `inboxMeta/${otherUid}/${convoId}`), { lastTs: Date.now(), lastFrom: uid });
            updateNotifications();
            alert('–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ');
            profileModal.classList.remove('show');
          } catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏'); }
        });
      } catch(e){ console.error(e); profileContent.innerHTML = '<div>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div>'; }
    }

    async function openInbox(){
      if (!auth.currentUser) { showAuthModal(); return; }
      profileContent.innerHTML = '<h3>–û—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</h3><div id="inboxList">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
      profileModal.classList.add('show'); profileModal.setAttribute('aria-hidden','false');
      const inboxList = document.getElementById('inboxList');
      try {
        const snap = await dbGet(dbRef(db, `inboxMeta/${auth.currentUser.uid}`));
        const data = snap && snap.exists() ? snap.val() : {};
        inboxList.innerHTML = '';
        for (const k in data) {
          if (k === 'unread') continue;
          const el = document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #eee';
          el.textContent = `${k} ‚Äî –æ—Å—Ç–∞–Ω–Ω—î: ${new Date(data[k].lastTs).toLocaleString()}`;
          el.addEventListener('click', ()=> { startPrivateChat(k.includes('_') ? (k.split('_')[0] === auth.currentUser.uid ? k.split('_')[1] : k.split('_')[0]) : k); });
          inboxList.appendChild(el);
        }
        if (!inboxList.children.length) inboxList.innerHTML = '–ü—É—Å—Ç–æ';
      } catch(e) { inboxList.innerHTML = '–ü–æ–º–∏–ª–∫–∞'; console.error(e); }
    }

    /* ----------------- Message menu ----------------- */
    const msgMenu = document.getElementById('msgMenu');
    function showMsgMenu(x,y,msg,wrap){
      msgMenu.style.left = x + 'px'; msgMenu.style.top = y + 'px'; msgMenu.style.display = 'block';
      const hide = ()=>{ msgMenu.style.display = 'none'; document.removeEventListener('click', hide); };
      document.addEventListener('click', hide, { once:true });
      msgMenu.querySelectorAll('button').forEach(btn=>{
        btn.onclick = async ()=>{
          const act = btn.dataset.act;
          try {
            if (act === 'reply') {
              const r = prompt('–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:');
              if (r) {
                await dbPush(dbRef(db, 'messages'), {
                  uid: auth.currentUser.uid,
                  nick: auth.currentUser.displayName || auth.currentUser.email,
                  avatar: auth.currentUser.photoURL || DEFAULT_AVATAR,
                  text: '‚Ü™Ô∏è –í—ñ–¥–ø–æ–≤—ñ–¥—å: ' + r,
                  ts: Date.now(),
                  recipientUid: msg.uid
                });
              }
            } else {
              if (!msg.id) { alert('–ù–µ–º–∞—î id –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è'); return; }
              await dbSet(dbRef(db, `messageReactions/${msg.id}/${auth.currentUser?auth.currentUser.uid:'anon'}`), { act, ts: Date.now() });
              alert('–î—ñ—è: ' + act);
            }
          } catch (e) { console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –¥—ñ—ó'); }
        };
      });
    }

    /* ===================== BOTS ===================== */
    // BOT_UIDS is used for admin clear action and detection
    const BOT_UIDS = ['bot_1_pf','bot_2_pf','bot_3_pf'];

    const BOT_USERS = [
      {
        uid: 'bot_1_pf',
        nick: 'Oleh S.',
        avatar: 'https://i.ibb.co/LH4wBMS/IMG-d8e6076e17f19db7fe3add0754738a01-V.jpg',
        ads: [
          { text: `O2 –°–Ü–ú –ö–ê–†–¢–ê\n–ë–µ–∑ –ªi–ºi—Ç —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç\n–ë–µ–∑ –ªi–ºi—Ç –¥–∑–≤—ñ–Ω–∫–∏\n–ü—Ä–∞—Ü—é—î –≤ –Ñ–≤—Ä–æ–ø—ñ\n–ü–ª–∞—Ç–∞ 699 –∫—Ä–æ–Ω/–º—ñ—Å. –¶—ñ–Ω–∞ 299–∫c. –¢–µ–ª: 607914467. Viber/WhatsApp/Telegram.`, image: null },
          { text: `–î–æ–±—Ä–æ–≥–æ –¥–Ω—è! –ü—Ä–æ–¥–∞—é iPhone 11 Pro Max –∑ —á–æ—Ö–ª–∞–º–∏. –ü–∏—Ç–∞–Ω–Ω—è –≤ –ø—Ä–∏–≤–∞—Ç.`, image: 'https://i.ibb.co/dwcXPqDr/IMG-1954f6b56869b9817a131ae33f3a37b6-V.jpg' },
          { text: null, image: 'https://i.ibb.co/G3kDcrYZ/IMG-fa590121e46c5b030c5ddc94d4e8bea9-V.jpg' }
        ],
      },
      {
        uid: 'bot_2_pf',
        nick: 'Anna M.',
        avatar: 'https://i.ibb.co/QFWDvGZ8/IMG-6748e7141906901b131b8fd5130a5c01-V.jpg',
        ads: [
          { text: `–ó–∞–ø—Ä–æ—à—É—é –º–æ–¥–µ–ª–µ–π –Ω–∞ –ø–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω–∏–π –º–∞–∫—ñ—è–∂ –≤—ñ–¥ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ–≥–æ –º–∞–π—Å—Ç—Ä–∞.\nüìç–ü—Ä–∞–≥–∞\nüìÖ –î–∞—Ç–∞ –≤ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—ñ.`, image: 'https://i.ibb.co/QFWDvGZ8/IMG-6748e7141906901b131b8fd5130a5c01-V.jpg' },
          { text: `–§–æ—Ç–æ –ø—Ä–∏–∫–ª–∞–¥ ‚Äî –¥–µ—Ç–∞–ª—ñ –≤ –ø—Ä–∏–≤–∞—Ç—ñ.`, image: 'https://i.ibb.co/j97RhTny/IMG-593d75b053ea1a28cdfb9fc52f93afad-V.jpg' },
          { text: null, image: 'https://i.ibb.co/Z11WVrVC/IMG-b83692bb79a1468af74c81620750e8c0-V.jpg' }
        ]
      },
      {
        uid: 'bot_3_pf',
        nick: 'Marek H.',
        avatar: 'https://i.ibb.co/rfNV6ddC/IMG-0cd648a74f86227fe46db2d01c099be0-V.jpg',
        ads: [
          { text: `–ù—É–∂–µ–Ω –≤–æ–¥–∏—Ç–µ–ª—å –¥–ª—è –ø–æ–º–æ—â–∏ –≤ –ø–µ—Ä–µ–µ–∑–¥–µ, —Å–æ —Å–≤–æ–∏–º –∞–≤—Ç–æ, –ø–∏—à–∏—Ç–µ –Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç—ã, –æ–±–≥–æ–≤–æ—Ä–∏–º –¥–µ—Ç–∞–ª—ñ. WhatsApp: +48 793 463 757`, image: null },
          { text: null, image: 'https://i.ibb.co/MzdTMPR/IMG-8231d8142ffcbba7c682ca598683e3f2-V.jpg' },
          { text: null, image: 'https://i.ibb.co/rfNV6ddC/IMG-0cd648a74f86227fe46db2d01c099be0-V.jpg' }
        ]
      }
    ];

    // schedule: 2min, 3min, 4min
    const SCHEDULE = [
      { botIdx: 0, wait: 2*60*1000 },
      { botIdx: 1, wait: 3*60*1000 },
      { botIdx: 2, wait: 4*60*1000 }
    ];

    let botsController = { enabled: false, loopTimerId: null, running: false, seqPos: 0 };

    const botsEnabledRef = dbRef(db, 'settings/botsEnabled');
    onValue(botsEnabledRef, (snap) => {
      const val = snap && snap.exists() ? Boolean(snap.val()) : false;
      botsController.enabled = val;
      if (val && !botsController.running) startBotsLoop();
      if (!val && botsController.running) stopBotsLoop();
    });

    function startBotsLoop(){
      if (botsController.running) return;
      botsController.running = true;
      botsController.seqPos = 0;
      localStorage.setItem('pf_bots_running', '1');
      (async function seqLoop(){
        if (!botsController.enabled) { botsController.running = false; localStorage.removeItem('pf_bots_running'); return; }
        const s = SCHEDULE[botsController.seqPos % SCHEDULE.length];
        const bot = BOT_USERS[s.botIdx];
        const adIndex = Math.floor(Date.now() / (60 * 1000)) % bot.ads.length;
        const ad = bot.ads[adIndex];
        // re-check flag
        const snap = await dbGet(dbRef(db, 'settings/botsEnabled'));
        const stillEnabled = snap && snap.exists() ? Boolean(snap.val()) : false;
        if (!stillEnabled) { botsController.running = false; localStorage.removeItem('pf_bots_running'); return; }
        try {
          await dbPush(dbRef(db, 'messages'), {
            uid: bot.uid,
            nick: bot.nick,
            avatar: bot.avatar,
            text: ad.text,
            image: ad.image || null,
            ts: Date.now()
          });
        } catch (e) { console.error('bot push err', e); }
        botsController.seqPos++;
        botsController.loopTimerId = setTimeout(seqLoop, s.wait);
      })();
    }

    function stopBotsLoop(){
      if (botsController.loopTimerId) clearTimeout(botsController.loopTimerId);
      botsController.running = false;
      localStorage.removeItem('pf_bots_running');
      botsController.loopTimerId = null;
    }

    (async ()=> {
      const s = await dbGet(botsEnabledRef);
      const enabled = s && s.exists() ? Boolean(s.val()) : false;
      botsController.enabled = enabled;
      if (enabled) startBotsLoop();
    })();

    /* =================== Google Maps =================== */
    const MAP_POINTS = [
      { title:'Nemocnice Motol', pos:{lat:50.058, lng:14.360}, img:'https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp' },
      { title:'Pravni pomoc', pos:{lat:50.083, lng:14.412}, img:'https://i.ibb.co/0gWD5wW/images-5.jpg' },
      { title:'Ukrainske sklepy', pos:{lat:50.084, lng:14.417}, img:'https://i.ibb.co/R49shL6k/images-6.jpg' }
    ];

    window.initMap = function(){
      try {
        const center = { lat:50.0755, lng:14.4378 };
        window.map = new google.maps.Map(mapEl, { center, zoom:13, gestureHandling:'greedy' });
        window.markers = [];
        MAP_POINTS.forEach(p=>{
          const marker = new google.maps.Marker({ position: p.pos, map: window.map, title: p.title });
          const content = `<div style="width:220px"><strong>${p.title}</strong><div><img src='${p.img}' style='width:100%;border-radius:6px;margin-top:6px'></div></div>`;
          const inf = new google.maps.InfoWindow({ content });
          marker.addListener('click', ()=> inf.open(window.map, marker));
          window.markers.push(marker);
        });
        centerBtn.addEventListener('click', ()=> window.map.panTo(center));
        mapSearch.addEventListener('input', (e)=> {
          const q = e.target.value.trim().toLowerCase();
          window.markers.forEach(mk => mk.setVisible(!q || mk.title.toLowerCase().includes(q)));
        });
      } catch(e){ console.error('initMap', e); }
    };

    async function loadMapsWithKey(){
      const key = 'AIzaSyBFrxVhpb6nHJ6rhiLl5Ho8t0jOb1iEQNc'; // your key inserted
      if (!key) return;
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&callback=initMap`;
      script.async = true; script.defer = true;
      document.head.appendChild(script);
    }

    /* ---------------- misc ---------------- */
    setInterval(()=> updateNotifications(), 8000);
    updateOnlineCount();
    document.addEventListener('DOMContentLoaded', ()=> { profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`; loadMapsWithKey(); });

    // Friends UI
    friendsBtn && friendsBtn.addEventListener('click', ()=> openFriends());

    async function openFriends(){
      if (!auth.currentUser) { showAuthModal(); return; }
      profileContent.innerHTML = '<h3>–î—Ä—É–∑—ñ —Ç–∞ –∑–∞—è–≤–∫–∏</h3><div id="friendsList">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
      profileModal.classList.add('show'); profileModal.setAttribute('aria-hidden','false');
      const list = document.getElementById('friendsList'); list.innerHTML = '';
      try {
        const reqSnap = await dbGet(dbRef(db, `friendRequests/${auth.currentUser.uid}`));
        const reqs = reqSnap && reqSnap.exists() ? reqSnap.val() : {};
        if (Object.keys(reqs).length) {
          const h = document.createElement('div'); h.innerHTML = '<strong>–ó–∞—è–≤–∫–∏:</strong>'; list.appendChild(h);
          for (const from of Object.keys(reqs)){
            const d = reqs[from]; const el = document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #eee';
            el.innerHTML = `${d.nick||d.from} ‚Äî <button data-acc='${from}' class='small-btn accept'>–ü—Ä–∏–π–Ω—è—Ç–∏</button> <button data-rej='${from}' class='small-btn reject'>–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>`;
            list.appendChild(el);
            el.querySelector('.accept').addEventListener('click', async (e)=>{ const f = e.target.dataset.acc; await dbSet(dbRef(db, `friends/${auth.currentUser.uid}/${f}`), {ts:Date.now()}); await dbSet(dbRef(db, `friends/${f}/${auth.currentUser.uid}`), {ts:Date.now()}); await dbRemove(dbRef(db, `friendRequests/${auth.currentUser.uid}/${f}`)); e.target.closest('div').remove(); updateNotifications(); });
            el.querySelector('.reject').addEventListener('click', async (e)=>{ const f = e.target.dataset.rej; await dbRemove(dbRef(db, `friendRequests/${auth.currentUser.uid}/${f}`)); e.target.closest('div').remove(); updateNotifications(); });
          }
        }
        const friendsSnap = await dbGet(dbRef(db, `friends/${auth.currentUser.uid}`));
        const friends = friendsSnap && friendsSnap.exists() ? Object.keys(friendsSnap.val()) : [];
        const fh = document.createElement('div'); fh.innerHTML = '<strong>–î—Ä—É–∑—ñ:</strong>'; list.appendChild(fh);
        if (friends.length===0) { const empty = document.createElement('div'); empty.textContent='–ü–æ–∫–∏ –Ω–µ–º–∞—î –¥—Ä—É–∑—ñ–≤'; list.appendChild(empty); }
        for (const f of friends){
          const userSnap = await dbGet(dbRef(db, `users/${f}`)); const u = userSnap && userSnap.exists() ? userSnap.val() : {nick:'–ê–Ω–æ–Ω—ñ–º'};
          const el = document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #eee';
          el.innerHTML = `<img src='${u.avatar||DEFAULT_AVATAR}' style='width:36px;height:36px;border-radius:50%;vertical-align:middle;margin-right:8px'> <strong>${u.nick||f}</strong> <button data-uid='${f}' class='small-btn' style='margin-left:8px'>–ù–∞–ø–∏—Å–∞—Ç–∏</button> <span style='float:right;color:#666' id='online_${f}'>...</span>`;
          list.appendChild(el);
          el.querySelector('button').addEventListener('click', ()=> startPrivateChat(f));
          const presSnap = await dbGet(dbRef(db, `presence/${f}`)); if (presSnap && presSnap.exists()){ document.getElementById('online_'+f).textContent = '–æ–Ω–ª–∞–π–Ω'; } else document.getElementById('online_'+f).textContent = '–æ—Ñ–ª–∞–π–Ω';
        }
      } catch(e){ list.innerHTML='–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è'; console.error(e); }
    }

    // expose debug actions
    window.PF = { startBotsLoop, stopBotsLoop, loadMapsWithKey, BOT_USERS, BOT_UIDS };

  </script>

  <!-- Auto-load Google Maps with key (inserted above) - the script is appended dynamically -->
  <!-- End of HTML -->
</body>
</html>
