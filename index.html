<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Praha Fu≈°ky ‚Äî —Å–æ—Ü—á–∞—Ç</title>

  <!-- –®—Ä–∏—Ñ—Ç–∏ -->
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="css/style.css"/>
</head>
<body>
  <!-- HEADER -->
  <header class="pf-header">
    <div class="brandRow">
      <button id="profileBtn" class="profile-btn" title="–ü—Ä–æ—Ñ—ñ–ª—å" aria-label="–ü—Ä–æ—Ñ—ñ–ª—å"></button>
      <h1>PRAHA FU≈†KY</h1>
      <button id="adminBtn" class="members-btn" title="–ê–¥–º—ñ–Ω" aria-label="–ê–¥–º—ñ–Ω">üë•</button>
      <button id="bellBtn" class="bell-btn" title="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è" aria-label="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è">üîî<span id="bellBadge" class="bell-badge">0</span></button>
    </div>
  </header>

  <!-- TABS -->
  <div class="topBar">
    <div class="neon-wrap">
      <nav class="neon-tabs" role="tablist" aria-label="–í–∫–ª–∞–¥–∫–∏">
        <button class="tab-button active" data-target="chatTab">üí¨ –ß–∞—Ç</button>
        <button class="tab-button" data-target="rentTab">üè† –û—Ä–µ–Ω–¥–∞</button>
        <button class="tab-button" data-target="mapTab">üó∫Ô∏è –ö–∞—Ä—Ç–∞</button>
        <button class="tab-button" data-target="friendsTab">üë• –î—Ä—É–∑—ñ</button>
        <button class="tab-button dm" data-target="dmTab">‚úâÔ∏è –û—Å–æ–±–∏—Å—Ç—ñ</button>
        <button class="tab-button" data-target="helpTab">üÜò –î–æ–ø–æ–º–æ–≥–∞</button>
        <button class="tab-button" data-target="payTab">üí≥ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –æ–ø–ª–∞—Ç</button>
        <button class="tab-button" data-target="peopleTab">üìã –£—á–∞—Å–Ω–∏–∫–∏</button>
      </nav>
      <div class="online-neon" id="onlineNeon">–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): 0</div>
    </div>
  </div>

  <main class="container" role="main">
    <!-- CHAT -->
    <section id="chatTab" class="tab-content active" role="region" aria-label="–ß–∞—Ç">
      <div class="chat-wallpaper" aria-hidden="true"></div>

      <div class="chat-area" id="chatArea" aria-live="polite">
        <div id="messages" class="messages" role="log"></div>
      </div>

      <input id="fileInput" type="file" accept="image/*" style="display:none"/>
      <div class="chat-input" role="region" aria-label="–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">
        <label for="fileInput" class="camera-btn" id="cameraLabel" title="–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ –≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (–ø–æ—Å–∏–ª–∞–Ω–Ω—è/—Ñ–∞–π–ª)">üì∑</label>
        <input id="messageInput" type="text" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." aria-label="–¢–µ–∫—Å—Ç"/>
        <button id="sendButton" class="send-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
      </div>

      <div id="photoToast" class="photo-toast">‚úîÔ∏è –§–æ—Ç–æ –¥–æ–¥–∞–Ω–æ. –í—ñ–¥–ø—Ä–∞–≤—Ç–µ ‚Äî –∑‚Äô—è–≤–∏—Ç—å—Å—è —É —Å—Ç—Ä—ñ—á—Ü—ñ.</div>
    </section>

    <!-- RENT -->
    <section id="rentTab" class="tab-content" role="region" aria-label="–û—Ä–µ–Ω–¥–∞">
      <div class="chat-wallpaper" aria-hidden="true"></div>

      <div class="chat-area" id="rentArea">
        <div id="rentMessages" class="messages" role="log"></div>
      </div>

      <input id="rentFileInput" type="file" accept="image/*" style="display:none"/>
      <div class="chat-input" role="region" aria-label="–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è">
        <label for="rentFileInput" class="camera-btn" title="–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ">üì∑</label>
        <input id="rentMessageInput" type="text" placeholder="–û–≥–æ–ª–æ—à–µ–Ω–Ω—è..."/>
        <button id="rentSendButton" class="send-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
      </div>

      <div id="rentPhotoToast" class="photo-toast">‚úîÔ∏è –§–æ—Ç–æ –¥–æ–¥–∞–Ω–æ. –í—ñ–¥–ø—Ä–∞–≤—Ç–µ ‚Äî –∑‚Äô—è–≤–∏—Ç—å—Å—è —É —Å—Ç—Ä—ñ—á—Ü—ñ.</div>
    </section>

    <!-- MAP -->
    <section id="mapTab" class="tab-content" role="region" aria-label="–ö–∞—Ä—Ç–∞">
      <div class="map-tools">
        <input id="mapSearch" placeholder="–ü–æ—à—É–∫ (–≤–æ–ª–æ–Ω—Ç–µ—Ä–∏, –∞–ø—Ç–µ–∫–∞‚Ä¶)" />
        <button class="tab-button" data-f="all">–£—Å–µ</button>
        <button class="tab-button" data-f="volunteer">–í–æ–ª–æ–Ω—Ç–µ—Ä–∏</button>
        <button class="tab-button" data-f="aid">–î–æ–ø–æ–º–æ–≥–∞</button>
        <button class="tab-button" data-f="pharmacy">–ê–ø—Ç–µ–∫–∏</button>
        <button id="centerBtn" class="tab-button">–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏</button>
      </div>
      <div id="map"></div>
    </section>

    <!-- FRIENDS -->
    <section id="friendsTab" class="tab-content" role="region" aria-label="–î—Ä—É–∑—ñ">
      <h2 class="pill-title">–ó–∞—è–≤–∫–∏ —Ç–∞ –¥—Ä—É–∑—ñ</h2>
      <div class="friends-wrap">
        <div>
          <h3>–ó–∞—è–≤–∫–∏</h3>
          <div id="friendRequests"></div>
        </div>
        <div>
          <h3>–ú–æ—ó –¥—Ä—É–∑—ñ (<span id="friendsOnlineCount">0</span> –æ–Ω–ª–∞–π–Ω)</h3>
          <div id="friendsList"></div>
        </div>
      </div>
    </section>

    <!-- DM -->
    <section id="dmTab" class="tab-content" role="region" aria-label="–û—Å–æ–±–∏—Å—Ç—ñ">
      <h2 class="pill-title">–ú–æ—ó –¥—ñ–∞–ª–æ–≥–∏</h2>
      <div id="dmList" class="dm-grid"></div>
    </section>

    <!-- HELP -->
    <section id="helpTab" class="tab-content" role="region" aria-label="–î–æ–ø–æ–º–æ–≥–∞">
      <h2 class="pill-title">–¢–µ—Ä–º—ñ–Ω–æ–≤–∞ –¥–æ–ø–æ–º–æ–≥–∞ —É –ü—Ä–∞–∑—ñ</h2>
      <div id="helpGrid" class="help-grid"></div>
    </section>

    <!-- PAY CONFIRMATIONS -->
    <section id="payTab" class="tab-content" role="region" aria-label="–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –æ–ø–ª–∞—Ç">
      <h2 class="pill-title">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –æ–ø–ª–∞—Ç</h2>
      <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr">
        <div style="background:#fff;border-radius:10px;padding:12px">
          <h3 style="margin:0 0 8px">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è (URL —Å–∫—Ä—ñ–Ω—à–æ—Ç—É)</h3>
          <input id="payImgUrl" placeholder="https://...jpg" style="width:100%;padding:10px;border-radius:10px;border:1px solid #ddd"/>
          <button id="paySend" class="tab-button" style="margin-top:8px">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
          <div id="paySendMsg" class="error" style="display:none"></div>
        </div>
        <div id="payInboxMine" style="background:#fff;border-radius:10px;padding:12px;max-height:48vh;overflow:auto">
          <h3 style="margin:0 0 8px">–ú–æ—ó –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è</h3>
          <div id="myPays"></div>
        </div>
      </div>

      <div id="payAdminBox" style="margin-top:12px;display:none;background:#fff;border-radius:10px;padding:12px">
        <h3 style="margin:0 0 8px">–ê–¥–º—ñ–Ω: –≤—Ö—ñ–¥–Ω—ñ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h3>
        <div id="payInboxAll" style="max-height:50vh;overflow:auto"></div>
      </div>
    </section>

    <!-- PEOPLE (ADMIN) -->
    <section id="peopleTab" class="tab-content" role="region" aria-label="–£—á–∞—Å–Ω–∏–∫–∏">
      <h2 class="pill-title">–£—á–∞—Å–Ω–∏–∫–∏ (–∞–¥–º—ñ–Ω)</h2>
      <div id="peopleGrid" class="help-grid"></div>
    </section>
  </main>

  <!-- MODALS -->
  <div id="bellModal" class="modal">
    <div class="panel">
      <button class="close" id="bellClose">‚úñ</button>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h3>
        <button id="notifClearAll" class="tab-button danger">–û—á–∏—Å—Ç–∏—Ç–∏</button>
      </div>
      <div id="notifList"></div>
    </div>
  </div>

  <div id="profileModal" class="modal">
    <div class="panel">
      <button class="close" id="profileClose">‚úñ</button>
      <div id="profileContent"></div>
    </div>
  </div>

  <div id="authModal" class="modal">
    <div class="panel">
      <button class="close" id="modalClose">‚úñ</button>
      <h2>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è / –í—Ö—ñ–¥</h2>
      <p style="margin:6px 0;color:#374151;font-size:13px">–ü—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –ª–∏—Å—Ç –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –º–æ–∂–µ –ø–æ—Ç—Ä–∞–ø–∏—Ç–∏ –≤ ¬´–°–ø–∞–º¬ª ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ.</p>
      <form id="registerForm" onsubmit="return false;">
        <input id="nickInput" type="text" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" required />
        <input id="emailInput" type="email" placeholder="Email" required />
        <input id="passwordInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω. 6)" required />
        <div class="row" style="display:flex;gap:8px;margin-top:8px">
          <button id="registerSubmit" type="button" class="tab-button">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
          <button id="loginShow"    type="button" class="tab-button alt">–£–≤—ñ–π—Ç–∏</button>
        </div>
        <div id="regError" class="error"></div>
      </form>

      <form id="loginForm" style="display:none" onsubmit="return false;">
        <input id="loginEmail" type="email" placeholder="Email" required />
        <input id="loginPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" required />
        <div class="row" style="display:flex;gap:8px;margin-top:8px">
          <button id="loginSubmit"   type="button" class="tab-button">–£–≤—ñ–π—Ç–∏</button>
          <button id="backToRegister"type="button" class="tab-button alt">–ù–∞–∑–∞–¥</button>
        </div>
        <div id="loginError" class="error"></div>
      </form>
    </div>
  </div>

  <div id="soundModal" class="modal">
    <div class="panel">
      <button class="close" id="soundClose">‚úñ</button>
      <h3 style="margin-top:0">–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫ —Å–ø–æ–≤—ñ—â–µ–Ω—å?</h3>
      <p>–†—ñ–∑–Ω—ñ –∑–≤—É–∫–∏ –¥–ª—è —á–∞—Ç—É, –õ–°, –∑–∞—è–≤–æ–∫ —É –¥—Ä—É–∑—ñ.</p>
      <div style="display:flex;gap:8px">
        <button id="soundEnable" class="tab-button">üîä –£–≤—ñ–º–∫–Ω—É—Ç–∏</button>
        <button id="soundLater" class="tab-button alt">–ü—ñ–∑–Ω—ñ—à–µ</button>
      </div>
    </div>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="modal">
    <div class="panel">
      <button class="close" id="adminClose">‚úñ</button>
      <h3 style="margin-top:0">–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h3>
      <div class="admin-grid">
        <section>
          <h4>–¢–µ–º–∞ —Å–∞–π—Ç—É</h4>
          <label>URL –æ–±–æ—ó–≤: <input id="wallUrlInput" placeholder="https://...jpg"/></label>
          <div class="row" style="display:flex;gap:8px;margin-top:8px">
            <button id="wallSave" class="tab-button">–ó–±–µ—Ä–µ–≥—Ç–∏ –¥–ª—è –≤—Å—ñ—Ö</button>
            <button id="wallApplyLocal" class="tab-button alt">–¢—ñ–ª—å–∫–∏ –º–µ–Ω—ñ</button>
          </div>
        </section>

        <section>
          <h4>–ó–≤—É–∫–∏</h4>
          <div style="display:grid;gap:6px">
            <label>–ß–∞—Ç (–≤—Ö—ñ–¥): <input id="sndChat" placeholder="URL .mp3/.wav"/></label>
            <label>–õ–° (–≤—Ö—ñ–¥): <input id="sndDM" placeholder="URL .mp3/.wav"/></label>
            <label>–ó–∞—è–≤–∫–∞ –≤ –¥—Ä—É–∑—ñ: <input id="sndFriend" placeholder="URL .mp3/.wav"/></label>
            <label>–°–∏—Å—Ç–µ–º–Ω–∏–π: <input id="sndSystem" placeholder="URL .mp3/.wav"/></label>
            <button id="sndSave" class="tab-button" style="margin-top:4px">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
          </div>
        </section>

        <section>
          <h4>–õ—ñ–º—ñ—Ç–∏ (–∑–∞ –∑–∞–º–æ–≤—á.)</h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <label>–¢–µ–∫—Å—Ç –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ: <input id="defText" type="number" min="0" value="200"/></label>
            <label>–§–æ—Ç–æ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ: <input id="defPhoto" type="number" min="0" value="100"/></label>
          </div>
          <p style="font-size:12px;color:#374151">Role <b>employer</b> ‚Äî –ø–∏—à–µ –≤—Å—ñ–º (—Ç–µ–∫—Å—Ç –±–µ–∑ –ª—ñ–º—ñ—Ç—ñ–≤), —Ñ–æ—Ç–æ ‚Äî –∑–∞ –ª—ñ–º—ñ—Ç–æ–º; <b>seeker</b> ‚Äî –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ –¥–æ —à—É–∫–∞—á—ñ–≤, —Ä–æ–±–æ—Ç–æ–¥–∞–≤—Ü—è–º ‚Äî –ø–ª–∞—Ç–Ω–æ/–ø—Ä–µ–º—ñ—É–º.</p>
          <button id="limitsSave" class="tab-button">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </section>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- Firebase config (—Ç–≤–æ—è) -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
      authDomain: "praga-4baee.firebaseapp.com",
      databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
      projectId: "praga-4baee",
      storageBucket: "praga-4baee.firebasestorage.app",
      messagingSenderId: "336023952536",
      appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
      measurementId: "G-BGDJD6R12N"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.database();
  </script>

  <!-- APP -->
  <script>
  // ====== UI Tabs / helpers ======
  const $ = s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const onlineNeon = $('#onlineNeon');
  const tabButtons = $$('.tab-button'); const tabContents = $$('.tab-content');
  function setActiveTab(id){
    tabButtons.forEach(b=>b.classList.toggle('active', b.dataset.target===id));
    tabContents.forEach(c=> c.style.display = (c.id===id)?'block':'none');
    if(id==='mapTab') initMapOnce();
  }
  tabButtons.forEach(b=> b.addEventListener('click', ()=> setActiveTab(b.dataset.target)));

  // ====== Sounds (URLs –≤ settings/sounds) ======
  const SND = {
    enabled:false, aud:{},
    async loadAll(){
      const snap = await db.ref('settings/sounds').get();
      const v = snap.val()||{};
      const def = {
        chat:    v.chat    || 'https://cdn.pixabay.com/audio/2022/03/15/audio_0b2b3c.mp3',
        dm:      v.dm      || 'https://cdn.pixabay.com/audio/2022/03/15/audio_7a1f03.mp3',
        friend:  v.friend  || 'https://cdn.pixabay.com/audio/2022/03/15/audio_ba2b64.mp3',
        system:  v.system  || 'https://cdn.pixabay.com/audio/2022/03/15/audio_5a5a1e.mp3'
      };
      for(const k of Object.keys(def)){
        const a=new Audio(def[k]); a.preload='auto'; SND.aud[k]=a;
      }
    },
    play(k){ if(!SND.enabled) return; try{ SND.aud[k]?.currentTime=0; SND.aud[k]?.play(); }catch{} }
  };

  // ====== Wallpaper (settings/theme/wallUrl) ======
  const DEFAULT_WALL = "https://i.ibb.co/pr18RzG3/charles-bridge-prague.jpg";
  function applyWallpaper(url){ document.documentElement.style.setProperty('--wall-url', `url("${url||DEFAULT_WALL}")`); }
  db.ref('settings/theme/wallUrl').on('value', s=> applyWallpaper(s.val()||DEFAULT_WALL));

  // ====== Guest 30 min/day read ======
  function allowGuestReadNow(){
    const key = 'guest_read';
    const now = Date.now();
    const obj = JSON.parse(localStorage.getItem(key)||'{}');
    const day = new Date().toDateString();
    if(obj.day!==day){ localStorage.setItem(key, JSON.stringify({day, start: now})); return true; }
    if(!obj.start){ localStorage.setItem(key, JSON.stringify({day, start: now})); return true; }
    const used = now - obj.start;
    return used <= 30*60*1000; // 30 —Ö–≤
  }
  function ensureAuthOrGuest(){
    if(auth.currentUser) return true;
    if(allowGuestReadNow()) return true;
    showAuth(); return false;
  }

  // ====== Auth & profile ======
  const DEFAULT_AVATAR = "https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg";
  const ADMIN_FLAG_PATH = 'settings/admins';
  const profileBtn = $('#profileBtn'); const bellBtn=$('#bellBtn'); const adminBtn=$('#adminBtn');
  function showAuth(){ $('#authModal').classList.add('show'); $('#regError').textContent=''; $('#loginError').textContent=''; }
  function hideAuth(){ $('#authModal').classList.remove('show'); }

  $('#modalClose').onclick = hideAuth;
  $('#loginShow').onclick = ()=>{ $('#registerForm').style.display='none'; $('#loginForm').style.display='block'; };
  $('#backToRegister').onclick = ()=>{ $('#registerForm').style.display='block'; $('#loginForm').style.display='none'; };

  $('#registerSubmit').onclick = async ()=>{
    const nick=$('#nickInput').value.trim(); const email=$('#emailInput').value.trim(); const pass=$('#passwordInput').value.trim();
    if(!nick||!email||pass.length<6){ $('#regError').textContent='–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è (–ø–∞—Ä–æ–ª—å ‚â• 6)'; return; }
    try{
      const cred=await auth.createUserWithEmailAndPassword(email,pass);
      await cred.user.updateProfile({ displayName:nick, photoURL:DEFAULT_AVATAR });
      await db.ref('users/'+cred.user.uid).set({ nick,email,avatar:DEFAULT_AVATAR,createdAt:Date.now(), role:'seeker' });
      hideAuth();
      showSoundAsk();
      notify(cred.user.uid,'system','–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ! –£–≤—ñ–º–∫–Ω—ñ—Ç—å –∑–≤—É–∫ —É –º–µ–Ω—é.', null);
    }catch(e){ $('#regError').textContent=e.message||String(e); }
  };
  $('#loginSubmit').onclick = async ()=>{
    try{ await auth.signInWithEmailAndPassword($('#loginEmail').value.trim(), $('#loginPassword').value.trim()); hideAuth(); showSoundAsk(); }
    catch(e){ $('#loginError').textContent=e.message||String(e); }
  };

  auth.onAuthStateChanged(async u=>{
    profileBtn.style.background = `url(${(u&&u.photoURL)||DEFAULT_AVATAR}) center/cover`;
    profileBtn.onclick = ()=>{ if(!auth.currentUser) showAuth(); else openProfile(auth.currentUser.uid,true); };
    if(u){ await db.ref('presence/'+u.uid).set({ ts:Date.now(), nick:u.displayName||u.email });
      subscribeNotifications(u.uid);
      renderDMInbox();
      refreshFriendsBlocks();
      loadPeopleAdmin();
      loadMyPays();
      db.ref(ADMIN_FLAG_PATH+'/'+u.uid).once('value').then(s=>{
        const isAdmin=!!s.val();
        $('#payAdminBox').style.display = isAdmin?'block':'none';
      });
    }
  });

  // ====== Notifications (bell) ======
  const bellModal=$('#bellModal'); const bellBadge=$('#bellBadge');
  $('#bellClose').onclick=()=> bellModal.classList.remove('show');
  bellBtn.onclick=()=>{ bellModal.classList.add('show'); bellBadge.textContent='0'; bellBadge.style.display='none'; };
  $('#notifClearAll').onclick=async()=>{
    if(!auth.currentUser) return;
    const ls = await db.ref('notifications/'+auth.currentUser.uid).get();
    const obj = ls.val()||{};
    const updates = {};
    Object.keys(obj).forEach(k=> updates['notifications/'+auth.currentUser.uid+'/'+k]=null);
    await db.ref().update(updates);
    $('#notifList').innerHTML='';
  };
  function renderNotifItem(id,v){
    const row=document.createElement('div');
    row.style.cssText='padding:8px;border-bottom:1px solid #eee;display:flex;gap:8px;align-items:center';
    row.innerHTML = `<div style="flex:1"><div style="font-weight:800">${(v.type||'info').toUpperCase()}</div><div style="font-size:13px">${v.text||''}</div></div>
                     <button class="tab-button alt" data-act="ok">‚úñ</button>`;
    row.querySelector('[data-act=ok]').onclick=()=> db.ref('notifications/'+auth.currentUser.uid+'/'+id).remove();
    $('#notifList').prepend(row);
  }
  function subscribeNotifications(uid){
    db.ref('notifications/'+uid).off();
    db.ref('notifications/'+uid).on('child_added', snap=>{
      renderNotifItem(snap.key, snap.val()||{});
      bellBadge.style.display='inline-block';
      bellBadge.textContent=String(Number(bellBadge.textContent||'0')+1);
      const t=(snap.val()||{}).type;
      if(t==='friend_req') SND.play('friend');
      else if(t==='dm') SND.play('dm');
      else SND.play('system');
      flashToast((snap.val()?.text)||'–ù–æ–≤–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è');
    });
  }
  function notify(toUid,type,text,extra){
    const obj = { ts:Date.now(), type, text, ...(extra||{}), from: auth.currentUser?.uid||'system' };
    return db.ref('notifications/'+toUid).push(obj);
  }
  function flashToast(msg){
    let t = document.querySelector('.dm-toast');
    if(!t){ t=document.createElement('div'); t.className='dm-toast'; document.body.appendChild(t); }
    t.textContent = msg; t.style.display='block'; setTimeout(()=> t.style.display='none', 1800);
  }

  // ====== Sound modal ======
  function showSoundAsk(){ $('#soundModal').classList.add('show'); }
  $('#soundEnable').onclick = ()=>{ SND.enabled=true; $('#soundModal').classList.remove('show'); };
  $('#soundLater').onclick  = ()=> $('#soundModal').classList.remove('show');
  $('#soundClose').onclick  = ()=> $('#soundModal').classList.remove('show');

  // ====== Admin Panel (theme/sounds/limits) ======
  $('#adminBtn').onclick = async ()=>{
    const u=auth.currentUser; if(!u){ showAuth(); return; }
    const isAdmin = !!(await db.ref(ADMIN_FLAG_PATH+'/'+u.uid).get()).val();
    if(!isAdmin){ flashToast('–¢—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω–∞'); return; }
    const th = (await db.ref('settings/theme/wallUrl').get()).val()||'';
    $('#wallUrlInput').value = th;
    const snd = (await db.ref('settings/sounds').get()).val()||{};
    $('#sndChat').value = snd.chat||'';
    $('#sndDM').value = snd.dm||'';
    $('#sndFriend').value = snd.friend||'';
    $('#sndSystem').value = snd.system||'';
    const lim = (await db.ref('settings/defaultLimits').get()).val()||{text:200,photo:100};
    $('#defText').value = lim.text||200; $('#defPhoto').value = lim.photo||100;
    $('#adminPanel').classList.add('show');
  };
  $('#adminClose').onclick = ()=> $('#adminPanel').classList.remove('show');

  $('#wallSave').onclick = async ()=>{
    const url=$('#wallUrlInput').value.trim(); if(!url) return;
    await db.ref('settings/theme/wallUrl').set(url);
    flashToast('–û–±–æ–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –¥–ª—è –≤—Å—ñ—Ö');
  };
  $('#wallApplyLocal').onclick = ()=>{
    const url=$('#wallUrlInput').value.trim(); if(!url) return;
    applyWallpaper(url); flashToast('–¢—ñ–ª—å–∫–∏ –¥–ª—è –≤–∞—Å –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ');
  };
  $('#sndSave').onclick = async ()=>{
    const obj={ chat:$('#sndChat').value.trim(), dm:$('#sndDM').value.trim(), friend:$('#sndFriend').value.trim(), system:$('#sndSystem').value.trim() };
    await db.ref('settings/sounds').set(obj);
    await SND.loadAll(); flashToast('–ó–≤—É–∫–∏ –æ–Ω–æ–≤–ª–µ–Ω–æ');
  };
  $('#limitsSave').onclick = async ()=>{
    const text=Number($('#defText').value||200), photo=Number($('#defPhoto').value||100);
    await db.ref('settings/defaultLimits').set({text,photo});
    flashToast('–õ—ñ–º—ñ—Ç–∏ –∑–∞ –∑–∞–º–æ–≤—á. –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
  };

  // ====== Map ======
  let _mapInit=false, map, markers=[], poi=[];
  function initMapOnce(){
    if(_mapInit) { setTimeout(()=>{ try{ map.invalidateSize(false);}catch{} },50); return; }
    _mapInit=true;
    map=L.map('map',{zoomControl:true}).setView([50.0755,14.4378],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'¬© OSM'}).addTo(map);
    poi=[
      {t:'volunteer',name:'–£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –≤–æ–ª–æ–Ω—Ç–µ—Ä—Å—å–∫–∏–π —Ü–µ–Ω—Ç—Ä',p:[50.087,14.43]},
      {t:'aid',      name:'–¶–µ–Ω—Ç—Ä –¥–æ–ø–æ–º–æ–≥–∏ UA',               p:[50.09,14.47]},
      {t:'pharmacy', name:'–ê–ø—Ç–µ–∫–∞ Praha 1',                  p:[50.07,14.41]},
      {t:'pharmacy', name:'–ê–ø—Ç–µ–∫–∞ Praha 3',                  p:[50.084,14.45]},
      {t:'volunteer',name:'Volunteers Hub',                  p:[50.08,14.50]},
      {t:'aid',      name:'–ü—É–Ω–∫—Ç –≤–∏–¥–∞—á—ñ –≥—É–º–∞–Ω—ñ—Ç–∞—Ä–∫–∏',        p:[50.095,14.39]}
    ];
    renderPoi(poi);
    $('#centerBtn').onclick=()=> map.setView([50.0755,14.4378],12);
    $$('#mapTab button[data-f]').forEach(b=> b.onclick=()=>{
      const list=(b.dataset.f==='all')? poi : poi.filter(o=>o.t===b.dataset.f);
      renderPoi(list);
    });
    $('#mapSearch').oninput=e=> searchPoi(e.target.value.trim());
  }
  function clearMarkers(){ markers.forEach(m=>m.remove()); markers=[]; }
  function renderPoi(list){ clearMarkers(); list.forEach(o=>{ const m=L.marker(o.p).addTo(map).bindPopup(`<b>${o.name}</b><br>${o.t}`); markers.push(m); }); }
  function searchPoi(q){ const l=q.toLowerCase(); renderPoi(poi.filter(o=>o.name.toLowerCase().includes(l)||o.t.includes(l))); }

  // ====== Chat / Rent shared ======
  const chatAreaMain = $('#chatArea'), chatAreaRent = $('#rentArea');
  const messagesEl   = $('#messages'), rentMessagesEl=$('#rentMessages');
  let pendingImageData=null, pendingRentImageData=null;

  $('#fileInput').addEventListener('change', async (e)=>{ if(e.target.files[0]){ pendingImageData = await fileToDataURL(e.target.files[0], 900, .9); $('#photoToast').style.display='block'; setTimeout(()=> $('#photoToast').style.display='none', 2000);} });
  $('#rentFileInput').addEventListener('change', async (e)=>{ if(e.target.files[0]){ pendingRentImageData = await fileToDataURL(e.target.files[0], 900, .9); $('#rentPhotoToast').style.display='block'; setTimeout(()=> $('#rentPhotoToast').style.display='none', 2000);} });

  function timeStr(ts){ return new Date(ts).toLocaleString(); }
  function renderMessage(m,container){
    if(!m||!m.ts) return;
    const wr=document.createElement('div'); wr.className='message'+((auth.currentUser&&m.uid===auth.currentUser.uid)?' self':'');
    const av=document.createElement('img'); av.className='avatar'; av.src=m.avatar||DEFAULT_AVATAR; av.alt=m.nick||'avatar'; av.title=m.nick||''; av.onclick=()=>openProfile(m.uid);
    const box=document.createElement('div'); box.className='message-content';
    const meta=document.createElement('div'); meta.className='message-meta'; meta.textContent=`${m.nick||'–ê–Ω–æ–Ω—ñ–º'} ¬∑ ${timeStr(m.ts)}` + (m.recipientUid?' ¬∑ –õ–°':'');
    box.appendChild(meta);
    if(m.text){ const p=document.createElement('div'); p.className='text'; p.innerText=m.text; box.appendChild(p); }
    if(m.image){ const im=document.createElement('img'); im.src=m.image; im.className='chat-image'; im.alt='–§–æ—Ç–æ'; box.appendChild(im); }
    wr.appendChild(av); wr.appendChild(box); container.appendChild(wr);
  }

  // Stream listeners
  db.ref('messages').limitToLast(300).on('child_added', snap=>{ const m=snap.val(); renderMessage(m, messagesEl); SND.play('chat'); });
  db.ref('rentMessages').limitToLast(300).on('child_added', snap=>{ const m=snap.val(); renderMessage(m, rentMessagesEl); });

  // Quotas & roles
  async function canSend(kind){ // kind: 'text'|'photo'
    if(!ensureAuthOrGuest()) return false;
    if(!auth.currentUser) { showAuth(); return false; }
    const uid=auth.currentUser.uid;
    const flags=(await db.ref('settings/userFlags/'+uid).get()).val()||{};
    if(flags.blocked===true){ flashToast('–í–∞—à –∞–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ'); return false; }
    const me=(await db.ref('users/'+uid).get()).val()||{};
    const role=me.role||'seeker';
    if(role==='employer' && kind==='text') return true;
    if(flags.premium && flags.premium!=='none') return true;
    const t=Number(flags.textRemaining||0), p=Number(flags.photoRemaining||0);
    if(kind==='text' && t>0) return true;
    if(kind==='photo' && p>0) return true;
    // –ª—ñ–º—ñ—Ç –≤–∏—á–µ—Ä–ø–∞–Ω–æ
    await notify(uid,'system','–õ—ñ–º—ñ—Ç –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤–∏—á–µ—Ä–ø–∞–Ω–æ. –î–æ–¥–∞–π—Ç–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –æ–ø–ª–∞—Ç–∏ —É –≤–∫–ª–∞–¥—Ü—ñ ¬´–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –æ–ø–ª–∞—Ç¬ª.',{});
    flashToast('–õ—ñ–º—ñ—Ç –≤–∏—á–µ—Ä–ø–∞–Ω–æ ‚Äî –¥–∏–≤. —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è'); return false;
  }

  // Send chat
  $('#sendButton').onclick = async ()=>{
    if(!auth.currentUser){ showAuth(); return; }
    const text = $('#messageInput').value.trim();
    const img  = pendingImageData || null;
    const kind = img ? 'photo' : 'text';
    if(!text && !img) return;
    if(!await canSend(kind)) return;
    const u=auth.currentUser;
    const msg={ uid:u.uid, nick:u.displayName||u.email||'–ê–Ω–æ–Ω—ñ–º', avatar:u.photoURL||DEFAULT_AVATAR, text:text||null, image:img, ts:Date.now() };
    await db.ref('messages').push(msg);
    await decCounterIfNeeded(u.uid, kind);
    $('#messageInput').value=''; pendingImageData=null; SND.play('chat');
  };
  $('#rentSendButton').onclick = async ()=>{
    if(!auth.currentUser){ showAuth(); return; }
    const text = $('#rentMessageInput').value.trim();
    const img  = pendingRentImageData || null;
    const kind = img ? 'photo' : 'text';
    if(!text && !img) return;
    if(!await canSend(kind)) return;
    const u=auth.currentUser;
    const msg={ uid:u.uid, nick:u.displayName||u.email||'–ê–Ω–æ–Ω—ñ–º', avatar:u.photoURL||DEFAULT_AVATAR, text:text||null, image:img, ts:Date.now() };
    await db.ref('rentMessages').push(msg);
    await decCounterIfNeeded(u.uid, kind);
    $('#rentMessageInput').value=''; pendingRentImageData=null; SND.play('chat');
  };

  async function decCounterIfNeeded(uid, kind){
    const p = 'settings/userFlags/'+uid+'/'+(kind==='photo'?'photoRemaining':'textRemaining');
    const snap=await db.ref(p).get(); const cur=Number(snap.val()||0);
    if(cur>0) await db.ref(p).set(cur-1);
  }

  // File -> DataURL helper
  function fileToDataURL(file,maxW=900,quality=.86){ return new Promise((resolve,reject)=>{ const img=new Image(); const r=new FileReader(); r.onload=e=>{ img.onload=()=>{ const sc=Math.min(1, maxW/img.width); const w=(img.width*sc)|0, h=(img.height*sc)|0; const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); resolve(c.toDataURL('image/jpeg',quality)); }; img.onerror=reject; img.src=e.target.result; }; r.onerror=reject; r.readAsDataURL(file); }); }

  // ====== Friends + Requests ======
  const friendsList=$('#friendsList'), friendRequestsEl=$('#friendRequests'), friendsOnlineCountEl=$('#friendsOnlineCount');
  async function refreshFriendsBlocks(){
    const u=auth.currentUser; if(!u){ friendsList.innerHTML=''; friendRequestsEl.innerHTML=''; return; }
    // Requests
    friendRequestsEl.innerHTML = '';
    const reqSnap=await db.ref('friendRequests/'+u.uid).get();
    if(reqSnap.exists()){
      const reqs=reqSnap.val();
      for(const fromUid of Object.keys(reqs)){
        const ud=(await db.ref('users/'+fromUid).get()).val()||{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
        const item=document.createElement('div'); item.className='help-card';
        item.innerHTML=`<div style="display:flex;gap:8px;align-items:center">
          <img src="${ud.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:8px;object-fit:cover">
          <div style="flex:1"><b>${ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</b><div style="font-size:12px;color:#64748b">${ud.email||''}</div></div>
          <div style="display:flex;gap:6px"><button class="tab-button" data-a="ok">‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏</button><button class="tab-button danger" data-a="no">‚úñ</button></div>
        </div>`;
        item.querySelector('[data-a=ok]').onclick=async()=>{
          await db.ref('friends/'+u.uid+'/'+fromUid).set({ status:'accepted', ts:Date.now() });
          await db.ref('friends/'+fromUid+'/'+u.uid).set({ status:'accepted', ts:Date.now() });
          await db.ref('friendRequests/'+u.uid+'/'+fromUid).remove();
          await notify(fromUid,'friend_ok',`–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ${u.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'} –ø—Ä–∏–π–Ω—è–≤ –∑–∞—è–≤–∫—É`,{});
          refreshFriendsBlocks();
        };
        item.querySelector('[data-a=no]').onclick=async()=>{
          await db.ref('friendRequests/'+u.uid+'/'+fromUid).remove(); await db.ref('friends/'+fromUid+'/'+u.uid).remove(); refreshFriendsBlocks();
        };
        friendRequestsEl.appendChild(item);
      }
    } else friendRequestsEl.innerHTML='<i>–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</i>';

    // Friends
    friendsList.innerHTML=''; let on=0;
    const frSnap=await db.ref('friends/'+u.uid).get();
    if(frSnap.exists()){
      const fr=frSnap.val();
      for(const fid of Object.keys(fr)){ const rel=fr[fid]; if(rel.status!=='accepted') continue;
        const ud=(await db.ref('users/'+fid).get()).val()||{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
        const pSnap=await db.ref('presence/'+fid).get(); const isOn=pSnap.exists(); if(isOn) on++;
        const card=document.createElement('div'); card.className='help-card';
        card.innerHTML=`<div style="display:flex;gap:8px;align-items:center">
          <img src="${ud.avatar||DEFAULT_AVATAR}" style="width:42px;height:42px;border-radius:8px;object-fit:cover">
          <div style="flex:1"><b>${ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</b><div style="font-size:12px;color:${isOn?'#10b981':'#64748b'}">${isOn?'–æ–Ω–ª–∞–π–Ω':'–æ—Ñ–ª–∞–π–Ω'}</div></div>
          <div style="display:flex;gap:6px"><button class='tab-button' data-a="pm">‚úâÔ∏è</button><button class='tab-button alt' data-a="open">üëÄ</button></div>
        </div>`;
        card.querySelector('[data-a=open]').onclick=()=> openProfile(fid);
        card.querySelector('[data-a=pm]').onclick=()=> openPrivateChat(fid);
        friendsList.appendChild(card);
      }
    } else friendsList.innerHTML='<i>–î–æ–¥–∞–π—Ç–µ –¥—Ä—É–∑—ñ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ—ñ–ª—ñ</i>';
    friendsOnlineCountEl.textContent=String(on);
  }

  async function sendFriendRequest(toUid){
    if(!auth.currentUser){ showAuth(); return; }
    const from=auth.currentUser.uid; if(from===toUid) return;
    await db.ref('friendRequests/'+toUid+'/'+from).set({ from, ts:Date.now() });
    await db.ref('friends/'+from+'/'+toUid).set({ status:'requested', ts:Date.now(), fromUid:from });
    await notify(toUid,'friend_req',`–ó–∞–ø–∏—Ç —É –¥—Ä—É–∑—ñ –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`,{});
    flashToast('–ó–∞—è–≤–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞');
  }

  // ====== Profiles & DM ======
  async function openProfile(uid,isSelf=false){
    $('#profileContent').innerHTML='<p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</p>'; $('#profileModal').classList.add('show');
    const user=(await db.ref('users/'+uid).get()).val()||{nick:'–ê–Ω–æ–Ω—ñ–º',avatar:DEFAULT_AVATAR};
    const flags=(await db.ref('settings/userFlags/'+uid).get()).val()||{};
    const remT=Number(flags.textRemaining||0), remP=Number(flags.photoRemaining||0), prem=flags.premium||'none', expires=flags.premiumUntil?new Date(flags.premiumUntil).toLocaleDateString():'‚Äî';
    const self = auth.currentUser && auth.currentUser.uid===uid;
    $('#profileContent').innerHTML = `
      <div style="display:flex;gap:12px;align-items:center">
        <img src="${user.avatar||DEFAULT_AVATAR}" style="width:84px;height:84px;border-radius:12px;object-fit:cover">
        <div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <h3 style="margin:0">${user.nick||'–ê–Ω–æ–Ω—ñ–º'}</h3>
            <span class="user-badge">–ü–ª–∞–Ω: <b>${prem}</b></span>
            <span class="user-badge">–¢–µ–∫—Å—Ç: <b>${remT}</b></span>
            <span class="user-badge">–§–æ—Ç–æ: <b>${remP}</b></span>
            <span class="user-badge">–î–æ: <b>${expires}</b></span>
          </div>
          <div style="color:#64748b">${user.email||''}</div>
        </div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        ${ self ? `
          <label class="tab-button" style="cursor:pointer"><input type="file" id="avatarFile" accept="image/*" style="display:none">–ó–º—ñ–Ω–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä</label>
          <button id="signOutBtn" class="tab-button danger">–í–∏–π—Ç–∏</button>` :
          `<button id="pmBtn" class="tab-button">–ù–∞–ø–∏—Å–∞—Ç–∏ –õ–°</button>
           <button id="addFriendBtn" class="tab-button">–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>`}
      </div>
    `;
    $('#profileClose').onclick=()=> $('#profileModal').classList.remove('show');
    if(self){
      $('#avatarFile').addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; const url=await fileToDataURL(f,900,.9); await db.ref('users/'+uid+'/avatar').set(url); await auth.currentUser.updateProfile({ photoURL:url }); profileBtn.style.background=`url(${url}) center/cover`; openProfile(uid,true); });
      $('#signOutBtn').onclick=async()=>{ await db.ref('presence/'+auth.currentUser.uid).remove().catch(()=>{}); await auth.signOut(); $('#profileModal').classList.remove('show'); };
    } else {
      $('#pmBtn').onclick=()=> openPrivateChat(uid);
      $('#addFriendBtn').onclick=()=> sendFriendRequest(uid);
    }
  }

  function convoId(a,b){ return a<b? a+'_'+b : b+'_'+a; }
  async function openPrivateChat(otherUid){
    if(!auth.currentUser){ showAuth(); return; }
    const uid=auth.currentUser.uid; const cid=convoId(uid,otherUid);
    const panel=document.createElement('div'); panel.className='modal show'; panel.innerHTML=`
      <div class="panel">
        <button class="close">‚úñ</button>
        <h3>–î—ñ–∞–ª–æ–≥</h3>
        <div id="dmThread" style="max-height:55vh;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px;margin-bottom:8px;background:#fafafa"></div>
        <div style="display:flex;gap:6px"><input id="dmText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd">
        <label class="camera-btn" title="–§–æ—Ç–æ –∑–∞ URL –∞–±–æ —Ñ–∞–π–ª"><input id="dmFile" type="file" accept="image/*" style="display:none">üì∑</label>
        <button id="dmSend" class="tab-button">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button></div>
      </div>`;
    document.body.appendChild(panel);
    panel.querySelector('.close').onclick=()=> panel.remove();
    const thread=panel.querySelector('#dmThread');

    db.ref('inboxMeta/'+uid+'/'+otherUid).set({ with:otherUid, ts:Date.now() });
    db.ref('inboxMeta/'+otherUid+'/'+uid).set({ with:uid, ts:Date.now() });

    db.ref('privateMessages/'+cid).limitToLast(300).on('child_added',snap=>{
      const m=snap.val(); const row=document.createElement('div');
      row.style.margin='6px 0'; row.style.textAlign=m.from===uid?'right':'left';
      row.textContent=`${m.text||''} ${m.image?'[—Ñ–æ—Ç–æ]':''} (${new Date(m.ts).toLocaleTimeString()})`;
      thread.appendChild(row); thread.scrollTop=thread.scrollHeight;
      if(m.to===uid) SND.play('dm');
    });
    let dmImg=null;
    panel.querySelector('#dmFile').addEventListener('change', async (e)=>{ if(e.target.files[0]){ dmImg=await fileToDataURL(e.target.files[0],900,.9); flashToast('–§–æ—Ç–æ –¥–æ–¥–∞–Ω–æ –¥–æ –õ–°'); } });
    panel.querySelector('#dmSend').onclick=async()=>{
      const t=panel.querySelector('#dmText').value.trim(); if(!t && !dmImg) return;
      if(!await canSend(dmImg?'photo':'text')) return;
      const pm={from:uid,to:otherUid,text:t||null,image:dmImg||null,ts:Date.now()};
      await db.ref('privateMessages/'+cid).push(pm);
      await notify(otherUid,'dm',`–ù–æ–≤–µ –õ–° –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`,{convoId:cid});
      await db.ref('inboxMeta/'+uid+'/'+otherUid).update({ last:t||'[—Ñ–æ—Ç–æ]', ts:pm.ts });
      await db.ref('inboxMeta/'+otherUid+'/'+uid).update({ last:t||'[—Ñ–æ—Ç–æ]', ts:pm.ts });
      panel.querySelector('#dmText').value=''; dmImg=null; SND.play('dm');
    };
  }

  function renderDMInbox(){
    const u=auth.currentUser;
    if(!u){ $('#dmList').innerHTML='<i>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –±–∞—á–∏—Ç–∏ –õ–°</i>'; return; }
    $('#dmList').innerHTML='';
    db.ref('inboxMeta/'+u.uid).orderByChild('ts').limitToLast(200).on('child_added', async snap=>{
      const other=snap.key; const meta=snap.val()||{};
      const name=(await db.ref('users/'+other+'/nick').get()).val()||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á';
      const avatar=(await db.ref('users/'+other+'/avatar').get()).val()||DEFAULT_AVATAR;
      const card=document.createElement('div'); card.className='help-card';
      card.innerHTML=`<div style="display:flex;gap:8px;align-items:center">
        <img src="${avatar}" style="width:42px;height:42px;border-radius:8px;object-fit:cover">
        <div style="flex:1"><b>${name}</b><div style="font-size:12px;color:#64748b">${meta.last||'‚Äî'}</div></div>
        <button class='tab-button'>–í—ñ–¥–∫—Ä–∏—Ç–∏</button></div>`;
      card.querySelector('button').onclick=()=> openPrivateChat(other);
      $('#dmList').prepend(card);
    });
  }

  // ====== Help cards ======
  (function fillHelp(){
    const data=[
      {img:"https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp", title:"Nemocnice Motol", sub:"V √övalu 84"},
      {img:"https://i.ibb.co/0gWD5wW/images-5.jpg", title:"–Æ—Ä–∏–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞", sub:"–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó"},
      {img:"https://i.ibb.co/R49shL6k/images-6.jpg", title:"–£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –º–∞–≥–∞–∑–∏–Ω–∏", sub:"–ü—Ä–æ–¥—É–∫—Ç–∏"}
    ];
    $('#helpGrid').innerHTML = data.map(i=>`
      <div class="help-card"><img src="${i.img}"><h3>${i.title}</h3><p>${i.sub}</p></div>`
    ).join('');
  })();

  // ====== Payments (confirmations) ======
  $('#paySend').onclick = async ()=>{
    if(!auth.currentUser){ showAuth(); return; }
    const url = $('#payImgUrl').value.trim(); if(!url){ $('#paySendMsg').style.display='block'; $('#paySendMsg').textContent='–í–∫–∞–∂—ñ—Ç—å URL —Å–∫—Ä—ñ–Ω—à–æ—Ç—É'; return; }
    await db.ref('payments/inbox/'+auth.currentUser.uid).push({ ts:Date.now(), image:url, status:'new' });
    await notify(auth.currentUser.uid,'system','–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ. –û—á—ñ–∫—É–π—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É.',{});
    const admins=(await db.ref(ADMIN_FLAG_PATH).get()).val()||{};
    Object.keys(admins).forEach(a=> admins[a] && notify(a,'pay',`–ù–æ–≤–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`,{}));
    $('#payImgUrl').value=''; loadMyPays();
  };
  async function loadMyPays(){
    if(!auth.currentUser) return;
    const snap=await db.ref('payments/inbox/'+auth.currentUser.uid).get();
    const v=snap.val()||{}; const el=$('#myPays'); el.innerHTML='';
    Object.keys(v).reverse().forEach(k=>{
      const it=v[k];
      const row=document.createElement('div'); row.className='help-card';
      row.innerHTML=`<div style="display:flex;gap:8px;align-items:center">
        <img src="${it.image}" style="width:64px;height:64px;border-radius:8px;object-fit:cover">
        <div style="flex:1"><b>${new Date(it.ts).toLocaleString()}</b><div style="font-size:12px;color:#64748b">–°—Ç–∞—Ç—É—Å: ${it.status||'new'}</div></div>
      </div>`;
      el.appendChild(row);
    });
  }
  async function loadPayInboxAdmin(){
    const u=auth.currentUser; if(!u) return;
    const isAdmin = !!(await db.ref(ADMIN_FLAG_PATH+'/'+u.uid).get()).val();
    if(!isAdmin) return;
    const box = $('#payInboxAll'); box.innerHTML='';
    const all = (await db.ref('payments/inbox').get()).val()||{};
    for(const uid of Object.keys(all)){
      for(const pid of Object.keys(all[uid])){
        const it=all[uid][pid]; const user=(await db.ref('users/'+uid).get()).val()||{};
        const row=document.createElement('div'); row.className='help-card';
        row.innerHTML=`<div style="display:flex;gap:8px;align-items:center">
          <img src="${it.image}" style="width:64px;height:64px;border-radius:8px;object-fit:cover">
          <div style="flex:1"><b>${user.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</b> <span class="user-badge">${user.email||''}</span><div style="font-size:12px;color:#64748b">${new Date(it.ts).toLocaleString()}</div></div>
          <div style="display:flex;gap:6px">
            <button class="tab-button" data-a="prem" data-u="${uid}" data-p="${pid}">–ü—Ä–µ–º—ñ—É–º</button>
            <button class="tab-button" data-a="premplus" data-u="${uid}" data-p="${pid}">–ü—Ä–µ–º—ñ—É–º+</button>
            <button class="tab-button alt" data-a="ok" data-u="${uid}" data-p="${pid}">–û–∫</button>
          </div>
        </div>`;
        box.appendChild(row);
      }
    }
    box.querySelectorAll('button[data-a]').forEach(btn=> btn.onclick=async()=>{
      const a=btn.dataset.a, uid=btn.dataset.u, pid=btn.dataset.p;
      if(a==='prem')      await db.ref('settings/userFlags/'+uid).update({ premium:'premium', premiumUntil: Date.now()+30*24*3600*1000 });
      else if(a==='premplus') await db.ref('settings/userFlags/'+uid).update({ premium:'premiumPlus', premiumUntil: Date.now()+30*24*3600*1000 });
      await db.ref('payments/inbox/'+uid+'/'+pid+'/status').set('checked');
      await notify(uid,'system','–û–ø–ª–∞—Ç—É –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ. –ü–ª–∞–Ω –æ–Ω–æ–≤–ª–µ–Ω–æ.',{});
      loadPayInboxAdmin();
    });
  }

  // ====== People (admin table) ======
  async function loadPeopleAdmin(){
    const u=auth.currentUser; if(!u) return;
    const isAdmin = !!(await db.ref(ADMIN_FLAG_PATH+'/'+u.uid).get()).val();
    const box=$('#peopleGrid'); box.innerHTML='';
    if(!isAdmin){ box.innerHTML='<i>–¢—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω–∞</i>'; return; }
    const users=(await db.ref('users').get()).val()||{};
    const flags=(await db.ref('settings/userFlags').get()).val()||{};
    for(const uid of Object.keys(users)){
      const us=users[uid]; const fl=flags[uid]||{};
      const card=document.createElement('div'); card.className='help-card bot-card';
      card.innerHTML=`<div style="display:flex;gap:10px;align-items:center">
        <img src="${us.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:8px;object-fit:cover">
        <div style="flex:1">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <b>${us.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</b>
            <span class="user-badge">${us.email||''}</span>
            <span class="user-badge">–†–æ–ª—å: ${us.role||'seeker'}</span>
            <span class="user-badge">–¢–µ–∫—Å—Ç: ${fl.textRemaining??'‚Äî'}</span>
            <span class="user-badge">–§–æ—Ç–æ: ${fl.photoRemaining??'‚Äî'}</span>
            <span class="user-badge">${fl.premium||'none'}</span>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
        <button class="tab-button" data-a="ban" data-u="${uid}">${fl.blocked?'–†–æ–∑–±–∞–Ω–∏—Ç–∏':'–ó–∞–±–∞–Ω–∏—Ç–∏'}</button>
        <button class="tab-button" data-a="prem" data-u="${uid}">–ü—Ä–µ–º—ñ—É–º</button>
        <button class="tab-button" data-a="premplus" data-u="${uid}">–ü—Ä–µ–º—ñ—É–º+</button>
        <button class="tab-button alt" data-a="text+" data-u="${uid}">+50 —Ç–µ–∫—Å—Ç</button>
        <button class="tab-button alt" data-a="photo+" data-u="${uid}">+20 —Ñ–æ—Ç–æ</button>
        <button class="tab-button alt" data-a="role" data-u="${uid}">–ó–º—ñ–Ω–∏—Ç–∏ —Ä–æ–ª—å</button>
      </div>`;
      box.appendChild(card);
    }
    box.querySelectorAll('button[data-a]').forEach(btn=> btn.onclick=async()=>{
      const a=btn.dataset.a, uid=btn.dataset.u;
      if(a==='ban'){ const cur=(await db.ref('settings/userFlags/'+uid+'/blocked').get()).val()===true; await db.ref('settings/userFlags/'+uid+'/blocked').set(!cur); }
      else if(a==='prem'){ await db.ref('settings/userFlags/'+uid).update({ premium:'premium', premiumUntil:Date.now()+30*24*3600*1000 }); }
      else if(a==='premplus'){ await db.ref('settings/userFlags/'+uid).update({ premium:'premiumPlus', premiumUntil:Date.now()+30*24*3600*1000 }); }
      else if(a==='text+'){ const v=Number((await db.ref('settings/userFlags/'+uid+'/textRemaining').get()).val()||0); await db.ref('settings/userFlags/'+uid+'/textRemaining').set(v+50); }
      else if(a==='photo+'){ const v=Number((await db.ref('settings/userFlags/'+uid+'/photoRemaining').get()).val()||0); await db.ref('settings/userFlags/'+uid+'/photoRemaining').set(v+20); }
      else if(a==='role'){ const cur=(await db.ref('users/'+uid+'/role').get()).val()||'seeker'; const next= (cur==='seeker'?'employer':'seeker'); await db.ref('users/'+uid+'/role').set(next); }
      loadPeopleAdmin();
    });
  }

  // ====== Start ======
  (async function(){
    applyWallpaper(DEFAULT_WALL);
    await SND.loadAll();
    // online count
    db.ref('presence').on('value', s=>{ const v=s.val()||{}; const real=Object.keys(v).length; onlineNeon.textContent=`–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): ${real*10}`; });
    // payments admin list
    auth.onAuthStateChanged(()=> loadPayInboxAdmin());
  })();

  // Hotkeys
  window.addEventListener('keydown', (e)=>{
    const map = { '1':'chatTab','2':'rentTab','3':'mapTab','4':'friendsTab','5':'dmTab' };
    if(map[e.key]) setActiveTab(map[e.key]);
  });
  </script>
</body>
</html>
