<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PRAGA FU≈†KY ‚Äî –°–æ—Ü—á–∞—Ç (PRO)</title>
  <meta name="theme-color" content="#071126" />
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#2ecc71;
      --glass: rgba(255,255,255,0.96);
      --muted:#64748b;
      --max-width:1100px;
      --avatar-size:56px;
      --chat-scale:1.12;
      --gothic-size:44px;
      --mobile-break:820px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif;-webkit-font-smoothing:antialiased;background:#071126;color:#0b1220;overflow-x:hidden}

    /* Background */
    body{ background-image:url('https://i.ibb.co/27hgtZfY/Prague.jpg'); background-size:cover; background-position:center; background-attachment:fixed }

    /* Header - –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ, —á—Ç–æ–±—ã –ª–µ–Ω—Ç–∞ –±—ã–ª–∞ –≤—ã—à–µ */
    header{
      position:sticky;
      top:0;
      z-index:160;
      padding:6px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:linear-gradient(180deg, rgba(0,0,0,0.16), rgba(0,0,0,0.02));
      backdrop-filter: blur(4px);
    }
    .left-block, .center-block, .right-block{display:flex;align-items:center;gap:10px}
    .left-block{flex:0 0 auto}
    .center-block{flex:1;justify-content:center;flex-direction:column;align-items:center}
    .right-block{flex:0 0 auto}

    /* Gothic brand with alternating colors */
    .brand {
      text-align:center;
      user-select:none;
    }
    .gothic {
      font-family:'UnifrakturCook',cursive;
      font-size:var(--gothic-size);
      margin:0;
      line-height:1;
      text-transform:uppercase;
      text-shadow: 2px 6px 0 rgba(0,0,0,0.45), 0 12px 30px rgba(0,0,0,0.6);
      display:inline-block;
      padding:2px 6px;
      border-radius:6px;
      background: linear-gradient(180deg, rgba(0,0,0,0.28), rgba(0,0,0,0.08));
    }

    .subtitle {
      margin:0;
      font-size:13px;
      color:#fff;
      padding:4px 8px;
      border-radius:8px;
      background:rgba(0,0,0,0.32);
      display:inline-block;
      margin-top:4px;
    }

    /* Controls */
    .profile-btn{width:48px;height:48px;border-radius:50%;border:2px solid #fff;background-size:cover;background-position:center;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,0.35)}
    .friends-btn{background:#fff;border:1px solid #ddd;padding:8px 10px;border-radius:10px;cursor:pointer}
    .bell{
      position:relative;
      width:56px;height:56px;border-radius:12px;background:linear-gradient(180deg,#fff,#f1f1f1);
      display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 8px 26px rgba(0,0,0,0.35)
    }
    .bell .count{position:absolute;right:-6px;top:-6px;background:#ef4444;color:#fff;border-radius:999px;padding:6px 9px;font-size:13px;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:none}

    /* Tabs */
    nav.tabs{display:flex;gap:8px;justify-content:center;padding:8px;width:100%;max-width:var(--max-width);margin:6px auto}
    .tab-button{background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 14px;font-weight:700;border-radius:10px;cursor:pointer}
    .tab-button.active{outline:3px solid rgba(46,204,113,0.12);background:linear-gradient(180deg, rgba(46,204,113,0.12), rgba(0,0,0,0.12))}

    main.container{max-width:var(--max-width);margin:6px auto;padding:6px}

    .tab-content{display:none}
    .tab-content.active{display:block}

    /* Chat area - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–µ–Ω—Ç—É (–º–µ–Ω—å—à–µ —à–∞–ø–∫–∏) */
    .chat-area{height:calc(100vh - 180px);overflow:auto;padding:10px;background:transparent}
    .messages{display:flex;flex-direction:column;gap:10px;padding-bottom:180px;transform:scale(var(--chat-scale));transform-origin:bottom left}
    .message{display:flex;gap:10px;align-items:flex-start;max-width:86%;word-break:break-word}
    .message.self{margin-left:auto;flex-direction:row-reverse}
    .avatar{width:var(--avatar-size);height:var(--avatar-size);border-radius:50%;object-fit:cover;flex:0 0 var(--avatar-size);box-shadow:0 3px 10px rgba(0,0,0,0.35);cursor:pointer}
    .message-content{background:var(--glass);padding:10px 14px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.12);color:#0b1220}
    .message.self .message-content{background:#E9FFF0}
    .message-meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .chat-image{max-width:100%;height:auto;border-radius:8px;margin-top:8px;display:block}
    .message-content .text{ font-family:'Inter',sans-serif;font-weight:600;font-size:0.98rem;color:#0b1220;white-space:pre-wrap;word-break:break-word }

    /* Input */
    .chat-input{position:fixed;left:0;right:0;bottom:0;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.99));border-top:1px solid rgba(0,0,0,0.06);z-index:90;display:flex;gap:8px;align-items:center;max-width:var(--max-width);margin:0 auto}
    .camera-btn{display:inline-flex;align-items:center;justify-content:center;cursor:pointer;width:44px;height:44px;border-radius:50%;background:#fff;border:1px solid #e6e6e6}
    .chat-input input[type="text"]{flex:1;padding:12px 14px;border-radius:22px;border:1px solid #d0d7de;font-size:15px;outline:none}
    .send-btn{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:18px;font-weight:800;cursor:pointer;box-shadow:0 8px 20px rgba(46,204,113,0.18)}

    /* Map */
    #map{height:62vh;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.3)}

    /* Help grid */
    .help-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;padding:12px}
    .help-card{background:#fff;padding:10px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .help-card img{width:100%;height:140px;object-fit:cover;border-radius:8px}

    /* No horizontal scroll and responsive images */
    img, video { max-width:100%; height:auto; display:block; }
    body, html { overflow-x:hidden; -webkit-overflow-scrolling: touch; }

    /* small device tweaks */
    @media(max-width:var(--mobile-break)){
      :root{--chat-scale:1.02;--gothic-size:32px}
      header{padding:8px 8px}
      .messages{transform-origin:bottom left;padding-bottom:220px}
      .chat-area{height:calc(100vh - 150px)}
      .gothic{font-size:28px}
      .profile-btn{width:44px;height:44px}
      .bell{width:50px;height:50px}
      .tab-button{padding:6px 10px;font-size:13px}
    }
  </style>
</head>
<body>

  <header>
    <!-- left: profile + friends -->
    <div class="left-block">
      <button id="profileBtn" class="profile-btn" title="–ü—Ä–æ—Ñ—ñ–ª—å" aria-label="–ü—Ä–æ—Ñ—ñ–ª—å"></button>
      <button id="friendsBtn" class="friends-btn" title="–î—Ä—É–∑—ñ">üë• –î—Ä—É–∑—ñ</button>
    </div>

    <!-- center: gothic brand with alternating colors per letter -->
    <div class="center-block">
      <div class="brand">
        <h1 class="gothic" id="brandTitle">
          <!-- we'll color letters via JS; fallback plain -->
          PRAGA FU≈†KY
        </h1>
        <!-- subtitle removed to increase chat area; will show per-user notifications after login -->
      </div>
    </div>

    <!-- right: big bell -->
    <div class="right-block">
      <div id="notifBell" class="bell" title="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è" aria-hidden="false" role="button" aria-label="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è" tabindex="0">
        <div class="bell-icon">üîî</div>
        <div id="notifCount" class="count" style="display:none">0</div>
      </div>
    </div>
  </header>

  <nav class="tabs" role="tablist" aria-label="–í–∫–ª–∞–¥–∫–∏" style="margin-top:6px">
    <button class="tab-button active" data-target="chatTab">üí¨ –ß–∞—Ç</button>
    <button class="tab-button" data-target="rentTab">üèòÔ∏è –ß–∞—Ç –û—Ä–µ–Ω–¥–∞</button>
    <button class="tab-button" data-target="mapTab">üó∫ –ö–∞—Ä—Ç–∞</button>
    <button class="tab-button" data-target="helpTab">‚ùì –î–æ–ø–æ–º–æ–≥–∞</button>
  </nav>

  <main class="container">
    <!-- Chat -->
    <section id="chatTab" class="tab-content active">
      <div class="chat-area" id="chatArea" aria-live="polite">
        <div id="messages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- Rent chat -->
    <section id="rentTab" class="tab-content" style="display:none">
      <div class="chat-area" style="height:54vh">
        <div id="rentMessages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- Map -->
    <section id="mapTab" class="tab-content" style="display:none">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <div style="flex:1"><input id="mapSearch" placeholder="–ü–æ—à—É–∫ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –≤–æ–ª–æ–Ω—Ç–µ—Ä–∏, –∞–ø—Ç–µ–∫–∞)..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd"></div>
        <div><button id="centerBtn" class="friends-btn">–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏</button></div>
      </div>
      <div id="map"></div>
    </section>

    <!-- Help -->
    <section id="helpTab" class="tab-content" style="display:none">
      <h2 style="color:#fff">–¢–µ—Ä–º—ñ–Ω–æ–≤–∞ –¥–æ–ø–æ–º–æ–≥–∞ —É –ü—Ä–∞–∑—ñ</h2>
      <div class="help-grid">
        <div class="help-card">
          <img src="https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp" alt="–ë–æ–ª—å–Ω–∏—Ü–∞">
          <h3>Nemocnice Motol</h3><p>–ê–¥—Ä–µ—Å–∞: V Uvalu 84</p>
        </div>
        <div class="help-card">
          <img src="https://i.ibb.co/0gWD5wW/images-5.jpg" alt="–Æ—Ä–∏—Å—Ç—ã">
          <h3>–Æ—Ä–∏–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞</h3><p>–î–æ–∫—É–º–µ–Ω—Ç–∏ —Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó</p>
        </div>
        <div class="help-card">
          <img src="https://i.ibb.co/R49shL6k/images-6.jpg" alt="–ú–∞–≥–∞–∑–∏–Ω—ã">
          <h3>–£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –º–∞–≥–∞–∑–∏–Ω–∏</h3><p>–ü—Ä–æ–¥—É–∫—Ç–∏ —Ç–∞ —Ç–æ–≤–∞—Ä–∏</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Hidden file input -->
  <input id="fileInput" type="file" accept="image/*" style="display:none">

  <!-- Input -->
  <div class="chat-input" role="region" aria-label="–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">
    <label for="fileInput" class="camera-btn" title="–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="#111" xmlns="http://www.w3.org/2000/svg"><path d="M4 7H6L7 5H17L18 7H20C21.1 7 22 7.9 22 9V19C22 20.1 21.1 21 20 21H4C2.9 21 2 20.1 2 19V9C2 7.9 2.9 7 4 7Z"></path></svg>
    </label>
    <input id="messageInput" type="text" inputmode="text" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." aria-label="–¢–µ–∫—Å—Ç" />
    <button id="sendButton" class="send-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
  </div>

  <!-- Profile modal -->
  <div id="profileModal" class="modal" aria-hidden="true" style="display:none">
    <div class="modal-panel">
      <button class="modal-close" id="profileClose">‚úï</button>
      <div id="profileContent">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>
  </div>

  <!-- Message menu -->
  <div id="msgMenu" class="msg-menu" role="menu" style="display:none">
    <button data-act="like">üëç –õ–∞–π–∫</button>
    <button data-act="warn">‚ö†Ô∏è –û—Å—Ç–µ—Ä–µ–∂–Ω–æ (—à–∞—Ö—Ä–∞–π)</button>
    <button data-act="dislike">üëé –î–∏–∑–ª–∞–π–∫</button>
    <button data-act="spam">üö´ –°–ø–∞–º</button>
    <button data-act="reply">‚Ü©Ô∏è –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏</button>
  </div>

  <!-- Small script to alternate letter colors of brand -->
  <script>
    (function colorBrand(){
      const el = document.getElementById('brandTitle');
      const t = 'PRAGA FU≈†KY';
      const colors = ['#e53e3e','#2ecc71']; // red / green alternating
      el.innerHTML = '';
      for(let i=0;i<t.length;i++){
        const ch = t[i];
        const span = document.createElement('span');
        span.textContent = ch;
        if (ch.trim()) span.style.color = colors[i%2];
        el.appendChild(span);
      }
    })();

    // tabs handlers
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    function setActiveTab(id){
      tabButtons.forEach(b => b.classList.toggle('active', b.dataset.target === id));
      tabContents.forEach(c => c.style.display = (c.id === id) ? 'block' : 'none');
      if (id === 'messageInput') document.getElementById('messageInput').focus();
      if (id === 'mapTab' && window.google && window.map) { google.maps.event.trigger(window.map,'resize'); window.map.setCenter({lat:50.0755,lng:14.4378}); }
    }
    tabButtons.forEach(btn => btn.addEventListener('click', ()=> setActiveTab(btn.dataset.target)));
    document.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='c') setActiveTab('chatTab'); if(e.key.toLowerCase()==='r') setActiveTab('rentTab'); if(e.key.toLowerCase()==='m') setActiveTab('mapTab'); if(e.key.toLowerCase()==='h') setActiveTab('helpTab'); });
  </script>
  <!-- START PART 2 -->
<script type="module">
/* =========================
   PART 2: Firebase + Logic
   ========================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile,
  sendEmailVerification, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import {
  getDatabase, ref as dbRef, push as dbPush, onChildAdded, query, orderByChild, limitToLast,
  get as dbGet, set as dbSet, onValue, remove as dbRemove
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

/* ---------- Firebase config (your working config from previous code) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
  authDomain: "praga-4baee.firebaseapp.com",
  databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
  projectId: "praga-4baee",
  storageBucket: "praga-4baee.firebasestorage.app",
  messagingSenderId: "336023952536",
  appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
  measurementId: "G-BGDJD6R12N"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ---------- DOM references (from Part1) ---------- */
const tabButtons = document.querySelectorAll('.tab-button');
const tabContents = document.querySelectorAll('.tab-content');
const messagesEl = document.getElementById('messages');
const rentMessagesEl = document.getElementById('rentMessages');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const fileInput = document.getElementById('fileInput');
const profileBtn = document.getElementById('profileBtn');
const profileModal = document.getElementById('profileModal');
const profileClose = document.getElementById('profileClose');
const profileContent = document.getElementById('profileContent');
const notifBell = document.getElementById('notifBell');
const notifCount = document.getElementById('notifCount');
const friendsBtn = document.getElementById('friendsBtn');
const adminModal = document.getElementById('adminModal');
const adminContent = document.getElementById('adminContent');
const adminClose = document.getElementById('adminClose');
const mapEl = document.getElementById('map');
const mapSearch = document.getElementById('mapSearch');
const centerBtn = document.getElementById('centerBtn');

const DEFAULT_AVATAR = 'https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg';
let currentUser = null;
const MSG_LIMIT = 800;

/* ------------------ Utility: timestamp -> local string ------------------ */
function timeStr(ts){ return new Date(ts).toLocaleString(); }

/* ------------------ Image resize helper (client-side) ------------------ */
function resizeImageFile(file, maxWidth = 1200, quality = 0.8) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = (e) => {
      img.onload = () => {
        const scale = Math.min(1, maxWidth / img.width);
        const w = Math.round(img.width * scale);
        const h = Math.round(img.height * scale);
        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        const dataUrl = canvas.toDataURL('image/jpeg', quality);
        resolve(dataUrl);
      };
      img.onerror = (err) => reject(err);
      img.src = e.target.result;
    };
    reader.onerror = (err) => reject(err);
    reader.readAsDataURL(file);
  });
}

/* ------------------ Render message (used for both chats) ------------------ */
function renderMessage(m, container){
  if (!m || !m.ts) return;
  const wrap = document.createElement('div');
  wrap.className = 'message' + ((currentUser && m.uid === currentUser.uid) ? ' self' : '');
  wrap.dataset.uid = m.uid || '';
  wrap.dataset.msgid = m.id || '';

  const avatar = document.createElement('img');
  avatar.className = 'avatar';
  avatar.src = m.avatar || DEFAULT_AVATAR;
  avatar.alt = m.nick || 'avatar';
  avatar.title = m.nick || '–ü—Ä–æ—Ñ—ñ–ª—å';
  avatar.addEventListener('click', ()=> openProfile(m.uid));

  const txt = document.createElement('div');
  txt.className = 'message-content';
  const meta = document.createElement('div');
  meta.className = 'message-meta';
  meta.textContent = `${m.nick || '–ê–Ω–æ–Ω—ñ–º'} ¬∑ ${timeStr(m.ts)}` + (m.recipientUid ? ' ¬∑ –æ—Å–æ–±–∏—Å—Ç–µ' : '');
  txt.appendChild(meta);

  if (m.text) {
    const p = document.createElement('div');
    p.className = 'text';
    p.innerText = m.text;
    txt.appendChild(p);
  }

  if (m.image) {
    const im = document.createElement('img');
    im.src = m.image;
    im.alt = '–§–æ—Ç–æ';
    im.className = 'chat-image';
    txt.appendChild(im);
  }

  wrap.appendChild(avatar);
  wrap.appendChild(txt);
  container.appendChild(wrap);

  // Context menu for reactions
  wrap.addEventListener('contextmenu', (ev) => {
    ev.preventDefault();
    showMsgMenu(ev.pageX, ev.pageY, m, wrap);
  });

  // auto-scroll logic
  const chatArea = container.closest('.chat-area');
  if (chatArea) {
    const nearBottom = chatArea.scrollHeight - chatArea.scrollTop - chatArea.clientHeight < 200;
    if (nearBottom) chatArea.scrollTop = chatArea.scrollHeight;
  }
}

/* ------------------ Subscribe to public messages ------------------ */
const msgsQuery = query(dbRef(db, "messages"), orderByChild("ts"), limitToLast(MSG_LIMIT));
onChildAdded(msgsQuery, (snap) => {
  const m = snap.val(); m.id = snap.key;
  renderMessage(m, messagesEl);
});

/* ------------------ Subscribe to rent messages ------------------ */
const rentQuery = query(dbRef(db, "rentMessages"), orderByChild("ts"), limitToLast(MSG_LIMIT));
onChildAdded(rentQuery, (snap) => {
  const m = snap.val(); m.id = snap.key;
  renderMessage(m, rentMessagesEl);
});

/* ------------------ Send message with checks ------------------ */
sendButton.addEventListener('click', async ()=>{ await sendMessageHandler('messages'); });
messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendButton.click(); } });

async function sendMessageHandler(dbPath = 'messages'){
  // maintenance check
  const mSnap = await dbGet(dbRef(db, 'settings/maintenance'));
  const maintenance = mSnap && mSnap.exists() ? Boolean(mSnap.val()) : false;
  if (maintenance) { alert('–°–∞–π—Ç –Ω–∞ —Ç–µ—Ö.–æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—ñ'); return; }

  if (!auth.currentUser){ showAuthModal(); return; }

  // ban check
  try {
    const banSnap = await dbGet(dbRef(db, `users/${auth.currentUser.uid}/banned`));
    if (banSnap && banSnap.exists() && banSnap.val() === true) { alert('–í–∞—à –∞–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ'); return; }
  } catch(e){ console.error('ban check err', e); }

  if (!await canSendMessage()) { alert('–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å email –∞–±–æ —Å–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—å 6-–≥–æ–¥–∏–Ω–Ω–∏–º –¥–æ—Å—Ç—É–ø–æ–º –ø—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó.'); return; }

  const text = messageInput.value.trim();
  const file = fileInput.files[0];
  if (!text && !file) return;

  // simple rate-limit (per-user)
  const lastKey = 'lastMsgTs_' + auth.currentUser.uid;
  const last = Number(localStorage.getItem(lastKey) || 0);
  if (Date.now() - last < 2500) { alert('–ó–∞–Ω–∞–¥—Ç–æ —à–≤–∏–¥–∫–æ, –∑–∞—á–µ–∫–∞–π—Ç–µ.'); return; }

  let imageData = null;
  if (file) {
    try { imageData = await resizeImageFile(file, 1200, 0.8); } catch(e){ console.error('resize error', e); alert('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Ñ–æ—Ç–æ'); return; }
  }

  const msg = {
    uid: auth.currentUser.uid,
    nick: auth.currentUser.displayName || auth.currentUser.email || '–ê–Ω–æ–Ω—ñ–º',
    avatar: auth.currentUser.photoURL || DEFAULT_AVATAR,
    text: text || null,
    image: imageData || null,
    ts: Date.now(),
    recipientUid: null
  };

  try {
    await dbPush(dbRef(db, dbPath), msg);
    localStorage.setItem(lastKey, String(Date.now()));
    messageInput.value = '';
    fileInput.value = '';
  } catch(err){ console.error('dbPush error', err); alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è'); }
}

/* ------------------ canSendMessage: emailVerified OR within 6 hours ------------------ */
async function canSendMessage(){
  const user = auth.currentUser;
  if (!user) return false;
  if (user.emailVerified) return true;
  const localKey = 'regTime_' + user.uid;
  const localVal = localStorage.getItem(localKey);
  const sixHours = 6 * 60 * 60 * 1000;
  if (localVal && (Date.now() - Number(localVal) < sixHours)) return true;
  try {
    const snap = await dbGet(dbRef(db, `users/${user.uid}/createdAt`));
    if (snap && snap.exists()) {
      const created = Number(snap.val());
      if (!Number.isNaN(created) && Date.now() - created < sixHours) {
        localStorage.setItem(localKey, String(created));
        return true;
      }
    }
  } catch (e) { console.error('canSendMessage db get error', e); }
  return false;
}

/* ------------------ Auth / Profile UI ------------------ */
function showAuthModal(){ profileModal.style.display='flex'; profileModal.setAttribute('aria-hidden','false'); profileContent.innerHTML = authHtml(); attachAuthHandlers(); }
function hideAuthModal(){ profileModal.style.display='none'; profileModal.setAttribute('aria-hidden','true'); }
function authHtml(){ return `
  <h2>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è / –í—Ö—ñ–¥</h2>
  <div style="display:flex;gap:12px;flex-direction:column">
    <input id="uiNick" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" />
    <input id="uiEmail" placeholder="Email" />
    <input id="uiPass" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω. 6)" type="password" />
    <div style="display:flex;gap:8px;"><button id="uiRegister" class="small-btn">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å</button><button id="uiLogin" class="small-btn">–£–≤—ñ–π—Ç–∏</button></div>
    <div id="uiAuthMsg" style="color:#b91c1c"></div>
  </div>
`; }
function attachAuthHandlers(){
  document.getElementById('uiRegister').addEventListener('click', async ()=>{
    const nick = document.getElementById('uiNick').value.trim();
    const email = document.getElementById('uiEmail').value.trim();
    const pass = document.getElementById('uiPass').value.trim();
    const msgEl = document.getElementById('uiAuthMsg'); msgEl.textContent = '';
    if (!nick || !email || !pass) { msgEl.textContent = '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è'; return; }
    if (pass.length < 6) { msgEl.textContent = '–ü–∞—Ä–æ–ª—å –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤'; return; }
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await updateProfile(cred.user, { displayName: nick, photoURL: DEFAULT_AVATAR });
      await dbSet(dbRef(db, `users/${cred.user.uid}`), { nick, email, avatar: DEFAULT_AVATAR, createdAt: Date.now(), online:true });
      localStorage.setItem('regTime_' + cred.user.uid, String(Date.now()));
      await sendEmailVerification(cred.user);
      hideAuthModal();
      alert('–ó–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ. –õ–∏—Å—Ç –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ. –£ –≤–∞—Å 6 –≥–æ–¥–∏–Ω –¥–æ—Å—Ç—É–ø—É –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è');
    } catch (e) { console.error(e); msgEl.textContent = e.message || String(e); }
  });

  document.getElementById('uiLogin').addEventListener('click', async ()=>{
    const email = document.getElementById('uiEmail').value.trim();
    const pass = document.getElementById('uiPass').value.trim();
    const msgEl = document.getElementById('uiAuthMsg'); msgEl.textContent = '';
    if (!email || !pass) { msgEl.textContent = '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è'; return; }
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      hideAuthModal();
    } catch (e) { console.error(e); msgEl.textContent = e.message || String(e); }
  });
}

/* ------------------ Profile open / editing ------------------ */
profileBtn.addEventListener('click', ()=> {
  if (!auth.currentUser) { showAuthModal(); return; }
  openProfile(auth.currentUser.uid, true);
});
profileClose.addEventListener('click', ()=> hideAuthModal());

async function openProfile(uid){
  profileContent.innerHTML = '<p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>';
  profileModal.style.display='flex'; profileModal.setAttribute('aria-hidden','false');
  try {
    const snap = await dbGet(dbRef(db, `users/${uid}`));
    const user = snap && snap.exists() ? snap.val() : { nick: '–ê–Ω–æ–Ω—ñ–º', avatar: DEFAULT_AVATAR };
    const isSelf = auth.currentUser && auth.currentUser.uid === uid;
    const isAdmin = auth.currentUser && auth.currentUser.email === 'urciknikolaj642@gmail.com';
    profileContent.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center">
        <img id="profImg" src="${user.avatar || DEFAULT_AVATAR}" style="width:112px;height:112px;border-radius:12px;object-fit:cover">
        <div>
          <h3 style="margin:0">${user.nick || '–ê–Ω–æ–Ω—ñ–º'} ${isAdmin? '<span style="display:inline-block;padding:4px 8px;background:#111;color:#fff;border-radius:6px;font-size:12px">ADMIN</span>':''}</h3>
          <div style="color:#666">${user.email || ''}</div>
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        ${isSelf ? '<button id="editAvatarBtn" class="small-btn">–ó–º—ñ–Ω–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä</button><button id="inboxBtn" class="small-btn">–û—Å–æ–±–∏—Å—Ç—ñ</button><button id="logoutBtn" class="small-btn">–í–∏–π—Ç–∏</button>' : `<button id="pmBtn" class="small-btn">–ù–∞–ø–∏—Å–∞—Ç–∏</button><button id="addFriendBtn" class="small-btn">–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>`}
      </div>
      <div id="profileMsg" style="margin-top:8px;color:#b91c1c"></div>
    `;
    if (isSelf) {
      document.getElementById('editAvatarBtn').addEventListener('click', ()=> {
        const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
        inp.addEventListener('change', async ()=> {
          const f = inp.files[0]; if (!f) return;
          try {
            const dataUrl = await resizeImageFile(f, 1000, 0.85);
            await dbSet(dbRef(db, `users/${uid}/avatar`), dataUrl);
            await updateProfile(auth.currentUser, { photoURL: dataUrl });
            document.getElementById('profImg').src = dataUrl;
            profileBtn.style.background = `url(${dataUrl}) center/cover`;
            alert('–ê–≤–∞—Ç–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ');
          } catch (e) { console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–≤–∞—Ç–∞—Ä–∞'); }
        });
        inp.click();
      });
      document.getElementById('inboxBtn').addEventListener('click', ()=> openInbox());
      document.getElementById('logoutBtn').addEventListener('click', async ()=> {
        try { await signOut(auth); alert('–í–∏ –≤–∏–π—à–ª–∏'); profileModal.style.display='none'; } catch(e){ console.error(e); }
      });
    } else {
      document.getElementById('pmBtn').addEventListener('click', ()=> { profileModal.style.display='none'; startPrivateChat(uid); });
      document.getElementById('addFriendBtn').addEventListener('click', async ()=> {
        if (!auth.currentUser) { showAuthModal(); return; }
        try {
          await dbSet(dbRef(db, `friendRequests/${uid}/${auth.currentUser.uid}`), { from: auth.currentUser.uid, ts: Date.now(), nick: auth.currentUser.displayName||auth.currentUser.email });
          document.getElementById('profileMsg').textContent = '–ó–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ.';
        } catch (e) { document.getElementById('profileMsg').textContent = '–ü–æ–º–∏–ª–∫–∞'; console.error(e); }
      });
    }
  } catch (e) { profileContent.innerHTML = '<p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</p>'; console.error(e); }
}

/* ------------------ Notifications panel (bell) ------------------ */
async function updateNotifications(){
  if (!auth.currentUser){ notifCount.style.display = 'none'; return; }
  try {
    const reqSnap = await dbGet(dbRef(db, `friendRequests/${auth.currentUser.uid}`));
    const reqCount = reqSnap && reqSnap.exists() ? Object.keys(reqSnap.val()).length : 0;
    const metaSnap = await dbGet(dbRef(db, `inboxMeta/${auth.currentUser.uid}/unread`));
    const unread = metaSnap && metaSnap.exists() ? Number(metaSnap.val()) : 0;
    const total = reqCount + unread;
    if (total > 0) { notifCount.style.display = 'block'; notifCount.textContent = String(total); } else notifCount.style.display = 'none';
  } catch (e) { console.error(e); }
}
notifBell.addEventListener('click', async ()=> {
  if (!auth.currentUser) { showAuthModal(); return; }
  adminContent.innerHTML = '<h3>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h3><div id="notifList">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
  adminModal.style.display='flex'; adminModal.setAttribute('aria-hidden','false');
  const list = document.getElementById('notifList');
  list.innerHTML = '';
  const rr = await dbGet(dbRef(db, `friendRequests/${auth.currentUser.uid}`));
  if (rr && rr.exists()) {
    const data = rr.val();
    for (const fromUid of Object.keys(data)) {
      const d = data[fromUid];
      const el = document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #eee';
      el.innerHTML = `–ó–∞–ø–∏—Ç –≤—ñ–¥ ${d.nick || d.from} ‚Äî <button data-from="${fromUid}" class="small-btn">–ü—Ä–∏–π–Ω—è—Ç–∏</button> <button data-from2="${fromUid}" class="small-btn">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>`;
      list.appendChild(el);
      el.querySelector('button[data-from]').addEventListener('click', async (e)=> {
        const from = e.target.dataset.from;
        try {
          await dbSet(dbRef(db, `friends/${auth.currentUser.uid}/${from}`), { ts: Date.now() });
          await dbSet(dbRef(db, `friends/${from}/${auth.currentUser.uid}`), { ts: Date.now() });
          await dbRemove(dbRef(db, `friendRequests/${auth.currentUser.uid}/${from}`));
          e.target.closest('div').remove();
          updateNotifications();
          alert('–î–æ–¥–∞–Ω–æ –≤ –¥—Ä—É–∑—ñ');
        } catch (ex) { console.error(ex); }
      });
      el.querySelector('button[data-from2]').addEventListener('click', async (e)=> {
        const from = e.target.dataset.from2;
        await dbRemove(dbRef(db, `friendRequests/${auth.currentUser.uid}/${from}`));
        e.target.closest('div').remove();
        updateNotifications();
      });
    }
  }
  const inbox = await dbGet(dbRef(db, `inboxMeta/${auth.currentUser.uid}`));
  if (inbox && inbox.exists()){
    const data = inbox.val();
    for (const convo in data) {
      if (convo === 'unread') continue;
      const el = document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #eee';
      el.textContent = `–ß–∞—Ç: ${convo} ‚Äî –æ—Å—Ç–∞–Ω–Ω—î: ${new Date(data[convo].lastTs).toLocaleString()}`;
      list.appendChild(el);
    }
  }
  if (list.innerHTML === '') list.innerHTML = '–ù–µ–º–∞—î —Å–ø–æ–≤—ñ—â–µ–Ω—å';
});

/* ------------------ Presence / online counter (√ó10) ------------------ */
function updateOnlineCount(){
  onValue(dbRef(db, 'presence'), (snap)=>{
    const val = snap.val() || {};
    const real = Object.keys(val).length;
    const shown = real * 10;
    // show somewhere ‚Äî for now title on bell
    notifBell && notifBell.setAttribute('title', '–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): ' + shown);
    // optional display in UI: if you have element, set innerText
  });
}

/* ------------------ Auth state changed ------------------ */
onAuthStateChanged(auth, (user)=> {
  currentUser = user;
  if (user) {
    profileBtn.style.background = `url(${user.photoURL || DEFAULT_AVATAR}) center/cover`;
    try { dbSet(dbRef(db, `presence/${user.uid}`), { ts: Date.now(), nick: user.displayName || user.email }); } catch(e){}
  } else {
    profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`;
  }
  updateNotifications();
  updateOnlineCount();
});
window.addEventListener('beforeunload', async ()=> { try{ if (auth.currentUser) await dbRemove(dbRef(db, `presence/${auth.currentUser.uid}`)); }catch(e){} });

/* ------------------ Private messages basics ------------------ */
async function startPrivateChat(otherUid){
  if (!auth.currentUser) { showAuthModal(); return; }
  const uid = auth.currentUser.uid;
  const convoId = uid < otherUid ? uid + '_' + otherUid : otherUid + '_' + uid;
  // open profile modal with PM UI
  profileContent.innerHTML = '<h3>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó...</h3>';
  profileModal.style.display='flex'; profileModal.setAttribute('aria-hidden','false');
  try {
    const msgsSnap = await dbGet(dbRef(db, `privateMessages/${convoId}`));
    const listHtml = document.createElement('div');
    listHtml.style.maxHeight = '50vh';
    listHtml.style.overflow = 'auto';
    listHtml.style.padding = '8px';
    if (msgsSnap && msgsSnap.exists()) {
      const data = msgsSnap.val();
      const keys = Object.keys(data).sort((a,b)=> data[a].ts - data[b].ts);
      for (const k of keys) {
        const m = data[k];
        const el = document.createElement('div');
        el.style.padding = '6px';
        el.style.borderBottom = '1px solid #eee';
        el.innerHTML = `<strong>${m.fromNick||m.from}</strong> ‚Ä¢ ${new Date(m.ts).toLocaleString()}<div>${m.text||''}</div>`;
        listHtml.appendChild(el);
      }
    } else {
      listHtml.innerHTML = '<div style="padding:8px;color:#666">–¢—É—Ç –ø–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</div>';
    }
    profileContent.innerHTML = `<h3>–û—Å–æ–±–∏—Å—Ç—ñ ‚Äî ${convoId}</h3>`;
    profileContent.appendChild(listHtml);
    const compose = document.createElement('div');
    compose.style.marginTop = '10px';
    compose.innerHTML = `<textarea id="pmText" style="width:100%;height:110px;padding:8px;border:1px solid #ddd;border-radius:8px" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."></textarea><div style="display:flex;gap:8px;margin-top:8px"><button id="pmSend" class="send-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button><button id="pmCancel" class="small-btn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button></div>`;
    profileContent.appendChild(compose);
    document.getElementById('pmCancel').addEventListener('click', ()=> { profileModal.style.display='none'; });
    document.getElementById('pmSend').addEventListener('click', async ()=> {
      const text = document.getElementById('pmText').value.trim(); if (!text) return alert('–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç');
      const pm = { from: uid, to: otherUid, text, ts: Date.now(), fromNick: auth.currentUser.displayName || auth.currentUser.email };
      try {
        await dbPush(dbRef(db, `privateMessages/${convoId}`), pm);
        const prev = await dbGet(dbRef(db, `inboxMeta/${otherUid}/unread`)); const cur = prev && prev.exists() ? Number(prev.val()) : 0;
        await dbSet(dbRef(db, `inboxMeta/${otherUid}/unread`), cur + 1);
        await dbSet(dbRef(db, `inboxMeta/${otherUid}/${convoId}`), { lastTs: Date.now(), lastFrom: uid });
        updateNotifications();
        alert('–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ');
        profileModal.style.display='none';
      } catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏'); }
    });
  } catch(e){ console.error(e); profileContent.innerHTML = '<div>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div>'; }
}

/* ------------------ Open Inbox (from profile) ------------------ */
async function openInbox(){
  if (!auth.currentUser) { showAuthModal(); return; }
  profileContent.innerHTML = '<h3>–û—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</h3><div id="inboxList">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
  profileModal.style.display='flex'; profileModal.setAttribute('aria-hidden','false');
  const inboxList = document.getElementById('inboxList');
  try {
    const snap = await dbGet(dbRef(db, `inboxMeta/${auth.currentUser.uid}`));
    const data = snap && snap.exists() ? snap.val() : {};
    inboxList.innerHTML = '';
    for (const k in data) {
      if (k === 'unread') continue;
      const el = document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #eee';
      el.textContent = `${k} ‚Äî –æ—Å—Ç–∞–Ω–Ω—î: ${new Date(data[k].lastTs).toLocaleString()}`;
      el.addEventListener('click', ()=> {
        // determine other user id from convo id
        const other = k.includes('_') ? (k.split('_')[0] === auth.currentUser.uid ? k.split('_')[1] : k.split('_')[0]) : k;
        startPrivateChat(other);
      });
      inboxList.appendChild(el);
    }
    if (!inboxList.children.length) inboxList.innerHTML = '–ü—É—Å—Ç–æ';
  } catch(e) { inboxList.innerHTML = '–ü–æ–º–∏–ª–∫–∞'; console.error(e); }
}

/* ------------------ Message menu (reactions) ------------------ */
const msgMenu = document.getElementById('msgMenu');
function showMsgMenu(x,y,msg,wrap){
  msgMenu.style.left = x + 'px'; msgMenu.style.top = y + 'px'; msgMenu.style.display = 'block';
  const hide = ()=>{ msgMenu.style.display = 'none'; document.removeEventListener('click', hide); };
  document.addEventListener('click', hide, { once:true });
  msgMenu.querySelectorAll('button').forEach(btn=>{
    btn.onclick = async ()=>{
      const act = btn.dataset.act;
      try {
        if (act === 'reply') {
          const r = prompt('–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:');
          if (r) {
            await dbPush(dbRef(db, 'messages'), {
              uid: auth.currentUser.uid,
              nick: auth.currentUser.displayName || auth.currentUser.email,
              avatar: auth.currentUser.photoURL || DEFAULT_AVATAR,
              text: '‚Ü™Ô∏è –í—ñ–¥–ø–æ–≤—ñ–¥—å: ' + r,
              ts: Date.now(),
              recipientUid: msg.uid
            });
          }
        } else {
          if (!msg.id) { alert('–ù–µ–º–∞—î id –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è'); return; }
          await dbSet(dbRef(db, `messageReactions/${msg.id}/${auth.currentUser?auth.currentUser.uid:'anon'}`), { act, ts: Date.now() });
          alert('–î—ñ—è: ' + act);
        }
      } catch (e) { console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –¥—ñ—ó'); }
    };
  });
}

/* ------------------ ADMIN: panel, tools (openAdminPanel via contextmenu on profile btn) ------------------ */
const ADMIN_EMAIL = 'urciknikolaj642@gmail.com';
adminClose.addEventListener('click', ()=> { adminModal.style.display='none'; });

async function openAdminPanel(){
  if (!auth.currentUser || auth.currentUser.email !== ADMIN_EMAIL) { alert('–î–æ—Å—Ç—É–ø –ª–∏—à–µ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞'); return; }
  adminModal.style.display='flex'; adminModal.setAttribute('aria-hidden','false');
  adminContent.innerHTML = '<h3>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h3><div id="adminInner">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
  const inner = document.getElementById('adminInner');
  inner.innerHTML = `
    <div class="admin-panel">
      <div class="admin-row"><label>–ë–æ—Ç–∏:</label><button id="toggleBots" class="small-btn">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</button><button id="viewBotLog" class="small-btn">–õ–æ–≥ –±–æ—Ç—ñ–≤</button></div>
      <div class="admin-row"><label>–ü–æ—à—É–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å:</label><input id="adminQuery" placeholder="–∫–ª—é—á–æ–≤–µ —Å–ª–æ–≤–æ"/><button id="searchMsgs" class="small-btn">–ü–æ—à—É–∫</button></div>
      <div class="admin-row"><label>–ë–∞–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (UID):</label><input id="banUid" placeholder="UID"/><button id="banBtn" class="small-btn">–ó–∞–±–∞–Ω–∏—Ç–∏</button><button id="unbanBtn" class="small-btn">–†–æ–∑–±–∞–Ω–∏—Ç–∏</button></div>
      <div class="admin-row"><label>–¢–µ—Ö. —Ä–µ–∂–∏–º:</label><button id="toggleMaintenance" class="small-btn">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏</button></div>
      <div class="admin-row"><label>–ï–∫—Å–ø–æ—Ä—Ç:</label><button id="exportMsgs" class="small-btn">–ï–∫—Å–ø–æ—Ä—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</button></div>
      <div id="adminResults" style="margin-top:10px;max-height:40vh;overflow:auto"></div>
    </div>
  `;
  // buttons wiring
  document.getElementById('toggleBots').addEventListener('click', async ()=>{
    const ref = dbRef(db, 'settings/botsEnabled'); const s = await dbGet(ref); const cur = s && s.exists() ? Boolean(s.val()) : false;
    await dbSet(ref, !cur); document.getElementById('toggleBots').textContent = !cur ? '–í–∏–º–∫–Ω—É—Ç–∏ –±–æ—Ç–∏' : '–£–≤—ñ–º–∫–Ω—É—Ç–∏ –±–æ—Ç–∏';
  });
  document.getElementById('viewBotLog').addEventListener('click', async ()=>{
    const snap = await dbGet(dbRef(db, 'botPosts')); const out = document.getElementById('adminResults'); out.innerHTML = '';
    if (snap && snap.exists()){
      const data = snap.val();
      Object.keys(data).reverse().slice(0,200).forEach(k=>{
        const m = data[k];
        const d = document.createElement('div'); d.style.padding='6px'; d.style.borderBottom='1px solid #eee'; d.textContent = `${m.nick||m.uid} ‚Ä¢ ${new Date(m.ts).toLocaleString()} ‚Ä¢ ${m.text||''}`; out.appendChild(d);
      });
    } else out.innerHTML='–õ–æ–≥—É –Ω–µ–º–∞—î';
  });
  document.getElementById('searchMsgs').addEventListener('click', async ()=>{
    const q = document.getElementById('adminQuery').value.trim().toLowerCase(); const out = document.getElementById('adminResults'); out.innerHTML='–ü–æ—à—É–∫...';
    if (!q) return out.innerHTML='–í–≤–µ–¥—ñ—Ç—å –∑–∞–ø–∏—Ç';
    const s = await dbGet(dbRef(db, 'messages')); out.innerHTML=''; if (!s || !s.exists()) return out.innerHTML='–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –Ω–µ–º–∞—î';
    const all = s.val(); Object.keys(all).forEach(k=>{
      const m = all[k];
      if ((m.text||'').toLowerCase().includes(q) || (m.nick||'').toLowerCase().includes(q)){
        const d=document.createElement('div'); d.style.padding='6px'; d.style.borderBottom='1px solid #eee';
        d.innerHTML = `<strong>${m.nick||m.uid}</strong> ‚Ä¢ ${new Date(m.ts).toLocaleString()}<div>${m.text||''}</div><div style="margin-top:6px"><button data-del="${k}" class="small-btn">–í–∏–¥–∞–ª–∏—Ç–∏</button></div>`;
        out.appendChild(d);
        d.querySelector('[data-del]').addEventListener('click', async (e)=>{ if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')) return; await dbRemove(dbRef(db, `messages/${e.target.dataset.del}`)); e.target.closest('div').remove(); });
      }
    });
  });
  document.getElementById('banBtn').addEventListener('click', async ()=>{
    const uid = document.getElementById('banUid').value.trim(); if (!uid) return alert('UID?'); await dbSet(dbRef(db, `users/${uid}/banned`), true); alert('–ó–∞–±–∞–Ω–µ–Ω–æ ' + uid);
  });
  document.getElementById('unbanBtn').addEventListener('click', async ()=>{ const uid=document.getElementById('banUid').value.trim(); if (!uid) return alert('UID?'); await dbSet(dbRef(db, `users/${uid}/banned`), false); alert('–†–æ–∑–±–∞–Ω–µ–Ω–æ ' + uid); });
  document.getElementById('toggleMaintenance').addEventListener('click', async ()=>{ const ref=dbRef(db,'settings/maintenance'); const s=await dbGet(ref); const cur=s && s.exists()?Boolean(s.val()):false; await dbSet(ref,!cur); alert('Maintenance: ' + (!cur)); });
  document.getElementById('exportMsgs').addEventListener('click', async ()=>{
    const snap = await dbGet(dbRef(db,'messages')); if (!snap || !snap.exists()) return alert('–ù–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å'); const data=snap.val(); const blob = new Blob([JSON.stringify(data)], {type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='messages_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
}
// open admin by contextmenu on profile
profileBtn.addEventListener('contextmenu', (e)=> { e.preventDefault(); openAdminPanel(); });

/* ------------------ BOTS: 3 bots with intervals 2/3/4 min ------------------ */
const BOT_UIDS = ['bot_1_pf','bot_2_pf','bot_3_pf'];
const BOT_USERS = [
  {
    uid: 'bot_1_pf',
    nick: 'Oleh S.',
    avatar: 'https://i.ibb.co/LH4wBMS/IMG-d8e6076e17f19db7fe3add0754738a01-V.jpg',
    ads: [
      { text: `O2 –°–Ü–ú –ö–ê–†–¢–ê\n–ë–µ–∑ –ªi–ºi—Ç —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç\n–ë–µ–∑ –ªi–ºi—Ç –¥–∑–≤—ñ–Ω–∫–∏\n–ü—Ä–∞—Ü—é—î –≤ –Ñ–≤—Ä–æ–ø—ñ\n–ü–ª–∞—Ç–∞ 699 –∫—Ä–æ–Ω/–º—ñ—Å. –¶—ñ–Ω–∞ 299–∫c. –¢–µ–ª: 607914467. Viber/WhatsApp/Telegram.`, image: null },
      { text: `–î–æ–±—Ä–æ–≥–æ –¥–Ω—è! –ü—Ä–æ–¥–∞—é iPhone 11 Pro Max —Ä–∞–∑–æ–º —ñ–∑ 26 —á–æ—Ö–ª–∞–º–∏ ‚Äî –¥–µ—Ç–∞–ª—ñ –≤ –ø—Ä–∏–≤–∞—Ç.`, image: 'https://i.ibb.co/dwcXPqDr/IMG-1954f6b56869b9817a131ae33f3a37b6-V.jpg' },
      { text: null, image: 'https://i.ibb.co/G3kDcrYZ/IMG-fa590121e46c5b030c5ddc94d4e8bea9-V.jpg' }
    ]
  },
  {
    uid: 'bot_2_pf',
    nick: 'Anna M.',
    avatar: 'https://i.ibb.co/QFWDvGZ8/IMG-6748e7141906901b131b8fd5130a5c01-V.jpg',
    ads: [
      { text: `–ó–∞–ø—Ä–æ—à—É—é –º–æ–¥–µ–ª–µ–π –Ω–∞ –ø–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω–∏–π –º–∞–∫—ñ—è–∂ –≤—ñ–¥ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ–≥–æ –º–∞–π—Å—Ç—Ä–∞. –ü—Ä–∞–≥–∞.`, image: 'https://i.ibb.co/QFWDvGZ8/IMG-6748e7141906901b131b8fd5130a5c01-V.jpg' },
      { text: `–§–æ—Ç–æ –ø—Ä–∏–∫–ª–∞–¥ ‚Äî –¥–µ—Ç–∞–ª—ñ –≤ –ø—Ä–∏–≤–∞—Ç.`, image: 'https://i.ibb.co/j97RhTny/IMG-593d75b053ea1a28cdfb9fc52f93afad-V.jpg' },
      { text: null, image: 'https://i.ibb.co/Z11WVrVC/IMG-b83692bb79a1468af74c81620750e8c0-V.jpg' }
    ]
  },
  {
    uid: 'bot_3_pf',
    nick: 'Marek H.',
    avatar: 'https://i.ibb.co/rfNV6ddC/IMG-0cd648a74f86227fe46db2d01c099be0-V.jpg',
    ads: [
      { text: `–ù—É–∂–µ–Ω –≤–æ–¥–∏—Ç–µ–ª—å –¥–ª—è –ø–æ–º–æ—â–∏ –≤ –ø–µ—Ä–µ–µ–∑–¥–µ, —Å–æ —Å–≤–æ–∏–º –∞–≤—Ç–æ, –ø–∏—à–∏—Ç–µ –Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç—ã, –æ–±—Å—É–¥–∏–º –¥–µ—Ç–∞–ª–∏\nWhatsApp: +48 793 463 757 ‚Ä¢ Telegram: @carlx_xxx`, image: null },
      { text: null, image: 'https://i.ibb.co/MzdTMPR/IMG-8231d8142ffcbba7c682ca598683e3f2-V.jpg' },
      { text: null, image: 'https://i.ibb.co/rfNV6ddC/IMG-0cd648a74f86227fe46db2d01c099be0-V.jpg' }
    ]
  }
];
const SCHEDULE = [{botIdx:0,wait:2*60*1000},{botIdx:1,wait:3*60*1000},{botIdx:2,wait:4*60*1000}];
let botsController = { enabled:false, running:false, seqPos:0, loopId:null };

// Listen DB setting
onValue(dbRef(db,'settings/botsEnabled'), (snap)=>{
  const val = snap && snap.exists()?Boolean(snap.val()):false;
  botsController.enabled = val;
  if (val && !botsController.running) startBots();
  if (!val && botsController.running) stopBots();
});

async function startBots(){
  if (botsController.running) return;
  botsController.running = true; botsController.seqPos = 0;
  (async function loop(){
    if (!botsController.enabled) { botsController.running=false; return; }
    const s = SCHEDULE[botsController.seqPos % SCHEDULE.length];
    const bot = BOT_USERS[s.botIdx];
    const adIndex = Math.floor(Date.now() / (60*1000)) % bot.ads.length;
    const ad = bot.ads[adIndex];
    try {
      await dbPush(dbRef(db,'messages'), {
        uid: bot.uid, nick: bot.nick, avatar: bot.avatar,
        text: ad.text, image: ad.image || null, ts: Date.now()
      });
      await dbPush(dbRef(db,'botPosts'), { uid:bot.uid, nick:bot.nick, text:ad.text, ts:Date.now() });
    } catch(e){ console.error('bot push err', e); }
    botsController.seqPos++;
    botsController.loopId = setTimeout(loop, s.wait);
  })();
}
function stopBots(){ if (botsController.loopId) clearTimeout(botsController.loopId); botsController.running=false; botsController.loopId=null; }

/* ------------------ MAP: 15 points in Prague with images ------------------ */
const MAP_POINTS = [
  { title:'Nemocnice Motol', pos:{lat:50.058000,lng:14.360000}, cat:'health', img:'https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp' },
  { title:'V√°clavsk√© n√°mƒõst√≠', pos:{lat:50.081400,lng:14.425300}, cat:'info', img:'' },
  { title:'Staromƒõstsk√© n√°mƒõst√≠', pos:{lat:50.087000,lng:14.420800}, cat:'info', img:'' },
  { title:'Karl≈Øv most', pos:{lat:50.086500,lng:14.411400}, cat:'info', img:'' },
  { title:'Pra≈æsk√Ω hrad', pos:{lat:50.090200,lng:14.398100}, cat:'help', img:'' },
  { title:'Hlavn√≠ n√°dra≈æ√≠', pos:{lat:50.084600,lng:14.433600}, cat:'transit', img:'' },
  { title:'Andƒõl (Sm√≠chov)', pos:{lat:50.059100,lng:14.399800}, cat:'shops', img:'' },
  { title:'Florenc Bus Hub', pos:{lat:50.088600,lng:14.433700}, cat:'volunteer', img:'' },
  { title:'≈Ωi≈ækov TV Tower', pos:{lat:50.082500,lng:14.450600}, cat:'info', img:'' },
  { title:'Letn√°', pos:{lat:50.092600,lng:14.419600}, cat:'park', img:'' },
  { title:'Vy≈°ehrad', pos:{lat:50.064900,lng:14.417800}, cat:'help', img:'' },
  { title:'N√°rodn√≠ muzeum', pos:{lat:50.075500,lng:14.430700}, cat:'info', img:'' },
  { title:'Karl√≠n', pos:{lat:50.092000,lng:14.457600}, cat:'volunteer', img:'' },
  { title:'Hole≈°ovice', pos:{lat:50.107400,lng:14.454800}, cat:'shops', img:'' },
  { title:'Vr≈°ovice', pos:{lat:50.069100,lng:14.451000}, cat:'housing', img:'' }
];

window.initMap = function(){
  try {
    const center = { lat:50.0755, lng:14.4378 };
    window.map = new google.maps.Map(mapEl, { center, zoom:12, gestureHandling:'greedy' });
    window.markers = [];
    MAP_POINTS.forEach(p=>{
      const marker = new google.maps.Marker({ position: p.pos, map: window.map, title: p.title });
      const content = `<div style="width:220px"><strong>${p.title}</strong>${p.img?`<div><img src='${p.img}' style='width:100%;border-radius:6px;margin-top:6px'></div>`:''}</div>`;
      const inf = new google.maps.InfoWindow({ content });
      marker.addListener('click', ()=> inf.open(window.map, marker));
      window.markers.push(marker);
    });
    centerBtn.addEventListener('click', ()=> window.map.panTo(center));
    mapSearch && mapSearch.addEventListener('input', (e)=> {
      const q = e.target.value.trim().toLowerCase();
      window.markers.forEach(mk => mk.setVisible(!q || mk.getTitle().toLowerCase().includes(q)));
    });
  } catch(e){ console.error('initMap', e); }
};

function loadMapsWithKey(){
  const key = 'AIzaSyBFrxVhpb6nHJ6rhiLl5Ho8t0jOb1iEQNc';
  if (!key) return;
  if (document.querySelector('script[data-maps]')) return;
  const script = document.createElement('script');
  script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&callback=initMap`;
  script.async = true; script.defer = true; script.setAttribute('data-maps','1');
  document.head.appendChild(script);
}

/* ------------------ Bootstrapping on DOMContentLoaded ------------------ */
document.addEventListener('DOMContentLoaded', ()=>{
  // set default profile icon
  profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`;
  // ensure images responsive (already in CSS)
  loadMapsWithKey();
  // update notifications periodically
  setInterval(()=> updateNotifications(), 8000);
});

/* ------------------ Expose debug functions for console use ------------------ */
window.PF = {
  startBots, stopBots, openAdminPanel, startPrivateChat, loadMapsWithKey, BOT_USERS
};

/* =========================
   END OF PART 2
   ========================= */
</script>
<script type="module">
/* PART 3 ‚Äî Friends UI, Reports, Moderation helpers, user export (download), image lightbox, UI polish */

import { getDatabase, ref as dbRef, get as dbGet, set as dbSet, push as dbPush, onValue, remove as dbRemove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

const db3 = getDatabase();
const auth3 = getAuth();

// Create modals we need (friends modal, reports modal, image lightbox)
(function createExtraModals(){
  // Friends modal
  if (!document.getElementById('friendsModal')) {
    const fm = document.createElement('div');
    fm.id = 'friendsModal';
    fm.className = 'modal';
    fm.style.display = 'none';
    fm.innerHTML = `<div class="modal-panel"><button class="modal-close" id="friendsClose">‚úï</button><div id="friendsContent">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>`;
    document.body.appendChild(fm);
    document.getElementById('friendsClose').addEventListener('click', ()=> fm.style.display='none');
  }

  // Reports / moderation modal (for mods/admin)
  if (!document.getElementById('reportsModal')) {
    const rm = document.createElement('div');
    rm.id = 'reportsModal';
    rm.className = 'modal';
    rm.style.display = 'none';
    rm.innerHTML = `<div class="modal-panel"><button class="modal-close" id="reportsClose">‚úï</button><div id="reportsContent">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>`;
    document.body.appendChild(rm);
    document.getElementById('reportsClose').addEventListener('click', ()=> rm.style.display='none');
  }

  // Image lightbox
  if (!document.getElementById('imageLightbox')) {
    const lb = document.createElement('div');
    lb.id = 'imageLightbox';
    lb.className = 'modal';
    lb.style.display = 'none';
    lb.innerHTML = `<div class="modal-panel" style="max-width:90%;background:transparent;box-shadow:none"><button class="modal-close" id="lbClose" style="position:absolute;right:10px;top:10px;background:#fff;border-radius:8px;padding:6px">‚úï</button><img id="lbImg" src="" style="width:100%;height:auto;border-radius:12px;display:block"></div>`;
    document.body.appendChild(lb);
    document.getElementById('lbClose').addEventListener('click', ()=> lb.style.display='none');
  }
})();

// Open friends modal and show friend requests + friends + online status
const friendsBtnEl = document.getElementById('friendsBtn');
friendsBtnEl && friendsBtnEl.addEventListener('click', ()=> openFriendsModal());

async function openFriendsModal(){
  const modal = document.getElementById('friendsModal');
  const container = document.getElementById('friendsContent');
  container.innerHTML = '<h3>–î—Ä—É–∑—ñ / –ó–∞—è–≤–∫–∏</h3><div id="friendInner">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
  modal.style.display='flex';
  if (!auth3.currentUser) { container.innerHTML = '<div>–í—Ö—ñ–¥ –ø–æ—Ç—Ä—ñ–±–µ–Ω</div>'; return; }
  const uid = auth3.currentUser.uid;
  try {
    const reqSnap = await dbGet(dbRef(db3, `friendRequests/${uid}`));
    const friendsSnap = await dbGet(dbRef(db3, `friends/${uid}`));
    const inner = document.getElementById('friendInner');
    inner.innerHTML = '';
    // Requests
    const reqs = reqSnap && reqSnap.exists() ? reqSnap.val() : {};
    const reqKeys = Object.keys(reqs || {});
    if (reqKeys.length) {
      const h = document.createElement('div'); h.innerHTML = '<strong>–ó–∞—è–≤–∫–∏:</strong>'; inner.appendChild(h);
      reqKeys.forEach(k=>{
        const r = reqs[k];
        const el = document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #eee';
        el.innerHTML = `${r.nick||r.from} <button data-acc="${k}" class="small-btn">–ü—Ä–∏–π–Ω—è—Ç–∏</button> <button data-rej="${k}" class="small-btn">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>`;
        inner.appendChild(el);
        el.querySelector('[data-acc]').addEventListener('click', async (e)=> {
          const fid = e.target.dataset.acc;
          await dbSet(dbRef(db3, `friends/${uid}/${fid}`), { ts: Date.now() });
          await dbSet(dbRef(db3, `friends/${fid}/${uid}`), { ts: Date.now() });
          await dbRemove(dbRef(db3, `friendRequests/${uid}/${fid}`));
          el.remove();
        });
        el.querySelector('[data-rej]').addEventListener('click', async (e)=> {
          const fid = e.target.dataset.rej;
          await dbRemove(dbRef(db3, `friendRequests/${uid}/${fid}`));
          el.remove();
        });
      });
    }

    // Friends list
    const friends = friendsSnap && friendsSnap.exists() ? friendsSnap.val() : {};
    const friendIds = Object.keys(friends || {});
    const listWrap = document.createElement('div'); listWrap.innerHTML = '<strong>–î—Ä—É–∑—ñ:</strong>';
    inner.appendChild(listWrap);
    if (!friendIds.length) {
      const p = document.createElement('div'); p.style.padding='8px'; p.textContent = '–ù–µ–º–∞—î –¥—Ä—É–∑—ñ–≤';
      listWrap.appendChild(p);
    } else {
      for (const fid of friendIds) {
        try {
          const uSnap = await dbGet(dbRef(db3, `users/${fid}`));
          const u = uSnap && uSnap.exists() ? uSnap.val() : { nick:'–ê–Ω–æ–Ω—ñ–º', avatar:DEFAULT_AVATAR };
          const p = document.createElement('div'); p.style.padding='8px'; p.style.borderBottom='1px solid #eee';
          const onlineSnap = await dbGet(dbRef(db3, `presence/${fid}`));
          const isOnline = onlineSnap && onlineSnap.exists();
          p.innerHTML = `<img src="${u.avatar||DEFAULT_AVATAR}" style="width:36px;height:36px;border-radius:8px;vertical-align:middle;margin-right:8px"> <strong>${u.nick||fid}</strong> ${isOnline?'<span style="color:green;margin-left:8px">‚óè</span>':''} <div style="float:right"><button data-pm="${fid}" class="small-btn">PM</button></div>`;
          listWrap.appendChild(p);
          p.querySelector('[data-pm]').addEventListener('click', ()=> startPrivateChat(fid));
        } catch(e){ console.error('friend render err', e); }
      }
    }
  } catch(e){ console.error(e); container.innerHTML = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è'; }
}

// Image click -> open lightbox
document.addEventListener('click', (ev)=>{
  const t = ev.target;
  if (t.classList && t.classList.contains('chat-image')) {
    const lb = document.getElementById('imageLightbox');
    const img = document.getElementById('lbImg');
    img.src = t.src;
    lb.style.display='flex';
  }
});

// Reports: user can report a message (add button to msg menu)
(function enhanceMsgMenuWithReport(){
  const menu = document.getElementById('msgMenu');
  if (!menu) return;
  const btn = document.createElement('button');
  btn.dataset.act = 'report';
  btn.textContent = '‚ö†Ô∏è –ü–æ—Å–∫–∞—Ä–∂–∏—Ç–∏—Å—å';
  menu.appendChild(btn);
  btn.addEventListener('click', async ()=>{
    // current selected message should be stored globally when opening menu; fallback prompt
    const targetMsgId = menu.dataset.msgid;
    if (!targetMsgId) { alert('–ù–µ –≤–∏–±—Ä–∞–Ω–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è'); return; }
    const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ —Å–∫–∞—Ä–≥–∏ (–∫–æ—Ä–æ—Ç–∫–æ):');
    if (!reason) return;
    try {
      await dbPush(dbRef(db3, `reports/${targetMsgId}`), { from: auth3.currentUser ? auth3.currentUser.uid : 'anon', reason, ts: Date.now() });
      alert('–°–∫–∞—Ä–≥–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞');
    } catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ —Å–∫–∞—Ä–≥–∏'); }
  });
})();

// When showing menu, set dataset.msgid for report
const originalShowMsgMenu = window.showMsgMenu || null;
window.showMsgMenu = function(x,y,msg,wrap){
  const menu = document.getElementById('msgMenu');
  if (!menu) return;
  menu.dataset.msgid = msg && msg.id ? msg.id : '';
  originalShowMsgMenu ? originalShowMsgMenu(x,y,msg,wrap) : menu.style.display='block';
};

// Moderation view (admins/mods can open reportsModal)
async function openReportsModal(){
  const modal = document.getElementById('reportsModal');
  const container = document.getElementById('reportsContent');
  modal.style.display='flex';
  container.innerHTML = '<h3>–ñ–∞–ª–æ–±–∏</h3><div id="reportsInner">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
  try {
    const snap = await dbGet(dbRef(db3, 'reports'));
    const inner = document.getElementById('reportsInner');
    inner.innerHTML = '';
    if (!snap || !snap.exists()) { inner.innerHTML = '<div>–ñ–∞–ª–æ–± –Ω–µ–º–∞—î</div>'; return; }
    const data = snap.val();
    for (const msgId of Object.keys(data)) {
      const arr = data[msgId];
      // arr is object of push keys
      for (const pk of Object.keys(arr)) {
        const r = arr[pk];
        const box = document.createElement('div'); box.style.padding='8px'; box.style.borderBottom='1px solid #eee';
        box.innerHTML = `<div><strong>–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:</strong> ${msgId}</div><div>–ü—Ä–∏—á–∏–Ω–∞: ${r.reason}</div><div>–í—ñ–¥: ${r.from}</div><div style="margin-top:6px"><button data-rem="${msgId}" class="small-btn">–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–≤–Ω—ñ—Å—Ç—é</button> <button data-mark="${msgId}" class="small-btn">–í—ñ–¥–∑–Ω–∞—á–∏—Ç–∏ —è–∫ —Ä–æ–∑–≥–ª—è–Ω—É—Ç–æ</button></div>`;
        inner.appendChild(box);
        box.querySelector('[data-rem]').addEventListener('click', async (e)=>{
          if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —ñ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –∂–∞–ª–æ–±–∏?')) return;
          try { await dbRemove(dbRef(db3, `messages/${e.target.dataset.rem}`)); await dbRemove(dbRef(db3, `reports/${e.target.dataset.rem}`)); box.remove(); alert('–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ'); } catch(err){ console.error(err); alert('–ü–æ–º–∏–ª–∫–∞'); }
        });
        box.querySelector('[data-mark]').addEventListener('click', async (e)=>{
          await dbRemove(dbRef(db3, `reports/${e.target.dataset.mark}`));
          box.remove();
        });
      }
    }
  } catch(e){ console.error(e); container.innerHTML = '–ü–æ–º–∏–ª–∫–∞'; }
}

// Add quick moderator open if admin: right-click on bell to open reports
notifBell && notifBell.addEventListener('contextmenu', (ev)=>{
  ev.preventDefault();
  // Only allow for admin/mods
  if (!auth3.currentUser) return;
  if (auth3.currentUser.email === 'urciknikolaj642@gmail.com') openReportsModal();
});

// Export "insurance" code or main backup to file
async function exportUserBackupToFile(){
  if (!auth3.currentUser) { alert('–í—Ö—ñ–¥ –ø–æ—Ç—Ä—ñ–±–µ–Ω'); return; }
  // We'll export user's public profile + messages (safe)
  try {
    const uid = auth3.currentUser.uid;
    const userSnap = await dbGet(dbRef(db3, `users/${uid}`));
    const msgsSnap = await dbGet(dbRef(db3, `messages`));
    const userData = { user: userSnap && userSnap.exists() ? userSnap.val() : {}, messages: msgsSnap && msgsSnap.exists() ? msgsSnap.val() : {} };
    const blob = new Blob([JSON.stringify(userData, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `backup_user_${uid}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    alert('–§–∞–π–ª –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ');
  } catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ–∞–π–ª—É'); }
}

// Add a small menu item in profile modal for export
(function addExportToProfile(){
  // patch openProfile to insert export button when self
  const oldOpen = window.openProfile;
  window.openProfile = async function(uid, selfOverride){
    await oldOpen(uid, selfOverride);
    try {
      if (auth3.currentUser && auth3.currentUser.uid === uid) {
        const wrap = document.getElementById('profileContent');
        const btn = document.createElement('button'); btn.className='small-btn'; btn.style.marginLeft='6px'; btn.textContent='–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–µ–∑–µ—Ä–≤';
        wrap.querySelector('div[style*="margin-top:12px"]').appendChild(btn);
        btn.addEventListener('click', exportUserBackupToFile);
      }
    } catch(e){}
  };
})();

</script>
<script type="module">
/* PART 4 ‚Äî Admin statistics, cleanup tools, UI/mobile polish, rate-limit & safety improvements, final glue */

import { getDatabase, ref as dbRef, get as dbGet, set as dbSet, remove as dbRemove, push as dbPush, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

const db4 = getDatabase();
const auth4 = getAuth();

// Admin stats UI: show counts and simple activity metrics
async function openAdminStats(){
  if (!auth4.currentUser || auth4.currentUser.email !== 'urciknikolaj642@gmail.com') { alert('–¢—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞'); return; }
  const modal = document.getElementById('adminModal');
  modal.style.display='flex';
  adminContent.innerHTML = '<h3>–ê–¥–º—ñ–Ω –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3><div id="statsInner">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
  const out = document.getElementById('statsInner');
  out.innerHTML = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
  try {
    const usersSnap = await dbGet(dbRef(db4, 'users'));
    const msgsSnap = await dbGet(dbRef(db4, 'messages'));
    const botSnap = await dbGet(dbRef(db4, 'botPosts'));
    const presSnap = await dbGet(dbRef(db4, 'presence'));
    const usersCount = usersSnap && usersSnap.exists() ? Object.keys(usersSnap.val()).length : 0;
    const msgsCount = msgsSnap && msgsSnap.exists() ? Object.keys(msgsSnap.val()).length : 0;
    const botCount = botSnap && botSnap.exists() ? Object.keys(botSnap.val()).length : 0;
    const presCount = presSnap && presSnap.exists() ? Object.keys(presSnap.val()).length : 0;
    const shown = presCount * 10;
    out.innerHTML = `<div>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ: <strong>${usersCount}</strong></div><div>–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (–≤—Å—å–æ–≥–æ): <strong>${msgsCount}</strong></div><div>–ü–æ—Å—Ç–∏ –±–æ—Ç—ñ–≤: <strong>${botCount}</strong></div><div>–†–µ–∞–ª—å–Ω–æ –æ–Ω–ª–∞–π–Ω: <strong>${presCount}</strong> ‚Üí –ø–æ–∫–∞–∑–∞–Ω–æ: <strong>${shown}</strong></div><div style="margin-top:10px"><button id="cleanupOld" class="small-btn">–û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Å—Ç–∞—Ä—ñ—à–µ (N –¥–Ω—ñ–≤)</button> <input id="cleanupDays" style="width:60px" value="30"></div><div style="margin-top:10px"><button id="downloadAll" class="small-btn">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤–µ—Å—å –¥–∞–º–ø –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</button></div>`;
    document.getElementById('cleanupOld').addEventListener('click', async ()=>{
      const days = Number(document.getElementById('cleanupDays').value || 30);
      if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Å—Ç–∞—Ä—à–µ ${days} –¥–Ω—ñ–≤?`)) return;
      try {
        const snap = await dbGet(dbRef(db4, 'messages'));
        if (!snap || !snap.exists()) { alert('–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –Ω–µ–º–∞—î'); return; }
        const all = snap.val();
        const now = Date.now();
        const cutoff = now - days * 24 * 60 * 60 * 1000;
        let removed = 0;
        for (const k of Object.keys(all)) {
          const m = all[k];
          if (m.ts && Number(m.ts) < cutoff) {
            await dbRemove(dbRef(db4, `messages/${k}`));
            removed++;
          }
        }
        alert('–í–∏–¥–∞–ª–µ–Ω–æ ' + removed);
      } catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –æ—á–∏—â–µ–Ω–Ω—è'); }
    });
    document.getElementById('downloadAll').addEventListener('click', async ()=>{
      const snap = await dbGet(dbRef(db4,'messages'));
      if (!snap || !snap.exists()) return alert('–ù–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å');
      const data = snap.val();
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='messages_all.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
  } catch(e){ console.error(e); out.innerHTML = '–ü–æ–º–∏–ª–∫–∞'; }
}

// Add admin stats quick access on admin modal top
(function addAdminStatsShortcut(){
  const oldOpen = window.openAdminPanel;
  window.openAdminPanel = async function(){
    await oldOpen();
    const adminInner = document.getElementById('adminInner');
    if (!adminInner) return;
    // add a button
    const btn = document.createElement('button');
    btn.className='small-btn';
    btn.textContent = '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞';
    adminInner.prepend(btn);
    btn.addEventListener('click', openAdminStats);
  };
})();

// Rate-limit enforcement per-IP is not possible client-side; we keep per-UID simple limit and serverless check.
// We'll also stop display of welcome system message ‚Äî instead show per-user toast upon login.
function showLoginToastIfNeeded(){
  if (!auth4.currentUser) return;
  // Show small temporary toast in top center
  const key = 'welcome_shown_' + auth4.currentUser.uid;
  if (localStorage.getItem(key)) return;
  localStorage.setItem(key, '1');
  const t = document.createElement('div');
  t.style.position='fixed'; t.style.top='80px'; t.style.left='50%'; t.style.transform='translateX(-50%)'; t.style.zIndex='400';
  t.style.background='rgba(0,0,0,0.7)'; t.style.color='#fff'; t.style.padding='10px 14px'; t.style.borderRadius='10px'; t.style.boxShadow='0 8px 30px rgba(0,0,0,0.4)';
  t.textContent = '–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ! –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ç–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –±—É–¥—É—Ç—å –Ω–∞–¥—Ö–æ–¥–∏—Ç–∏ —Å—é–¥–∏.';
  document.body.appendChild(t);
  setTimeout(()=> t.remove(), 7500);
}

// Observe auth changes to show login toast
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
onAuthStateChanged(auth4, (u)=> { if (u) showLoginToastIfNeeded(); });

// Small UI polish: make sure long words wrap and images never cause horizontal scroll (reinforce)
(function enforceNoHScroll(){
  document.documentElement.style.overflowX='hidden';
  document.body.style.overflowX='hidden';
  const style = document.createElement('style');
  style.innerHTML = ` .message-content { word-break:break-word; overflow-wrap:break-word; } .chat-image { max-width:100%; height:auto; display:block; } `;
  document.head.appendChild(style);
})();

// Add unread badge next to profile when PMs exist
async function refreshPmBadge(){
  if (!auth4.currentUser) { /* hide badge */ return; }
  const uid = auth4.currentUser.uid;
  const s = await dbGet(dbRef(db4, `inboxMeta/${uid}/unread`));
  const unread = s && s.exists() ? Number(s.val()) : 0;
  // Add small red dot on profile button or change border
  const el = document.getElementById('profileBtn');
  if (!el) return;
  // create badge element if needed
  let b = el.querySelector('.pm-badge');
  if (!b) { b = document.createElement('div'); b.className='pm-badge'; b.style.position='absolute'; b.style.right='-2px'; b.style.top='-2px'; b.style.background='#ef4444'; b.style.color='#fff'; b.style.borderRadius='50%'; b.style.padding='3px 6px'; b.style.fontSize='12px'; b.style.boxShadow='0 2px 6px rgba(0,0,0,0.3)'; el.style.position='relative'; el.appendChild(b); }
  if (unread > 0) { b.style.display='block'; b.textContent = unread; } else b.style.display='none';
}

// call periodically
setInterval(()=>{ refreshPmBadge(); updateNotifications(); updateOnlineCount(); }, 8000);

// Add a small toolbar for mobile: scroll-to-bottom button
(function addScrollBottomBtn(){
  const btn = document.createElement('button');
  btn.textContent = '‚Üì';
  btn.title = '–í–Ω–∏–∑';
  btn.style.position='fixed';
  btn.style.right='12px';
  btn.style.bottom='90px';
  btn.style.zIndex='120';
  btn.style.width='44px';
  btn.style.height='44px';
  btn.style.borderRadius='50%';
  btn.style.border='none';
  btn.style.background='rgba(0,0,0,0.6)';
  btn.style.color='#fff';
  btn.style.fontSize='20px';
  btn.style.display='none';
  document.body.appendChild(btn);
  btn.addEventListener('click', ()=> {
    const active = document.querySelector('.tab-content.active .chat-area');
    if (active) active.scrollTop = active.scrollHeight;
  });
  // show/hide on scroll
  document.addEventListener('scroll', ()=> {
    const active = document.querySelector('.tab-content.active .chat-area');
    if (!active) return;
    const nearBottom = active.scrollHeight - active.scrollTop - active.clientHeight < 250;
    btn.style.display = nearBottom ? 'none' : 'block';
  }, { passive:true });
})();

// Final safety: intercept dbPush of messages happening client-side via monkey-patch to add moderation flags if needed
// (we avoid breaking existing functionality)
(function wrapDbPushForMessages(){
  // this is intentionally lightweight: logs pushes to 'messageAudit' for admin review
  const originalPush = dbPush;
  window._originalDbPush = originalPush;
  window.dbPushWithAudit = async function(ref, data) {
    try {
      // if pushing to messages, add audit log
      if (String(ref && ref._path && ref._path.pieces && ref._path.pieces.includes && ref._path.pieces.includes('messages') || (typeof ref === 'string' && ref.includes('messages')))) {
        // push as usual
        const res = await originalPush(ref, data);
        // log summary
        try { await dbPush(dbRef(db4, 'messageAudit'), { uid: data.uid||null, ts: Date.now(), snippet: (data.text||'').substring(0,120) }); } catch(e){ console.warn('audit log fail', e); }
        return res;
      }
      return await originalPush(ref, data);
    } catch(e){ throw e; }
  };
})();

// NOTE for deployer: If you later want server-side heavy moderation, move logic to cloud function.

</script>
