<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ü–†–ê–ì–ê –§–£–®–ö–ò ‚Äî –ß–∞—Ç</title>

  <!-- Fonts: Inter + Gothic (–¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=UnifrakturCook:wght@700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">

  <!--
    –í–ù–ò–ú–ê–ù–ò–ï ‚Äî –®–∞–±–ª–æ–Ω –ø–∏—Å—å–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–≤—Å—Ç–∞–≤—å—Ç–µ –≤ Firebase Console -> Authentication -> Templates):
    (–ù–∞ —É–∫—Ä. —è–∑—ã–∫–µ, —Å —Ç–µ–∫—Å—Ç–æ–º –æ 6-—á–∞—Å–æ–≤–æ–º –¥–æ—Å—Ç—É–ø–µ –±–µ–∑ –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó)

    Subject: –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ—ó –ø–æ—à—Ç–∏ ‚Äî –ü–†–ê–ì–ê –§–£–®–ö–ò

    HTML message:
    <p>–ü—Ä–∏–≤—ñ—Ç, %DISPLAY_NAME%!</p>
    <p>–î–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∞—à–æ—ó –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ—ó –ø–æ—à—Ç–∏ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∏–∂—á–µ:</p>
    <p><a href="%LINK%">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∞–¥—Ä–µ—Å—É –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ—ó –ø–æ—à—Ç–∏</a></p>
    <p>–Ø–∫—â–æ –≤–∏ –Ω–µ —Ä–µ—î—Å—Ç—Ä—É–≤–∞–ª–∏—Å—è ‚Äî –ø—Ä–æ—Å—Ç–æ —ñ–≥–Ω–æ—Ä—É–π—Ç–µ —Ü–µ–π –ª–∏—Å—Ç.</p>
    <p>–£–≤–∞–≥–∞: –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email —É –≤–∞—Å –≤—Å–µ –æ–¥–Ω–æ —î <strong>6 –≥–æ–¥–∏–Ω</strong> –¥–æ—Å—Ç—É–ø—É –¥–æ —á–∞—Ç—É –ø—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó.</p>
    <p>–ó –ø–æ–≤–∞–≥–æ—é,<br>–ö–æ–º–∞–Ω–¥–∞ –ü–†–ê–ì–ê –§–£–®–ö–ò</p>

    –ü—Ä–∏–º—ñ—Ç–∫–∞: —à–∞–±–ª–æ–Ω –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª—å Firebase (Authentication -> Templates),
    —ñ –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ Email/Password –ø—Ä–æ–≤–∞–π–¥–µ—Ä –≤–∫–ª—é—á–µ–Ω–∏–π, –∞ –¥–æ–º–µ–Ω –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∏–π (–¥–∏–≤. DNS –∑–∞–ø–∏—Å–∏).
  -->

  <style>
    :root{
      --accent: #2ecc71;
      --accent-strong: #20b561;
      --glass: rgba(255,255,255,0.94);
      --muted: #64748b;
      --max-width: 980px;
      --avatar-size: 44px;
      --tab-bg: rgba(0,0,0,0.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif;-webkit-font-smoothing:antialiased;overflow-x:hidden}

    /* –§–æ–Ω –ü—Ä–∞–≥–∏ ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞—î–º–æ (—á–∏—Å—Ç–∞—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—è) */
    body {
      background-image: url('https://i.ibb.co/27hgtZfY/Prague.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: #fff;
    }

    /* Header ‚Äî —á—É—Ç—å –∑–∞—Ç–µ–º–Ω—ë–Ω–Ω—ã–π —Ñ–æ–Ω –¥–ª—è —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ (–Ω–µ –∑–∞—Ç–µ–º–Ω—è—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –≥–ª–æ–±–∞–ª—å–Ω–æ) */
    header{
      position:sticky;
      top:0;
      z-index:80;
      padding:14px 12px;
      text-align:center;
      background: linear-gradient(180deg, rgba(3,7,12,0.45), rgba(3,7,12,0.18));
      backdrop-filter: blur(4px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }
    header h1{
      margin:0;
      font-family: 'UnifrakturCook', Poppins, Inter, sans-serif;
      font-weight:700;
      font-size:30px;
      letter-spacing:1px;
      text-shadow:0 6px 18px rgba(0,0,0,0.6);
      color: #fff;
    }
    header p{margin:8px 0 0;font-size:14px;color:#eaf6ed; font-weight:600}

    /* Tabs bar (–ø—ñ–¥–Ω—è—Ç–∏ —Ç—Ä–æ—Ö–∏ –≤–∏—â–µ —Ç–∞ –∑—Ä–æ–±–∏—Ç–∏ –≤–∏–¥–Ω–∏–º–∏) */
    .tabs-wrap {
      display:flex;
      justify-content:center;
      margin-top:8px;
      z-index:79;
      position:sticky;
      top:76px;
      pointer-events:auto;
    }
    nav.tabs{
      display:flex;
      gap:12px;
      padding:10px;
      border-radius:12px;
      background: var(--tab-bg);
      box-shadow: 0 8px 30px rgba(0,0,0,0.45);
      align-items:center;
    }
    .tab-button{
      background: transparent;
      border: none;
      color: #fff;
      padding:10px 18px;
      font-weight:800;
      font-size:15px;
      border-radius:10px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25) inset;
      letter-spacing:0.6px;
    }
    .tab-button:not(.active){
      background: rgba(255,255,255,0.02);
    }
    .tab-button.active{
      background: var(--accent);
      color: #04210b;
      box-shadow: 0 8px 28px rgba(32,181,97,0.22);
      transform: translateY(-2px);
    }

    main.container{max-width:var(--max-width);margin:12px auto;padding:8px}
    .sys-msg{
      max-width:var(--max-width);
      margin:6px auto 14px;
      padding:10px 12px;
      border-radius:12px;
      background: rgba(255,255,255,0.06);
      color:#fff;
      font-size:15px;
      text-align:center;
      font-weight:600;
    }

    .tab-content{display:none}
    .tab-content.active{display:block}

    /* Chat */
    .chat-area{
      height:calc(100vh - 360px);
      overflow:auto;
      padding:12px 10px;
      background: transparent;
    }
    .messages{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding-bottom:160px;
    }
    .message{
      display:flex;
      gap:10px;
      align-items:flex-start;
      max-width:78%;
      word-break:break-word;
    }
    .message.self{margin-left:auto;flex-direction:row-reverse}
    .avatar{
      width:var(--avatar-size);
      height:var(--avatar-size);
      border-radius:50%;
      object-fit:cover;
      flex:0 0 var(--avatar-size);
      box-shadow:0 6px 20px rgba(0,0,0,0.45);
      cursor:pointer;
    }
    .message-content{
      background: var(--glass);
      padding:12px 14px;
      border-radius:14px;
      box-shadow:0 10px 40px rgba(2,6,23,0.18);
      color:#0b1220;
      max-width: 100%;
    }
    .message.self .message-content{background:#E9FFF0}
    .message-meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .chat-image{max-width:320px;border-radius:10px;margin-top:8px;display:block;box-shadow:0 6px 18px rgba(0,0,0,0.25)}

    /* Gothic bold font for chat text */
    .message-content .text {
      font-family: 'UnifrakturCook', cursive;
      font-weight:700;
      font-size:1.02rem;
      color:#0b1220;
      line-height:1.05;
    }

    /* Input bar */
    .chat-input{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.99));
      border-top:1px solid rgba(0,0,0,0.06);
      z-index:90;
      display:flex;
      gap:10px;
      align-items:center;
      max-width:var(--max-width);
      margin:0 auto;
    }
    .camera-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      width:48px;height:48px;border-radius:50%;
      background:#fff;border:1px solid #e6e6e6;
      box-shadow:0 8px 20px rgba(0,0,0,0.08);
    }
    .chat-input input[type="text"]{
      flex:1;padding:12px 14px;border-radius:24px;border:1px solid #d0d7de;font-size:16px;outline:none;
      font-family:Inter, Arial, sans-serif;
    }
    .send-btn{
      background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:20px;font-weight:800;cursor:pointer;
      box-shadow:0 10px 28px rgba(46,204,113,0.18);
    }
    .small-btn{padding:8px 10px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:100}
    .modal.show{display:flex}
    .modal-panel{background:#fff;border-radius:12px;padding:18px;width:92%;max-width:520px;position:relative;box-shadow:0 18px 80px rgba(2,6,23,0.4)}
    .modal-close{position:absolute;right:10px;top:8px;background:transparent;border:none;font-size:16px;cursor:pointer}
    .auth-form input{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #dcdcdc}
    .auth-actions{display:flex;gap:8px;justify-content:space-between}
    .auth-actions button{flex:1;padding:10px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer}
    .error-line{color:#b91c1c;font-size:13px;margin-top:6px}

    .profile-btn{position:fixed;right:12px;top:12px;z-index:101;width:48px;height:48px;border-radius:50%;border:2px solid #fff;background-size:cover;background-position:center;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,0.4)}

    /* Map */
    #map{width:100%;height:60vh;border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.45)}

    @media (max-width:640px){
      .chat-area{height:calc(100vh - 420px)}
      .chat-image{max-width:200px}
      header h1{font-size:24px}
      .tab-button{padding:8px 12px;font-size:14px}
    }

  </style>
</head>
<body>
  <header>
    <h1>–ü–†–ê–ì–ê –§–£–®–ö–ò</h1>
    <p>–í—ñ—Ç–∞—î–º–æ! –î–æ—Ä–æ–≥—ñ —É–∫—Ä–∞—ó–Ω—Ü—ñ ‚Äî —Ü–µ–π —á–∞—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ, —â–æ–± –¥–æ–ø–æ–º–∞–≥–∞—Ç–∏ –Ω–∞—à–∏–º —Å–ø—ñ–≤–≤—ñ—Ç—á–∏–∑–Ω–∏–∫–∞–º.</p>
  </header>

  <div class="tabs-wrap">
    <nav class="tabs" role="tablist" aria-label="–í–∫–ª–∞–¥–∫–∏">
      <button class="tab-button active" data-target="chatTab" aria-pressed="true">üí¨ –ß–∞—Ç</button>
      <button class="tab-button" data-target="mapTab" aria-pressed="false">üó∫ –ö–∞—Ä—Ç–∞</button>
      <button class="tab-button" data-target="helpTab" aria-pressed="false">‚ùì –î–æ–ø–æ–º–æ–≥–∞</button>
    </nav>
  </div>

  <main class="container" role="main">
    <div class="sys-msg" id="welcomeMsg">–Ø–∫—â–æ –≤–∏ –≤–ø–µ—Ä—à–µ ‚Äî –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏" ‚Äî –∑'—è–≤–∏—Ç—å—Å—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è. 6 –≥–æ–¥–∏–Ω –¥–æ—Å—Ç—É–ø—É –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email.</div>

    <!-- Chat tab -->
    <section id="chatTab" class="tab-content active" role="region" aria-label="–ß–∞—Ç">
      <div class="chat-area" id="chatArea" aria-live="polite">
        <div id="messages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- Map tab -->
    <section id="mapTab" class="tab-content" role="region" aria-label="–ö–∞—Ä—Ç–∞" style="display:none;">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <div style="flex:1">
          <input id="mapSearch" placeholder="–ü–æ—à—É–∫ (–≤–æ–ª–æ–Ω—Ç–µ—Ä–∏ / –∞–ø—Ç–µ–∫–∞ / –∫–ª—ñ–Ω—ñ–∫–∞)..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd">
        </div>
        <div>
          <button id="centerBtn" class="small-btn">–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏</button>
        </div>
      </div>
      <div id="map"></div>
    </section>

    <!-- Help tab -->
    <section id="helpTab" class="tab-content" role="region" aria-label="–î–æ–ø–æ–º–æ–≥–∞" style="display:none;">
      <h2 style="color:#fff; margin-top:0; margin-bottom:10px;">–¢–µ—Ä–º—ñ–Ω–æ–≤–∞ –¥–æ–ø–æ–º–æ–≥–∞ —É –ü—Ä–∞–∑—ñ</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;padding:12px">
        <div style="background:white;padding:10px;border-radius:10px">
          <img src="https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp" style="width:100%;height:130px;object-fit:cover;border-radius:8px">
          <h3>Nemocnice Motol</h3><p>–ê–¥—Ä–µ—Å–∞: V Uvalu 84</p>
        </div>
        <div style="background:white;padding:10px;border-radius:10px">
          <img src="https://i.ibb.co/0gWD5wW/images-5.jpg" style="width:100%;height:130px;object-fit:cover;border-radius:8px">
          <h3>–Æ—Ä–∏–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞</h3><p>–î–æ–∫—É–º–µ–Ω—Ç–∏ —Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó</p>
        </div>
        <div style="background:white;padding:10px;border-radius:10px">
          <img src="https://i.ibb.co/R49shL6k/images-6.jpg" style="width:100%;height:130px;object-fit:cover;border-radius:8px">
          <h3>–ú–∞–≥–∞–∑–∏–Ω–∏</h3><p>–ü—Ä–æ–¥—É–∫—Ç–∏ —Ç–∞ –ø–æ–±—É—Ç</p>
        </div>
      </div>
    </section>
  </main>

  <button id="profileBtn" class="profile-btn" title="–ü—Ä–æ—Ñ—ñ–ª—å" aria-label="–ü—Ä–æ—Ñ—ñ–ª—å"></button>

  <!-- hidden file for camera/photo -->
  <input id="fileInput" type="file" accept="image/*" style="display:none">

  <!-- input area -->
  <div class="chat-input" role="region" aria-label="–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">
    <label for="fileInput" class="camera-btn" title="–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ" id="cameraLabel" aria-hidden="true">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M4 7H6L7 5H17L18 7H20C21.1 7 22 7.9 22 9V19C22 20.1 21.1 21 20 21H4C2.9 21 2 20.1 2 19V9C2 7.9 2.9 7 4 7Z" fill="#111"/>
        <circle cx="12" cy="13" r="3.5" fill="#fff"/>
      </svg>
    </label>

    <input id="messageInput" type="text" inputmode="text" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." aria-label="–¢–µ–∫—Å—Ç" />
    <button id="sendButton" class="send-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
  </div>

  <!-- auth modal -->
  <div id="authModal" class="modal" aria-hidden="true">
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <button class="modal-close" id="modalClose">‚úï</button>
      <h2 id="authTitle">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è / –í—Ö—ñ–¥</h2>

      <form id="registerForm" class="auth-form" onsubmit="return false;">
        <input id="nickInput" type="text" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" required />
        <input id="emailInput" type="email" placeholder="Email" required />
        <input id="passwordInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω—ñ–º—É–º 6)" required />
        <div class="auth-actions">
          <button id="registerSubmit" type="button">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
          <button id="loginShow" type="button" style="background:#4b5563">–£–≤—ñ–π—Ç–∏</button>
        </div>
        <div id="regError" class="error-line"></div>
      </form>

      <form id="loginForm" class="auth-form" style="display:none" onsubmit="return false;">
        <input id="loginEmail" type="email" placeholder="Email" required />
        <input id="loginPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" required />
        <div class="auth-actions">
          <button id="loginSubmit" type="button">–£–≤—ñ–π—Ç–∏</button>
          <button id="backToRegister" type="button" style="background:#4b5563">–ù–∞–∑–∞–¥</button>
        </div>
        <div id="loginError" class="error-line"></div>
      </form>
    </div>
  </div>

  <!-- Firebase + app script (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, sendEmailVerification, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref as dbRef, push as dbPush, onChildAdded, query, orderByChild, limitToLast, get as dbGet, set as dbSet } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // ---------- Firebase config (–≤–∞—à –ø—Ä–æ–µ–∫—Ç) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
      authDomain: "praga-4baee.firebaseapp.com",
      databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
      projectId: "praga-4baee",
      storageBucket: "praga-4baee.firebasestorage.app",
      messagingSenderId: "336023952536",
      appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
      measurementId: "G-BGDJD6R12N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // DOM refs
    const tabButtons = document.querySelectorAll(".tab-button");
    const tabContents = document.querySelectorAll(".tab-content");
    const messagesEl = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    const fileInput = document.getElementById("fileInput");
    const cameraLabel = document.getElementById("cameraLabel");
    const authModal = document.getElementById("authModal");
    const registerForm = document.getElementById("registerForm");
    const loginForm = document.getElementById("loginForm");
    const nickInput = document.getElementById("nickInput");
    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");
    const registerSubmit = document.getElementById("registerSubmit");
    const loginShow = document.getElementById("loginShow");
    const loginSubmit = document.getElementById("loginSubmit");
    const backToRegister = document.getElementById("backToRegister");
    const loginEmail = document.getElementById("loginEmail");
    const loginPassword = document.getElementById("loginPassword");
    const modalClose = document.getElementById("modalClose");
    const regError = document.getElementById("regError");
    const loginError = document.getElementById("loginError");
    const profileBtn = document.getElementById("profileBtn");
    const mapSearch = document.getElementById("mapSearch");
    const centerBtn = document.getElementById("centerBtn");
    const welcomeMsg = document.getElementById("welcomeMsg");

    // state
    const DEFAULT_AVATAR = "https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg";
    let currentUser = null;
    const MSG_LIMIT = 200;

    /* ------------------ Tabs ------------------ */
    function setActiveTab(id) {
      tabButtons.forEach(b => {
        const active = b.dataset.target === id;
        b.classList.toggle("active", active);
        b.setAttribute("aria-pressed", active ? "true" : "false");
      });
      tabContents.forEach(c => c.style.display = (c.id === id) ? "block" : "none");
      if (id === "chatTab") {
        messageInput.focus();
      }
      // if switching to map, trigger resize so map –Ω–µ –∑–ª—ñ—Ç–∞—î
      if (id === "mapTab" && typeof google !== "undefined" && window.map) {
        setTimeout(()=> {
          google.maps.event.trigger(window.map, "resize");
          window.map.setCenter({ lat:50.0755, lng:14.4378 });
        }, 150);
      }
    }
    tabButtons.forEach(btn => btn.addEventListener("click", ()=> setActiveTab(btn.dataset.target)));

    // hotkeys
    document.addEventListener("keydown", (e)=> {
      if (e.key.toLowerCase() === 'c') setActiveTab("chatTab");
      if (e.key.toLowerCase() === 'm') setActiveTab("mapTab");
      if (e.key.toLowerCase() === 'h') setActiveTab("helpTab");
    });

    /* ------------------ Modal / Auth UI ------------------ */
    function showAuthModal(){ authModal.classList.add("show"); authModal.setAttribute("aria-hidden","false"); regError.textContent=""; loginError.textContent=""; }
    function hideAuthModal(){ authModal.classList.remove("show"); authModal.setAttribute("aria-hidden","true"); }
    modalClose?.addEventListener("click", hideAuthModal);
    loginShow?.addEventListener("click", ()=>{ registerForm.style.display="none"; loginForm.style.display="block"; });
    backToRegister?.addEventListener("click", ()=>{ registerForm.style.display="block"; loginForm.style.display="none"; });

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
registerSubmit?.addEventListener("click", async () => {
  regError.textContent = "";
  const nick = nickInput.value.trim();
  const email = emailInput.value.trim();
  const pass = passwordInput.value.trim();
  if (!nick || !email || !pass) {
    regError.textContent = "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è";
    return;
  }
  if (pass.length < 6) {
    regError.textContent = "–ü–∞—Ä–æ–ª—å –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤";
    return;
  }
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    await updateProfile(cred.user, { displayName: nick, photoURL: DEFAULT_AVATAR });
    await dbSet(dbRef(db, `users/${cred.user.uid}`), { nick, email, avatar: DEFAULT_AVATAR, createdAt: Date.now() });
    localStorage.setItem("regTime_" + cred.user.uid, String(Date.now()));
    await sendEmailVerification(cred.user);
    hideAuthModal();
    alert("–í–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ. –õ–∏—Å—Ç –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ. –£ –≤–∞—Å 6 –≥–æ–¥–∏–Ω –¥–æ—Å—Ç—É–ø—É –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è.");
  } catch (err) {
    console.error("register err", err);
    regError.textContent = err?.message || String(err);
  }
});

// –í—Ö–æ–¥
loginSubmit?.addEventListener("click", async () => {
  loginError.textContent = "";
  const email = loginEmail.value.trim();
  const pass = loginPassword.value.trim();
  if (!email || !pass) {
    loginError.textContent = "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å email —ñ –ø–∞—Ä–æ–ª—å";
    return;
  }
  try {
    const cred = await signInWithEmailAndPassword(auth, email, pass);
    const user = cred.user;
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    if (!user.emailVerified) {
      const regTimeStr = localStorage.getItem("regTime_" + user.uid);
      if (!regTimeStr || Date.now() - Number(regTimeStr) > 6 * 60 * 60 * 1000) {
        alert("–¢–µ—Ä–º—ñ–Ω –¥—ñ—ó —Ç–∏–º—á–∞—Å–æ–≤–æ–≥–æ –¥–æ—Å—Ç—É–ø—É –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è. –ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å email, —â–æ–± —É–≤—ñ–π—Ç–∏.");
        await signOut(auth);
        return;
      }
    }
    hideAuthModal();
  } catch (err) {
    console.error("login err", err);
    loginError.textContent = err?.message || String(err);
  }
});

    /* canSendMessage: emailVerified OR within 6 hours since createdAt */
    async function canSendMessage(){
      const user = auth.currentUser;
      if (!user) return false;
      if (user.emailVerified) return true;
      const localKey = "regTime_" + user.uid;
      const localVal = localStorage.getItem(localKey);
      const sixHours = 6 * 60 * 60 * 1000;
      if (localVal && (Date.now() - Number(localVal) < sixHours)) return true;
      try {
        const snap = await dbGet(dbRef(db, `users/${user.uid}/createdAt`));
        if (snap && snap.exists()) {
          const created = Number(snap.val());
          if (!Number.isNaN(created) && Date.now() - created < sixHours) {
            localStorage.setItem(localKey, String(created));
            return true;
          }
        }
      } catch (e) { console.error("canSendMessage db get error", e); }
      return false;
    }

    /* ------------------ Chat rendering & messages ------------------ */
    function timeStr(ts){ return new Date(ts).toLocaleString(); }
    function renderMessage(m){
      if (!m || !m.ts) return;
      const wrap = document.createElement("div");
      wrap.className = "message" + ((currentUser && m.uid === currentUser.uid) ? " self" : "");
      const avatar = document.createElement("img");
      avatar.className = "avatar";
      avatar.src = m.avatar || DEFAULT_AVATAR;
      avatar.alt = m.nick || "avatar";
      avatar.title = m.nick || "–û—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è";
      avatar.addEventListener("click", ()=> {
        if (!currentUser) { showAuthModal(); return; }
        if (m.uid === currentUser.uid) alert("–¶–µ –≤–∏"); else alert("–û—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (—Ñ—É–Ω–∫—Ü—ñ—è –ø–æ–∫–∏ –ø—Ä–æ—Å—Ç–∞).");
      });

      const txt = document.createElement("div");
      txt.className = "message-content";
      const meta = document.createElement("div");
      meta.className = "message-meta";
      meta.textContent = `${m.nick || "–ê–Ω–æ–Ω—ñ–º"} ¬∑ ${timeStr(m.ts)}` + (m.recipientUid ? " ¬∑ –æ—Å–æ–±–∏—Å—Ç–µ" : "");
      txt.appendChild(meta);

      if (m.text) {
        const p = document.createElement("div");
        p.className = "text";
        p.innerText = m.text;
        txt.appendChild(p);
      }
      if (m.image) {
        const im = document.createElement("img");
        im.src = m.image;
        im.alt = "–§–æ—Ç–æ";
        im.className = "chat-image";
        txt.appendChild(im);
      }

      wrap.appendChild(avatar);
      wrap.appendChild(txt);
      messagesEl.appendChild(wrap);

      // autoscroll if near bottom
      const chatAreaEl = document.querySelector('.chat-area');
      const nearBottom = chatAreaEl.scrollHeight - chatAreaEl.scrollTop - chatAreaEl.clientHeight < 200;
      if (nearBottom) chatAreaEl.scrollTop = chatAreaEl.scrollHeight;
    }

    // subscribe last messages and new ones
    const messagesQuery = query(dbRef(db, "messages"), orderByChild("ts"), limitToLast(MSG_LIMIT));
    onChildAdded(messagesQuery, (snap) => {
      const m = snap.val();
      renderMessage(m);
    }, (err) => {
      console.error("onChildAdded error", err);
    });

    /* ------------------ Image handling (resize -> dataURL) ------------------ */
    function resizeImageFile(file, maxWidth = 900, quality = 0.8) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        reader.onload = (e) => {
          img.onload = () => {
            const scale = Math.min(1, maxWidth / img.width);
            const w = Math.round(img.width * scale);
            const h = Math.round(img.height * scale);
            const canvas = document.createElement('canvas');
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            resolve(dataUrl);
          };
          img.onerror = (err) => reject(err);
          img.src = e.target.result;
        };
        reader.onerror = (err) => reject(err);
        reader.readAsDataURL(file);
      });
    }

    /* ------------------ Send message (text + optional image) ------------------ */
    sendButton.addEventListener("click", async ()=>{
      if (!auth.currentUser) { showAuthModal(); return; }
      if (!await canSendMessage()) { alert("–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å email –∞–±–æ —Å–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—å 6-–≥–æ–¥–∏–Ω–Ω–∏–º –¥–æ—Å—Ç—É–ø–æ–º –ø—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó."); return; }

      const text = messageInput.value.trim();
      const file = fileInput.files[0];
      if (!text && !file) return;

      let imageData = null;
      if (file) {
        try {
          imageData = await resizeImageFile(file, 900, 0.8);
        } catch (e) {
          console.error("resize error", e);
          alert("–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Ñ–æ—Ç–æ");
          return;
        }
      }

      const msg = {
        uid: auth.currentUser.uid,
        nick: auth.currentUser.displayName || auth.currentUser.email || "–ê–Ω–æ–Ω—ñ–º",
        avatar: auth.currentUser.photoURL || DEFAULT_AVATAR,
        text: text || null,
        image: imageData || null,
        ts: Date.now(),
        recipientUid: null
      };

      try {
        await dbPush(dbRef(db, "messages"), msg);
        messageInput.value = "";
        fileInput.value = "";
      } catch (err) {
        console.error("dbPush error", err);
        alert("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è");
      }
    });

    // enter to send
    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendButton.click(); }
    });

    // camera label behaviour: if not logged -> show modal
    cameraLabel.addEventListener("click", (e) => {
      if (!auth.currentUser) { e.preventDefault(); showAuthModal(); return; }
      // otherwise native file chooser opens (label -> input)
    });

    // profile button: sign out / show modal
    profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`;
    profileBtn.addEventListener("click", () => {
      if (!auth.currentUser) { showAuthModal(); return; }
      if (confirm("–í–∏ —Ö–æ—á–µ—Ç–µ –≤–∏–π—Ç–∏? OK ‚Äî –≤–∏–π—Ç–∏; Cancel ‚Äî –∑–∞–ª–∏—à–∏—Ç–∏—Å—è.")) {
        signOut(auth).then(() => {
          profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`;
          alert("–í–∏ –≤–∏–π—à–ª–∏");
        });
      }
    });

    // Preload background to avoid white flash
    (function preloadBg(){
      const img = new Image();
      img.src = 'https://i.ibb.co/27hgtZfY/Prague.jpg';
      img.onload = ()=> console.log("background loaded");
      img.onerror = ()=> console.warn("background failed to load");
    })();

    /***********************
     *  Google Maps part
     ***********************/
    // Use the small images you provided for certain markers
    const IMG_HOSPITAL = "https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp";
    const IMG_LAWYER = "https://i.ibb.co/0gWD5wW/images-5.jpg";
    const IMG_SHOP = "https://i.ibb.co/R49shL6k/images-6.jpg";

    const POINTS = [
      { title: "Nemocnice Motol", pos: {lat:50.058, lng:14.360}, cat:"hospital", img: IMG_HOSPITAL },
      { title: "Nemocnice Na Frantisku", pos: {lat:50.086, lng:14.418}, cat:"hospital", img: IMG_HOSPITAL },
      { title: "Klinika Praha", pos: {lat:50.078, lng:14.422}, cat:"hospital", img: IMG_HOSPITAL },

      { title: "Pravni pomoc —Ü–µ–Ω—Ç—Ä A", pos: {lat:50.083, lng:14.412}, cat:"lawyer", img: IMG_LAWYER },
      { title: "Pravni pomoc —Ü–µ–Ω—Ç—Ä B", pos: {lat:50.089, lng:14.430}, cat:"lawyer", img: IMG_LAWYER },
      { title: "Advokatni kancelar C", pos: {lat:50.071, lng:14.425}, cat:"lawyer", img: IMG_LAWYER },

      { title: "Albert Supermarket", pos: {lat:50.084, lng:14.417}, cat:"shop", img: IMG_SHOP },
      { title: "Billa City", pos: {lat:50.076, lng:14.437}, cat:"shop", img: IMG_SHOP },
      { title: "Kaufland Praha", pos: {lat:50.085, lng:14.414}, cat:"shop", img: IMG_SHOP },

      { title: "Pomoc Centrum 1", pos: {lat:50.082, lng:14.419}, cat:"help", img: null },
      { title: "Pomoc Centrum 2", pos: {lat:50.088, lng:14.427}, cat:"help", img: null },
      { title: "Shelter Point", pos: {lat:50.074, lng:14.432}, cat:"help", img: null }
    ];

    let map;
    let markers = [];

    // global initMap for Google callback
    window.initMap = function() {
      const center = { lat: 50.0755, lng: 14.4378 };
      map = new google.maps.Map(document.getElementById("map"), {
        center,
        zoom: 13,
        gestureHandling: "greedy",
      });
      window.map = map;
      renderMarkers("all");

      centerBtn?.addEventListener("click", ()=> map.panTo(center) );
      mapSearch?.addEventListener("input", (e)=> {
        const q = e.target.value.trim().toLowerCase();
        markers.forEach(mk => {
          const show = !q || (mk.title && mk.title.toLowerCase().includes(q));
          mk.setVisible(show);
        });
      });
    };

    function createIconFor(cat){
      const color = (cat === "hospital") ? "#FF6B6B" : (cat === "lawyer") ? "#4D96FF" : (cat === "shop") ? "#FFD166" : "#8AF598";
      const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="44" height="44"><circle cx="22" cy="22" r="16" fill="${color}" stroke="#fff" stroke-width="3"/></svg>`);
      return { url: `data:image/svg+xml;utf8,${svg}`, scaledSize: new google.maps.Size(44,44) };
    }

    function renderMarkers(filterCat = "all"){
      markers.forEach(m => m.setMap(null));
      markers = [];
      POINTS.forEach(p => {
        if (filterCat === "all" || p.cat === filterCat) {
          const mk = new google.maps.Marker({
            position: p.pos,
            map,
            title: p.title,
            icon: createIconFor(p.cat)
          });
          const content = `<div style="min-width:180px">
                            <strong style="font-size:14px">${p.title}</strong>
                            ${p.img ? `<div style="margin-top:8px"><img src="${p.img}" style="width:180px;height:100px;object-fit:cover;border-radius:6px"></div>` : `<div style="margin-top:6px;color:#555">–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</div>`}
                          </div>`;
          const inf = new google.maps.InfoWindow({ content });
          mk.addListener("click", ()=> inf.open(map, mk));
          mk.title = p.title;
          markers.push(mk);
        }
      });
    }

    // Ensure map resizes when switching tabs (also handled in setActiveTab)
    document.querySelectorAll(".tab-button").forEach(btn => {
      btn.addEventListener("click", () => {
        if (btn.dataset.target === "mapTab" && typeof google !== "undefined" && map) {
          setTimeout(()=> {
            google.maps.event.trigger(map, "resize");
            map.setCenter({ lat:50.0755, lng:14.4378});
          }, 140);
        }
      });
    });

    // End of module
  </script>

  <!-- Google Maps (–∫–ª—é—á, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –¥–∞–ª–∏) -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFrxVhpb6nHJ6rhiLl5Ho8t0jOb1iEQNc&callback=initMap"></script>
</body>
</html>
