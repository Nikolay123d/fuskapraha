<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Makame.cz chat (single-file)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
:root{--line:rgba(255,255,255,.12);--text:#eafff3;--wall:url('https://i.ibb.co/pr18RzG3/charles-bridge-prague.jpg')}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:#0b1611;color:var(--text);background-image:var(--wall);background-size:cover;background-attachment:fixed}
a{color:#7dffc1}
.topbar{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px 14px;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);border-bottom:1px solid var(--line);z-index:20}
.brand{font-weight:900}
.ghost{background:transparent;border:1px solid var(--line);border-radius:10px;color:var(--text);padding:6px 10px}
.citysel select{border:1px solid var(--line);background:rgba(0,0,0,.35);color:var(--text);border-radius:10px;padding:6px 8px}

.tabs{display:flex;gap:8px;padding:8px 12px;background:rgba(0,0,0,.45);border-bottom:1px solid var(--line);position:sticky;top:56px;z-index:19}
.tabs.hidden{display:none}
.tab{border:1px solid var(--line);background:rgba(0,0,0,.35);color:var(--text);border-radius:10px;padding:8px 10px}
.tab.active{border-color:#39ff91}

#views{padding:12px;max-width:1100px;margin:0 auto}
.view{display:none;background:rgba(0,0,0,.25);border:1px solid var(--line);border-radius:14px;padding:10px}
.view.active{display:block}

.feed{display:flex;flex-direction:column;gap:10px;min-height:55vh;padding-bottom:72px}
.msg{display:flex;gap:8px}
.msg .ava{width:36px;height:36px;border-radius:50%;overflow:hidden;border:1px solid var(--line);flex:0 0 36px}
.msg .ava img{width:100%;height:100%;object-fit:cover}
.msg .bubble{background:rgba(0,0,0,.55);border:1px solid var(--line);border-radius:16px;padding:8px 12px;max-width:78%}
.msg .name{font-weight:700;font-size:12px;opacity:.9;margin-bottom:4px}
.msg .text img{max-width:220px;border-radius:10px;border:1px solid var(--line);display:block;margin-top:6px}
.msg .actions{display:flex;gap:6px;margin-top:6px}
.msg .actions button{border:1px solid var(--line);background:rgba(0,0,0,.3);color:var(--text);border-radius:10px;padding:4px 8px;font-size:12px}

.composer.sticky{position:sticky;bottom:8px;display:flex;gap:8px;align-items:center;background:rgba(0,0,0,.72);padding:8px;border:1px solid var(--line);border-radius:12px}
.composer input{flex:1;min-width:160px;padding:10px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.35);color:var(--text)}
.composer button,.filebtn{border:1px solid rgba(58,255,145,.8);background:rgba(0,0,0,.25);color:var(--text);border-radius:12px;padding:10px 12px}
.filebtn input{display:none}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:30}
.modal[hidden]{display:none !important}
.card{width:min(92vw,820px);background:#0f1b16;border:1px solid var(--line);border-radius:14px;padding:12px}
.card header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.row{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
.ava-lg{width:64px;height:64px;border-radius:50%;border:1px solid var(--line);object-fit:cover}
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
.map{height:420px;border-radius:12px;overflow:hidden}
.dm{display:grid;grid-template-columns:300px 1fr;gap:12px}
#dmMessages{display:flex;flex-direction:column;gap:8px;max-height:55vh;overflow:auto}
.adm-only{border:1px dashed var(--line);padding:8px;border-radius:10px;margin-top:10px}
.muted{opacity:.7;font-size:12px}

.toast{
  position:sticky; bottom:88px;
  background:rgba(0,0,0,.9);
  border:1px solid var(--line);
  padding:8px 10px; border-radius:10px; width:max-content; max-width:90%;
  margin:6px 8px; z-index:22
}
#globalToast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px }
</style>
</head>
<body>
  <header class="topbar">
    <div class="left">
      <button id="toggleTabs" class="ghost">‚ò∞ –ú–µ–Ω—é</button>
      <div class="brand">Makame.cz chat</div>
      <label class="citysel">
        <span>Mƒõsto:</span>
        <select id="citySelect">
          <option value="praha">Praha</option>
          <option value="brno">Brno</option>
          <option value="ostrava">Ostrava</option>
          <option value="plzen">Plze≈à</option>
          <option value="olomouc">Olomouc</option>
        </select>
      </label>
    </div>
    <div class="mid"><span id="onlineCounter">Online (cca): 0</span></div>
    <div class="right">
      <button id="participantsBtn" title="√öƒçastn√≠ci">üë•</button>
      <button id="profileBtn" title="Profil">Profil</button>
    </div>
  </header>

  <nav class="tabs" id="tabs">
    <button data-tab="chat" class="tab active">üí¨ Chat</button>
    <button data-tab="rent" class="tab">üè† Pron√°jem</button>
    <button data-tab="map" class="tab">üó∫Ô∏è Mapa</button>
    <button data-tab="dm" class="tab">‚úâÔ∏è Osobn√≠</button>
    <button data-tab="help" class="tab">üÜò N√°povƒõda</button>
    <button data-tab="announce" class="tab">üì¢ Ozn√°men√≠</button>
    <button data-tab="admin" class="tab adm-only">üõ† Admin</button>
  </nav>

  <main id="views">
    <!-- CHAT -->
    <section id="view-chat" class="view active">
      <div id="chatFeed" class="feed"></div>
      <div id="chatToast" class="toast" hidden>‚úîÔ∏è Foto –¥–æ–¥–∞–Ω–æ. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´Odeslat¬ª.</div>
      <div class="composer sticky">
        <label class="filebtn" title="Foto"><input type="file" id="chatFile" accept="image/*">üì∑</label>
        <input id="chatInput" placeholder="Napi≈°te zpr√°vu‚Ä¶ (m≈Ø≈æe b√Ωt URL na foto)">
        <button id="chatSend">Odeslat</button>
        <button id="clearChat" class="adm-only">üßπ Vyƒçistit</button>
      </div>
    </section>

    <!-- RENT -->
    <section id="view-rent" class="view">
      <div id="rentFeed" class="feed"></div>
      <div class="composer sticky">
        <label class="filebtn"><input type="file" id="rentFile" accept="image/*">üì∑</label>
        <input id="rentInput" placeholder="Inzer√°t‚Ä¶">
        <button id="rentSend">Odeslat</button>
      </div>
    </section>

    <!-- MAP -->
    <section id="view-map" class="view">
      <div class="row">
        <button id="mapCenter">Centrovat</button>
        <label class="filebtn adm-only" title="Pozad√≠ mƒõsta (foto)"><input type="file" id="cityBgFile" accept="image/*">üì∑</label>
        <input id="cityBgUrl" class="adm-only" placeholder="URL pozad√≠ pro mƒõsto">
        <button id="saveCityBg" class="adm-only">Ulo≈æit pozad√≠</button>
      </div>
      <div id="map" class="map"></div>
      <div class="adm-only row">
        <input id="poiTitle" placeholder="N√°zev">
        <input id="poiType" placeholder="Typ (vol/help/pharm)">
        <input id="poiAvatar" placeholder="URL avataru (vol.)">
        <input id="poiPhoto" placeholder="URL fotky (vol.)">
        <input id="poiLat" placeholder="lat (–æ–ø—Ü.)">
        <input id="poiLng" placeholder="lng (–æ–ø—Ü.)">
        <button id="poiAdd">–î–æ–¥–∞—Ç–∏ —Ç–æ—á–∫—É</button>
      </div>
    </section>

    <!-- DMs -->
    <section id="view-dm" class="view">
      <div class="dm">
        <aside id="dmSidebar"></aside>
        <div class="dmThread">
          <div id="dmHeader"></div>
          <div id="dmMessages"></div>
          <div id="dmToast" class="toast" hidden>‚úîÔ∏è Foto –¥–æ–¥–∞–Ω–æ –¥–æ –õ–°. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´Odeslat¬ª.</div>
          <div class="composer sticky">
            <label class="filebtn"><input type="file" id="dmFile" accept="image/*">üì∑</label>
            <input id="dmInput" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è‚Ä¶">
            <button id="dmSend">Odeslat</button>
          </div>
        </div>
      </div>
    </section>

    <!-- HELP -->
    <section id="view-help" class="view">
      <div class="adm-only row">
        <input id="helpTitle" placeholder="Nadpis">
        <input id="helpLink" placeholder="Odkaz (https://‚Ä¶)">
        <input id="helpImage" placeholder="URL obr√°zku">
        <button id="helpPost">Publikovat</button>
      </div>
      <div id="helpGrid" class="cards"></div>
    </section>

    <!-- Announce -->
    <section id="view-announce" class="view">
      <div class="adm-only row">
        <input id="anTitle" placeholder="T√©ma">
        <input id="anImage" placeholder="URL fotky (vol.)">
        <textarea id="anText" placeholder="Text"></textarea>
        <button id="anPost">Publikovat</button>
      </div>
      <div id="anGrid" class="cards"></div>
    </section>

    <!-- Admin -->
    <section id="view-admin" class="view">
      <div class="card adm-only">
        <h3>Role / Moderace</h3>
        <div class="row">
          <input id="roleUid" placeholder="UID u≈æivatele">
          <button id="makeMod">+ Moder√°tor</button>
          <button id="removeMod">‚Äì Moder√°tor</button>
          <button id="ban30">‚õî Ban 30 min</button>
          <input id="banReason" placeholder="D≈Øvod">
          <button id="unban">‚úÖ Unban</button>
        </div>
        <h4>St√≠≈ænosti</h4>
        <div id="reportsBox"></div>
      </div>

      <div class="card adm-only">
        <h3>–ë–æ—Ç–∏</h3>
        <div class="row">
          <input id="botCity" placeholder="–ú—ñ—Å—Ç–æ (praha)">
          <input id="botText" placeholder="Text">
          <input id="botImage" placeholder="URL obr√°zku (–æ–ø—Ü.)">
          <select id="botInterval">
            <option value="2">–∫–æ–∂–Ω—ñ 2 —Ö–≤</option>
            <option value="5">–∫–æ–∂–Ω—ñ 5 —Ö–≤</option>
            <option value="15" selected>–∫–æ–∂–Ω—ñ 15 —Ö–≤</option>
          </select>
          <button id="botStart">–°—Ç–∞—Ä—Ç</button>
          <button id="botStop">–°—Ç–æ–ø</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Participants -->
  <div id="participantsModal" class="modal" hidden>
    <div class="card">
      <header><b>√öƒçastn√≠ci</b><button data-close>‚úñ</button></header>
      <div id="participantsList"></div>
    </div>
  </div>

  <!-- Profile -->
  <div id="profileModal" class="modal" hidden>
    <div class="card">
      <header><b>M≈Øj profil</b><button data-close>‚úñ</button></header>
      <div class="row">
        <label class="filebtn"><input type="file" id="avatarFile" accept="image/*">üì∑</label>
        <img id="myAvatar" class="ava-lg" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiB2aWV3Qm94PSIwIDAgMjU2IDI1NiI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwIiB5MT0iMCIgeDI9IjEiIHkyPSIxIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjMWRkMWExIi8+CiAgICAgIDxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzEwYWM4NCIvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9IjI1NiIgaGVpZ2h0PSIyNTYiIHJ4PSIxMjgiIGZpbGw9InVybCgjZykiLz4KICA8Y2lyY2xlIGN4PSIxMjgiIGN5PSIxMDQiIHI9IjQ4IiBmaWxsPSIjZmZmZmZmIi8+CiAgPHBhdGggZD0iTTQwIDIxMmMxMi00MCA1Mi01NiA4OC01NnM3NiAxNiA4OCA1NiIgZmlsbD0iI2ZmZmZmZiIvPgo8L3N2Zz4=" alt="">
        <div>
          <div><b id="myName">–ê–Ω–æ–Ω—ñ–º</b></div>
          <div class="muted">Role: <span id="myRole">seeker</span> ¬∑ Tarif: <span id="myPlan">free</span></div>
        </div>
      </div>
      <div class="row">
        <input id="setNick" placeholder="Nov√Ω nick">
        <input id="setAvatarUrl" placeholder="URL avataru (vol.)">
        <select id="setRole">
          <option value="seeker">Hled√°m pr√°ci</option>
          <option value="employer">Zamƒõstnavatel</option>
        </select>
        <button id="saveProfile">Ulo≈æit</button>
      </div>
      <div class="row">
        <button id="buyPremium">Koupit Premium</button>
        <button id="resetPass">Obnovit heslo</button>
        <button id="btnSignout">Odhl√°sit</button>
      </div>
    </div>
  </div>

  <!-- Global toast -->
  <div id="globalToast" class="toast" hidden></div>

  <!-- libs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- app -->


<script>

/* ==== config.js ==== */
// ==== Firebase config
window.FIREBASE_CONFIG = {
  apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
  authDomain: "praga-4baee.firebaseapp.com",
  databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
  projectId: "praga-4baee",
  storageBucket: "praga-4baee.appspot.com",
  messagingSenderId: "336023952536",
  appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
  measurementId: "G-BGDJD6R12N"
};

// Admin email
window.ADMIN_EMAIL = "urciknikolaj642@gmail.com";

// Use Firebase Storage? If false ‚Äî images are saved as dataURL into DB
window.USE_STORAGE = false;

// Default avatar
window.DEFAULT_AVATAR = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiB2aWV3Qm94PSIwIDAgMjU2IDI1NiI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwIiB5MT0iMCIgeDI9IjEiIHkyPSIxIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjMWRkMWExIi8+CiAgICAgIDxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzEwYWM4NCIvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9IjI1NiIgaGVpZ2h0PSIyNTYiIHJ4PSIxMjgiIGZpbGw9InVybCgjZykiLz4KICA8Y2lyY2xlIGN4PSIxMjgiIGN5PSIxMDQiIHI9IjQ4IiBmaWxsPSIjZmZmZmZmIi8+CiAgPHBhdGggZD0iTTQwIDIxMmMxMi00MCA1Mi01NiA4OC01NnM3NiAxNiA4OCA1NiIgZmlsbD0iI2ZmZmZmZiIvPgo8L3N2Zz4=";


/* ==== locale-cs.js ==== */
window.LCZ={ok:'Hotovo', loginRequired:'P≈ôihlaste se pro pokraƒçov√°n√≠'};


/* ==== utils.js ==== */

window.$=(s,r=document)=>r.querySelector(s); window.$$=(s,r=document)=>Array.from(r.querySelectorAll(s));
window.toast=(t)=>{const d=document.createElement('div'); d.className='toast'; d.textContent=t; document.body.appendChild(d); setTimeout(()=>d.remove(),2200)};
window.SND={chat:new Audio(), dm:new Audio(), ok:new Audio(), err:new Audio()};

function showView(id){ $$('.view').forEach(v=>v.classList.remove('active')); const el=$('#'+id); if(el){ el.classList.add('active'); localStorage.setItem('lastView',id);} }
document.addEventListener('click',e=>{const t=e.target.closest('[data-view]'); if(!t) return; e.preventDefault(); showView(t.dataset.view)});
window.addEventListener('DOMContentLoaded',()=> showView(localStorage.getItem('lastView')||'view-chat'));

// Wallpaper (no flicker)
(function(){ try{const w=localStorage.getItem('wall'); if(w){ document.body.style.background='#0b1416 url('+w+') center/cover fixed no-repeat'; }}catch(e){} })();
document.addEventListener('change',e=>{const t=e.target; if(t && t.id==='wallCamera'){ const f=t.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ localStorage.setItem('wall',r.result);}catch(e){}; document.body.style.background='#0b1416 url('+r.result+') center/cover fixed no-repeat'; toast('Pozad√≠ bylo zmƒõnƒõno'); }; r.readAsDataURL(f); }});

// Greeting for Dasha only after auth
function bindGreeting(){
  const overlay=$('#greetOverlay'); if(!overlay) return;
  firebase.auth().onAuthStateChanged(u=>{
    if(!u){ overlay.hidden=true; return; }
    const em=(u.email||'').toLowerCase();
    overlay.hidden = (em!=='darausoan@gmail.com');
  });
  $('#greetClose')?.addEventListener('click',()=> $('#greetOverlay').hidden=true);
});
bindGreeting();

// City state
function getCity(){ const sel=$('#citySelect'); const saved=localStorage.getItem('city'); if(saved){ if(sel) sel.value=saved; return saved; } return sel? sel.value : 'praha'; }
function setCity(c){ localStorage.setItem('city',c); }
document.addEventListener('change',e=>{ if(e.target && e.target.id==='citySelect'){ setCity(e.target.value); }});
window.getCity=getCity;



/* ==== helpers.js ==== */

const db=firebase.database();
async function fetchUserPublic(uid){
  const up = (await db.ref('usersPublic/'+uid).get()).val();
  if (up) return up;
  const u = (await db.ref('users/'+uid).get()).val();
  if (u) return { nick: u.name || u.nick || 'U≈æivatel', email: u.email, avatar: u.avatar };
  const p = (await db.ref('profiles/'+uid).get()).val();
  if (p) return p;
  return { nick:'U≈æivatel' };
}
window.fetchUserPublic = fetchUserPublic;



/* ==== presence.js ==== */

const db=firebase.database(); const auth=firebase.auth();
function setPresence(u){
  const ref=db.ref('.info/connected');
  ref.on('value', snap=>{
    if(snap.val()===false) return;
    const up=db.ref('presence/'+u.uid);
    up.onDisconnect().set({online:false,ts:firebase.database.ServerValue.TIMESTAMP});
    up.set({online:true,ts:firebase.database.ServerValue.TIMESTAMP});
  });
}
auth.onAuthStateChanged(u=>{ if(u){ setPresence(u); } });



/* ==== map.js ==== */

const db=firebase.database(); const auth=firebase.auth();
let MAP, tiles;
function initMap(){
  MAP = L.map('map').setView([50.0755, 14.4378], 11);
  tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(MAP);

  db.ref('map').on('child_added', snap=>{
    const v=snap.val(); if(!v) return;
    L.marker([v.lat,v.lng]).addTo(MAP).bindPopup(`<b>${v.title||''}</b><br>${v.desc||''}`);
  });

  MAP.on('click', async (e)=>{
    const u=firebase.auth().currentUser; if(!u) return alert('P≈ôihlaste se');
    const title=prompt('N√°zev bodu:'); if(!title) return;
    const id=db.ref('map').push().key;
    await db.ref('map/'+id).set({lat:e.latlng.lat, lng:e.latlng.lng, title, by:u.uid, ts:Date.now()});
  });
}
window.addEventListener('DOMContentLoaded', initMap);



/* ==== friends.js ==== */

const db=firebase.database(); const auth=firebase.auth();

async function friendItem(uid, st){
  const wrap=document.createElement('div'); wrap.className='msg';
  const u=await fetchUserPublic(uid);
  wrap.innerHTML = `<div class="meta"><b>${u.nick||'U≈æivatel'}</b> ¬∑ ${st}</div>` +
                   `<div class="row"><button data-act="chat">Napsat</button>`+
                   (st==='pending' ? `<button data-act="accept">P≈ôijmout</button>` : `<button data-act="remove">Odebrat</button>`) + `</div>`;
  wrap.addEventListener('click', async (e)=>{
    const a=e.target.dataset.act; if(!a) return; const me=auth.currentUser.uid;
    if(a==='accept'){ await db.ref('friends/'+me+'/'+uid).set('accepted'); await db.ref('friends/'+uid+'/'+me).set('accepted'); await db.ref('friendRequests/'+me+'/'+uid).remove(); loadFriends(); }
    if(a==='remove'){ await db.ref('friends/'+me+'/'+uid).remove(); await db.ref('friends/'+uid+'/'+me).remove(); loadFriends(); }
    if(a==='chat'){ localStorage.setItem('dmTo', uid); document.querySelector('[data-view="view-dm"]').click(); }
  });
  return wrap;
}

async function loadFriends(){
  const me=auth.currentUser; if(!me) return;
  const box=document.getElementById('friendsList'); box.innerHTML='';
  const rq=(await db.ref('friendRequests/'+me.uid).get()).val()||{};
  for(const uid of Object.keys(rq)){ box.appendChild(await friendItem(uid, 'pending')); }
  const fr=(await db.ref('friends/'+me.uid).get()).val()||{};
  for(const [uid,st] of Object.entries(fr)){ box.appendChild(await friendItem(uid, st)); }
}

document.getElementById('friendAddBtn')?.addEventListener('click', async ()=>{
  try{
    const me=auth.currentUser; if(!me) return alert('P≈ôihlaste se');
    const email=document.getElementById('friendEmail').value.trim(); if(!email) return;
    const key=email.toLowerCase().replace(/\./g,',');
    const toS=await db.ref('emails/'+key).get(); const uid=(toS.val()&&toS.val().uid); if(!uid) return alert('Email nezn√°m');
    await db.ref('friendRequests/'+uid+'/'+me.uid).set({from:me.uid, ts:Date.now()});
    toast('≈Ω√°dost odesl√°na'); loadFriends();
  }catch(e){ console.error(e); toast('Chyba'); }
});
firebase.auth().onAuthStateChanged(u=>{ if(u) loadFriends(); });



/* ==== dm.js ==== */

const db=firebase.database(); const auth=firebase.auth();
function dmKey(a,b){ return [a,b].sort().join('_'); }
async function resolveUidByEmail(email){
  const key=email.toLowerCase().replace(/\./g,',');
  const s=await db.ref('emails/'+key).get();
  return (s.val()&&s.val().uid)||null;
}

async function renderDM(room){
  const box=document.getElementById('dmFeed'); box.innerHTML='';
  const ref=db.ref('privateMessages/'+room).limitToLast(50);
  ref.on('child_added', async snap=>{
    const m=snap.val(); const u=await fetchUserPublic(m.by);
    const el=document.createElement('div'); el.className='msg';
    el.innerHTML=`<div class="meta"><b>${u.nick||'U≈æivatel'}</b> ¬∑ ${new Date(m.ts).toLocaleString()}</div>`+
      (m.text?`<div>${m.text}</div>`:'')+(m.img?`<img src="${m.img}" class="chat-photo">`:'');
    box.appendChild(el);
  });
}

document.getElementById('dmSend')?.addEventListener('click', async ()=>{
  try{
    const me=auth.currentUser; if(!me) return alert('P≈ôihlaste se');
    let to=document.getElementById('dmTo').value.trim(); if(!to) return;
    if(to.includes('@')){ const uid=await resolveUidByEmail(to); if(!uid) return alert('Email nezn√°m'); to=uid; }
    const text=document.getElementById('dmText').value.trim();
    let img=null; const f=document.getElementById('dmPhoto').files[0]; if(f) img=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
    if(!text && !img) return;
    const room=dmKey(me.uid,to);
    await db.ref('privateMessages/'+room).push({by:me.uid, ts:Date.now(), text, img});
    await db.ref('inboxMeta/'+to+'/'+room).set({from:me.uid, ts:Date.now()});
    document.getElementById('dmText').value=''; document.getElementById('dmPhoto').value=''; toast('Odesl√°no'); SND.dm.play();
    renderDM(room);
  }catch(e){ console.error(e); SND.err.play(); }
});



/* ==== rent.js ==== */

const db=firebase.database(); const auth=firebase.auth();
function ttlDays(d){ return d*24*60*60*1000; }
async function rentAdd(){
  const u=auth.currentUser; if(!u) return alert('P≈ôihlaste se');
  const title=document.getElementById('rentTitle').value.trim();
  const price=parseInt(document.getElementById('rentPrice').value||'0',10);
  const ttl=parseInt(document.getElementById('rentTTL').value||'0',10);
  const f=document.getElementById('rentPhoto').files[0];
  let img=null; if(f){ img=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }
  const d={by:u.uid, title, price, img, status:'active', ts:Date.now()};
  if(ttl>0) d.expiresAt= Date.now()+ttlDays(ttl);
  await db.ref('rentMessages').push(d);
  toast('Inzer√°t p≈ôid√°n'); loadRent();
}
async function loadRent(){
  const s=await db.ref('rentMessages').get(); const v=s.val()||{}; const arr=Object.keys(v).map(id=>({id,...v[id]}));
  const q={status: document.getElementById('rentStatus').value, sort: document.getElementById('rentSort').value};
  let a=arr.filter(x=> !x.expiresAt || x.expiresAt>Date.now()); if(q.status) a=a.filter(x=>x.status===q.status);
  if(q.sort==='price') a.sort((A,B)=>(+A.price||0)-(+B.price||0)); else a.sort((A,B)=> ( (B.ts||0) - (A.ts||0) ));
  const box=document.getElementById('rentFeed'); box.innerHTML='';
  a.forEach(x=>{ const d=document.createElement('div'); d.className='msg'; d.innerHTML=`<div class="meta"><b>${x.title||'(bez n√°zvu)'}</b> ¬∑ ${new Date(x.ts).toLocaleString()} ¬∑ ${x.price||''} Kƒç</div>`+(x.img?`<img src="${x.img}" class="chat-photo">`:'' ); box.appendChild(d); });
}
document.getElementById('rentAdd')?.addEventListener('click', rentAdd);
document.getElementById('rentApply')?.addEventListener('click', loadRent);
window.addEventListener('DOMContentLoaded', loadRent);



/* ==== chat.js ==== */

const db=firebase.database(); const auth=firebase.auth();

function userBadge(u){
  if(!u) return '';
  if(u.role==='admin') return '<span class="badge admin">ADMIN</span>';
  if(u.role==='moderator') return '<span class="badge mod">MOD</span>';
  if(u.premium) return '<span class="badge premium">PREMIUM</span>';
  return '';
}

function msgEl(m,u){
  const d=document.createElement('div'); d.className='msg';
  const name=(u?.nick||'U≈æivatel')+userBadge(u)+ (u?.online?'<span class="online"></span>':'');
  d.innerHTML = `<div class="meta"><b>${name}</b> ¬∑ ${new Date(m.ts||Date.now()).toLocaleString()}</div>`+
                (m.text? `<div class="text">${m.text}</div>`:'' )+
                (m.img? `<img src="${m.img}" class="chat-photo">`:'');
  return d;
}

let offChat=null;
async function loadChat(){
  const feed=$('#chatFeed'); if(!feed) return;
  feed.innerHTML='';
  if(offChat){ offChat(); offChat=null; }
  const city=getCity(); const sel=$('#citySelect'); if(sel) sel.value=city;

  const usersCache={};
  async function getUser(uid){
    if(usersCache[uid]) return usersCache[uid];
    const v=await fetchUserPublic(uid);
    const p=await db.ref('presence/'+uid).get(); v.online=!!(p.val()&&p.val().online);
    return (usersCache[uid]=v);
  }

  const ref=db.ref('messages/'+city).limitToLast(50);
  const cb=(snap)=>{ const m=snap.val()||{}; getUser(m.by).then(u=> feed.appendChild(msgEl(m,u))); };
  ref.on('child_added', cb); offChat=()=> ref.off('child_added', cb);
}
window.addEventListener('DOMContentLoaded', loadChat);
document.getElementById('citySelect')?.addEventListener('change', loadChat);

async function fileToDataURL(f){ return await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }

document.getElementById('sendBtn')?.addEventListener('click', async ()=>{
  try{
    const u=auth.currentUser; if(!u) return alert('P≈ôihlaste se');
    const text=document.getElementById('msgText').value.trim();
    let img=null; const f=document.getElementById('msgPhoto').files[0]; if(f) img=await fileToDataURL(f);
    if(!text && !img) return;
    const m={by:u.uid, ts:Date.now(), text, img};
    await db.ref('messages/'+getCity()).push(m);
    await db.ref('throttle/'+u.uid+'/lastTs').set(Date.now());
    document.getElementById('msgText').value=''; document.getElementById('msgPhoto').value=''; SND.ok.play();
  }catch(e){ console.error(e); SND.err.play(); }
});



/* ==== admin.js ==== */

const db=firebase.database(); const auth=firebase.auth();

document.getElementById('createMakameBot')?.addEventListener('click', async ()=>{
  const city=prompt('Mƒõsto? (nap≈ô. praha)','praha')||'praha';
  const every=parseInt(prompt('Interval minut?','30')||'30',10);
  await BOTS.create({type:'chat', city, everyMin:every, text:'Makame.cz ‚Äî najdi pr√°ci za 5 minut (≈æivƒõ)', ad:true});
  toast('Bot vytvo≈ôen');
});

document.getElementById('premiumGive')?.addEventListener('click', async ()=>{
  const uid=prompt('UID u≈æivatele?'); if(!uid) return;
  await db.ref('roles/'+uid+'/premium').set(true); toast('Premium udƒõleno');
});
document.getElementById('premiumRevoke')?.addEventListener('click', async ()=>{
  const uid=prompt('UID u≈æivatele?'); if(!uid) return;
  await db.ref('roles/'+uid+'/premium').set(false); toast('Premium odebr√°no');
});
document.getElementById('ban30')?.addEventListener('click', async ()=>{
  const uid=prompt('UID?'); if(!uid) return; await db.ref('bans/'+uid).set({until: Date.now()+30*60*1000}); toast('Ban 30 min');
});
document.getElementById('unban')?.addEventListener('click', async ()=>{
  const uid=prompt('UID?'); if(!uid) return; await db.ref('bans/'+uid).remove(); toast('Zru≈°en ban');
});

async function loadUsers(){
  const box=document.getElementById('usersList'); if(!box) return;
  const s=await db.ref('users').get(); const v=s.val()||{}; box.innerHTML='';
  Object.entries(v).forEach(([uid,u])=>{
    const d=document.createElement('div'); d.className='msg';
    d.innerHTML=`<div class="meta"><b>${(u.name||u.nick||'(bez nicku)')}</b> ¬∑ ${u.email||''}</div>`;
    box.appendChild(d);
  });
}
window.addEventListener('DOMContentLoaded', loadUsers);



/* ==== bots.js ==== */
(function(){
  let timer=null;
  function isAdmin(u){ return u?.email === window.ADMIN_EMAIL; }

  async function tick(){
    const auth=firebase.auth(); const db=firebase.database();
    const u=auth.currentUser; if(!u) return;
    const cfg = JSON.parse(localStorage.getItem('BOT_CFG')||'null');
    if(!cfg || !cfg.enabled) return;
    if(!isAdmin(u) && (+cfg.interval < 15)) cfg.interval = 15; // non-admin limit

    const now=Date.now();
    const last=+(localStorage.getItem('BOT_LAST')||0);
    if(now-last < cfg.interval*60*1000) return;

    await db.ref('messages/'+(cfg.city||'praha')).push({
      by: u.uid, text: cfg.text||null, photo: cfg.image||null, ts: now
    });
    localStorage.setItem('BOT_LAST', String(now));
  }

  function startBot(city,text,image,intervalMin){
    localStorage.setItem('BOT_CFG', JSON.stringify({enabled:true,city,text,image,interval:+intervalMin||15}));
    if(timer) clearInterval(timer);
    timer=setInterval(tick, 15000);
    tick();
  }
  function stopBot(){
    localStorage.setItem('BOT_CFG', JSON.stringify({enabled:false}));
    if(timer) clearInterval(timer); timer=null;
  }

  document.addEventListener('click',(e)=>{
    if(e.target && e.target.id==='botStart'){
      const city=document.getElementById('botCity').value||'praha';
      const text=document.getElementById('botText').value||'';
      const image=document.getElementById('botImage').value||null;
      const interval=document.getElementById('botInterval').value||15;
      startBot(city,text,image,interval);
      alert('–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–∏–π');
    }
    if(e.target && e.target.id==='botStop'){ stopBot(); alert('–ë–æ—Ç –∑—É–ø–∏–Ω–µ–Ω–∏–π'); }
  });
})();


/* ==== auth.js ==== */

// auth.js
(function(){
  function start(){
    try{
      if(!(window.firebase && firebase.apps && firebase.apps.length)){
        console.error('Firebase not initialized (auth.js)'); return;
      }
      // If not signed in, try anonymous (debug fallback)
      firebase.auth().onAuthStateChanged(async (u)=>{
        if(!u){
          try{
            await firebase.auth().signInAnonymously();
            console.log('[auth] signed in anonymously');
          }catch(e){
            console.warn('[auth] anon sign-in failed:', e);
          }
        }else{
          // Show email/uid in profile
          const em = (u.email || '(anonymn√≠)');
          const emailEl = document.getElementById('profileEmail');
          if(emailEl) emailEl.textContent = em + ' ¬∑ ' + u.uid.slice(0,6);
        }
      });
    }catch(e){ console.error(e); }
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', start); else start();
})();



/* ==== bootstrap.js ==== */

// bootstrap.js ‚Äî safe startup layer for local file:// runs
(function(){
  function log(...a){ try{ console.log('[bootstrap]', ...a); }catch(e){} }
  function ready(fn){
    if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, {once:true});
    else fn();
  }
  function ensureCity(){
    try{
      const sel = document.getElementById('citySelect');
      let v = (localStorage.getItem('city') || (sel && sel.value) || 'praha');
      const map = { 'Praha':'praha', 'Brno':'brno', 'Ostrava':'ostrava' };
      if(map[v]) v = map[v];
      v = (v||'praha').toLowerCase();
      localStorage.setItem('city', v);
      if(sel && sel.value !== (map[v] || v)) { sel.value = (map[v] || 'Praha'); }
      if(!window.getCity){ window.getCity = ()=> (localStorage.getItem('city') || 'praha'); }
    }catch(e){ log('ensureCity ERR', e); }
  }
  function ensureLocale(){
    try{
      if(typeof window.localeCS === 'undefined' && typeof localeCS !== 'undefined'){
        window.localeCS = localeCS;
      }
    }catch(e){}
  }
  function ensureAuth(cb){
    if(!(window.firebase && firebase.apps && firebase.apps.length)){
      log('Firebase app not ready yet'); cb && cb(); return;
    }
    const auth = firebase.auth();
    let done = false;
    auth.onAuthStateChanged(function(u){
      if(done) return;
      done = true;
      if(u){ log('Auth OK', u.uid); cb && cb(); }
      else{
        auth.signInAnonymously().then(()=>{ log('Signed in anon'); cb && cb(); })
          .catch(e=>{ log('Anon sign-in ERR', e && e.code || e); cb && cb(); });
      }
    });
  }

  window.addEventListener('error', function(e){
    try{ console.log('[JS-ERROR]', e.message, e.filename, e.lineno); }catch(_){}
  });

  ready(function(){
    ensureLocale();
    ensureCity();
    ensureAuth(function(){
      document.dispatchEvent(new CustomEvent('app-bootstrap-ready'));
    });
  });
})();



/* ==== app.js ==== */
// ==== init
firebase.initializeApp(window.FIREBASE_CONFIG);
const auth=firebase.auth();
const db=firebase.database();
const stg=firebase.storage();

const $=(q,root=document)=>root.querySelector(q);
const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));
const esc=(s='')=>s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

// ==== toasts
function showToast(el,txt,ms=2600){ const n=(typeof el==='string')?$(el):el; n.textContent=txt; n.hidden=false; clearTimeout(n._t); n._t=setTimeout(()=>n.hidden=true,ms); }

// ==== globals
if(!localStorage.getItem('city')) localStorage.setItem('city','praha');
let CURRENT_CITY = localStorage.getItem('city');
let CHAT_REF=null, RENT_REF=null, DM_REF=null;
let CURRENT_DM_UID=null;

function isAdmin(u){ return u?.email === window.ADMIN_EMAIL; }

// ==== utils
async function fileToUrl(file){
  return new Promise(async (res,rej)=>{
    try{
      if(window.USE_STORAGE){
        const ref=stg.ref().child(`uploads/${auth.currentUser.uid}/${Date.now()}_${file.name}`);
        await ref.put(file); const url=await ref.getDownloadURL(); res(url);
      } else {
        const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);
      }
    }catch(e){ rej(e); }
  });
}

function bubble({id,name,avatar,text,photo,city}){
  const wrap=document.createElement('div'); wrap.className='msg'; wrap.dataset.id=id||'';
  const ava=document.createElement('div'); ava.className='ava';
  const img=new Image(); img.src=avatar||window.DEFAULT_AVATAR; ava.appendChild(img);
  const b=document.createElement('div'); b.className='bubble';
  const n=document.createElement('div'); n.className='name'; n.textContent=name||'U≈æivatel';
  const t=document.createElement('div'); t.className='text';
  t.innerHTML=(text?esc(text):'') + (photo?`<img src="${photo}" loading="lazy">`:'');
  const actions=document.createElement('div'); actions.className='actions';
  actions.innerHTML=`
    <button data-like="1">üëç</button>
    <button data-like="-1">üëé</button>
    <button data-report>‚ö†Ô∏è –ü–æ—Å–∫–∞—Ä–∂–∏—Ç–∏—Å—å</button>
    <button data-dm>‚úâÔ∏è Napsat</button>
    <button data-del class="adm-only" style="display:none">üóë Smazat</button>`;
  b.append(n,t,actions); wrap.append(ava,b);

  actions.addEventListener('click', async (e)=>{
    const me=auth.currentUser; if(!me) return alert('P≈ôihlaste se');
    if(e.target.dataset.like){ await db.ref(`likes/${city}/${id}/${me.uid}`).set(+e.target.dataset.like); }
    if(e.target.hasAttribute('data-report')){
      const reason=prompt('–ü—Ä–∏—á–∏–Ω–∞ —Å–∫–∞—Ä–≥–∏?'); if(!reason) return;
      await db.ref(`reports/${city}/${id}`).push({by:me.uid,reason,ts:Date.now()});
      showToast('#globalToast','St√≠≈ænost odesl√°na. Dƒõkujeme!');
    }
    if(e.target.hasAttribute('data-dm') && wrap.dataset.by){ openDmWith(wrap.dataset.by); switchTo('dm'); }
    if(e.target.hasAttribute('data-del')){
      await db.ref(`messages/${city}/${id}`).update({deleted:true,deletedBy:me.uid,tsDel:Date.now()}); wrap.remove();
    }
  });
  return wrap;
}

function userPublic(uid){ return db.ref('usersPublic/'+uid).get().then(s=>s.val()||null); }
async function ensureMyPublic(u){
  if(!u) return;
  const s=await db.ref('usersPublic/'+u.uid).get();
  if(!s.exists()){
    await db.ref('usersPublic/'+u.uid).set({ name: u.displayName || 'U≈æivatel', avatar: window.DEFAULT_AVATAR, role: 'seeker', plan: 'free' });
  }
}

// ==== –≤–∫–ª–∞–¥–∫–∏ / –º–µ–Ω—é
function switchTo(tab){ $$('.tab').forEach(t=>t.classList.remove('active')); $$(`[data-tab="${tab}"]`)[0]?.classList.add('active'); $$('.view').forEach(v=>v.classList.remove('active')); $(`#view-${tab}`)?.classList.add('active'); }
$('#toggleTabs').addEventListener('click',()=> $('#tabs').classList.toggle('hidden'));
$('#tabs').addEventListener('click',(e)=>{ const b=e.target.closest('.tab'); if(!b) return; switchTo(b.dataset.tab); });
$('#citySelect').value=CURRENT_CITY;
$('#citySelect').addEventListener('change',()=>{ CURRENT_CITY=$('#citySelect').value; localStorage.setItem('city',CURRENT_CITY); subChat(); subRent(); loadCityBg(); loadReports(); loadPoi(); });

// ==== –æ–Ω–ª–∞–π–Ω-–æ—Ü–µ–Ω–∫–∞
setInterval(()=> $('#onlineCounter').textContent='Online (cca): '+(Math.floor(Math.random()*12)+3), 4000);

// ==== –£—á–∞—Å—Ç–Ω–∏–∫–∏
$('#participantsBtn').addEventListener('click', async()=>{
  const box=$('#participantsModal'); const list=$('#participantsList'); list.innerHTML='';
  const s=await db.ref('usersPublic').get(); const all=s.val()||{};
  for(const [uid,info] of Object.entries(all)){
    const row=document.createElement('div'); row.className='msg'; row.dataset.uid=uid;
    row.innerHTML=`<div class="ava"><img src="${info.avatar||window.DEFAULT_AVATAR}"></div>
      <div class="bubble"><div class="name">${esc(info.name||'U≈æivatel')}</div>
      <div class="muted">${esc(info.role||'seeker')} ¬∑ ${esc(info.plan||'free')}</div>
      <div class="actions">
        <button data-dm>‚úâÔ∏è Napsat</button>
        <button data-add>+ –î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>
      </div></div>`;
    list.appendChild(row);
  }
  list.onclick=async e=>{
    const row=e.target.closest('.msg'); if(!row) return; const uid=row.dataset.uid; const me=auth.currentUser;
    if(e.target.dataset.dm){ openDmWith(uid); box.hidden=true; switchTo('dm'); }
    if(e.target.dataset.add){ if(!me) return alert('P≈ôihlaste se'); await db.ref('friendRequests/'+uid+'/'+me.uid).set({from:me.uid,ts:Date.now(),status:'pending'}); }
  };
  box.hidden=false;
});
$$('#participantsModal [data-close]').forEach(b=> b.onclick=()=> $('#participantsModal').hidden=true);

// ==== CHAT
function renderMessage(city,id,val){
  if(val.deleted) return null;
  const el=bubble({id,name:val._name, avatar:val._avatar, text:val.text, photo:val.photo, city});
  el.dataset.by = val.by;
  return el;
}
async function subChat(){
  if(CHAT_REF){ try{ CHAT_REF.off(); }catch{} }
  $('#chatFeed').innerHTML='';
  CHAT_REF=db.ref('messages/'+CURRENT_CITY).limitToLast(200);
  CHAT_REF.on('child_added', async s=>{
    const m=s.val(); const up=await userPublic(m.by)||{};
    m._name=up.name||'U≈æivatel'; m._avatar=up.avatar||window.DEFAULT_AVATAR;
    const el=renderMessage(CURRENT_CITY, s.key, m); if(el){ $('#chatFeed').appendChild(el); $('#chatFeed').scrollTop = $('#chatFeed').scrollHeight; }
  });
  CHAT_REF.on('child_changed', s=>{
    const el=$(`#chatFeed .msg[data-id="${s.key}"]`); if(el && s.val().deleted) el.remove();
  });
}
subChat();

$('#chatFile').addEventListener('change', e=>{ if(e.target.files?.length) showToast('#chatToast','‚úîÔ∏è –§–æ—Ç–æ –¥–æ–¥–∞–Ω–æ. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏¬ª.'); });

$('#chatSend').onclick = async()=>{
  if(!auth.currentUser) return ensureAuth();
  const ban=await db.ref('bans/'+auth.currentUser.uid).get();
  if(ban.exists() && ban.val().until > Date.now()) return alert('Doƒçasn√Ω z√°kaz odes√≠l√°n√≠');

  let photo=null; const f=$('#chatFile').files[0]; if(f) { try{ photo=await fileToUrl(f); }catch(e){ showToast('#globalToast','‚ö†Ô∏è Nepoda≈ôilo se nahr√°t fotku'); } }
  const urlTextCandidate=$('#chatInput').value.trim();
  const txt = urlTextCandidate || null;
  if(!txt && !photo) return;

  await db.ref('messages/'+CURRENT_CITY).push({by:auth.currentUser.uid, text:txt, photo:photo, ts:Date.now()});
  $('#chatInput').value=''; $('#chatFile').value=''; showToast('#globalToast','‚úîÔ∏è Zpr√°va odesl√°na');
};

$('#clearChat').onclick = async()=>{
  const me=auth.currentUser; if(!me) return;
  const isMod=(await db.ref('roles/'+me.uid+'/moderator').get()).val()===true;
  if(!isAdmin(me) && !isMod) return alert('Pouze admin/moder√°tor');
  if(!confirm('Vyƒçistit cel√Ω chat?')) return;
  const snap=await db.ref('messages/'+CURRENT_CITY).get();
  snap.forEach(child=> db.ref('messages/'+CURRENT_CITY+'/'+child.key).update({deleted:true,deletedBy:me.uid,tsDel:Date.now()}));
};

// ==== RENT
async function subRent(){
  if(RENT_REF){ try{ RENT_REF.off(); }catch{} }
  $('#rentFeed').innerHTML='';
  RENT_REF=db.ref('rentMessages/'+CURRENT_CITY).limitToLast(200);
  RENT_REF.on('child_added', async s=>{
    const m=s.val(); const up=await userPublic(m.by)||{};
    m._name=up.name||'U≈æivatel'; m._avatar=up.avatar||window.DEFAULT_AVATAR;
    const el=renderMessage(CURRENT_CITY, s.key, m); if(el) $('#rentFeed').appendChild(el);
  });
}
subRent();

$('#rentSend').onclick = async()=>{
  if(!auth.currentUser) return ensureAuth();
  let photo=null; const f=$('#rentFile').files[0]; if(f) { try{ photo=await fileToUrl(f); }catch(e){ showToast('#globalToast','‚ö†Ô∏è Nepoda≈ôilo se nahr√°t fotku'); } }
  const txt=$('#rentInput').value.trim()||null; if(!txt && !photo) return;
  await db.ref('rentMessages/'+CURRENT_CITY).push({by:auth.currentUser.uid,text:txt,photo:photo,ts:Date.now()});
  $('#rentInput').value=''; $('#rentFile').value=''; showToast('#globalToast','‚úîÔ∏è Inzer√°t odesl√°n');
};

// ==== DMs
function openDmWith(uid){
  if(DM_REF){ try{ DM_REF.off(); }catch{} }
  CURRENT_DM_UID=uid; $('#dmMessages').innerHTML=''; $('#dmHeader').textContent='–î—ñ–∞–ª–æ–≥';
  const me=auth.currentUser?.uid; if(!me){ ensureAuth(); return; }
  const tid=[me,uid].sort().join('_');
  DM_REF=db.ref('privateMessages/'+tid).limitToLast(200);
  DM_REF.on('child_added', async s=>{
    const m=s.val(); const up=await userPublic(m.by)||{};
    const el=bubble({id:s.key,name:up.name||'U≈æivatel',avatar:up.avatar||window.DEFAULT_AVATAR,text:m.text,photo:m.photo,city:'dm'}); $('#dmMessages').appendChild(el);
    $('#dmMessages').scrollTop = $('#dmMessages').scrollHeight;
  });
  $('#dmSend').onclick = async ()=>{
    const txt=$('#dmInput').value.trim(); let photo=null; const f=$('#dmFile').files[0];
    if(f){ try{ photo=await fileToUrl(f); }catch(e){ showToast('#globalToast','‚ö†Ô∏è Fotka se nenahr√°la'); } }
    if(!txt && !photo) return;
    await db.ref('privateMessages/'+tid).push({by:me,text:txt||null,photo:photo||null,ts:Date.now()});
    $('#dmInput').value=''; $('#dmFile').value=''; showToast('#globalToast','‚úîÔ∏è Zpr√°va odesl√°na');
  };
}
document.addEventListener('click', (e)=>{ if(e.target && e.target.matches('[data-dm-open]')) openDmWith(e.target.getAttribute('data-dm-open')); });
document.addEventListener('click', (e)=>{ if(e.target && e.target.matches('[data-open-profile]')) alert('–ü—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–¥–µ–º–æ)'); });
$('#dmFile').addEventListener('change', e=>{ if(e.target.files?.length) showToast('#dmToast','‚úîÔ∏è –§–æ—Ç–æ –¥–æ–¥–∞–Ω–æ –¥–æ –õ–°. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ù–∞–¥—ñ—Å–ª–∞—Ç–∏¬ª.'); });

// ==== Help & Announce
$('#helpPost')?.addEventListener('click', async()=>{
  const u=auth.currentUser; if(!isAdmin(u)) return alert('Jen pro admina');
  const v={title:$('#helpTitle').value.trim(), link:$('#helpLink').value.trim()||null, image:$('#helpImage').value.trim()||null, ts:Date.now()};
  await db.ref('help/'+CURRENT_CITY+'/cards').push(v);
  $('#helpTitle').value=''; $('#helpLink').value=''; $('#helpImage').value='';
});
function subHelp(){
  db.ref('help/'+CURRENT_CITY+'/cards').off();
  $('#helpGrid').innerHTML='';
  db.ref('help/'+CURRENT_CITY+'/cards').on('child_added', s=>{
    const v=s.val(); const c=document.createElement('div'); c.className='card';
    c.innerHTML=`${v.image?`<img src="${v.image}" style="width:100%;border-radius:10px">`:''}<b>${esc(v.title||'')}</b>${v.link?` ¬∑ <a href="${v.link}" target="_blank">Otev≈ô√≠t</a>`:''}`;
    $('#helpGrid').prepend(c);
  });
}
subHelp();

$('#anPost')?.addEventListener('click', async()=>{
  const u=auth.currentUser; if(!isAdmin(u)) return alert('Jen pro admina');
  const v={title:$('#anTitle').value.trim(), image:$('#anImage').value.trim()||null, text:$('#anText').value.trim()||'', ts:Date.now()};
  await db.ref('announce/'+CURRENT_CITY).push(v);
  $('#anTitle').value=''; $('#anImage').value=''; $('#anText').value='';
});
function subAnnounce(){
  db.ref('announce/'+CURRENT_CITY).off();
  $('#anGrid').innerHTML='';
  db.ref('announce/'+CURRENT_CITY).on('child_added', s=>{
    const v=s.val(); const c=document.createElement('div'); c.className='card';
    c.innerHTML=`${v.image?`<img src="${v.image}" style="width:100%;border-radius:10px">`:''}<b>${esc(v.title||'')}</b><div>${esc(v.text||'')}</div>`;
    $('#anGrid').prepend(c);
  });
}
subAnnounce();

// ==== MAP
let map, markers=[];
function initMap(){ if(map) return; map=L.map('map').setView([50.0755,14.4378],12); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(map); }
initMap();
$('#mapCenter').onclick=()=> map.setView([50.0755,14.4378],12);
function loadPoi(){
  markers.forEach(m=>m.remove()); markers=[]; db.ref('map/poi/'+CURRENT_CITY).off();
  db.ref('map/poi/'+CURRENT_CITY).on('child_added', s=>{
    const v=s.val()||{}; const ico = v.avatar? L.icon({iconUrl:v.avatar,iconSize:[36,36],className:'poi-ava'}) : undefined;
    const m=L.marker([v.lat||50.08, v.lng||14.43], ico?{icon:ico}:{ });
    m.addTo(map);
    m.bindPopup(`<div><b>${esc(v.title||'Bod')}</b></div><div>–¢–∏–ø: ${esc(v.type||'')}</div>${v.photo?`<div><img src="${v.photo}" style="max-width:180px;border-radius:8px;margin-top:6px"></div>`:''}<div class="muted">lat: ${v.lat} ¬∑ lng: ${v.lng}</div>`);
    markers.push(m);
  });
}
loadPoi();
$('#poiAdd').onclick = async()=>{
  const u=auth.currentUser; if(!u) return ensureAuth();
  const isMod=(await db.ref('roles/'+u.uid+'/moderator').get()).val()===true;
  if(!isAdmin(u) && !isMod) return alert('Pouze admin/moder√°tor');
  const c=map.getCenter();
  const lat=parseFloat($('#poiLat').value)||c.lat; const lng=parseFloat($('#poiLng').value)||c.lng;
  const v={title:$('#poiTitle').value.trim(), type:$('#poiType').value.trim(), avatar:$('#poiAvatar').value.trim()||null, photo:$('#poiPhoto').value.trim()||null, lat,lng,ts:Date.now(),by:u.uid};
  await db.ref('map/poi/'+CURRENT_CITY).push(v);
  $('#poiTitle').value=$('#poiType').value=$('#poiAvatar').value=$('#poiPhoto').value=$('#poiLat').value=$('#poiLng').value='';
};

// ==== —Ñ–æ–Ω –≥–æ—Ä–æ–¥–∞
async function loadCityBg(){ try{ const cs=await db.ref('settings/theme/cityBackgrounds/'+CURRENT_CITY).get(); const url=cs.exists()?cs.val():null;
  if(url){ document.documentElement.style.setProperty('--wall', `url('${url}')`); localStorage.setItem('bg_'+CURRENT_CITY,url); }
  else{ const cached=localStorage.getItem('bg_'+CURRENT_CITY); if(cached) document.documentElement.style.setProperty('--wall', `url('${cached}')`); }
}catch{} }
loadCityBg();
$('#saveCityBg').onclick = async()=>{
  const u=auth.currentUser; if(!u) return ensureAuth();
  const isMod=(await db.ref('roles/'+u.uid+'/moderator').get()).val()===true;
  if(!isAdmin(u) && !isMod) return alert('Pouze admin/moder√°tor');
  const url=$('#cityBgUrl').value.trim(); if(!url) return;
  await db.ref('settings/theme/cityBackgrounds/'+CURRENT_CITY).set(url);
  document.documentElement.style.setProperty('--wall', `url('${url}')`); $('#cityBgUrl').value='';
};
$('#cityBgFile').addEventListener('change', async(e)=>{
  const u=auth.currentUser; if(!u) return ensureAuth();
  const isMod=(await db.ref('roles/'+u.uid+'/moderator').get()).val()===true;
  if(!isAdmin(u) && !isMod) return alert('Pouze admin/moder√°tor');
  const f=e.target.files[0]; if(!f) return; const url=await fileToUrl(f);
  await db.ref('settings/theme/cityBackgrounds/'+CURRENT_CITY).set(url);
  document.documentElement.style.setProperty('--wall', `url('${url}')`); e.target.value='';
});

// ==== –ü—Ä–æ—Ñ—ñ–ª—å
$('#profileBtn').onclick=()=> $('#profileModal').hidden=false;
$$('#profileModal [data-close]').forEach(b=> b.onclick=()=> $('#profileModal').hidden=true);

async function refreshMe(){
  const u=auth.currentUser; if(!u) return;
  const me=await userPublic(u.uid)||{};
  $('#myName').textContent=me.name||'U≈æivatel';
  $('#myRole').textContent=me.role||'seeker';
  $('#myAvatar').src=me.avatar||window.DEFAULT_AVATAR;
}
$('#saveProfile').onclick = async()=>{
  if(!auth.currentUser) return;
  const uid=auth.currentUser.uid;
  const up={}; const n=$('#setNick').value.trim(); if(n) up.name=n;
  const a=$('#setAvatarUrl').value.trim(); if(a) up.avatar=a;
  const r=$('#setRole').value; if(r) up.role=r;
  await db.ref('usersPublic/'+uid).update(up);
  $('#setNick').value=''; $('#setAvatarUrl').value='';
  refreshMe();
};
$('#avatarFile').addEventListener('change', async(e)=>{
  const f=e.target.files[0]; if(!f) return; const url=await fileToUrl(f);
  await db.ref('usersPublic/'+auth.currentUser.uid).update({avatar:url}); refreshMe(); e.target.value='';
});

$('#buyPremium').onclick=async()=>{
  const me=auth.currentUser; if(!me) return ensureAuth();
  const amount = prompt('Tarif:\n- 50 CZK: Basic (–±–µ–∑ –±–æ—Ç–∞)\n- 100 CZK: Premium\n- 150 CZK: Premium+\n–í–≤–µ–¥—ñ—Ç—å —Å—É–º—É (50/100/150):','100');
  if(!amount) return;
  showToast('#globalToast','‚úîÔ∏è –ó–∞—è–≤–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞. –î–æ–¥–∞–π—Ç–µ —á–µ–∫. –Ø–∫—â–æ –ª–∏—Å—Ç –≤—ñ–¥ –Ω–∞—Å ‚Äî ‚ö†Ô∏è –ü–ï–†–ï–í–Ü–†–¢–ï –°–ü–ê–ú!');
  await db.ref('payments/requests/'+me.uid).push({amount:+amount, ts:Date.now()});
};

// ==== –†–æ–ª—ñ/–±–∞–Ω/—Ä–µ–ø–æ—Ä—Ç–∏
async function loadReports(){ const box=$('#reportsBox'); if(!box) return;
  box.innerHTML=''; const s=await db.ref('reports/'+CURRENT_CITY).get(); const all=s.val()||{};
  Object.entries(all).forEach(([msgId,items])=>{ Object.values(items||{}).forEach(rep=>{
    const div=document.createElement('div'); div.className='msg';
    div.innerHTML=`<div class="bubble"><div class="name">–°–∫–∞—Ä–≥–∞</div>
    <div>msg: ${msgId}</div><div>${esc(rep.reason||'')}</div>
    <div class="muted">${new Date(rep.ts).toLocaleString()}</div>
    <div class="actions"><button data-godel data-id="${msgId}">Smazat –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</button></div></div>`;
    box.appendChild(div); }); });
  box.onclick=async e=>{
    if(e.target.dataset.godel){
      const me=auth.currentUser; const isMod=(await db.ref('roles/'+me.uid+'/moderator').get()).val()===true;
      if(!isAdmin(me) && !isMod) return;
      await db.ref('messages/'+CURRENT_CITY+'/'+e.target.dataset.id).update({deleted:true,deletedBy:me.uid,tsDel:Date.now()});
      showToast('#globalToast','‚úîÔ∏è Smaz√°no');
    }
  };
}
$('#makeMod')?.addEventListener('click', async()=>{ const uid=$('#roleUid').value.trim(); if(!uid) return; await db.ref('roles/'+uid).update({moderator:true}); showToast('#globalToast','Hotovo'); });
$('#removeMod')?.addEventListener('click', async()=>{ const uid=$('#roleUid').value.trim(); if(!uid) return; await db.ref('roles/'+uid).update({moderator:false}); showToast('#globalToast','Hotovo'); });
$('#ban30')?.addEventListener('click', async()=>{
  const uid=$('#roleUid').value.trim(); if(!uid) return;
  const reason=$('#banReason').value.trim()||'–ø–æ—Ä—É—à–µ–Ω–Ω—è –ø—Ä–∞–≤–∏–ª';
  await db.ref('bans/'+uid).set({until: Date.now()+30*60*1000, reason}); showToast('#globalToast','‚õî Ban 30 min');
});
$('#unban')?.addEventListener('click', async()=>{ const uid=$('#roleUid').value.trim(); if(!uid) return; await db.ref('bans/'+uid).remove(); showToast('#globalToast','‚úÖ –†–æ–∑–±–∞–Ω'); });

// ==== –ø—Ä–æ—Å—Ç–∏–π –º—ñ–Ω—ñ-–ª–æ–≥—ñ–Ω/—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è/verify/reset
async function ensureAuth(){
  const u=auth.currentUser; if(u) return u;
  const mode = prompt('–í—Ö—ñ–¥/–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è: –≤–≤–µ–¥—ñ—Ç—å EMAIL (–∞–±–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏)'); if(!mode) return null;
  const email = mode.trim();
  const pass = prompt('–ü–∞—Ä–æ–ª—å (–º—ñ–Ω. 6 —Å–∏–º–≤–æ–ª—ñ–≤)'); if(!pass) return null;
  try{
    let cred;
    try { cred = await auth.signInWithEmailAndPassword(email,pass); }
    catch{ cred = await auth.createUserWithEmailAndPassword(email,pass);
           try{ await cred.user.sendEmailVerification(); showToast('#globalToast','Potvrzovac√≠ e-mail odesl√°n. ‚ö†Ô∏è Zkontrolujte SPAM!'); }catch{} }
    await ensureMyPublic(cred.user); showToast('#globalToast','V√≠tejte! Jste p≈ôihl√°≈°en.');
    return cred.user;
  }catch(e){ alert('Auth error: '+e.message); return null; }
}

$('#resetPass')?.addEventListener('click', async()=>{
  const email = auth.currentUser?.email || prompt('–í–∫–∞–∂—ñ—Ç—å email –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è:');
  if(!email) return;
  try{ await auth.sendPasswordResetEmail(email); showToast('#globalToast','E-mail pro obnovu odesl√°n. ‚ö†Ô∏è Zkontrolujte SPAM!'); }
  catch(e){ alert(e.message); }
});

auth.onAuthStateChanged(async u=>{
  $$('.adm-only').forEach(x=> x.style.display = (u && isAdmin(u)) ? 'block' : 'none');
  if(u){ await ensureMyPublic(u); await refreshMe(); loadReports(); }
});

$('#btnSignout').onclick=()=> auth.signOut();

// —Å—Ç–∞—Ä—Ç
loadReports();


/* ==== diagnostics.js ==== */

// diagnostics.js
(function(){

// --- auto UI inject ---
(function(){
  if (document.getElementById('diagPanel')) return;
  const wrap = document.createElement('div');
  wrap.id = 'diagPanel';
  wrap.style.cssText = 'position:fixed;right:12px;bottom:12px;z-index:99999;background:#0e1a1f;color:#d7fbe8;border:1px solid #1f3b45;border-radius:10px;padding:10px;font:12px/1.2 system-ui;box-shadow:0 6px 24px rgba(0,0,0,.3)';
  wrap.innerHTML = '<div style="display:flex;gap:6px;align-items:center;margin-bottom:6px;"><b>Diag</b><button id="diagPing">Ping</button><button id="diagSeed">Seed</button><button id="diagClose" title="Hide">√ó</button></div><pre id="diagOut" style="margin:0;max-width:300px;max-height:160px;overflow:auto;"></pre>';
  document.body.appendChild(wrap);
  document.getElementById('diagClose').onclick = ()=> wrap.remove();
})();

  function start(){
    if(!(window.firebase && firebase.apps && firebase.apps.length)) return;
    const db = firebase.database();
    const out = document.getElementById('diagOut');
    function show(msg){ if(out){ out.textContent = msg; } console.log('[diag]', msg); }
    const pingBtn = document.getElementById('diagPing');
    const seedBtn = document.getElementById('diagSeed');
    if(pingBtn){
      pingBtn.addEventListener('click', async ()=>{
        try{
          const ref = db.ref('diagnostics/ping');
          const ts = Date.now();
          await ref.push({ts});
          show('Ping OK: '+ts);
        }catch(e){
          show('Ping ERR: '+(e && e.code ? e.code : e.message));
        }
      });
    }
    if(seedBtn){
      seedBtn.addEventListener('click', async ()=>{
        try{
          const city = (localStorage.getItem('city') || 'praha');
          const u = firebase.auth().currentUser;
          if(!u){ show('Seed ERR: not signed in'); return; }
          await db.ref('messages/'+city).push({by:u.uid, ts:Date.now(), text:'Test zpr√°va (seed)'});
          show('Seed OK to messages/'+city);
        }catch(e){
          show('Seed ERR: '+(e && e.code ? e.code : e.message));
        }
      });
    }
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', start); else start();
})();



/* ==== sw-register.js ==== */
if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js').catch(()=>{});}

</script>
</body>
</html>