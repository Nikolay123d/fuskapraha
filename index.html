<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Praha Fu≈°ky ‚Äî —Å–æ—Ü—á–∞—Ç</title>

  <!-- –®–†–ò–§–¢–´ -->
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <!-- –°–¢–ò–õ–ò -->
  <style>
    :root{
      --accent:#22c55e; --accent-2:#10b981; --danger:#ef4444;
      --glass:rgba(255,255,255,.96); --muted:#64748b; --ink:#0b1220;
      --max:1020px; --avatar:44px; --header-h:66px; --chat-scale:1.12;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Arial,sans-serif;background:#071126;color:var(--ink);overflow-x:hidden}
    body{background:url('https://i.ibb.co/27hgtZfY/Prague.jpg') center/cover fixed}

    /* Header */
    header{position:sticky;top:0;z-index:80;padding:6px 8px;text-align:center;color:#fff;backdrop-filter:blur(3px)}
    .brandRow{display:flex;align-items:center;justify-content:center;gap:10px;min-height:var(--header-h);position:relative}
    .profile-btn,.bell-btn,.gear-btn{
      position:absolute;top:8px;width:46px;height:46px;border-radius:50%;border:2px solid rgba(255,255,255,.9);
      display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35);color:#fff;background:rgba(0,0,0,.28)
    }
    .profile-btn{left:8px;background-size:cover;background-position:center}
    .gear-btn{right:64px;display:none}
    .bell-btn{right:8px}
    .bell-badge{position:absolute;top:-6px;right:-6px;background:#ff3366;color:#fff;border-radius:12px;padding:2px 6px;font-size:12px;font-weight:700;box-shadow:0 0 10px rgba(255,51,102,.9);display:none}
    header h1{
      margin:0;font-family:'UnifrakturCook',Inter,sans-serif;font-weight:700;font-size:34px;letter-spacing:1px;text-transform:uppercase;
      background:linear-gradient(90deg,#22c55e,#ef4444);-webkit-background-clip:text;background-clip:text;color:transparent;
      text-shadow:0 2px 0 rgba(0,0,0,.55),0 6px 18px rgba(0,0,0,.6)
    }
    header .sub{margin:4px auto 0;font-size:13px;color:#e8ffee;display:inline-block;padding:6px 10px;border-radius:10px;background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.08)}

    /* Tabs bar */
    .topBar{position:sticky;top:var(--header-h);z-index:70;backdrop-filter:blur(2px)}
    .neon-wrap{max-width:var(--max);margin:6px auto 0;padding:6px 8px}
    .neon-tabs{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .tab-button{border:none;font-weight:800;letter-spacing:.2px;cursor:pointer;border-radius:12px;padding:8px 14px;color:#021f13;background:#cfffdf;box-shadow:0 0 12px rgba(34,197,94,.35),inset 0 -3px 0 rgba(0,0,0,.06);transition:.15s transform ease,.15s box-shadow ease}
    .tab-button:hover{transform:translateY(-1px);box-shadow:0 0 16px rgba(34,197,94,.8),inset 0 -3px 0 rgba(0,0,0,.06)}
    .tab-button.active{outline:2px solid #39ff91;box-shadow:0 0 18px rgba(57,255,145,.9),inset 0 -3px 0 rgba(0,0,0,.06)}
    .online-neon{margin:6px auto 8px;max-width:var(--max);text-align:center;color:#baffd1;font-weight:800;text-shadow:0 0 8px rgba(57,255,145,.9);background:rgba(0,0,0,.35);border:1px solid rgba(57,255,145,.35);border-radius:10px;padding:6px 10px}

    main.container{max-width:var(--max);margin:0 auto;padding:8px}
    .tab-content{display:none}
    .tab-content.active{display:block}

    /* Chat feed */
    .chat-area{height:calc(100vh - 320px);overflow:auto;padding:10px 6px}
    .messages{display:flex;flex-direction:column;gap:12px;padding-bottom:220px;transform:scale(var(--chat-scale));transform-origin:bottom left}
    .message{display:flex;gap:10px;align-items:flex-start;max-width:78%;word-break:break-word}
    .message.self{margin-left:auto;flex-direction:row-reverse}
    .avatar{width:var(--avatar);height:var(--avatar);border-radius:50%;object-fit:cover;flex:0 0 var(--avatar);box-shadow:0 3px 10px rgba(0,0,0,.35);cursor:pointer}
    .message-content{background:var(--glass);padding:10px 12px;border-radius:14px;box-shadow:0 6px 30px rgba(2,6,23,.18);color:var(--ink);position:relative}
    .message.self .message-content{background:#E9FFF0}
    .message-meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .chat-image{max-width:300px;border-radius:8px;margin-top:8px;display:block}
    .message-content .text{font-weight:600;font-size:1rem;white-space:pre-wrap}
    .msg-actions{position:absolute;right:6px;top:6px;opacity:.7;font-size:12px}
    .msg-actions button{border:none;background:transparent;cursor:pointer}

    /* Input bar */
    .chat-input{position:fixed;left:0;right:0;bottom:0;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,.96),rgba(255,255,255,.99));border-top:1px solid rgba(0,0,0,.06);z-index:90;display:flex;gap:8px;align-items:center;max-width:var(--max);margin:0 auto}
    .camera-btn{display:inline-flex;align-items:center;justify-content:center;cursor:pointer;width:48px;height:48px;border-radius:50%;background:#fff;border:1px solid #e6e6e6}
    .camera-btn svg{width:20px;height:20px}
    .chat-input input[type="text"]{flex:1;padding:12px 14px;border-radius:24px;border:1px solid #d0d7de;font-size:16px;outline:none}
    .send-btn{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:20px;font-weight:800;cursor:pointer;box-shadow:0 8px 20px rgba(34,197,94,.18)}

    /* Modals */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:95}
    .modal.show{display:flex}
    .modal .panel{background:#fff;border-radius:12px;padding:16px;width:92%;max-width:780px;position:relative;box-shadow:0 18px 80px rgba(2,6,23,.4)}
    .modal .close{position:absolute;right:10px;top:8px;background:transparent;border:none;font-size:18px;cursor:pointer}

    /* Message context menu */
    .msg-menu{position:absolute;background:#fff;border-radius:8px;padding:6px;box-shadow:0 6px 20px rgba(0,0,0,.2);z-index:200;display:none}
    .msg-menu button{display:block;border:none;background:transparent;padding:6px 10px;text-align:left;width:100%;cursor:pointer}
    .msg-menu button:hover{background:rgba(0,0,0,.03)}

    /* Help cards */
    .help-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;padding:12px}
    .help-card{background:#fff;padding:10px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .help-card img{width:100%;height:140px;object-fit:cover;border-radius:8px}

    /* Friends */
    .friends-wrap{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
    .friend-card{background:#fff;border-radius:10px;padding:10px;box-shadow:0 2px 10px rgba(0,0,0,.08);display:flex;gap:10px;align-items:center}

    /* Map */
    #map{width:100%;height:60vh;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.3);background:#eaf7ff}

    /* Admin bar + users table */
    .admin-bar{position:sticky;top:0;z-index:67;display:none;max-width:var(--max);margin:6px auto;padding:8px;border-radius:10px;background:rgba(0,0,0,.35);border:1px solid rgba(57,255,145,.35);color:#dfffe8}
    .admin-bar .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .admin-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:10px;background:#fff;color:#111;box-shadow:0 2px 8px rgba(0,0,0,.15)}
    .admin-chip input[type="range"]{width:120px}

    .modal.full .panel{width:98%;max-width:none;height:92vh;display:flex;flex-direction:column}
    .admin-users-head{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .admin-users-search{flex:1;display:flex;gap:8px}
    .admin-users-body{flex:1;overflow:auto;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    .grid-users{width:100%;border-collapse:collapse}
    .grid-users th,.grid-users td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left;vertical-align:middle}
    .grid-users th{position:sticky;top:0;background:#f8fafc;z-index:1}
    .user-badge{display:inline-flex;align-items:center;gap:6px;background:#f1f5f9;border-radius:999px;padding:4px 8px;font-size:12px}
    .tag-premium{background:#ecfeff}.tag-banned{background:#fee2e2}
    .btn-mini{border:none;border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer}
    .btn-red{background:#fee2e2}.btn-green{background:#dcfce7}.btn-amber{background:#fff3cd}
    .muted{color:#64748b}.pill{display:inline-block;border:1px solid #e5e7eb;border-radius:999px;padding:4px 8px;font-size:12px;background:#fff}
    .blink{animation:blink 1.3s linear infinite}@keyframes blink{50%{opacity:.45}}

    @media (max-width:640px){
      .chat-area{height:calc(100vh - 360px)}
      .chat-image{max-width:200px}
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <header>
    <div class="brandRow">
      <button id="profileBtn" class="profile-btn" title="–ü—Ä–æ—Ñ—ñ–ª—å" aria-label="–ü—Ä–æ—Ñ—ñ–ª—å"></button>
      <h1>PRAHA FU≈†KY</h1>
      <button id="gearBtn" class="gear-btn" title="–ê–¥–º—ñ–Ω" aria-label="–ê–¥–º—ñ–Ω">‚öôÔ∏è</button>
      <button id="bellBtn" class="bell-btn" title="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è" aria-label="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è">üîî<span id="bellBadge" class="bell-badge">0</span></button>
    </div>
    <div class="sub">–î–æ–ø–æ–º–∞–≥–∞—î–º–æ —É–∫—Ä–∞—ó–Ω—Ü—è–º —É –ü—Ä–∞–∑—ñ ‚Äî —Å–ø—ñ–ª—å–Ω–æ—Ç–∞, —á–∞—Ç, –æ—Ä–µ–Ω–¥–∞, –¥–æ–ø–æ–º–æ–≥–∞.</div>
  </header>

  <!-- TOP TABS -->
  <div class="topBar">
    <div class="neon-wrap">
      <nav class="neon-tabs" role="tablist" aria-label="–í–∫–ª–∞–¥–∫–∏">
        <button class="tab-button active" data-target="chatTab">üí¨ –ß–∞—Ç</button>
        <button class="tab-button" data-target="rentTab">üè† –ß–∞—Ç –û—Ä–µ–Ω–¥–∞</button>
        <button class="tab-button" data-target="mapTab">üó∫Ô∏è –ö–∞—Ä—Ç–∞</button>
        <button class="tab-button" data-target="friendsTab">üë• –î—Ä—É–∑—ñ</button>
        <button class="tab-button" data-target="helpTab">üÜò –î–æ–ø–æ–º–æ–≥–∞</button>
        <button class="tab-button" data-target="dmTab">‚úâÔ∏è –û—Å–æ–±–∏—Å—Ç—ñ</button>
      </nav>
      <div class="online-neon" id="onlineNeon">–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): 0</div>
    </div>
  </div>

  <!-- MAIN TABS CONTENT -->
  <main class="container" role="main">
    <!-- –ê–¥–º–∏–Ω-–±–∞—Ä –ø–æ–≤–µ—Ä—Ö —á–∞—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç; –≤–∫–ª—é—á–∞–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º –¥–ª—è –∞–¥–º–∏–Ω–∞) -->
    <div id="adminBar" class="admin-bar">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:800">–ö–µ—Ä—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞–º–∏</div>
        <div>
          <button id="startAll" class="tab-button">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—Å—ñ—Ö</button>
          <button id="stopAll" class="tab-button" style="background:#ffe1e1">‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏ –≤—Å—ñ—Ö</button>
          <button id="postOnceAll" class="tab-button" style="background:#fff3cd">‚ö°Ô∏è –ü–æ –æ–¥–Ω–æ–º—É –ø–æ—Å—Ç—É</button>
          <button id="openAllUsers" class="tab-button" style="background:#d1fae5">üë• –£—á–∞—Å–Ω–∏–∫–∏</button>
        </div>
      </div>
      <div id="botsRow" class="row" style="margin-top:8px"></div>
    </div>

    <!-- –ß–ê–¢ -->
    <section id="chatTab" class="tab-content active" role="region" aria-label="–ß–∞—Ç">
      <div class="chat-area" id="chatArea" aria-live="polite">
        <div id="messages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- –ß–ê–¢ –û–†–ï–ù–î–ê -->
    <section id="rentTab" class="tab-content" role="region" aria-label="–ß–∞—Ç –û—Ä–µ–Ω–¥–∞">
      <div class="chat-area" id="rentArea">
        <div id="rentMessages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- –ö–ê–†–¢–ê -->
    <section id="mapTab" class="tab-content" role="region" aria-label="–ö–∞—Ä—Ç–∞">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <input id="mapSearch" placeholder="–ü–æ—à—É–∫ (–≤–æ–ª–æ–Ω—Ç–µ—Ä–∏, –∞–ø—Ç–µ–∫–∞‚Ä¶)" style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd" />
        <button id="centerBtn" class="tab-button" style="padding:6px 10px">–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏</button>
      </div>
      <div id="map"></div>
    </section>

    <!-- –î–†–£–ó–Ü -->
    <section id="friendsTab" class="tab-content" role="region" aria-label="–î—Ä—É–∑—ñ">
      <h2 style="color:#fff;margin:6px 0">–î—Ä—É–∑—ñ —Ç–∞ –∑–∞—è–≤–∫–∏</h2>
      <div class="friends-wrap">
        <div>
          <h3>–ó–∞—è–≤–∫–∏</h3>
          <div id="friendRequests"></div>
        </div>
        <div>
          <h3>–ú–æ—ó –¥—Ä—É–∑—ñ (<span id="friendsOnlineCount">0</span> –æ–Ω–ª–∞–π–Ω)</h3>
          <div id="friendsList"></div>
        </div>
      </div>
    </section>

    <!-- –î–û–ü–û–ú–û–ì–ê -->
    <section id="helpTab" class="tab-content" role="region" aria-label="–î–æ–ø–æ–º–æ–≥–∞">
      <h2 style="color:#fff">–¢–µ—Ä–º—ñ–Ω–æ–≤–∞ –¥–æ–ø–æ–º–æ–≥–∞ —É –ü—Ä–∞–∑—ñ</h2>
      <div class="help-grid" id="helpGrid">
        <div class="help-card"><img src="https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp" alt=""><h3>Nemocnice Motol</h3><p>V √övalu 84</p></div>
        <div class="help-card"><img src="https://i.ibb.co/0gWD5wW/images-5.jpg" alt=""><h3>–Æ—Ä–∏–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞</h3><p>–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó</p></div>
        <div class="help-card"><img src="https://i.ibb.co/R49shL6k/images-6.jpg" alt=""><h3>–£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –º–∞–≥–∞–∑–∏–Ω–∏</h3><p>–ü—Ä–æ–¥—É–∫—Ç–∏</p></div>
      </div>
    </section>

    <!-- –õ–° –°–ü–ò–°–û–ö -->
    <section id="dmTab" class="tab-content" role="region" aria-label="–û—Å–æ–±–∏—Å—Ç—ñ">
      <h2 style="color:#fff;margin:6px 0">–ú–æ—ó –¥—ñ–∞–ª–æ–≥–∏</h2>
      <div id="dmList"></div>
    </section>
  </main>

  <!-- –û–±—â–∏–π input (—Ñ–æ—Ç–æ + —Ç–µ–∫—Å—Ç + –∫–Ω–æ–ø–∫–∞) -->
  <input id="fileInput" type="file" accept="image/*" style="display:none" />
  <div class="chat-input" role="region" aria-label="–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">
    <label for="fileInput" class="camera-btn" id="cameraLabel" aria-hidden="true">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M4 7H6L7 5H17L18 7H20C21.1 7 22 7.9 22 9V19C22 20.1 21.1 21 20 21H4C2.9 21 2 20.1 2 19V9C2 7.9 2.9 7 4 7Z" fill="#111"/><circle cx="12" cy="13" r="3.5" fill="#fff"/></svg>
    </label>
    <input id="messageInput" type="text" inputmode="text" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." aria-label="–¢–µ–∫—Å—Ç" />
    <button id="sendButton" class="send-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
  </div>

  <!-- –ú–û–î–ê–õ–ö–ò: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è, –ü—Ä–æ—Ñ–∏–ª—å, –ú–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏—è, –ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫, –ê–¥–º–∏–Ω, –£—á–∞—Å—Ç–Ω–∏–∫–∏ -->
  <div id="authModal" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <button class="close" id="modalClose">‚úñ</button>
      <h2>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è / –í—Ö—ñ–¥</h2>
      <form id="registerForm" class="auth-form" onsubmit="return false;">
        <input id="nickInput" type="text" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" required />
        <input id="emailInput" type="email" placeholder="Email" required />
        <input id="passwordInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω. 6)" required />
        <div class="auth-actions" style="display:flex;gap:8px">
          <button id="registerSubmit" type="button" class="tab-button" style="flex:1">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
          <button id="loginShow" type="button" class="tab-button" style="flex:1;background:#4b5563;color:#fff">–£–≤—ñ–π—Ç–∏</button>
        </div>
        <div id="regError" class="muted" style="color:#b91c1c;margin-top:6px"></div>
      </form>
      <form id="loginForm" class="auth-form" style="display:none" onsubmit="return false;">
        <input id="loginEmail" type="email" placeholder="Email" required />
        <input id="loginPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" required />
        <div class="auth-actions" style="display:flex;gap:8px">
          <button id="loginSubmit" type="button" class="tab-button" style="flex:1">–£–≤—ñ–π—Ç–∏</button>
          <button id="backToRegister" type="button" class="tab-button" style="flex:1;background:#4b5563;color:#fff">–ù–∞–∑–∞–¥</button>
        </div>
        <div id="loginError" class="muted" style="color:#b91c1c;margin-top:6px"></div>
      </form>
    </div>
  </div>

  <div id="profileModal" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <button class="close" id="profileClose">‚úñ</button>
      <div id="profileContent"></div>
    </div>
  </div>

  <div id="msgMenu" class="msg-menu" role="menu">
    <button data-act="like">üëç –õ–∞–π–∫</button>
    <button data-act="warn">‚ö†Ô∏è –û–±–µ—Ä–µ–∂–Ω–æ (—à–∞—Ö—Ä–∞–π)</button>
    <button data-act="dislike">üëé –î–∏–∑–ª–∞–π–∫</button>
    <button data-act="spam">üö´ –°–ø–∞–º</button>
    <button data-act="reply">‚Ü©Ô∏è –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏</button>
    <button data-act="delete">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ (–∞–≤—Ç–æ—Ä/–∞–¥–º—ñ–Ω)</button>
  </div>

  <div id="bellModal" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <button class="close" id="bellClose">‚úñ</button>
      <h3>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h3>
      <div id="notifList"></div>
    </div>
  </div>

  <div id="adminModal" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <button class="close" id="adminClose">‚úñ</button>
      <h3>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h3>
      <p>–®–≤–∏–¥–∫—ñ—Å—Ç—å –±–æ—Ç—ñ–≤ ‚Äî –º–Ω–æ–∂–Ω–∏–∫ (0.5√ó‚Ä¶3√ó). –°—Ç–∞–Ω –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.</p>
      <div id="adminBots"></div>
    </div>
  </div>

  <div id="adminUsersModal" class="modal full" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <button class="close" data-close id="adminUsersClose">‚úñ</button>
      <div class="admin-users-head">
        <h3 style="margin:0">–£—á–∞—Å–Ω–∏–∫–∏ —Å–∞–π—Ç—É</h3>
        <div class="admin-users-search">
          <input id="userSearch" placeholder="–ü–æ—à—É–∫ –∑–∞ –Ω—ñ–∫–æ–º –∞–±–æ email‚Ä¶" style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px" />
          <div class="pill">–£—Å—å–æ–≥–æ: <b id="usersTotal">0</b></div>
          <div class="pill">–ù–∞ –µ–∫—Ä–∞–Ω—ñ: <b id="usersShown">0</b></div>
        </div>
      </div>
      <div class="admin-users-body">
        <table class="grid-users">
          <thead><tr><th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th><th class="muted">Email</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–µ–º—ñ—É–º</th><th>–î—ñ—ó</th></tr></thead>
          <tbody id="usersTBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- ========== –ö–û–ù–ï–¶ –ß–ê–°–¢–ò 1/4 ==========
       –î–ê–õ–ï–ï –í –ß–ê–°–¢–ò 2/4 –ë–£–î–ï–¢ Firebase + –±–∞–∑–æ–≤—ã–π JS (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, —á–∞—Ç, –¥—Ä—É–∑—å—è, –õ–°) -->
<!-- ========== –ß–ê–°–¢–¨ 2/4 ‚Äî Firebase + –±–∞–∑–æ–≤—ã–π JS (—Ç–∞–±—ã, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –ø—Ä–æ—Ñ–∏–ª—å, —á–∞—Ç, –õ–°, –¥—Ä—É–∑—å—è) ========== -->

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
/* --- –¢–í–û–ô –ö–û–ù–§–ò–ì (praga-4baee) --- */
const firebaseConfig = {
  apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
  authDomain: "praga-4baee.firebaseapp.com",
  databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
  projectId: "praga-4baee",
  storageBucket: "praga-4baee.firebasestorage.app",
  messagingSenderId: "336023952536",
  appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
  measurementId: "G-BGDJD6R12N"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.database();

/* --- DOM —Å—Å—ã–ª–∫–∏ / –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã --- */
const tabButtons = document.querySelectorAll(".tab-button");
const tabContents= document.querySelectorAll(".tab-content");
const messagesEl = document.getElementById("messages");
const rentMessagesEl = document.getElementById("rentMessages");
const messageInput = document.getElementById("messageInput");
const sendButton = document.getElementById("sendButton");
const fileInput = document.getElementById("fileInput");
const profileBtn = document.getElementById("profileBtn");
const profileModal = document.getElementById("profileModal");
const profileClose = document.getElementById("profileClose");
const profileContent = document.getElementById("profileContent");
const adminBar = document.getElementById("adminBar");
const gearBtn = document.getElementById("gearBtn");
const adminModal = document.getElementById("adminModal");
const adminClose = document.getElementById("adminClose");
const adminBots = document.getElementById("adminBots");
const bellBtn = document.getElementById("bellBtn");
const bellBadge = document.getElementById("bellBadge");
const bellModal = document.getElementById("bellModal");
const bellClose = document.getElementById("bellClose");
const notifList = document.getElementById("notifList");
const onlineNeon = document.getElementById("onlineNeon");
const dmList = document.getElementById("dmList");
const friendsList = document.getElementById("friendsList");
const friendRequests = document.getElementById("friendRequests");
const friendsOnlineCountEl = document.getElementById("friendsOnlineCount");

const DEFAULT_AVATAR = "https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg";
const ADMIN_EMAIL = "urciknikolaj642@gmail.com";
let isAdmin=false, currentUser=null; const MSG_LIMIT=300;

/* --- –¢–∞–±—ã --- */
function setActiveTab(id){
  tabButtons.forEach(b=>b.classList.toggle("active",b.dataset.target===id));
  tabContents.forEach(c=>c.style.display=(c.id===id)?"block":"none");
  if (id==="chatTab"||id==="rentTab") messageInput.focus();
  adminBar.style.display = (id==='chatTab' && isAdmin) ? 'block' : 'none';
  if (id==='mapTab' && window.google && window.map) google.maps.event.trigger(window.map,'resize');
}
tabButtons.forEach(btn=>btn.addEventListener('click',()=>setActiveTab(btn.dataset.target)));

/* --- –£—Ç–∏–ª–∏—Ç—ã --- */
function timeStr(ts){ return new Date(ts).toLocaleString(); }
function isNearBottom(area){ return (area.scrollHeight - area.scrollTop - area.clientHeight) < 160; }
function scrollToBottom(area){ area.scrollTop = area.scrollHeight; }
function notify(title,text){
  const row=document.createElement('div'); row.style.padding="6px 8px"; row.style.borderBottom="1px solid #eee";
  row.textContent = `${title}: ${text}`; notifList.prepend(row);
  let n=Number(bellBadge.dataset.n||"0")+1; bellBadge.dataset.n=String(n);
  bellBadge.textContent=n; bellBadge.style.display=n>0?"inline-block":"none";
}
function toast(t){ notify("–Ü–Ω—Ñ–æ", t); }
bellBtn.addEventListener('click',()=>{ bellModal.classList.add('show'); bellBadge.dataset.n="0"; bellBadge.style.display="none"; });
bellClose.addEventListener('click',()=> bellModal.classList.remove('show'));

/* --- Auth UI --- */
const authModal = document.getElementById("authModal");
const modalClose= document.getElementById("modalClose");
const registerForm=document.getElementById("registerForm");
const loginForm=document.getElementById("loginForm");
const loginShow=document.getElementById("loginShow");
const backToRegister=document.getElementById("backToRegister");
const registerSubmit=document.getElementById("registerSubmit");
const loginSubmit=document.getElementById("loginSubmit");
const regError=document.getElementById("regError");
const loginError=document.getElementById("loginError");
const nickInput=document.getElementById("nickInput");
const emailInput=document.getElementById("emailInput");
const passwordInput=document.getElementById("passwordInput");
const loginEmail=document.getElementById("loginEmail");
const loginPassword=document.getElementById("loginPassword");

function showAuth(){ authModal.classList.add('show'); regError.textContent=""; loginError.textContent=""; }
function hideAuth(){ authModal.classList.remove('show'); }
modalClose.addEventListener('click',hideAuth);
loginShow.addEventListener('click',()=>{ registerForm.style.display="none"; loginForm.style.display="block"; });
backToRegister.addEventListener('click',()=>{ registerForm.style.display="block"; loginForm.style.display="none"; });

registerSubmit.addEventListener('click', async ()=>{
  regError.textContent="";
  const nick=nickInput.value.trim();
  const email=emailInput.value.trim();
  const pass=passwordInput.value.trim();
  if(!nick||!email||pass.length<6){ regError.textContent="–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è (–ø–∞—Ä–æ–ª—å ‚â•6)"; return; }
  try{
    const cred=await auth.createUserWithEmailAndPassword(email,pass);
    await cred.user.updateProfile({ displayName:nick, photoURL:DEFAULT_AVATAR });
    await db.ref('users/'+cred.user.uid).set({ nick,email,avatar:DEFAULT_AVATAR,createdAt:Date.now() });
    await db.ref('presence/'+cred.user.uid).set({ ts:Date.now(), nick });
    notify("–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è","–í–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ. 6 –≥–æ–¥–∏–Ω –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email.");
    hideAuth();
  }catch(e){ regError.textContent=e.message||String(e); }
});

loginSubmit.addEventListener('click', async ()=>{
  loginError.textContent="";
  try{
    await auth.signInWithEmailAndPassword(loginEmail.value.trim(), loginPassword.value.trim());
    hideAuth();
  }catch(e){ loginError.textContent=e.message||String(e); }
});

/* --- onAuthStateChanged: —Ä–æ–ª–∏, –∞–≤–∞—Ç–∞—Ä—ã, presence, –ø–æ–¥–ø–∏—Å–∫–∏ --- */
auth.onAuthStateChanged(async (u)=>{
  currentUser=u;
  profileBtn.style.background = `url(${(u&&u.photoURL)||DEFAULT_AVATAR}) center/cover`;
  if (u){ await db.ref('presence/'+u.uid).set({ ts:Date.now(), nick:u.displayName||u.email }); }
  // admin?
  if (u){
    try{
      const roleSnap=await db.ref('users/'+u.uid+'/role').get();
      const role=roleSnap.exists()?roleSnap.val():null;
      isAdmin = (u.email===ADMIN_EMAIL) || role==='admin';
    }catch{ isAdmin=(u.email===ADMIN_EMAIL); }
  } else isAdmin=false;
  gearBtn.style.display = isAdmin?'flex':'none';
  adminBar.style.display = (isAdmin && document.getElementById('chatTab').style.display==='block')?'block':'none';
  subscribeNotifications(u&&u.uid);
  loadDMList();
  refreshFriendsBlocks();
  updateOnlineCount();
});

/* --- –ü—Ä–æ—Ñ–∏–ª—å --- */
profileBtn.addEventListener('click', async ()=>{
  if(!auth.currentUser){ showAuth(); return; }
  openProfile(auth.currentUser.uid,true);
});
profileClose.addEventListener('click',()=> profileModal.classList.remove('show'));

async function openProfile(uid,self=false){
  profileModal.classList.add('show');
  profileContent.innerHTML="<p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</p>";
  try{
    const s=await db.ref('users/'+uid).get();
    const user=s.exists()?s.val():{nick:"–ê–Ω–æ–Ω—ñ–º",avatar:DEFAULT_AVATAR};
    const isSelf=auth.currentUser&&auth.currentUser.uid===uid; const email=user.email||"";
    profileContent.innerHTML=`
      <div style="display:flex;gap:12px;align-items:center">
        <img src="${user.avatar||DEFAULT_AVATAR}" style="width:84px;height:84px;border-radius:12px;object-fit:cover">
        <div><h3 style="margin:0 0 4px">${user.nick||"–ê–Ω–æ–Ω—ñ–º"}</h3><div style="color:${email?'#333':'#666'}">${email}</div></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        ${isSelf?`
          <label class="tab-button" style="cursor:pointer">
            <input type="file" id="avatarFile" accept="image/*" style="display:none">–ó–º—ñ–Ω–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä (—Ñ–∞–π–ª)
          </label>
          <button id="myDMsBtn" class="tab-button">–ú–æ—ó –õ–°</button>
          <a class="tab-button" href="mailto:${ADMIN_EMAIL}?subject=–†–µ–∫–ª–∞–º–∞%20Praha%20Fu≈°ky">–ö—É–ø–∏—Ç–∏ —Ä–µ–∫–ª–∞–º—É</a>
          <button id="signOutBtn" class="tab-button" style="background:#ffe1e1">–í–∏–π—Ç–∏</button>
        `:`
          <button id="pmBtn" class="tab-button">–ù–∞–ø–∏—Å–∞—Ç–∏ –õ–°</button>
          <button id="addFriendBtn" class="tab-button">–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>
          <button id="reportBtn" class="tab-button" style="background:#ffe7c4">–ü–æ—Å–∫–∞—Ä–∂–∏—Ç–∏—Å—å</button>
        `}
      </div>
      <div id="profileMsg" style="margin-top:8px;color:#b91c1c"></div>
    `;
    if(isSelf){
      document.getElementById('avatarFile').addEventListener('change', async (e)=>{
        const file=e.target.files[0]; if(!file) return;
        const url=await fileToDataURL(file,900,.9);
        await db.ref('users/'+uid+'/avatar').set(url);
        await auth.currentUser.updateProfile({photoURL:url});
        profileBtn.style.background=`url(${url}) center/cover`;
        profileContent.querySelector('img').src=url;
        toast('–ê–≤–∞—Ç–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ');
      });
      document.getElementById('myDMsBtn').onclick=()=>{ profileModal.classList.remove('show'); setActiveTab('dmTab'); };
      document.getElementById('signOutBtn').onclick=async()=>{ try{ await db.ref('presence/'+auth.currentUser.uid).remove(); }catch{} await auth.signOut(); profileModal.classList.remove('show'); };
    }else{
      document.getElementById('pmBtn').onclick=()=>{ profileModal.classList.remove('show'); openPrivateChat(uid); };
      document.getElementById('addFriendBtn').onclick=()=> sendFriendRequest(uid);
      document.getElementById('reportBtn').onclick=()=> notify('–°–∫–∞—Ä–≥–∞','–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É');
    }
  }catch{ profileContent.innerHTML="<p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</p>"; }
}

/* --- helper: —Å–∂–∞—Ç–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤ dataURL --- */
function fileToDataURL(file,maxW=900,quality=.85){
  return new Promise((resolve,reject)=>{
    const img=new Image(); const r=new FileReader();
    r.onload=e=>{ img.onload=()=>{ const sc=Math.min(1,maxW/img.width); const w=img.width*sc|0,h=img.height*sc|0;
      const c=document.createElement('canvas'); c.width=w; c.height=h; const x=c.getContext('2d'); x.drawImage(img,0,0,w,h);
      resolve(c.toDataURL('image/jpeg',quality)); }; img.onerror=reject; img.src=e.target.result; };
    r.onerror=reject; r.readAsDataURL(file);
  });
}

/* --- –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è (–ø—ñ–¥–ø–∏—Å–∫–∞) --- */
function subscribeNotifications(uid){
  if(!uid) return;
  db.ref('notifications/'+uid).on('child_added',snap=>{
    const v=snap.val()||{}; notify(v.type||'info', v.text||'');
  });
}

/* --- ONLINE √ó10 --- */
function updateOnlineCount(){
  db.ref('presence').on('value',snap=>{
    const val=snap.val()||{}; const real=Object.keys(val).length;
    onlineNeon.textContent=`–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): ${real*10}`;
  });
  window.addEventListener('beforeunload',async()=>{ try{ if(auth.currentUser) await db.ref('presence/'+auth.currentUser.uid).remove(); }catch{} });
}

/* --- –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è --- */
function renderMessage(m,container){
  if(!m||!m.ts) return;
  const wrap=document.createElement('div');
  wrap.className="message"+((auth.currentUser&&m.uid===auth.currentUser.uid)?" self":"");
  wrap.dataset.uid=m.uid||""; wrap.dataset.msgid=m.id||"";
  const avatar=document.createElement('img'); avatar.className="avatar"; avatar.src=m.avatar||DEFAULT_AVATAR; avatar.alt=m.nick||"avatar"; avatar.title=m.nick||"–ü—Ä–æ—Ñ—ñ–ª—å"; avatar.onclick=()=>openProfile(m.uid);
  const txt=document.createElement('div'); txt.className="message-content";
  const meta=document.createElement('div'); meta.className="message-meta"; meta.textContent=`${m.nick||"–ê–Ω–æ–Ω—ñ–º"} ¬∑ ${timeStr(m.ts)}`+(m.recipientUid?" ¬∑ –æ—Å–æ–±–∏—Å—Ç–µ":""); txt.appendChild(meta);
  if(m.text){ const p=document.createElement('div'); p.className='text'; p.innerText=m.text; txt.appendChild(p); }
  if(m.image){ const im=document.createElement('img'); im.src=m.image; im.className='chat-image'; im.alt='–§–æ—Ç–æ'; txt.appendChild(im); }
  const act=document.createElement('div'); act.className='msg-actions'; act.innerHTML=`<button title="–î—ñ—ó">‚ãØ</button>`;
  act.querySelector('button').onclick=(ev)=>{ const r=ev.target.getBoundingClientRect(); showMsgMenu(r.left,r.bottom+4,m,wrap); };
  txt.appendChild(act);
  const area=container.closest('.chat-area'); const stick=area?isNearBottom(area):false;
  wrap.appendChild(avatar); wrap.appendChild(txt); container.appendChild(wrap); if(area&&stick) scrollToBottom(area);
}

/* --- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ª–µ–Ω—Ç—ã --- */
let initialMainLoaded=false, initialRentLoaded=false;
db.ref('messages').limitToLast(MSG_LIMIT).on('child_added',snap=>{
  const m=snap.val(); m.id=snap.key; renderMessage(m,messagesEl);
  if(!initialMainLoaded){ clearTimeout(window._scrollMainInit); window._scrollMainInit=setTimeout(()=>{scrollToBottom(document.getElementById('chatArea')); initialMainLoaded=true;},80);}
});
db.ref('rentMessages').limitToLast(MSG_LIMIT).on('child_added',snap=>{
  const m=snap.val(); m.id=snap.key; renderMessage(m,rentMessagesEl);
  if(!initialRentLoaded){ clearTimeout(window._scrollRentInit); window._scrollRentInit=setTimeout(()=>{scrollToBottom(document.getElementById('rentArea')); initialRentLoaded=true;},80);}
});
function activeChatPath(){ return document.getElementById('rentTab').style.display==="block" ? "rentMessages" : "messages"; }

/* --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–µ–∫—Å—Ç/—Ñ–æ—Ç–æ) --- */
async function canSend(){ if(!auth.currentUser) return false; return true; } // —É–ø—Ä–æ—Å—Ç–∏–ª–∏, –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –≤–µ—Ä–Ω—ë—à—å 6h/verify
sendButton.addEventListener('click', async ()=>{
  if(!auth.currentUser){ showAuth(); return; }
  if(!await canSend()){ toast('–ü–æ—Ç—Ä—ñ–±–Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email'); return; }
  const text=messageInput.value.trim(); const file=fileInput.files[0];
  if(!text && !file) return;
  let imageData=null;
  if(file){ try{ imageData=await fileToDataURL(file,900,.9); }catch{ notify('–ü–æ–º–∏–ª–∫–∞','–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ'); return; } }
  const msg={ uid:auth.currentUser.uid, nick:auth.currentUser.displayName||auth.currentUser.email||"–ê–Ω–æ–Ω—ñ–º", avatar:auth.currentUser.photoURL||DEFAULT_AVATAR, text:text||null, image:imageData||null, ts:Date.now(), recipientUid:null };
  try{
    await db.ref(activeChatPath()).push(msg);
    messageInput.value=""; fileInput.value="";
    notify('OK','–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ');
  }catch{ notify('–ü–æ–º–∏–ª–∫–∞','–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏'); }
});
messageInput.addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendButton.click(); } });
document.querySelector('.camera-btn').addEventListener('click',e=>{ if(!auth.currentUser){ e.preventDefault(); showAuth(); } });

/* --- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏—è (–ª–∞–π–∫/—Å–ø–∞–º/—É–¥–∞–ª–∏—Ç—å/–æ—Ç–≤–µ—Ç) --- */
const msgMenu=document.getElementById('msgMenu');
function showMsgMenu(x,y,msg,wrap){
  msgMenu.style.left=x+"px"; msgMenu.style.top=y+"px"; msgMenu.style.display="block";
  const hide=()=>{ msgMenu.style.display="none"; document.removeEventListener('click',hide); };
  document.addEventListener('click',hide,{once:true});
  msgMenu.querySelectorAll('button').forEach(btn=>{
    btn.onclick=async()=>{ const act=btn.dataset.act;
      try{
        if(act==='reply'){
          const r=prompt('–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:'); if(r){ await db.ref('messages').push({ uid:auth.currentUser.uid, nick:auth.currentUser.displayName||auth.currentUser.email, avatar:auth.currentUser.photoURL||DEFAULT_AVATAR, text:"‚Ü©Ô∏è "+r, ts:Date.now(), recipientUid:msg.uid }); }
        }else if(act==='delete'){
          if(auth.currentUser.uid===msg.uid || isAdmin){ await db.ref(activeChatPath()+'/'+(msg.id||'')).remove(); wrap.remove(); notify('OK','–í–∏–¥–∞–ª–µ–Ω–æ'); }
          else notify('–í—ñ–¥–º–æ–≤–∞','–õ–∏—à–µ –∞–≤—Ç–æ—Ä –∞–±–æ –∞–¥–º—ñ–Ω');
        }else{
          if(msg.id){
            await db.ref('messageReactions/'+msg.id+'/'+auth.currentUser.uid).set({ act, ts:Date.now() });
            await db.ref('notifications/'+msg.uid).push({ts:Date.now(),type:'reaction',text:`${act} –Ω–∞ –≤–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è`,from:auth.currentUser.uid});
            notify('OK','–î—ñ—è –≤–∏–∫–æ–Ω–∞–Ω–∞');
          }
        }
      }catch{ notify('–ü–æ–º–∏–ª–∫–∞ –¥—ñ—ó','–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑'); }
    };
  });
}

/* --- –î–†–£–ó–Ü --- */
async function sendFriendRequest(toUid){
  if(!auth.currentUser){ showAuth(); return; } const from=auth.currentUser.uid; if(from===toUid) return;
  await db.ref('friendRequests/'+toUid+'/'+from).set({ from, ts:Date.now() });
  await db.ref('friends/'+from+'/'+toUid).set({ status:'requested', ts:Date.now(), fromUid:from });
  await db.ref('notifications/'+toUid).push({ ts:Date.now(), type:'friend', text:`–ó–∞–ø–∏—Ç —É –¥—Ä—É–∑—ñ –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`, from });
  notify('OK','–ó–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ');
}
function friendCard(u,online){
  const d=document.createElement('div'); d.className='friend-card';
  d.innerHTML=`<img src="${u.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
    <div style="flex:1"><div style="font-weight:800">${u.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</div><div style="font-size:12px;color:${online?'#10b981':'#64748b'}">${online?'–æ–Ω–ª–∞–π–Ω':'–æ—Ñ–ª–∞–π–Ω'}</div></div>
    <div style="display:flex;gap:6px"><button class="tab-button btn-pm">‚úâÔ∏è</button><button class="tab-button btn-open">üëÄ</button></div>`;
  return d;
}
async function refreshFriendsBlocks(){
  const u=auth.currentUser; if(!u){ friendsList.innerHTML=""; friendRequests.innerHTML=""; friendsOnlineCountEl.textContent="0"; return; }
  // –∑–∞—è–≤–∫–∏ –º–µ–Ω—ñ
  const reqSnap=await db.ref('friendRequests/'+u.uid).get(); friendRequests.innerHTML="";
  if(reqSnap.exists()){
    const reqs=reqSnap.val(); for(const fromUid of Object.keys(reqs)){
      const uSnap=await db.ref('users/'+fromUid).get(); const ud=uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
      const item=document.createElement('div'); item.className='friend-card';
      item.innerHTML=`<img src="${ud.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
      <div style="flex:1"><div style="font-weight:800">${ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</div><div class="muted" style="font-size:12px">–∑–∞—è–≤–∫–∞ —É –¥—Ä—É–∑—ñ</div></div>
      <div style="display:flex;gap:6px"><button class="tab-button btn-accept">‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏</button><button class="tab-button btn-decline" style="background:#ffe1e1">‚úñ</button></div>`;
      item.querySelector('.btn-accept').onclick=async()=>{
        await db.ref('friends/'+u.uid+'/'+fromUid).set({ status:'accepted', ts:Date.now() });
        await db.ref('friends/'+fromUid+'/'+u.uid).set({ status:'accepted', ts:Date.now() });
        await db.ref('friendRequests/'+u.uid+'/'+fromUid).remove();
        await db.ref('notifications/'+fromUid).push({ ts:Date.now(), type:'friend', text:`${u.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'} –¥–æ–¥–∞–≤(–ª–∞) –≤–∞—Å —É –¥—Ä—É–∑—ñ`, from:u.uid });
        refreshFriendsBlocks();
      };
      item.querySelector('.btn-decline').onclick=async()=>{ await db.ref('friendRequests/'+u.uid+'/'+fromUid).remove(); await db.ref('friends/'+fromUid+'/'+u.uid).remove(); refreshFriendsBlocks(); };
      friendRequests.appendChild(item);
    }
  }else friendRequests.innerHTML="<i>–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</i>";

  // –º–æ—ó –¥—Ä—É–∑—ñ
  friendsList.innerHTML=""; const frSnap=await db.ref('friends/'+u.uid).get(); let onlineCount=0;
  if(frSnap.exists()){
    const fr=frSnap.val(); for(const fid of Object.keys(fr)){ const rel=fr[fid]; if(rel.status!=='accepted') continue;
      const uSnap=await db.ref('users/'+fid).get(); const ud=uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
      const pSnap=await db.ref('presence/'+fid).get(); const isOn=pSnap.exists(); if(isOn) onlineCount++;
      const card=friendCard(ud,isOn); card.querySelector('.btn-open').onclick=()=>openProfile(fid); card.querySelector('.btn-pm').onclick=()=>openPrivateChat(fid); friendsList.appendChild(card);
    }
  } else friendsList.innerHTML="<i>–î–æ–¥–∞–π—Ç–µ –¥—Ä—É–∑—ñ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ—ñ–ª—ñ</i>";
  friendsOnlineCountEl.textContent=String(onlineCount);
}

/* --- –õ–° --- */
function convoIdFor(a,b){ return a<b? a+"_"+b : b+"_"+a; }
async function openPrivateChat(otherUid){
  if(!auth.currentUser){ showAuth(); return; }
  const uid=auth.currentUser.uid; const cid=convoIdFor(uid,otherUid);
  const panel=document.createElement('div'); panel.className='modal show'; panel.style.zIndex=98;
  panel.innerHTML=`<div class="panel"><button class="close">‚úñ</button><h3>–î—ñ–∞–ª–æ–≥</h3>
  <div id="dmThread" style="max-height:55vh;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px;margin-bottom:8px;background:#fafafa"></div>
  <div style="display:flex;gap:6px"><input id="dmText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd"><button id="dmSend" class="tab-button">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button></div></div>`;
  document.body.appendChild(panel);
  panel.querySelector('.close').onclick=()=>panel.remove();
  const thread=panel.querySelector('#dmThread');
  db.ref('privateMessages/'+cid).limitToLast(200).on('child_added',snap=>{
    const m=snap.val(); const row=document.createElement('div'); row.style.margin="6px 0"; row.style.textAlign=m.from===uid?"right":"left";
    row.textContent=`${m.text} (${new Date(m.ts).toLocaleTimeString()})`; thread.appendChild(row); thread.scrollTop=thread.scrollHeight;
  });
  panel.querySelector('#dmSend').onclick=async()=>{
    const t=panel.querySelector('#dmText').value.trim(); if(!t) return;
    const pm={from:uid,to:otherUid,text:t,ts:Date.now()};
    await db.ref('privateMessages/'+cid).push(pm);
    await db.ref('notifications/'+otherUid).push({ ts:Date.now(), type:'dm', text:`–ù–æ–≤–µ –õ–° –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`, from:uid });
    panel.querySelector('#dmText').value="";
  };
}
async function loadDMList(){
  const u=auth.currentUser; if(!u){ dmList.innerHTML="<i>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –±–∞—á–∏—Ç–∏ –õ–°</i>"; return; }
  dmList.innerHTML=`<p>–í—ñ–¥–∫—Ä–∏–≤–∞–π—Ç–µ –õ–° —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ—ñ–ª—ñ –∞–±–æ –ø–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è—Ö üîî.</p>`;
}

/* --- –®–µ—Å—Ç–µ—Ä—ë–Ω–∫–∞ --- */
gearBtn.addEventListener('click',()=>{ if(isAdmin){ adminModal.classList.add('show'); }});
adminClose.addEventListener('click',()=> adminModal.classList.remove('show'));
</script>
<!-- ========== –ö–û–ù–ï–¶ –ß–ê–°–¢–ò 2/4 ==========
     –î–ê–õ–ï–ï –ß–ê–°–¢–¨ 3/4 ‚Äî –ê–¥–º–∏–Ω (–±–æ—Ç—ã, –≤—ã–¥–∞—á–∞ –¥–æ–Ω–∞—Ç–æ–≤/–±–∞–Ω), —Ç–∞–±–ª–∏—Ü–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∫–∞—Ä—Ç–∞ Google ==========
-->
<!-- ========== –ß–ê–°–¢–¨ 3/4 ‚Äî Firebase + –ª–æ–≥–∏–∫–∞ —á–∞—Ç–∞/–õ–°/–¥—Ä—É–∑–µ–π/—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ========== -->
<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
  /* ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE (—Ç–≤–æ–∏ –∫–ª—é—á–∏ praga-4baee) ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
    authDomain: "praga-4baee.firebaseapp.com",
    databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
    projectId: "praga-4baee",
    storageBucket: "praga-4baee.firebasestorage.app",
    messagingSenderId: "336023952536",
    appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
    measurementId: "G-BGDJD6R12N"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.database();

  /* ===== DOM ===== */
  const tabButtons = document.querySelectorAll(".tab-button");
  const tabContents= document.querySelectorAll(".tab-content");
  const messagesEl = document.getElementById("messages");
  const rentMessagesEl = document.getElementById("rentMessages");
  const messageInput = document.getElementById("messageInput");
  const sendButton = document.getElementById("sendButton");
  const fileInput = document.getElementById("fileInput");
  const profileBtn = document.getElementById("profileBtn");
  const profileModal = document.getElementById("profileModal");
  const profileClose = document.getElementById("profileClose");
  const profileContent = document.getElementById("profileContent");
  const adminBar = document.getElementById("adminBar");
  const gearBtn = document.getElementById("gearBtn");
  const adminModal = document.getElementById("adminModal");
  const adminClose = document.getElementById("adminClose");
  const adminBots = document.getElementById("adminBots");
  const bellBtn = document.getElementById("bellBtn");
  const bellBadge = document.getElementById("bellBadge");
  const bellModal = document.getElementById("bellModal");
  const bellClose = document.getElementById("bellClose");
  const notifList = document.getElementById("notifList");
  const onlineNeon = document.getElementById("onlineNeon");
  const dmList = document.getElementById("dmList");
  const friendsList = document.getElementById("friendsList");
  const friendRequests = document.getElementById("friendRequests");
  const friendsOnlineCountEl = document.getElementById("friendsOnlineCount");
  const msgMenu = document.getElementById("msgMenu");

  /* ===== –ö–û–ù–°–¢–ê–ù–¢–´ ===== */
  const DEFAULT_AVATAR = "https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg";
  const ADMIN_EMAIL = "urciknikolaj642@gmail.com";
  let isAdmin=false, currentUser=null;
  const MSG_LIMIT = 300;

  /* ===== –í–ö–õ–ê–î–ö–ò ===== */
  function setActiveTab(id){
    tabButtons.forEach(b => b.classList.toggle("active", b.dataset.target===id));
    tabContents.forEach(c => c.style.display = (c.id===id) ? "block" : "none");
    if (id==="chatTab"||id==="rentTab") messageInput?.focus();
    adminBar.style.display = (id==='chatTab' && isAdmin) ? 'block' : 'none';
    if (id==='mapTab' && window.google && window.map) google.maps.event.trigger(window.map,'resize');
  }
  tabButtons.forEach(btn => btn.addEventListener('click',()=> setActiveTab(btn.dataset.target)));

  /* ===== –£–¢–ò–õ–ò–¢–´ ===== */
  function timeStr(ts){ return new Date(ts).toLocaleString(); }
  function isNearBottom(area){ return (area.scrollHeight - area.scrollTop - area.clientHeight) < 160; }
  function scrollToBottom(area){ area.scrollTop = area.scrollHeight; }
  function notify(title, text){
    const row=document.createElement('div');
    row.style.padding="6px 8px"; row.style.borderBottom="1px solid #eee";
    row.textContent = `${title}: ${text}`;
    notifList.prepend(row);
    let n = Number(bellBadge.dataset.n||"0")+1;
    bellBadge.dataset.n = String(n);
    bellBadge.textContent = n;
    bellBadge.style.display = n>0 ? "inline-block" : "none";
  }
  function toast(t){ notify("–Ü–Ω—Ñ–æ", t); }

  bellBtn.addEventListener('click',()=>{
    bellModal.classList.add('show');
    bellBadge.dataset.n="0";
    bellBadge.style.display="none";
  });
  bellClose.addEventListener('click',()=> bellModal.classList.remove('show'));

  /* ===== AUTH UI ===== */
  const authModal = document.getElementById("authModal");
  const modalClose= document.getElementById("modalClose");
  const registerForm=document.getElementById("registerForm");
  const loginForm=document.getElementById("loginForm");
  const loginShow=document.getElementById("loginShow");
  const backToRegister=document.getElementById("backToRegister");
  const registerSubmit=document.getElementById("registerSubmit");
  const loginSubmit=document.getElementById("loginSubmit");
  const regError=document.getElementById("regError");
  const loginError=document.getElementById("loginError");
  const nickInput=document.getElementById("nickInput");
  const emailInput=document.getElementById("emailInput");
  const passwordInput=document.getElementById("passwordInput");
  const loginEmail=document.getElementById("loginEmail");
  const loginPassword=document.getElementById("loginPassword");

  function showAuth(){ authModal.classList.add('show'); regError.textContent=""; loginError.textContent=""; }
  function hideAuth(){ authModal.classList.remove('show'); }
  modalClose.addEventListener('click',hideAuth);
  loginShow.addEventListener('click',()=>{ registerForm.style.display="none"; loginForm.style.display="block"; });
  backToRegister.addEventListener('click',()=>{ registerForm.style.display="block"; loginForm.style.display="none"; });

  registerSubmit.addEventListener('click', async ()=>{
    regError.textContent="";
    const nick=nickInput.value.trim();
    const email=emailInput.value.trim();
    const pass=passwordInput.value.trim();
    if(!nick||!email||pass.length<6){ regError.textContent="–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è (–ø–∞—Ä–æ–ª—å ‚â•6)"; return; }
    try{
      const cred=await auth.createUserWithEmailAndPassword(email,pass);
      await cred.user.updateProfile({ displayName:nick, photoURL:DEFAULT_AVATAR });
      await db.ref('users/'+cred.user.uid).set({ nick,email,avatar:DEFAULT_AVATAR,createdAt:Date.now() });
      await db.ref('presence/'+cred.user.uid).set({ ts:Date.now(), nick });
      notify("–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è","–í–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ. 6 –≥–æ–¥–∏–Ω –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email.");
      hideAuth();
    }catch(e){ regError.textContent=e.message||String(e); }
  });

  loginSubmit.addEventListener('click', async ()=>{
    loginError.textContent="";
    try{
      await auth.signInWithEmailAndPassword(loginEmail.value.trim(), loginPassword.value.trim());
      hideAuth();
    }catch(e){ loginError.textContent=e.message||String(e); }
  });

  auth.onAuthStateChanged(async (u)=>{
    currentUser=u;
    profileBtn.style.background = `url(${(u&&u.photoURL)||DEFAULT_AVATAR}) center/cover`;
    if (u){ await db.ref('presence/'+u.uid).set({ ts:Date.now(), nick:u.displayName||u.email }); }

    // –∞–¥–º–∏–Ω?
    if (u){
      try{
        const roleSnap=await db.ref('users/'+u.uid+'/role').get();
        const role=roleSnap.exists()?roleSnap.val():null;
        isAdmin = (u.email===ADMIN_EMAIL) || role==='admin';
      }catch{ isAdmin=(u.email===ADMIN_EMAIL); }
    } else isAdmin=false;

    gearBtn.style.display = isAdmin?'flex':'none';
    adminBar.style.display = (isAdmin && document.getElementById('chatTab').style.display==='block')?'block':'none';

    subscribeNotifications(u&&u.uid);
    loadDMList();
    refreshFriendsBlocks();
    updateOnlineCount();
  });

  /* ===== –ü–†–û–§–ò–õ–¨ ===== */
  profileBtn.addEventListener('click', async ()=>{
    if(!auth.currentUser){ showAuth(); return; }
    openProfile(auth.currentUser.uid,true);
  });
  profileClose.addEventListener('click',()=> profileModal.classList.remove('show'));

  async function openProfile(uid,self=false){
    profileModal.classList.add('show');
    profileContent.innerHTML="<p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</p>";
    try{
      const s=await db.ref('users/'+uid).get();
      const user=s.exists()?s.val():{nick:"–ê–Ω–æ–Ω—ñ–º",avatar:DEFAULT_AVATAR};
      const isSelf=auth.currentUser&&auth.currentUser.uid===uid;
      const email=user.email||"";
      profileContent.innerHTML=`
        <div style="display:flex;gap:12px;align-items:center">
          <img src="${user.avatar||DEFAULT_AVATAR}" style="width:84px;height:84px;border-radius:12px;object-fit:cover">
          <div><h3 style="margin:0 0 4px">${user.nick||"–ê–Ω–æ–Ω—ñ–º"}</h3><div style="color:${email?'#333':'#666'}">${email}</div></div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          ${isSelf?`
            <label class="tab-button" style="cursor:pointer">
              <input type="file" id="avatarFile" accept="image/*" style="display:none">–ó–º—ñ–Ω–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä (—Ñ–∞–π–ª)
            </label>
            <button id="myDMsBtn" class="tab-button">–ú–æ—ó –õ–°</button>
            <a class="tab-button" href="mailto:${ADMIN_EMAIL}?subject=–†–µ–∫–ª–∞–º–∞%20Praha%20Fu≈°ky">–ö—É–ø–∏—Ç–∏ —Ä–µ–∫–ª–∞–º—É</a>
            <button id="signOutBtn" class="tab-button" style="background:#ffe1e1">–í–∏–π—Ç–∏</button>
          `:`
            <button id="pmBtn" class="tab-button">–ù–∞–ø–∏—Å–∞—Ç–∏ –õ–°</button>
            <button id="addFriendBtn" class="tab-button">–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>
            <button id="reportBtn" class="tab-button" style="background:#ffe7c4">–ü–æ—Å–∫–∞—Ä–∂–∏—Ç–∏—Å—å</button>
          `}
        </div>
        <div id="profileMsg" style="margin-top:8px;color:#b91c1c"></div>
      `;
      if(isSelf){
        document.getElementById('avatarFile').addEventListener('change', async (e)=>{
          const file=e.target.files[0]; if(!file) return;
          const url=await fileToDataURL(file,900,.9);
          await db.ref('users/'+uid+'/avatar').set(url);
          await auth.currentUser.updateProfile({photoURL:url});
          profileBtn.style.background=`url(${url}) center/cover`;
          profileContent.querySelector('img').src=url;
          toast('–ê–≤–∞—Ç–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ');
        });
        document.getElementById('myDMsBtn').onclick=()=>{ profileModal.classList.remove('show'); setActiveTab('dmTab'); };
        document.getElementById('signOutBtn').onclick=async()=>{
          try{ await db.ref('presence/'+auth.currentUser.uid).remove(); }catch{}
          await auth.signOut(); profileModal.classList.remove('show');
        };
      }else{
        document.getElementById('pmBtn').onclick=()=>{ profileModal.classList.remove('show'); openPrivateChat(uid); };
        document.getElementById('addFriendBtn').onclick=()=> sendFriendRequest(uid);
        document.getElementById('reportBtn').onclick=()=> notify('–°–∫–∞—Ä–≥–∞','–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É');
      }
    }catch{
      profileContent.innerHTML="<p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</p>";
    }
  }

  /* ===== –•–ï–õ–ü–ï–† –ö–ê–†–¢–ò–ù–û–ö (–≤ dataURL) ===== */
  function fileToDataURL(file,maxW=900,quality=.85){
    return new Promise((resolve,reject)=>{
      const img=new Image(); const r=new FileReader();
      r.onload=e=>{ img.onload=()=>{ const sc=Math.min(1,maxW/img.width); const w=img.width*sc|0,h=img.height*sc|0;
        const c=document.createElement('canvas'); c.width=w; c.height=h;
        c.getContext('2d').drawImage(img,0,0,w,h);
        resolve(c.toDataURL('image/jpeg',quality));
      }; img.onerror=reject; img.src=e.target.result; };
      r.onerror=reject; r.readAsDataURL(file);
    });
  }

  /* ===== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===== */
  function subscribeNotifications(uid){
    if(!uid) return;
    db.ref('notifications/'+uid).on('child_added',snap=>{
      const v=snap.val()||{};
      notify(v.type||'info', v.text||'');
    });
  }

  /* ===== ONLINE √ó10 ===== */
  function updateOnlineCount(){
    db.ref('presence').on('value',snap=>{
      const val=snap.val()||{};
      const real=Object.keys(val).length;
      onlineNeon.textContent = `–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): ${real*10}`;
    });
    window.addEventListener('beforeunload',async()=>{
      try{ if(auth.currentUser) await db.ref('presence/'+auth.currentUser.uid).remove(); }catch{}
    });
  }

  /* ===== –†–ï–ù–î–ï–† –°–û–û–ë–©–ï–ù–ò–Ø ===== */
  function renderMessage(m,container){
    if(!m||!m.ts) return;
    const wrap=document.createElement('div');
    wrap.className="message"+((auth.currentUser&&m.uid===auth.currentUser.uid)?" self":"");
    wrap.dataset.uid=m.uid||""; wrap.dataset.msgid=m.id||"";

    const avatar=document.createElement('img');
    avatar.className="avatar";
    avatar.src=m.avatar||DEFAULT_AVATAR;
    avatar.alt=m.nick||"avatar";
    avatar.title=m.nick||"–ü—Ä–æ—Ñ—ñ–ª—å";
    avatar.onclick=()=>openProfile(m.uid);

    const txt=document.createElement('div'); txt.className="message-content";
    const meta=document.createElement('div'); meta.className="message-meta";
    meta.textContent=`${m.nick||"–ê–Ω–æ–Ω—ñ–º"} ¬∑ ${timeStr(m.ts)}`+(m.recipientUid?" ¬∑ –æ—Å–æ–±–∏—Å—Ç–µ":"");
    txt.appendChild(meta);

    if(m.text){ const p=document.createElement('div'); p.className='text'; p.innerText=m.text; txt.appendChild(p); }
    if(m.image){ const im=document.createElement('img'); im.src=m.image; im.className='chat-image'; im.alt='–§–æ—Ç–æ'; txt.appendChild(im); }

    const act=document.createElement('div'); act.className='msg-actions';
    act.innerHTML=`<button title="–î—ñ—ó">‚ãØ</button>`;
    act.querySelector('button').onclick=(ev)=>{
      const r=ev.target.getBoundingClientRect();
      showMsgMenu(r.left, r.bottom+4, m, wrap);
    };
    txt.appendChild(act);

    const area=container.closest('.chat-area'); const stick=area?isNearBottom(area):false;
    wrap.appendChild(avatar); wrap.appendChild(txt); container.appendChild(wrap);
    if(area&&stick) scrollToBottom(area);
  }

  /* ===== –ü–û–î–ü–ò–°–ö–ò –ß–ê–¢–ê ===== */
  let initialMainLoaded=false, initialRentLoaded=false;

  db.ref('messages').limitToLast(MSG_LIMIT).on('child_added',snap=>{
    const m=snap.val(); m.id=snap.key;
    renderMessage(m, messagesEl);
    if(!initialMainLoaded){
      clearTimeout(window._scrollMainInit);
      window._scrollMainInit=setTimeout(()=>{
        scrollToBottom(document.getElementById('chatArea'));
        initialMainLoaded=true;
      },80);
    }
  });

  db.ref('rentMessages').limitToLast(MSG_LIMIT).on('child_added',snap=>{
    const m=snap.val(); m.id=snap.key;
    renderMessage(m, rentMessagesEl);
    if(!initialRentLoaded){
      clearTimeout(window._scrollRentInit);
      window._scrollRentInit=setTimeout(()=>{
        scrollToBottom(document.getElementById('rentArea'));
        initialRentLoaded=true;
      },80);
    }
  });

  function activeChatPath(){
    return document.getElementById('rentTab').style.display==="block" ? "rentMessages" : "messages";
  }

  /* ===== –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø ===== */
  async function canSend(){ if(!auth.currentUser) return false; return true; }

  sendButton.addEventListener('click', async ()=>{
    if(!auth.currentUser){ showAuth(); return; }
    if(!await canSend()){ toast('–ü–æ—Ç—Ä—ñ–±–Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email'); return; }
    const text=messageInput.value.trim();
    const file=fileInput.files[0];
    if(!text && !file) return;

    let imageData=null;
    if(file){
      try{ imageData=await fileToDataURL(file,900,.9); }
      catch{ notify('–ü–æ–º–∏–ª–∫–∞','–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ'); return; }
    }

    const msg={
      uid:auth.currentUser.uid,
      nick:auth.currentUser.displayName||auth.currentUser.email||"–ê–Ω–æ–Ω—ñ–º",
      avatar:auth.currentUser.photoURL||DEFAULT_AVATAR,
      text:text||null,
      image:imageData||null,
      ts:Date.now(),
      recipientUid:null
    };

    try{
      await db.ref(activeChatPath()).push(msg);
      messageInput.value=""; fileInput.value="";
      toast('–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ');
    }catch{
      notify('–ü–æ–º–∏–ª–∫–∞','–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏');
    }
  });

  messageInput.addEventListener('keydown',(e)=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendButton.click(); }
  });

  document.querySelector('.camera-btn').addEventListener('click',(e)=>{
    if(!auth.currentUser){ e.preventDefault(); showAuth(); }
  });

  /* ===== –ú–ï–ù–Æ –°–û–û–ë–©–ï–ù–ò–Ø (–ª–∞–π–∫/—Å–ø–∞–º/—É–¥–∞–ª–∏—Ç—å/–æ—Ç–≤–µ—Ç) ===== */
  function showMsgMenu(x,y,msg,wrap){
    msgMenu.style.left = x+"px";
    msgMenu.style.top  = y+"px";
    msgMenu.style.display="block";
    const hide=()=>{ msgMenu.style.display="none"; document.removeEventListener('click',hide); };
    document.addEventListener('click',hide,{once:true});

    msgMenu.querySelectorAll('button').forEach(btn=>{
      btn.onclick=async()=>{
        const act=btn.dataset.act;
        try{
          if(act==='reply'){
            const r=prompt('–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:');
            if(r){
              await db.ref('messages').push({
                uid:auth.currentUser.uid,
                nick:auth.currentUser.displayName||auth.currentUser.email,
                avatar:auth.currentUser.photoURL||DEFAULT_AVATAR,
                text:"‚Ü©Ô∏è "+r,
                ts:Date.now(),
                recipientUid:msg.uid
              });
            }
          }else if(act==='delete'){
            if(auth.currentUser.uid===msg.uid || isAdmin){
              await db.ref(activeChatPath()+'/'+(msg.id||'')).remove();
              wrap.remove(); toast('–í–∏–¥–∞–ª–µ–Ω–æ');
            }else notify('–í—ñ–¥–º–æ–≤–∞','–õ–∏—à–µ –∞–≤—Ç–æ—Ä –∞–±–æ –∞–¥–º—ñ–Ω');
          }else{
            if(msg.id){
              await db.ref('messageReactions/'+msg.id+'/'+auth.currentUser.uid).set({ act, ts:Date.now() });
              await db.ref('notifications/'+msg.uid).push({ ts:Date.now(), type:'reaction', text:`${act} –Ω–∞ –≤–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è`, from:auth.currentUser.uid });
              toast('–î—ñ—è –≤–∏–∫–æ–Ω–∞–Ω–∞');
            }
          }
        }catch{ notify('–ü–æ–º–∏–ª–∫–∞ –¥—ñ—ó','–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑'); }
      };
    });
  }

  /* ===== –î–†–£–ó–¨–Ø (–∑–∞—è–≤–∫–∏/—Å–ø–∏—Å–æ–∫/–æ–Ω–ª–∞–π–Ω) ===== */
  async function sendFriendRequest(toUid){
    if(!auth.currentUser){ showAuth(); return; }
    const from=auth.currentUser.uid; if(from===toUid) return;
    await db.ref('friendRequests/'+toUid+'/'+from).set({ from, ts:Date.now() });
    await db.ref('friends/'+from+'/'+toUid).set({ status:'requested', ts:Date.now(), fromUid:from });
    await db.ref('notifications/'+toUid).push({ ts:Date.now(), type:'friend', text:`–ó–∞–ø–∏—Ç —É –¥—Ä—É–∑—ñ –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`, from });
    toast('–ó–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ');
  }

  function friendCard(u,online){
    const d=document.createElement('div'); d.className='friend-card';
    d.innerHTML=`<img src="${u.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
      <div style="flex:1"><div style="font-weight:800">${u.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</div>
      <div style="font-size:12px;color:${online?'#10b981':'#64748b'}">${online?'–æ–Ω–ª–∞–π–Ω':'–æ—Ñ–ª–∞–π–Ω'}</div></div>
      <div style="display:flex;gap:6px"><button class="tab-button btn-pm">‚úâÔ∏è</button><button class="tab-button btn-open">üëÄ</button></div>`;
    return d;
  }

  async function refreshFriendsBlocks(){
    const u=auth.currentUser;
    if(!u){ friendsList.innerHTML=""; friendRequests.innerHTML=""; friendsOnlineCountEl.textContent="0"; return; }

    // –∑–∞—è–≤–∫–∏ –º–Ω–µ
    const reqSnap=await db.ref('friendRequests/'+u.uid).get();
    friendRequests.innerHTML="";
    if(reqSnap.exists()){
      const reqs=reqSnap.val();
      for(const fromUid of Object.keys(reqs)){
        const uSnap=await db.ref('users/'+fromUid).get();
        const ud=uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
        const item=document.createElement('div'); item.className='friend-card';
        item.innerHTML=`<img src="${ud.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
          <div style="flex:1"><div style="font-weight:800">${ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</div>
          <div class="muted" style="font-size:12px">–∑–∞—è–≤–∫–∞ —É –¥—Ä—É–∑—ñ</div></div>
          <div style="display:flex;gap:6px">
            <button class="tab-button btn-accept">‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏</button>
            <button class="tab-button btn-decline" style="background:#ffe1e1">‚úñ</button>
          </div>`;
        item.querySelector('.btn-accept').onclick=async()=>{
          await db.ref('friends/'+u.uid+'/'+fromUid).set({ status:'accepted', ts:Date.now() });
          await db.ref('friends/'+fromUid+'/'+u.uid).set({ status:'accepted', ts:Date.now() });
          await db.ref('friendRequests/'+u.uid+'/'+fromUid).remove();
          await db.ref('notifications/'+fromUid).push({ ts:Date.now(), type:'friend', text:`${u.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'} –¥–æ–¥–∞–≤(–ª–∞) –≤–∞—Å —É –¥—Ä—É–∑—ñ`, from:u.uid });
          refreshFriendsBlocks();
        };
        item.querySelector('.btn-decline').onclick=async()=>{
          await db.ref('friendRequests/'+u.uid+'/'+fromUid).remove();
          await db.ref('friends/'+fromUid+'/'+u.uid).remove();
          refreshFriendsBlocks();
        };
        friendRequests.appendChild(item);
      }
    }else friendRequests.innerHTML="<i>–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</i>";

    // –º–æ–∏ –¥—Ä—É–∑—å—è
    friendsList.innerHTML="";
    const frSnap=await db.ref('friends/'+u.uid).get();
    let onlineCount=0;
    if(frSnap.exists()){
      const fr=frSnap.val();
      for(const fid of Object.keys(fr)){
        const rel=fr[fid]; if(rel.status!=='accepted') continue;
        const uSnap=await db.ref('users/'+fid).get();
        const ud=uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
        const pSnap=await db.ref('presence/'+fid).get();
        const isOn=pSnap.exists(); if(isOn) onlineCount++;
        const card=friendCard(ud,isOn);
        card.querySelector('.btn-open').onclick=()=>openProfile(fid);
        card.querySelector('.btn-pm').onclick=()=>openPrivateChat(fid);
        friendsList.appendChild(card);
      }
    }else{
      friendsList.innerHTML="<i>–î–æ–¥–∞–π—Ç–µ –¥—Ä—É–∑—ñ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ—ñ–ª—ñ</i>";
    }
    friendsOnlineCountEl.textContent=String(onlineCount);
  }

  /* ===== –õ–ò–ß–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø ===== */
  function convoIdFor(a,b){ return a<b? a+"_"+b : b+"_"+a; }

  async function openPrivateChat(otherUid){
    if(!auth.currentUser){ showAuth(); return; }
    const uid=auth.currentUser.uid;
    const cid=convoIdFor(uid,otherUid);

    const panel=document.createElement('div');
    panel.className='modal show'; panel.style.zIndex=98;
    panel.innerHTML=`
      <div class="panel">
        <button class="close">‚úñ</button>
        <h3>–î—ñ–∞–ª–æ–≥</h3>
        <div id="dmThread" style="max-height:55vh;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px;margin-bottom:8px;background:#fafafa"></div>
        <div style="display:flex;gap:6px">
          <input id="dmText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd">
          <button id="dmSend" class="tab-button">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
        </div>
      </div>`;
    document.body.appendChild(panel);
    panel.querySelector('.close').onclick=()=>panel.remove();

    const thread=panel.querySelector('#dmThread');
    db.ref('privateMessages/'+cid).limitToLast(200).on('child_added',snap=>{
      const m=snap.val();
      const row=document.createElement('div');
      row.style.margin="6px 0";
      row.style.textAlign=m.from===uid?"right":"left";

      // –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –Ω–∏–∫/–∞–≤–∞—Ç–∞—Ä —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
      const who = (m.from===uid) ? (auth.currentUser.displayName||'–Ø') : '...';
      row.textContent=`${m.text} (${new Date(m.ts).toLocaleTimeString()})`;
      thread.appendChild(row);
      thread.scrollTop=thread.scrollHeight;
    });

    panel.querySelector('#dmSend').onclick=async()=>{
      const t=panel.querySelector('#dmText').value.trim();
      if(!t) return;
      const pm={ from:uid, to:otherUid, text:t, ts:Date.now() };
      await db.ref('privateMessages/'+cid).push(pm);
      await db.ref('notifications/'+otherUid).push({
        ts:Date.now(), type:"dm",
        text:`–ù–æ–≤–µ –õ–° –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`,
        from: uid
      });
      panel.querySelector('#dmText').value="";
    };
  }

  async function loadDMList(){
    const u=auth.currentUser;
    if(!u){ dmList.innerHTML="<i>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –±–∞—á–∏—Ç–∏ –õ–°</i>"; return; }
    // –ø—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫: ¬´–≤—ñ–¥–∫—Ä–∏–≤–∞–π—Ç–µ –õ–° —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ—ñ–ª—ñ –∞–±–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è¬ª
    dmList.innerHTML=`<p>–í—ñ–¥–∫—Ä–∏–≤–∞–π—Ç–µ –õ–° —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ—ñ–ª—ñ –∞–±–æ –ø–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è—Ö üîî.</p>`;
  }

  /* ===== –®–ï–°–¢–ï–†–Å–ù–ö–ê (–∞–¥–º–∏–Ω) ===== */
  gearBtn.addEventListener('click',()=>{ if(isAdmin){ adminModal.classList.add('show'); }});
  adminClose.addEventListener('click',()=> adminModal.classList.remove('show'));
</script>
<!-- /–ß–ê–°–¢–¨ 3/4 -->
<script>
/* ===== –ê–¥–º—ñ–Ω: –¥–æ–Ω–∞—Ç–∏/–±–∞–Ω —ñ –ø–æ–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ ===== */
const ADMIN_ACCOUNT_NUMBER = "ƒçsob 354037257/0300";
const DONATE_BASIC = 100, DONATE_PRO = 199;
let _allUsers = [], _userFlags = {}, _paymentInbox = {};

/* –ü—Ä–∞–ø–æ—Ä—Ü—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (–±–∞–Ω/–ø—Ä–µ–º—ñ—É–º) */
db.ref('settings/userFlags').on('value', s => {
  _userFlags = s.val() || {};
  if (document.getElementById('adminUsersModal').classList.contains('show')) {
    renderUsersTable(_allUsers);
  }
});

/* Inbox ¬´–ø–ª–∞—Ç–µ–∂—ñ–≤¬ª: —è–∫ —Ç—ñ–ª—å–∫–∏ –¥–µ—Å—å –∑‚Äô—è–≤–∏–ª–∞—Å—å –ø—ñ–¥–æ–∑—Ä—ñ–ª–∞ –æ–ø–ª–∞—Ç–∞ ‚Äî –ø—ñ–¥—Å–≤—ñ—á—É—î–º–æ –∞–¥–º—ñ–Ω–∞ */
db.ref('settings/paymentInbox').on('child_added', snap => {
  const v = snap.val() || {};
  _paymentInbox[snap.key] = v;
  if (isAdmin && auth.currentUser) {
    db.ref('notifications/' + auth.currentUser.uid).push({
      ts: Date.now(), type: 'pay',
      text: `–ü—ñ–¥–æ–∑—Ä–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É: ${v.fromUid ? v.fromUid.slice(0, 6) : ''}‚Ä¶`
    }).catch(()=>{});
  }
});

/* –í—ñ–¥–∫—Ä–∏—Ç–∏ –ø–æ–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫ –ª—é–¥–µ–π */
document.getElementById('openAllUsers').addEventListener('click', async () => {
  if (!isAdmin) { notify('–í—ñ–¥–º–æ–≤–∞', '–¢—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω–∞'); return; }
  document.getElementById('adminUsersModal').classList.add('show');
  const s = await db.ref('users').get();
  const obj = s.val() || {};
  _allUsers = Object.keys(obj).map(uid => ({ uid, ...obj[uid] }));
  document.getElementById('usersTotal').textContent = String(_allUsers.length);
  renderUsersTable(_allUsers);
});
document.getElementById('adminUsersClose').addEventListener('click', () => {
  document.getElementById('adminUsersModal').classList.remove('show');
});
document.getElementById('userSearch').addEventListener('input', () => renderUsersTable(_allUsers));

function renderUsersTable(list) {
  const q = document.getElementById('userSearch').value.trim().toLowerCase();
  const tbody = document.getElementById('usersTBody'); tbody.innerHTML = '';
  const filtered = list
    .filter(u => !q || (u.nick || '').toLowerCase().includes(q) || (u.email || '').toLowerCase().includes(q))
    .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
  document.getElementById('usersShown').textContent = String(filtered.length);

  filtered.forEach(u => {
    const flags = _userFlags[u.uid] || {};
    const banned = !!flags.banned;
    const premium = flags.premium || 'none';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <div style="display:flex;gap:8px;align-items:center">
          <img src="${u.avatar || DEFAULT_AVATAR}" style="width:36px;height:36px;border-radius:10px;object-fit:cover">
          <div>
            <div style="font-weight:800">${u.nick || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</div>
            <div class="muted" style="font-size:12px">${u.uid.slice(0,8)}‚Ä¶</div>
          </div>
        </div>
      </td>
      <td class="muted">${u.email || ''}</td>
      <td>${banned ? `<span class="user-badge tag-banned">–ó–∞–±–∞–Ω–µ–Ω–æ</span>` : `<span class="user-badge">OK</span>`}</td>
      <td>${
        premium==='pro' ? `<span class="user-badge tag-premium">PRO 199</span>` :
        premium==='basic' ? `<span class="user-badge tag-premium">BASIC 100</span>` :
        `<span class="user-badge">none</span>`
      }</td>
      <td>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          ${banned
            ? `<button class="btn-mini" data-act="unban" data-uid="${u.uid}">–†–æ–∑–±–∞–Ω–∏—Ç–∏</button>`
            : `<button class="btn-mini btn-red" data-act="ban" data-uid="${u.uid}">–ó–∞–±–∞–Ω–∏—Ç–∏</button>`
          }
          <button class="btn-mini btn-amber" data-act="grant100" data-uid="${u.uid}">–î–æ–Ω–∞—Ç 100</button>
          <button class="btn-mini btn-green" data-act="grant199" data-uid="${u.uid}">–î–æ–Ω–∞—Ç 199</button>
          <button class="btn-mini" data-act="pm" data-uid="${u.uid}">‚úâÔ∏è –õ–°</button>
          <button class="btn-mini" data-act="open" data-uid="${u.uid}">üëÄ –ü—Ä–æ—Ñ—ñ–ª—å</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('button[data-act]').forEach(btn =>
    btn.onclick = () => adminUserAction(btn.dataset.act, btn.dataset.uid)
  );
}

async function adminUserAction(act, uid) {
  if (!isAdmin) { notify('–í—ñ–¥–º–æ–≤–∞', '–ü–æ—Ç—Ä—ñ–±–Ω—ñ –ø—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω–∞'); return; }
  try{
    if (act==='ban') {
      await db.ref('settings/userFlags/'+uid).update({ banned:true, updatedBy:auth.currentUser.uid });
      await db.ref('notifications/'+uid).push({ ts:Date.now(), type:'system', text:'–í–∞—à –∞–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ (–±–∞–Ω).' });
      notify('OK','–ó–∞–±–∞–Ω–µ–Ω–æ');
    } else if (act==='unban') {
      await db.ref('settings/userFlags/'+uid).update({ banned:false, updatedBy:auth.currentUser.uid });
      await db.ref('notifications/'+uid).push({ ts:Date.now(), type:'system', text:'–ë–∞–Ω –∑–Ω—è—Ç–æ.' });
      notify('OK','–†–æ–∑–±–∞–Ω–µ–Ω–æ');
    } else if (act==='grant100') {
      await db.ref('settings/userFlags/'+uid).update({ premium:'basic', premiumSince:Date.now(), updatedBy:auth.currentUser.uid });
      await db.ref('notifications/'+uid).push({ ts:Date.now(), type:'premium', text:`–ê–∫—Ç–∏–≤–æ–≤–∞–Ω–æ BASIC (${DONATE_BASIC} Kƒç)` });
      notify('OK','–í–∏–¥–∞–Ω–æ BASIC 100');
    } else if (act==='grant199') {
      await db.ref('settings/userFlags/'+uid).update({ premium:'pro', premiumSince:Date.now(), updatedBy:auth.currentUser.uid });
      await db.ref('notifications/'+uid).push({ ts:Date.now(), type:'premium', text:`–ê–∫—Ç–∏–≤–æ–≤–∞–Ω–æ PRO (${DONATE_PRO} Kƒç)` });
      notify('OK','–í–∏–¥–∞–Ω–æ PRO 199');
    } else if (act==='pm') {
      openPrivateChat(uid);
    } else if (act==='open') {
      openProfile(uid);
    }
  }catch(e){ console.error(e); notify('–ü–æ–º–∏–ª–∫–∞','–î—ñ—è –Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–∞'); }
}

/* ===== ¬´–°–∫–∞–Ω–µ—Ä –æ–ø–ª–∞—Ç¬ª ‚Äî —è–∫—â–æ —Ö—Ç–æ—Å—å –∫–∏–¥–∞—î —Å–∫—Ä—ñ–Ω/—Ç–µ–∫—Å—Ç –∑ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∞–º–∏ ‚Äî –ø–∏—à–µ–º–æ –≤ settings/paymentInbox ===== */
function looksLikePaymentText(t){
  if(!t) return false;
  const s=t.toLowerCase();
  return s.includes('–æ–ø–ª–∞—Ç')||s.includes('–ø–ª–∞—Ç—ñ–∂')||s.includes('donat')||s.includes('–¥–æ–Ω–∞—Ç')
      ||s.includes('199')||s.includes('100')||s.includes('354037257')||s.includes('0300');
}
db.ref('messages').limitToLast(300).on('child_added', snap=>{
  const m=snap.val()||{}; if(!m.uid) return;
  if(!(m.image || looksLikePaymentText(m.text))) return;
  db.ref('settings/paymentInbox').push({
    fromUid:m.uid, ts:m.ts||Date.now(), messageId:snap.key, imageUrl:m.image||null, text:m.text||null
  }).catch(()=>{});
});

/* ===== –ë–û–¢–ò –∑ ¬´–ª—é–¥—Å—å–∫–∏–º–∏¬ª –Ω—ñ–∫–∞–º–∏ ===== */
if(!window.BOTS_DEF){
  window.BOTS_DEF = [
    { id:'bot_1', nick:"–ú–∞—Ä–∏–Ω–∞", avatar:"https://i.ibb.co/LH4wBMS/IMG-d8e6076e17f19db7fe3add0754738a01-V.jpg",
      posts:[
        {text:`O2 –°–Ü–ú –ö–ê–†–¢–ê\n–ë–µ–∑ –ª—ñ–º—ñ—Ç —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç —ñ –¥–∑–≤—ñ–Ω–∫–∏, –ø—Ä–∞—Ü—é—î –≤ –Ñ–°. 699 Kƒç/–º—ñ—Å. –°—Ç–∞—Ä—Ç 299 Kƒç. 607 914 467 (Viber/WhatsApp/Telegram)`, image:"https://i.ibb.co/LH4wBMS/IMG-d8e6076e17f19db7fe3add0754738a01-V.jpg"},
        {text:`–ü—Ä–æ–¥–∞—é iPhone 11 Pro Max + 26 —á–æ—Ö–ª—ñ–≤. –ë–µ–∑ —Ç—Ä—ñ—â–∏–Ω, –±–µ–∑ Apple ID. –ü–∏—à—ñ—Ç—å —É –ø—Ä–∏–≤–∞—Ç.`, image:"https://i.ibb.co/dwcXPqDr/IMG-1954f6b56869b9817a131ae33f3a37b6-V.jpg"},
        {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è`, image:"https://i.ibb.co/G3kDcrYZ/IMG-fa590121e46c5b030c5ddc94d4e8bea9-V.jpg"}
      ], baseInterval:2*60*1000
    },
    { id:'bot_2', nick:"–ê–Ω—Ç–æ–Ω", avatar:"https://i.ibb.co/Z11WVrVC/IMG-b83692bb79a1468af74c81620750e8c0-V.jpg",
      posts:[
        {text:`–®–∞–±–ª–æ–Ω`, image:"https://i.ibb.co/Z11WVrVC/IMG-b83692bb79a1468af74c81620750e8c0-V.jpg"},
        {text:`–®—É–∫–∞—é –º–æ–¥–µ–ª–µ–π –Ω–∞ –ø–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω–∏–π –º–∞–∫—ñ—è–∂ (–ü—Ä–∞–≥–∞, 28.07 –æ 14:00). –õ–∏—à–µ –∑–∞ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏. –£ –ø—Ä–∏–≤–∞—Ç.`, image:"https://i.ibb.co/QFWDvGZ8/IMG-6748e7141906901b131b8fd5130a5c01-V.jpg"},
        {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è 3`, image:"https://i.ibb.co/j97RhTny/IMG-593d75b053ea1a28cdfb9fc52f93afad-V.jpg"}
      ], baseInterval:3*60*1000
    },
    { id:'bot_3', nick:"–û–ª–µ–≥", avatar:"https://i.ibb.co/MzdTMPR/IMG-8231d8142ffcbba7c682ca598683e3f2-V.jpg",
      posts:[
        {text:`–ü–æ—Ç—Ä—ñ–±–µ–Ω –≤–æ–¥—ñ–π –¥–ª—è –ø–µ—Ä–µ—ó–∑–¥—É (–∑—ñ —Å–≤–æ—ó–º –∞–≤—Ç–æ).\nWhatsApp: +48 793 463 757 ‚Ä¢ Telegram: @carlx_xxx`, image:null},
        {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è`, image:"https://i.ibb.co/MzdTMPR/IMG-8231d8142ffcbba7c682ca598683e3f2-V.jpg"},
        {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è 3`, image:"https://i.ibb.co/rfNV6ddC/IMG-0cd648a74f86227fe46db2d01c099be0-V.jpg"}
      ], baseInterval:4*60*1000
    }
  ];
}

/* –ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä –±–æ—Ç—ñ–≤ */
const BotController = (()=>{
  const timers=new Map(), indices=new Map(), speeds=new Map();
  function nextPost(id,posts){ const i=(indices.get(id)||0); indices.set(id,i+1); return posts[i%posts.length]; }
  async function post(bot){
    const p=nextPost(bot.id,bot.posts);
    try{
      await db.ref('messages').push({
        uid:bot.id, nick:bot.nick, avatar:bot.avatar,
        text:p.text, image:p.image||null, ts:Date.now()
      });
    }catch(e){ console.error('bot push',e); }
  }
  function isRunning(id){ return timers.has(id); }
  function computeInterval(bot){ const mult=speeds.get(bot.id)||1; const min=15000; return Math.max(min, bot.baseInterval/mult); }
  function start(bot){
    if(isRunning(bot.id)) return;
    const tick=async()=>{ await post(bot); schedule(); };
    function schedule(){ const t=setTimeout(tick, computeInterval(bot)); timers.set(bot.id,t); updateUI(bot.id); }
    schedule();
  }
  function stop(id){ const t=timers.get(id); if(t){ clearTimeout(t); timers.delete(id); updateUI(id); } }
  function setSpeed(id,m){ speeds.set(id,m); if(timers.has(id)){ clearTimeout(timers.get(id)); timers.delete(id); const b=BOTS_DEF.find(x=>x.id===id); if(b) start(b); } updateUI(id); }
  function postOnce(bot){ return post(bot); }
  function stopAll(){ Array.from(timers.keys()).forEach(stop); }
  function startAll(){ BOTS_DEF.forEach(start); }
  function postOnceAll(){ return Promise.all(BOTS_DEF.map(postOnce)); }
  function getSpeed(id){ return speeds.get(id)||1; }
  function updateUI(id){
    const chip=document.querySelector(`[data-bot='${id}']`);
    if(!chip) return;
    const running=isRunning(id);
    chip.querySelector('.state').textContent = running ? '‚óè –ø—Ä–∞—Ü—é—î' : '‚óã –∑—É–ø–∏–Ω–µ–Ω–æ';
    chip.querySelector('.toggle').textContent= running ? '‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏' : '‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏';
  }
  return {start,stop,setSpeed,postOnce,stopAll,startAll,postOnceAll,getSpeed,isRunning};
})();

/* UI –¥–ª—è –±–æ—Ç—ñ–≤ (—ñ —É –≤–µ—Ä—Ö–Ω—ñ–π –ø–∞–Ω–µ–ª—ñ, —ñ –≤ –º–æ–¥–∞–ª—Ü—ñ) */
function buildBotChip(bot){
  const w=document.createElement('div'); w.className='admin-chip'; w.dataset.bot=bot.id;
  w.innerHTML=`
    <img src="${bot.avatar}" style="width:26px;height:26px;border-radius:6px;object-fit:cover">
    <b>${bot.nick}</b>
    <span class="state" style="font-size:12px;opacity:.8">‚óã –∑—É–ø–∏–Ω–µ–Ω–æ</span>
    <button class="toggle tab-button" style="padding:6px 10px">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏</button>
    <button class="once tab-button" style="padding:6px 10px;background:#fff3cd">‚ö°Ô∏è –†–∞–∑</button>
    <label style="font-size:12px">—à–≤–∏–¥–∫. <input type="range" min="0.5" max="3" step="0.1" value="1" class="speed"></label>
    <span class="speedv" style="font-size:12px">1√ó</span>
  `;
  const toggle=w.querySelector('.toggle');
  const once=w.querySelector('.once');
  const range=w.querySelector('.speed');
  const speedv=w.querySelector('.speedv');

  toggle.onclick=()=>{ if(BotController.isRunning(bot.id)) BotController.stop(bot.id); else BotController.start(bot); };
  once.onclick=()=>BotController.postOnce(bot);
  range.oninput=()=>{
    const v=Number(range.value);
    speedv.textContent=v.toFixed(1)+'√ó';
    BotController.setSpeed(bot.id,v);
    localStorage.setItem('bot_speed_'+bot.id,String(v));
  };
  const saved=Number(localStorage.getItem('bot_speed_'+bot.id)||'1');
  if(!Number.isNaN(saved)&&saved){ range.value=String(saved); speedv.textContent=saved.toFixed(1)+'√ó'; BotController.setSpeed(bot.id,saved); }
  return w;
}
function initAdminUI(){
  const row = document.getElementById('botsRow');
  if(row){ row.innerHTML=''; BOTS_DEF.forEach(b=> row.appendChild(buildBotChip(b))); }
  if(adminBots){ adminBots.innerHTML=''; BOTS_DEF.forEach(b=> adminBots.appendChild(buildBotChip(b))); }

  document.getElementById('startAll').onclick = ()=>BotController.startAll();
  document.getElementById('stopAll').onclick  = ()=>BotController.stopAll();
  document.getElementById('postOnceAll').onclick = ()=>BotController.postOnceAll();

  // —Ö—Ä–µ—Å—Ç–∏–∫ –¥–ª—è –∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ
  (function addAdminClose(){
    const bar=document.getElementById('adminBar');
    if(!bar || bar.querySelector('.admin-x')) return;
    const x=document.createElement('button');
    x.className='admin-x';
    x.textContent='‚úñ';
    x.title='–°—Ö–æ–≤–∞—Ç–∏ –ø–∞–Ω–µ–ª—å';
    x.style.cssText='position:absolute;right:6px;top:6px;border:none;background:transparent;color:#dfffe8;font-size:18px;cursor:pointer';
    x.onclick=()=>{ bar.style.display='none'; };
    bar.appendChild(x);
  })();
}
/* –ü–æ–∫–∞–∑–∞—Ç–∏ –∞–¥–º—ñ–Ω—Å—å–∫—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –ø—ñ—Å–ª—è –≤—Ö–æ–¥—É */
auth.onAuthStateChanged(u=>{ if(u && (isAdmin || u.email===ADMIN_EMAIL)) initAdminUI(); });

/* ===== –î–æ–≤–≥–µ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –ø–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—é (–º–æ–±—ñ–ª—å–Ω–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è/–¥—ñ—ó) ===== */
(function enableLongPress(){
  let pressTimer;
  document.addEventListener('touchstart', (e)=>{
    const wrap=e.target.closest('.message'); if(!wrap) return;
    clearTimeout(pressTimer);
    const msgId=wrap.dataset.msgid; const uid=wrap.dataset.uid;
    const pt = e.touches && e.touches[0] ? e.touches[0] : null;
    pressTimer=setTimeout(()=>{
      const x = pt ? pt.clientX : (wrap.getBoundingClientRect().left + 10);
      const y = pt ? pt.clientY : (wrap.getBoundingClientRect().top + 10);
      showMsgMenu(x, y, { id:msgId, uid }, wrap);
    }, 500);
  }, {passive:true});
  ['touchend','touchmove','touchcancel'].forEach(ev=>{
    document.addEventListener(ev, ()=> clearTimeout(pressTimer), {passive:true});
  });
})();

/* ===== –ö–ê–†–¢–ê Google ===== */
const POINTS = [
  { title:"Nemocnice Motol", pos:{lat:50.058,lng:14.360}, cat:"hospital", icon:"https://i.ibb.co/7Nv86Ch/hospital.png" },
  { title:"Nemocnice Na Franti≈°ku", pos:{lat:50.086,lng:14.418}, cat:"hospital", icon:"https://i.ibb.co/7Nv86Ch/hospital.png" },
  { title:"Pr√°vn√≠ pomoc ‚Äî —Ü–µ–Ω—Ç—Ä A", pos:{lat:50.083,lng:14.412}, cat:"lawyer",   icon:"https://i.ibb.co/5n2cVnR/law.png" },
  { title:"Pomoc Centrum 1", pos:{lat:50.082,lng:14.419}, cat:"help",     icon:"https://i.ibb.co/0V7gmp7/help.png" },
  { title:"Shop ‚Äî Albert", pos:{lat:50.084,lng:14.417},   cat:"shop",     icon:"https://i.ibb.co/CtM7Fv4/shop.png" }
];
let map, markers=[];
function initMap(){
  map = new google.maps.Map(document.getElementById('map'), {
    center:{lat:50.0755,lng:14.4378}, zoom:12,
    mapTypeControl:false, streetViewControl:false
  });
  markers = POINTS.map(p=>{
    const m = new google.maps.Marker({
      position:p.pos, title:p.title, map,
      icon: p.icon ? { url:p.icon, scaledSize:new google.maps.Size(28,28) } : undefined
    });
    const iw = new google.maps.InfoWindow({ content:`<b>${p.title}</b><br><small>${p.cat}</small>` });
    m.addListener('click', ()=> iw.open({ map, anchor:m }));
    return m;
  });
}
window.initMap = initMap;

/* –ü–æ—à—É–∫ —ñ —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è –∫–∞—Ä—Ç–∏ */
const mapSearch = document.getElementById('mapSearch');
const centerBtn = document.getElementById('centerBtn');
if (mapSearch) {
  mapSearch.addEventListener('input', () => {
    const q = mapSearch.value.trim().toLowerCase();
    if (!markers || !markers.length) return;
    markers.forEach((m, idx) => {
      const p = POINTS[idx];
      const show = !q || p.title.toLowerCase().includes(q) || (p.cat||'').toLowerCase().includes(q);
      m.setVisible(show);
    });
  });
}
if (centerBtn) {
  centerBtn.addEventListener('click', () => {
    if (map) map.setCenter({ lat: 50.0755, lng: 14.4378 });
  });
}

/* –ü—ñ–¥–∫–∞–∑–∫–∞ –∞–¥–º—ñ–Ω–∞–º, —è–∫—â–æ –ª–µ–Ω—Ç–∞ –ø–æ—Ä–æ–∂–Ω—è */
setTimeout(()=>{
  const hasItems = !!document.getElementById('messages').firstChild;
  if (isAdmin && !hasItems) notify('–ü—ñ–¥–∫–∞–∑–∫–∞','–õ–µ–Ω—Ç–∞ –ø–æ—Ä–æ–∂–Ω—è. –£ –ø–∞–Ω–µ–ª—ñ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –º–æ–∂–Ω–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç—ñ–≤.');
}, 800);

/* ESC –∑–∞–∫—Ä–∏–≤–∞—î –≤—ñ–¥–∫—Ä–∏—Ç—ñ –º–æ–¥–∞–ª–∫–∏ */
document.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal.show').forEach(m=> m.classList.remove('show'));
  }
});
</script>

<!-- Google Maps (—Ç–≤—ñ–π –∫–ª—é—á) -->
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFrxVhpb6nHJ6rhiLl5Ho8t0jOb1iEQNc&callback=initMap"></script>

</body>
</html>
<!-- ========== –ö–Ü–ù–ï–¶–¨ –ß–ê–°–¢–ò 4/4 ========== -->

