<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Praha Fu≈°ky ‚Äì –°–æ—Ü—á–∞—Ç</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --accent:#2ecc71;
      --accent-neon: #39ff91;
      --glass: rgba(255,255,255,0.95);
      --muted:#64748b;
      --max-width:1020px;
      --avatar-size:44px;
      --chat-scale:1.25; /* +25% —è–∫ –ø—Ä–æ—Å–∏–≤ */
      --header-h:74px;   /* –∫–æ–º–ø–∞–∫—Ç–Ω–∞ —à–∞–ø–∫–∞ */
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Arial, sans-serif;background:#071126;color:#0b1220;overflow-x:hidden}
    body{
      background-image: url('https://i.ibb.co/27hgtZfY/Prague.jpg');
      background-size: cover;background-position:center;background-attachment: fixed;
    }

    /* Header */
    header{position:sticky;top:0;z-index:70;padding:10px 8px 6px;text-align:center;color:#fff;backdrop-filter:blur(3px)}
    .brandRow{display:flex;align-items:center;justify-content:center;gap:10px;position:relative;min-height:var(--header-h)}
    /* avatar left, bell right, admin gear near bell */
    .profile-btn{position:absolute;left:10px;top:12px;z-index:100;width:46px;height:46px;border-radius:50%;border:2px solid #fff;background-size:cover;background-position:center;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35)}
    .bell-btn{position:absolute;right:10px;top:12px;width:46px;height:46px;border-radius:50%;border:2px solid rgba(255,255,255,.9);background:rgba(0,0,0,.28);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35);color:#fff}
    .gear-btn{position:absolute;right:66px;top:12px;width:46px;height:46px;border-radius:50%;border:2px solid rgba(255,255,255,.9);background:rgba(0,0,0,.28);display:none;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35);color:#fff}
    .bell-badge{position:absolute;top:-6px;right:-6px;background:#ff3366;color:#fff;border-radius:12px;padding:2px 6px;font-size:12px;font-weight:700;box-shadow:0 0 10px rgba(255,51,102,.9)}
    header h1{
      margin:0; font-family:'UnifrakturCook', Inter, sans-serif; font-weight:700; font-size:34px; letter-spacing:1px; text-transform:uppercase;
      background: linear-gradient(90deg,#d00,#1155ff); -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 2px 0 rgba(0,0,0,.55), 0 6px 18px rgba(0,0,0,.6);
    }
    header .sub{
      margin:6px auto 0; font-size:13px; color:#e8ffee; display:inline-block; padding:6px 10px; border-radius:10px;
      background:rgba(0,0,0,.28); border:1px solid rgba(255,255,255,.08)
    }

    /* Neon tabs row */
    .topBar{position:sticky;top:calc(var(--header-h));z-index:66;backdrop-filter: blur(2px)}
    .neon-wrap{max-width:var(--max-width);margin:6px auto 0;padding:6px 8px}
    .neon-tabs{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .tab-button{
      border:none; font-weight:800; letter-spacing:.2px; cursor:pointer; border-radius:12px; padding:8px 14px; color:#021f13;
      background:#cfffdf; box-shadow: 0 0 12px rgba(57,255,145,.45), inset 0 -3px 0 rgba(0,0,0,.08);
      transition:.15s transform ease, .15s box-shadow ease;
    }
    .tab-button:hover{transform:translateY(-1px); box-shadow:0 0 16px rgba(57,255,145,.85), inset 0 -3px 0 rgba(0,0,0,.08)}
    .tab-button.active{outline:2px solid var(--accent-neon); box-shadow:0 0 18px rgba(57,255,145,.95), inset 0 -3px 0 rgba(0,0,0,.08)}
    /* Info strip removed per request */
    .online-neon{
      margin:8px auto 10px; max-width:var(--max-width); text-align:center; color:#baffd1; font-weight:800;
      text-shadow:0 0 8px rgba(57,255,145,.9);
      background:rgba(0,0,0,.35); border:1px solid rgba(57,255,145,.35);
      border-radius:10px; padding:6px 10px;
    }

    main.container{max-width:var(--max-width);margin:0 auto;padding:10px}
    .tab-content{display:none}
    .tab-content.active{display:block}

    /* chat */
    .chat-area{height:calc(100vh - 320px);overflow:auto;padding:14px 8px;background:transparent}
    .messages{display:flex;flex-direction:column;gap:12px;padding-bottom:220px;transform:scale(var(--chat-scale));transform-origin:bottom left}
    .message{display:flex;gap:10px;align-items:flex-start;max-width:78%;word-break:break-word}
    .message.self{margin-left:auto;flex-direction:row-reverse}
    .avatar{width:var(--avatar-size);height:var(--avatar-size);border-radius:50%;object-fit:cover;flex:0 0 var(--avatar-size);box-shadow:0 3px 10px rgba(0,0,0,0.35);cursor:pointer}
    .message-content{background:var(--glass);padding:10px 12px;border-radius:14px;box-shadow:0 6px 30px rgba(2,6,23,0.18);color:#0b1220; position:relative}
    .message.self .message-content{background:#E9FFF0}
    .message-meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .chat-image{max-width:300px;border-radius:8px;margin-top:8px;display:block}
    .message-content .text { font-family: 'Inter', sans-serif; font-weight:600; font-size:1rem; color:#0b1220; white-space:pre-wrap }
    .msg-actions{position:absolute; right:6px; top:6px; opacity:.65; font-size:12px}
    .msg-actions button{border:none;background:transparent;cursor:pointer}

    /* input bar */
    .chat-input{position:fixed;left:0;right:0;bottom:0;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.99));border-top:1px solid rgba(0,0,0,0.06);z-index:80;display:flex;gap:8px;align-items:center;max-width:var(--max-width);margin:0 auto}
    .camera-btn{display:inline-flex;align-items:center;justify-content:center;cursor:pointer;width:48px;height:48px;border-radius:50%;background:#fff;border:1px solid #e6e6e6}
    .camera-btn svg{width:20px;height:20px}
    .chat-input input[type="text"]{flex:1;padding:12px 14px;border-radius:24px;border:1px solid #d0d7de;font-size:16px;outline:none}
    .send-btn{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:20px;font-weight:800;cursor:pointer;box-shadow:0 8px 20px rgba(46,204,113,0.18)}

    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:95}
    .modal.show{display:flex}
    .modal-panel{background:#fff;border-radius:12px;padding:18px;width:92%;max-width:720px;position:relative;box-shadow:0 18px 80px rgba(2,6,23,0.4)}
    .modal-close{position:absolute;right:10px;top:8px;background:transparent;border:none;font-size:18px;cursor:pointer}
    .auth-form input{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #dcdcdc}
    .auth-actions{display:flex;gap:8px;justify-content:space-between}
    .auth-actions button{flex:1;padding:10px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer}
    .error-line{color:#b91c1c;font-size:13px;margin-top:6px}

    /* context menu */
    .msg-menu{position:absolute;background:#fff;border-radius:8px;padding:6px;box-shadow:0 6px 20px rgba(0,0,0,0.2);z-index:200;display:none}
    .msg-menu button{display:block;border:none;background:transparent;padding:6px 10px;text-align:left;width:100%;cursor:pointer}
    .msg-menu button:hover{background:rgba(0,0,0,0.03)}

    /* help cards */
    .help-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;padding:12px}
    .help-card{background:#fff;padding:10px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .help-card img{width:100%;height:140px;object-fit:cover;border-radius:8px}

    /* friends page */
    .friends-wrap{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
    .friend-card{background:#fff;border-radius:10px;padding:10px;box-shadow:0 2px 10px rgba(0,0,0,.08);display:flex;gap:10px;align-items:center}

    /* map */
    #map{width:100%;height:60vh;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.3);background:#eaf7ff}

    /* Admin bar (compact floating when chat tab) */
    .admin-bar{position:sticky; top:0; z-index:67; display:none; max-width:var(--max-width); margin:6px auto; padding:8px; border-radius:10px; background:rgba(0,0,0,.35); border:1px solid rgba(57,255,145,.35); color:#dfffe8}
    .admin-bar .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .admin-chip{display:inline-flex;align-items:center;gap:6px; padding:6px 8px; border-radius:10px; background:#ffffff; color:#111; box-shadow:0 2px 8px rgba(0,0,0,.15)}
    .admin-chip input[type="range"]{width:120px}

    @media (max-width:640px){
      .chat-area{height:calc(100vh - 360px)}
      .chat-image{max-width:200px}
    }
  </style>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>

  <header>
    <div class="brandRow">
      <button id="profileBtn" class="profile-btn" title="–ü—Ä–æ—Ñ—ñ–ª—å" aria-label="–ü—Ä–æ—Ñ—ñ–ª—å"></button>
      <h1>Praha Fu≈°ky</h1>
      <button id="gearBtn" class="gear-btn" title="–ê–¥–º—ñ–Ω" aria-label="–ê–¥–º—ñ–Ω">‚öôÔ∏è</button>
      <button id="bellBtn" class="bell-btn" title="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è" aria-label="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è">
        üîî
        <span id="bellBadge" class="bell-badge" style="display:none">0</span>
      </button>
    </div>
    <div class="sub">–î–æ–ø–æ–º–∞–≥–∞—î–º–æ —É–∫—Ä–∞—ó–Ω—Ü—è–º —É –ü—Ä–∞–∑—ñ ‚Äî —Å–ø—ñ–ª—å–Ω–æ—Ç–∞, —á–∞—Ç, –æ—Ä–µ–Ω–¥–∞, –¥–æ–ø–æ–º–æ–≥–∞.</div>
  </header>

  <!-- Tabs + online -->
  <div class="topBar">
    <div class="neon-wrap">
      <nav class="neon-tabs" role="tablist" aria-label="–í–∫–ª–∞–¥–∫–∏">
        <button class="tab-button active" data-target="chatTab">üí¨ –ß–∞—Ç</button>
        <button class="tab-button" data-target="rentTab">üè† –ß–∞—Ç –û—Ä–µ–Ω–¥–∞</button>
        <button class="tab-button" data-target="mapTab">üó∫Ô∏è –ö–∞—Ä—Ç–∞</button>
        <button class="tab-button" data-target="friendsTab">üë• –î—Ä—É–∑—ñ</button>
        <button class="tab-button" data-target="helpTab">üÜò –î–æ–ø–æ–º–æ–≥–∞</button>
        <button class="tab-button" data-target="dmTab">‚úâÔ∏è –û—Å–æ–±–∏—Å—Ç—ñ</button>
      </nav>
      <!-- info-strip removed per request -->
      <div class="online-neon" id="onlineNeon">–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): 0</div>
    </div>
  </div>

  <main class="container" role="main">
    <!-- Admin floating bar (only for admin) -->
    <div id="adminBar" class="admin-bar">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:800">–ö–µ—Ä—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞–º–∏</div>
        <div>
          <button id="startAll" class="tab-button">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—Å—ñ—Ö</button>
          <button id="stopAll" class="tab-button" style="background:#ffe1e1">‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏ –≤—Å—ñ—Ö</button>
          <button id="postOnceAll" class="tab-button" style="background:#fff3cd">‚ö°Ô∏è –ü–æ –æ–¥–Ω–æ–º—É –ø–æ—Å—Ç—É</button>
        </div>
      </div>
      <div id="botsRow" class="row" style="margin-top:8px"></div>
    </div>

    <!-- Chat -->
    <section id="chatTab" class="tab-content active" role="region" aria-label="–ß–∞—Ç">
      <div class="chat-area" id="chatArea" aria-live="polite">
        <div id="messages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- Rent Chat -->
    <section id="rentTab" class="tab-content" role="region" aria-label="–ß–∞—Ç –û—Ä–µ–Ω–¥–∞">
      <div class="chat-area" id="rentArea">
        <div id="rentMessages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- Map -->
    <section id="mapTab" class="tab-content" role="region" aria-label="–ö–∞—Ä—Ç–∞">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <div style="flex:1">
          <input id="mapSearch" placeholder="–ü–æ—à—É–∫ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –≤–æ–ª–æ–Ω—Ç–µ—Ä–∏, –∞–ø—Ç–µ–∫–∞)..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd">
        </div>
        <div>
          <button id="centerBtn" class="tab-button" style="padding:6px 10px">–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏</button>
        </div>
      </div>
      <div id="map"></div>
    </section>

    <!-- Friends -->
    <section id="friendsTab" class="tab-content" role="region" aria-label="–î—Ä—É–∑—ñ">
      <h2 style="color:#fff;margin:6px 0">–î—Ä—É–∑—ñ —Ç–∞ –∑–∞—è–≤–∫–∏</h2>
      <div class="friends-wrap">
        <div>
          <h3>–ó–∞—è–≤–∫–∏</h3>
          <div id="friendRequests"></div>
        </div>
        <div>
          <h3>–ú–æ—ó –¥—Ä—É–∑—ñ (<span id="friendsOnlineCount">0</span> –æ–Ω–ª–∞–π–Ω)</h3>
          <div id="friendsList"></div>
        </div>
      </div>
    </section>

    <!-- Help -->
    <section id="helpTab" class="tab-content" role="region" aria-label="–î–æ–ø–æ–º–æ–≥–∞">
      <h2 style="color:#fff">–¢–µ—Ä–º—ñ–Ω–æ–≤–∞ –¥–æ–ø–æ–º–æ–≥–∞ —É –ü—Ä–∞–∑—ñ</h2>
      <div class="help-grid" id="helpGrid">
        <div class="help-card">
          <img src="https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp" alt="–ë–æ–ª—å–Ω–∏—Ü–∞">
          <h3>Nemocnice Motol</h3><p>–ê–¥—Ä–µ—Å–∞: V √övalu 84</p>
        </div>
        <div class="help-card">
          <img src="https://i.ibb.co/0gWD5wW/images-5.jpg" alt="–Æ—Ä–∏—Å—Ç—ã">
          <h3>–Æ—Ä–∏–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞</h3><p>–î–æ–∫—É–º–µ–Ω—Ç–∏ —Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó</p>
        </div>
        <div class="help-card">
          <img src="https://i.ibb.co/R49shL6k/images-6.jpg" alt="–ú–∞–≥–∞–∑–∏–Ω—ã">
          <h3>–£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –º–∞–≥–∞–∑–∏–Ω–∏</h3><p>–ü—Ä–æ–¥—É–∫—Ç–∏ —Ç–∞ —Ç–æ–≤–∞—Ä–∏</p>
        </div>
      </div>
    </section>

    <!-- Direct Messages (overview) -->
    <section id="dmTab" class="tab-content" role="region" aria-label="–û—Å–æ–±–∏—Å—Ç—ñ">
      <h2 style="color:#fff;margin:6px 0">–ú–æ—ó –¥—ñ–∞–ª–æ–≥–∏</h2>
      <div id="dmList"></div>
    </section>
  </main>

  <!-- hidden file for camera -->
  <input id="fileInput" type="file" accept="image/*" style="display:none">

  <!-- input area (shared for active chat tab: chat or rent) -->
  
  <div id="quotaBar" style="position:fixed;left:0;right:0;bottom:68px;display:flex;gap:8px;align-items:center;justify-content:center;padding:6px 10px;margin:0 auto;max-width:1020px;z-index:81">
    <div id="quotaText" style="background:rgba(0,0,0,.35);border:1px solid rgba(57,255,145,.35);color:#dfffe8;border-radius:10px;padding:6px 10px;font-weight:800"></div>
    <button id="openPayBtn" class="tab-button">üí≥ –ü—ñ–¥–ø–∏—Å–∫–∞</button>
  </div>

  <div class="chat-input" role="region" aria-label="–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">
    <label for="fileInput" class="camera-btn" title="–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ" id="cameraLabel" aria-hidden="true">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M4 7H6L7 5H17L18 7H20C21.1 7 22 7.9 22 9V19C22 20.1 21.1 21 20 21H4C2.9 21 2 20.1 2 19V9C2 7.9 2.9 7 4 7Z" fill="#111"/>
        <circle cx="12" cy="13" r="3.5" fill="#fff"/>
      </svg>
    </label>
    <input id="messageInput" type="text" inputmode="text" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." aria-label="–¢–µ–∫—Å—Ç" />
    <button id="sendButton" class="send-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
  </div>

  <!-- auth modal -->
  <div id="authModal" class="modal" aria-hidden="true">
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <button class="modal-close" id="modalClose">‚úñ</button>
      <h2 id="authTitle">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è / –í—Ö—ñ–¥</h2>

      <form id="registerForm" class="auth-form" onsubmit="return false;">
        <input id="nickInput" type="text" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" required />
        <input id="emailInput" type="email" placeholder="Email" required />
        <input id="passwordInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω—ñ–º—É–º 6)" required />
        <input id="avatarUrlInput" type="url" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∫–∏ (–∑–∞ –±–∞–∂–∞–Ω–Ω—è–º, —á–µ—Ä–µ–∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è)" />
        <div class="auth-actions">
          <button id="registerSubmit" type="button">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
          <button id="loginShow" type="button" style="background:#4b5563">–£–≤—ñ–π—Ç–∏</button>
        </div>
        <div id="regError" class="error-line"></div>
      </form>

      <form id="loginForm" class="auth-form" style="display:none" onsubmit="return false;">
        <input id="loginEmail" type="email" placeholder="Email" required />
        <input id="loginPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" required />
        <div class="auth-actions">
          <button id="loginSubmit" type="button">–£–≤—ñ–π—Ç–∏</button>
          <button id="backToRegister" type="button" style="background:#4b5563">–ù–∞–∑–∞–¥</button>
        </div>
        <div id="loginError" class="error-line"></div>
      </form>
    </div>
  </div>

  <!-- profile modal -->
  <div id="profileModal" class="modal" aria-hidden="true">
    <div class="modal-panel" role="dialog" aria-modal="true">
      <button class="modal-close" id="profileClose">‚úñ</button>
      <div id="profileContent"></div>
    </div>
  </div>

  <!-- message actions menu -->
  <div id="msgMenu" class="msg-menu" role="menu">
    <button data-act="like">üëç –õ–∞–π–∫</button>
    <button data-act="warn">‚ö†Ô∏è –û–±–µ—Ä–µ–∂–Ω–æ (—à–∞—Ö—Ä–∞–π)</button>
    <button data-act="dislike">üëé –î–∏–∑–ª–∞–π–∫</button>
    <button data-act="spam">üö´ –°–ø–∞–º</button>
    <button data-act="reply">‚Ü©Ô∏è –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏</button>
  </div>

  <!-- notifications modal -->
  <div id="bellModal" class="modal" aria-hidden="true">
    <div class="modal-panel" role="dialog" aria-modal="true">
      <button class="modal-close" id="bellClose">‚úñ</button>
      <h3>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h3>
      <div id="notifList"></div>
    </div>
  </div>

  <!-- Admin modal -->
  <div id="adminModal" class="modal" aria-hidden="true">
    <div class="modal-panel" role="dialog" aria-modal="true">
      <button class="modal-close" id="adminClose">‚úñ</button>
      <h3>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h3>
      <p style="margin-top:0">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –±–æ—Ç–∞–º–∏ –Ω–∏–∂—á–µ. –®–≤–∏–¥–∫—ñ—Å—Ç—å = –º–Ω–æ–∂–Ω–∏–∫ (0.5√ó ‚Ä¶ 3√ó). –°—Ç–∞–Ω –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (per device).</p>
      <div id="adminBots"></div>
    </div>
  </div>

  <!-- Firebase + app logic -->
  <script type="module">
    /* ---------------- Firebase ---------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile,
      sendEmailVerification, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getDatabase, ref as dbRef, push as dbPush, onChildAdded, query, orderByChild, limitToLast,
      get as dbGet, set as dbSet, onValue, remove as dbRemove, update as dbUpdate
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // --- Config (—ñ–∑ —Ç–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç—É) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
      authDomain: "praga-4baee.firebaseapp.com",
      databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
      projectId: "praga-4baee",
      storageBucket: "praga-4baee.firebasestorage.app",
      messagingSenderId: "336023952536",
      appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
      measurementId: "G-BGDJD6R12N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    /* ---------------- Admin detection ---------------- */
    const ADMIN_EMAIL = "urciknikolaj642@gmail.com"; // —Ç–≤—ñ–π email –∑ –∫–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç–∏ —Ä–µ–∫–ª–∞–º—É"
    const ADMIN_UIDS = new Set(); // –¥–æ–¥–∞—Ç–∫–æ–≤–æ –º–æ–∂–Ω–∞ –≤–ø–∏—Å–∞—Ç–∏ UID-–∏ —Å—é–¥–∏
    let isAdmin = false;

    /* ---------------- DOM refs ---------------- */
    const tabButtons = document.querySelectorAll(".tab-button");
    const tabContents = document.querySelectorAll(".tab-content");
    const messagesEl = document.getElementById("messages");
    const rentMessagesEl = document.getElementById("rentMessages");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    const fileInput = document.getElementById("fileInput");
    const authModal = document.getElementById("authModal");
    const registerForm = document.getElementById("registerForm");
    const loginForm = document.getElementById("loginForm");
    const nickInput = document.getElementById("nickInput");
    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");
    const avatarUrlInput = document.getElementById("avatarUrlInput");
    const registerSubmit = document.getElementById("registerSubmit");
    const loginShow = document.getElementById("loginShow");
    const loginSubmit = document.getElementById("loginSubmit");
    const backToRegister = document.getElementById("backToRegister");
    const loginEmail = document.getElementById("loginEmail");
    const loginPassword = document.getElementById("loginPassword");
    const modalClose = document.getElementById("modalClose");
    const regError = document.getElementById("regError");
    const loginError = document.getElementById("loginError");

    const profileBtn = document.getElementById("profileBtn");
    const profileModal = document.getElementById("profileModal");
    const profileContent = document.getElementById("profileContent");
    const profileClose = document.getElementById("profileClose");

    const msgMenu = document.getElementById("msgMenu");
    const onlineNeon = document.getElementById("onlineNeon");

    const bellBtn = document.getElementById("bellBtn");
    const bellBadge = document.getElementById("bellBadge");
    const bellModal = document.getElementById("bellModal");
    const bellClose = document.getElementById("bellClose");
    const notifList = document.getElementById("notifList");

    const friendsList = document.getElementById("friendsList");
    const friendRequests = document.getElementById("friendRequests");
    const friendsOnlineCountEl = document.getElementById("friendsOnlineCount");
    const dmList = document.getElementById("dmList");

    const mapSearch = document.getElementById("mapSearch");
    const centerBtn = document.getElementById("centerBtn");

    const adminBar = document.getElementById('adminBar');
    const botsRow = document.getElementById('botsRow');
    const startAllBtn = document.getElementById('startAll');
    const stopAllBtn = document.getElementById('stopAll');
    const postOnceAllBtn = document.getElementById('postOnceAll');
    const gearBtn = document.getElementById('gearBtn');
    const adminModal = document.getElementById('adminModal');
    const adminClose = document.getElementById('adminClose');
    const adminBots = document.getElementById('adminBots');

    const DEFAULT_AVATAR = "https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg";
    let currentUser = null;
    const MSG_LIMIT = 250;

    /* ---------------- Tabs + hotkeys ---------------- */
    function setActiveTab(id) {
      tabButtons.forEach(b => b.classList.toggle("active", b.dataset.target === id));
      tabContents.forEach(c => c.style.display = (c.id === id) ? "block" : "none");
      if (id === "chatTab" || id === "rentTab") messageInput.focus();
      if (id === "mapTab") { if (typeof google !== 'undefined' && window.map) google.maps.event.trigger(window.map,'resize'); }
      // –ø–æ–∫–∞–∑–∞—Ç–∏ admin bar —Ç—ñ–ª—å–∫–∏ –Ω–∞ —á–∞—Ç-–≤–∫–ª–∞–¥—Ü—ñ —ñ —è–∫—â–æ –∞–¥–º—ñ–Ω
      adminBar.style.display = (id === 'chatTab' && isAdmin) ? 'block' : 'none';
    }
    tabButtons.forEach(btn => btn.addEventListener("click", ()=> setActiveTab(btn.dataset.target)));
    document.addEventListener("keydown", (e)=> {
      const k = e.key.toLowerCase();
      if (k === 'c') setActiveTab("chatTab");
      if (k === 'r') setActiveTab("rentTab");
      if (k === 'm') setActiveTab("mapTab");
      if (k === 'f') setActiveTab("friendsTab");
      if (k === 'h') setActiveTab("helpTab");
      if (k === 'd') setActiveTab("dmTab");
    });

    /* ---------------- Auth modal ---------------- */
    function showAuthModal(){ authModal.classList.add("show"); authModal.setAttribute("aria-hidden","false"); regError.textContent=""; loginError.textContent=""; }
    function hideAuthModal(){ authModal.classList.remove("show"); authModal.setAttribute("aria-hidden","true"); }
    modalClose?.addEventListener("click", hideAuthModal);
    loginShow?.addEventListener("click", ()=>{ registerForm.style.display="none"; loginForm.style.display="block"; });
    backToRegister?.addEventListener("click", ()=>{ registerForm.style.display="block"; loginForm.style.display="none"; });
    registerSubmit?.addEventListener("click", async ()=> {
      regError.textContent = "";
      const nick = nickInput.value.trim();
      const email = emailInput.value.trim();
      const pass = passwordInput.value.trim();
      const avatarUrl = (avatarUrlInput.value || "").trim();
      if (!nick || !email || !pass) { regError.textContent = "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è"; return; }
      if (pass.length < 6) { regError.textContent = "–ü–∞—Ä–æ–ª—å –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤"; return; }
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        const photo = avatarUrl || DEFAULT_AVATAR;
        await updateProfile(cred.user, { displayName: nick, photoURL: photo });
        await dbSet(dbRef(db, `users/${cred.user.uid}`), {
          nick, email, avatar: photo, createdAt: Date.now()
        });
        localStorage.setItem("regTime_" + cred.user.uid, String(Date.now()));
        await sendEmailVerification(cred.user);
        try { await dbSet(dbRef(db, `presence/${cred.user.uid}`), { ts: Date.now(), nick }); } catch(e){}
        hideAuthModal();
        // –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —É üîî –∑–∞–º—ñ—Å—Ç—å info-strip
        await dbPush(dbRef(db, `notifications/${cred.user.uid}`), { ts: Date.now(), type:"info", text:"–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ‚Äò–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏‚Äô –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó. 6 –≥–æ–¥–∏–Ω –¥–æ—Å—Ç—É–ø—É –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email." });
      } catch (err) { console.error(err); regError.textContent = err?.message || String(err); }
    });
    loginSubmit?.addEventListener("click", async ()=> {
      loginError.textContent = "";
      const email = loginEmail.value.trim();
      const pass = loginPassword.value.trim();
      if (!email || !pass) { loginError.textContent = "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å email —ñ –ø–∞—Ä–æ–ª—å"; return; }
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        hideAuthModal();
      } catch (err) { console.error(err); loginError.textContent = err?.message || String(err); }
    });

    onAuthStateChanged(auth, async (user)=> {
      currentUser = user;
      if (user) {
        profileBtn.style.background = `url(${user.photoURL || DEFAULT_AVATAR}) center/cover`;
        try { await dbSet(dbRef(db, `presence/${user.uid}`), { ts: Date.now(), nick: user.displayName || user.email }); } catch(e){}
        subscribeNotifications(user.uid);
        loadDMList();
        // –≤–∏–∑–Ω–∞—á–∞—î–º–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        try {
          const roleSnap = await dbGet(dbRef(db, `users/${user.uid}/role`));
          const role = roleSnap.exists() ? roleSnap.val() : null;
          isAdmin = (user.email === ADMIN_EMAIL) || ADMIN_UIDS.has(user.uid) || role === 'admin';
        } catch(e){ isAdmin = (user.email === ADMIN_EMAIL) || ADMIN_UIDS.has(user.uid); }
        gearBtn.style.display = isAdmin ? 'flex' : 'none';
        adminBar.style.display = (isAdmin && document.getElementById('chatTab').style.display === 'block') ? 'block' : (isAdmin ? 'block' : 'none');
        if (isAdmin) initAdminUI();
      } else {
        profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`;
        isAdmin = false; gearBtn.style.display = 'none'; adminBar.style.display = 'none';
      }
      updateOnlineCount();
      refreshFriendsBlocks();
    });

    /* ---------------- 6h rule ---------------- */
    async function canSendMessage(){
      const user = auth.currentUser;
      if (!user) return false;
      if (user.emailVerified) return true;
      const localKey = "regTime_" + user.uid;
      const localVal = localStorage.getItem(localKey);
      const sixHours = 6 * 60 * 60 * 1000;
      if (localVal && (Date.now() - Number(localVal) < sixHours)) return true;
      try {
        const snap = await dbGet(dbRef(db, `users/${user.uid}/createdAt`));
        if (snap && snap.exists()) {
          const created = Number(snap.val());
          if (!Number.isNaN(created) && Date.now() - created < sixHours) {
            localStorage.setItem(localKey, String(created));
            return true;
          }
        }
      } catch (e) { console.error(e); }
      return false;
    }

    /* ---------------- Rendering messages (with sticky autoscroll) ---------------- */
    function timeStr(ts){ return new Date(ts).toLocaleString(); }
    function isNearBottom(area){ return (area.scrollHeight - area.scrollTop - area.clientHeight) < 160; }
    function scrollToBottom(area){ area.scrollTop = area.scrollHeight; }

    function renderMessage(m, container){
      if (!m || !m.ts) return;
      const wrap = document.createElement("div");
      wrap.className = "message" + ((currentUser && m.uid === currentUser.uid) ? " self" : "");
      wrap.dataset.uid = m.uid || "";
      wrap.dataset.msgid = m.id || "";

      const avatar = document.createElement("img");
      avatar.className = "avatar";
      avatar.src = m.avatar || DEFAULT_AVATAR;
      avatar.alt = m.nick || "avatar";
      avatar.title = m.nick || "–ü–æ–∫–∞–∑ –ø—Ä–æ—Ñ—ñ–ª—é";
      avatar.addEventListener("click", ()=> openProfile(m.uid));

      const txt = document.createElement("div");
      txt.className = "message-content";
      const meta = document.createElement("div");
      meta.className = "message-meta";
      meta.textContent = `${m.nick || "–ê–Ω–æ–Ω—ñ–º"} ¬∑ ${timeStr(m.ts)}` + (m.recipientUid ? " ¬∑ –æ—Å–æ–±–∏—Å—Ç–µ" : "");
      txt.appendChild(meta);

      if (m.text) {
        const p = document.createElement("div");
        p.className = "text";
        p.innerText = m.text;
        txt.appendChild(p);
      }
      if (m.image) {
        const im = document.createElement("img");
        im.src = m.image;
        im.alt = "–§–æ—Ç–æ";
        im.className = "chat-image";
        txt.appendChild(im);
      }

      const act = document.createElement("div");
      act.className = "msg-actions";
      act.innerHTML = `<button title="–î—ñ—ó">‚ãØ</button>`;
      act.querySelector("button").addEventListener("click", (ev)=>{
        const rect = ev.target.getBoundingClientRect();
        showMsgMenu(rect.left, rect.bottom+4, m, wrap);
      });
      txt.appendChild(act);

      const area = container.closest('.chat-area');
      const stick = area ? isNearBottom(area) : false;

      wrap.appendChild(avatar);
      wrap.appendChild(txt);
      container.appendChild(wrap);

      if (area && stick) scrollToBottom(area);
    }

    /* ---------------- Subscriptions for chats (load newest first view) ---------------- */
    let initialMainLoaded = false;
    let initialRentLoaded = false;
    const msgsQuery = query(dbRef(db, "messages"), orderByChild("ts"), limitToLast(MSG_LIMIT));
    onChildAdded(msgsQuery, (snap) => {
      const m = snap.val(); m.id = snap.key; renderMessage(m, messagesEl);
      if (!initialMainLoaded) {
        // –î–æ—á–µ–∫–∞—î–º–æ—Å—å –ø–µ—Ä—à–æ—ó –ø–∞—Ä—Ç—ñ—ó (–º—ñ–∫—Ä–æ–∑–∞—Ç—Ä–∏–º–∫–∞) —ñ –ø—Ä–æ–∫—Ä—É—Ç–∏–º–æ –¥–æ–Ω–∏–∑—É, —â–æ–± –Ω–µ –≤—ñ–¥–∫—Ä–∏–≤–∞–ª–æ—Å—å –Ω–∞ —Å—Ç–∞—Ä–∏—Ö
        clearTimeout(window._scrollMainInit);
        window._scrollMainInit = setTimeout(()=>{ const area = document.getElementById('chatArea'); scrollToBottom(area); initialMainLoaded = true; }, 80);
      }
    });

    const rentQuery = query(dbRef(db, "rentMessages"), orderByChild("ts"), limitToLast(MSG_LIMIT));
    onChildAdded(rentQuery, (snap) => {
      const m = snap.val(); m.id = snap.key; renderMessage(m, rentMessagesEl);
      if (!initialRentLoaded) {
        clearTimeout(window._scrollRentInit);
        window._scrollRentInit = setTimeout(()=>{ const area = document.getElementById('rentArea'); scrollToBottom(area); initialRentLoaded = true; }, 80);
      }
    });

    /* ---------------- Send message (to active chat) ---------------- */
    function activeChatPath(){
      const isRent = document.getElementById("rentTab").style.display === "block";
      return isRent ? "rentMessages" : "messages";
    }
    sendButton.addEventListener("click", async ()=>{
      if (!auth.currentUser) { showAuthModal(); return; }
      if (!await canSendMessage()) { notify("–ü–æ—Ç—Ä—ñ–±–Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email", "–°–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—å 6-–≥–æ–¥–∏–Ω–Ω–∏–º –¥–æ—Å—Ç—É–ø–æ–º –ø—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –∞–±–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å email."); return; }

      const text = messageInput.value.trim();
      const file = fileInput.files[0];
      if (!text && !file) return;

      let imageData = null;
      if (file) {
        try { imageData = await resizeImageFile(file, 900, 0.8); }
        catch (e) { console.error(e); notify("–ü–æ–º–∏–ª–∫–∞", "–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ"); return; }
      }

      const msg = {
        uid: auth.currentUser.uid,
        nick: auth.currentUser.displayName || auth.currentUser.email || "–ê–Ω–æ–Ω—ñ–º",
        avatar: auth.currentUser.photoURL || DEFAULT_AVATAR,
        text: text || null,
        image: imageData || null,
        ts: Date.now(),
        recipientUid: null
      };

      try {
        await dbPush(dbRef(db, activeChatPath()), msg);
        messageInput.value = ""; fileInput.value = "";
      } catch (err) { console.error(err); notify("–ü–æ–º–∏–ª–∫–∞", "–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è"); }
    });
    messageInput.addEventListener("keydown", (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendButton.click(); } });

    document.querySelector('.camera-btn')?.addEventListener("click", (e) => {
      if (!auth.currentUser) { e.preventDefault(); showAuthModal(); return; }
    });

    /* ---------------- Profile ---------------- */
    profileBtn.addEventListener("click", async ()=> {
      if (!auth.currentUser) { showAuthModal(); return; }
      openProfile(auth.currentUser.uid, true);
    });
    profileClose.addEventListener("click", ()=> { profileModal.classList.remove("show"); profileModal.setAttribute("aria-hidden","true"); });

    async function openProfile(uid, self=false){
      profileContent.innerHTML = "<p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>";
      profileModal.classList.add("show"); profileModal.setAttribute("aria-hidden","false");
      try {
        const snap = await dbGet(dbRef(db, `users/${uid}`));
        const user = snap && snap.exists() ? snap.val() : { nick: "–ê–Ω–æ–Ω—ñ–º", avatar: DEFAULT_AVATAR };
        const isSelf = auth.currentUser && auth.currentUser.uid === uid;
        const email = user.email || "";

        profileContent.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center">
            <img src="${user.avatar || DEFAULT_AVATAR}" style="width:84px;height:84px;border-radius:12px;object-fit:cover">
            <div>
              <h3 style="margin:0 0 4px">${user.nick || "–ê–Ω–æ–Ω—ñ–º"}</h3>
              <div style="color:${email ? '#333':'#666'}">${email}</div>
            </div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            ${isSelf ? `
                <button id="editAvatarBtn" class="tab-button">–ó–º—ñ–Ω–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä (URL)</button>
                <button id="myDMsBtn" class="tab-button">–ú–æ—ó –õ–°</button>
                <button id="signOutBtn" class="tab-button" style="background:#ffe1e1">–í–∏–π—Ç–∏</button>
                <a class="tab-button" id="buyAdsBtn" href="mailto:urciknikolaj642@gmail.com?subject=–ü–æ–∫—É–ø–∫–∞%20—Ä–µ–∫–ª–∞–º–∏%20Praha%20Fu≈°ky">–ö—É–ø–∏—Ç–∏ —Ä–µ–∫–ª–∞–º—É</a>
              ` : `
                <button id="pmBtn" class="tab-button">–ù–∞–ø–∏—Å–∞—Ç–∏ –õ–°</button>
                <button id="addFriendBtn" class="tab-button">–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>
                <button id="reportBtn" class="tab-button" style="background:#ffe7c4">–ü–æ—Å–∫–∞—Ä–∂–∏—Ç–∏—Å—å</button>
              `}
          </div>
          <div id="profileMsg" style="margin-top:8px;color:#b91c1c"></div>
        `;

        if (isSelf){
          document.getElementById("editAvatarBtn").addEventListener("click", async ()=>{
            const url = prompt("–í—Å—Ç–∞–≤ URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∫–∏:");
            if (!url) return;
            try{
              await dbSet(dbRef(db, `users/${uid}/avatar`), url);
              await updateProfile(auth.currentUser, { photoURL: url });
              profileContent.querySelector('img').src = url;
              profileBtn.style.background = `url(${url}) center/cover`;
              notify("–ê–≤–∞—Ç–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ","–§–æ—Ç–æ –∑–º—ñ–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ URL.");
            }catch(e){ notify("–ü–æ–º–∏–ª–∫–∞","–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä"); }
          });
          document.getElementById("myDMsBtn").addEventListener("click", ()=> { profileModal.classList.remove("show"); setActiveTab("dmTab"); });
          document.getElementById("signOutBtn").addEventListener("click", async ()=> {
            try{ await dbRemove(dbRef(db, `presence/${auth.currentUser.uid}`)); }catch(e){}
            await signOut(auth);
            profileModal.classList.remove("show");
          });
        } else {
          document.getElementById("pmBtn").addEventListener("click", ()=> { profileModal.classList.remove("show"); openPrivateChat(uid); });
          document.getElementById("addFriendBtn").addEventListener("click", ()=> sendFriendRequest(uid));
          document.getElementById("reportBtn").addEventListener("click", ()=> notify("–°–∫–∞—Ä–≥–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞","–î—è–∫—É—î–º–æ, –º–∏ —Ä–æ–∑–≥–ª—è–Ω–µ–º–æ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è."));
        }
      } catch(e){ profileContent.innerHTML = "<p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</p>"; }
    }

    /* ---------------- Private chat ---------------- */
    function convoIdFor(uidA, uidB){ return uidA < uidB ? uidA + "_" + uidB : uidB + "_" + uidA; }

    async function openPrivateChat(otherUid){
      if (!auth.currentUser){ showAuthModal(); return; }
      const uid = auth.currentUser.uid;
      const cid = convoIdFor(uid, otherUid);

      const panel = document.createElement('div');
      panel.className = 'modal show'; panel.style.zIndex = 98;
      panel.innerHTML = `
        <div class="modal-panel">
          <button class="modal-close">‚úñ</button>
          <h3>–î—ñ–∞–ª–æ–≥</h3>
          <div id="dmThread" style="max-height:55vh;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px;margin-bottom:8px;background:#fafafa"></div>
          <div style="display:flex;gap:6px">
            <input id="dmText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd">
            <button id="dmSend" class="tab-button">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
          </div>
        </div>`;
      document.body.appendChild(panel);
      const closeBtn = panel.querySelector('.modal-close');
      closeBtn.addEventListener('click', ()=> panel.remove());

      const thread = panel.querySelector('#dmThread');
      const dmQ = query(dbRef(db, `privateMessages/${cid}`), orderByChild("ts"), limitToLast(200));
      onChildAdded(dmQ, (snap)=>{
        const m = snap.val();
        const row = document.createElement('div');
        row.style.margin = "6px 0";
        row.style.textAlign = m.from === uid ? "right" : "left";
        row.textContent = `${m.text}  (${new Date(m.ts).toLocaleTimeString()})`;
        thread.appendChild(row);
        thread.scrollTop = thread.scrollHeight;
      });

      panel.querySelector('#dmSend').addEventListener('click', async ()=>{
        const t = panel.querySelector('#dmText').value.trim();
        if (!t) return;
        const pm = { from: uid, to: otherUid, text: t, ts: Date.now() };
        await dbPush(dbRef(db, `privateMessages/${cid}`), pm);
        await dbPush(dbRef(db, `notifications/${otherUid}`), { ts: Date.now(), type:"dm", text:`–ù–æ–≤–µ –õ–° –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`, from: uid });
        panel.querySelector('#dmText').value = "";
      });
    }

    async function loadDMList(){
      const u = auth.currentUser; if (!u) { dmList.innerHTML = "<i>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –±–∞—á–∏—Ç–∏ –õ–°</i>"; return; }
      dmList.innerHTML = `<p>–í—ñ–¥–∫—Ä–∏–≤–∞–π—Ç–µ –õ–° —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ—ñ–ª—ñ –∞–±–æ –ø–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è—Ö üîî. (–î–ª—è —Å–ø–∏—Å–∫—É —Ä–æ–∑–º–æ–≤ –∫—Ä–∞—â–µ –∑–∞–≤–µ—Å—Ç–∏ conversations/${u.uid}).</p>`;
    }

    /* ---------------- Message menu ---------------- */
    function showMsgMenu(x,y,msg,wrap){
      msgMenu.style.left = x + "px"; msgMenu.style.top = y + "px"; msgMenu.style.display = "block";
      const hide = ()=> { msgMenu.style.display = "none"; document.removeEventListener("click", hide); };
      document.addEventListener("click", hide, { once:true });
      msgMenu.querySelectorAll('button').forEach(btn=>{
        btn.onclick = async ()=> {
          const act = btn.dataset.act;
          try {
            if (act === 'reply') {
              const r = prompt("–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:");
              if (r) {
                await dbPush(dbRef(db, "messages"), {
                  uid: auth.currentUser.uid,
                  nick: auth.currentUser.displayName || auth.currentUser.email,
                  avatar: auth.currentUser.photoURL || DEFAULT_AVATAR,
                  text: "‚Ü©Ô∏è –í—ñ–¥–ø–æ–≤—ñ–¥—å: " + r,
                  ts: Date.now(),
                  recipientUid: msg.uid
                });
              }
            } else {
              if (msg.id) {
                await dbSet(dbRef(db, `messageReactions/${msg.id}/${auth.currentUser.uid}`), { act, ts: Date.now() });
                await dbPush(dbRef(db, `notifications/${msg.uid}`), { ts: Date.now(), type:"reaction", text:`${act} –Ω–∞ –≤–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è`, from: auth.currentUser.uid });
                notify("–î—ñ—è –≤–∏–∫–æ–Ω–∞–Ω–∞", "–†–µ–∞–∫—Ü—ñ—é –∑–±–µ—Ä–µ–∂–µ–Ω–æ");
              } else notify("–ü–æ–º–∏–ª–∫–∞", "–ù–µ–º–∞—î id –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è");
            }
          } catch(e){ console.error(e); notify("–ü–æ–º–∏–ª–∫–∞ –¥—ñ—ó","–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑"); }
        };
      });
    }

    /* ---------------- Presence / online √ó10 ---------------- */
    function updateOnlineCount(){
      onValue(dbRef(db, "presence"), (snap)=>{
        const val = snap.val() || {};
        const real = Object.keys(val).length;
        const shown = real * 10;
        onlineNeon.textContent = `–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): ${shown}`;
      });
    }
    window.addEventListener('beforeunload', async ()=> {
      try{ if (auth.currentUser) await dbRemove(dbRef(db, `presence/${auth.currentUser.uid}`)); }catch(e){}
    });

    /* ---------------- Friends ---------------- */
    async function sendFriendRequest(toUid){
      if (!auth.currentUser) { showAuthModal(); return; }
      const from = auth.currentUser.uid;
      if (from === toUid) return;
      try{
        await dbSet(dbRef(db, `friendRequests/${toUid}/${from}`), { from, ts: Date.now() });
        await dbSet(dbRef(db, `friends/${from}/${toUid}`), { status:"requested", ts: Date.now(), fromUid: from });
        await dbPush(dbRef(db, `notifications/${toUid}`), { ts: Date.now(), type:"friend", text:`–ó–∞–ø–∏—Ç —É –¥—Ä—É–∑—ñ –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`, from });
        notify("–ó–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ","–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –æ—Ç—Ä–∏–º–∞—î —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è.");
      }catch(e){ notify("–ü–æ–º–∏–ª–∫–∞","–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞–ø–∏—Ç"); }
    }

    function friendCard(u, online){
      const div = document.createElement('div'); div.className = 'friend-card';
      div.innerHTML = `
        <img src="${u.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
        <div style="flex:1">
          <div style="font-weight:800">${u.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</div>
          <div style="font-size:12px;color:${online?'#10b981':'#64748b'}">${online?'–æ–Ω–ª–∞–π–Ω':'–æ—Ñ–ª–∞–π–Ω'}</div>
        </div>
        <div style="display:flex;gap:6px">
          <button class="tab-button btn-pm">‚úâÔ∏è</button>
          <button class="tab-button btn-open">üëÄ</button>
        </div>`;
      return div;
    }

    async function refreshFriendsBlocks(){
      const u = auth.currentUser;
      if (!u){ friendsList.innerHTML=""; friendRequests.innerHTML=""; friendsOnlineCountEl.textContent="0"; return; }

      // Requests to me
      const reqSnap = await dbGet(dbRef(db, `friendRequests/${u.uid}`));
      friendRequests.innerHTML = "";
      if (reqSnap.exists()){
        const reqs = reqSnap.val();
        for (const fromUid of Object.keys(reqs)){
          const uSnap = await dbGet(dbRef(db, `users/${fromUid}`));
          const ud = uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
          const item = document.createElement('div');
          item.className = 'friend-card';
          item.innerHTML = `
            <img src="${ud.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
            <div style="flex:1">
              <div style="font-weight:800">${ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</div>
              <div style="font-size:12px;color:#64748b">–∑–∞—è–≤–∫–∞ —É –¥—Ä—É–∑—ñ</div>
            </div>
            <div style="display:flex;gap:6px">
              <button class="tab-button btn-accept">‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏</button>
              <button class="tab-button btn-decline" style="background:#ffe1e1">‚úñ</button>
            </div>`;
          item.querySelector('.btn-accept').addEventListener('click', async ()=>{
            await dbSet(dbRef(db, `friends/${u.uid}/${fromUid}`), { status:"accepted", ts: Date.now() });
            await dbSet(dbRef(db, `friends/${fromUid}/${u.uid}`), { status:"accepted", ts: Date.now() });
            await dbRemove(dbRef(db, `friendRequests/${u.uid}/${fromUid}`));
            await dbPush(dbRef(db, `notifications/${fromUid}`), { ts: Date.now(), type:"friend", text:`${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'} –¥–æ–¥–∞–≤(–ª–∞) –≤–∞—Å —É –¥—Ä—É–∑—ñ`, from: u.uid });
            refreshFriendsBlocks();
          });
          item.querySelector('.btn-decline').addEventListener('click', async ()=>{
            await dbRemove(dbRef(db, `friendRequests/${u.uid}/${fromUid}`));
            await dbRemove(dbRef(db, `friends/${fromUid}/${u.uid}`));
            refreshFriendsBlocks();
          });
          friendRequests.appendChild(item);
        }
      } else {
        friendRequests.innerHTML = "<i>–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</i>";
      }

      // My friends
      friendsList.innerHTML = "";
      const frSnap = await dbGet(dbRef(db, `friends/${u.uid}`));
      let onlineCount = 0;
      if (frSnap.exists()){
        const fr = frSnap.val();
        for (const fid of Object.keys(fr)){
          const rel = fr[fid];
          if (rel.status !== "accepted") continue;
          const uSnap = await dbGet(dbRef(db, `users/${fid}`));
          const ud = uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
          const pSnap = await dbGet(dbRef(db, `presence/${fid}`));
          const isOnline = pSnap.exists();
          if (isOnline) onlineCount++;
          const card = friendCard(ud, isOnline);
          card.querySelector('.btn-open').addEventListener('click', ()=> openProfile(fid));
          card.querySelector('.btn-pm').addEventListener('click', ()=> openPrivateChat(fid));
          friendsList.appendChild(card);
        }
      } else {
        friendsList.innerHTML = "<i>–î–æ–¥–∞–π—Ç–µ –¥—Ä—É–∑—ñ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ—ñ–ª—ñ</i>";
      }
      friendsOnlineCountEl.textContent = String(onlineCount);
    }

    /* ---------------- Notifications (bell) ---------------- */
    function notify(title, text){
      const row = document.createElement('div');
      row.style.padding = "6px 8px"; row.style.borderBottom = "1px solid #eee";
      row.textContent = `${title}: ${text}`;
      notifList.prepend(row);
      let n = Number(bellBadge.dataset.n || "0") + 1;
      bellBadge.dataset.n = String(n);
      bellBadge.textContent = n;
      bellBadge.style.display = n>0 ? "inline-block":"none";
    }
    function subscribeNotifications(uid){
      onChildAdded(dbRef(db, `notifications/${uid}`), (snap)=>{
        const v = snap.val() || {};
        notify(v.type || "Info", v.text || "");
      });
    }
    bellBtn.addEventListener('click', ()=>{
      bellModal.classList.add("show");
      bellModal.setAttribute("aria-hidden","false");
      bellBadge.dataset.n = "0";
      bellBadge.style.display = "none";
    });
    bellClose.addEventListener('click', ()=>{
      bellModal.classList.remove("show"); bellModal.setAttribute("aria-hidden","true");
    });

    /* ---------------- Image resize helper ---------------- */
    function resizeImageFile(file, maxWidth = 900, quality = 0.8) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        reader.onload = (e) => {
          img.onload = () => {
            const scale = Math.min(1, maxWidth / img.width);
            const w = Math.round(img.width * scale);
            const h = Math.round(img.height * scale);
            const canvas = document.createElement('canvas');
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            resolve(dataUrl);
          };
          img.onerror = (err) => reject(err);
          img.src = e.target.result;
        };
        reader.onerror = (err) => reject(err);
        reader.readAsDataURL(file);
      });
    }

    /* ---------------- Bots controller ---------------- */
    const BOTS_DEF = [
      { id: 'bot_1', nick:"Bot_–û–≥–æ–ª–æ—à–µ–Ω–Ω—è_1", avatar:"https://i.ibb.co/LH4wBMS/IMG-d8e6076e17f19db7fe3add0754738a01-V.jpg",
        posts:[
          {text:`O2 –°–Ü–ú –ö–ê–†–¢–ê\n–ë–µ–∑ –ª—ñ–º—ñ—Ç —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç\n–ë–µ–∑ –ª—ñ–º—ñ—Ç –¥–∑–≤—ñ–Ω–∫–∏\n–ü—Ä–∞—Ü—é—î –≤ –Ñ–≤—Ä–æ–ø—ñ\n–ü–ª–∞—Ç–∞ 699 –∫—Ä–æ–Ω/–º—ñ—Å. –¶—ñ–Ω–∞ 299 –∫—Å. —Ç–µ–ª 607914467 (Viber/WhatsApp/Telegram)`, image:"https://i.ibb.co/LH4wBMS/IMG-d8e6076e17f19db7fe3add0754738a01-V.jpg"},
          {text:`–ü—Ä–æ–¥–∞—é iPhone 11 Pro Max + 26 —á–æ—Ö–ª—ñ–≤ (—á–æ—Ö–ª–∏ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ). –¢–µ–ª–µ—Ñ–æ–Ω –±–µ–∑ —Ç—Ä—ñ—â–∏–Ω, –Ω–µ –ø–∞–¥–∞–≤, –≤—Å–µ –æ—Ä–∏–≥—ñ–Ω–∞–ª, –±–µ–∑ Apple ID. –ü–∏—Ç–∞–Ω–Ω—è —É –ø—Ä–∏–≤–∞—Ç.`, image:"https://i.ibb.co/dwcXPqDr/IMG-1954f6b56869b9817a131ae33f3a37b6-V.jpg"},
          {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è`, image:"https://i.ibb.co/G3kDcrYZ/IMG-fa590121e46c5b030c5ddc94d4e8bea9-V.jpg"}
        ],
        baseInterval: 2*60*1000*1.6
      },
      { id: 'bot_2', nick:"Bot_–û–≥–æ–ª–æ—à–µ–Ω–Ω—è_2", avatar:"https://i.ibb.co/Z11WVrVC/IMG-b83692bb79a1468af74c81620750e8c0-V.jpg",
        posts:[
          {text:`–®–∞–±–ª–æ–Ω`, image:"https://i.ibb.co/Z11WVrVC/IMG-b83692bb79a1468af74c81620750e8c0-V.jpg"},
          {text:`–ó–∞–ø—Ä–æ—à—É—é –º–æ–¥–µ–ª–µ–π –Ω–∞ –ø–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω–∏–π –º–∞–∫—ñ—è–∂ (–ü—Ä–∞–≥–∞, 28.07 –æ 14:00). –¶—ñ–Ω–∞ ‚Äî –ª–∏—à–µ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏. –î–µ—Ç–∞–ª—ñ —É –ø—Ä–∏–≤–∞—Ç.`, image:"https://i.ibb.co/QFWDvGZ8/IMG-6748e7141906901b131b8fd5130a5c01-V.jpg"},
          {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è 3`, image:"https://i.ibb.co/j97RhTny/IMG-593d75b053ea1a28cdfb9fc52f93afad-V.jpg"}
        ],
        baseInterval: 3*60*1000*1.6
      },
      { id: 'bot_3', nick:"Bot_–û–≥–æ–ª–æ—à–µ–Ω–Ω—è_3", avatar:"https://i.ibb.co/MzdTMPR/IMG-8231d8142ffcbba7c682ca598683e3f2-V.jpg",
        posts:[
          {text:`–ù—É–∂–µ–Ω –≤–æ–¥–∏—Ç–µ–ª—å –¥–ª—è –ø–æ–º–æ—â–∏ –≤ –ø–µ—Ä–µ–µ–∑–¥–µ (—Å–æ —Å–≤–æ–∏–º –∞–≤—Ç–æ). WhatsApp: +48 793 463 757 ‚Ä¢ Telegram: @carlx_xxx`, image:null},
          {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è`, image:"https://i.ibb.co/MzdTMPR/IMG-8231d8142ffcbba7c682ca598683e3f2-V.jpg"},
          {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è 3`, image:"https://i.ibb.co/rfNV6ddC/IMG-0cd648a74f86227fe46db2d01c099be0-V.jpg"}
        ],
        baseInterval: 4*60*1000*1.6
      }
    ];

    const BotController = (() => {
      const timers = new Map();
      const indices = new Map();
      const speeds = new Map(); // multiplier per bot (default 1)

      function nextIndex(id, posts){
        const i = (indices.get(id) || 0);
        indices.set(id, i+1);
        return posts[i % posts.length];
      }

      async function post(bot){
        const p = nextIndex(bot.id, bot.posts);
        try {
          await dbPush(dbRef(db, "messages"), {
            uid: bot.id, nick: bot.nick, avatar: bot.avatar,
            text: p.text, image: p.image || null, ts: Date.now()
          });
        } catch(e){ console.error("bot push err", e); }
      }

      function isRunning(id){ return timers.has(id); }

      function computeInterval(bot){
        const mult = speeds.get(bot.id) || 1;
        const minMs = 15000; // safeguard –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª 15—Å
        return Math.max(minMs, bot.baseInterval / mult);
      }

      function start(bot){
        if (isRunning(bot.id)) return;
        const tick = async ()=>{ await post(bot); schedule(); };
        function schedule(){
          const ms = computeInterval(bot);
          const t = setTimeout(tick, ms);
          timers.set(bot.id, t);
          updateUIState(bot.id);
        }
        schedule();
      }

      function stop(id){
        const t = timers.get(id);
        if (t){ clearTimeout(t); timers.delete(id); updateUIState(id); }
      }

      function setSpeed(botId, mult){
        speeds.set(botId, mult);
        // —è–∫—â–æ –±–æ—Ç –ø—Ä–∞—Ü—é—î ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç–∞–π–º–µ—Ä –∑ –Ω–æ–≤–∏–º —ñ–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
        if (timers.has(botId)){
          clearTimeout(timers.get(botId));
          timers.delete(botId);
          const bot = BOTS_DEF.find(b=>b.id===botId);
          if (bot) start(bot);
        }
        updateUIState(botId);
      }

      function postOnce(bot){ return post(bot); }

      function stopAll(){ Array.from(timers.keys()).forEach(stop); }
      function startAll(){ BOTS_DEF.forEach(start); }
      function postOnceAll(){ return Promise.all(BOTS_DEF.map(postOnce)); }

      function getSpeed(id){ return speeds.get(id) || 1; }

      function updateUIState(id){
        const chip = document.querySelector(`[data-bot='${id}']`);
        if (!chip) return;
        const running = isRunning(id);
        chip.querySelector('.state').textContent = running ? '‚óè –ø—Ä–∞—Ü—é—î' : '‚óã –∑—É–ø–∏–Ω–µ–Ω–æ';
        chip.querySelector('.toggle').textContent = running ? '‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏' : '‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏';
      }

      return { start, stop, setSpeed, isRunning, postOnce, stopAll, startAll, postOnceAll, getSpeed };
    })();

    function buildBotChip(bot){
      const wrap = document.createElement('div');
      wrap.className = 'admin-chip';
      wrap.dataset.bot = bot.id;
      wrap.innerHTML = `
        <img src="${bot.avatar}" style="width:26px;height:26px;border-radius:6px;object-fit:cover"> 
        <b>${bot.nick}</b>
        <span class="state" style="font-size:12px;opacity:.8">‚óã –∑—É–ø–∏–Ω–µ–Ω–æ</span>
        <button class="toggle tab-button" style="padding:6px 10px">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏</button>
        <button class="once tab-button" style="padding:6px 10px;background:#fff3cd">‚ö°Ô∏è –†–∞–∑</button>
        <label style="font-size:12px">—à–≤–∏–¥–∫. <input type="range" min="0.5" max="3" step="0.1" value="1" class="speed"></label>
        <span class="speedv" style="font-size:12px">1√ó</span>
      `;
      const toggle = wrap.querySelector('.toggle');
      const once = wrap.querySelector('.once');
      const range = wrap.querySelector('.speed');
      const speedv = wrap.querySelector('.speedv');

      toggle.addEventListener('click', ()=>{
        if (BotController.isRunning(bot.id)) BotController.stop(bot.id); else BotController.start(bot);
      });
      once.addEventListener('click', ()=> BotController.postOnce(bot));
      range.addEventListener('input', ()=>{
        const v = Number(range.value);
        speedv.textContent = v.toFixed(1) + '√ó';
        BotController.setSpeed(bot.id, v);
        localStorage.setItem('bot_speed_'+bot.id, String(v));
      });
      // restore saved speed
      const saved = Number(localStorage.getItem('bot_speed_'+bot.id) || '1');
      if (!Number.isNaN(saved) && saved){ range.value = String(saved); speedv.textContent = saved.toFixed(1)+'√ó'; BotController.setSpeed(bot.id, saved); }
      return wrap;
    }

    function initAdminUI(){
      // floating bar
      botsRow.innerHTML = '';
      BOTS_DEF.forEach(bot=> botsRow.appendChild(buildBotChip(bot)));
      startAllBtn.onclick = ()=> BotController.startAll();
      stopAllBtn.onclick = ()=> BotController.stopAll();
      postOnceAllBtn.onclick = ()=> BotController.postOnceAll();

      // admin modal duplicate controls (optional)
      adminBots.innerHTML = '';
      BOTS_DEF.forEach(bot=> adminBots.appendChild(buildBotChip(bot)));

      gearBtn.onclick = ()=>{ adminModal.classList.add('show'); adminModal.setAttribute('aria-hidden','false'); };
      adminClose.onclick = ()=>{ adminModal.classList.remove('show'); adminModal.setAttribute('aria-hidden','true'); };

      // —è–∫—â–æ —á–∞—Ç –ø–æ—Ä–æ–∂–Ω—ñ–π ‚Äî –ø–æ–∫–∞–∂–µ–º–æ –ø—ñ–¥–∫–∞–∑–∫—É –∞–¥–º—ñ–Ω–∞ (—Ä–∞–∑–æ–≤–∏–π –ø–æ—Å—Ç —É—Å—ñ–º –±–æ—Ç–∞–º)
      setTimeout(()=>{
        if (!messagesEl.firstChild){
          notify('–ü—ñ–¥–∫–∞–∑–∫–∞', '–ß–∞—Ç –ø–æ—Ä–æ–∂–Ω—ñ–π. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ ‚öôÔ∏è —â–æ–± –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∞–±–æ ‚ö°Ô∏è –¥–æ–¥–∞—Ç–∏ –ø–µ—Ä—à—ñ –ø–æ—Å—Ç–∏ –±–æ—Ç—ñ–≤.');
        }
      }, 600);
    }

    /* ---------------- Map with icons + guarded init ---------------- */
    const POINTS = [
      { title: "Nemocnice Motol", pos: {lat:50.058, lng:14.360}, cat:"hospital", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png" },
      { title: "Nemocnice Na Frantisku", pos: {lat:50.086, lng:14.418}, cat:"hospital", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png" },
      { title: "Klinika Praha", pos: {lat:50.078, lng:14.422}, cat:"hospital", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png" },
      { title: "Pravni pomoc —Ü–µ–Ω—Ç—Ä A", pos: {lat:50.083, lng:14.412}, cat:"lawyer", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png" },
      { title: "Pravni pomoc —Ü–µ–Ω—Ç—Ä B", pos: {lat:50.089, lng:14.430}, cat:"lawyer", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png" },
      { title: "Advokatni kancelar C", pos: {lat:50.071, lng:14.425}, cat:"lawyer", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png" },
      { title: "Albert Supermarket", pos: {lat:50.084, lng:14.417}, cat:"shop", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/yellow-dot.png" },
      { title: "Billa City", pos: {lat:50.076, lng:14.437}, cat:"shop", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/yellow-dot.png" },
      { title: "Kaufland Praha", pos: {lat:50.085, lng:14.414}, cat:"shop", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/yellow-dot.png" },
      { title: "Pomoc Centrum 1", pos: {lat:50.082, lng:14.419}, cat:"help", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/ltblue-dot.png" },
      { title: "Pomoc Centrum 2", pos: {lat:50.088, lng:14.427}, cat:"help", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/ltblue-dot.png" },
      { title: "Shelter Point", pos: {lat:50.074, lng:14.432}, cat:"help", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/ltblue-dot.png" },
      { title: "Clinic D", pos: {lat:50.090, lng:14.418}, cat:"hospital", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png" },
      { title: "Clinic E", pos: {lat:50.079, lng:14.404}, cat:"hospital", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png" },
      { title: "Law Office D", pos: {lat:50.081, lng:14.440}, cat:"lawyer", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png" },
      { title: "Shop D", pos: {lat:50.083, lng:14.445}, cat:"shop", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/yellow-dot.png" },
      { title: "Shop E", pos: {lat:50.0715, lng:14.421}, cat:"shop", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/yellow-dot.png" }
    ];

    let map, markers=[];
    function initMap(){
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat:50.0755, lng:14.4378}, zoom: 12, mapTypeControl:false, streetViewControl:false
      });
      markers = POINTS.map(p=> new google.maps.Marker({ position:p.pos, title:p.title, icon:p.icon, map }));
    }
    window.initMap = initMap;

    mapSearch.addEventListener('input', ()=>{
      const q = mapSearch.value.toLowerCase();
      markers.forEach((m, idx)=>{
        const p = POINTS[idx];
        const show = p.title.toLowerCase().includes(q) || p.cat.toLowerCase().includes(q);
        m.setVisible(show);
      });
    });
    centerBtn.addEventListener('click', ()=>{ if (map) map.setCenter({lat:50.0755,lng:14.4378}); });

    /* ---------------- Admin gear button ---------------- */
    gearBtn.addEventListener('click', ()=>{ if (isAdmin){ adminModal.classList.add('show'); adminModal.setAttribute('aria-hidden','false'); }});

  </script>
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9tOqK-Ze3F8MeAIzirty8o4e7WZk3w3A&callback=initMap"></script>

  <!-- subscription & payment modal -->
  <div id="payModal" class="modal" aria-hidden="true">
    <div class="modal-panel" role="dialog" aria-modal="true">
      <button class="modal-close" id="payClose">‚úñ</button>
      <h3>–ü—ñ–¥–ø–∏—Å–∫–∞ ‚Ä¢ 100 Kƒç/–º—ñ—Å</h3>
      <p style="margin-top:0">–û–ø–ª–∞—á—É–π—Ç–µ –Ω–∞ —Ä–∞—Ö—É–Ω–æ–∫ <b>354037257/0300</b>. –ü—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å —Ñ–æ—Ç–æ –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó. –ë–æ—Ç –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å —Ç–µ–∫—Å—Ç —ñ –∞–∫—Ç–∏–≤—É—î –ø—ñ–¥–ø–∏—Å–∫—É.</p>
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
        <input id="payFile" type="file" accept="image/*" />
        <button id="payOcrBtn" class="tab-button">üì∑ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ñ–æ—Ç–æ</button>
      </div>
      <div id="payOcrStatus" style="font-size:13px;color:#111;background:#f6f6f6;border:1px solid #eee;border-radius:8px;padding:8px;min-height:60px"></div>
      <div style="margin-top:10px">
        <button id="activateMonthBtn" class="tab-button" style="display:none;background:#10b981;color:#fff">‚úÖ –ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –Ω–∞ –º—ñ—Å—è—Ü—å</button>
      </div>
    </div>
  </div>

  <script type="module">
    // --- Quotas & Subscription constants ---
    const PRICE_CZK = 100;
    const BANK_ACCOUNT = "354037257/0300";
    const FREE_LIMIT_TEXT = 200;     // 200 –ø—Ä–æ—Å—Ç–∏—Ö –°–ú–°
    const FREE_LIMIT_MEDIA = 100;    // 100 –°–ú–° –∑ —Ñ–æ—Ç–æ

    // DB helpers reuse existing 'db' from main module
    const usageRef = (uid)=> dbRef(db, `usage/${uid}`);
    const subsRef  = (uid)=> dbRef(db, `subscriptions/${uid}`);
    let _usageCache = null;
    let _subsCache = null;
    let _expectingType = null;
    let _expectingSince = 0;

    function fmtDaysLeft(ts){
      const ms = ts - Date.now();
      if (ms <= 0) return "–∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—å";
      const days = Math.ceil(ms / (24*60*60*1000));
      return days + " –¥–Ω.";
    }

    async function readUsage(uid){
      try{
        const snap = await dbGet(usageRef(uid));
        _usageCache = snap.exists()? snap.val(): { textCount:0, photoCount:0 };
      }catch(e){ _usageCache = { textCount:0, photoCount:0 }; }
      return _usageCache;
    }

    async function readSubs(uid){
      try{
        const snap = await dbGet(subsRef(uid));
        _subsCache = snap.exists()? snap.val(): { activeUntil:0 };
      }catch(e){ _subsCache = { activeUntil:0 }; }
      return _subsCache;
    }

    async function writeUsage(uid, nu){
      try{ await dbSet(usageRef(uid), nu); }catch(e){ console.error("usage write", e); }
    }
    async function writeSubs(uid, nv){
      try{ await dbSet(subsRef(uid), nv); }catch(e){ console.error("subs write", e); }
    }

    // Override quota text UI whenever auth changes
    const quotaTextEl = document.getElementById("quotaText");
    const openPayBtn = document.getElementById("openPayBtn");
    const payModal = document.getElementById("payModal");
    const payClose = document.getElementById("payClose");
    const payFile = document.getElementById("payFile");
    const payOcrBtn = document.getElementById("payOcrBtn");
    const payOcrStatus = document.getElementById("payOcrStatus");
    const activateMonthBtn = document.getElementById("activateMonthBtn");

    openPayBtn?.addEventListener("click", ()=>{ payModal.classList.add("show"); payModal.setAttribute("aria-hidden","false"); });
    payClose?.addEventListener("click", ()=>{ payModal.classList.remove("show"); payModal.setAttribute("aria-hidden","true"); });

    // OCR flow with Tesseract: look for the phrase + account
    async function runOCR(file){
      if (!file){ payOcrStatus.textContent = "–î–æ–¥–∞–π—Ç–µ —Ñ–æ—Ç–æ –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó."; return; }
      payOcrStatus.textContent = "–†–æ–∑–ø—ñ–∑–Ω–∞—é —Ç–µ–∫—Å—Ç‚Ä¶";
      try{
        const { createWorker } = Tesseract;
        const worker = await createWorker();
        const { data: { text } } = await worker.recognize(file);
        await worker.terminate();
        payOcrStatus.textContent = "–†–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ:\n" + text;
        const ph1 = /–ø–ª–∞—Ç[–µ—ë]–∂\s+–ø–æ–¥—Ç–≤–µ—Ä–∂–¥[–µ—ë]–Ω –º–æ–µ–π —Ä–µ–∫–≤–∏–∑–∏—Ç[–∞—ã–∏]/i;
        const okPhrase = ph1.test(text);
        const okAcc = text.includes("354037257/0300") || /3540\s*37257\s*\/\s*0300/.test(text);
        if (okPhrase && okAcc){
          payOcrStatus.textContent += "\n‚úÖ –ó–±—ñ–≥ –∑–Ω–∞–π–¥–µ–Ω–æ. –ú–æ–∂–Ω–∞ –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å–∫—É.";
          activateMonthBtn.style.display = "inline-flex";
        } else {
          payOcrStatus.textContent += "\n‚ö†Ô∏è –§—Ä–∞–∑–∞ –∞–±–æ —Ä–∞—Ö—É–Ω–æ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ. –í–∏ –º–æ–∂–µ—Ç–µ –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –≤—Ä—É—á–Ω—É —á–µ—Ä–µ–∑ –∞–¥–º—ñ–Ω–∞.";
          activateMonthBtn.style.display = "none";
        }
      }catch(e){
        console.error(e);
        payOcrStatus.textContent = "–ü–æ–º–∏–ª–∫–∞ OCR. –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–µ —Ñ–æ—Ç–æ.";
        activateMonthBtn.style.display = "none";
      }
    }
    payOcrBtn?.addEventListener("click", ()=> runOCR(payFile.files?.[0]));

    activateMonthBtn?.addEventListener("click", async ()=>{
      if (!auth.currentUser) { notify("–ü–æ—Ç—Ä—ñ–±–µ–Ω –≤—Ö—ñ–¥","–£–≤—ñ–π–¥—ñ—Ç—å —É –ø—Ä–æ—Ñ—ñ–ª—å"); return; }
      const uid = auth.currentUser.uid;
      const now = Date.now();
      const base = _subsCache?.activeUntil && _subsCache.activeUntil > now ? _subsCache.activeUntil : now;
      const monthMs = 30*24*60*60*1000;
      const nv = { activeUntil: base + monthMs, lastProofTs: now };
      await writeSubs(uid, nv);
      notify("–ü—ñ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∞", "–î—è–∫—É—î–º–æ! –î—ñ–π—Å–Ω–∞ –¥–æ: " + new Date(nv.activeUntil).toLocaleDateString());
      renderQuotaUI(); // refresh
      payModal.classList.remove("show"); payModal.setAttribute("aria-hidden","true");
    });

    async function renderQuotaUI(){
      const u = auth.currentUser;
      if (!u){ quotaTextEl.textContent = "–ì—ñ—Å—Ç—å: —É–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–∏—Å–∞—Ç–∏"; return; }
      const [usg, sub] = await Promise.all([readUsage(u.uid), readSubs(u.uid)]);
      const active = sub.activeUntil && sub.activeUntil > Date.now();
      const leftText = Math.max(0, FREE_LIMIT_TEXT - (usg.textCount||0));
      const leftPhoto = Math.max(0, FREE_LIMIT_MEDIA - (usg.photoCount||0));
      quotaTextEl.textContent = active
        ? `–ü—ñ–¥–ø–∏—Å–∫–∞: ${fmtDaysLeft(sub.activeUntil)} –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è`
        : `–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ –∑–∞–ª–∏—à–∏–ª–æ—Å—å: —Ç–µ–∫—Å—Ç ${leftText} / —Ñ–æ—Ç–æ ${leftPhoto}. –ü—ñ—Å–ª—è –ª—ñ–º—ñ—Ç—ñ–≤ ‚Äî 100 Kƒç/–º—ñ—Å –Ω–∞ ${BANK_ACCOUNT}`;
    }

    onAuthStateChanged(auth, async ()=>{
      // refresh quota bar once user changes
      renderQuotaUI();
    });

    // --- Quota-aware send gate ---
    async function canSendByQuota(){
      const u = auth.currentUser;
      if (!u) return false;
      const [usg, sub] = await Promise.all([readUsage(u.uid), readSubs(u.uid)]);
      const active = sub.activeUntil && sub.activeUntil > Date.now();
      if (active) return true;

      const hasFile = !!(document.getElementById('fileInput')?.files?.[0]);
      if (hasFile){
        const leftPhoto = Math.max(0, FREE_LIMIT_MEDIA - (usg.photoCount||0));
        if (leftPhoto <= 0){
          notify("–õ—ñ–º—ñ—Ç –≤–∏—á–µ—Ä–ø–∞–Ω–æ", `–§–æ—Ç–æ/–°–ú–°: 100 —ñ–∑ 100. –û—Ñ–æ—Ä–º—ñ—Ç—å –ø—ñ–¥–ø–∏—Å–∫—É –∑–∞ ${PRICE_CZK} Kƒç –Ω–∞ ${BANK_ACCOUNT}.`);
          return false;
        }
        _expectingType = "photo";
      } else {
        const leftText = Math.max(0, FREE_LIMIT_TEXT - (usg.textCount||0));
        if (leftText <= 0){
          notify("–õ—ñ–º—ñ—Ç –≤–∏—á–µ—Ä–ø–∞–Ω–æ", `–¢–µ–∫—Å—Ç–æ–≤—ñ –°–ú–°: 200 —ñ–∑ 200. –û—Ñ–æ—Ä–º—ñ—Ç—å –ø—ñ–¥–ø–∏—Å–∫—É –∑–∞ ${PRICE_CZK} Kƒç –Ω–∞ ${BANK_ACCOUNT}.`);
          return false;
        }
        _expectingType = "text";
      }
      _expectingSince = Date.now() - 2500; // tolerate a tiny clock skew
      return true;
    }

    // Replace/override the earlier canSendMessage() with quota logic + original 6h rule
    const _sixHours = 6 * 60 * 60 * 1000;
    window.canSendMessage = async function(){
      const user = auth.currentUser;
      if (!user) return false;
      // 6h rule from the original implementation
      if (user.emailVerified){
        // ok for email-verified, proceed to quota
      } else {
        const localKey = "regTime_" + user.uid;
        const localVal = localStorage.getItem(localKey);
        if (localVal && (Date.now() - Number(localVal) < _sixHours)){
          // allowed within 6h grace
        } else {
          try {
            const snap = await dbGet(dbRef(db, `users/${user.uid}/createdAt`));
            if (snap && snap.exists()) {
              const created = Number(snap.val());
              if (!Number.isNaN(created) && Date.now() - created < _sixHours) {
                localStorage.setItem(localKey, String(created));
              } else {
                notify("–ü–æ—Ç—Ä—ñ–±–Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email", "6 –≥–æ–¥–∏–Ω –¥–æ—Å—Ç—É–ø—É –∑–∞–∫—ñ–Ω—á–∏–ª–∏—Å—è. –ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å email –∞–±–æ –æ—Ñ–æ—Ä–º—ñ—Ç—å –ø—ñ–¥–ø–∏—Å–∫—É.");
                return false;
              }
            } else {
              notify("–ü–æ—Ç—Ä—ñ–±–Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email", "–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å email –∞–±–æ –æ—Ñ–æ—Ä–º—ñ—Ç—å –ø—ñ–¥–ø–∏—Å–∫—É.");
              return false;
            }
          } catch(e){
            console.error(e);
            notify("–ü–æ–º–∏–ª–∫–∞", "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥–æ—Å—Ç—É–ø. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ.");
            return false;
          }
        }
      }
      // Quota gate
      const ok = await canSendByQuota();
      if (!ok) return false;
      return true;
    };

    // After message actually appears in the chat (from our uid), increment usage once
    function postSendWatcher(m){
      try{
        if (!auth.currentUser) return;
        if (m.uid !== auth.currentUser.uid) return;
        if (!_expectingType) return;
        if (!m.ts || m.ts < _expectingSince) return;
        const isPhoto = !!m.image;
        const type = _expectingType;
        // Clear expectation so we don't double-count
        _expectingType = null;
        _expectingSince = 0;
        // Update usage in DB (serverless)
        (async ()=>{
          const u = await readUsage(auth.currentUser.uid);
          const nu = { textCount: u.textCount||0, photoCount: u.photoCount||0 };
          if (type === "photo" || isPhoto) nu.photoCount += 1;
          else nu.textCount += 1;
          await writeUsage(auth.currentUser.uid, nu);
          renderQuotaUI();
        })();
      }catch(e){ console.error(e); }
    }

    // Hook into existing stream renders (messages + rentMessages)
    const _origRenderMain = (snap)=>{ try{ const m = snap.val(); m.id = snap.key; postSendWatcher(m);}catch(e){} };
    const _origRenderRent = (snap)=>{ try{ const m = snap.val(); m.id = snap.key; postSendWatcher(m);}catch(e){} };

    // Attach lightweight listeners (do not re-render, original handlers already render)
    onChildAdded(dbRef(db, "messages"), _origRenderMain);
    onChildAdded(dbRef(db, "rentMessages"), _origRenderRent);

    // --- Admin tools: delete message + ban user (lightweight) ---
    function attachAdminActions(){
      if (!isAdmin) return;
      // Add global delegation for delete/ban on message content
      document.addEventListener('click', async (e)=>{
        const btn = e.target.closest('[data-admin-act]');
        if (!btn) return;
        const act = btn.dataset.adminAct;
        const msgid = btn.dataset.msgid;
        const uid = btn.dataset.uid;
        if (act === 'del' && msgid){
          await dbRemove(dbRef(db, `messages/${msgid}`));
          notify("–í–∏–¥–∞–ª–µ–Ω–æ","–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–µ");
        }
        if (act === 'ban' && uid){
          await dbSet(dbRef(db, `bans/${uid}`), { ts: Date.now(), by: auth.currentUser.uid });
          notify("–ë–∞–Ω","–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞–±–∞–Ω–µ–Ω–æ");
        }
      });
    }

    // Extend existing render to show small admin buttons
    const _messages = document.getElementById("messages");
    const _rentMessages = document.getElementById("rentMessages");
    const observer = new MutationObserver(()=>{
      if (!isAdmin) return;
      document.querySelectorAll('.message').forEach(wrap=>{
        if (wrap.dataset._admInit) return;
        wrap.dataset._admInit = "1";
        const uid = wrap.dataset.uid || "";
        const msgid = wrap.dataset.msgid || "";
        const host = wrap.querySelector('.message-content .msg-actions');
        if (host){
          const span = document.createElement('span');
          span.innerHTML = `
            <button data-admin-act="del" data-msgid="${msgid}" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</button>
            <button data-admin-act="ban" data-uid="${uid}" title="–ë–∞–Ω">‚õî</button>
          `;
          host.appendChild(span);
        }
      });
    });
    observer.observe(_messages, { childList:true, subtree:true });
    observer.observe(_rentMessages, { childList:true, subtree:true });
    attachAdminActions();

    // --- Hard gate: prevent banned users from sending
    async function checkBan(uid){
      try{ const s = await dbGet(dbRef(db, `bans/${uid}`)); return s.exists(); }catch(e){ return false; }
    }
    // Override sendButton click to add ban check prior to original handler (capture phase)
    const _sendBtn = document.getElementById("sendButton");
    _sendBtn.addEventListener('click', async (ev)=>{
      if (!auth.currentUser) return; // original handler will open auth
      const banned = await checkBan(auth.currentUser.uid);
      if (banned){
        ev.stopImmediatePropagation();
        ev.preventDefault();
        notify("–ë–∞–Ω", "–í–∏ –∑–∞–±–∞–Ω–µ–Ω—ñ. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.");
      }
    }, true);

    // Initial render of quota bar
    renderQuotaUI();
  </script>

</body>
</html>
