<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–ü–†–ê–ì–ê –§–£–®–ö–ò ‚Äî —á–∞—Ç —Å–ø—ñ–ª—å–Ω–æ—Ç–∏</title>
  <style>
    :root{
      --bg:#0b0f16;
      --glass: rgba(255,255,255,0.08);
      --glass2: rgba(255,255,255,0.12);
      --text:#e8eef7;
      --muted:#9fb0c7;
      --brand:#26c6da;
      --accent:#ffd166;
      --danger:#ff6b6b;
      --success:#10b981;
      --card:#111827bb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background:
        linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.7)),
        url('https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=2070&auto=format&fit=crop') center/cover fixed no-repeat;
      backdrop-filter:saturate(120%) blur(0.2px);
    }
    a{color:var(--brand);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{
      display:grid;grid-template-rows:auto auto 1fr auto;min-height:100vh;
      gap:10px;padding:10px 10px 18px;max-width:1100px;margin:0 auto;
    }
    header{
      display:flex;align-items:center;justify-content:space-between;
      background:var(--glass);border:1px solid rgba(255,255,255,.15);border-radius:14px;
      padding:10px 12px;box-shadow:0 4px 18px rgba(0,0,0,.25);
    }
    .logo{
      display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:1px;
      text-shadow:0 3px 0 rgba(0,0,0,.38), 0 0 18px rgba(255,255,255,.08);
      user-select:none
    }
    .logo .goth{
      font-family: "UnifrakturMaguntia", "Cinzel", Georgia, serif;
      font-size:28px;
      position:relative;
      display:inline-block;
    }
    .logo .goth span{
      position:relative;display:inline-block;margin-right:2px
    }
    .logo .goth span::after{
      content:"";position:absolute;left:2px;top:55%;
      width:100%;height:40%;filter:blur(3px);
      box-shadow:0 14px 0 rgba(0,0,0,.55);
      transform:skewX(-8deg);
    }
    .online-chip{font-size:12px;padding:4px 8px;border-radius:999px;background:var(--glass2);border:1px solid rgba(255,255,255,.12)}
    .hdr-actions{display:flex;gap:8px;align-items:center}
    .btn{border:1px solid rgba(255,255,255,.16);background:var(--glass2);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,.18)}
    .btn.small{padding:6px 10px;font-size:12px}
    .avatar-btn{width:36px;height:36px;border-radius:10px;background:#ffffff22;border:1px solid #ffffff33;overflow:hidden;cursor:pointer}
    .avatar-btn img{width:100%;height:100%;object-fit:cover}
    nav.tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:var(--glass);cursor:pointer}
    .tab.active{background:linear-gradient(180deg,#1f2937cc,#111827cc);border-color:#3b82f680}
    .main{
      display:grid;grid-template-columns:1.15fr .85fr;gap:10px;
    }
    .card{
      background:var(--card);border:1px solid rgba(255,255,255,.12);border-radius:14px;
      box-shadow:0 8px 32px rgba(0,0,0,.35);
      overflow:hidden;min-height:240px
    }
    .section-head{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.03)}
    .section-title{font-weight:800;letter-spacing:.3px}
    .chat-area{height:52vh;overflow:auto;padding:10px;scroll-behavior:smooth}
    .message{display:flex;gap:10px;margin:10px 0}
    .message.self{flex-direction:row-reverse}
    .avatar{width:36px;height:36px;border-radius:10px;object-fit:cover;border:1px solid rgba(255,255,255,.2)}
    .message-content{flex:1;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);padding:8px 10px;border-radius:12px;position:relative}
    .message-meta{font-size:11px;color:var(--muted);margin-bottom:6px}
    .text{white-space:pre-wrap;line-height:1.35}
    .chat-image{max-width:100%;border-radius:10px;margin-top:6px;border:1px solid rgba(255,255,255,.1)}
    .msg-actions{position:absolute;right:6px;bottom:6px;opacity:.85}
    .msg-actions button{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.2);color:#f6f6f6;border-radius:8px;padding:2px 6px;cursor:pointer}
    .input-bar{display:flex;gap:8px;padding:10px;border-top:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.03)}
    .input-bar textarea{flex:1;min-height:42px;max-height:120px;resize:vertical;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.25);color:var(--text);padding:10px}
    .icon-btn{width:42px;height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);cursor:pointer}
    .icon-btn:hover{background:rgba(255,255,255,.12)}
    .right-col .block{margin-bottom:10px}
    #map{width:100%;height:34vh}
    .filters{display:flex;gap:6px;padding:8px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);cursor:pointer;font-size:12px}
    .pill.active{background:rgba(38,198,218,.2);border-color:#26c6da80}
    .hint{font-size:13px;color:var(--muted);padding:8px 10px}
    /* Notifications */
    .bell{position:relative}
    .badge{position:absolute;top:-6px;right:-6px;background:#ef4444;color:white;border-radius:999px;padding:2px 6px;font-size:11px;display:none}
    /* Modals */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;backdrop-filter:blur(2px)}
    .modal.show{display:flex}
    .modal-panel{width:min(720px,92vw);max-height:82vh;overflow:auto;background:var(--card);border:1px solid rgba(255,255,255,.15);border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.5);padding:14px}
    .modal-close{float:right;border:none;background:transparent;font-size:20px;color:#cbd5e1;cursor:pointer}
    /* Friends & DMs (no black text) */
    .friend-card{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);padding:8px;border-radius:12px;margin:6px 0}
    .friend-card .tab-button{background:rgba(255,255,255,.08);color:var(--text);border:1px solid rgba(255,255,255,.16)}
    .tab-button{border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.08);padding:8px 12px;border-radius:10px;color:var(--text);cursor:pointer}
    .tab-button:hover{background:rgba(255,255,255,.12)}
    /* Bots floating bar (collapsible) */
    .bots-float{position:fixed;left:12px;bottom:12px;background:rgba(17,24,39,.92);border:1px solid rgba(255,255,255,.12);border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.45);padding:8px;z-index:97;max-width:92vw}
    .bots-row{display:flex;gap:8px;flex-wrap:wrap}
    .admin-chip{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);padding:6px 8px;border-radius:12px}
    .bots-toggle{display:flex;align-items:center;gap:6px;margin-bottom:6px}
    .bots-collapsed .bots-row{display:none}
    .bots-collapsed{opacity:.8}
    /* Message menu */
    #msgMenu{position:fixed;display:none;background:var(--card);border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:6px;z-index:99}
    #msgMenu button{display:block;width:100%;text-align:left;padding:6px 10px;background:transparent;border:none;color:var(--text);cursor:pointer}
    #msgMenu button:hover{background:rgba(255,255,255,.08)}
  </style>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.googleapis.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=UnifrakturMaguntia&display=swap" rel="stylesheet">
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <div class="goth" aria-label="–ü—Ä–∞–≥–∞ –§—É—à–∫–∏">
          <span>–ü</span><span>–†</span><span>–ê</span><span>–ì</span><span>–ê</span>
          &nbsp; <span>–§</span><span>–£</span><span>–®</span><span>–ö</span><span>–ò</span>
        </div>
        <div class="online-chip" id="onlineNeon">–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): 0</div>
      </div>
      <nav class="tabs" role="tablist" aria-label="–ù–∞–≤—ñ–≥–∞—Ü—ñ—è">
        <button class="tab active" data-tab="chatTab">–ß–∞—Ç</button>
        <button class="tab" data-tab="rentTab">–ß–∞—Ç –û—Ä–µ–Ω–¥–∞</button>
        <button class="tab" data-tab="mapTab">–ö–∞—Ä—Ç–∞</button>
        <button class="tab" data-tab="helpTab">–î–æ–ø–æ–º–æ–≥–∞</button>
        <button class="tab" data-tab="friendsTab">–î—Ä—É–∑—ñ</button>
        <button class="tab" data-tab="dmTab">–û—Å–æ–±–∏—Å—Ç—ñ</button>
      </nav>
      <div class="hdr-actions">
        <div class="bell">
          <button id="bellBtn" class="btn small">üîî</button>
          <span id="bellBadge" class="badge">0</span>
        </div>
        <button id="gearBtn" class="btn small">‚öôÔ∏è</button>
        <button id="profileBtn" class="avatar-btn" title="–ü—Ä–æ—Ñ—ñ–ª—å"><img id="profileAvatar" src="https://i.imgur.com/6VBx3io.png" alt=""></button>
      </div>
    </header>

    <div id="hintBar" class="card">
      <div class="section-head">
        <div class="section-title">–ü—Ä–∞–≥–∞ –§—É—à–∫–∏ ‚Äî –ø—Ä–∞–≤–∏–ª–∞ —Ç–∞ –ø–æ—Ä–∞–¥–∏</div>
      </div>
      <div class="hint">
        –Ø–∫—â–æ –≤–∏ –≤–ø–µ—Ä—à–µ ‚Äî –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏¬ª –≤–Ω–∏–∑—É —á–∞—Ç—É ‚Äî –∑'—è–≤–∏—Ç—å—Å—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è.
        6 –≥–æ–¥–∏–Ω –¥–æ—Å—Ç—É–ø—É –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email. –ö–Ω–æ–ø–∫–∏ –Ω–∏–∂—á–µ ‚Äî —à–≤–∏–¥–∫–∏–π –¥–æ—Å—Ç—É–ø:
      </div>
      <div class="filters" role="group" aria-label="–®–≤–∏–¥–∫—ñ –¥—ñ—ó">
        <button id="quickChat" class="pill">–í —á–∞—Ç</button>
        <button id="quickRent" class="pill">–í –æ—Ä–µ–Ω–¥—É</button>
        <button id="quickHelp" class="pill">–í –¥–æ–ø–æ–º–æ–≥—É</button>
      </div>
    </div>

    <main class="main">
      <section class="card" id="chatTab">
        <div class="section-head"><div class="section-title">–ó–∞–≥–∞–ª—å–Ω–∏–π —á–∞—Ç</div></div>
        <div class="chat-area" id="chatArea" aria-live="polite"></div>
        <div class="input-bar">
          <textarea id="messageInput" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è‚Ä¶"></textarea>
          <input id="fileInput" type="file" accept="image/*" hidden>
          <button class="icon-btn camera-btn" id="cameraBtn" title="–ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ñ–æ—Ç–æ">üì∑</button>
          <button id="sendButton" class="btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
        </div>
      </section>

      <aside class="right-col">
        <section class="card block" id="mapTab" style="display:none">
          <div class="section-head">
            <div class="section-title">–ö–∞—Ä—Ç–∞ –∫–æ—Ä–∏—Å–Ω–∏—Ö –º—ñ—Å—Ü—å</div>
          </div>
          <div class="filters">
            <input id="mapSearch" placeholder="–ü–æ—à—É–∫ –Ω–∞ –∫–∞—Ä—Ç—ñ‚Ä¶" style="flex:1;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.25);color:var(--text)">
            <button class="pill" id="centerBtn">–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏</button>
          </div>
          <div id="map"></div>
        </section>

        <section class="card block" id="helpTab" style="display:none">
          <div class="section-head"><div class="section-title">–î–æ–ø–æ–º–æ–≥–∞</div></div>
          <div style="padding:10px">
            <ul>
              <li>–ï–∫—Å—Ç—Ä–µ–Ω—ñ —Å–ª—É–∂–±–∏: 112</li>
              <li>–¶–µ–Ω—Ç—Ä –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ —É–∫—Ä–∞—ó–Ω—Ü—ñ–≤: Praha hlavn√≠ n√°dra≈æ√≠, –ø–∞–≤—ñ–ª—å–π–æ–Ω –¥–æ–ø–æ–º–æ–≥–∏.</li>
              <li>–ú–µ–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ: Motol, Na Franti≈°ku ‚Äî –∑–≤–µ—Ä—Ç–∞–π—Ç–µ—Å—è —É –ø—Ä–∏–π–º–∞–ª—å–Ω–µ, –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏.</li>
              <li>–Æ—Ä–∏–¥–∏—á–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞: –û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó <b>OPU</b>, <b>ƒålovƒõk v t√≠sni</b>.</li>
              <li>–ü—Ä–∞—Ü–µ–≤–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è: –ø–∞–º‚Äô—è—Ç–∞–π—Ç–µ –ø—Ä–æ –¥–æ–≥–æ–≤–æ—Ä–∏ —Ç–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç —Å—Ç–æ—Ä–æ–Ω–Ω—ñ–º.</li>
              <li>–û–±–µ—Ä–µ–∂–Ω–æ —à–∞—Ö—Ä–∞—ó: –ø–µ—Ä–µ–≤—ñ—Ä—è–π—Ç–µ –ø—Ä–æ—Ñ—ñ–ª—å, –¥–∏–≤—ñ—Ç—å—Å—è —Ä–µ–∞–∫—Ü—ñ—ó ¬´‚ö†Ô∏è –æ–±–µ—Ä–µ–∂–Ω–æ¬ª –ø—ñ–¥ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏.</li>
              <li>–†–µ–∫–ª–∞–º–∞: –Ω–∞–ø–∏—à—ñ—Ç—å –Ω–∞ <a href="mailto:urciknikolaj642@gmail.com?subject=–ü–æ–∫—É–ø–∫–∞%20—Ä–µ–∫–ª–∞–º–∏%20Praha%20Fu≈°ky">urciknikolaj642@gmail.com</a></li>
            </ul>
          </div>
        </section>

        <section class="card block" id="friendsTab" style="display:none">
          <div class="section-head">
            <div class="section-title">–î—Ä—É–∑—ñ (<span id="friendsOnlineCount">0</span> –æ–Ω–ª–∞–π–Ω)</div>
          </div>
          <div style="padding:10px">
            <h4>–ó–∞—è–≤–∫–∏</h4>
            <div id="friendRequests"></div>
            <h4>–ú–æ—ó –¥—Ä—É–∑—ñ</h4>
            <div id="friendsList"></div>
          </div>
        </section>

        <section class="card block" id="dmTab" style="display:none">
          <div class="section-head"><div class="section-title">–û—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</div></div>
          <div style="padding:10px" id="dmList"></div>
        </section>

        <section class="card block" id="rentTab" style="display:none">
          <div class="section-head"><div class="section-title">–ß–∞—Ç: –û—Ä–µ–Ω–¥–∞ –∫–≤–∞—Ä—Ç–∏—Ä</div></div>
          <div class="chat-area" id="rentArea" aria-live="polite"></div>
          <div class="input-bar">
            <textarea id="rentInput" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ –æ—Ä–µ–Ω–¥—ñ‚Ä¶"></textarea>
            <input id="rentFile" type="file" accept="image/*" hidden>
            <button class="icon-btn" id="rentCamera" title="–§–æ—Ç–æ">üì∑</button>
            <button id="rentSend" class="btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
          </div>
        </section>
      </aside>
    </main>
  </div>

  <!-- Floating bots controller (collapsible) -->
  <div class="bots-float bots-collapsed" id="botsFloat" aria-live="polite">
    <div class="bots-toggle">
      <button class="tab-button" id="botsToggleBtn">ü§ñ –ü–∞–Ω–µ–ª—å –±–æ—Ç—ñ–≤</button>
      <button class="tab-button" id="startAllBtn">–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—Å—ñ—Ö</button>
      <button class="tab-button" id="stopAllBtn">–ó—É–ø–∏–Ω–∏—Ç–∏ –≤—Å—ñ—Ö</button>
      <button class="tab-button" id="postOnceAllBtn">‚ö°Ô∏è –†–∞–∑</button>
    </div>
    <div class="bots-row" id="botsRow"></div>
  </div>

  <!-- Admin modal -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="modal-panel">
      <button class="modal-close" id="adminClose">‚úñ</button>
      <h3>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h3>
      <div id="adminBots"></div>
      <hr>
      <div>
        <h4>–ö–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏</h4>
        <input id="banUid" placeholder="UID –¥–ª—è –±–∞–Ω–∞" style="padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.25);color:var(--text)">
        <button class="tab-button" id="banBtn">–ó–∞–±–∞–Ω–∏—Ç–∏</button>
        <button class="tab-button" id="unbanBtn">–†–æ–∑–±–∞–Ω–∏—Ç–∏</button>
      </div>
      <div style="margin-top:10px">
        <h4>–ß–∏—Å—Ç–∫–∞ —á–∞—Ç—ñ–≤</h4>
        <button class="tab-button" id="clearMain">–û—á–∏—Å—Ç–∏—Ç–∏ –∑–∞–≥–∞–ª—å–Ω–∏–π —á–∞—Ç</button>
        <button class="tab-button" id="clearRent">–û—á–∏—Å—Ç–∏—Ç–∏ —á–∞—Ç –æ—Ä–µ–Ω–¥–∏</button>
      </div>
    </div>
  </div>

  <!-- Profile modal -->
  <div class="modal" id="profileModal" aria-hidden="true">
    <div class="modal-panel">
      <button class="modal-close" id="profileClose">‚úñ</button>
      <div id="profileContent"></div>
    </div>
  </div>

  <!-- Notifications modal -->
  <div class="modal" id="bellModal" aria-hidden="true">
    <div class="modal-panel">
      <button class="modal-close" id="bellClose">‚úñ</button>
      <h3>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h3>
      <div id="notifList"></div>
    </div>
  </div>

  <!-- Message actions context menu -->
  <div id="msgMenu" role="menu" aria-hidden="true">
    <button data-act="reply">‚Ü©Ô∏è –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏</button>
    <button data-act="like">üëç –õ–∞–π–∫</button>
    <button data-act="careful">‚ö†Ô∏è –û–±–µ—Ä–µ–∂–Ω–æ —à–∞—Ö—Ä–∞–π</button>
    <button data-act="dislike">üëé –î–∏–∑–ª–∞–π–∫</button>
    <button data-act="spam">üö´ –°–ø–∞–º</button>
    <button data-act="delete">üóë –í–∏–¥–∞–ª–∏—Ç–∏</button>
  </div>

  <!-- Firebase CDN (modular v9) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- Tesseract.js for OCR of receipts -->
  <script src="https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js"></script>

  <script>
    /* ---------------- Firebase init (your config) ---------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
      authDomain: "praga-4baee.firebaseapp.com",
      databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
      projectId: "praga-4baee",
      storageBucket: "praga-4baee.firebasestorage.app",
      messagingSenderId: "336023952536",
      appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
      measurementId: "G-BGDJD6R12N"
    };
    firebase.initializeApp(firebaseConfig);
    try { firebase.analytics(); } catch(e){}

    const auth = firebase.auth();
    const db = firebase.database();
    const dbRef = (path) => db.ref(path);
    const dbPush = (path, val) => dbRef(path).push(val);
    const dbSet = (path, val) => dbRef(path).set(val);
    const dbGet = (path) => dbRef(path).get();
    const dbRemove = (path) => dbRef(path).remove();
    const onChildAdded = (path, cb) => dbRef(path).on('child_added', cb);
    const onValue = (path, cb) => dbRef(path).on('value', cb);

    const DEFAULT_AVATAR = "https://i.imgur.com/6VBx3io.png";
    const MSG_LIMIT = 160;

    /* ---------------- DOM refs ---------------- */
    const messagesEl = document.getElementById('chatArea');
    const rentMessagesEl = document.getElementById('rentArea');
    const messageInput = document.getElementById('messageInput');
    const fileInput = document.getElementById('fileInput');
    const sendButton = document.getElementById('sendButton');
    const cameraBtn = document.getElementById('cameraBtn');

    const rentInput = document.getElementById('rentInput');
    const rentFile = document.getElementById('rentFile');
    const rentSend = document.getElementById('rentSend');
    const rentCamera = document.getElementById('rentCamera');

    const tabButtons = document.querySelectorAll('.tab');
    const onlineNeon = document.getElementById('onlineNeon');
    const profileBtn = document.getElementById('profileBtn');
    const profileAvatar = document.getElementById('profileAvatar');
    const bellBtn = document.getElementById('bellBtn');
    const bellBadge = document.getElementById('bellBadge');
    const gearBtn = document.getElementById('gearBtn');
    const notifList = document.getElementById('notifList');

    const profileModal = document.getElementById('profileModal');
    const profileContent = document.getElementById('profileContent');
    const profileClose = document.getElementById('profileClose');

    const adminModal = document.getElementById('adminModal');
    const adminClose = document.getElementById('adminClose');
    const adminBots = document.getElementById('adminBots');

    const dmList = document.getElementById('dmList');
    const friendsList = document.getElementById('friendsList');
    const friendRequests = document.getElementById('friendRequests');
    const friendsOnlineCountEl = document.getElementById('friendsOnlineCount');

    const mapSearch = document.getElementById('mapSearch');
    const centerBtn = document.getElementById('centerBtn');

    const botsFloat = document.getElementById('botsFloat');
    const botsRow = document.getElementById('botsRow');
    const startAllBtn = document.getElementById('startAllBtn');
    const stopAllBtn = document.getElementById('stopAllBtn');
    const postOnceAllBtn = document.getElementById('postOnceAllBtn');
    const botsToggleBtn = document.getElementById('botsToggleBtn');

    const bellModal = document.getElementById('bellModal');
    const bellClose = document.getElementById('bellClose');

    const msgMenu = document.getElementById('msgMenu');

    /* ---------------- Tabs ---------------- */
    tabButtons.forEach(btn=>{
      btn.addEventListener('click', ()=> setActiveTab(btn.dataset.tab));
    });
    function setActiveTab(id){
      document.querySelectorAll('main .card, .right-col .card').forEach(el=>{
        if (el.id === id) el.style.display = ''; else if (['chatTab'].includes(el.id)) el.style.display=''; else el.style.display='none';
      });
      tabButtons.forEach(b=> b.classList.toggle('active', b.dataset.tab===id));
      if (id==='dmTab') loadDMList();
      if (id==='friendsTab') refreshFriendsBlocks();
    }
    document.getElementById('quickChat').onclick = ()=> setActiveTab('chatTab');
    document.getElementById('quickRent').onclick = ()=> setActiveTab('rentTab');
    document.getElementById('quickHelp').onclick = ()=> setActiveTab('helpTab');

    /* ---------------- Auth helpers ---------------- */
    let currentUser = null;
    auth.onAuthStateChanged(async (u)=>{
      currentUser = u;
      if (u){
        profileAvatar.src = u.photoURL || DEFAULT_AVATAR;
        await dbSet(`users/${u.uid}`, {
          uid: u.uid,
          nick: u.displayName || (u.email||'').split('@')[0] || '–ê–Ω–æ–Ω—ñ–º',
          email: u.email || '',
          avatar: u.photoURL || DEFAULT_AVATAR,
          createdAt: Date.now()
        });
        await dbSet(`presence/${u.uid}`, true);
        subscribeNotifications(u.uid);
        refreshFriendsBlocks();
      } else {
        profileAvatar.src = DEFAULT_AVATAR;
      }
    });

    /* ---------------- 6h rule ---------------- */
    async function canSendMessage(){
      const user = auth.currentUser;
      if (!user) return false;
      if (user.emailVerified) return true;
      const localKey = "regTime_" + user.uid;
      const localVal = localStorage.getItem(localKey);
      const sixHours = 6 * 60 * 60 * 1000;
      if (localVal && (Date.now() - Number(localVal) < sixHours)) return true;
      try {
        const snap = await dbGet(`users/${user.uid}/createdAt`);
        if (snap && snap.exists()) {
          const created = Number(snap.val());
          if (!Number.isNaN(created) && Date.now() - created < sixHours) {
            localStorage.setItem(localKey, String(created));
            return true;
          }
        }
      } catch (e) { console.error(e); }
      return false;
    }

    /* ---------------- Usage limits & subscription ---------------- */
    const LIMITS = { photo: 100, text: 200 };
    const ACCOUNT_PATTERN = "354037257/0300";
    async function getUsage(uid){
      const s = await dbGet(`usage/${uid}`);
      if (s.exists()) return s.val();
      return { photo:0, text:0, until: 0 };
    }
    async function incUsage(uid, kind){
      const u = await getUsage(uid);
      u[kind] = (u[kind]||0) + 1;
      await dbSet(`usage/${uid}`, u);
      return u;
    }
    async function hasActiveSub(uid){
      const u = await getUsage(uid);
      return (u.until || 0) > Date.now();
    }
    function showPayDialog(){
      const panel = document.createElement('div');
      panel.className = 'modal show';
      panel.innerHTML = `
        <div class="modal-panel">
          <button class="modal-close">‚úñ</button>
          <h3>–õ—ñ–º—ñ—Ç –≤–∏—á–µ—Ä–ø–∞–Ω–æ</h3>
          <p>–©–æ–± –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏, –æ–ø–ª–∞—Ç—ñ—Ç—å 100 –∫—Ä–æ–Ω –Ω–∞ —Ä–∞—Ö—É–Ω–æ–∫ <b>${ACCOUNT_PATTERN}</b> —ñ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–æ—Ç–æ –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ (OCR).</p>
          <input id="receiptInput" type="file" accept="image/*">
          <div id="receiptMsg" class="hint">–ö–ª—é—á–æ–≤—ñ —Ñ—Ä–∞–∑–∏ –Ω–∞ —Ñ–æ—Ç–æ: "–ü–ª–∞—Ç—ñ–∂ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ", –≤–∞—à —Ä–∞—Ö—É–Ω–æ–∫ –∞–±–æ ${ACCOUNT_PATTERN}</div>
          <button class="tab-button" id="receiptSend">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ñ–æ—Ç–æ</button>
        </div>`;
      document.body.appendChild(panel);
      panel.querySelector('.modal-close').onclick = ()=> panel.remove();
      panel.querySelector('#receiptSend').onclick = async ()=>{
        const f = panel.querySelector('#receiptInput').files[0];
        if (!f) return;
        panel.querySelector('#receiptMsg').textContent = "–†–æ–∑–ø—ñ–∑–Ω–∞—î–º–æ‚Ä¶ –∑–∞—á–µ–∫–∞–π—Ç–µ";
        const img = URL.createObjectURL(f);
        try{
          const { data: { text } } = await Tesseract.recognize(img, 'uk+ru+eng');
          const ok = /–ø–ª–∞—Ç(–µ|—ñ)–∂.*–ø(—ñ|i)–¥—Ç–≤/iu.test(text) || text.includes(ACCOUNT_PATTERN);
          if (ok){
            const uid = auth.currentUser.uid;
            const u = await getUsage(uid);
            u.until = Date.now() + 30*24*60*60*1000;
            u.photo = 0; u.text = 0;
            await dbSet(`usage/${uid}`, u);
            notify("–û–ø–ª–∞—Ç–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∞", "–ü—ñ–¥–ø–∏—Å–∫—É –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–æ –Ω–∞ 30 –¥–Ω—ñ–≤");
            panel.remove();
          } else {
            panel.querySelector('#receiptMsg').textContent = "–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–µ —Ñ–æ—Ç–æ –∞–±–æ –∑—Ä–æ–±—ñ—Ç—å —á—ñ—Ç–∫—ñ—à–µ.";
          }
        }catch(e){
          panel.querySelector('#receiptMsg').textContent = "–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è.";
        }
      };
    }

    async function checkAndMaybeLimit(kind){
      const u = auth.currentUser; if (!u) return false;
      if (await hasActiveSub(u.uid)) return true;
      const usage = await getUsage(u.uid);
      const cap = LIMITS[kind];
      if ((usage[kind]||0) >= cap){
        await dbPush(`notifications/${u.uid}`, { ts: Date.now(), type:"limit", text:`–õ—ñ–º—ñ—Ç ${kind==='photo'?'—Ñ–æ—Ç–æ':'—Ç–µ–∫—Å—Ç—ñ–≤'} –≤–∏—á–µ—Ä–ø–∞–Ω–æ. –î–ª—è –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è ‚Äî –æ–ø–ª–∞—Ç–∞ 100 –∫—Ä–æ–Ω —Ç–∞ —Ñ–æ—Ç–æ –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó.`, from:'system' });
        showPayDialog();
        return false;
      }
      await incUsage(u.uid, kind);
      return true;
    }

    /* ---------------- Rendering & actions ---------------- */
    function timeStr(ts){ return new Date(ts).toLocaleString(); }
    function isNearBottom(area){ return (area.scrollHeight - area.scrollTop - area.clientHeight) < 160; }
    function scrollToBottom(area){ area.scrollTop = area.scrollHeight; }

    function renderMessage(m, container){
      if (!m || !m.ts) return;
      const wrap = document.createElement("div");
      wrap.className = "message" + ((currentUser && m.uid === currentUser.uid) ? " self" : "");
      wrap.dataset.uid = m.uid || "";
      wrap.dataset.msgid = m.id || "";

      const avatar = document.createElement("img");
      avatar.className = "avatar";
      avatar.src = m.avatar || DEFAULT_AVATAR;
      avatar.alt = m.nick || "avatar";
      avatar.title = m.nick || "–ü–æ–∫–∞–∑ –ø—Ä–æ—Ñ—ñ–ª—é";
      avatar.addEventListener("click", ()=> openProfile(m.uid));

      const txt = document.createElement("div");
      txt.className = "message-content";
      const meta = document.createElement("div");
      meta.className = "message-meta";
      meta.textContent = `${m.nick || "–ê–Ω–æ–Ω—ñ–º"} ¬∑ ${timeStr(m.ts)}` + (m.recipientUid ? " ¬∑ –æ—Å–æ–±–∏—Å—Ç–µ" : "");
      txt.appendChild(meta);

      if (m.text) {
        const p = document.createElement("div");
        p.className = "text";
        p.innerText = m.text;
        txt.appendChild(p);
      }
      if (m.image) {
        const im = document.createElement("img");
        im.src = m.image;
        im.alt = "–§–æ—Ç–æ";
        im.className = "chat-image";
        txt.appendChild(im);
      }

      const act = document.createElement("div");
      act.className = "msg-actions";
      const btn = document.createElement('button'); btn.textContent = '‚ãØ';
      btn.addEventListener('click', (ev)=>{
        const rect = ev.target.getBoundingClientRect();
        showMsgMenu(rect.left, rect.bottom+4, m, wrap);
      });
      act.appendChild(btn);
      txt.appendChild(act);

      const area = container.closest('.chat-area');
      const stick = area ? isNearBottom(area) : false;

      wrap.appendChild(avatar);
      wrap.appendChild(txt);
      container.appendChild(wrap);

      if (area && stick) scrollToBottom(area);
    }

    /* ---------------- Queries (newest first view) ---------------- */
    let initialMainLoaded = false;
    let initialRentLoaded = false;
    dbRef("messages").limitToLast(MSG_LIMIT).on('child_added', (snap)=>{
      const m = snap.val(); m.id = snap.key; renderMessage(m, messagesEl);
      if (!initialMainLoaded) {
        clearTimeout(window._scrollMainInit);
        window._scrollMainInit = setTimeout(()=>{ const area = document.getElementById('chatArea'); scrollToBottom(area); initialMainLoaded = true; }, 80);
      }
    });
    dbRef("rentMessages").limitToLast(MSG_LIMIT).on('child_added', (snap)=>{
      const m = snap.val(); m.id = snap.key; renderMessage(m, rentMessagesEl);
      if (!initialRentLoaded) {
        clearTimeout(window._scrollRentInit);
        window._scrollRentInit = setTimeout(()=>{ const area = document.getElementById('rentArea'); scrollToBottom(area); initialRentLoaded = true; }, 80);
      }
    });

    /* ---------------- Send (active chat) ---------------- */
    function activeChatPath(){
      const isRent = document.getElementById("rentTab").style.display === "" || document.querySelector('.tab.active')?.dataset.tab==='rentTab';
      return isRent ? "rentMessages" : "messages";
    }
    cameraBtn.addEventListener('click', ()=> fileInput.click());
    rentCamera.addEventListener('click', ()=> rentFile.click());

    async function resizeImageFile(file, maxWidth = 900, quality = 0.8) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        reader.onload = (e) => {
          img.onload = () => {
            const scale = Math.min(1, maxWidth / img.width);
            const w = Math.round(img.width * scale);
            const h = Math.round(img.height * scale);
            const canvas = document.createElement('canvas');
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            resolve(dataUrl);
          };
          img.onerror = (err) => reject(err);
          img.src = e.target.result;
        };
        reader.onerror = (err) => reject(err);
        reader.readAsDataURL(file);
      });
    }

    async function sendTo(path, text, file){
      if (!auth.currentUser) { showAuthModal(); return; }
      if (!await canSendMessage()) { notify("–ü–æ—Ç—Ä—ñ–±–Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email", "–°–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—å 6-–≥–æ–¥–∏–Ω–Ω–∏–º –¥–æ—Å—Ç—É–ø–æ–º –∞–±–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å email."); return; }
      let kind = text ? 'text' : 'photo';
      if (!(await checkAndMaybeLimit(kind))) return;

      let imageData = null;
      if (file) {
        try { imageData = await resizeImageFile(file, 900, 0.8); }
        catch (e) { console.error(e); notify("–ü–æ–º–∏–ª–∫–∞", "–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ"); return; }
      }
      const u = auth.currentUser;
      const userSnap = await dbGet(`users/${u.uid}`);
      const profile = userSnap.exists()? userSnap.val() : {};
      const msg = {
        uid: u.uid,
        nick: profile.nick || u.displayName || u.email || "–ê–Ω–æ–Ω—ñ–º",
        avatar: profile.avatar || u.photoURL || DEFAULT_AVATAR,
        text: text || null,
        image: imageData || null,
        ts: Date.now(),
        recipientUid: null
      };
      try {
        await dbPush(path, msg);
      } catch (err) { console.error(err); notify("–ü–æ–º–∏–ª–∫–∞", "–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏"); }
    }

    sendButton.addEventListener("click", async ()=>{
      const text = messageInput.value.trim();
      const file = fileInput.files[0];
      if (!text && !file) return;
      await sendTo(activeChatPath(), text, file);
      messageInput.value = ""; fileInput.value = "";
    });
    messageInput.addEventListener("keydown", (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendButton.click(); } });

    rentSend.addEventListener("click", async ()=>{
      const text = rentInput.value.trim();
      const file = rentFile.files[0];
      if (!text && !file) return;
      await sendTo("rentMessages", text, file);
      rentInput.value = ""; rentFile.value = "";
    });

    /* ---------------- Message menu ---------------- */
    function showMsgMenu(x,y,msg,wrap){
      msgMenu.style.left = x + "px"; msgMenu.style.top = y + "px"; msgMenu.style.display = "block";
      msgMenu.setAttribute('aria-hidden','false');
      const hide = ()=> { msgMenu.style.display = "none"; msgMenu.setAttribute('aria-hidden','true'); document.removeEventListener("click", hide); };
      setTimeout(()=>document.addEventListener("click", hide, { once:true }), 0);

      msgMenu.querySelectorAll('button').forEach(btn=>{
        btn.onclick = async ()=> {
          const act = btn.dataset.act;
          try {
            if (act === 'reply') {
              const r = prompt("–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:");
              if (r) {
                await dbPush("messages", {
                  uid: auth.currentUser.uid,
                  nick: auth.currentUser.displayName || auth.currentUser.email,
                  avatar: auth.currentUser.photoURL || DEFAULT_AVATAR,
                  text: "‚Ü©Ô∏è –í—ñ–¥–ø–æ–≤—ñ–¥—å: " + r,
                  ts: Date.now(),
                  recipientUid: msg.uid
                });
              }
            } else if (act === 'delete') {
              if (auth.currentUser && (auth.currentUser.uid === msg.uid)){
                await dbRemove(`messages/${msg.id}`);
                wrap.remove();
              } else notify("–í—ñ–¥–º–æ–≤–∞", "–ú–æ–∂–Ω–∞ –≤–∏–¥–∞–ª—è—Ç–∏ –ª–∏—à–µ —Å–≤–æ—ó –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è");
            } else {
              if (msg.id) {
                await dbSet(`messageReactions/${msg.id}/${auth.currentUser.uid}`, { act, ts: Date.now() });
                await dbPush(`notifications/${msg.uid}`, { ts: Date.now(), type:"reaction", text:`${act} –Ω–∞ –≤–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è`, from: auth.currentUser.uid });
                notify("–î—ñ—è –≤–∏–∫–æ–Ω–∞–Ω–∞", "–†–µ–∞–∫—Ü—ñ—é –∑–±–µ—Ä–µ–∂–µ–Ω–æ");
              } else notify("–ü–æ–º–∏–ª–∫–∞", "–ù–µ–º–∞—î id –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è");
            }
          } catch(e){ console.error(e); notify("–ü–æ–º–∏–ª–∫–∞ –¥—ñ—ó","–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑"); }
        };
      });
    }

    /* ---------------- Presence / online √ó10 ---------------- */
    onValue("presence", (snap)=>{
      const val = snap.val() || {};
      const real = Object.keys(val).length;
      const shown = real * 10;
      onlineNeon.textContent = `–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): ${shown}`;
    });
    window.addEventListener('beforeunload', async ()=> {
      try{ if (auth.currentUser) await dbRemove(`presence/${auth.currentUser.uid}`); }catch(e){}
    });

    /* ---------------- Friends ---------------- */
    async function sendFriendRequest(toUid){
      if (!auth.currentUser) { showAuthModal(); return; }
      const from = auth.currentUser.uid;
      if (from === toUid) return;
      try{
        await dbSet(`friendRequests/${toUid}/${from}`, { from, ts: Date.now() });
        await dbSet(`friends/${from}/${toUid}`, { status:"requested", ts: Date.now(), fromUid: from });
        await dbPush(`notifications/${toUid}`, { ts: Date.now(), type:"friend", text:`–ó–∞–ø–∏—Ç —É –¥—Ä—É–∑—ñ –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`, from });
        notify("–ó–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ","–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –æ—Ç—Ä–∏–º–∞—î —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è.");
      }catch(e){ notify("–ü–æ–º–∏–ª–∫–∞","–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞–ø–∏—Ç"); }
    }

    function friendCard(u, online, fid){
      const div = document.createElement('div'); div.className = 'friend-card';
      div.innerHTML = `
        <img src="${u.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
        <div style="flex:1">
          <div style="font-weight:800">${u.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</div>
          <div style="font-size:12px;color:${online?'#10b981':'#94a3b8'}">${online?'–æ–Ω–ª–∞–π–Ω':'–æ—Ñ–ª–∞–π–Ω'}</div>
        </div>
        <div style="display:flex;gap:6px">
          <button class="tab-button btn-pm">‚úâÔ∏è</button>
          <button class="tab-button btn-open">üëÄ</button>
        </div>`;
      div.querySelector('.btn-open').addEventListener('click', ()=> openProfile(fid));
      div.querySelector('.btn-pm').addEventListener('click', ()=> openPrivateChat(fid));
      return div;
    }

    async function refreshFriendsBlocks(){
      const u = auth.currentUser;
      if (!u){ friendsList.innerHTML=""; friendRequests.innerHTML=""; friendsOnlineCountEl.textContent="0"; return; }

      // Requests to me
      const reqSnap = await dbGet(`friendRequests/${u.uid}`);
      friendRequests.innerHTML = "";
      if (reqSnap.exists()){
        const reqs = reqSnap.val();
        for (const fromUid of Object.keys(reqs)){
          const uSnap = await dbGet(`users/${fromUid}`);
          const ud = uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
          const item = document.createElement('div');
          item.className = 'friend-card';
          item.innerHTML = `
            <img src="${ud.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
            <div style="flex:1">
              <div style="font-weight:800">${ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</div>
              <div style="font-size:12px;color:#94a3b8">–∑–∞—è–≤–∫–∞ —É –¥—Ä—É–∑—ñ</div>
            </div>
            <div style="display:flex;gap:6px">
              <button class="tab-button btn-accept">‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏</button>
              <button class="tab-button btn-decline" style="background:#ffe1e122">‚úñ</button>
            </div>`;
          item.querySelector('.btn-accept').addEventListener('click', async ()=>{
            await dbSet(`friends/${u.uid}/${fromUid}`, { status:"accepted", ts: Date.now() });
            await dbSet(`friends/${fromUid}/${u.uid}`, { status:"accepted", ts: Date.now() });
            await dbRemove(`friendRequests/${u.uid}/${fromUid}`);
            await dbPush(`notifications/${fromUid}`, { ts: Date.now(), type:"friend", text:`${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'} –¥–æ–¥–∞–≤(–ª–∞) –≤–∞—Å —É –¥—Ä—É–∑—ñ`, from: u.uid });
            refreshFriendsBlocks();
          });
          item.querySelector('.btn-decline').addEventListener('click', async ()=>{
            await dbRemove(`friendRequests/${u.uid}/${fromUid}`);
            await dbRemove(`friends/${fromUid}/${u.uid}`);
            refreshFriendsBlocks();
          });
          friendRequests.appendChild(item);
        }
      } else {
        friendRequests.innerHTML = "<i>–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</i>";
      }

      // My friends
      friendsList.innerHTML = "";
      const frSnap = await dbGet(`friends/${u.uid}`);
      let onlineCount = 0;
      if (frSnap.exists()){
        const fr = frSnap.val();
        for (const fid of Object.keys(fr)){
          const rel = fr[fid];
          if (rel.status !== "accepted") continue;
          const uSnap = await dbGet(`users/${fid}`);
          const ud = uSnap.exists()?uSnap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
          const pSnap = await dbGet(`presence/${fid}`);
          const isOnline = pSnap.exists();
          if (isOnline) onlineCount++;
          const card = friendCard(ud, isOnline, fid);
          friendsList.appendChild(card);
        }
      } else {
        friendsList.innerHTML = "<i>–î–æ–¥–∞–π—Ç–µ –¥—Ä—É–∑—ñ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ—ñ–ª—ñ</i>";
      }
      friendsOnlineCountEl.textContent = String(onlineCount);
    }

    /* ---------------- Profile ---------------- */
    document.getElementById('profileBtn').addEventListener('click', async ()=> {
      if (!auth.currentUser) { showAuthModal(); return; }
      openProfile(auth.currentUser.uid, true);
    });
    profileClose.addEventListener('click', ()=> { profileModal.classList.remove("show"); profileModal.setAttribute("aria-hidden","true"); });

    async function openProfile(uid, self=false){
      profileContent.innerHTML = "<p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>";
      profileModal.classList.add("show"); profileModal.setAttribute("aria-hidden","false");
      try {
        const snap = await dbGet(`users/${uid}`);
        const user = snap && snap.exists() ? snap.val() : { nick: "–ê–Ω–æ–Ω—ñ–º", avatar: DEFAULT_AVATAR };
        const isSelf = auth.currentUser && auth.currentUser.uid === uid;
        const email = user.email || "";

        profileContent.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center">
            <img src="${user.avatar || DEFAULT_AVATAR}" style="width:84px;height:84px;border-radius:12px;object-fit:cover">
            <div>
              <h3 style="margin:0 0 4px">${user.nick || "–ê–Ω–æ–Ω—ñ–º"}</h3>
              <div style="color:${email ? '#e2e8f0':'#94a3b8'}">${email}</div>
            </div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            ${isSelf ? `
                <button id="editAvatarBtn" class="tab-button">–ó–º—ñ–Ω–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä (URL)</button>
                <button id="myDMsBtn" class="tab-button">–ú–æ—ó –õ–°</button>
                <button id="signOutBtn" class="tab-button" style="background:#ffe1e122">–í–∏–π—Ç–∏</button>
                <a class="tab-button" id="buyAdsBtn" href="mailto:urciknikolaj642@gmail.com?subject=–ü–æ–∫—É–ø–∫–∞%20—Ä–µ–∫–ª–∞–º–∏%20Praha%20Fu≈°ky">–ö—É–ø–∏—Ç–∏ —Ä–µ–∫–ª–∞–º—É</a>
              ` : `
                <button id="pmBtn" class="tab-button">–ù–∞–ø–∏—Å–∞—Ç–∏ –õ–°</button>
                <button id="addFriendBtn" class="tab-button">–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>
                <button id="reportBtn" class="tab-button" style="background:#fff3cd22">–ü–æ—Å–∫–∞—Ä–∂–∏—Ç–∏—Å—å</button>
              `}
          </div>
          <div id="profileMsg" style="margin-top:8px;color:#b91c1c"></div>
        `;

        if (isSelf){
          document.getElementById("editAvatarBtn").addEventListener("click", async ()=>{
            const url = prompt("–í—Å—Ç–∞–≤ URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∫–∏:");
            if (!url) return;
            try{
              await dbSet(`users/${uid}/avatar`, url);
              await auth.currentUser.updateProfile({ photoURL: url });
              profileContent.querySelector('img').src = url;
              profileBtn.style.background = `url(${url}) center/cover`;
              notify("–ê–≤–∞—Ç–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ","–§–æ—Ç–æ –∑–º—ñ–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ URL.");
            }catch(e){ notify("–ü–æ–º–∏–ª–∫–∞","–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä"); }
          });
          document.getElementById("myDMsBtn").addEventListener("click", ()=> { profileModal.classList.remove("show"); setActiveTab("dmTab"); });
          document.getElementById("signOutBtn").addEventListener("click", async ()=> {
            try{ await dbRemove(`presence/${auth.currentUser.uid}`); }catch(e){}
            await auth.signOut();
            profileModal.classList.remove("show");
          });
        } else {
          document.getElementById("pmBtn").addEventListener("click", ()=> { profileModal.classList.remove("show"); openPrivateChat(uid); });
          document.getElementById("addFriendBtn").addEventListener("click", ()=> sendFriendRequest(uid));
          document.getElementById("reportBtn").addEventListener("click", ()=> notify("–°–∫–∞—Ä–≥–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞","–î—è–∫—É—î–º–æ, –º–∏ —Ä–æ–∑–≥–ª—è–Ω–µ–º–æ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è."));
        }
      } catch(e){ profileContent.innerHTML = "<p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</p>"; }
    }

    /* ---------------- Private chat ---------------- */
    function convoIdFor(uidA, uidB){ return uidA < uidB ? uidA + "_" + uidB : uidB + "_" + uidA; }

    async function openPrivateChat(otherUid){
      if (!auth.currentUser){ showAuthModal(); return; }
      const uid = auth.currentUser.uid;
      const cid = convoIdFor(uid, otherUid);

      const panel = document.createElement('div');
      panel.className = 'modal show'; panel.style.zIndex = 98;
      panel.innerHTML = `
        <div class="modal-panel">
          <button class="modal-close">‚úñ</button>
          <h3>–î—ñ–∞–ª–æ–≥</h3>
          <div id="dmThread" style="max-height:55vh;overflow:auto;border:1px solid #eee1;border-radius:8px;padding:8px;margin-bottom:8px;background:#0b1220"></div>
          <div style="display:flex;gap:6px">
            <input id="dmText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e2e8f0">
            <button id="dmSend" class="tab-button">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
          </div>
        </div>`;
      document.body.appendChild(panel);
      const closeBtn = panel.querySelector('.modal-close');
      closeBtn.addEventListener('click', ()=> panel.remove());

      const thread = panel.querySelector('#dmThread');
      dbRef(`privateMessages/${cid}`).limitToLast(200).on('child_added', (snap)=>{
        const m = snap.val();
        const row = document.createElement('div');
        row.style.margin = "6px 0";
        row.style.textAlign = m.from === uid ? "right" : "left";
        row.textContent = `${m.text}  (${new Date(m.ts).toLocaleTimeString()})`;
        thread.appendChild(row);
        thread.scrollTop = thread.scrollHeight;
      });

      panel.querySelector('#dmSend').addEventListener('click', async ()=>{
        const t = panel.querySelector('#dmText').value.trim();
        if (!t) return;
        const pm = { from: uid, to: otherUid, text: t, ts: Date.now() };
        await dbPush(`privateMessages/${cid}`, pm);
        await dbPush(`notifications/${otherUid}`), { ts: Date.now(), type:"dm", text:`–ù–æ–≤–µ –õ–° –≤—ñ–¥ ${auth.currentUser.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`, from: uid };
        panel.querySelector('#dmText').value = "";
      });
    }

    async function loadDMList(){
      const u = auth.currentUser; if (!u) { dmList.innerHTML = "<i>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –±–∞—á–∏—Ç–∏ –õ–°</i>"; return; }
      dmList.innerHTML = `<p>–í—ñ–¥–∫—Ä–∏–≤–∞–π—Ç–µ –õ–° —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ—ñ–ª—ñ –∞–±–æ –ø–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è—Ö üîî. (–°–ø–∏—Å–æ–∫ –¥—ñ–∞–ª–æ–≥—ñ–≤ –º–æ–∂–Ω–∞ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ conversations/${u.uid}).</p>`;
    }

    /* ---------------- Notifications (bell) ---------------- */
    function notify(title, text){
      const row = document.createElement('div');
      row.style.padding = "6px 8px"; row.style.borderBottom = "1px solid #334155";
      row.textContent = `${title}: ${text}`;
      notifList.prepend(row);
      let n = Number(bellBadge.dataset.n || "0") + 1;
      bellBadge.dataset.n = String(n);
      bellBadge.textContent = n;
      bellBadge.style.display = n>0 ? "inline-block":"none";
    }
    function subscribeNotifications(uid){
      dbRef(`notifications/${uid}`).on('child_added', (snap)=>{
        const v = snap.val() || {};
        notify(v.type || "Info", v.text || "");
      });
    }
    bellBtn.addEventListener('click', ()=>{
      bellModal.classList.add("show");
      bellModal.setAttribute("aria-hidden","false");
      bellBadge.dataset.n = "0";
      bellBadge.style.display = "none";
    });
    bellClose.addEventListener('click', ()=>{
      bellModal.classList.remove("show"); bellModal.setAttribute("aria-hidden","true");
    });

    /* ---------------- Bots controller ---------------- */
    const BOTS_DEF = [
      { id: 'bot_1', nick:"Bot_–û–≥–æ–ª–æ—à–µ–Ω–Ω—è_1", avatar:"https://i.ibb.co/LH4wBMS/IMG-d8e6076e17f19db7fe3add0754738a01-V.jpg",
        posts:[
          {text:`O2 –°–Ü–ú –ö–ê–†–¢–ê\n–ë–µ–∑ –ª—ñ–º—ñ—Ç —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç\n–ë–µ–∑ –ª—ñ–º—ñ—Ç –¥–∑–≤—ñ–Ω–∫–∏\n–ü—Ä–∞—Ü—é—î –≤ –Ñ–≤—Ä–æ–ø—ñ\n–ü–ª–∞—Ç–∞ 699 –∫—Ä–æ–Ω/–º—ñ—Å. –¶—ñ–Ω–∞ 299 –∫—Å. —Ç–µ–ª 607914467 (Viber/WhatsApp/Telegram)`, image:"https://i.ibb.co/LH4wBMS/IMG-d8e6076e17f19db7fe3add0754738a01-V.jpg"},
          {text:`–ü—Ä–æ–¥–∞—é iPhone 11 Pro Max + 26 —á–æ—Ö–ª—ñ–≤ (—á–æ—Ö–ª–∏ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ). –¢–µ–ª–µ—Ñ–æ–Ω –±–µ–∑ —Ç—Ä—ñ—â–∏–Ω, –Ω–µ –ø–∞–¥–∞–≤, –≤—Å–µ –æ—Ä–∏–≥—ñ–Ω–∞–ª, –±–µ–∑ Apple ID. –ü–∏—Ç–∞–Ω–Ω—è —É –ø—Ä–∏–≤–∞—Ç.`, image:"https://i.ibb.co/dwcXPqDr/IMG-1954f6b56869b9817a131ae33f3a37b6-V.jpg"},
          {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è`, image:"https://i.ibb.co/G3kDcrYZ/IMG-fa590121e46c5b030c5ddc94d4e8bea9-V.jpg"}
        ],
        baseInterval: 2*60*1000*1.6
      },
      { id: 'bot_2', nick:"Bot_–û–≥–æ–ª–æ—à–µ–Ω–Ω—è_2", avatar:"https://i.ibb.co/Z11WVrVC/IMG-b83692bb79a1468af74c81620750e8c0-V.jpg",
        posts:[
          {text:`–®–∞–±–ª–æ–Ω`, image:"https://i.ibb.co/Z11WVrVC/IMG-b83692bb79a1468af74c81620750e8c0-V.jpg"},
          {text:`–ó–∞–ø—Ä–æ—à—É—é –º–æ–¥–µ–ª–µ–π –Ω–∞ –ø–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω–∏–π –º–∞–∫—ñ—è–∂ (–ü—Ä–∞–≥–∞, 28.07 –æ 14:00). –¶—ñ–Ω–∞ ‚Äî –ª–∏—à–µ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏. –î–µ—Ç–∞–ª—ñ —É –ø—Ä–∏–≤–∞—Ç.`, image:"https://i.ibb.co/QFWDvGZ8/IMG-6748e7141906901b131b8fd5130a5c01-V.jpg"},
          {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è 3`, image:"https://i.ibb.co/j97RhTny/IMG-593d75b053ea1a28cdfb9fc52f93afad-V.jpg"}
        ],
        baseInterval: 3*60*1000*1.6
      },
      { id: 'bot_3', nick:"Bot_–û–≥–æ–ª–æ—à–µ–Ω–Ω—è_3", avatar:"https://i.ibb.co/MzdTMPR/IMG-8231d8142ffcbba7c682ca598683e3f2-V.jpg",
        posts:[
          {text:`–ù—É–∂–µ–Ω –≤–æ–¥–∏—Ç–µ–ª—å –¥–ª—è –ø–æ–º–æ—â–∏ –≤ –ø–µ—Ä–µ–µ–∑–¥–µ (—Å–æ —Å–≤–æ–∏–º –∞–≤—Ç–æ). WhatsApp: +48 793 463 757 ‚Ä¢ Telegram: @carlx_xxx`, image:null},
          {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è`, image:"https://i.ibb.co/MzdTMPR/IMG-8231d8142ffcbba7c682ca598683e3f2-V.jpg"},
          {text:`–û–≥–æ–ª–æ—à–µ–Ω–Ω—è 3`, image:"https://i.ibb.co/rfNV6ddC/IMG-0cd648a74f86227fe46db2d01c099be0-V.jpg"}
        ],
        baseInterval: 4*60*1000*1.6
      }
    ];

    const BotController = (() => {
      const timers = new Map();
      const indices = new Map();
      const speeds = new Map(); // multiplier per bot (default 1)

      function nextIndex(id, posts){
        const i = (indices.get(id) || 0);
        indices.set(id, i+1);
        return posts[i % posts.length];
      }

      async function post(bot){
        const p = nextIndex(bot.id, bot.posts);
        try {
          await dbPush("messages", {
            uid: bot.id, nick: bot.nick, avatar: bot.avatar,
            text: p.text, image: p.image || null, ts: Date.now()
          });
        } catch(e){ console.error("bot push err", e); }
      }

      function isRunning(id){ return timers.has(id); }

      function computeInterval(bot){
        const mult = speeds.get(bot.id) || 1;
        const minMs = 15000; // safeguard
        return Math.max(minMs, bot.baseInterval / mult);
      }

      function start(bot){
        if (isRunning(bot.id)) return;
        const tick = async ()=>{ await post(bot); schedule(); };
        function schedule(){
          const ms = computeInterval(bot);
          const t = setTimeout(tick, ms);
          timers.set(bot.id, t);
          updateUIState(bot.id);
        }
        schedule();
      }

      function stop(id){
        const t = timers.get(id);
        if (t){ clearTimeout(t); timers.delete(id); updateUIState(id); }
      }

      function setSpeed(botId, mult){
        speeds.set(botId, mult);
        if (timers.has(botId)){
          clearTimeout(timers.get(botId));
          timers.delete(botId);
          const bot = BOTS_DEF.find(b=>b.id===botId);
          if (bot) start(bot);
        }
        updateUIState(botId);
      }

      function postOnce(bot){ return post(bot); }

      function stopAll(){ Array.from(timers.keys()).forEach(stop); }
      function startAll(){ BOTS_DEF.forEach(start); }
      function postOnceAll(){ return Promise.all(BOTS_DEF.map(postOnce)); }

      function getSpeed(id){ return speeds.get(id) || 1; }

      function updateUIState(id){
        const chip = document.querySelector(`[data-bot='${id}']`);
        if (!chip) return;
        const running = isRunning(id);
        chip.querySelector('.state').textContent = running ? '‚óè –ø—Ä–∞—Ü—é—î' : '‚óã –∑—É–ø–∏–Ω–µ–Ω–æ';
        chip.querySelector('.toggle').textContent = running ? '‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏' : '‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏';
      }

      return { start, stop, setSpeed, isRunning, postOnce, stopAll, startAll, postOnceAll, getSpeed };
    })();

    function buildBotChip(bot){
      const wrap = document.createElement('div');
      wrap.className = 'admin-chip';
      wrap.dataset.bot = bot.id;
      wrap.innerHTML = `
        <img src="${bot.avatar}" style="width:26px;height:26px;border-radius:6px;object-fit:cover"> 
        <b>${bot.nick}</b>
        <span class="state" style="font-size:12px;opacity:.8">‚óã –∑—É–ø–∏–Ω–µ–Ω–æ</span>
        <button class="toggle tab-button" style="padding:6px 10px">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏</button>
        <button class="once tab-button" style="padding:6px 10px;background:#fff3cd22">‚ö°Ô∏è –†–∞–∑</button>
        <label style="font-size:12px">—à–≤–∏–¥–∫. <input type="range" min="0.5" max="3" step="0.1" value="1" class="speed"></label>
        <span class="speedv" style="font-size:12px">1√ó</span>
      `;
      const toggle = wrap.querySelector('.toggle');
      const once = wrap.querySelector('.once');
      const range = wrap.querySelector('.speed');
      const speedv = wrap.querySelector('.speedv');

      toggle.addEventListener('click', ()=>{
        if (BotController.isRunning(bot.id)) BotController.stop(bot.id); else BotController.start(bot);
      });
      once.addEventListener('click', ()=> BotController.postOnce(bot));
      range.addEventListener('input', ()=>{
        const v = Number(range.value);
        speedv.textContent = v.toFixed(1) + '√ó';
        BotController.setSpeed(bot.id, v);
        localStorage.setItem('bot_speed_'+bot.id, String(v));
      });
      const saved = Number(localStorage.getItem('bot_speed_'+bot.id) || '1');
      if (!Number.isNaN(saved) && saved){ range.value = String(saved); speedv.textContent = saved.toFixed(1)+'√ó'; BotController.setSpeed(bot.id, saved); }
      return wrap;
    }

    function initAdminUI(){
      botsRow.innerHTML = '';
      BOTS_DEF.forEach(bot=> botsRow.appendChild(buildBotChip(bot)));
      startAllBtn.onclick = ()=> BotController.startAll();
      stopAllBtn.onclick = ()=> BotController.stopAll();
      postOnceAllBtn.onclick = ()=> BotController.postOnceAll();
      document.getElementById('gearBtn').onclick = ()=>{ adminModal.classList.add('show'); adminModal.setAttribute('aria-hidden','false'); };
      adminClose.onclick = ()=>{ adminModal.classList.remove('show'); adminModal.setAttribute('aria-hidden','true'); };

      // collapsible toggle
      botsToggleBtn.onclick = ()=>{
        botsFloat.classList.toggle('bots-collapsed');
      };
      // show tip if empty
      setTimeout(()=>{
        if (!messagesEl.firstChild){
          notify('–ü—ñ–¥–∫–∞–∑–∫–∞', '–ß–∞—Ç –ø–æ—Ä–æ–∂–Ω—ñ–π. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ ‚öôÔ∏è —â–æ–± –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∞–±–æ ‚ö°Ô∏è –¥–æ–¥–∞—Ç–∏ –ø–µ—Ä—à—ñ –ø–æ—Å—Ç–∏ –±–æ—Ç—ñ–≤.');
        }
      }, 600);

      // Admin actions
      document.getElementById('banBtn').onclick = async ()=>{
        const uid = document.getElementById('banUid').value.trim();
        if (!uid) return;
        await dbSet(`banned/${uid}`, true);
        notify('–ë–∞–Ω', `–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ${uid} –∑–∞–±–∞–Ω–µ–Ω–∏–π.`);
      };
      document.getElementById('unbanBtn').onclick = async ()=>{
        const uid = document.getElementById('banUid').value.trim();
        if (!uid) return;
        await dbRemove(`banned/${uid}`);
        notify('–†–æ–∑–±–∞–Ω', `–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ${uid} —Ä–æ–∑–±–∞–Ω–µ–Ω–∏–π.`);
      };
      document.getElementById('clearMain').onclick = async ()=>{
        await dbRemove('messages'); notify('–ê–¥–º—ñ–Ω', '–ì–æ–ª–æ–≤–Ω–∏–π —á–∞—Ç –æ—á–∏—â–µ–Ω–æ');
      };
      document.getElementById('clearRent').onclick = async ()=>{
        await dbRemove('rentMessages'); notify('–ê–¥–º—ñ–Ω', '–ß–∞—Ç –æ—Ä–µ–Ω–¥–∏ –æ—á–∏—â–µ–Ω–æ');
      };
    }

    /* ---------------- Map with markers ---------------- */
    const POINTS = [
      { title: "Nemocnice Motol", pos: {lat:50.058, lng:14.360}, cat:"hospital", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png" },
      { title: "Nemocnice Na Frantisku", pos: {lat:50.086, lng:14.418}, cat:"hospital", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png" },
      { title: "Klinika Praha", pos: {lat:50.078, lng:14.422}, cat:"hospital", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png" },
      { title: "Pravni pomoc —Ü–µ–Ω—Ç—Ä A", pos: {lat:50.083, lng:14.412}, cat:"lawyer", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png" },
      { title: "Pravni pomoc —Ü–µ–Ω—Ç—Ä B", pos: {lat:50.089, lng:14.430}, cat:"lawyer", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png" },
      { title: "Advokatni kancelar C", pos: {lat:50.071, lng:14.425}, cat:"lawyer", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png" },
      { title: "Albert Supermarket", pos: {lat:50.084, lng:14.417}, cat:"shop", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/yellow-dot.png" },
      { title: "Billa City", pos: {lat:50.076, lng:14.437}, cat:"shop", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/yellow-dot.png" },
      { title: "Kaufland Praha", pos: {lat:50.085, lng:14.414}, cat:"shop", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/yellow-dot.png" },
      { title: "Pomoc Centrum 1", pos: {lat:50.082, lng:14.419}, cat:"help", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/ltblue-dot.png" },
      { title: "Pomoc Centrum 2", pos: {lat:50.088, lng:14.427}, cat:"help", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/ltblue-dot.png" },
      { title: "Shelter Point", pos: {lat:50.074, lng:14.432}, cat:"help", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/ltblue-dot.png" },
      { title: "Clinic D", pos: {lat:50.090, lng:14.418}, cat:"hospital", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png" },
      { title: "Clinic E", pos: {lat:50.079, lng:14.404}, cat:"hospital", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png" },
      { title: "Law Office D", pos: {lat:50.081, lng:14.440}, cat:"lawyer", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png" },
      { title: "Shop D", pos: {lat:50.083, lng:14.445}, cat:"shop", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/yellow-dot.png" },
      { title: "Shop E", pos: {lat:50.0715, lng:14.421}, cat:"shop", icon:"https://maps.gstatic.com/mapfiles/ms2/micons/yellow-dot.png" }
    ];
    let map, markers=[];
    function initMap(){
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat:50.0755, lng:14.4378}, zoom: 12, mapTypeControl:false, streetViewControl:false
      });
      markers = POINTS.map(p=> new google.maps.Marker({ position:p.pos, title:p.title, icon:p.icon, map }));
    }
    window.initMap = initMap;

    mapSearch?.addEventListener('input', ()=>{
      const q = mapSearch.value.toLowerCase();
      markers.forEach((m, idx)=>{
        const p = POINTS[idx];
        const show = p.title.toLowerCase().includes(q) || p.cat.toLowerCase().includes(q);
        m.setVisible(show);
      });
    });
    centerBtn?.addEventListener('click', ()=>{ if (map) map.setCenter({lat:50.0755,lng:14.4378}); });

    /* ---------------- Bots UI init ---------------- */
    initAdminUI();

    /* ---------------- Simple email/password auth modal ---------------- */
    function showAuthModal(){
      const panel = document.createElement('div');
      panel.className = 'modal show';
      panel.innerHTML = `
        <div class="modal-panel">
          <button class="modal-close">‚úñ</button>
          <h3>–í—Ö—ñ–¥ / –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h3>
          <div style="display:grid;gap:8px;grid-template-columns:1fr 1fr">
            <input id="email" type="email" placeholder="Email" style="padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e2e8f0">
            <input id="pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å" style="padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e2e8f0">
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="doSignIn" class="tab-button">–£–≤—ñ–π—Ç–∏</button>
            <button id="doSignUp" class="tab-button">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
          </div>
          <div class="hint">–ü—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó ‚Äî 6 –≥–æ–¥–∏–Ω –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email. –ü–æ—Ç—ñ–º –ø—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å email.</div>
        </div>`;
      document.body.appendChild(panel);
      panel.querySelector('.modal-close').onclick = ()=> panel.remove();
      panel.querySelector('#doSignIn').onclick = async ()=>{
        const em = panel.querySelector('#email').value.trim();
        const pw = panel.querySelector('#pass').value;
        try{ await auth.signInWithEmailAndPassword(em, pw); panel.remove(); }
        catch(e){ alert('–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: '+e.message); }
      };
      panel.querySelector('#doSignUp').onclick = async ()=>{
        const em = panel.querySelector('#email').value.trim();
        const pw = panel.querySelector('#pass').value;
        try{ await auth.createUserWithEmailAndPassword(em, pw); await auth.currentUser.sendEmailVerification(); alert('–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ email.'); panel.remove(); }
        catch(e){ alert('–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó: '+e.message); }
      };
    }

    /* ---------------- Collapsible bots panel state restore ---------------- */
    (function(){
      const state = localStorage.getItem('bots_collapsed');
      if (state === '0') botsFloat.classList.remove('bots-collapsed');
      botsToggleBtn.addEventListener('click', ()=>{
        const collapsed = botsFloat.classList.contains('bots-collapsed');
        localStorage.setItem('bots_collapsed', collapsed ? '0' : '1');
      });
    })();
  </script>

  <!-- Google Maps -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9tOqK-Ze3F8MeAIzirty8o4e7WZk3w3A&callback=initMap"></script>
</body>
</html>
