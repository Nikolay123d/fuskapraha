<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ü–†–ê–ì–ê –§–£–®–ö–ò ‚Äî –°–æ—Ü—á–∞—Ç</title>

  <!-- –®—Ä–∏—Ñ—Ç—ã -->
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --accent:#2ecc71;
      --glass: rgba(255,255,255,0.96);
      --muted:#64748b;
      --max-width:980px;
      --avatar-size:44px;
      --chat-scale:1.12;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif;-webkit-font-smoothing:antialiased;background:#071126;color:#0b1220;overflow-x:hidden}

    body {
      background-image: url('https://i.ibb.co/27hgtZfY/Prague.jpg');
      background-size: cover; background-position: center; background-attachment: fixed;
    }

    header{position:sticky;top:0;z-index:60;padding:12px 8px;text-align:center;color:#fff;backdrop-filter:blur(3px)}
    header h1{margin:0;font-family: 'UnifrakturCook', Poppins, Inter, sans-serif;font-weight:700;font-size:36px;letter-spacing:1px;
      text-shadow: 0 3px 0 rgba(0,0,0,0.5), 0 6px 18px rgba(0,0,0,0.6);
      color:#fff; text-transform:uppercase;}
    header p{display:none} /* —É–±—Ä–∞–Ω–æ —Å —ç–∫—Ä–∞–Ω–∞ ‚Äî —É–µ–¥–µ—Ç –≤ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫ */

    /* top-left profile + top-right bell */
    .profile-btn{position:fixed;left:12px;top:12px;z-index:100;width:48px;height:48px;border-radius:50%;border:2px solid #fff;background-size:cover;background-position:center;cursor:pointer}
    .bell-btn{position:fixed;right:12px;top:12px;z-index:100;width:48px;height:48px;border-radius:50%;border:2px solid #fff;background:#ffffffcc;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .bell-badge{position:absolute;right:-2px;top:-2px;background:#ef4444;color:#fff;font-size:11px;padding:2px 6px;border-radius:999px}

    nav.tabs{display:flex;gap:10px;justify-content:center;padding:10px 12px;position:sticky;top:86px;z-index:58}
    .tab-button{background:rgba(255,255,255,0.06);border:none;color:#fff;padding:8px 16px;font-weight:700;border-radius:12px;cursor:pointer}
    .tab-button.active{box-shadow: inset 0 -4px 0 var(--accent);background:rgba(0,0,0,0.22)}

    main.container{max-width:var(--max-width);margin:0 auto;padding:12px}
    .sys-msg{display:none} /* –±–æ–ª—å—à–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–µ */

    .tab-content{display:none}
    .tab-content.active{display:block}

    /* chat */
    .chat-area{height:calc(100vh - 330px);overflow:auto;padding:14px 8px;background:transparent}
    .messages{display:flex;flex-direction:column;gap:12px;padding-bottom:220px;transform:scale(var(--chat-scale));transform-origin:bottom left}
    .message{display:flex;gap:10px;align-items:flex-start;max-width:78%;word-break:break-word}
    .message.self{margin-left:auto;flex-direction:row-reverse}
    .avatar{width:var(--avatar-size);height:var(--avatar-size);border-radius:50%;object-fit:cover;flex:0 0 var(--avatar-size);box-shadow:0 3px 10px rgba(0,0,0,0.35);cursor:pointer}
    .message-content{background:var(--glass);padding:10px 12px;border-radius:14px;box-shadow:0 6px 30px rgba(2,6,23,0.18);color:#0b1220}
    .message.self .message-content{background:#E9FFF0}
    .message-meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .chat-image{max-width:300px;border-radius:8px;margin-top:8px;display:block}
    .message-content .text { font-family: 'UnifrakturCook', cursive; font-weight:700; font-size:1rem; color:#0b1220; }

    /* input bar */
    .chat-input{position:fixed;left:0;right:0;bottom:0;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.99));border-top:1px solid rgba(0,0,0,0.06);z-index:80;display:flex;gap:8px;align-items:center;max-width:var(--max-width);margin:0 auto}
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;cursor:pointer;width:48px;height:48px;border-radius:50%;background:#fff;border:1px solid #e6e6e6}
    .chat-input input[type="text"]{flex:1;padding:12px 14px;border-radius:24px;border:1px solid #d0d7de;font-size:16px;outline:none}
    .send-btn{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:20px;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(46,204,113,0.18)}
    .small-btn{padding:8px 10px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}

    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:95}
    .modal.show{display:flex}
    .modal-panel{background:#fff;border-radius:12px;padding:18px;width:92%;max-width:520px;position:relative;box-shadow:0 18px 80px rgba(2,6,23,0.4)}
    .modal-close{position:absolute;right:10px;top:8px;background:transparent;border:none;font-size:16px;cursor:pointer}
    .auth-form input{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #dcdcdc}
    .auth-actions{display:flex;gap:8px;justify-content:space-between}
    .auth-actions button{flex:1;padding:10px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer}
    .error-line{color:#b91c1c;font-size:13px;margin-top:6px}

    /* msg menu */
    .msg-menu{position:absolute;background:#fff;border-radius:8px;padding:6px;box-shadow:0 6px 20px rgba(0,0,0,0.2);z-index:200;display:none}
    .msg-menu button{display:block;border:none;background:transparent;padding:6px 10px;text-align:left;width:100%;cursor:pointer}
    .msg-menu button:hover{background:rgba(0,0,0,0.03)}

    /* help */
    .help-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;padding:12px}
    .help-card{background:#fff;padding:10px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .help-card img{width:100%;height:140px;object-fit:cover;border-radius:8px}

    /* friends list */
    .friends-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    .friend-item{display:flex;gap:10px;align-items:center;background:#fff;border-radius:10px;padding:10px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .friend-item img{width:44px;height:44px;border-radius:50%;object-fit:cover}

    /* admin */
    .admin-table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden}
    .admin-table th, .admin-table td{padding:10px;border-bottom:1px solid #eee;text-align:left}

    /* notifications dropdown */
    .notif-panel{position:fixed;right:12px;top:64px;width:320px;max-height:60vh;overflow:auto;background:#fff;border-radius:12px;box-shadow:0 18px 80px rgba(2,6,23,0.4);display:none;z-index:120}
    .notif-panel.show{display:block}
    .notif-item{padding:10px 12px;border-bottom:1px solid #f0f0f0;font-size:14px}
    .notif-item:last-child{border-bottom:none}

    #map{width:100%;height:calc(60vh);border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.3)}

    @media (max-width:640px){
      .chat-area{height:calc(100vh - 380px)}
      .chat-image{max-width:180px}
      .messages{transform:scale(1.06)}
      .profile-btn{left:8px;top:8px}
      .bell-btn{right:8px;top:8px}
    }
  </style>
</head>
<body>
  <header>
    <h1>–ü–†–ê–ì–ê –§–£–®–ö–ò</h1>
    <p></p>
  </header>

  <!-- –ö–Ω–æ–ø–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –∏ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫ -->
  <button id="profileBtn" class="profile-btn" title="–ü—Ä–æ—Ñ—ñ–ª—å" aria-label="–ü—Ä–æ—Ñ—ñ–ª—å"></button>
  <button id="bellBtn" class="bell-btn" title="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è" aria-label="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è">
    <span style="font-size:20px">üîî</span>
    <span id="bellBadge" class="bell-badge" style="display:none">0</span>
  </button>
  <div id="notifPanel" class="notif-panel" role="menu" aria-label="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è"></div>

  <!-- –í–∫–ª–∞–¥–∫–∏ -->
  <nav class="tabs" role="tablist" aria-label="–í–∫–ª–∞–¥–∫–∏">
    <button class="tab-button active" data-target="chatTab">üí¨ –ß–∞—Ç</button>
    <button class="tab-button" data-target="rentTab">üè† –ß–∞—Ç –û—Ä–µ–Ω–¥–∞</button>
    <button class="tab-button" data-target="mapTab">üó∫Ô∏è –ö–∞—Ä—Ç–∞</button>
    <button class="tab-button" data-target="friendsTab">üë• –î—Ä—É–∑—ñ</button>
    <button class="tab-button" data-target="helpTab">‚ùì –î–æ–ø–æ–º–æ–≥–∞</button>
    <button class="tab-button" data-target="adminTab" id="adminTabBtn" style="display:none">üõ°Ô∏è –ê–¥–º—ñ–Ω</button>
  </nav>

  <main class="container" role="main">
    <div class="sys-msg"></div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
    <section id="chatTab" class="tab-content active" role="region" aria-label="–ß–∞—Ç">
      <div class="chat-area" id="chatArea" aria-live="polite">
        <div id="messages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- –ß–∞—Ç –û—Ä–µ–Ω–¥–∞ (–æ–±—ã—á–Ω—ã–π —á–∞—Ç) -->
    <section id="rentTab" class="tab-content" role="region" aria-label="–ß–∞—Ç –û—Ä–µ–Ω–¥–∞">
      <div class="chat-area" id="rentArea" aria-live="polite" style="height:50vh">
        <div id="rentMessages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- –ö–∞—Ä—Ç–∞ -->
    <section id="mapTab" class="tab-content" role="region" aria-label="–ö–∞—Ä—Ç–∞" style="display:none;">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <div style="flex:1">
          <input id="mapSearch" placeholder="–ü–æ—à—É–∫ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –≤–æ–ª–æ–Ω—Ç–µ—Ä–∏, –∞–ø—Ç–µ–∫–∞)..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd">
        </div>
        <div>
          <button id="centerBtn" class="small-btn">–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏</button>
        </div>
      </div>
      <div id="map"></div>
    </section>

    <!-- –î—Ä—É–∑—ñ -->
    <section id="friendsTab" class="tab-content" role="region" aria-label="–î—Ä—É–∑—ñ" style="display:none;">
      <h2 style="color:#fff;margin:6px 0 10px">–í–∞—à—ñ –¥—Ä—É–∑—ñ</h2>
      <div id="friendsList" class="friends-list"></div>
    </section>

    <!-- –î–æ–ø–æ–º–æ–≥–∞ -->
    <section id="helpTab" class="tab-content" role="region" aria-label="–î–æ–ø–æ–º–æ–≥–∞" style="display:none;">
      <h2 style="color:#fff">–¢–µ—Ä–º—ñ–Ω–æ–≤–∞ –¥–æ–ø–æ–º–æ–≥–∞ —É –ü—Ä–∞–∑—ñ</h2>
      <div class="help-grid" id="helpGrid">
        <div class="help-card">
          <img src="https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp" alt="–ë–æ–ª—å–Ω–∏—Ü–∞">
          <h3>Nemocnice Motol</h3><p>–ê–¥—Ä–µ—Å–∞: V Uvalu 84</p>
        </div>
        <div class="help-card">
          <img src="https://i.ibb.co/0gWD5wW/images-5.jpg" alt="–Æ—Ä–∏—Å—Ç—ã">
          <h3>–Æ—Ä–∏–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞</h3><p>–î–æ–∫—É–º–µ–Ω—Ç–∏ —Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó</p>
        </div>
        <div class="help-card">
          <img src="https://i.ibb.co/R49shL6k/images-6.jpg" alt="–ú–∞–≥–∞–∑–∏–Ω—ã">
          <h3>–£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –º–∞–≥–∞–∑–∏–Ω–∏</h3><p>–ü—Ä–æ–¥—É–∫—Ç–∏ —Ç–∞ —Ç–æ–≤–∞—Ä–∏</p>
        </div>
      </div>
    </section>

    <!-- –ê–¥–º—ñ–Ω (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º) -->
    <section id="adminTab" class="tab-content" role="region" aria-label="–ê–¥–º—ñ–Ω" style="display:none;">
      <h2 style="color:#fff;margin:6px 0 10px">–ü–∞–Ω–µ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
      <div style="background:#fff;border-radius:10px;padding:10px;margin-bottom:12px">
        <button id="adminRefresh" class="small-btn">–û–Ω–æ–≤–∏—Ç–∏</button>
        <button id="adminPrunePresence" class="small-btn">–û—á–∏—Å—Ç–∏—Ç–∏ ¬´–º–µ—Ä—Ç–≤—ñ¬ª online</button>
      </div>
      <div style="overflow:auto">
        <table class="admin-table" id="adminMsgs">
          <thead><tr><th>–ß–∞—Å</th><th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th><th>–¢–µ–∫—Å—Ç</th><th>–î—ñ—ó</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- –í–≤–æ–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ —Å—Å—ã–ª–∫–µ -->
  <input id="fileInput" type="file" accept="image/*" style="display:none"> <!-- –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –æ—Å—Ç–∞–≤–ª–µ–Ω –∫–∞–∫ —Ö—É–∫ -->
  <div class="chat-input" role="region" aria-label="–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">
    <button id="imageUrlBtn" class="icon-btn" title="–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º">üñºÔ∏è</button>
    <input id="messageInput" type="text" inputmode="text" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." aria-label="–¢–µ–∫—Å—Ç" />
    <button id="sendButton" class="send-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
  </div>

  <!-- auth modal -->
  <div id="authModal" class="modal" aria-hidden="true">
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <button class="modal-close" id="modalClose">‚úñ</button>
      <h2 id="authTitle">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è / –í—Ö—ñ–¥</h2>

      <form id="registerForm" class="auth-form" onsubmit="return false;">
        <input id="nickInput" type="text" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" required />
        <input id="emailInput" type="email" placeholder="Email" required />
        <input id="passwordInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω—ñ–º—É–º 6)" required />
        <div class="auth-actions">
          <button id="registerSubmit" type="button">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
          <button id="loginShow" type="button" style="background:#4b5563">–£–≤—ñ–π—Ç–∏</button>
        </div>
        <div id="regError" class="error-line"></div>
      </form>

      <form id="loginForm" class="auth-form" style="display:none" onsubmit="return false;">
        <input id="loginEmail" type="email" placeholder="Email" required />
        <input id="loginPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" required />
        <div class="auth-actions">
          <button id="loginSubmit" type="button">–£–≤—ñ–π—Ç–∏</button>
          <button id="backToRegister" type="button" style="background:#4b5563">–ù–∞–∑–∞–¥</button>
        </div>
        <div id="loginError" class="error-line"></div>
      </form>
    </div>
  </div>

  <!-- profile modal -->
  <div id="profileModal" class="modal" aria-hidden="true">
    <div class="modal-panel" role="dialog" aria-modal="true">
      <button class="modal-close" id="profileClose">‚úñ</button>
      <div id="profileContent"></div>
    </div>
  </div>

  <!-- message actions menu -->
  <div id="msgMenu" class="msg-menu" role="menu">
    <button data-act="like">üëç –õ–∞–π–∫</button>
    <button data-act="warn">‚ö†Ô∏è –û—Å—Ç–µ—Ä–µ–∂–Ω–æ (—à–∞—Ö—Ä–∞–π)</button>
    <button data-act="dislike">üëé –î–∏–∑–ª–∞–π–∫</button>
    <button data-act="spam">üö´ –°–ø–∞–º</button>
    <button data-act="reply">‚Ü©Ô∏è –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏</button>
  </div>
    <!-- Firebase + App logic -->
  <script type="module">
    /* ---------- Firebase (v9 modular) ---------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile,
      sendEmailVerification, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getDatabase, ref as dbRef, push as dbPush, onChildAdded, query, orderByChild, limitToLast,
      get as dbGet, set as dbSet, onValue, remove as dbRemove, update as dbUpdate
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // --- –¢–í–û–ò –ö–õ–Æ–ß–ò (–æ—Å—Ç–∞–≤–ª—è—é –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
      authDomain: "praga-4baee.firebaseapp.com",
      databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
      projectId: "praga-4baee",
      storageBucket: "praga-4baee.firebasestorage.app",
      messagingSenderId: "336023952536",
      appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
      measurementId: "G-BGDJD6R12N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    /* ---------- DOM ---------- */
    const tabButtons = document.querySelectorAll(".tab-button");
    const tabContents = document.querySelectorAll(".tab-content");
    const messagesEl = document.getElementById("messages");
    const rentMessagesEl = document.getElementById("rentMessages");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    const fileInput = document.getElementById("fileInput"); // –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º (–æ—Å—Ç–∞–≤–ª–µ–Ω)
    const imageUrlBtn = document.getElementById("imageUrlBtn");
    const authModal = document.getElementById("authModal");
    const registerForm = document.getElementById("registerForm");
    const loginForm = document.getElementById("loginForm");
    const nickInput = document.getElementById("nickInput");
    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");
    const registerSubmit = document.getElementById("registerSubmit");
    const loginShow = document.getElementById("loginShow");
    const loginSubmit = document.getElementById("loginSubmit");
    const backToRegister = document.getElementById("backToRegister");
    const loginEmail = document.getElementById("loginEmail");
    const loginPassword = document.getElementById("loginPassword");
    const modalClose = document.getElementById("modalClose");
    const regError = document.getElementById("regError");
    const loginError = document.getElementById("loginError");
    const profileBtn = document.getElementById("profileBtn");
    const profileModal = document.getElementById("profileModal");
    const profileContent = document.getElementById("profileContent");
    const profileClose = document.getElementById("profileClose");
    const msgMenu = document.getElementById("msgMenu");
    const mapSearch = document.getElementById("mapSearch");
    const centerBtn = document.getElementById("centerBtn");
    const adminTabBtn = document.getElementById("adminTabBtn");
    const adminMsgsTbody = document.querySelector("#adminMsgs tbody");
    const friendsListEl = document.getElementById("friendsList");
    const bellBtn = document.getElementById("bellBtn");
    const bellBadge = document.getElementById("bellBadge");
    const notifPanel = document.getElementById("notifPanel");

    /* ---------- State ---------- */
    const DEFAULT_AVATAR = "https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg";
    let currentUser = null;
    const MSG_LIMIT = 200;
    let pendingImageURL = null; // —Ñ–æ—Ç–æ –ø–æ —Å—Å—ã–ª–∫–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const BOT_SLOWDOWN = 1.6;   // 60% –º–µ–¥–ª–µ–Ω–Ω–µ–µ

    /* ---------- UI: tabs + hotkeys ---------- */
    function setActiveTab(id) {
      tabButtons.forEach(b => b.classList.toggle("active", b.dataset.target === id));
      tabContents.forEach(c => c.style.display = (c.id === id) ? "block" : "none");
      if (id === "chatTab" || id === "rentTab") messageInput.focus();
      if (id === "mapTab") {
        if (typeof google !== "undefined" && window.map) {
          google.maps.event.trigger(window.map, "resize");
        }
      }
      localStorage.setItem("activeTab", id);
    }
    // restore last tab
    const savedTab = localStorage.getItem("activeTab");
    if (savedTab) setActiveTab(savedTab);

    tabButtons.forEach(btn => btn.addEventListener("click", ()=> setActiveTab(btn.dataset.target)));
    document.addEventListener("keydown", (e)=> {
      const k = e.key.toLowerCase();
      if (k === 'c') setActiveTab("chatTab");
      if (k === 'r') setActiveTab("rentTab");
      if (k === 'm') setActiveTab("mapTab");
      if (k === 'h') setActiveTab("helpTab");
      if (k === 'f') setActiveTab("friendsTab");
      if (k === 'a') { if (adminTabBtn.style.display !== "none") setActiveTab("adminTab"); }
    });

    /* ---------- Notifications (–∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫) ---------- */
    const DEFAULT_NOTIFS = [
      { id:"welcome", ts: Date.now(), text: "–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –¥–æ —á–∞—Ç—É! –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –¥–∞—î 6 –≥–æ–¥–∏–Ω –¥–æ—Å—Ç—É–ø—É –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email." },
      { id:"imageTip", ts: Date.now(), text: "–§–æ—Ç–æ –¥–æ–¥–∞—é—Ç—å—Å—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º ‚Äî –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å üñºÔ∏è –∑–ª—ñ–≤–∞ –≤—ñ–¥ –ø–æ–ª—è –≤–≤–æ–¥—É." }
    ];
    function loadNotifs(){
      const raw = localStorage.getItem("pf_notifs");
      let list = raw ? JSON.parse(raw) : [];
      if (!raw){ list = DEFAULT_NOTIFS; localStorage.setItem("pf_notifs", JSON.stringify(list)); }
      return list;
    }
    function saveNotifs(list){ localStorage.setItem("pf_notifs", JSON.stringify(list)); }
    function renderNotifs(){
      const list = loadNotifs().sort((a,b)=> b.ts-a.ts);
      notifPanel.innerHTML = list.map(n=>`<div class="notif-item"><div>${n.text}</div><div style="font-size:12px;color:#64748b">${new Date(n.ts).toLocaleString()}</div></div>`).join("") || '<div class="notif-item">–ü–æ–∫–∏ —â–æ –ø–æ—Ä–æ–∂–Ω—å–æ</div>';
      bellBadge.style.display = list.length ? "inline-block" : "none";
      bellBadge.textContent = String(list.length);
    }
    function addNotif(text){ const list = loadNotifs(); list.push({id:String(Date.now()), ts:Date.now(), text}); saveNotifs(list); renderNotifs(); }
    bellBtn.addEventListener("click", ()=> { notifPanel.classList.toggle("show"); renderNotifs(); });
    document.addEventListener("click", (e)=>{ if (!notifPanel.contains(e.target) && e.target!==bellBtn) notifPanel.classList.remove("show"); });

    /* ---------- Auth ---------- */
    function showAuthModal(){ authModal.classList.add("show"); authModal.setAttribute("aria-hidden","false"); regError.textContent=""; loginError.textContent=""; }
    function hideAuthModal(){ authModal.classList.remove("show"); authModal.setAttribute("aria-hidden","true"); }
    modalClose?.addEventListener("click", hideAuthModal);
    loginShow?.addEventListener("click", ()=>{ registerForm.style.display="none"; loginForm.style.display="block"; });
    backToRegister?.addEventListener("click", ()=>{ registerForm.style.display="block"; loginForm.style.display="none"; });

    registerSubmit?.addEventListener("click", async ()=> {
      regError.textContent = "";
      const nick = nickInput.value.trim();
      const email = emailInput.value.trim();
      const pass = passwordInput.value.trim();
      if (!nick || !email || !pass) { regError.textContent = "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è"; return; }
      if (pass.length < 6) { regError.textContent = "–ü–∞—Ä–æ–ª—å –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤"; return; }
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(cred.user, { displayName: nick, photoURL: DEFAULT_AVATAR });
        await dbSet(dbRef(db, `users/${cred.user.uid}`), { nick, email, avatar: DEFAULT_AVATAR, createdAt: Date.now(), online: true, role: "user" });
        localStorage.setItem("regTime_" + cred.user.uid, String(Date.now()));
        await sendEmailVerification(cred.user);
        hideAuthModal();
        addNotif("–í–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ. –õ–∏—Å—Ç –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ. –£ –≤–∞—Å 6 –≥–æ–¥–∏–Ω –¥–æ—Å—Ç—É–ø—É –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è.");
      } catch (err) { console.error("register err", err); regError.textContent = err?.message || String(err); }
    });

    loginSubmit?.addEventListener("click", async ()=> {
      loginError.textContent = "";
      const email = loginEmail.value.trim();
      const pass = loginPassword.value.trim();
      if (!email || !pass) { loginError.textContent = "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å email —ñ –ø–∞—Ä–æ–ª—å"; return; }
      try { await signInWithEmailAndPassword(auth, email, pass); hideAuthModal(); }
      catch (err) { console.error("login err", err); loginError.textContent = err?.message || String(err); }
    });

    onAuthStateChanged(auth, async (user)=> {
      currentUser = user;
      if (user) {
        profileBtn.style.background = `url(${user.photoURL || DEFAULT_AVATAR}) center/cover`;
        try { await dbSet(dbRef(db, `presence/${user.uid}`), { ts: Date.now(), nick: user.displayName || user.email }); } catch(e){}
        // admin?
        try {
          const s = await dbGet(dbRef(db, `users/${user.uid}/role`));
          const role = s.exists() ? s.val() : "user";
          adminTabBtn.style.display = role === "admin" ? "inline-block" : "none";
        } catch(e){}
      } else {
        profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`;
        adminTabBtn.style.display = "none";
      }
      updateOnlineCount();
      renderFriends();
    });

    /* ---------- Access rule: verified OR 6 hours ---------- */
    async function canSendMessage(){
      const user = auth.currentUser;
      if (!user) return false;
      if (user.emailVerified) return true;
      const localKey = "regTime_" + user.uid;
      const localVal = localStorage.getItem(localKey);
      const sixHours = 6 * 60 * 60 * 1000;
      if (localVal && (Date.now() - Number(localVal) < sixHours)) return true;
      try {
        const snap = await dbGet(dbRef(db, `users/${user.uid}/createdAt`));
        if (snap && snap.exists()) {
          const created = Number(snap.val());
          if (!Number.isNaN(created) && Date.now() - created < sixHours) {
            localStorage.setItem(localKey, String(created));
            return true;
          }
        }
      } catch (e) { console.error("canSendMessage db get error", e); }
      return false;
    }

    /* ---------- Render messages ---------- */
    function timeStr(ts){ return new Date(ts).toLocaleString(); }
    function renderMessage(m, container = messagesEl){
      if (!m || !m.ts) return;
      const wrap = document.createElement("div");
      wrap.className = "message" + ((currentUser && m.uid === currentUser.uid) ? " self" : "");
      wrap.dataset.uid = m.uid || "";
      wrap.dataset.msgid = m.id || "";

      const avatar = document.createElement("img");
      avatar.className = "avatar";
      avatar.src = m.avatar || DEFAULT_AVATAR;
      avatar.alt = m.nick || "avatar";
      avatar.title = m.nick || "–ü–æ–∫–∞–∑ –ø—Ä–æ—Ñ—ñ–ª—é";
      avatar.addEventListener("click", ()=> openProfile(m.uid));

      const txt = document.createElement("div");
      txt.className = "message-content";
      const meta = document.createElement("div");
      meta.className = "message-meta";
      meta.textContent = `${m.nick || "–ê–Ω–æ–Ω—ñ–º"} ¬∑ ${timeStr(m.ts)}` + (m.recipientUid ? " ¬∑ –æ—Å–æ–±–∏—Å—Ç–µ" : "");
      txt.appendChild(meta);

      if (m.text) {
        const p = document.createElement("div");
        p.className = "text";
        p.innerText = m.text;
        txt.appendChild(p);
      }
      if (m.imageUrl) {
        const im = document.createElement("img");
        im.src = m.imageUrl;
        im.alt = "–§–æ—Ç–æ";
        im.className = "chat-image";
        txt.appendChild(im);
      }

      wrap.appendChild(avatar);
      wrap.appendChild(txt);
      container.appendChild(wrap);

      // –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
      wrap.addEventListener('contextmenu', (ev) => {
        ev.preventDefault();
        showMsgMenu(ev.pageX, ev.pageY, m, wrap);
      });

      // –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
      const chatArea = container.closest('.chat-area');
      if (chatArea) {
        const nearBottom = chatArea.scrollHeight - chatArea.scrollTop - chatArea.clientHeight < 200;
        if (nearBottom) chatArea.scrollTop = chatArea.scrollHeight;
      }
    }

    /* ---------- Subscribe feeds (main + rent) ---------- */
    const msgsQuery = query(dbRef(db, "messages"), orderByChild("ts"), limitToLast(MSG_LIMIT));
    onChildAdded(msgsQuery, (snap) => { const m = snap.val(); m.id = snap.key; renderMessage(m, messagesEl); });
    const rentQuery = query(dbRef(db, "rentMessages"), orderByChild("ts"), limitToLast(MSG_LIMIT));
    onChildAdded(rentQuery, (snap) => { const m = snap.val(); m.id = snap.key; renderMessage(m, rentMessagesEl); });

    /* ---------- Image by URL ---------- */
    imageUrlBtn.addEventListener("click", ()=>{
      if (!auth.currentUser) { showAuthModal(); return; }
      const url = prompt("–í—Å—Ç–∞–≤—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (https://‚Ä¶):");
      if (!url) return;
      try {
        new URL(url);
        pendingImageURL = url;
        addNotif("–î–æ–¥–∞–Ω–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ñ–æ—Ç–æ. –í—ñ–¥–ø—Ä–∞–≤—Ç–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —â–æ–± –ø—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏.");
      } catch { alert("–ù–µ–≤—ñ—Ä–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è"); }
    });

    /* ---------- Send message (main or rent depending on active tab) ---------- */
    function activeChatPath(){
      const btn = Array.from(tabButtons).find(b=>b.classList.contains("active"));
      if (!btn) return "messages";
      const target = btn.dataset.target;
      return target === "rentTab" ? "rentMessages" : "messages";
    }

    sendButton.addEventListener("click", async ()=>{
      if (!auth.currentUser) { showAuthModal(); return; }
      if (!await canSendMessage()) { alert("–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å email –∞–±–æ —Å–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—å 6-–≥–æ–¥–∏–Ω–Ω–∏–º –¥–æ—Å—Ç—É–ø–æ–º –ø—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó."); return; }

      const text = messageInput.value.trim();
      if (!text && !pendingImageURL) return;

      const msg = {
        uid: auth.currentUser.uid,
        nick: auth.currentUser.displayName || auth.currentUser.email || "–ê–Ω–æ–Ω—ñ–º",
        avatar: auth.currentUser.photoURL || DEFAULT_AVATAR,
        text: text || null,
        imageUrl: pendingImageURL || null,
        ts: Date.now(),
        recipientUid: null
      };

      try {
        await dbPush(dbRef(db, activeChatPath()), msg);
        messageInput.value = "";
        pendingImageURL = null;
      } catch (err) {
        console.error("dbPush error", err);
        alert("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è");
      }
    });

    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendButton.click(); }
    });

    /* ---------- Profile ---------- */
    profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`;
    profileBtn.addEventListener("click", async ()=> {
      if (!auth.currentUser) { showAuthModal(); return; }
      const uid = auth.currentUser.uid;
      openProfile(uid, true);
    });
    profileClose.addEventListener("click", ()=> { profileModal.classList.remove("show"); profileModal.setAttribute("aria-hidden","true"); });

    async function openProfile(uid, self=false){
      profileContent.innerHTML = "<p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>";
      profileModal.classList.add("show"); profileModal.setAttribute("aria-hidden","false");
      try {
        const snap = await dbGet(dbRef(db, `users/${uid}`));
        const user = snap && snap.exists() ? snap.val() : { nick: "–ê–Ω–æ–Ω—ñ–º", avatar: DEFAULT_AVATAR };
        const isSelf = auth.currentUser && auth.currentUser.uid === uid;
        profileContent.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center">
            <img src="${user.avatar || DEFAULT_AVATAR}" style="width:84px;height:84px;border-radius:12px;object-fit:cover">
            <div>
              <h3>${user.nick || "–ê–Ω–æ–Ω—ñ–º"}</h3>
              <div style="color:${user.email ? '#333' : '#666'}">${user.email || ''}</div>
            </div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px">
            ${isSelf ? '<button id="editAvatarBtn" class="small-btn">–ó–º—ñ–Ω–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä (URL)</button>' : `<button id="pmBtn" class="small-btn">–ù–∞–ø–∏—Å–∞—Ç–∏</button><button id="addFriendBtn" class="small-btn">–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>`}
            <button id="viewPhotosBtn" class="small-btn">–ì–∞–ª–µ—Ä–µ—è</button>
          </div>
          <div id="profileMsg" style="margin-top:8px;color:#b91c1c"></div>
        `;
        if (isSelf){
          document.getElementById("editAvatarBtn").addEventListener("click", async ()=> {
            const url = prompt("–í—Å—Ç–∞–≤—Ç–µ URL –∞–≤–∞—Ç–∞—Ä–∞ (https://‚Ä¶):");
            if (!url) return;
            try{
              new URL(url);
              await dbSet(dbRef(db, `users/${uid}/avatar`), url);
              await updateProfile(auth.currentUser, { photoURL: url });
              profileContent.querySelector('img').src = url;
              profileBtn.style.background = `url(${url}) center/cover`;
              addNotif("–ê–≤–∞—Ç–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ");
            }catch(e){ alert("–ù–µ–≤—ñ—Ä–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è"); }
          });
        } else {
          document.getElementById("pmBtn").addEventListener("click", ()=> {
            profileModal.classList.remove("show"); profileModal.setAttribute("aria-hidden","true");
            openPrivateChat(uid);
          });
          document.getElementById("addFriendBtn").addEventListener("click", async ()=> {
            if (!auth.currentUser) { showAuthModal(); return; }
            try {
              await dbSet(dbRef(db, `friends/${auth.currentUser.uid}/${uid}`), { ts: Date.now() });
              document.getElementById("profileMsg").textContent = "–î–æ–¥–∞–Ω–æ –≤ –¥—Ä—É–∑—ñ / –∑–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ.";
              renderFriends();
            } catch(e){ document.getElementById("profileMsg").textContent = "–ü–æ–º–∏–ª–∫–∞"; }
          });
        }
      } catch(e){ profileContent.innerHTML = "<p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</p>"; }
    }

    /* ---------- Private chat ---------- */
    async function openPrivateChat(otherUid){
      if (!auth.currentUser){ showAuthModal(); return; }
      const uid = auth.currentUser.uid;
      const convoId = uid < otherUid ? uid + "_" + otherUid : otherUid + "_" + uid;
      const text = prompt("–ù–∞–ø–∏—à—ñ—Ç—å –æ—Å–æ–±–∏—Å—Ç–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:");
      if (!text) return;
      const pm = { from: uid, to: otherUid, text, ts: Date.now() };
      await dbPush(dbRef(db, `privateMessages/${convoId}`), pm);
      addNotif("–û—Å–æ–±–∏—Å—Ç–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ");
    }

    /* ---------- Message menu (reactions, reply) ---------- */
    function showMsgMenu(x,y,msg,wrap){
      msgMenu.style.left = x + "px"; msgMenu.style.top = y + "px"; msgMenu.style.display = "block";
      const hide = ()=> { msgMenu.style.display = "none"; document.removeEventListener("click", hide); };
      document.addEventListener("click", hide, { once:true });
      msgMenu.querySelectorAll('button').forEach(btn=>{
        btn.onclick = async ()=> {
          const act = btn.dataset.act;
          try {
            if (act === 'reply') {
              const r = prompt("–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:");
              if (r) {
                await dbPush(dbRef(db, activeChatPath()), {
                  uid: auth.currentUser.uid,
                  nick: auth.currentUser.displayName || auth.currentUser.email,
                  avatar: auth.currentUser.photoURL || DEFAULT_AVATAR,
                  text: "‚Ü©Ô∏è –í—ñ–¥–ø–æ–≤—ñ–¥—å: " + r,
                  ts: Date.now(),
                  recipientUid: msg.uid
                });
              }
            } else {
              if (msg.id) {
                await dbSet(dbRef(db, `messageReactions/${msg.id}/${auth.currentUser.uid}`), { act, ts: Date.now() });
                addNotif("–î—ñ—è –≤–∏–∫–æ–Ω–∞–Ω–∞: " + act);
              } else alert("–ù–µ–º–∞—î id –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è");
            }
          } catch(e){ console.error(e); alert("–ü–æ–º–∏–ª–∫–∞ –¥—ñ—ó"); }
        };
      });
    }

    /* ---------- Friends ---------- */
    async function getFriendsOnline(){
      if (!currentUser) return [];
      const snap = await dbGet(dbRef(db, `friends/${currentUser.uid}`));
      const friends = snap && snap.exists() ? Object.keys(snap.val()) : [];
      const online = [];
      for (const f of friends){
        const p = await dbGet(dbRef(db, `presence/${f}`));
        if (p && p.exists()) {
          const u = await dbGet(dbRef(db, `users/${f}`));
          online.push({ uid:f, ...(p.val()||{}), ...(u.exists()?u.val():{}) });
        }
      }
      return online;
    }

    async function renderFriends(){
      if (!auth.currentUser){ friendsListEl.innerHTML = "<div class='notif-item'>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –±–∞—á–∏—Ç–∏ –¥—Ä—É–∑—ñ–≤</div>"; return; }
      const online = await getFriendsOnline();
      if (!online.length){ friendsListEl.innerHTML = "<div class='notif-item'>–ü–æ–∫–∏ —â–æ –Ω—ñ–∫–æ–≥–æ –æ–Ω–ª–∞–π–Ω</div>"; return; }
      friendsListEl.innerHTML = online.map(f=>`
        <div class="friend-item">
          <img src="${f.avatar || DEFAULT_AVATAR}" alt="">
          <div style="flex:1">
            <div style="font-weight:700">${f.nick || f.email || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</div>
            <div style="font-size:12px;color:#64748b">${new Date(f.ts||Date.now()).toLocaleString()}</div>
          </div>
          <button class="small-btn" data-uid="${f.uid}" data-act="pm">–ù–∞–ø–∏—Å–∞—Ç–∏</button>
          <button class="small-btn" data-uid="${f.uid}" data-act="remove">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        </div>
      `).join("");
      friendsListEl.querySelectorAll("button").forEach(b=>{
        b.onclick = async ()=>{
          const uid = b.dataset.uid; const act = b.dataset.act;
          if (act==="pm") openPrivateChat(uid);
          if (act==="remove"){
            if (!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –∑ –¥—Ä—É–∑—ñ–≤?")) return;
            await dbRemove(dbRef(db, `friends/${auth.currentUser.uid}/${uid}`));
            renderFriends();
          }
        };
      });
    }

    /* ---------- Presence / online counter ---------- */
    function updateOnlineCount(){
      onValue(dbRef(db, "presence"), (snap)=>{
        const val = snap.val() || {};
        const real = Object.keys(val).length;
        const shown = real * 10; // –∫–∞–∫ —É —Ç–µ–±—è
        // –ø–µ—Ä–µ–Ω–æ—Å –∏–Ω—Ñ–æ –≤ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫ –≤–º–µ—Å—Ç–æ —ç–∫—Ä–∞–Ω–∞
        addNotif(`–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): ${shown}`);
      });
    }

    // –ø–æ–ø—ã—Ç–∫–∞ —É–±—Ä–∞—Ç—å presence –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ
    window.addEventListener('beforeunload', async ()=> {
      try{ await dbRemove(dbRef(db, `presence/${auth.currentUser?.uid}`)); } catch(e){}
    });
    /* ---------- Bots (60% –º–µ–¥–ª–µ–Ω–Ω–µ–µ) ---------- */
    const BOTS = [
      { uid: "bot_1", nick:"Bot_–û–≥–æ–ª–æ—à–µ–Ω–Ω—è_1", ads: ["üç≤ –ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∞ —ó–∂–∞ ‚Äî –∞–¥—Ä–µ—Å–∞ A","üéí –†–µ—á—ñ –¥–ª—è –¥—ñ—Ç–µ–π ‚Äî –ø—É–Ω–∫—Ç B","‚õëÔ∏è –ü–µ—Ä—à–æ–ø–æ–º—ñ—á ‚Äî —ñ–Ω—Ñ–æ C"], interval: 2*60*1000 },
      { uid: "bot_2", nick:"Bot_–û–≥–æ–ª–æ—à–µ–Ω–Ω—è_2", ads: ["üèòÔ∏è –î–æ–ø–æ–º–æ–≥–∞ –∑ –∂–∏—Ç–ª–æ–º ‚Äî –∫–æ–Ω—Ç–∞–∫—Ç–∏ D","üéÅ –ü–∞–∫–µ—Ç–∏ –¥–æ–ø–æ–º–æ–≥–∏ ‚Äî –ø—É–Ω–∫—Ç E","ü§ù –Ü–≤–µ–Ω—Ç –≤–æ–ª–æ–Ω—Ç–µ—Ä—ñ–≤ ‚Äî F"], interval: 3*60*1000 },
      { uid: "bot_3", nick:"Bot_–û–≥–æ–ª–æ—à–µ–Ω–Ω—è_3", ads: ["‚öñÔ∏è –Æ—Ä–∏–¥–∏—á–Ω—ñ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó ‚Äî G","üçõ –ì–∞—Ä—è—á—ñ –æ–±—ñ–¥–∏ ‚Äî H","üó£Ô∏è –ö—É—Ä—Å–∏ –º–æ–≤–∏ ‚Äî I"], interval: 4*60*1000 },
    ];
    (function startBotsOnce(){
      if (window.__botsStarted) return; window.__botsStarted = true;
      BOTS.forEach((bot)=>{
        let i = 0;
        const interval = Math.round(bot.interval * BOT_SLOWDOWN);
        setInterval(async ()=>{
          const text = bot.ads[i % bot.ads.length]; i++;
          try {
            await dbPush(dbRef(db, "messages"), {
              uid: bot.uid, nick: bot.nick, avatar: DEFAULT_AVATAR, text, ts: Date.now()
            });
          } catch(e){ console.error("bot push err", e); }
        }, interval);
      });
    })();

    /* ---------- Map ---------- */
    const POINTS = [
      { title: "Nemocnice Motol", pos: {lat:50.058, lng:14.360}, cat:"hospital" },
      { title: "Nemocnice Na Frantisku", pos: {lat:50.086, lng:14.418}, cat:"hospital" },
      { title: "Klinika Praha", pos: {lat:50.078, lng:14.422}, cat:"hospital" },
      { title: "Pravni pomoc —Ü–µ–Ω—Ç—Ä A", pos: {lat:50.083, lng:14.412}, cat:"lawyer" },
      { title: "Pravni pomoc —Ü–µ–Ω—Ç—Ä B", pos: {lat:50.089, lng:14.430}, cat:"lawyer" },
      { title: "Advokatni kancelar C", pos: {lat:50.071, lng:14.425}, cat:"lawyer" },
      { title: "Albert Supermarket", pos: {lat:50.084, lng:14.417}, cat:"shop" },
      { title: "Billa City", pos: {lat:50.076, lng:14.437}, cat:"shop" },
      { title: "Kaufland Praha", pos: {lat:50.085, lng:14.414}, cat:"shop" },
      { title: "Pomoc Centrum 1", pos: {lat:50.082, lng:14.419}, cat:"help" },
      { title: "Pomoc –¶–µ–Ω—Ç—Ä 2", pos: {lat:50.088, lng:14.427}, cat:"help" },
      { title: "Shelter Point", pos: {lat:50.074, lng:14.432}, cat:"help" },
      { title: "Clinic D", pos: {lat:50.090, lng:14.418}, cat:"hospital" },
      { title: "Clinic E", pos: {lat:50.079, lng:14.404}, cat:"hospital" },
      { title: "Law Office D", pos: {lat:50.081, lng:14.440}, cat:"lawyer" },
      { title: "Shop D", pos: {lat:50.083, lng:14.445}, cat:"shop" },
      { title: "Shop E", pos: {lat:50.0715, lng:14.421}, cat:"shop" },
      { title: "Help Center 3", pos: {lat:50.086, lng:14.431}, cat:"help" },
      { title: "Help Center 4", pos: {lat:50.072, lng:14.439}, cat:"help" },
      { title: "Medical Aid 8", pos: {lat:50.0875, lng:14.435}, cat:"hospital" },
      { title: "Legal Aid 9", pos: {lat:50.0785, lng:14.410}, cat:"lawyer" },
      { title: "Shop F", pos: {lat:50.080, lng:14.408}, cat:"shop" },
      { title: "Community Aid", pos: {lat:50.0835, lng:14.425}, cat:"help" },
      { title: "Charity Hub", pos: {lat:50.079, lng:14.430}, cat:"help" },
      { title: "Pharmacy 1", pos: {lat:50.088, lng:14.420}, cat:"shop" }
    ];

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π init —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –¥–≤–æ–π–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    window.initMap = function(){
      try{
        if (window.map) return; // —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
        const center = { lat: 50.0755, lng: 14.4378 };
        window.map = new google.maps.Map(document.getElementById("map"), { center, zoom:13, gestureHandling:"greedy" });
        window.markers = [];
        POINTS.forEach(p=>{
          const color = (p.cat==="hospital")?"#FF6B6B":(p.cat==="lawyer")?"#4D96FF":(p.cat==="shop")?"#FFD166":"#8AF598";
          const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36"><circle cx="18" cy="18" r="12" fill="${color}" stroke="#fff" stroke-width="3"/></svg>`);
          const mk = new google.maps.Marker({
            position:p.pos, map:window.map, title:p.title,
            icon:{url:`data:image/svg+xml;utf8,${svg}`, scaledSize:new google.maps.Size(36,36)}
          });
          mk.title = p.title; mk.cat = p.cat;
          mk.addListener('click', ()=> new google.maps.InfoWindow({content:`<b>${p.title}</b><div>${p.cat}</div>`}).open(window.map, mk));
          window.markers.push(mk);
        });

        centerBtn?.addEventListener("click", ()=> window.map.panTo(center));
        mapSearch?.addEventListener("input", (e)=> {
          const q = e.target.value.trim().toLowerCase();
          window.markers.forEach(mk => mk.setVisible(!q || mk.title.toLowerCase().includes(q)));
        });

        // –æ—Ç–º–µ—Ç–∏–º —É—Å–ø–µ—à–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        localStorage.setItem("map_inited","1");
      }catch(err){
        console.error("initMap error", err);
      }
    };

    // –µ—Å–ª–∏ –∫–∞—Ä—Ç–∞ ¬´–ª–æ–º–∞–ª–∞—Å—å¬ª, –Ω–µ –∫—Ä–∞—à–∏–º UI
    window.addEventListener("error", (e)=>{
      if ((e.message||"").includes("google")) {
        addNotif("–ü–æ–º–∏–ª–∫–∞ Google Maps. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–ª—é—á API.");
      }
    });

    /* ---------- Admin panel ---------- */
    async function adminLoadLast(n=100){
      adminMsgsTbody.innerHTML = "<tr><td colspan='4'>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td></tr>";
      // –±–µ—Ä—ë–º –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —á–∞—Ç–∞
      const snap = await dbGet(dbRef(db, "messages"));
      const list = [];
      if (snap.exists()){
        const obj = snap.val();
        for (const id in obj){ list.push({ id, ...obj[id] }); }
      }
      list.sort((a,b)=> b.ts - a.ts);
      const rows = list.slice(0,n).map(m=>`
        <tr data-id="${m.id}">
          <td>${timeStr(m.ts)}</td>
          <td>${m.nick || m.uid}</td>
          <td>${(m.text||"")}${m.imageUrl?`<div><a href="${m.imageUrl}" target="_blank">[—Ñ–æ—Ç–æ]</a></div>`:""}</td>
          <td>
            <button class="small-btn" data-act="del" data-id="${m.id}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            <button class="small-btn" data-act="ban" data-uid="${m.uid}">Ban</button>
          </td>
        </tr>
      `).join("");
      adminMsgsTbody.innerHTML = rows || "<tr><td colspan='4'>–ü–æ—Ä–æ–∂–Ω—å–æ</td></tr>";
      adminMsgsTbody.querySelectorAll("button").forEach(b=>{
        b.onclick = async ()=>{
          const act = b.dataset.act;
          if (act==="del"){
            const id = b.dataset.id;
            if (!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è?")) return;
            await dbRemove(dbRef(db, `messages/${id}`));
            b.closest("tr")?.remove();
          } else if (act==="ban"){
            const uid = b.dataset.uid;
            if (!confirm("–ü–æ–∑–Ω–∞—á–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —è–∫ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ–≥–æ?")) return;
            await dbUpdate(dbRef(db, `users/${uid}`), { banned:true });
            addNotif("–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–æ–∑–Ω–∞—á–µ–Ω–∏–π —è–∫ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π");
          }
        };
      });
    }
    document.getElementById("adminRefresh")?.addEventListener("click", ()=> adminLoadLast());
    document.getElementById("adminPrunePresence")?.addEventListener("click", async ()=>{
      const snap = await dbGet(dbRef(db, "presence"));
      if (snap.exists()){
        const now = Date.now();
        const obj = snap.val();
        let removed = 0;
        for (const uid in obj){
          if (!obj[uid]?.ts || now - obj[uid].ts > 1000*60*60*6){ // 6h stale
            await dbRemove(dbRef(db, `presence/${uid}`));
            removed++;
          }
        }
        addNotif(`–ü—Ä–∏–±—Ä–∞–Ω–æ ¬´–º–µ—Ä—Ç–≤–∏—Ö¬ª: ${removed}`);
      }
    });

    // –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω-—Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∞–¥–º–∏–Ω-–≤–∫–ª–∞–¥–∫—É
    document.getElementById("adminTabBtn")?.addEventListener("click", ()=> setTimeout(()=>adminLoadLast(), 50));

    /* ---------- Initial tweaks ---------- */
    document.addEventListener('DOMContentLoaded', ()=> {
      profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`;
      renderNotifs();
    });
  </script>

  <!-- Google Maps (—Ç–≤–æ–π –∫–ª—é—á) -->
  <!-- –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á, –ø–æ–º–µ–Ω—è–π –∑–¥–µ—Å—å: -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFrxVhpb6nHJ6rhiLl5Ho8t0jOb1iEQNc&callback=initMap"></script>
</body>
</html>
