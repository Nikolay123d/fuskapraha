<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ü—Ä–∞–≥–∞ –§—É—à–∫–∏ ‚Äî –î–æ–ø–æ–º–æ–≥–∞ —É–∫—Ä–∞—ó–Ω—Ü—è–º</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #000 url('https://i.ibb.co/27hgtZfY/Prague.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
    }
    header {
      <!-- –ü—Ä–æ—Ñ—ñ–ª—å –ª—ñ–≤–æ—Ä—É—á -->
<button id="profileBtn" class="icon-btn" title="–ü—Ä–æ—Ñ—ñ–ª—å" style="left:10px;top:8px;background-image:url('https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg')"></button>

<!-- –ü—Ä–∞–≤–æ—Ä—É—á: ‚öôÔ∏è —Ç–∞ üîî -->
<div class="header-actions">
  <button id="gearBtn" class="icon-btn" title="–ê–¥–º—ñ–Ω" style="display:none">‚öôÔ∏è</button>
  <div style="position:relative">
    <button id="bellBtn" class="icon-btn" title="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è">üîî</button>
    <span id="bellBadge" class="badge">0</span>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª: –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è -->
<div id="bellModal" class="modal">
  <div class="panel">
    <button class="close" id="bellClose">‚úñ</button>
    <h3>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h3>
    <div id="notifList" style="max-height:60vh;overflow:auto"></div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª: –ü—Ä–æ—Ñ—ñ–ª—å (–∫–æ–Ω—Ç–µ–Ω—Ç –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º) -->
<div id="profileModal" class="modal">
  <div class="panel">
    <button class="close" id="profileClose">‚úñ</button>
    <div id="profileContent">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª: –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –£—á–∞—Å–Ω–∏–∫–∏ -->
<div id="adminModal" class="modal">
  <div class="panel">
    <button class="close" id="adminClose">‚úñ</button>
    <h3>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <button id="btnClearChat">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ —á–∞—Ç</button>
      <button id="btnClearRent">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –æ—Ä–µ–Ω–¥—É</button>
      <button id="btnReloadUsers">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
    </div>
    <div id="usersList" style="max-height:60vh;overflow:auto;border:1px solid #eee;border-radius:8px"></div>
  </div>
</div>
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      margin: 10px 0;
      animation: neon 2s infinite alternate;
    }
    @keyframes neon {
      0% { color: red; text-shadow: 0 0 10px red; }
      100% { color: lime; text-shadow: 0 0 10px lime; }
    }
    nav {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 10px;
    }
    nav button {
      padding: 10px 15px;
      border-radius: 10px;
      border: none;
      background: #0a0;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
    }
    nav button.active {
      background: #f00;
    }
    #notifications {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 280px;
      max-height: 400px;
      overflow-y: auto;
      background: rgba(0,0,0,0.8);
      border-radius: 10px;
      padding: 10px;
      display: none;
      z-index: 9999;
    }
    #chat, #friends, #map, #private, #helper {
      display: none;
      padding: 10px;
    }
    #chat.active, #friends.active, #map.active, #private.active, #helper.active {
      display: block;
    }
    .message {
      background: rgba(255,255,255,0.1);
      margin: 5px 0;
      padding: 5px 10px;
      border-radius: 8px;
    }
    .system {
      color: #0f0;
      font-style: italic;
    }
    .friend, .dialog {
      background: rgba(255,255,255,0.1);
      margin: 5px 0;
      padding: 5px 10px;
      border-radius: 8px;
    }
    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      vertical-align: middle;
      margin-right: 5px;
    }
    .input-bar {
      display: flex;
      padding: 10px;
      background: rgba(0,0,0,0.6);
      position: fixed;
      bottom: 0;
      width: 100%;
      gap: 5px;
    }
    .input-bar input[type="text"] {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: none;
    }
    .input-bar button {
      padding: 8px 15px;
      border: none;
      border-radius: 8px;
      background: #0a0;
      color: #fff;
    }
  </style>
</head>
<body>
  <header>–ü—Ä–∞–≥–∞ –§—É—à–∫–∏</header>
  <nav>
    <button class="active" data-target="chat">üí¨ –ß–∞—Ç</button>
    <button data-target="friends">üë• –î—Ä—É–∑—ñ</button>
    <button data-target="map">üó∫ –ö–∞—Ä—Ç–∞</button>
    <button data-target="private">‚úâÔ∏è –û—Å–æ–±–∏—Å—Ç—ñ</button>
    <button data-target="helper">ü§ñ –ü–æ–º—ñ—á–Ω–∏–∫</button>
  </nav>
  <div id="notifications"></div>
<!-- ===== –í–ö–õ–ê–î–ö–ò ===== -->
  <main style="max-width:1000px;margin:0 auto;padding:10px">
    <!-- –ß–∞—Ç (–¥–≤–µ –ª–µ–Ω—Ç—ã: –û—Å–Ω–æ–≤–Ω–æ–π –∏ –û—Ä–µ–Ω–¥–∞) -->
    <section id="chat" class="active">
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:8px">
        <button class="subtab active" data-chat="main">üí¨ –û—Å–Ω–æ–≤–Ω–∏–π —á–∞—Ç</button>
        <button class="subtab" data-chat="rent">üè† –ß–∞—Ç –û—Ä–µ–Ω–¥–∞</button>
        <span id="online" style="margin-left:auto;background:rgba(0,0,0,.45);padding:6px 10px;border-radius:10px">–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): 0</span>
      </div>
      <div id="chatAreas" style="position:relative">
        <div id="messages" style="min-height:55vh;max-height:60vh;overflow:auto;padding:8px;background:rgba(0,0,0,.35);border-radius:10px"></div>
        <div id="rentMessages" style="display:none;min-height:55vh;max-height:60vh;overflow:auto;padding:8px;background:rgba(0,0,0,.35);border-radius:10px"></div>
      </div>
    </section>

    <!-- –î—Ä—É–∑—ñ -->
    <section id="friends">
      <h2>–î—Ä—É–∑—ñ —Ç–∞ –∑–∞—è–≤–∫–∏</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px">
        <div>
          <h3>–ó–∞—è–≤–∫–∏</h3>
          <div id="friendRequests"></div>
        </div>
        <div>
          <h3>–ú–æ—ó –¥—Ä—É–∑—ñ (<span id="friendsOnlineCount">0</span> –æ–Ω–ª–∞–π–Ω)</h3>
          <div id="friendsList"></div>
        </div>
      </div>
    </section>

    <!-- –ö–∞—Ä—Ç–∞ -->
    <section id="map">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <input id="mapSearch" placeholder="–ü–æ—à—É–∫ (–≤–æ–ª–æ–Ω—Ç–µ—Ä–∏, –∞–ø—Ç–µ–∫–∞...)" style="flex:1;padding:10px;border-radius:10px;border:1px solid #ddd">
        <button id="centerBtn">–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏</button>
      </div>
      <div id="gmap" style="height:60vh;border-radius:10px;background:#eaf7ff"></div>
    </section>

    <!-- –û—Å–æ–±–∏—Å—Ç—ñ (—Å–ø–∏—Å–æ–∫ –¥—ñ–∞–ª–æ–≥—ñ–≤) -->
    <section id="private">
      <h2>–ú–æ—ó –¥—ñ–∞–ª–æ–≥–∏</h2>
      <div id="dmList"></div>
    </section>

    <!-- –ü–æ–º—ñ—á–Ω–∏–∫ (30 –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏—Ö) -->
    <section id="helper">
      <div style="background:rgba(255,255,255,.12);border-radius:12px;padding:10px">
        <p><b>–ü–æ–º—ñ—á–Ω–∏–∫ –ü—Ä–∞–≥–∏:</b> –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ: <b id="assistLeft">30</b> –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å. –î–∞–ª—ñ ‚Äî –ø—ñ–¥–ø–∏—Å–∫–∞ 199 Kƒç/–º—ñ—Å (–±–∞–∑–æ–≤–∞ 100 Kƒç).</p>
        <div id="assistLog" style="max-height:45vh;overflow:auto;border:1px solid #444;border-radius:8px;padding:8px;margin-bottom:8px;background:rgba(0,0,0,.25)"></div>
        <div style="display:flex;gap:6px">
          <input id="assistInput" placeholder="–ü–∏—Ç–∞–Ω–Ω—è..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #444;background:#111;color:#fff">
          <button id="assistSend">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
        </div>
        <div id="assistPay" style="display:none;margin-top:8px;background:#332a00;border:1px dashed #f59e0b;border-radius:8px;padding:8px">
          –õ—ñ–º—ñ—Ç –≤–∏—á–µ—Ä–ø–∞–Ω–æ. –û–ø–ª–∞—Ç–∞ –Ω–∞ —Ä–∞—Ö—É–Ω–æ–∫: <b>ƒçsob 354037257/0300</b>. –ù–∞–¥—ñ—à–ª—ñ—Ç—å —Ñ–æ—Ç–æ –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó —É —á–∞—Ç ‚Äî –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å.
        </div>
      </div>
    </section>
  </main>

  <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ (–æ–±—â–∞—è –¥–ª—è —á–∞—Ç–æ–≤) -->
  <div class="input-bar">
    <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
      üì∑ <input id="fileInput" type="file" accept="image/*" style="display:none">
    </label>
    <input id="messageInput" type="text" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." />
    <button id="sendButton">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
  </div>

  <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫) -->
  <div id="notifications"></div>

  <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏—è -->
  <div id="msgMenu" style="position:absolute;display:none;background:#111;color:#fff;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.4)">
    <button data-act="reply" style="display:block;width:100%;padding:8px 10px;background:transparent;border:none;color:#fff;text-align:left">‚Ü©Ô∏è –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏</button>
    <button data-act="like" style="display:block;width:100%;padding:8px 10px;background:transparent;border:none;color:#fff;text-align:left">üëç –õ–∞–π–∫</button>
    <button data-act="warn" style="display:block;width:100%;padding:8px 10px;background:transparent;border:none;color:#fff;text-align:left">‚ö†Ô∏è –û–±–µ—Ä–µ–∂–Ω–æ</button>
    <button data-act="dislike" style="display:block;width:100%;padding:8px 10px;background:transparent;border:none;color:#fff;text-align:left">üëé –î–∏–∑–ª–∞–π–∫</button>
    <button data-act="spam" style="display:block;width:100%;padding:8px 10px;background:transparent;border:none;color:#fff;text-align:left">üö´ –°–ø–∞–º</button>
    <button data-act="delete" style="display:block;width:100%;padding:8px 10px;background:transparent;border:none;color:#fff;text-align:left">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –¥–ª—è –≤—Å—ñ—Ö</button>
  </div>

  <!-- –ú–æ–¥–∞–ª –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <div id="authModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:9999">
    <div style="background:#fff;color:#111;width:92%;max-width:520px;border-radius:12px;padding:16px;position:relative">
      <button id="authClose" style="position:absolute;right:10px;top:10px;border:none;background:transparent;font-size:18px;cursor:pointer">‚úñ</button>
      <h3>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è / –í—Ö—ñ–¥</h3>
      <div id="authTabs" style="display:flex;gap:8px;margin-bottom:8px">
        <button id="tabReg" class="active">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
        <button id="tabLogin">–í—Ö—ñ–¥</button>
      </div>
      <div id="regForm">
        <input id="nickInput" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" style="width:100%;padding:10px;margin:6px 0">
        <input id="emailInput" type="email" placeholder="Email" style="width:100%;padding:10px;margin:6px 0">
        <input id="passwordInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å (‚â•6)" style="width:100%;padding:10px;margin:6px 0">
        <div style="display:flex;gap:6px;align-items:center;margin:6px 0">
          <input id="avatarFile" type="file" accept="image/*">
          <input id="avatarUrlInput" type="url" placeholder="–∞–±–æ URL –∞–≤–∞—Ç–∞—Ä–∫–∏" style="flex:1;padding:10px">
        </div>
        <button id="registerSubmit" style="width:100%;padding:10px">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
      </div>
      <div id="loginForm" style="display:none">
        <input id="loginEmail" type="email" placeholder="Email" style="width:100%;padding:10px;margin:6px 0">
        <input id="loginPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" style="width:100%;padding:10px;margin:6px 0">
        <button id="loginSubmit" style="width:100%;padding:10px">–£–≤—ñ–π—Ç–∏</button>
      </div>
      <div id="authErr" style="color:#b91c1c;margin-top:8px"></div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª –ø—Ä–æ—Ñ–∏–ª—è -->
  <div id="profileModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:9999">
    <div style="background:#fff;color:#111;width:92%;max-width:520px;border-radius:12px;padding:16px;position:relative">
      <button id="profileClose" style="position:absolute;right:10px;top:10px;border:none;background:transparent;font-size:18px;cursor:pointer">‚úñ</button>
      <div id="profileContent">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>
    </div>
  </div>


---

üìå –ß–∞—Å—Ç—å 3 ‚Äî —Å–∫—Ä–∏–ø—Ç—ã (—Ç–∞–±—ã, Firebase, —á–∞—Ç/–æ—Ä–µ–Ω–¥–∞, –õ–°, –¥—Ä—É–∑—ñ, –∞–≤–∞—Ç–∞—Ä/—Ñ–æ—Ç–æ, –∫–∞—Ä—Ç–∞, –ø–æ–º–æ—â–Ω–∏–∫)

<!-- Firebase + –ª–æ–≥–∏–∫–∞ —Å–∞–π—Ç–∞ -->
  <script type="module">
    /* ======= –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º ======= */
    const navBtns = Array.from(document.querySelectorAll('nav button'));
    const sections = {
      chat: document.getElementById('chat'),
      friends: document.getElementById('friends'),
      map: document.getElementById('map'),
      private: document.getElementById('private'),
      helper: document.getElementById('helper')
    };
    navBtns.forEach(b=>{
      b.onclick = ()=>{
        navBtns.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        Object.values(sections).forEach(s=>s.classList.remove('active'));
        sections[b.dataset.target].classList.add('active');
        if (b.dataset.target==='map' && window._ensureMap) window._ensureMap();
      };
    });

    /* ======= –ü–æ–¥—Ç–∞–±—ã —á–∞—Ç–∞ (–û—Å–Ω–æ–≤–Ω–æ–π / –û—Ä–µ–Ω–¥–∞) ======= */
    const subBtns = Array.from(document.querySelectorAll('.subtab'));
    const mainBox = document.getElementById('messages');
    const rentBox = document.getElementById('rentMessages');
    subBtns.forEach(btn=>{
      btn.onclick = ()=>{
        subBtns.forEach(x=>x.classList.remove('active'));
        btn.classList.add('active');
        const isRent = btn.dataset.chat==='rent';
        mainBox.style.display = isRent ? 'none' : 'block';
        rentBox.style.display = isRent ? 'block' : 'none';
      };
    });

    /* ======= –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è / —Ç–æ—Å—Ç ======= */
    const bellBox = document.getElementById('notifications');
    function toast(msg, ok=true){
      const d = document.createElement('div');
      d.style.cssText = 'background:'+(ok?'#10b981':'#ef4444')+';padding:10px;border-radius:10px;margin:6px 0;font-weight:700';
      d.textContent = msg;
      bellBox.style.display = 'block';
      bellBox.prepend(d);
      setTimeout(()=>d.remove(), 2600);
    }

    /* ======= Firebase ======= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, updateProfile, sendEmailVerification, signOut
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getDatabase, ref as dbRef, push as dbPush, onChildAdded, onValue, get as dbGet, set as dbSet, remove as dbRemove, query, orderByChild, limitToLast
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import {
      getStorage, ref as stRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
      authDomain: "praga-4baee.firebaseapp.com",
      databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
      projectId: "praga-4baee",
      storageBucket: "praga-4baee.appspot.com",
      messagingSenderId: "336023952536",
      appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
      measurementId: "G-BGDJD6R12N"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    const DEFAULT_AVATAR = "https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg";
    const ADMIN_EMAIL = "urciknikolaj642@gmail.com";
    let isAdmin = false;

    /* ======= –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–º–æ–¥–∞–ª) ======= */
    const authModal = document.getElementById('authModal');
    const authErr = document.getElementById('authErr');
    const tabReg = document.getElementById('tabReg');
    const tabLogin = document.getElementById('tabLogin');
    const regForm = document.getElementById('regForm');
    const loginForm = document.getElementById('loginForm');
    const authClose = document.getElementById('authClose');
    tabReg.onclick = ()=>{ tabReg.classList.add('active'); tabLogin.classList.remove('active'); regForm.style.display='block'; loginForm.style.display='none'; };
    tabLogin.onclick = ()=>{ tabLogin.classList.add('active'); tabReg.classList.remove('active'); regForm.style.display='none'; loginForm.style.display='block'; };
    authClose.onclick = ()=> authModal.style.display='none';
    function showAuth(){ authModal.style.display='flex'; authErr.textContent=''; }

    document.getElementById('registerSubmit').onclick = async ()=>{
      authErr.textContent='';
      const nick = document.getElementById('nickInput').value.trim();
      const email = document.getElementById('emailInput').value.trim();
      const pass = document.getElementById('passwordInput').value.trim();
      const file = document.getElementById('avatarFile').files[0];
      const avatarUrlInput = document.getElementById('avatarUrlInput').value.trim();
      if (!nick||!email||!pass){ authErr.textContent='–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è'; return; }
      try{
        const cred = await createUserWithEmailAndPassword(auth,email,pass);
        let photo = DEFAULT_AVATAR;
        if (file){
          const r = stRef(storage, `avatars/${cred.user.uid}_${Date.now()}.jpg`);
          const snap = await uploadBytes(r,file);
          photo = await getDownloadURL(snap.ref);
        } else if (avatarUrlInput){ photo = avatarUrlInput; }
        await updateProfile(cred.user,{displayName:nick, photoURL:photo});
        await dbSet(dbRef(db, `users/${cred.user.uid}`), {nick,email,avatar:photo,createdAt:Date.now()});
        await sendEmailVerification(cred.user);
        authModal.style.display='none';
        toast('‚úÖ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞');
      }catch(e){ authErr.textContent = e.message || String(e); }
    };

    document.getElementById('loginSubmit').onclick = async ()=>{
      authErr.textContent='';
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPassword').value.trim();
      if (!email||!pass){ authErr.textContent='–í–∫–∞–∂—ñ—Ç—å email —ñ –ø–∞—Ä–æ–ª—å'; return; }
      try{
        await signInWithEmailAndPassword(auth,email,pass);
        authModal.style.display='none';
        toast('‚úÖ –í—Ö—ñ–¥ —É—Å–ø—ñ—à–Ω–∏–π');
      }catch(e){ authErr.textContent = e.message || String(e); }
    };

    /* ======= –ü—Ä–æ—Ñ–∏–ª—å ======= */
    const profileModal = document.getElementById('profileModal');
    const profileContent = document.getElementById('profileContent');
    document.querySelector('header').onclick = ()=>{}; // –æ—Å—Ç–∞–≤–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º –±–µ–∑ –¥–µ–π—Å—Ç–≤–∏—è
    function openProfile(uid){
      profileModal.style.display='flex';
      profileContent.innerHTML='–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶';
      (async ()=>{
        const snap = await dbGet(dbRef(db, `users/${uid}`));
        const u = snap.exists()?snap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
        const self = auth.currentUser && auth.currentUser.uid===uid;
        profileContent.innerHTML = `
          <div style="display:flex;gap:10px;align-items:center">
            <img src="${u.avatar||DEFAULT_AVATAR}" style="width:72px;height:72px;border-radius:12px;object-fit:cover">
            <div><div style="font-weight:800">${u.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</div><div style="font-size:12px;color:#555">${u.email||''}</div></div>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            ${ self ? `
              <label style="background:#eee;padding:8px;border-radius:8px;cursor:pointer">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä
                <input id="avatarUpload" type="file" accept="image/*" style="display:none">
              </label>
              <button id="btnLogout">–í–∏–π—Ç–∏</button>
            `:`
              <button id="btnPM">–ù–∞–ø–∏—Å–∞—Ç–∏ –õ–°</button>
              <button id="btnAddFriend">–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>
            `}
          </div>
          <div id="pMsg" style="margin-top:6px;color:#b91c1c"></div>
        `;
        if (self){
          document.getElementById('btnLogout').onclick = async ()=>{ await signOut(auth); profileModal.style.display='none'; };
          const up = document.getElementById('avatarUpload');
          up.onchange = async ()=>{
            const f = up.files[0]; if(!f) return;
            try{
              const r = stRef(storage, `avatars/${uid}_${Date.now()}.jpg`);
              const snap = await uploadBytes(r,f);
              const url = await getDownloadURL(snap.ref);
              await dbSet(dbRef(db,`users/${uid}/avatar`),url);
              await updateProfile(auth.currentUser,{photoURL:url});
              toast('‚úÖ –ê–≤–∞—Ç–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ');
              profileModal.style.display='none';
            }catch(e){ toast('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–≤–∞—Ç–∞—Ä—É',false); }
          };
        } else {
          document.getElementById('btnPM').onclick = ()=>{ profileModal.style.display='none'; openDM(uid); };
          document.getElementById('btnAddFriend').onclick = async ()=>{
            const from = auth.currentUser?.uid; if(!from){ showAuth(); return; }
            await dbSet(dbRef(db, `friendRequests/${uid}/${from}`), {from,ts:Date.now()});
            await dbSet(dbRef(db, `friends/${from}/${uid}`), {status:'requested',ts:Date.now(),fromUid:from});
            toast('‚úÖ –ó–∞–ø–∏—Ç —É –¥—Ä—É–∑—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ');
          };
        }
      })();
    }
    document.getElementById('profileClose').onclick = ()=> profileModal.style.display='none';

    /* ======= –û–Ω–ª–∞–π–Ω-—Å—á—ë—Ç—á–∏–∫ √ó10 ======= */
    const onlineLabel = document.getElementById('online');
    onAuthStateChanged(auth, async (user)=>{
      // —Ä–æ–ª—å –∞–¥–º–∏–Ω–∞
      isAdmin = !!user && (user.email===ADMIN_EMAIL);
      if (user){
        await dbSet(dbRef(db, `presence/${user.uid}`), {ts:Date.now(), nick: user.displayName||user.email});
      }
      onValue(dbRef(db,'presence'), s=>{
        const val = s.val()||{};
        const real = Object.keys(val).length;
        const shown = real*10 + (real>0?1:0);
        onlineLabel.textContent = `–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): ${shown}`;
      });
      loadDMList();
      refreshFriends();
    });

    window.addEventListener('beforeunload', async ()=>{
      try{ const u = auth.currentUser; if(u) await dbRemove(dbRef(db,`presence/${u.uid}`)); }catch(e){}
    });

    /* ======= –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π ======= */
    function msgHTML(m){
      return `
        <div class="message" data-id="${m.id||''}" data-uid="${m.uid||''}" style="display:flex;gap:8px;align-items:flex-start">
          <img class="avatar" src="${m.avatar||DEFAULT_AVATAR}" alt="">
          <div style="flex:1">
            <div style="font-size:12px;opacity:.8">${m.nick||'–ê–Ω–æ–Ω—ñ–º'} ¬∑ ${new Date(m.ts).toLocaleString()} ${m.recipientUid?'¬∑ –æ—Å–æ–±–∏—Å—Ç–µ':''}</div>
            ${m.text?`<div style="white-space:pre-wrap">${m.text}</div>`:''}
            ${m.image?`<div><img src="${m.image}" style="max-width:260px;border-radius:8px;margin-top:6px"></div>`:''}
          </div>
          <button class="more" style="border:none;background:transparent;color:#fff;font-size:18px;cursor:pointer">‚ãØ</button>
        </div>`;
    }
    function bindMsgMenu(container, path){
      container.addEventListener('click', (e)=>{
        const more = e.target.closest('.more'); if(!more) return;
        const wrap = more.closest('.message');
        const rect = more.getBoundingClientRect();
        const menu = document.getElementById('msgMenu');
        menu.style.left = `${rect.left}px`;
        menu.style.top = `${rect.bottom+4}px`;
        menu.style.display = 'block';
        const uid = wrap.dataset.uid;
        const mid = wrap.dataset.id;
        const hide = ()=>{ menu.style.display='none'; document.removeEventListener('click',hide); };
        document.addEventListener('click', hide, {once:true});
        menu.querySelectorAll('button').forEach(btn=>{
          btn.onclick = async ()=>{
            const act = btn.dataset.act;
            if (act==='delete'){
              const me = auth.currentUser;
              if (isAdmin || (me && me.uid===uid)){
                await dbRemove(dbRef(db, `${path}/${mid}`)); wrap.remove(); toast('üóëÔ∏è –í–∏–¥–∞–ª–µ–Ω–æ');
              } else toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤',false);
              return;
            }
            if (act==='reply'){
              const r = prompt('–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:'); if(!r) return;
              sendToPath(path,{ text:'‚Ü©Ô∏è '+r, recipientUid:uid });
            } else {
              await dbPush(dbRef(db, `messageReactions/${mid}/${auth.currentUser.uid}`), {act,ts:Date.now()});
              await dbPush(dbRef(db, `notifications/${uid}`), {ts:Date.now(),type:'reaction',text:act,from:auth.currentUser.uid});
              toast('‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ');
            }
          };
        });
      });
    }

    /* ======= –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —á–∞—Ç—ã ======= */
    const MSG_LIMIT = 400;
    const boxMain = document.getElementById('messages');
    const boxRent = document.getElementById('rentMessages');

    function liveFeed(path, box){
      const q = query(dbRef(db, path), orderByChild('ts'), limitToLast(MSG_LIMIT));
      onChildAdded(q, snap=>{
        const v = snap.val(); v.id = snap.key;
        const div = document.createElement('div');
        div.innerHTML = msgHTML(v);
        const row = div.firstElementChild;
        // –∫–ª–∏–∫ –ø–æ –∞–≤–∞—Ç–∞—Ä—É -> –ø—Ä–æ—Ñ–∏–ª—å
        row.querySelector('.avatar').onclick = ()=> openProfile(v.uid);
        box.appendChild(row);
        box.scrollTop = box.scrollHeight;
      });
      bindMsgMenu(box, path);
    }
    liveFeed('messages', boxMain);
    liveFeed('rentMessages', boxRent);

    /* ======= –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (–≤ —Ç–µ–∫—É—â—É—é –ª–µ–Ω—Ç—É) ======= */
    const sendBtn = document.getElementById('sendButton');
    const input = document.getElementById('messageInput');
    const fileInput = document.getElementById('fileInput');

    async function uploadImg(file, uid){
      const r = stRef(storage, `chat/${uid}_${Date.now()}_${file.name||'img'}`);
      const snap = await uploadBytes(r,file);
      return await getDownloadURL(snap.ref);
    }
    function activePath(){ return rentBox.style.display==='block' ? 'rentMessages' : 'messages'; }

    async function sendToPath(path, extra={}){
      const u = auth.currentUser; if(!u){ showAuth(); return; }
      const text = extra.text ?? input.value.trim();
      const file = fileInput.files[0];
      if (!text && !file) return;
      let image = null;
      if (file){ try{ image = await uploadImg(file,u.uid); }catch(e){ toast('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ',false); return; } }
      const msg = {
        uid: u.uid, nick: u.displayName||u.email||'–ê–Ω–æ–Ω—ñ–º',
        avatar: u.photoURL||DEFAULT_AVATAR, text: text||null, image,
        ts: Date.now(), recipientUid: extra.recipientUid||null
      };
      await dbPush(dbRef(db, path), msg);
      input.value=''; fileInput.value='';
      toast('‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ');
    }

    sendBtn.onclick = ()=> sendToPath(activePath());
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); } });

    /* ======= –î—Ä—É–∑—ñ ======= */
    const friendRequests = document.getElementById('friendRequests');
    const friendsList = document.getElementById('friendsList');
    const friendsOnlineCountEl = document.getElementById('friendsOnlineCount');

    async function refreshFriends(){
      const u = auth.currentUser; if(!u){ friendRequests.innerHTML=''; friendsList.innerHTML=''; return; }
      // –∑–∞—è–≤–∫–∏
      const reqSnap = await dbGet(dbRef(db, `friendRequests/${u.uid}`));
      friendRequests.innerHTML='';
      if (reqSnap.exists()){
        const reqs = reqSnap.val();
        for (const fromUid of Object.keys(reqs)){
          const us = await dbGet(dbRef(db, `users/${fromUid}`));
          const ud = us.exists()?us.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
          const row = document.createElement('div');
          row.className='friend';
          row.innerHTML = `
            <img class="avatar" src="${ud.avatar||DEFAULT_AVATAR}"> ${ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}
            <div style="margin-top:6px;display:flex;gap:6px">
              <button class="acc">‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏</button>
              <button class="decl">‚úñ</button>
            </div>`;
          row.querySelector('.acc').onclick = async ()=>{
            await dbSet(dbRef(db, `friends/${u.uid}/${fromUid}`), {status:'accepted',ts:Date.now()});
            await dbSet(dbRef(db, `friends/${fromUid}/${u.uid}`), {status:'accepted',ts:Date.now()});
            await dbRemove(dbRef(db, `friendRequests/${u.uid}/${fromUid}`));
            toast('‚úÖ –î–æ–¥–∞–Ω–æ —É –¥—Ä—É–∑—ñ');
            refreshFriends();
          };
          row.querySelector('.decl').onclick = async ()=>{
            await dbRemove(dbRef(db, `friendRequests/${u.uid}/${fromUid}`));
            await dbRemove(dbRef(db, `friends/${fromUid}/${u.uid}`));
            refreshFriends();
          };
          friendRequests.appendChild(row);
        }
      } else friendRequests.innerHTML = '<i>–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</i>';

      // –º–æ—ó –¥—Ä—É–∑—ñ
      friendsList.innerHTML='';
      const frSnap = await dbGet(dbRef(db, `friends/${u.uid}`));
      let onlineCount = 0;
      if (frSnap.exists()){
        const fr = frSnap.val();
        for (const fid of Object.keys(fr)){
          if (fr[fid].status!=='accepted') continue;
          const us = await dbGet(dbRef(db, `users/${fid}`));
          const ud = us.exists()?us.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
          const p = await dbGet(dbRef(db, `presence/${fid}`));
          const online = p.exists(); if (online) onlineCount++;
          const row = document.createElement('div');
          row.className='friend';
          row.innerHTML = `
            <img class="avatar" src="${ud.avatar||DEFAULT_AVATAR}"> ${ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}
            <span style="font-size:12px;opacity:.7"> ¬∑ ${online?'–æ–Ω–ª–∞–π–Ω':'–æ—Ñ–ª–∞–π–Ω'}</span>
            <div style="margin-top:6px;display:flex;gap:6px">
              <button class="pm">‚úâÔ∏è –õ–°</button>
              <button class="prof">üëÄ –ü—Ä–æ—Ñ—ñ–ª—å</button>
            </div>`;
          row.querySelector('.pm').onclick = ()=> openDM(fid);
          row.querySelector('.prof').onclick = ()=> openProfile(fid);
          friendsList.appendChild(row);
        }
      } else friendsList.innerHTML = '<i>–î–æ–¥–∞–π—Ç–µ –¥—Ä—É–∑—ñ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ—ñ–ª—ñ</i>';
      friendsOnlineCountEl.textContent = String(onlineCount);
    }

    /* ======= –õ–°: —Å–ø–∏—Å–æ–∫ –∏ –æ–∫–Ω–æ –¥–∏–∞–ª–æ–≥–∞ ======= */
    const dmList = document.getElementById('dmList');
    function convoId(a,b){ return a<b ? `${a}_${b}` : `${b}_${a}`; }

    async function openDM(otherUid){
      const u = auth.currentUser; if(!u){ showAuth(); return; }
      const cid = convoId(u.uid, otherUid);
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999';
      modal.innerHTML = `
        <div style="background:#fff;color:#111;width:92%;max-width:640px;border-radius:12px;padding:12px;position:relative">
          <button class="close" style="position:absolute;right:10px;top:10px;border:none;background:transparent;font-size:18px;cursor:pointer">‚úñ</button>
          <h3>–î—ñ–∞–ª–æ–≥</h3>
          <div class="log" style="max-height:60vh;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px;background:#fafafa"></div>
          <div style="display:flex;gap:6px;margin-top:8px">
            <input class="txt" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd">
            <button class="send">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
      const close = ()=> modal.remove();
      modal.querySelector('.close').onclick = close;

      const log = modal.querySelector('.log');
      const txt = modal.querySelector('.txt');
      const send = modal.querySelector('.send');

      const q = query(dbRef(db, `privateMessages/${cid}`), orderByChild('ts'), limitToLast(300));
      onChildAdded(q, snap=>{
        const m = snap.val();
        const row = document.createElement('div');
        row.style.cssText = 'margin:6px 0;'+(m.from===u.uid?'text-align:right':'text-align:left');
        row.textContent = `${m.text} (${new Date(m.ts).toLocaleTimeString()})`;
        log.appendChild(row);
        log.scrollTop = log.scrollHeight;
      });

      send.onclick = async ()=>{
        const t = txt.value.trim(); if(!t) return;
        const pm = {from:u.uid,to:otherUid,text:t,ts:Date.now()};
        await dbPush(dbRef(db, `privateMessages/${cid}`), pm);
        await dbSet(dbRef(db, `inboxMeta/${u.uid}/${otherUid}`), {otherUid,last:t,ts:pm.ts});
        await dbSet(dbRef(db, `inboxMeta/${otherUid}/${u.uid}`), {otherUid:u.uid,last:t,ts:pm.ts});
        await dbPush(dbRef(db, `notifications/${otherUid}`), {ts:Date.now(),type:'dm',text:`–ù–æ–≤–µ –õ–° –≤—ñ–¥ ${u.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`,from:u.uid});
        txt.value='';
      };
    }

    function loadDMList(){
      const u = auth.currentUser; if(!u){ dmList.innerHTML='<i>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –±–∞—á–∏—Ç–∏ –õ–°</i>'; return; }
      onValue(dbRef(db, `inboxMeta/${u.uid}`), async snap=>{
        dmList.innerHTML='';
        const m = snap.val()||{};
        const keys = Object.keys(m).sort((a,b)=> (m[b].ts||0)-(m[a].ts||0));
        for (const k of keys){
          const meta = m[k];
          const us = await dbGet(dbRef(db, `users/${meta.otherUid}`));
          const ud = us.exists()?us.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
          const row = document.createElement('div');
          row.className='dialog';
          row.innerHTML = `
            <img class="avatar" src="${ud.avatar||DEFAULT_AVATAR}"> <b>${ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</b>
            <div style="font-size:12px;opacity:.7">${meta.last||''}</div>
            <div style="margin-top:6px"><button class="open">–í—ñ–¥–∫—Ä–∏—Ç–∏</button></div>
          `;
          row.querySelector('.open').onclick = ()=> openDM(meta.otherUid);
          dmList.appendChild(row);
        }
      });
    }

    /* ======= –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (üîî) ======= */
    function notify(uid){
      onChildAdded(dbRef(db, `notifications/${uid}`),(snap)=>{
        const v = snap.val()||{};
        toast(`${v.type||'–Ü–Ω—Ñ–æ'}: ${v.text||''}`);
      });
    }

    /* ======= –ö–∞—Ä—Ç–∞ Google ======= */
    let map, markers=[];
    const POINTS = [
      { title: "Nemocnice Motol", pos: {lat:50.058, lng:14.360}, cat:"hospital" },
      { title: "Nemocnice Na Frantisku", pos: {lat:50.086, lng:14.418}, cat:"hospital" },
      { title: "Pravni pomoc —Ü–µ–Ω—Ç—Ä", pos: {lat:50.083, lng:14.412}, cat:"lawyer" },
      { title: "Albert", pos: {lat:50.084, lng:14.417}, cat:"shop" },
      { title: "Pomoc 1", pos: {lat:50.082, lng:14.419}, cat:"help" }
    ];
    window._ensureMap = ()=>{
      if (window.google && !map){
        map = new google.maps.Map(document.getElementById('gmap'), {center:{lat:50.0755,lng:14.4378}, zoom:12, streetViewControl:false, mapTypeControl:false});
        POINTS.forEach(p=> markers.push(new google.maps.Marker({position:p.pos,title:p.title,map})));
      }
    };
    document.getElementById('mapSearch').oninput = (e)=>{
      const q = e.target.value.toLowerCase();
      markers.forEach((m,i)=>{
        const p = POINTS[i]; m.setVisible(p.title.toLowerCase().includes(q) || p.cat.includes(q));
      });
    };
    document.getElementById('centerBtn').onclick = ()=> map && map.setCenter({lat:50.0755,lng:14.4378});

    /* ======= –ü–æ–º—ñ—á–Ω–∏–∫ (–ª—ñ–º—ñ—Ç 30) ‚Äî –∑–∞–≥–ª—É—à–∫–∞ –±–µ–∑ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –∫–ª—é—á–∞ ======= */
    const assistLeftEl = document.getElementById('assistLeft');
    const assistLog = document.getElementById('assistLog');
    const assistInput = document.getElementById('assistInput');
    const assistSend = document.getElementById('assistSend');
    let assistLeft = Number(localStorage.getItem('assistLeft')||'30');
    assistLeftEl.textContent = assistLeft;
    assistSend.onclick = ()=>{
      if (assistLeft<=0){ document.getElementById('assistPay').style.display='block'; return; }
      const q = assistInput.value.trim(); if(!q) return;
      const mine = document.createElement('div'); mine.style.textAlign='right'; mine.textContent = q; assistLog.appendChild(mine);
      const bot = document.createElement('div'); bot.style.textAlign='left'; bot.textContent = '–ü–æ–º—ñ—á–Ω–∏–∫: –≤—ñ–¥–ø–æ–≤—ñ–º –ø—ñ—Å–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∫–ª—é—á–∞ GPT (–Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞).'; assistLog.appendChild(bot);
      assistLog.scrollTop = assistLog.scrollHeight;
      assistInput.value='';
      assistLeft--; localStorage.setItem('assistLeft', String(assistLeft)); assistLeftEl.textContent = assistLeft;
    };

    /* ======= –ê–≤—Ç–æ–ª–æ–≥–∏–Ω: –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ ======= */
    document.getElementById('sendButton').addEventListener('click', ()=>{
      if (!auth.currentUser) showAuth();
    }, {capture:true});

    /* ======= –ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ ‚Äî –ø–æ–¥–ø–∏—Å–∫–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ======= */
    onAuthStateChanged(auth, (u)=>{
      if (u){
        notify(u.uid);
        loadDMList();
        refreshFriends();
      }
    });
  </script>

  <!-- Google Maps (—Ç–≤–æ–π –∫–ª—é—á) -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFrxVhpb6nHJ6rhiLl5Ho8t0jOb1iEQNc&callback=_ensureMap"></script>
</body>
</html>
<!-- Firebase + –ª–æ–≥–∏–∫–∞ —Å–∞–π—Ç–∞ -->
  <script type="module">
    /* ======= –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º ======= */
    const navBtns = Array.from(document.querySelectorAll('nav button'));
    const sections = {
      chat: document.getElementById('chat'),
      friends: document.getElementById('friends'),
      map: document.getElementById('map'),
      private: document.getElementById('private'),
      helper: document.getElementById('helper')
    };
    navBtns.forEach(b=>{
      b.onclick = ()=>{
        navBtns.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        Object.values(sections).forEach(s=>s.classList.remove('active'));
        sections[b.dataset.target].classList.add('active');
        if (b.dataset.target==='map' && window._ensureMap) window._ensureMap();
      };
    });

    /* ======= –ü–æ–¥—Ç–∞–±—ã —á–∞—Ç–∞ (–û—Å–Ω–æ–≤–Ω–æ–π / –û—Ä–µ–Ω–¥–∞) ======= */
    const subBtns = Array.from(document.querySelectorAll('.subtab'));
    const mainBox = document.getElementById('messages');
    const rentBox = document.getElementById('rentMessages');
    subBtns.forEach(btn=>{
      btn.onclick = ()=>{
        subBtns.forEach(x=>x.classList.remove('active'));
        btn.classList.add('active');
        const isRent = btn.dataset.chat==='rent';
        mainBox.style.display = isRent ? 'none' : 'block';
        rentBox.style.display = isRent ? 'block' : 'none';
      };
    });

    /* ======= –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è / —Ç–æ—Å—Ç ======= */
    const bellBox = document.getElementById('notifications');
    function toast(msg, ok=true){
      const d = document.createElement('div');
      d.style.cssText = 'background:'+(ok?'#10b981':'#ef4444')+';padding:10px;border-radius:10px;margin:6px 0;font-weight:700';
      d.textContent = msg;
      bellBox.style.display = 'block';
      bellBox.prepend(d);
      setTimeout(()=>d.remove(), 2600);
    }
    /* header actions */
.header-actions{position:fixed;right:10px;top:8px;display:flex;gap:10px;z-index:9998}
.icon-btn{width:44px;height:44px;border-radius:50%;border:2px solid rgba(255,255,255,.9);
  background:rgba(0,0,0,.35);color:#fff;display:flex;align-items:center;justify-content:center;
  cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35)}
#profileBtn{position:fixed;left:10px;top:8px;background-size:cover;background-position:center}
.badge{position:absolute;right:-6px;top:-6px;background:#ff3366;color:#fff;border-radius:12px;
  padding:2px 6px;font-size:12px;font-weight:700;display:none}

/* modals */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,.6);z-index:9999}
.modal .panel{background:#fff;color:#111;width:92%;max-width:720px;border-radius:12px;padding:14px;position:relative}
.modal .close{position:absolute;right:10px;top:10px;border:none;background:transparent;font-size:18px;cursor:pointer}

/* admin participants list */
.user-row{display:flex;gap:10px;align-items:center;padding:8px;border-bottom:1px solid #eee}
.user-row img{width:36px;height:36px;border-radius:8px;object-fit:cover}
.user-row .tags{font-size:12px;opacity:.7}
.user-row .actions{margin-left:auto;display:flex;gap:6px;flex-wrap:wrap}
.user-row .actions button{padding:6px 8px;border-radius:8px;border:none;cursor:pointer}

    /* ======= Firebase ======= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, updateProfile, sendEmailVerification, signOut
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getDatabase, ref as dbRef, push as dbPush, onChildAdded, onValue, get as dbGet, set as dbSet, remove as dbRemove, query, orderByChild, limitToLast
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import {
      getStorage, ref as stRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
      authDomain: "praga-4baee.firebaseapp.com",
      databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
      projectId: "praga-4baee",
      storageBucket: "praga-4baee.appspot.com",
      messagingSenderId: "336023952536",
      appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
      measurementId: "G-BGDJD6R12N"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    const DEFAULT_AVATAR = "https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg";
    const ADMIN_EMAIL = "urciknikolaj642@gmail.com";
    let isAdmin = false;

    /* ======= –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–º–æ–¥–∞–ª) ======= */
    const authModal = document.getElementById('authModal');
    const authErr = document.getElementById('authErr');
    const tabReg = document.getElementById('tabReg');
    const tabLogin = document.getElementById('tabLogin');
    const regForm = document.getElementById('regForm');
    const loginForm = document.getElementById('loginForm');
    const authClose = document.getElementById('authClose');
    tabReg.onclick = ()=>{ tabReg.classList.add('active'); tabLogin.classList.remove('active'); regForm.style.display='block'; loginForm.style.display='none'; };
    tabLogin.onclick = ()=>{ tabLogin.classList.add('active'); tabReg.classList.remove('active'); regForm.style.display='none'; loginForm.style.display='block'; };
    authClose.onclick = ()=> authModal.style.display='none';
    function showAuth(){ authModal.style.display='flex'; authErr.textContent=''; }

    document.getElementById('registerSubmit').onclick = async ()=>{
      authErr.textContent='';
      const nick = document.getElementById('nickInput').value.trim();
      const email = document.getElementById('emailInput').value.trim();
      const pass = document.getElementById('passwordInput').value.trim();
      const file = document.getElementById('avatarFile').files[0];
      const avatarUrlInput = document.getElementById('avatarUrlInput').value.trim();
      if (!nick||!email||!pass){ authErr.textContent='–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è'; return; }
      try{
        const cred = await createUserWithEmailAndPassword(auth,email,pass);
        let photo = DEFAULT_AVATAR;
        if (file){
          const r = stRef(storage, `avatars/${cred.user.uid}_${Date.now()}.jpg`);
          const snap = await uploadBytes(r,file);
          photo = await getDownloadURL(snap.ref);
        } else if (avatarUrlInput){ photo = avatarUrlInput; }
        await updateProfile(cred.user,{displayName:nick, photoURL:photo});
        await dbSet(dbRef(db, `users/${cred.user.uid}`), {nick,email,avatar:photo,createdAt:Date.now()});
        await sendEmailVerification(cred.user);
        authModal.style.display='none';
        toast('‚úÖ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞');
      }catch(e){ authErr.textContent = e.message || String(e); }
    };

    document.getElementById('loginSubmit').onclick = async ()=>{
      authErr.textContent='';
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPassword').value.trim();
      if (!email||!pass){ authErr.textContent='–í–∫–∞–∂—ñ—Ç—å email —ñ –ø–∞—Ä–æ–ª—å'; return; }
      try{
        await signInWithEmailAndPassword(auth,email,pass);
        authModal.style.display='none';
        toast('‚úÖ –í—Ö—ñ–¥ —É—Å–ø—ñ—à–Ω–∏–π');
      }catch(e){ authErr.textContent = e.message || String(e); }
    };

    /* ======= –ü—Ä–æ—Ñ–∏–ª—å ======= */
    const profileModal = document.getElementById('profileModal');
    const profileContent = document.getElementById('profileContent');
    document.querySelector('header').onclick = ()=>{}; // –æ—Å—Ç–∞–≤–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º –±–µ–∑ –¥–µ–π—Å—Ç–≤–∏—è
    function openProfile(uid){
      profileModal.style.display='flex';
      profileContent.innerHTML='–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶';
      (async ()=>{
        const snap = await dbGet(dbRef(db, `users/${uid}`));
        const u = snap.exists()?snap.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
        const self = auth.currentUser && auth.currentUser.uid===uid;
        profileContent.innerHTML = `
          <div style="display:flex;gap:10px;align-items:center">
            <img src="${u.avatar||DEFAULT_AVATAR}" style="width:72px;height:72px;border-radius:12px;object-fit:cover">
            <div><div style="font-weight:800">${u.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</div><div style="font-size:12px;color:#555">${u.email||''}</div></div>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            ${ self ? `
              <label style="background:#eee;padding:8px;border-radius:8px;cursor:pointer">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä
                <input id="avatarUpload" type="file" accept="image/*" style="display:none">
              </label>
              <button id="btnLogout">–í–∏–π—Ç–∏</button>
            `:`
              <button id="btnPM">–ù–∞–ø–∏—Å–∞—Ç–∏ –õ–°</button>
              <button id="btnAddFriend">–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>
            `}
          </div>
          <div id="pMsg" style="margin-top:6px;color:#b91c1c"></div>
        `;
        if (self){
          document.getElementById('btnLogout').onclick = async ()=>{ await signOut(auth); profileModal.style.display='none'; };
          const up = document.getElementById('avatarUpload');
          up.onchange = async ()=>{
            const f = up.files[0]; if(!f) return;
            try{
              const r = stRef(storage, `avatars/${uid}_${Date.now()}.jpg`);
              const snap = await uploadBytes(r,f);
              const url = await getDownloadURL(snap.ref);
              await dbSet(dbRef(db,`users/${uid}/avatar`),url);
              await updateProfile(auth.currentUser,{photoURL:url});
              toast('‚úÖ –ê–≤–∞—Ç–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ');
              profileModal.style.display='none';
            }catch(e){ toast('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–≤–∞—Ç–∞—Ä—É',false); }
          };
        } else {
          document.getElementById('btnPM').onclick = ()=>{ profileModal.style.display='none'; openDM(uid); };
          document.getElementById('btnAddFriend').onclick = async ()=>{
            const from = auth.currentUser?.uid; if(!from){ showAuth(); return; }
            await dbSet(dbRef(db, `friendRequests/${uid}/${from}`), {from,ts:Date.now()});
            await dbSet(dbRef(db, `friends/${from}/${uid}`), {status:'requested',ts:Date.now(),fromUid:from});
            toast('‚úÖ –ó–∞–ø–∏—Ç —É –¥—Ä—É–∑—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ');
          };
        }
      })();
    }
    document.getElementById('profileClose').onclick = ()=> profileModal.style.display='none';

    /* ======= –û–Ω–ª–∞–π–Ω-—Å—á—ë—Ç—á–∏–∫ √ó10 ======= */
    const onlineLabel = document.getElementById('online');
    onAuthStateChanged(auth, async (user)=>{
      // —Ä–æ–ª—å –∞–¥–º–∏–Ω–∞
      isAdmin = !!user && (user.email===ADMIN_EMAIL);
      if (user){
        await dbSet(dbRef(db, `presence/${user.uid}`), {ts:Date.now(), nick: user.displayName||user.email});
      }
      onValue(dbRef(db,'presence'), s=>{
        const val = s.val()||{};
        const real = Object.keys(val).length;
        const shown = real*10 + (real>0?1:0);
        onlineLabel.textContent = `–û–Ω–ª–∞–π–Ω (–ø—Ä–∏–±–ª.): ${shown}`;
      });
      loadDMList();
      refreshFriends();
    });

    window.addEventListener('beforeunload', async ()=>{
      try{ const u = auth.currentUser; if(u) await dbRemove(dbRef(db,`presence/${u.uid}`)); }catch(e){}
    });

    /* ======= –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π ======= */
    function msgHTML(m){
      return `
        <div class="message" data-id="${m.id||''}" data-uid="${m.uid||''}" style="display:flex;gap:8px;align-items:flex-start">
          <img class="avatar" src="${m.avatar||DEFAULT_AVATAR}" alt="">
          <div style="flex:1">
            <div style="font-size:12px;opacity:.8">${m.nick||'–ê–Ω–æ–Ω—ñ–º'} ¬∑ ${new Date(m.ts).toLocaleString()} ${m.recipientUid?'¬∑ –æ—Å–æ–±–∏—Å—Ç–µ':''}</div>
            ${m.text?`<div style="white-space:pre-wrap">${m.text}</div>`:''}
            ${m.image?`<div><img src="${m.image}" style="max-width:260px;border-radius:8px;margin-top:6px"></div>`:''}
          </div>
          <button class="more" style="border:none;background:transparent;color:#fff;font-size:18px;cursor:pointer">‚ãØ</button>
        </div>`;
    }
    function bindMsgMenu(container, path){
      container.addEventListener('click', (e)=>{
        const more = e.target.closest('.more'); if(!more) return;
        const wrap = more.closest('.message');
        const rect = more.getBoundingClientRect();
        const menu = document.getElementById('msgMenu');
        menu.style.left = `${rect.left}px`;
        menu.style.top = `${rect.bottom+4}px`;
        menu.style.display = 'block';
        const uid = wrap.dataset.uid;
        const mid = wrap.dataset.id;
        const hide = ()=>{ menu.style.display='none'; document.removeEventListener('click',hide); };
        document.addEventListener('click', hide, {once:true});
        menu.querySelectorAll('button').forEach(btn=>{
          btn.onclick = async ()=>{
            const act = btn.dataset.act;
            if (act==='delete'){
              const me = auth.currentUser;
              if (isAdmin || (me && me.uid===uid)){
                await dbRemove(dbRef(db, `${path}/${mid}`)); wrap.remove(); toast('üóëÔ∏è –í–∏–¥–∞–ª–µ–Ω–æ');
              } else toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤',false);
              return;
            }
            if (act==='reply'){
              const r = prompt('–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:'); if(!r) return;
              sendToPath(path,{ text:'‚Ü©Ô∏è '+r, recipientUid:uid });
            } else {
              await dbPush(dbRef(db, `messageReactions/${mid}/${auth.currentUser.uid}`), {act,ts:Date.now()});
              await dbPush(dbRef(db, `notifications/${uid}`), {ts:Date.now(),type:'reaction',text:act,from:auth.currentUser.uid});
              toast('‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ');
            }
          };
        });
      });
    }

    /* ======= –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —á–∞—Ç—ã ======= */
    const MSG_LIMIT = 400;
    const boxMain = document.getElementById('messages');
    const boxRent = document.getElementById('rentMessages');

    function liveFeed(path, box){
      const q = query(dbRef(db, path), orderByChild('ts'), limitToLast(MSG_LIMIT));
      onChildAdded(q, snap=>{
        const v = snap.val(); v.id = snap.key;
        const div = document.createElement('div');
        div.innerHTML = msgHTML(v);
        const row = div.firstElementChild;
        // –∫–ª–∏–∫ –ø–æ –∞–≤–∞—Ç–∞—Ä—É -> –ø—Ä–æ—Ñ–∏–ª—å
        row.querySelector('.avatar').onclick = ()=> openProfile(v.uid);
        box.appendChild(row);
        box.scrollTop = box.scrollHeight;
      });
      bindMsgMenu(box, path);
    }
    liveFeed('messages', boxMain);
    liveFeed('rentMessages', boxRent);

    /* ======= –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (–≤ —Ç–µ–∫—É—â—É—é –ª–µ–Ω—Ç—É) ======= */
    const sendBtn = document.getElementById('sendButton');
    const input = document.getElementById('messageInput');
    const fileInput = document.getElementById('fileInput');

    async function uploadImg(file, uid){
      const r = stRef(storage, `chat/${uid}_${Date.now()}_${file.name||'img'}`);
      const snap = await uploadBytes(r,file);
      return await getDownloadURL(snap.ref);
    }
    function activePath(){ return rentBox.style.display==='block' ? 'rentMessages' : 'messages'; }

    async function sendToPath(path, extra={}){
      const u = auth.currentUser; if(!u){ showAuth(); return; }
      const text = extra.text ?? input.value.trim();
      const file = fileInput.files[0];
      if (!text && !file) return;
      let image = null;
      if (file){ try{ image = await uploadImg(file,u.uid); }catch(e){ toast('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ',false); return; } }
      const msg = {
        uid: u.uid, nick: u.displayName||u.email||'–ê–Ω–æ–Ω—ñ–º',
        avatar: u.photoURL||DEFAULT_AVATAR, text: text||null, image,
        ts: Date.now(), recipientUid: extra.recipientUid||null
      };
      await dbPush(dbRef(db, path), msg);
      input.value=''; fileInput.value='';
      toast('‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ');
    }

    sendBtn.onclick = ()=> sendToPath(activePath());
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); } });

    /* ======= –î—Ä—É–∑—ñ ======= */
    const friendRequests = document.getElementById('friendRequests');
    const friendsList = document.getElementById('friendsList');
    const friendsOnlineCountEl = document.getElementById('friendsOnlineCount');

    async function refreshFriends(){
      const u = auth.currentUser; if(!u){ friendRequests.innerHTML=''; friendsList.innerHTML=''; return; }
      // –∑–∞—è–≤–∫–∏
      const reqSnap = await dbGet(dbRef(db, `friendRequests/${u.uid}`));
      friendRequests.innerHTML='';
      if (reqSnap.exists()){
        const reqs = reqSnap.val();
        for (const fromUid of Object.keys(reqs)){
          const us = await dbGet(dbRef(db, `users/${fromUid}`));
          const ud = us.exists()?us.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
          const row = document.createElement('div');
          row.className='friend';
          row.innerHTML = `
            <img class="avatar" src="${ud.avatar||DEFAULT_AVATAR}"> ${ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}
            <div style="margin-top:6px;display:flex;gap:6px">
              <button class="acc">‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏</button>
              <button class="decl">‚úñ</button>
            </div>`;
          row.querySelector('.acc').onclick = async ()=>{
            await dbSet(dbRef(db, `friends/${u.uid}/${fromUid}`), {status:'accepted',ts:Date.now()});
            await dbSet(dbRef(db, `friends/${fromUid}/${u.uid}`), {status:'accepted',ts:Date.now()});
            await dbRemove(dbRef(db, `friendRequests/${u.uid}/${fromUid}`));
            toast('‚úÖ –î–æ–¥–∞–Ω–æ —É –¥—Ä—É–∑—ñ');
            refreshFriends();
          };
          row.querySelector('.decl').onclick = async ()=>{
            await dbRemove(dbRef(db, `friendRequests/${u.uid}/${fromUid}`));
            await dbRemove(dbRef(db, `friends/${fromUid}/${u.uid}`));
            refreshFriends();
          };
          friendRequests.appendChild(row);
        }
      } else friendRequests.innerHTML = '<i>–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</i>';

      // –º–æ—ó –¥—Ä—É–∑—ñ
      friendsList.innerHTML='';
      const frSnap = await dbGet(dbRef(db, `friends/${u.uid}`));
      let onlineCount = 0;
      if (frSnap.exists()){
        const fr = frSnap.val();
        for (const fid of Object.keys(fr)){
          if (fr[fid].status!=='accepted') continue;
          const us = await dbGet(dbRef(db, `users/${fid}`));
          const ud = us.exists()?us.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
          const p = await dbGet(dbRef(db, `presence/${fid}`));
          const online = p.exists(); if (online) onlineCount++;
          const row = document.createElement('div');
          row.className='friend';
          row.innerHTML = `
            <img class="avatar" src="${ud.avatar||DEFAULT_AVATAR}"> ${ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}
            <span style="font-size:12px;opacity:.7"> ¬∑ ${online?'–æ–Ω–ª–∞–π–Ω':'–æ—Ñ–ª–∞–π–Ω'}</span>
            <div style="margin-top:6px;display:flex;gap:6px">
              <button class="pm">‚úâÔ∏è –õ–°</button>
              <button class="prof">üëÄ –ü—Ä–æ—Ñ—ñ–ª—å</button>
            </div>`;
          row.querySelector('.pm').onclick = ()=> openDM(fid);
          row.querySelector('.prof').onclick = ()=> openProfile(fid);
          friendsList.appendChild(row);
        }
      } else friendsList.innerHTML = '<i>–î–æ–¥–∞–π—Ç–µ –¥—Ä—É–∑—ñ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ—ñ–ª—ñ</i>';
      friendsOnlineCountEl.textContent = String(onlineCount);
    }

    /* ======= –õ–°: —Å–ø–∏—Å–æ–∫ –∏ –æ–∫–Ω–æ –¥–∏–∞–ª–æ–≥–∞ ======= */
    const dmList = document.getElementById('dmList');
    function convoId(a,b){ return a<b ? `${a}_${b}` : `${b}_${a}`; }

    async function openDM(otherUid){
      const u = auth.currentUser; if(!u){ showAuth(); return; }
      const cid = convoId(u.uid, otherUid);
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999';
      modal.innerHTML = `
        <div style="background:#fff;color:#111;width:92%;max-width:640px;border-radius:12px;padding:12px;position:relative">
          <button class="close" style="position:absolute;right:10px;top:10px;border:none;background:transparent;font-size:18px;cursor:pointer">‚úñ</button>
          <h3>–î—ñ–∞–ª–æ–≥</h3>
          <div class="log" style="max-height:60vh;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px;background:#fafafa"></div>
          <div style="display:flex;gap:6px;margin-top:8px">
            <input class="txt" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd">
            <button class="send">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
      const close = ()=> modal.remove();
      modal.querySelector('.close').onclick = close;

      const log = modal.querySelector('.log');
      const txt = modal.querySelector('.txt');
      const send = modal.querySelector('.send');

      const q = query(dbRef(db, `privateMessages/${cid}`), orderByChild('ts'), limitToLast(300));
      onChildAdded(q, snap=>{
        const m = snap.val();
        const row = document.createElement('div');
        row.style.cssText = 'margin:6px 0;'+(m.from===u.uid?'text-align:right':'text-align:left');
        row.textContent = `${m.text} (${new Date(m.ts).toLocaleTimeString()})`;
        log.appendChild(row);
        log.scrollTop = log.scrollHeight;
      });

      send.onclick = async ()=>{
        const t = txt.value.trim(); if(!t) return;
        const pm = {from:u.uid,to:otherUid,text:t,ts:Date.now()};
        await dbPush(dbRef(db, `privateMessages/${cid}`), pm);
        await dbSet(dbRef(db, `inboxMeta/${u.uid}/${otherUid}`), {otherUid,last:t,ts:pm.ts});
        await dbSet(dbRef(db, `inboxMeta/${otherUid}/${u.uid}`), {otherUid:u.uid,last:t,ts:pm.ts});
        await dbPush(dbRef(db, `notifications/${otherUid}`), {ts:Date.now(),type:'dm',text:`–ù–æ–≤–µ –õ–° –≤—ñ–¥ ${u.displayName||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}`,from:u.uid});
        txt.value='';
      };
    }

    function loadDMList(){
      const u = auth.currentUser; if(!u){ dmList.innerHTML='<i>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –±–∞—á–∏—Ç–∏ –õ–°</i>'; return; }
      onValue(dbRef(db, `inboxMeta/${u.uid}`), async snap=>{
        dmList.innerHTML='';
        const m = snap.val()||{};
        const keys = Object.keys(m).sort((a,b)=> (m[b].ts||0)-(m[a].ts||0));
        for (const k of keys){
          const meta = m[k];
          const us = await dbGet(dbRef(db, `users/${meta.otherUid}`));
          const ud = us.exists()?us.val():{nick:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',avatar:DEFAULT_AVATAR};
          const row = document.createElement('div');
          row.className='dialog';
          row.innerHTML = `
            <img class="avatar" src="${ud.avatar||DEFAULT_AVATAR}"> <b>${ud.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</b>
            <div style="font-size:12px;opacity:.7">${meta.last||''}</div>
            <div style="margin-top:6px"><button class="open">–í—ñ–¥–∫—Ä–∏—Ç–∏</button></div>
          `;
          row.querySelector('.open').onclick = ()=> openDM(meta.otherUid);
          dmList.appendChild(row);
        }
      });
    }

    /* ======= –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (üîî) ======= */
    function notify(uid){
      onChildAdded(dbRef(db, `notifications/${uid}`),(snap)=>{
        const v = snap.val()||{};
        toast(`${v.type||'–Ü–Ω—Ñ–æ'}: ${v.text||''}`);
      });
    }

    /* ======= –ö–∞—Ä—Ç–∞ Google ======= */
    let map, markers=[];
    const POINTS = [
      { title: "Nemocnice Motol", pos: {lat:50.058, lng:14.360}, cat:"hospital" },
      { title: "Nemocnice Na Frantisku", pos: {lat:50.086, lng:14.418}, cat:"hospital" },
      { title: "Pravni pomoc —Ü–µ–Ω—Ç—Ä", pos: {lat:50.083, lng:14.412}, cat:"lawyer" },
      { title: "Albert", pos: {lat:50.084, lng:14.417}, cat:"shop" },
      { title: "Pomoc 1", pos: {lat:50.082, lng:14.419}, cat:"help" }
    ];
    window._ensureMap = ()=>{
      if (window.google && !map){
        map = new google.maps.Map(document.getElementById('gmap'), {center:{lat:50.0755,lng:14.4378}, zoom:12, streetViewControl:false, mapTypeControl:false});
        POINTS.forEach(p=> markers.push(new google.maps.Marker({position:p.pos,title:p.title,map})));
      }
    };
    document.getElementById('mapSearch').oninput = (e)=>{
      const q = e.target.value.toLowerCase();
      markers.forEach((m,i)=>{
        const p = POINTS[i]; m.setVisible(p.title.toLowerCase().includes(q) || p.cat.includes(q));
      });
    };
    document.getElementById('centerBtn').onclick = ()=> map && map.setCenter({lat:50.0755,lng:14.4378});

    /* ======= –ü–æ–º—ñ—á–Ω–∏–∫ (–ª—ñ–º—ñ—Ç 30) ‚Äî –∑–∞–≥–ª—É—à–∫–∞ –±–µ–∑ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –∫–ª—é—á–∞ ======= */
    const assistLeftEl = document.getElementById('assistLeft');
    const assistLog = document.getElementById('assistLog');
    const assistInput = document.getElementById('assistInput');
    const assistSend = document.getElementById('assistSend');
    let assistLeft = Number(localStorage.getItem('assistLeft')||'30');
    assistLeftEl.textContent = assistLeft;
    assistSend.onclick = ()=>{
      if (assistLeft<=0){ document.getElementById('assistPay').style.display='block'; return; }
      const q = assistInput.value.trim(); if(!q) return;
      const mine = document.createElement('div'); mine.style.textAlign='right'; mine.textContent = q; assistLog.appendChild(mine);
      const bot = document.createElement('div'); bot.style.textAlign='left'; bot.textContent = '–ü–æ–º—ñ—á–Ω–∏–∫: –≤—ñ–¥–ø–æ–≤—ñ–º –ø—ñ—Å–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∫–ª—é—á–∞ GPT (–Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞).'; assistLog.appendChild(bot);
      assistLog.scrollTop = assistLog.scrollHeight;
      assistInput.value='';
      assistLeft--; localStorage.setItem('assistLeft', String(assistLeft)); assistLeftEl.textContent = assistLeft;
    };

    /* ======= –ê–≤—Ç–æ–ª–æ–≥–∏–Ω: –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ ======= */
    document.getElementById('sendButton').addEventListener('click', ()=>{
      if (!auth.currentUser) showAuth();
    }, {capture:true});

    /* ======= –ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ ‚Äî –ø–æ–¥–ø–∏—Å–∫–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ======= */
    onAuthStateChanged(auth, (u)=>{
      if (u){
        notify(u.uid);
        loadDMList();
        refreshFriends();
      }
    });
  </script>
/* ===== –ü—Ä–æ—Ñ—ñ–ª—å / –ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫ / –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å ===== */
const profileBtn = document.getElementById('profileBtn');
const gearBtn = document.getElementById('gearBtn');
const bellBtn = document.getElementById('bellBtn');
const bellBadge = document.getElementById('bellBadge');
const bellModal = document.getElementById('bellModal');
const bellClose = document.getElementById('bellClose');
const notifList = document.getElementById('notifList');

const adminModal = document.getElementById('adminModal');
const adminClose = document.getElementById('adminClose');
const usersList = document.getElementById('usersList');
const btnReloadUsers = document.getElementById('btnReloadUsers');
const btnClearChat = document.getElementById('btnClearChat');
const btnClearRent = document.getElementById('btnClearRent');

let banned = false;

/* –ø–æ–∫–∞–∑ –ø—Ä–æ—Ñ—ñ–ª—é */
profileBtn.onclick = ()=> auth.currentUser ? openProfile(auth.currentUser.uid) : showAuth();
document.getElementById('profileClose').onclick = ()=> document.getElementById('profileModal').style.display='none';

/* –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫ */
bellBtn.onclick = ()=>{ bellModal.style.display='flex'; bellBadge.style.display='none'; };
bellClose.onclick = ()=> bellModal.style.display='none';

/* –ø—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è */
function subscribeNotifications(uid){
  onChildAdded(dbRef(db, `notifications/${uid}`),(snap)=>{
    const v = snap.val()||{};
    const row = document.createElement('div');
    row.style.cssText = "padding:8px;border-bottom:1px solid #eee";
    row.textContent = `${v.type||'Info'}: ${v.text||''}`;
    notifList.prepend(row);
    // –±–µ–π–¥–∂
    const n = Number(bellBadge.dataset.n||"0")+1;
    bellBadge.dataset.n = String(n);
    bellBadge.textContent = n;
    bellBadge.style.display = 'inline-block';
  });
}

/* —Ä–æ–ª—å –∞–¥–º—ñ–Ω–∞ + –±–∞–Ω-—Å—Ç–∞—Ç—É—Å */
onAuthStateChanged(auth, async (u)=>{
  if (u){
    profileBtn.style.backgroundImage = `url(${u.photoURL||DEFAULT_AVATAR})`;
    const roleSnap = await dbGet(dbRef(db, `users/${u.uid}/role`));
    isAdmin = (u.email===ADMIN_EMAIL) || (roleSnap.exists() && roleSnap.val()==='admin');
    gearBtn.style.display = isAdmin ? 'flex' : 'none';
    subscribeNotifications(u.uid);
    // –±–∞–Ω-—Å—Ç–∞—Ç—É—Å
    onValue(dbRef(db, `users/${u.uid}/ban`), s=> banned = !!s.val());
  } else {
    gearBtn.style.display = 'none';
    banned = false;
  }
});

/* –ê–¥–º—ñ–Ω-–∫–Ω–æ–ø–∫–∞ */
gearBtn.onclick = ()=>{ if(isAdmin){ adminModal.style.display='flex'; loadAllUsers(); } };
adminClose.onclick = ()=> adminModal.style.display='none';

/* –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ —É—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ */
async function loadAllUsers(){
  usersList.innerHTML = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶';
  const snap = await dbGet(dbRef(db,'users'));
  usersList.innerHTML = '';
  const val = snap.val()||{};
  const ids = Object.keys(val);
  if (!ids.length){ usersList.innerHTML = '<i>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –Ω–µ–º–∞—î</i>'; return; }
  for (const uid of ids){
    const u = val[uid];
    const row = document.createElement('div');
    row.className = 'user-row';
    row.innerHTML = `
      <img src="${u.avatar||DEFAULT_AVATAR}">
      <div>
        <div><b>${u.nick||'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</b></div>
        <div class="tags">${u.email||''}${u.role==='admin'?' ¬∑ admin':''}${u.ban?' ¬∑ üîí –∑–∞–±–∞–Ω–µ–Ω–∏–π':''}${u.premium?' ¬∑ ‚≠ê –ø—Ä–µ–º—ñ—É–º':''}${u.donate?' ¬∑ üí≥ –¥–æ–Ω–∞—Ç':''}</div>
      </div>
      <div class="actions">
        <button class="pm">‚úâÔ∏è –õ–°</button>
        <button class="donate">üí≥ –î–æ–Ω–∞—Ç</button>
        <button class="premium">‚≠ê –ü—Ä–µ–º—ñ—É–º</button>
        <button class="ban">${u.ban?'‚úÖ –†–æ–∑–±–∞–Ω–∏—Ç–∏':'‚õî –ó–∞–±–∞–Ω–∏—Ç–∏'}</button>
        <button class="profile">üëÄ –ü—Ä–æ—Ñ—ñ–ª—å</button>
      </div>`;
    row.querySelector('.pm').onclick = ()=> openDM(uid);
    row.querySelector('.profile').onclick = ()=> openProfile(uid);
    row.querySelector('.donate').onclick = async ()=>{
      await dbSet(dbRef(db,`users/${uid}/donate`), true);
      await dbPush(dbRef(db,`notifications/${uid}`), {ts:Date.now(), type:'donate', text:'–î–æ–Ω–∞—Ç –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º'});
      loadAllUsers();
    };
    row.querySelector('.premium').onclick = async ()=>{
      await dbSet(dbRef(db,`users/${uid}/premium`), true);
      await dbPush(dbRef(db,`notifications/${uid}`), {ts:Date.now(), type:'premium', text:'–ü—Ä–µ–º—ñ—É–º –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ'});
      loadAllUsers();
    };
    row.querySelector('.ban').onclick = async ()=>{
      const newVal = !(u.ban===true);
      await dbSet(dbRef(db,`users/${uid}/ban`), newVal);
      await dbPush(dbRef(db,`notifications/${uid}`), {ts:Date.now(), type:'moderation', text: newVal?'–û–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ':'–ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –∑–Ω—è—Ç–æ'});
      loadAllUsers();
    };
    usersList.appendChild(row);
  }
}
btnReloadUsers.onclick = loadAllUsers;

/* –æ—á–∏—Å—Ç–∏—Ç–∏ —á–∞—Ç–∏ */
btnClearChat.onclick = async ()=>{ if(confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –æ—Å–Ω–æ–≤–Ω–∏–π —á–∞—Ç?')){ await dbRemove(dbRef(db,'messages')); toast('‚úÖ –û—á–∏—â–µ–Ω–æ'); } };
btnClearRent.onclick  = async ()=>{ if(confirm('–û—á–∏—Å—Ç–∏—Ç–∏ —á–∞—Ç –æ—Ä–µ–Ω–¥–∏?')){ await dbRemove(dbRef(db,'rentMessages')); toast('‚úÖ –û—á–∏—â–µ–Ω–æ'); } };

/* –ó–∞–±–æ—Ä–æ–Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –¥–ª—è –∑–∞–±–∞–Ω–µ–Ω–∏—Ö */
const _origSendToPath = sendToPath;
sendToPath = async function(path, extra={}){
  if (banned){ toast('–í–∞—à –∞–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.', false); return; }
  await _origSendToPath(path, extra);
};
  <!-- Google Maps (—Ç–≤–æ–π –∫–ª—é—á) -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFrxVhpb6nHJ6rhiLl5Ho8t0jOb1iEQNc&callback=_ensureMap"></script>
</body>
</html>

