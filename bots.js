const db2=firebase.database(); let botTimer=null; async function pollBots(){ try{ const snap=await db2.ref('bots').get(); const all=snap.val()||{}; const nowMs=Date.now(); for(const uid in all){ for(const bid in all[uid]){ const b=all[uid][bid]; if(!b.enabled) continue; const isAdmin=auth.currentUser&&auth.currentUser.email===window.ADMIN_EMAIL; const minGap=isAdmin?0:Math.max(15,parseInt(b.intervalMin||15,10)); const metaRef=db2.ref('botsMeta/'+uid+'/'+bid); const meta=(await metaRef.get()).val()||{}; const last=meta.lastTs||0; if(nowMs-last<minGap*60*1000) continue; const day=new Date().toISOString().slice(0,10); const dayCount=(meta.day===day)?(meta.dayCount||0):0; if(!isAdmin && dayCount>=100) continue; const m={by:uid,ts:nowMs}; if(b.text) m.text=b.text; if(b.photo) m.photo=b.photo; await db2.ref('messages/'+(b.city||'praha')).push(m); await metaRef.set({lastTs:nowMs,day:day,dayCount:dayCount+1}); } } }catch(e){} } auth.onAuthStateChanged(u=>{ if(u&&u.email===window.ADMIN_EMAIL){ if(botTimer) clearInterval(botTimer); botTimer=setInterval(pollBots,15000); pollBots(); } else { if(botTimer){ clearInterval(botTimer); botTimer=null; } } });