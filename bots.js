const db=firebase.database(); const auth=firebase.auth(); window.BOTS=(function(){ const REF=()=> db.ref('bots'); async function create(b){ const u=auth.currentUser; if(!u) throw new Error('auth'); const body=Object.assign({ownerUid:u.uid, active:true, everyMin:30, nextTs:0, ts:Date.now()}, b); return REF().push(body); } async function tick(){ const u=auth.currentUser; if(!u) return; const s=await REF().orderByChild('ownerUid').equalTo(u.uid).get(); const bots=s.val()||{}; const now=Date.now(); for(const [id,b] of Object.entries(bots)){ if(!b.active) continue; if(b.nextTs && b.nextTs>now) continue; const city=b.city||'praha'; if(b.type==='rent'){ await db.ref('rent').push({by:u.uid, ts:now, ad:true, title:b.title||'Inzer√°t', price:b.price||'', img:b.img||null, status:'active'}); } else { await db.ref('messages/'+city).push({by:u.uid, ts:now, text:b.text||'REKLAMA', img:b.img||null, ad:true}); } await REF().child(id).update({nextTs: now + (parseInt(b.everyMin||30,10)*60*1000)}); } } setInterval(tick, 15000); return {create,tick}; })();