const db=firebase.database(); const auth=firebase.auth(); async function friendItem(uid, st){ const wrap=document.createElement('div'); wrap.className='msg'; const u=(await db.ref('usersPublic/'+uid).get()).val()||{nick:'Uživatel'}; wrap.innerHTML = `<div class='meta'><b>${u.nick||'Uživatel'}</b> · ${st}</div><div class='row'><button data-act='chat'>Napsat</button>`+ (st==='pending'?`<button data-act='accept'>Přijmout</button>`:`<button data-act='remove'>Odebrat</button>`) + `</div>`; wrap.addEventListener('click', async (e)=>{ const a=e.target.dataset.act; if(!a) return; const me=auth.currentUser.uid; if(a==='accept'){ await db.ref('friends/'+me+'/'+uid).set('accepted'); await db.ref('friends/'+uid+'/'+me).set('accepted'); loadFriends(); } if(a==='remove'){ await db.ref('friends/'+me+'/'+uid).remove(); await db.ref('friends/'+uid+'/'+me).remove(); loadFriends(); } if(a==='chat'){ const key=[me,uid].sort().join('_'); localStorage.setItem('dmTo', uid); document.querySelector('[data-view="view-dm"]').click(); } }); return wrap; } async function loadFriends(){ const me=auth.currentUser; if(!me) return; const box=document.getElementById('friendsList'); box.innerHTML=''; const s=await db.ref('friends/'+me.uid).get(); const v=s.val()||{}; for(const [uid,st] of Object.entries(v)){ box.appendChild(await friendItem(uid, st)); } } document.getElementById('friendAddBtn')?.addEventListener('click', async ()=>{ try{ const me=auth.currentUser; if(!me) return alert('Přihlaste se'); const email=document.getElementById('friendEmail').value.trim(); if(!email) return; const toS=await db.ref('emails/'+email.replace('.',',')).get(); const uid=(toS.val()&&toS.val().uid); if(!uid) return alert('Email neznám'); await db.ref('friends/'+me.uid+'/'+uid).set('pending'); await db.ref('friends/'+uid+'/'+me.uid).set('pending'); toast('Žádost odeslána'); loadFriends(); }catch(e){ console.error(e); toast('Chyba'); } }); firebase.auth().onAuthStateChanged(u=>{ if(u) loadFriends(); });