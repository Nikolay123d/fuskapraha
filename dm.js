const db=firebase.database(); const auth=firebase.auth(); function dmKey(a,b){ return [a,b].sort().join('_'); } async function resolveUidByEmail(email){ const s=await db.ref('emails/'+email.replace('.',',')).get(); return (s.val()&&s.val().uid)||null; } $('#dmSend')?.addEventListener('click', async ()=>{ try{ const u=auth.currentUser; if(!u) return alert('Přihlaste se'); let to=$('#dmTo').value.trim(); if(!to) return; if(to.includes('@')){ const uid=await resolveUidByEmail(to); if(!uid) return alert('Email neznám'); to=uid; } const text=$('#dmText').value.trim(); let img=null; const f=$('#dmPhoto').files[0]; if(f) img=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); if(!text && !img) return; await db.ref('privateMessages/'+dmKey(auth.currentUser.uid,to)).push({by:auth.currentUser.uid, ts:Date.now(), text, img}); $('#dmText').value=''; $('#dmPhoto').value=''; toast('Odesláno'); SND.dm.play(); }catch(e){ console.error(e); SND.err.play(); }});