const $=(q,r=document)=>r.querySelector(q);function esc(s=''){return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
async function openDmWith(otherUid){const me=auth.currentUser?.uid;if(!me){toast('Přihlaste se');return;}window.DM_OTHER=otherUid;document.querySelector('.tab[data-tab="dm"]').click();$('#dmHeader').textContent='Konverzace';subDm();}
function pathA(a,b){return'dm/'+a+'/'+b;}
function subDm(){const me=auth.currentUser?.uid,other=window.DM_OTHER;if(!me||!other)return;const box=$('#dmMessages');box.innerHTML='';db.ref(pathA(me,other)).limitToLast(200).on('child_added',async s=>{const v=s.val()||{};const up=(await db.ref('usersPublic/'+(v.by||'')).get()).val()||{};const row=document.createElement('div');row.className='msg';row.innerHTML=`<div class="ava"><img src="${up.avatar||window.INIT_AVATAR}"></div><div class="bubble"><div class="name">${esc(up.name||v.by||'—')} · <span class="muted">${new Date(v.ts||Date.now()).toLocaleString('cs-CZ')}</span></div>${v.text?('<div>'+esc(v.text)+'</div>'):''}</div>`;box.appendChild(row);box.scrollTop=box.scrollHeight;try{document.querySelector('#aNewDM').play();}catch(e){};if(Notification?.permission==='granted'){navigator.serviceWorker?.getRegistration?.().then(r=>r?.showNotification('Nová zpráva v DM',{body:v.text||'Nová zpráva'}));}});$('#dmSend').onclick=async()=>{const text=($('#dmInput').value||'').trim();if(!text)return;const msg={by:me,to:other,text,ts:Date.now()};await Promise.all([db.ref(pathA(me,other)).push(msg),db.ref(pathA(other,me)).push(msg)]);$('#dmInput').value='';toast('Zpráva odeslána');};}
window.openDmWith=openDmWith;
