(function(){const $=(q,r=document)=>r.querySelector(q);let CURRENT_SPD=null,CURRENT_AMOUNT=0,CURRENT_PLAN='premium_monthly',CURRENT_VS='';auth.onAuthStateChanged(u=>{if(!u)auth.signInAnonymously().catch(()=>{});});function planToAmount(plan){if(plan==='premium_monthly')return window.PREMIUM_PRICING.monthly||50;if(plan==='premium_plus')return window.PREMIUM_PRICING.plus||120;if(plan==='lifetime_bot')return window.PREMIUM_PRICING.lifetime_bot||200;return 50;}function buildSPD(acc,amount,msg,vs){const enc=s=>String(s||'').replace(/\*/g,'').replace(/[\r\n]/g,'');return `SPD*1.0*ACC:${enc(acc)}*AM:${enc(amount)}*CC:CZK${msg?`*MSG:${enc(msg)}`:''}${vs?`*X-VS:${enc(vs)}`:''}`;}function qrUrlFromText(t){const data=encodeURIComponent(t);return `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${data}`;}
$('#gen').onclick=()=>{CURRENT_PLAN=$('#plan').value;CURRENT_AMOUNT=planToAmount(CURRENT_PLAN);CURRENT_VS=String(Date.now()).slice(-9);const msg=$('#msg').value||'';CURRENT_SPD=buildSPD(window.CSOB_ACC,CURRENT_AMOUNT,msg,CURRENT_VS);const url=qrUrlFromText(CURRENT_SPD);$('#qrBox').innerHTML=`<img src="${url}" alt="QR platba" style="width:240px;height:240px;border-radius:12px"/>`;$('#spdBox').textContent=CURRENT_SPD;$('#qrPanel').hidden=false;};
$('#submitReq').onclick=async()=>{const u=auth.currentUser;if(!u)return alert('Přihlaste se');const req={plan:CURRENT_PLAN,amount:CURRENT_AMOUNT,spd:CURRENT_SPD,qrUrl:$('#qrBox img')?.src||null,vs:CURRENT_VS,msg:$('#msg').value||'',ts:Date.now(),status:'pending'};const ref=await db.ref('payments/requests/'+u.uid).push(req);alert('Žádost odeslána: '+ref.key);};})();