async function fileToDataUrl(f){return await new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(f);});}
function mapIsAdmin(){const u=auth.currentUser;return!!(u&&(window.ADMIN_EMAILS||[]).includes((u.email||'').toLowerCase()));}
document.addEventListener('DOMContentLoaded',()=>{if(typeof L==='undefined')return;const mapEl=document.getElementById('map');if(!mapEl)return;const map=L.map('map').setView([50.087,14.42],12);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);document.getElementById('addPlace').onclick=async()=>{if(!mapIsAdmin()){alert('Jen admin');return;}const c=map.getCenter();const u=auth.currentUser;if(!u)return;let img=null;const f=document.getElementById('placeFile')?.files?.[0];if(f){img=await fileToDataUrl(f);} const p={lat:c.lat,lng:c.lng,title:'Místo',desc:'',img:img,by:u.uid,ts:Date.now()};await db.ref('places').push(p);};let edit=false;document.getElementById('editMode').onclick=()=>{edit=!edit;alert(edit?'Úpravy zapnuty':'Úpravy vypnuty');};db.ref('places').on('child_added',s=>addMarker(s.key,s.val()));db.ref('places').on('child_changed',s=>addMarker(s.key,s.val(),true));db.ref('places').on('child_removed',s=>{});const markers={};function addMarker(id,v,replace=false){if(replace&&markers[id]){markers[id].remove();delete markers[id];}const m=L.marker([v.lat||50.087,v.lng||14.42],{draggable:mapIsAdmin()}).addTo(map);markers[id]=m;function html(){return `<b>${(v.title||'Místo')}</b><br>${(v.desc||'')}<br><small>${new Date(v.ts||Date.now()).toLocaleString('cs-CZ')}</small>${mapIsAdmin()?`<br><button onclick="editPlace('${id}')">Upravit</button> <button onclick="delPlace('${id}')">Smazat</button>`:''}`;}m.bindPopup(html());if(mapIsAdmin()){m.on('dragend',async e=>{const latlng=e.target.getLatLng();await db.ref('places/'+id).update({lat:latlng.lat,lng:latlng.lng});});}}window.editPlace=async function(id){const v=(await db.ref('places/'+id).get()).val()||{};const title=prompt('Název',v.title||'Místo');if(title===null)return;const desc=prompt('Popis',v.desc||'');if(desc===null)return;const img=prompt('URL obrázku',v.img||'');if(img===null)return;await db.ref('places/'+id).update({title,desc,img});};window.delPlace=async function(id){if(confirm('Smazat?'))await db.ref('places/'+id).remove();};});
