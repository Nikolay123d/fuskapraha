(function(){let app,auth,db,st;const ADMIN_EMAIL=window.PF_ADMIN_EMAIL||'urciknikolaj642@gmail.com';let my={uid:null,nick:'Гість',ava:'public/images/ava.png',vip:false};let currentCity='praha';const $=id=>document.getElementById(id);function showModal(id){const el=$(id);if(el)el.classList.add('show');}function closeModal(id){const el=$(id);if(el)el.classList.remove('show');}document.addEventListener('click',e=>{const closer=e.target.closest('[data-close]');if(closer){closeModal(closer.getAttribute('data-close'));}});document.querySelectorAll('#tabs button').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('#tabs button').forEach(b=>b.classList.remove('active'));btn.classList.add('active');document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));$('view-'+btn.dataset.view).classList.add('active');});});window.addEventListener('load',()=>{firebase.initializeApp(window.PF_CONFIG);app=firebase.app();auth=firebase.auth();db=firebase.database();st=firebase.storage();auth.onAuthStateChanged(async u=>{if(!u){await auth.signInAnonymously();return;}my.uid=u.uid;my.nick=u.displayName||my.nick;my.ava=u.photoURL||my.ava;const snap=await db.ref('usersPublic/'+my.uid).get();if(snap.exists()){const v=snap.val();my.nick=v.nick||my.nick;my.ava=v.ava||my.ava;my.vip=!!v.vip;}else{await db.ref('usersPublic/'+my.uid).set({nick:my.nick,ava:my.ava,ts:Date.now(),role:'user',vip:false});}$('myAva').src=my.ava;$('profAva').src=my.ava;$('profNick').textContent=my.nick;$('profEmail').textContent=u.email||'анонім';$('vipBadge').style.display=my.vip?'inline-block':'none';document.querySelector('.adminBtn').style.display=(u.email===ADMIN_EMAIL)?'inline-block':'none';if(u.email===ADMIN_EMAIL){if(window.PF_ADMIN)PF_ADMIN.init(firebase);if(window.PF_BOTS)PF_BOTS.startForAdmin(firebase);}db.ref('settings/theme/wallUrl').on('value',s=>{const url=s.val();if(url)document.getElementById('walls').style.backgroundImage=`url('${url}')`;});listenCity();loadUsersAndFriends();initMap();});});$('citySel').addEventListener('change',e=>{currentCity=e.target.value;listenCity();});function listenCity(){const feed=$('chatFeed');feed.innerHTML='';db.ref('messages/'+currentCity).limitToLast(100).on('child_added',s=>{const v=s.val();const d=document.createElement('div');d.className='msg';d.innerHTML=`<img class="avatar" src="${v.ava||'public/images/ava.png'}" data-uid="${v.uid||''}"><div><div class="meta">${v.nick||'Anon'} · ${new Date(v.ts||Date.now()).toLocaleTimeString()}</div>${v.txt?('<div>'+escapeHtml(v.txt)+'</div>'):''}${v.img?('<div><img class="photo" src="'+v.img+'"></div>'):''}</div>`;feed.appendChild(d);feed.scrollTop=feed.scrollHeight;});}$('chatSend').addEventListener('click',trySendChat);$('chatInput').addEventListener('keydown',e=>{if(e.key==='Enter')trySendChat();});async function trySendChat(){const file=$('chatPhoto').files[0];const txt=$('chatInput').value.trim();if(!txt&&!file)return;if(auth.currentUser&&auth.currentUser.isAnonymous){showModal('regModal');return;}await sendChat(txt,file);}async function sendChat(txt,file){let img=null;if(file){const id='chat_'+Date.now();await st.ref('chat/'+my.uid+'/'+id).put(file);img=await st.ref('chat/'+my.uid+'/'+id).getDownloadURL();}await db.ref('messages/'+currentCity).push({uid:my.uid,nick:my.nick,ava:my.ava,txt:txt||null,img,ts:Date.now()});$('chatInput').value='';$('chatPhoto').value='';}$('saveProfile').addEventListener('click',async()=>{const nick=$('nickInput').value.trim()||my.nick;const url=$('avaUrlInput').value.trim();let ava=my.ava;const f=$('avaFile').files[0];if(f){const id='ava_'+Date.now();await st.ref('ava/'+my.uid+'/'+id).put(f);ava=await st.ref('ava/'+my.uid+'/'+id).getDownloadURL();}else if(url){ava=url;}await auth.currentUser.updateProfile({displayName:nick,photoURL:ava});await db.ref('usersPublic/'+my.uid).update({nick,ava});my.nick=nick;my.ava=ava;$('myAva').src=ava;$('profAva').src=ava;$('profNick').textContent=nick;});$('regDo').addEventListener('click',async()=>{const nick=$('regNick').value.trim()||'Користувач';const email=$('regEmail').value.trim();const pass=$('regPass').value;if(!email||!pass){alert('Email та пароль обовʼязкові');return;}try{const cred=firebase.auth.EmailAuthProvider.credential(email,pass);await auth.currentUser.linkWithCredential(cred);await auth.currentUser.updateProfile({displayName:nick});await db.ref('usersPublic/'+auth.currentUser.uid).update({nick});closeModal('regModal');}catch(e){try{await auth.signOut();await auth.signInWithEmailAndPassword(email,pass);await auth.currentUser.updateProfile({displayName:nick});await db.ref('usersPublic/'+auth.currentUser.uid).update({nick});closeModal('regModal');}catch(err){alert('Помилка: '+(err.message||err.code));}}});function loadUsersAndFriends(){const all=$('allUsers'),req=$('friendReq'),fr=$('friendsList');db.ref('usersPublic').on('value',snap=>{all.innerHTML='';const data=snap.val()||{};Object.keys(data).forEach(uid=>{const u=data[uid];const row=document.createElement('div');row.innerHTML=`<div style="display:flex;gap:10px;align-items:center"><img src="${u.ava||'public/images/ava.png'}" style="width:34px;height:34px;border-radius:50%;object-fit:cover"><div style="flex:1"><b>${u.nick||'User'}</b> ${u.vip?'<span class="badge">VIP</span>':''}</div><div style="display:flex;gap:6px"><button data-act="add">+ Додати</button><button data-act="msg">ЛС</button></div>`;row.querySelector('[data-act="add"]').onclick=()=>db.ref('friendRequests/'+uid+'/'+my.uid).set(true);row.querySelector('[data-act="msg"]').onclick=()=>openDM(uid,u.nick||'User',u.ava||'public/images/ava.png');all.appendChild(row);});});db.ref('friendRequests/'+my.uid).on('value',snap=>{req.innerHTML='';const data=snap.val()||{};Object.keys(data).forEach(from=>{const el=document.createElement('div');el.innerHTML=`<div style="display:flex;gap:8px;align-items:center"><div style="flex:1"><b>Заявка</b> від ${from}</div><button data-a="ok">Прийняти</button><button data-a="no">Відхилити</button>`;el.querySelector('[data-a="ok"]').onclick=async()=>{await db.ref('friends/'+my.uid+'/'+from).set(true);await db.ref('friends/'+from+'/'+my.uid).set(true);await db.ref('friendRequests/'+my.uid+'/'+from).remove();};el.querySelector('[data-a="no"]').onclick=()=>db.ref('friendRequests/'+my.uid+'/'+from).remove();req.appendChild(el);});});db.ref('friends/'+my.uid).on('value',async snap=>{fr.innerHTML='';const data=snap.val()||{};const ids=Object.keys(data);for(const fid of ids){const u=(await db.ref('usersPublic/'+fid).get()).val()||{};const el=document.createElement('div');el.innerHTML=`<div style="display:flex;gap:10px;align-items:center"><img src="${u.ava||'public/images/ava.png'}" style="width:34px;height:34px;border-radius:50%;object-fit:cover"><div style="flex:1"><b>${u.nick||'User'}</b></div><div style="display:flex;gap:6px"><button data-a="msg">ЛС</button><button data-a="rm">Прибрати</button></div>`;el.querySelector('[data-a="msg"]').onclick=()=>openDM(fid,u.nick||'User',u.ava||'public/images/ava.png');el.querySelector('[data-a="rm"]').onclick=async()=>{await db.ref('friends/'+my.uid+'/'+fid).remove();await db.ref('friends/'+fid+'/'+my.uid).remove();};fr.appendChild(el);}});}function threadId(a,b){return[a,b].sort().join('_');}function openDM(uid,name,ava){$('dmHeader').textContent='Листування з '+(name||'User');const tId=threadId(my.uid,uid);const feed=$('dmThread');feed.innerHTML='';db.ref('privateMessages/'+tId).limitToLast(100).on('child_added',s=>{const v=s.val();const m=document.createElement('div');m.className='msg';m.innerHTML=`<img class="avatar" src="${v.ava||'public/images/ava.png'}"><div><div class="meta">${v.nick||'User'} · ${new Date(v.ts||Date.now()).toLocaleTimeString()}</div>${v.txt||''}${v.img?('<div><img class="photo" src="'+v.img+'"></div>'):''}</div>`;feed.appendChild(m);feed.scrollTop=feed.scrollHeight;});showModal('dmModal');$('dmModalSend').onclick=async()=>{const txt=$('dmModalInput').value.trim();const file=$('dmModalPhoto').files[0];if(!txt&&!file)return;let img=null;if(file){const id='dm_'+Date.now();await st.ref('dm/'+my.uid+'/'+id).put(file);img=await st.ref('dm/'+my.uid+'/'+id).getDownloadURL();}await db.ref('privateMessages/'+tId).push({uid:my.uid,nick:my.nick,ava:my.ava,txt,img,ts:Date.now()});$('dmModalInput').value='';$('dmModalPhoto').value='';};}window.openDM=openDM;document.getElementById('buyVip').addEventListener('click',()=>showModal('payModal'));document.getElementById('openPay').addEventListener('click',()=>showModal('payModal'));document.getElementById('paySend').addEventListener('click',async()=>{const f=$('payFile').files[0];if(!f)return;const id='pay_'+Date.now();await st.ref('payments/'+my.uid+'/'+id).put(f);await db.ref('payments/inbox/'+my.uid+'/'+id).set({uid:my.uid,ts:Date.now()});closeModal('payModal');alert('Чек надіслано. Очікуйте підтвердження.');});function initMap(){const m=L.map('map',{zoomControl:true});m.setView([50.087,14.421],12);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(m);$('helpGrid').innerHTML='<div class="card">Медична допомога — Prague 1</div><div class="card">Юридична консультація — Prague 3</div>';}function escapeHtml(str){return(str||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}})();